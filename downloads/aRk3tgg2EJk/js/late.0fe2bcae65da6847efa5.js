(self.webpackChunkmp_webgl=self.webpackChunkmp_webgl||[]).push([[7475],{63360:e=>{var t={kind:"Document",definitions:[{kind:"OperationDefinition",operation:"query",name:{kind:"Name",value:"FileAttachments"},variableDefinitions:[{kind:"VariableDefinition",variable:{kind:"Variable",name:{kind:"Name",value:"modelId"}},type:{kind:"NonNullType",type:{kind:"NamedType",name:{kind:"Name",value:"ID"}}},directives:[]},{kind:"VariableDefinition",variable:{kind:"Variable",name:{kind:"Name",value:"pageSize"}},type:{kind:"NonNullType",type:{kind:"NamedType",name:{kind:"Name",value:"Int"}}},directives:[]}],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"fileAttachmentsByModelId"},arguments:[{kind:"Argument",name:{kind:"Name",value:"modelId"},value:{kind:"Variable",name:{kind:"Name",value:"modelId"}}},{kind:"Argument",name:{kind:"Name",value:"pageSize"},value:{kind:"Variable",name:{kind:"Name",value:"pageSize"}}}],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"results"},arguments:[],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"FragmentSpread",name:{kind:"Name",value:"FileAttachmentDetails"},directives:[]}]}}]}}]}},{kind:"OperationDefinition",operation:"mutation",name:{kind:"Name",value:"DeleteFileAttachment"},variableDefinitions:[{kind:"VariableDefinition",variable:{kind:"Variable",name:{kind:"Name",value:"id"}},type:{kind:"NonNullType",type:{kind:"NamedType",name:{kind:"Name",value:"ID"}}},directives:[]}],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"deleteFileAttachment"},arguments:[{kind:"Argument",name:{kind:"Name",value:"id"},value:{kind:"Variable",name:{kind:"Name",value:"id"}}}],directives:[]}]}},{kind:"FragmentDefinition",name:{kind:"Name",value:"FileAttachmentDetails"},typeCondition:{kind:"NamedType",name:{kind:"Name",value:"FileAttachment"}},directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"id"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"created"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"filename"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"url"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"validUntil"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"bytes"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"mimeType"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"downloadUrl"},arguments:[],directives:[]},{kind:"InlineFragment",typeCondition:{kind:"NamedType",name:{kind:"Name",value:"ImageFileAttachment"}},directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"imageWidth"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"imageHeight"},arguments:[],directives:[]}]}}]}},{kind:"OperationDefinition",operation:"mutation",name:{kind:"Name",value:"UploadFileAttachmentToModel"},variableDefinitions:[{kind:"VariableDefinition",variable:{kind:"Variable",name:{kind:"Name",value:"organizationId"}},type:{kind:"NonNullType",type:{kind:"NamedType",name:{kind:"Name",value:"ID"}}},directives:[]},{kind:"VariableDefinition",variable:{kind:"Variable",name:{kind:"Name",value:"modelId"}},type:{kind:"NonNullType",type:{kind:"NamedType",name:{kind:"Name",value:"ID"}}},directives:[]},{kind:"VariableDefinition",variable:{kind:"Variable",name:{kind:"Name",value:"contents"}},type:{kind:"NonNullType",type:{kind:"NamedType",name:{kind:"Name",value:"FileUpload"}}},directives:[]},{kind:"VariableDefinition",variable:{kind:"Variable",name:{kind:"Name",value:"filename"}},type:{kind:"NonNullType",type:{kind:"NamedType",name:{kind:"Name",value:"String"}}},directives:[]}],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"uploadFileAttachmentToModel"},arguments:[{kind:"Argument",name:{kind:"Name",value:"organizationId"},value:{kind:"Variable",name:{kind:"Name",value:"organizationId"}}},{kind:"Argument",name:{kind:"Name",value:"modelId"},value:{kind:"Variable",name:{kind:"Name",value:"modelId"}}},{kind:"Argument",name:{kind:"Name",value:"contents"},value:{kind:"Variable",name:{kind:"Name",value:"contents"}}},{kind:"Argument",name:{kind:"Name",value:"filename"},value:{kind:"Variable",name:{kind:"Name",value:"filename"}}}],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"FragmentSpread",name:{kind:"Name",value:"FileAttachmentDetails"},directives:[]}]}}]}}],loc:{start:0,end:809}};t.loc.source={body:"# read all attachments for the specified model\nquery FileAttachments($modelId: ID!, $pageSize: Int!) {\n  fileAttachmentsByModelId(modelId: $modelId, pageSize: $pageSize) {\n    results { ...FileAttachmentDetails }\n  }\n}\n\nmutation DeleteFileAttachment($id: ID!) {\n  deleteFileAttachment(id: $id)\n}\n\nfragment FileAttachmentDetails on FileAttachment {\n  id\n  created\n  filename\n  url\n  validUntil\n  bytes\n  mimeType\n  downloadUrl\n  ...on ImageFileAttachment {\n      imageWidth\n      imageHeight\n  }\n}\n\nmutation UploadFileAttachmentToModel($organizationId: ID!, $modelId: ID!, $contents: FileUpload!, $filename: String!) {\n  uploadFileAttachmentToModel(organizationId: $organizationId, modelId: $modelId,\n                              contents: $contents, filename: $filename) {\n    ...FileAttachmentDetails\n  }\n}\n",name:"GraphQL request",locationOffset:{line:1,column:1}};function i(e,t){if("FragmentSpread"===e.kind)t.add(e.name.value);else if("VariableDefinition"===e.kind){var n=e.type;"NamedType"===n.kind&&t.add(n.name.value)}e.selectionSet&&e.selectionSet.selections.forEach((function(e){i(e,t)})),e.variableDefinitions&&e.variableDefinitions.forEach((function(e){i(e,t)})),e.definitions&&e.definitions.forEach((function(e){i(e,t)}))}var n={};function a(e,t){for(var i=0;i<e.definitions.length;i++){var n=e.definitions[i];if(n.name&&n.name.value==t)return n}}function s(e,t){var i={kind:e.kind,definitions:[a(e,t)]};e.hasOwnProperty("loc")&&(i.loc=e.loc);var s=n[t]||new Set,o=new Set,r=new Set;for(s.forEach((function(e){r.add(e)}));r.size>0;){var d=r;r=new Set,d.forEach((function(e){o.has(e)||(o.add(e),(n[e]||new Set).forEach((function(e){r.add(e)})))}))}return o.forEach((function(t){var n=a(e,t);n&&i.definitions.push(n)})),i}t.definitions.forEach((function(e){if(e.name){var t=new Set;i(e,t),n[e.name.value]=t}})),e.exports=t,e.exports.FileAttachments=s(t,"FileAttachments"),e.exports.DeleteFileAttachment=s(t,"DeleteFileAttachment"),e.exports.FileAttachmentDetails=s(t,"FileAttachmentDetails"),e.exports.UploadFileAttachmentToModel=s(t,"UploadFileAttachmentToModel")},44354:e=>{var t={kind:"Document",definitions:[{kind:"OperationDefinition",operation:"query",name:{kind:"Name",value:"GetObjectAnnotations"},variableDefinitions:[{kind:"VariableDefinition",variable:{kind:"Variable",name:{kind:"Name",value:"modelId"}},type:{kind:"NonNullType",type:{kind:"NamedType",name:{kind:"Name",value:"ID"}}},directives:[]},{kind:"VariableDefinition",variable:{kind:"Variable",name:{kind:"Name",value:"inferenceEvents"}},type:{kind:"ListType",type:{kind:"NonNullType",type:{kind:"NamedType",name:{kind:"Name",value:"ID"}}}},directives:[]},{kind:"VariableDefinition",variable:{kind:"Variable",name:{kind:"Name",value:"minConfidence"}},type:{kind:"NamedType",name:{kind:"Name",value:"Float"}},directives:[]},{kind:"VariableDefinition",variable:{kind:"Variable",name:{kind:"Name",value:"ids"}},type:{kind:"ListType",type:{kind:"NonNullType",type:{kind:"NamedType",name:{kind:"Name",value:"ID"}}}},directives:[]},{kind:"VariableDefinition",variable:{kind:"Variable",name:{kind:"Name",value:"includeDisabled"}},type:{kind:"NamedType",name:{kind:"Name",value:"Boolean"}},directives:[]},{kind:"VariableDefinition",variable:{kind:"Variable",name:{kind:"Name",value:"includeLayers"}},type:{kind:"NonNullType",type:{kind:"NamedType",name:{kind:"Name",value:"Boolean"}}},directives:[]}],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"model"},arguments:[{kind:"Argument",name:{kind:"Name",value:"id"},value:{kind:"Variable",name:{kind:"Name",value:"modelId"}}}],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"objectAnnotations"},arguments:[{kind:"Argument",name:{kind:"Name",value:"inferenceEvents"},value:{kind:"Variable",name:{kind:"Name",value:"inferenceEvents"}}},{kind:"Argument",name:{kind:"Name",value:"minimumConfidenceOverride"},value:{kind:"Variable",name:{kind:"Name",value:"minConfidence"}}},{kind:"Argument",name:{kind:"Name",value:"ids"},value:{kind:"Variable",name:{kind:"Name",value:"ids"}}},{kind:"Argument",name:{kind:"Name",value:"includeDisabled"},value:{kind:"Variable",name:{kind:"Name",value:"includeDisabled"}}}],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"FragmentSpread",name:{kind:"Name",value:"ObjectAnnotationInfo"},directives:[]}]}}]}}]}},{kind:"OperationDefinition",operation:"mutation",name:{kind:"Name",value:"AddObjectAnnotation"},variableDefinitions:[{kind:"VariableDefinition",variable:{kind:"Variable",name:{kind:"Name",value:"modelId"}},type:{kind:"NonNullType",type:{kind:"NamedType",name:{kind:"Name",value:"ID"}}},directives:[]},{kind:"VariableDefinition",variable:{kind:"Variable",name:{kind:"Name",value:"objectAnnotation"}},type:{kind:"NonNullType",type:{kind:"NamedType",name:{kind:"Name",value:"ObjectAnnotationDetails"}}},directives:[]},{kind:"VariableDefinition",variable:{kind:"Variable",name:{kind:"Name",value:"includeLayers"}},type:{kind:"NonNullType",type:{kind:"NamedType",name:{kind:"Name",value:"Boolean"}}},directives:[]}],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"addObjectAnnotation"},arguments:[{kind:"Argument",name:{kind:"Name",value:"modelId"},value:{kind:"Variable",name:{kind:"Name",value:"modelId"}}},{kind:"Argument",name:{kind:"Name",value:"objectAnnotation"},value:{kind:"Variable",name:{kind:"Name",value:"objectAnnotation"}}}],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"FragmentSpread",name:{kind:"Name",value:"ObjectAnnotationInfo"},directives:[]}]}}]}},{kind:"OperationDefinition",operation:"mutation",name:{kind:"Name",value:"PatchObjectAnnotation"},variableDefinitions:[{kind:"VariableDefinition",variable:{kind:"Variable",name:{kind:"Name",value:"modelId"}},type:{kind:"NonNullType",type:{kind:"NamedType",name:{kind:"Name",value:"ID"}}},directives:[]},{kind:"VariableDefinition",variable:{kind:"Variable",name:{kind:"Name",value:"objectAnnotationId"}},type:{kind:"NonNullType",type:{kind:"NamedType",name:{kind:"Name",value:"ID"}}},directives:[]},{kind:"VariableDefinition",variable:{kind:"Variable",name:{kind:"Name",value:"data"}},type:{kind:"NonNullType",type:{kind:"NamedType",name:{kind:"Name",value:"ObjectAnnotationPatch"}}},directives:[]},{kind:"VariableDefinition",variable:{kind:"Variable",name:{kind:"Name",value:"includeLayers"}},type:{kind:"NonNullType",type:{kind:"NamedType",name:{kind:"Name",value:"Boolean"}}},directives:[]}],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"patchObjectAnnotation"},arguments:[{kind:"Argument",name:{kind:"Name",value:"modelId"},value:{kind:"Variable",name:{kind:"Name",value:"modelId"}}},{kind:"Argument",name:{kind:"Name",value:"objectAnnotationId"},value:{kind:"Variable",name:{kind:"Name",value:"objectAnnotationId"}}},{kind:"Argument",name:{kind:"Name",value:"patch"},value:{kind:"Variable",name:{kind:"Name",value:"data"}}}],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"FragmentSpread",name:{kind:"Name",value:"ObjectAnnotationInfo"},directives:[]}]}}]}},{kind:"OperationDefinition",operation:"mutation",name:{kind:"Name",value:"SetBulkObjectAnnotationsEnabled"},variableDefinitions:[{kind:"VariableDefinition",variable:{kind:"Variable",name:{kind:"Name",value:"modelId"}},type:{kind:"NonNullType",type:{kind:"NamedType",name:{kind:"Name",value:"ID"}}},directives:[]},{kind:"VariableDefinition",variable:{kind:"Variable",name:{kind:"Name",value:"objectAnnotationIds"}},type:{kind:"NonNullType",type:{kind:"ListType",type:{kind:"NonNullType",type:{kind:"NamedType",name:{kind:"Name",value:"ID"}}}}},directives:[]},{kind:"VariableDefinition",variable:{kind:"Variable",name:{kind:"Name",value:"setEnabled"}},type:{kind:"NonNullType",type:{kind:"NamedType",name:{kind:"Name",value:"Boolean"}}},directives:[]},{kind:"VariableDefinition",variable:{kind:"Variable",name:{kind:"Name",value:"includeLayers"}},type:{kind:"NonNullType",type:{kind:"NamedType",name:{kind:"Name",value:"Boolean"}}},directives:[]}],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"setBulkObjectAnnotationsEnabled"},arguments:[{kind:"Argument",name:{kind:"Name",value:"modelId"},value:{kind:"Variable",name:{kind:"Name",value:"modelId"}}},{kind:"Argument",name:{kind:"Name",value:"objectAnnotationIds"},value:{kind:"Variable",name:{kind:"Name",value:"objectAnnotationIds"}}},{kind:"Argument",name:{kind:"Name",value:"setEnabled"},value:{kind:"Variable",name:{kind:"Name",value:"setEnabled"}}}],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"FragmentSpread",name:{kind:"Name",value:"ObjectAnnotationInfo"},directives:[]}]}}]}},{kind:"OperationDefinition",operation:"mutation",name:{kind:"Name",value:"DeleteObjectAnnotation"},variableDefinitions:[{kind:"VariableDefinition",variable:{kind:"Variable",name:{kind:"Name",value:"modelId"}},type:{kind:"NonNullType",type:{kind:"NamedType",name:{kind:"Name",value:"ID"}}},directives:[]},{kind:"VariableDefinition",variable:{kind:"Variable",name:{kind:"Name",value:"objectAnnotationId"}},type:{kind:"NonNullType",type:{kind:"NamedType",name:{kind:"Name",value:"ID"}}},directives:[]}],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"deleteObjectAnnotation"},arguments:[{kind:"Argument",name:{kind:"Name",value:"modelId"},value:{kind:"Variable",name:{kind:"Name",value:"modelId"}}},{kind:"Argument",name:{kind:"Name",value:"objectAnnotationId"},value:{kind:"Variable",name:{kind:"Name",value:"objectAnnotationId"}}}],directives:[]}]}},{kind:"FragmentDefinition",name:{kind:"Name",value:"ObjectAnnotationInfo"},typeCondition:{kind:"NamedType",name:{kind:"Name",value:"ObjectAnnotation"}},directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"id"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"created"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"modified"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"model"},arguments:[],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"id"},arguments:[],directives:[]}]}},{kind:"Field",name:{kind:"Name",value:"floor"},arguments:[],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"id"},arguments:[],directives:[]}]}},{kind:"Field",name:{kind:"Name",value:"room"},arguments:[],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"id"},arguments:[],directives:[]}]}},{kind:"Field",name:{kind:"Name",value:"layer"},arguments:[],directives:[{kind:"Directive",name:{kind:"Name",value:"include"},arguments:[{kind:"Argument",name:{kind:"Name",value:"if"},value:{kind:"Variable",name:{kind:"Name",value:"includeLayers"}}}]}],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"id"},arguments:[],directives:[]}]}},{kind:"Field",name:{kind:"Name",value:"enabled"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"label"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"confidence"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"region"},arguments:[],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"InlineFragment",typeCondition:{kind:"NamedType",name:{kind:"Name",value:"VectorRegion"}},directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"anchorPosition"},arguments:[],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"x"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"y"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"z"},arguments:[],directives:[]}]}},{kind:"Field",name:{kind:"Name",value:"stemNormal"},arguments:[],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"x"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"y"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"z"},arguments:[],directives:[]}]}},{kind:"Field",name:{kind:"Name",value:"stemLength"},arguments:[],directives:[]}]}}]}},{kind:"Field",name:{kind:"Name",value:"tag"},arguments:[],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"id"},arguments:[],directives:[]}]}},{kind:"Field",name:{kind:"Name",value:"keywords"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"classification"},arguments:[],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"id"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"label"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"defaultKeywords"},arguments:[],directives:[]}]}}]}}],loc:{start:0,end:1971}};t.loc.source={body:"# Object Tag Suggestions\n# Reference: https://matterport.atlassian.net/wiki/spaces/EX/pages/44320356/Object+Detection+-+Workshop+Suggestions\n\nquery GetObjectAnnotations($modelId: ID!, $inferenceEvents: [ID!], $minConfidence: Float, $ids: [ID!], $includeDisabled: Boolean, $includeLayers: Boolean!) {\n  model(id: $modelId) {\n    objectAnnotations(inferenceEvents: $inferenceEvents, minimumConfidenceOverride: $minConfidence, ids: $ids, includeDisabled: $includeDisabled) {\n      ...ObjectAnnotationInfo\n    }\n  }\n}\n\nmutation AddObjectAnnotation($modelId: ID!, $objectAnnotation: ObjectAnnotationDetails!, $includeLayers: Boolean!) {\n  addObjectAnnotation(modelId: $modelId, objectAnnotation: $objectAnnotation) {\n    ...ObjectAnnotationInfo\n  }\n}\n\n# Update a single object annotation\nmutation PatchObjectAnnotation($modelId: ID!, $objectAnnotationId: ID!, $data: ObjectAnnotationPatch!, $includeLayers: Boolean!) {\n  patchObjectAnnotation(modelId: $modelId, , objectAnnotationId: $objectAnnotationId, patch: $data) {\n    ...ObjectAnnotationInfo\n  }\n}\n\nmutation SetBulkObjectAnnotationsEnabled($modelId: ID! $objectAnnotationIds:[ID!]!, $setEnabled: Boolean!, $includeLayers: Boolean!) {\n  setBulkObjectAnnotationsEnabled(modelId: $modelId, objectAnnotationIds: $objectAnnotationIds, setEnabled: $setEnabled) {\n    ...ObjectAnnotationInfo\n  }\n}\n\nmutation DeleteObjectAnnotation($modelId: ID!, $objectAnnotationId: ID!) {\n  deleteObjectAnnotation(modelId: $modelId, objectAnnotationId: $objectAnnotationId)\n}\n\nfragment ObjectAnnotationInfo on ObjectAnnotation {\n  id\n  created\n  modified\n  model {\n    id\n  }\n  floor {\n    id\n  }\n  room {\n    id\n  }\n  layer @include(if: $includeLayers) { id } \n  enabled\n  label\n  confidence\n  region {\n    ... on VectorRegion {\n      anchorPosition {\n        x, y, z\n      }\n      stemNormal {\n        x, y, z\n      }\n      stemLength\n    }\n  }\n  tag {\n    id\n  }\n  keywords\n  classification {\n    id,\n    label,\n    defaultKeywords\n  }\n}\n",name:"GraphQL request",locationOffset:{line:1,column:1}};function i(e,t){if("FragmentSpread"===e.kind)t.add(e.name.value);else if("VariableDefinition"===e.kind){var n=e.type;"NamedType"===n.kind&&t.add(n.name.value)}e.selectionSet&&e.selectionSet.selections.forEach((function(e){i(e,t)})),e.variableDefinitions&&e.variableDefinitions.forEach((function(e){i(e,t)})),e.definitions&&e.definitions.forEach((function(e){i(e,t)}))}var n={};function a(e,t){for(var i=0;i<e.definitions.length;i++){var n=e.definitions[i];if(n.name&&n.name.value==t)return n}}function s(e,t){var i={kind:e.kind,definitions:[a(e,t)]};e.hasOwnProperty("loc")&&(i.loc=e.loc);var s=n[t]||new Set,o=new Set,r=new Set;for(s.forEach((function(e){r.add(e)}));r.size>0;){var d=r;r=new Set,d.forEach((function(e){o.has(e)||(o.add(e),(n[e]||new Set).forEach((function(e){r.add(e)})))}))}return o.forEach((function(t){var n=a(e,t);n&&i.definitions.push(n)})),i}t.definitions.forEach((function(e){if(e.name){var t=new Set;i(e,t),n[e.name.value]=t}})),e.exports=t,e.exports.GetObjectAnnotations=s(t,"GetObjectAnnotations"),e.exports.AddObjectAnnotation=s(t,"AddObjectAnnotation"),e.exports.PatchObjectAnnotation=s(t,"PatchObjectAnnotation"),e.exports.SetBulkObjectAnnotationsEnabled=s(t,"SetBulkObjectAnnotationsEnabled"),e.exports.DeleteObjectAnnotation=s(t,"DeleteObjectAnnotation"),e.exports.ObjectAnnotationInfo=s(t,"ObjectAnnotationInfo")},34558:(e,t,i)=>{"use strict";i.r(t),i.d(t,{default:()=>D});var n=i(23205),a=i(80328),s=i(35223),o=i(9389),r=i(60052),d=i(45018),l=i(49191),h=i(99817),c=i(79760),m=i(14746),u=i(20322),g=i(15855),p=i(82389),y=i(28997),v=i(44158),w=i(54839),f=i(2409),b=i(62148),T=i(97624);class D extends n.n{constructor(){super(...arguments),this.name="quick-menus"}async init(e,t){this.settingsModule=await t.getModuleBySymbol(a.ZF),this.scanInfoDataModule=await t.getModuleBySymbol(s.He),this.settingsGui=this.settingsModule.getSettingsGui();const i=await t.getModuleBySymbol(o.r),n=await t.market.waitForData(l.A),D=await t.market.waitForData(y.o),C=await t.market.waitForData(d.M);this.uIndex=this.settingsGui.addPanel("Link to location",[v.D.U],{allowSubGroups:!1,width:400,ratio:90});const P=[38,38,40,40,37,39,37,39,66,65,v.D.O];this.oIndex=this.settingsGui.addPanel("Scan Info",P,{allowSubGroups:!1,width:400,ratio:75}),this.pIndex=this.settingsGui.addPanel("Quick settings",[v.D.P],{allowSubGroups:!1}),this.settingsGui.loadPromise.then((()=>{this.settingsGui.addControl(this.uIndex,"","Link",{}),this.settingsGui.addButton(this.uIndex,"","Copy to clipboard",(()=>{const e=document.createElement("input");e.type="text",e.value=this.buildLink(i),document.body.appendChild(e),e.select(),document.execCommand("copy"),document.body.removeChild(e)})),this.settingsGui.toggle(this.uIndex),this.settingsGui.addControl(this.oIndex,"","Scan ID",{}),this.settingsGui.addControl(this.oIndex,"","Anchor ID",{}),this.settingsGui.addControl(this.oIndex,"","Created",{}),this.settingsGui.addControl(this.oIndex,"","Time of Day",{}),this.settingsGui.addControl(this.oIndex,"","Alignment",{}),this.settingsGui.addControl(this.oIndex,"","Options",{}),this.settingsGui.addControl(this.oIndex,"","Camera",{}),this.settingsGui.addControl(this.oIndex,"","Camera Types",{}),this.settingsGui.addControl(this.oIndex,"","Sensor Serials",{}),this.settingsGui.addControl(this.oIndex,"","Serial Number",{}),this.settingsGui.addControl(this.oIndex,"","Mount Calibration",{}),this.settingsGui.addControl(this.oIndex,"","Software Version",{}),this.settingsGui.addButton(this.oIndex,"","Copy Scan ID",(async()=>{if(n.currentSweepObject){const e=await this.scanInfoDataModule.getScanInfo(n.currentSweepObject.platformId);if(e){const t=document.createElement("input");t.type="text",t.value=e.id,document.body.appendChild(t),t.select(),document.execCommand("copy"),document.body.removeChild(t)}}})),this.settingsGui.addButton(this.oIndex,"","Download Scan",(async()=>{if(n.currentSweepObject){const e=await this.scanInfoDataModule.getScanDownloadURL(n.currentSweepObject.platformId);e&&window.open(e)}})),this.settingsGui.toggle(this.oIndex);const e=c.V$*(180/Math.PI)*60;this.settingsGui.addControl(this.pIndex,"",u.f,!0),this.settingsGui.addControl(this.pIndex,"",w.s,!0),this.settingsGui.addControl(this.pIndex,"",f.qE,!0),this.settingsGui.addControl(this.pIndex,"",b.Q,!0),this.settingsGui.addSlider(this.pIndex,"",T.Vp,T.lg,0,100,1),this.settingsGui.addSlider(this.pIndex,"",m.lookAccelerationKey,e,.25,10,2),this.settingsGui.addSlider(this.pIndex,"",r.baseTransitionSpeedKey,h.Ay.camera.baseTransitionTime,1,5e3,0);const t=D.tryGetProperty(g._V,g.aS);this.settingsGui.addSlider(this.pIndex,"",g.d6,(0,p.wg)(t),.5,10,2),this.settingsGui.toggle(this.pIndex),this.settingsModule.registerSetting("Quick settings",m.lookAccelerationKey,e,!1),this.settingsModule.registerSetting("Quick settings",r.baseTransitionSpeedKey,h.Ay.camera.baseTransitionTime,!1),this.settingsModule.registerSetting("Quick settings",T.Vp,T.lg,!1),this.settingsGui.onToggle(this.uIndex,(e=>{e&&this.settingsGui.updateSetting(this.uIndex,"Link",this.buildLink(i))})),this.settingsGui.onToggle(this.oIndex,(e=>{e&&this.refreshScanInfo(n)})),C.pose.onChanged((()=>{this.settingsGui.isLoaded&&this.settingsGui.isVisible(this.uIndex)&&this.settingsGui.updateSetting(this.uIndex,"Link",this.buildLink(i)),this.settingsGui.isLoaded&&this.settingsGui.isVisible(this.oIndex)&&this.refreshScanInfo(n)})),D.onPropertyChanged(g.d6,(e=>{D.setProperty(g._V,(0,p.A0)(e))}))}))}refreshScanInfo(e){e.currentSweep?this.scanInfoDataModule.getScanInfo(e.currentSweep).then((e=>{this.updateScanInfo(e)})):this.updateScanInfo(void 0)}updateScanInfo(e){this.settingsGui.updateSetting(this.oIndex,"Scan ID",e?e.id:""),this.settingsGui.updateSetting(this.oIndex,"Anchor ID",e?e.anchorId:""),this.settingsGui.updateSetting(this.oIndex,"Created",e?e.created:""),this.settingsGui.updateSetting(this.oIndex,"Time of Day",e?e.timeOfDay:""),this.settingsGui.updateSetting(this.oIndex,"Alignment",e?e.alignment:""),this.settingsGui.updateSetting(this.oIndex,"Options",e?JSON.stringify(e.options):""),this.settingsGui.updateSetting(this.oIndex,"Camera",e?`${e.camera.vendor} ${e.camera.model}`:""),this.settingsGui.updateSetting(this.oIndex,"Camera Types",e?JSON.stringify(e.camera.cameraTypes):""),this.settingsGui.updateSetting(this.oIndex,"Sensor Serials",e?JSON.stringify(e.camera.sensorSerialNumbers):""),this.settingsGui.updateSetting(this.oIndex,"Serial Number",e?e.camera.serialNumber:""),this.settingsGui.updateSetting(this.oIndex,"Mount Calibration",e?e.camera.mountCalibrationVersion:""),this.settingsGui.updateSetting(this.oIndex,"Software Version",e?e.camera.softwareVersion:"")}buildLink(e){return decodeURIComponent(e.creator.createDeepLink().href)}}},33810:(e,t,i)=>{"use strict";i.d(t,{T:()=>m});var n=i(74848),a=i(2409),s=i(66083),o=i(16616),r=i(521),d=i(75414),l=i(16603),h=i(12003),c=i(45518);function m({parentTool:e}){const t=(0,l.i)(a.qE,!1),i=(0,l.i)(o.nH,!1),m=(0,l.i)(s.nc,!1),u=(0,d.t)(),g=i&&m;return!g&&!t||t&&e!==r.S0.TAGS||!t&&e!==r.S0.NOTES?null:(0,n.jsxs)("div",Object.assign({className:"overlay-ui"},{children:[(0,n.jsx)(c.o,{}),(0,n.jsx)(h.G,{notesEnabled:g,openModal:u})]}))}},97088:(e,t,i)=>{"use strict";i.r(t),i.d(t,{AnnotationAttachmentClickedMessage:()=>c.z,AnnotationBlockClickedMessage:()=>c.v,AnnotationType:()=>m.U,AnnotationsViewData:()=>r.o,CloseAnnotationCommand:()=>d.XK,CloseBillboardCommand:()=>d.ZR,CloseDockedAnnotationCommand:()=>d.Tj,CloseOtherAnnotationsCommand:()=>d.mS,DockAnnotationCommand:()=>d.y8,PreviewAnnotationCommand:()=>d.Zx,SelectAnnotationCommand:()=>d.xo,default:()=>u});var n=i(23205),a=i(59839),s=i(35596),o=i(61334),r=i(87513),d=i(91902),l=i(54522);class h extends n.n{constructor(){super(...arguments),this.name="annotations",this.handleDockAnnotation=async e=>{const t=this.viewData,{dockedAnnotation:i}=t,{id:n,annotationType:a,force:s}=e;(this.viewData.getCapabilities(n).dock||s)&&((null==i?void 0:i.id)!==n||(null==i?void 0:i.annotationType)!==a?t.atomic((()=>{t.setDockedAnnotation(n,a),t.setBillboardAnnotation(null)})):this.log.debug("Annotation is already docked"))},this.handleSelectAnnotation=async e=>{const t=this.viewData,{billboardAnnotation:i,billboardSelected:n}=t,{id:a,annotationType:s,force:o}=e;(this.viewData.getCapabilities(a).preview||o)&&(n&&(null==i?void 0:i.id)===a&&(null==i?void 0:i.annotationType)===s?this.log.debug("Annotation is already selected"):t.atomic((()=>{t.setBillboardAnnotation(a,s,!0),t.setDockedAnnotation(null)})))},this.handlePreviewAnnotation=async e=>{this.viewData.getCapabilities(e.id).preview&&this.viewData.setBillboardAnnotation(e.id,e.annotationType,!1)},this.handleCloseBillboard=async()=>{this.viewData.setBillboardAnnotation(null)},this.handleCloseDockedAnnotation=async()=>{this.viewData.setDockedAnnotation(null)},this.handleClosingOtherAnnotations=async e=>{const{exceptType:t,exceptId:i}=e;this.closeOtherAnnotations(t,i)},this.closeOtherAnnotations=(e,t)=>{const i=this.viewData,{billboardAnnotation:n,dockedAnnotation:a}=i,s=n&&!this.isMatchingAnnotation(n,e,t),o=a&&!this.isMatchingAnnotation(a,e,t);i.atomic((()=>{n&&s&&i.setBillboardAnnotation(null),a&&o&&i.setDockedAnnotation(null)}))},this.handleCloseAnnotation=async e=>{const t=this.viewData,{billboardAnnotation:i,dockedAnnotation:n}=t,{id:a,annotationType:s}=e;t.atomic((()=>{a===(null==i?void 0:i.id)&&s===(null==i?void 0:i.annotationType)&&t.setBillboardAnnotation(null),a===(null==n?void 0:n.id)&&s===(null==n?void 0:n.annotationType)&&t.setDockedAnnotation(null)}))},this.handleDockedAnnotationChanged=()=>{this.viewData.dockedAnnotation?this.engine.broadcast(new a.I7):this.engine.broadcast(new a.f1)}}async init(e,t){this.viewData=new r.o,this.engine=t,[this.applicationData,this.layersData]=await Promise.all([t.market.waitForData(s.zH),t.market.waitForData(o.P)]),this.bindings.push(t.commandBinder.addBinding(d.y8,this.handleDockAnnotation),t.commandBinder.addBinding(d.xo,this.handleSelectAnnotation),t.commandBinder.addBinding(d.Zx,this.handlePreviewAnnotation),t.commandBinder.addBinding(d.XK,this.handleCloseAnnotation),t.commandBinder.addBinding(d.ZR,this.handleCloseBillboard),t.commandBinder.addBinding(d.Tj,this.handleCloseDockedAnnotation),t.commandBinder.addBinding(d.mS,this.handleClosingOtherAnnotations),t.subscribe(l.zM,this.handleCloseBillboard),this.applicationData.onPropertyChanged("application",this.closeOtherAnnotations),this.layersData.onPropertyChanged("currentViewId",this.handleCloseBillboard),this.viewData.onDockedAnnotationChanged(this.handleDockedAnnotationChanged)),t.market.register(this,r.o,this.viewData)}dispose(e){this.bindings.forEach((e=>{e.cancel()})),this.bindings=[],super.dispose(e)}onUpdate(){}isMatchingAnnotation(e,t,i){return!(!i&&!t)&&((!i||i===e.id)&&(!t||t===e.annotationType))}}var c=i(5272),m=i(9876);const u=h},61075:(e,t,i)=>{"use strict";i.r(t),i.d(t,{default:()=>H});var n=i(23205),a=i(70835),s=i(54244),o=i(20489),r=i(53360),d=i(72380),l=i(10657),h=i(64260),c=i(35652),m=i(89552);class u{constructor(){this.getAttachmentDetails=e=>e.mediaType?{mediaType:(0,m.ft)(e.mediaType),srcUrl:e.src,thumbnailUrl:e.src,width:e.width,height:e.height}:null,this.validate=e=>!!e&&void 0!==e.mediaType}serialize(e){const t=this.getAttachmentDetails(e);return t&&this.validate(t)?t:null}}var g=i(91183),p=i(86014),y=i(6150),v=i(17246);const w=new c.Ay("AttachmentsStore");class f extends l.g{constructor(e){super(e),this.embedSerializer=new u,this.embedDeserializer=new g.g,this.fileDeserializer=new p.x}create(e){if(0===e.length)return Promise.resolve(null);const t=e[0].parentId,i=e[0].parentType;if(e.find((e=>e.parentId!==t||e.parentType!==i)))throw new Error("Cannot attach to different parents in one request");const n=this.getViewId(),a=[],o=[];let d,l;if(e.forEach((e=>{if(e.category===r._A.EXTERNAL){const t=this.embedSerializer.serialize(e);if(!t)throw w.error("Failure attaching external attachment:",e),new Error("Could not attach External Attachment");a.push(t)}else e.category===r._A.UPLOAD&&o.push(e.id)})),i!==s.pi.COMMENT)throw new Error(`Cannot attach to attachment to a ${i}`);return d=y.AddCommentAttachments,l="addCommentAttachments",this.mutate(d,{modelId:n,parentId:t,externalAttachments:a,fileAttachments:o}).then((e=>{const t=[],i=(0,h.L)(e,`data.${l}.externalAttachments`);if(i&&Array.isArray(i))for(const e of i){const i=this.embedDeserializer.deserialize(e);i&&t.push(i)}const n=(0,h.L)(e,`data.${l}.fileAttachments`);if(n&&Array.isArray(n))for(const e of n){const i=this.fileDeserializer.deserialize(e);i&&t.push(i)}return t.reduce(((e,t)=>(e[t.id]=t,e)),{})}))}async remove(e){const{id:t,parentId:i,parentType:n}=e,a=this.getViewId(),s=await this.mutate(v.RemoveFileAttachment,{modelId:a,attachmentId:t,parentType:n,parentId:i}),o=(0,h.L)(s,"data.removeFileAttachment")||!1;return o||w.error("remove file attachment failed!"),o}async delete(e,t,i){const n=this.getViewId();return Promise.all(e.map((e=>this.mutate(v.DeleteExternalAttachment,{modelId:n,attachmentId:e,parentType:i,parentId:t}))))}getViewId(){if(!this.viewId)throw new Error("Invalid valid id!");return this.viewId}}var b=i(45704),T=i(61373),D=i(21746),C=i(24563);class P{constructor(e){const{baseUrl:t}=e;this.config=e,this.context=e.context,this.client=new D.t({baseUrl:t,server:C.vE,mdsContext:e.context})}get readonly(){return this.config.readonly}async create(...e){throw new b.E}async read(e={}){throw new b.E}async update(...e){throw new b.E}async delete(...e){throw new b.E}async query(e,t,i={}){if(!this.context.baseViewId)throw new T.V("Cannot read Attachments, no model view configured");return this.client.query(e,t,i)}async mutate(e,t,i){const{readonly:n}=this.config;if(n)throw new T.n8("Cannot write Attachments, model is in read-only mode");if(!this.context.baseViewId)throw new T.V("Cannot write Attachments, no model view configured");return this.client.mutate(e,t,i)}}var A=i(63360),S=i(88488),I=i(16276);const k=new c.Ay("file-upload-deserializer");class N{deserialize(e){if(!e||!this.validate(e))return k.debug("Deserialized invalid file attachment data from MDS",e),null;const t=new o.o;return t.id=e.id,t.created=(0,S.X)(e.created),e.mimeType&&(t.mimeType=e.mimeType,t.mediaType=(0,m.uc)(e.mimeType)),t.downloadUrl=new I.f(e.downloadUrl||"",(0,S.X)(e.validUntil,null)),t.thumbnailUrl=new I.f(e.url||"",(0,S.X)(e.validUntil,null)),t.url=new I.f(e.url||"",(0,S.X)(e.validUntil,null)),t.filename=e.filename||"",t.bytes=e.bytes||0,t.category=r._A.UPLOAD,t.width=e.imageWidth||0,t.height=e.imageHeight||0,t}validate(e){return["id","created","url","filename","mimeType","validUntil"].every((t=>t in e))}}class E{constructor(){}serialize(e){return{filename:e.file.name,contents:{filename:e.file.name,blob:e.file}}}}const O=new c.Ay("FileAttachmentStorage");class M extends P{constructor(e){super(e),this.uploadDeserializer=new N,this.uploadSerializer=new E,this.attachmentDeserializer=new p.x}async create(e,t){const i=this.context.baseViewId,n=this.uploadSerializer.serialize(e);let a;try{a=await this.client.upload(A.UploadFileAttachmentToModel,"UploadFileAttachmentToModel",Object.assign(Object.assign({},n),{modelId:i,organizationId:this.config.organizationId}),t,e.xhr)}catch(t){return O.error(t),t.code.includes("quota.exceeded")?e.error=r.t2.OVER_QUOTA:e.error=r.t2.UPLOAD_FAILED,e.progress=100,e}if(a.errors&&a.errors.length>0)O.error(a.errors),e.error=r.t2.UPLOAD_FAILED;else{const t=(0,h.L)(a,"data.uploadFileAttachmentToModel")||null;if(t){const i=this.uploadDeserializer.deserialize(t);i?(O.info("upload successful!"),e.attachment=i):(O.error("cannot create attachment"),e.error=r.t2.UPLOAD_FAILED)}else O.error("upload failed!"),e.error=r.t2.UPLOAD_FAILED}return e.progress=100,e}async delete(e){const t=await this.client.mutate(A.DeleteFileAttachment,{id:e}),i=(0,h.L)(t,"data.deleteFileAttachment")||!1;return i?O.info("upload deleted!"):O.error("upload deletion failed!"),i}async read(){var e,t,i;const n=this.context.baseViewId;if(!n)return O.error("Missing model ID"),[];const a=null!==(i=null===(t=null===(e=(await this.client.query(A.FileAttachments,{modelId:n,pageSize:1e3})).data)||void 0===e?void 0:e.fileAttachmentsByModelId)||void 0===t?void 0:t.results)&&void 0!==i?i:[],s=[];return a.forEach((e=>{const t=this.attachmentDeserializer.deserialize(e);t&&s.push(t)})),s}}var x=i(55848),B=i(4234),V=i(52937),R=i(79679);function F(e){switch(e){case R.n.PHOTO:return r.zu.IMAGE;case R.n.VIDEO:return r.zu.VIDEO;case R.n.RICH:return r.zu.RICH;default:return}}function L(e){const{height:t,width:i,thumbnail_height:n,thumbnail_width:a,cache_age:s}=e,o=(void 0===t||void 0===i)&&(a&&n),r=e.type===R.n.PHOTO?e.url:void 0,d=e.thumbnail_url||r,l=s?new Date(Date.now()+1e3*s):null;return{width:o?a:i,height:o?n:t,mediaType:F(e.type),url:new I.f(r||"",l),thumbnailUrl:new I.f(d||"",l)}}var j=i(61334),U=i(85217);class H extends n.n{constructor(){super(...arguments),this.name="attachments-module",this.loadEmbeddedAttachment=async e=>this.getUpdatedEmbed(e.attachment),this.embedMedia=async e=>{let t,i=null;const n=await this.oEmbedConsumer.getOEmbedData(e.src);return n?(i=new o.o,i.id=(0,a.W0)(),i.parentType=e.parentType,i.parentId=e.parentId,i.src=e.src,i.category=r._A.EXTERNAL,Object.assign(i,L(n)),this.attachmentsData.addPending(i),t=r.d3.EMBED_SUCCESS):t=r.d3.EMBED_FAIL,this.engine.broadcast(new d.Z4(i,t,e.parentId,e.parentType)),i},this.uploadAttachments=e=>{const{parentType:t,parentId:i,files:n}=e,a=this.attachmentsData,s=[];return n.forEach((e=>{const n=this.uploadAttachment(e,i,t).then((e=>(a.atomic((()=>{e.error?(a.removeUpload(e.id),a.addFailure(e)):e.attachment&&(e.attachment.parentId=i,e.attachment.parentType=t,a.removeUpload(e.id),a.addPending(e.attachment))})),this.engine.broadcast(new d.Uf(e)),e)));s.push(n)})),Promise.all(s)},this.onProgress=(e,t)=>{if(!e.lengthComputable)return;const i=e.total>0?Math.floor(e.loaded/e.total*100):100,n=Object.assign(Object.assign({},t),{progress:i});this.attachmentsData.updateUpload(n),this.engine.broadcast(new d.hg(n))},this.removeFailure=async e=>{this.attachmentsData.removeFailure(e.id)},this.removeAttachment=async e=>{if(this.fileAttachmentStorage.readonly)return void this.log.error("File attachment storage is readonly");const{attachment:t}=e,i=this.attachmentsData,n=i.getPendingAttachment(t.id);n?(n.category===r._A.UPLOAD&&await this.fileAttachmentStorage.delete(t.id),i.removePendingAttachment(t.id)):i.markAttachmentForDelete(t)},this.confirmAttachmentChanges=async e=>{const t=this.attachmentsData,{pendings:i,removals:n}=t,{parentId:a,parentType:o,prevParentId:d}=e,l=i.length>0||n.length>0;if(i.length>0){const e=d||a;t.iteratePending((t=>{d&&t.parentId===e&&t.parentType===o&&(t.parentId=a)}));const n=o!==s.pi.MATTERTAG?i.values:i.values.filter((e=>e.category===r._A.UPLOAD));await this.attachmentsStore.create(n)}if(n.length>0){const e=o!==s.pi.MATTERTAG?n.values:n.values.filter((e=>e.category===r._A.UPLOAD));e.length>0&&await this.deleteAttachments(e,a,o)}return this.resetAttachmentData(),l},this.cancelAttachmentUpload=async e=>{const{uploads:t}=this.attachmentsData,i=null==t?void 0:t.get(e.uploadId);(null==i?void 0:i.xhr)&&(i.xhr.abort(),this.attachmentsData.removeUpload(e.uploadId))},this.cancelAttachmentChanges=async()=>{const e=this.attachmentsData,{pendings:t,uploads:i,removals:n}=e;0===t.length&&0===n.length&&0===i.length||(this.fileAttachmentStorage.readonly?this.log.error("File attachment storage is readonly"):(t.values.forEach((e=>{e.category===r._A.UPLOAD&&this.fileAttachmentStorage.delete(e.id)})),i.length&&i.values.map((e=>this.cancelAttachmentUpload({uploadId:e.id}))),this.resetAttachmentData()))},this.deleteAttachments=async(e,t,i)=>{if(this.fileAttachmentStorage.readonly)return void this.log.error("File attachment storage is readonly");if(0===e.length)return;const n=[],a=[];this.attachmentsData.atomic((()=>{e.forEach((e=>{e.category===r._A.UPLOAD?n.push(e):e.category===r._A.EXTERNAL&&a.push(e.id)}))})),n.length>0&&await Promise.all(n.map((e=>this.attachmentsStore.remove(e)))),a.length>0&&await this.attachmentsStore.delete(a,t,i)},this.handleAttachmentViewerCommand=async e=>{const{open:t,attachments:i,attachmentId:n}=e;t&&i?this.openAttachmentViewer(i,n):this.closeAttachmentViewer()},this.immediatelyDeleteAttachment=async e=>{this.fileAttachmentStorage.readonly?this.log.error("File attachment storage is readonly"):e.id?await this.fileAttachmentStorage.delete(e.id):this.log.error("ID required to delete attachment")}}async init(e,t){this.engine=t;const[i,n]=await Promise.all([t.market.waitForData(j.P),t.market.waitForData(U.E)]),{oEmbedConsumer:a}=e,s=n.getModelOrganizationId();this.attachmentsStore=new f({context:i.mdsContext,readonly:!1});const o=()=>{this.attachmentsStore.setStoreViewId(i.getNonworkshopViewId())};o(),this.bindings.push(i.onPropertyChanged("currentViewId",o)),this.fileAttachmentStorage=new M(Object.assign({context:i.mdsContext,readonly:!s,organizationId:s},e)),this.oEmbedConsumer=await a,this.attachmentsData=new x.v,this.bindings.push(t.commandBinder.addBinding(B.bI,this.uploadAttachments),t.commandBinder.addBinding(B.Bd,this.embedMedia),t.commandBinder.addBinding(B.ib,this.loadEmbeddedAttachment),t.commandBinder.addBinding(B.ov,this.confirmAttachmentChanges),t.commandBinder.addBinding(B.Yr,this.cancelAttachmentUpload),t.commandBinder.addBinding(B.OK,this.cancelAttachmentChanges),t.commandBinder.addBinding(B.dX,(async()=>this.resetAttachmentData())),t.commandBinder.addBinding(B.fz,this.removeAttachment),t.commandBinder.addBinding(B.c4,this.removeFailure),t.commandBinder.addBinding(B.ht,this.handleAttachmentViewerCommand),t.commandBinder.addBinding(B.of,this.immediatelyDeleteAttachment)),t.market.register(this,x.v,this.attachmentsData)}async getUpdatedEmbed(e){if(e.category===r._A.EXTERNAL){const t=await this.oEmbedConsumer.getOEmbedData(e.src);return Object.assign(e,L(t)),t}return null}async uploadAttachment(e,t,i){const n={file:e,id:(0,a.W0)(),progress:0,error:null,attachment:null,parentId:t,parentType:i,xhr:new XMLHttpRequest};if(this.fileAttachmentStorage.readonly)return this.log.error("File attachment storage is readonly"),n.error=r.t2.PERMISSION_DENIED,Promise.resolve(n);const s=e.size;return 0===s?(n.error=r.t2.EMPTY_FILE,Promise.resolve(n)):s>V.LY?(n.error=r.t2.FILE_TOO_LARGE,Promise.resolve(n)):(this.attachmentsData.addUpload(n),this.fileAttachmentStorage.create(n,(e=>this.onProgress(e,n))))}resetAttachmentData(){const e=this.attachmentsData;e.atomic((()=>{e.clearPending(),e.clearRemovals(),e.clearUploads(),e.clearFailures()}))}openAttachmentViewer(e,t){this.viewerOpen=!0,this.engine.broadcast(new d.FA(e,t))}closeAttachmentViewer(){this.viewerOpen&&(this.viewerOpen=!1,this.engine.broadcast(new d.hd))}async getAllAttachments(){return this.fileAttachmentStorage.read()}}},66175:(e,t,i)=>{"use strict";i.d(t,{A:()=>a});var n=i(23205);class a extends n.n{constructor(){super(...arguments),this.name="base-controls",this.inputBindings=[]}registerActiveStateChangeBinding(){this.bindings.push(this.controls.onActiveStateChanged((()=>this.onActiveStateChanged())))}updateInputBindings(){this.controls.isActive?this.inputBindings.forEach((e=>e.renew())):this.inputBindings.forEach((e=>e.cancel()))}onActiveStateChanged(){this.controls.stop(),this.updateInputBindings()}dispose(e){super.dispose(e);for(const e of this.inputBindings)e.cancel();this.inputBindings=[]}}},18007:(e,t,i)=>{"use strict";i.d(t,{A:()=>a});var n=i(41733);class a{constructor(){this.poseControllerObservable=(0,n.p)(null)}rotateBetweenOrientations(e,t,i,n,a){return console.warn("rotateBetweenOrientations(): not implemented"),Promise.resolve()}get poseController(){return this.poseControllerObservable.value}setController(e){return this.poseControllerObservable.value=e,this}get isActive(){return null!=this.poseController}onActiveStateChanged(e){return this.poseControllerObservable.onChanged(e)}}},63516:(e,t,i)=>{"use strict";i.r(t),i.d(t,{default:()=>y});var n=i(23205),a=i(35223),s=i(68909),o=i(12183),r=i(44129),d=i(84252);const l=new s.Vector3(0,1,0),h=[{innerRadius:0,outerRadius:.42,color:d.V.MP_BRAND.clone(),opacity:.7},{innerRadius:.67,outerRadius:1,color:d.V.MP_BRAND.clone(),opacity:.7}];class c{constructor(e,t,i){this.scene=e,this.sweepData=t,this.mesh=new r.O({radius:.25,normal:l,rings:h}),this.mesh.name="CurrentPanoMarker",this.mesh.renderOrder=o.X.panoMarker,this.mesh.layers.mask=i.mask}init(){}dispose(){this.mesh.dispose()}render(){const e=this.sweepData.currentAlignedSweepObject;e&&this.move(e.floorPosition)}activate(){this.scene.add(this.mesh)}deactivate(){this.scene.remove(this.mesh)}move(e){this.mesh.position.copy(e).setY(e.y+c.floorOffset)}}c.floorOffset=.01;var m=i(48064),u=i(49191),g=i(62083),p=i(82110);class y extends n.n{constructor(){super(...arguments),this.name="current-pano-marker",this.state={markerEnabled:!1,transitionPromise:null}}async init(e,t){const i=(await t.getModuleBySymbol(a.M7)).getScene(),n=t.claimRenderLayer(this.name),[s,o]=await Promise.all([t.market.waitForData(u.A),t.market.waitForData(m.X)]);this.engine=t,this.sweepData=s,this.viewmodeData=o,this.markerRenderer=new c(i,s,n),this.bindings.push(t.commandBinder.addBinding(g.I,(async({enabled:e})=>this.setCommandOverride(e))),this.viewmodeData.makeModeChangeSubscription((()=>this.updateMarker())),this.sweepData.makeSweepChangeSubscription((()=>this.updateMarker()))),this.updateMarker()}setCommandOverride(e){this.state.commandOverride=e,this.updateMarker()}async updateMarker(){const{commandOverride:e}=this.state,t=this.viewmodeData.currentMode,i=this.sweepData.currentAlignedSweepObject,n=!1===e||(0,p.nI)(t)||t===p.N3.Transition;return this.toggleMarker(!!i&&!n)}async toggleMarker(e){const{markerEnabled:t,transitionPromise:i}=this.state;if(i&&await i,t===e)return;const n=e?this.enableMarker():this.disableMarker();return this.state.transitionPromise=n.finally((()=>{this.state.markerEnabled=e,this.state.transitionPromise=null})),this.state.transitionPromise}async enableMarker(){return this.engine.addComponent(this,this.markerRenderer)}async disableMarker(){return this.engine.removeComponent(this,this.markerRenderer)}}},829:(e,t,i)=>{"use strict";i.r(t),i.d(t,{default:()=>u});var n=i(23205),a=i(35223),s=i(82110),o=i(48064),r=i(3032),d=i(80399),l=i(49191),h=i(21959),c=i(28997),m=i(62148);class u extends n.n{constructor(){super(...arguments),this.name="cursor-controller",this.visibilityRules=[],this.disabled=!1}async init(e,t){this.bindings.push(t.commandBinder.addBinding(h.j,(async e=>{this.disabled=e.disable}))),[this.cursorMesh,this.cursorModule]=await Promise.all([t.getModuleBySymbol(a.zX),t.getModuleBySymbol(a.ep)]),this.visibilityRules.push((()=>{const e=t.market.tryGetData(o.X);return!!e&&(0,s.nI)(e.closestMode)}),(()=>{const e=t.market.tryGetData(l.A);return!!e&&!e.isSweepUnaligned(e.currentSweep)}),(()=>{const e=t.market.tryGetData(r.R);return!!e&&!e.isTourActive()}),(()=>{const e=t.market.tryGetData(d.O);return!!e&&!e.isMobile()}),(()=>{const e=t.market.tryGetData(c.o);return!!e&&e.tryGetProperty(m.Q,!0)}))}onUpdate(){this.updateCursorVisibility()}addVisibilityRule(e){this.visibilityRules.push(e)}removeVisibilityRule(e){const t=this.visibilityRules.indexOf(e);-1!==t&&this.visibilityRules.splice(t,1)}setFadeProps(e){this.cursorModule.setFadeProps(e)}updateCursorVisibility(){const e=!this.disabled&&this.visibilityRules.reduce(((e,t)=>e&&t()),!0);this.cursorMesh.setVisible(e)}setTexture(e){this.cursorModule.setTexture(e)}}},62148:(e,t,i)=>{"use strict";i.d(t,{Q:()=>n});const n="features/cursor"},1129:(e,t,i)=>{"use strict";i.r(t),i.d(t,{default:()=>h});var n=i(35223),a=i(23205),s=i(68909),o=i(40888),r=i(64488),d=i(75650),l=i(33630);class h extends a.n{constructor(){super(...arguments),this.name="cursor-data",this.fadeOutDelay=700,this.fadeOutDuration=700,this.fadeInDuration=300,this.movementThreshold=.003,this.cursorState=new r.J,this.position=new s.Vector2,this.timeToFade=0}async init(e,t){this.input=await t.getModuleBySymbol(n.mL),this.raycasterData=await t.market.waitForData(l.$),t.market.register(this,r.J,this.cursorState),this.bindings.push(this.input.registerHandler(d.$3,this.onPointerMove.bind(this))),this.fadeInDuration>this.fadeOutDelay&&this.log.warn("fadeInDuration should be less than fadeOutDelay!")}onUpdate(e){let t=!1;this.timeToFade>0&&(this.timeToFade-=e,this.timeToFade<=0&&(t=!0)),this.cursorState.opacity.tick(e),this.cursorState.commit(),t&&this.cursorState.opacity.modifyAnimation(1,0,this.fadeOutDuration)}setFadeProps(e){const{fadeOut:t,fadeIn:i}=e;this.fadeOutDuration=t&&t.duration?t.duration:this.fadeOutDuration,this.fadeOutDelay=t&&t.delay?t.delay:this.fadeOutDelay,this.fadeInDuration=i&&i.duration?i.duration:this.fadeInDuration}setTexture(e){this.cursorState.texture=e}onPointerMove(){if(null!==this.raycasterData.hit&&this.raycasterData.pointerNdcPosition.distanceToSquared(this.position)>this.movementThreshold){this.position.copy(this.raycasterData.pointerNdcPosition),this.timeToFade=this.fadeOutDelay;const e=(0,o.C)(0,this.fadeInDuration,1-this.cursorState.opacity.value);this.cursorState.opacity.modifyAnimation(this.cursorState.opacity.value,1,e),this.cursorState.commit()}}dispose(e){super.dispose(e)}}},64488:(e,t,i)=>{"use strict";i.d(t,{J:()=>s});var n=i(83916),a=i(61589);class s extends a.B{constructor(){super(),this.name="cursor",this.opacity=new n.z(0),this.texture=null}}},67507:(e,t,i)=>{"use strict";var n;i.d(t,{S:()=>n}),function(e){e[e.Reticle=0]="Reticle",e[e.GridPlane=1]="GridPlane"}(n||(n={}))},40522:(e,t,i)=>{"use strict";i.r(t),i.d(t,{default:()=>p});var n=i(23205),a=i(35223),s=i(68909),o=i(64488),r=i(33630),d=i(23847),l=i(67507),h=i(12183),c=i(44129),m=i(84252);const u=[{outerRadius:.977,innerRadius:.926,color:m.V.WHITE.clone(),opacity:1},{outerRadius:.898,innerRadius:.648,color:m.V.WHITE.clone(),opacity:.73}];class g{constructor(e,t=d.H.ALL){this.scene=e,this.layer=t,this.supportsMobile=!1,this.style=l.S.Reticle,this.bindings=[],this.onCursorDataUpdated=e=>{this.mesh.configure({opacity:e.opacity.value,texture:e.texture})},this.onPositionUpdate=e=>{if(e.hit&&e.hit.face){const t=e.hit.point.clone(),i=e.hit.face.normal;this.container.position.copy(t),this.mesh.configure({normal:i})}},this.container=new s.Group,this.container.name="cursor",this.mesh=new c.O({radius:.2,rings:u}),this.container.add(this.mesh),this.mesh.renderOrder=h.X.reticule,this.mesh.layers.mask=this.layer.mask}init(){}render(){}dispose(){this.mesh.dispose(),this.container.children.forEach((e=>{if(e.isMesh&&e!==this.mesh){e.geometry.dispose();const t=e.material;t.dispose(),t.map&&t.map.dispose()}}))}async activate(e){const t=await e.market.waitForData(o.J),i=await e.market.waitForData(r.$);this.bindings.push(t.onChanged(this.onCursorDataUpdated),i.onChanged(this.onPositionUpdate)),this.scene.add(this.container)}deactivate(){for(const e of this.bindings)e.cancel();this.bindings.length=0,this.scene.remove(this.container)}setVisible(e){this.container.visible=e}}class p extends n.n{constructor(){super(...arguments),this.name="cursor-mesh",this.setVisible=e=>{this.cursor&&this.cursor.setVisible(e)}}async init(e,t){const i=(await t.getModuleBySymbol(a.M7)).getScene(),n=t.claimRenderLayer(this.name);this.cursor=new g(i,n),t.addComponent(this,this.cursor)}get container(){return this.cursor.container}}},58408:(e,t,i)=>{"use strict";i.r(t),i.d(t,{default:()=>d});var n=i(23205),a=i(35223),s=i(40653),o=i(68909),r=i(48071);class d extends n.n{constructor(){super(...arguments),this.name="fat-caster",this.rayAssembly=new Array(d.rayCount),this.rayPlaneOrientation=new o.Quaternion,this.rayVisuals=[]}async init(e,t){this.config={debug:!!e.debug},this.raycaster=await t.getModuleBySymbol(a.sA);for(let e=0;e<d.rayCount;++e)this.rayAssembly[e]=new o.Ray;if(e.debug){const e=(await t.getModuleBySymbol(a.M7)).getScene();for(let t=0;t<d.rayCount;++t){this.rayVisuals[t]=new o.ArrowHelper(new o.Vector3,new o.Vector3);const i=this.rayVisuals[t];i.remove(i.cone),i.setLength(1e3),e.add(this.rayVisuals[t])}}}async dispose(e){const t=(await e.getModuleBySymbol(a.M7)).getScene();for(const e of this.rayVisuals)t.remove(e)}get ray(){return this.raycaster.pointer.pointerRay.clone()}cast(e,t,i=s.X.Filter.AVERAGE){const n=this.ray;return this.updateRayAssembly(n.origin,n.direction,e),this.castRays(t,i)}castRays(e,t){const i=[];let n=null;for(const t of this.rayAssembly){const a=this.raycaster.picking.pick(t.origin,t.direction,e);a&&(t===this.rayAssembly[0]&&(n=a),a.point.add(this.rayAssembly[0].origin).sub(t.origin),i.push(a))}return t(i,n,this.rayAssembly)}updateRayAssembly(e,t,i){for(const e of this.rayAssembly)e.direction.copy(t);if(this.rayPlaneOrientation.setFromUnitVectors(r.B1.FORWARD,t),this.rayAssembly[0].origin.copy(e),this.rayAssembly[1].origin.copy(r.B1.RIGHT).multiplyScalar(i).applyQuaternion(this.rayPlaneOrientation).add(e),this.rayAssembly[2].origin.copy(r.B1.UP).multiplyScalar(i).applyQuaternion(this.rayPlaneOrientation).add(e),this.rayAssembly[3].origin.copy(r.B1.LEFT).multiplyScalar(i).applyQuaternion(this.rayPlaneOrientation).add(e),this.rayAssembly[4].origin.copy(r.B1.DOWN).multiplyScalar(i).applyQuaternion(this.rayPlaneOrientation).add(e),this.rayAssembly[5].origin.copy(r.B1.UP).add(r.B1.RIGHT).setLength(i).applyQuaternion(this.rayPlaneOrientation).add(e),this.rayAssembly[6].origin.copy(r.B1.UP).add(r.B1.LEFT).setLength(i).applyQuaternion(this.rayPlaneOrientation).add(e),this.rayAssembly[7].origin.copy(r.B1.DOWN).add(r.B1.RIGHT).setLength(i).applyQuaternion(this.rayPlaneOrientation).add(e),this.rayAssembly[8].origin.copy(r.B1.DOWN).add(r.B1.LEFT).setLength(i).applyQuaternion(this.rayPlaneOrientation).add(e),this.config.debug)for(let e=0;e<this.rayVisuals.length;++e){const i=this.rayVisuals[e];i.setDirection(t),i.position.copy(this.rayAssembly[e].origin)}}}d.rayCount=9},40653:(e,t,i)=>{"use strict";i.d(t,{X:()=>n});var n,a=i(68909);!function(e){let t;!function(e){const t=e=>{for(const t of e)if(t.face)return{point:t.point,object:t.object,distance:t.distance,face:t.face};return null},i=(e,t)=>e.distance-t.distance;e.CENTER_FIRST=(e,i)=>i&&i.face?{point:i.point,normal:i.face.normal,object:i.object,distance:i.distance,face:i.face}:t(e),e.CLOSEST=e=>t(e.sort(i)),e.AVERAGE=e=>{if(0===e.length)return null;const t={point:new a.Vector3,face:{a:0,b:1,c:2,normal:new a.Vector3,materialIndex:0},distance:0,object:e[0].object};for(const i of e)t.face&&i.face&&(t.point.add(i.point),t.face.normal.add(i.face.normal));return t.point.divideScalar(e.length),t.face&&t.face.normal.divideScalar(e.length).normalize(),t};e.CENTER_GROUP=t=>(i,a,s)=>{if(a){const n=[a];for(let e=1;e<i.length&&e<3;++e){const o=i[e];if(o.face){const i=Math.abs(s[e].direction.dot(o.face.normal));a.point.distanceTo(o.point)*i<=t&&n.push(o)}}if(n.length>=3){const t=e.AVERAGE(n,null,s);if(t&&t.face&&a.face)return t.face.normal=a.face.normal,t}}const o=n(i,s,t);return o?e.AVERAGE(o,null,s):e.CENTER_FIRST(i,a,s)};const n=(e,t,n)=>{const a=e.slice().sort(i),s=[a[0]];let o;for(o=1;o<a.length&&s.length<3;++o){const e=a[o];if(e.face){const i=Math.abs(t[o].direction.dot(e.face.normal));s[0].point.distanceTo(e.point)*i>n&&(s.length=0),s.push(e)}}return s.length<3?null:s}}(t=e.Filter||(e.Filter={}))}(n||(n={}))},47060:(e,t,i)=>{"use strict";i.r(t),i.d(t,{GetFloorIntersectCommand:()=>n.X,default:()=>y});var n=i(21674),a=i(23205),s=i(35223),o=i(46785),r=i(45018),d=i(39591),l=i(34040),h=i(90302),c=i(94221),m=i(90280),u=i(68909),g=i(48071);class p extends a.n{constructor(){super(...arguments),this.name="floor-caster",this.cameraPosition=new u.Vector3,this.forwardPosition=new u.Vector3,this.targetPlane=new u.Plane}async init(e,t){this.engine=t,[this.renderer,this.cameraData,this.raycaster,this.floorsData,this.meshQuery]=await Promise.all([t.getModuleBySymbol(s.M7),t.market.waitForData(r.M),t.getModuleBySymbol(s.sA),t.market.waitForData(l.q),t.getModuleBySymbol(s.PM)]),t.commandBinder.addBinding(n.X,(e=>this.castToFloor(e.screenPosition,e.height,e.includeHiddenFloors)))}async castToFloor(e,t,i=!0){await this.engine.after(o.R.End);const n=this.renderer.getScene().camera,a=(0,d.wc)(e.x,e.y,this.cameraData.width,this.cameraData.height);let s,r=null;this.cameraPosition.set(a.x,a.y,-1).unproject(n),this.forwardPosition.set(a.x,a.y,1).unproject(n);const l=this.raycaster.picking.cast(this.cameraPosition,this.forwardPosition.clone().sub(this.cameraPosition).normalize(),i?h.c$:h.aV)[0];if(l&&l.object instanceof c.r){r=l&&l.point||null;const e=this.meshQuery.floorIdFromObject(l.object);e?s=this.floorsData.getFloor(e):r&&(s=this.floorsData.getClosestFloorAtHeight(r.y))}if(void 0!==t&&!r){this.cameraPosition.copy(this.cameraData.pose.position);const e=(0,d.OG)(this.cameraData,a);if(this.cameraData.isOrtho())e.y=t,r=e;else{const i=(0,m.kf)(this.cameraPosition,e);this.targetPlane.set(g.B1.DOWN,t),r=(0,m.qK)(this.cameraPosition,i,this.targetPlane)||null}}const u=s?s.index:-1;return{position:r,floor:u,floorIndex:u}}}const y=p},61343:(e,t,i)=>{"use strict";i.d(t,{g:()=>r});var n=i(38584),a=i(69505),s=i(26197),o=i(8430);class r{constructor(e){this.capabilites={links:{enable:e.supportLinks,keepLabels:e.keepLinkLabels}}}parse(e,t){const i=[];if(!e)return[];return e.split("[").map((function(e,t){return 0===t?e:"["+e})).forEach((e=>{const n=this.findLink(e);n?/javascript:/i.test(n.url)||(this.addLinkChunk(i,n,t),this.addTextChunk(i,e.slice(n.markdown.length))):this.addTextChunk(i,e)})),i}findLink(e){const t=e.match(/\[([^\]]*)\]\((.*)\)/);if(!t)return null;const i=t[2];let n=1,a=0;for(;a<i.length&&("("===i[a]?n++:")"===i[a]&&n--,0!==n);)a++;const s=i.length-a;return{markdown:t[0].substring(0,t[0].length-s),label:t[1],url:this.conditionallyEncode(t[2].substring(0,a))}}conditionallyEncode(e){const t=e.trim();return this.needsEncoding(t)?encodeURI(t):t}needsEncoding(e){if(e.match(o.Cv))return!0;let t=e;try{t=decodeURI(e)}catch(e){}return!1}addTextChunk(e,t){0!==t.length&&e.push({type:s.q.text,text:t})}addLinkChunk(e,t,i){if(!this.capabilites.links.enable)return void(this.capabilites.links.keepLabels&&this.addTextChunk(e,t.label));const o={label:t.label,url:t.url,type:n.J.EXT_LINK};-1===o.url.indexOf("://")&&(o.url="http://"+o.url);const r=-1!==o.url.indexOf("matterport.com/show"),d=-1!==o.url.indexOf(window.location.host+"/show");if(r||d){const e=-1!==o.url.indexOf(i),t=a.s.deserialize(o.url);e&&t?(o.type=n.J.NAVIGATION,o.navigationData=t):(o.type=n.J.MODEL,o.url+="&play=1")}e.push({type:s.q.link,link:o})}static getNumLinks(e){let t=0;return e.forEach((e=>{"link"===e.type&&void 0!==e.link&&t++})),t}}},45880:(e,t,i)=>{"use strict";i.r(t),i.d(t,{default:()=>Y,makeMattertagDeserializer:()=>k.V});var n=i(23205),a=i(35223),s=i(95577),o=i(60282),r=i(26325),d=i(80379),l=i(68781),h=i(27230),c=i(59810),m=i(71306),u=i(64464),g=i(26197),p=i(93612),y=i(61343),v=i(80788),w=i(29337),f=i(10657),b=i(35652),T=i(64260),D=i(86014),C=i(91183),P=i(54244),A=i(15151);const S=new b.Ay("mds-mattertag-serializer");class I{constructor(e,t){this.updateSerializer=e,this.mediaSerializer=t}serialize(e,t){const i=this.mediaSerializer.serialize(e),n=this.updateSerializer.serialize(e,t),a=null!==i?Object.assign(Object.assign({},i),n):n;return this.validate(a)?a:null}validate(e){if(!e)return!1;const t=["label","description","mediaUrl"].some((t=>t in e)),i=["floorId","enabled","anchorPosition"].filter((t=>!(t in e))),n=0===i.length,a=!!e.anchorPosition&&(0,A.Z)(e.anchorPosition),s=n&&t&&a;return s||S.debug("Invalid MattertagDetails:",{missingFields:i,validPosition:a}),s}}var k=i(73328);class N{serialize(e){return this.validate(e)?{sid:e.sid}:null}validate(e){const t=null!==e&&!!e.mediaType&&e.mediaType===g.q.none;return null!==e&&!!e.sid&&t}}var E=i(76863);const O=new b.Ay("mds-mattertag-serializer");class M{serialize(e){const t=this.extractMedia(e);return this.validate(t)?t:null}validate(e){if(!e)return!1;const t=["mediaUrl","mediaType"].every((t=>t in e)),i=void 0!==e.mediaType&&["rich","photo","video"].includes(e.mediaType),n=t&&i;return n||O.debug("invalid media",e,{hasRequiredFields:t,hasValidMediaType:i}),n}extractMedia(e){const t={};return e.mediaSrc&&(t.mediaUrl=e.mediaSrc),e.mediaType&&e.mediaType in x&&(t.mediaType=e.mediaType),t.mediaUrl&&t.mediaType?t:null}}const x={[g.q.photo]:[E.yg.PHOTO],[g.q.rich]:[E.yg.RICH],[g.q.video]:[E.yg.VIDEO]};var B=i(61825),V=i(76735),R=i(67433);const F=new b.Ay("mds-mattertag-serializer");class L{serialize(e,t){var i;if(!e)return null;const n={};return void 0!==e.enabled&&(n.enabled=e.enabled),void 0!==e.stemVisible&&(n.stemEnabled=e.stemVisible),void 0!==e.label&&(n.label=e.label),void 0!==e.description&&(n.description=e.description),void 0!==e.color&&(0,B._o)(e.color)&&(n.color=(new R.I).copy(e.color).getHexString()),void 0!==e.anchorPosition&&(0,A.Z)(e.anchorPosition)&&(n.anchorPosition=V.U$.toVisionVector(e.anchorPosition)),void 0!==e.anchorNormal&&(0,A.Z)(e.anchorNormal)&&(n.stemNormal=V.U$.toVisionVector(e.anchorNormal)),void 0!==e.stemHeight&&(n.stemLength=e.stemHeight),Object.prototype.hasOwnProperty.call(e,"icon")&&(n.icon=null!==(i=e.icon)&&void 0!==i?i:""),void 0!==e.keywords&&(n.keywords=e.keywords.isObservableArray?e.keywords.values():e.keywords),e.floorId&&(n.floorId=e.floorId),e.roomId&&(n.roomId=e.roomId),e.layerId&&t&&(n.layerId=e.layerId),e.objectAnnotationId&&(n.objectAnnotationId=e.objectAnnotationId),n&&this.validate(n)?n:null}validate(e){if(!e)return!1;const t=["layerId","floorId","roomId","color","label","description","enabled","stemEnabled","stemLength","stemNormal","stemDirection","anchorPosition","objectAnnotationId","keywords","icon"],i=Object.keys(e).length>0,n=Object.keys(e).every((e=>t.includes(e))),a=n&&i;return a||F.debug("Invalid MattertagPatch:",{hasContents:i,hasValidFields:n,data:e}),a}}class j{serialize(e){const t=e.fileAttachments;return void 0===t?null:{fileAttachments:t.map((e=>e.id))}}}var U=i(27140);const H=new b.Ay("MdsMattertagStore");class z extends f.g{constructor(e,t){super(e),this.includeObjectTags=t,this.layeredType=P.jM.MATTERTAG,this.prefetchKey="data.model.mattertags",this.fileAttachmentDeserializer=new D.x,this.fileAttachmentSerializer=new j,this.patchSerializer=new L,this.mediaUpdateSerializer=new M,this.mediaRemovalSerializer=new N,this.createSerializer=new I(this.patchSerializer,this.mediaUpdateSerializer),this.tagDeserializer=new k.P(this.fileAttachmentDeserializer,new C.g),this.deserializer=new w.n({deserializer:this.tagDeserializer})}async read(e){const{includeDisabled:t=!1}=this.config,i={modelId:this.getViewId(),includeDisabled:t,prefetchKey:this.prefetchKey,includeLayers:this.readLayerId()};return this.query(U.GetMattertags,i,e).then((e=>{var t,i;const n=null===(i=null===(t=null==e?void 0:e.data)||void 0===t?void 0:t.model)||void 0===i?void 0:i.mattertags;if(!n||!Array.isArray(n))return null;return(this.deserializer.deserialize(n)||[]).reduce(((e,t)=>(!this.includeObjectTags&&t.objectAnnotationId||(e[t.sid]=t),e)),{})}))}async refreshFileAttachments(e){const{includeDisabled:t=!1}=this.config,i={modelId:(null==e?void 0:e.modelId)||this.getViewId(),includeDisabled:t};return this.query(U.RefreshTagFileAttachments,i,e).then((e=>{var t,i;const n=null===(i=null===(t=null==e?void 0:e.data)||void 0===t?void 0:t.model)||void 0===i?void 0:i.mattertags;if(!n||!Array.isArray(n))return{};const a=[];for(const e of n){if(!e.id||!e.fileAttachments)throw H.error("Failure refreshing tag file attachments"),new Error("Failure refreshing tag file attachments");e.fileAttachments.forEach((e=>{const t=this.fileAttachmentDeserializer.deserialize(e);t&&a.push(t)}))}return a.reduce(((e,t)=>(e[t.id]=t,e)),{})}))}async create(e){const t=this.getViewId(),i=[];for(const n of e){const e=this.createSerializer.serialize(n,this.writeLayerId(n.layerId));if(!e)throw H.error("Failure saving tag:",n.sid,n),new Error("Could not save Mattertag");const a=n.sid;let o=", $data: MattertagDetails!";const r={modelId:t,mattertagId:a,data:e},d=this.fileAttachmentSerializer.serialize(n);d&&(o+=", $fileAttachments: [ID!]",r.fileAttachments=d.fileAttachments);const l=`\n        addMattertag(\n          modelId: $modelId,\n          mattertagId: "${a}",\n          mattertag: $data) {\n            id\n            created\n            modified\n          }\n        ${d?`addMattertagAttachments(\n            modelId: $modelId,\n            mattertagId: "${a}",\n            fileAttachments: $fileAttachments) {\n              id\n            }`:""}\n      `,h=v.gql`
        mutation AddMattertag($modelId: ID! ${o}) {
          ${l}
        }
      `,c=await this.mutate(h,r),m=(0,T.L)(c,"data.addMattertag"),u=(new s.Q).copy(n);u.sid=m.id,u.commit(),i.push(u)}return i}async update(e,t){if(!e||0===e.length)return;let i="";const n={},a=this.getViewId();n.modelId=a;let s="";for(const t of e){const e=t.sid,a=this.mediaUpdateSerializer.serialize(t),o=this.mediaRemovalSerializer.serialize(t),r=this.patchSerializer.serialize(t,!1),d=r||o||a,l=this.fileAttachmentSerializer.serialize(t);if(!(r||a||o||l))return void H.debug(`Nothing to update for tag ${e}`,t);if(d){const t=r||{};i+=`, $patch${e}: MattertagPatch!`,o&&(t.mediaUrl=""),a&&(t.mediaUrl=a.mediaUrl,t.mediaType=a.mediaType),n[`patch${e}`]=t}l&&(i+=`, $fileAttachments${e}: [ID!]`,n[`fileAttachments${e}`]=l.fileAttachments),n[`mediaType${e}`]=a&&a.mediaType,n[`mediaUrl${e}`]=a&&a.mediaUrl;s+=`\n        update${e}:\n        ${d?`patchMattertag(\n            modelId: $modelId,\n            mattertagId: "${e}",\n            patch: $patch${e}) {\n              id\n            }`:""}\n        ${l?`addMattertagAttachments(\n            modelId: $modelId,\n            mattertagId: "${e}",\n            fileAttachments: $fileAttachments${e}) {\n              id\n            }`:""}\n      `}for(const{attachment:e}of t)(null==e?void 0:e.id)&&(null==e?void 0:e.parentId)&&e.parentType?(i+=`, $parentType${e.id}: ParentType!`,n[`parentType${e.id}`]=e.parentType,s+=`\n        unattach${e.id}:\n        removeFileAttachment(modelId: $modelId,\n                             attachmentId: "${e.id}",\n                             parentType: $parentType${e.id},\n                             parentId: "${e.parentId}") `):H.debug("MattertagStore.update: unable to remove file attachment");const o=v.gql`
      mutation tagUpdate($modelId: ID! ${i}) {
        ${s}
      }
    `;await this.mutate(o,n)}async delete(e){if(!e||0===e.length)return;const t=this.getViewId();let i="";for(const t of e){if(!t||t&&!t.sid)throw new Error("MattertagStore.delete failed");i+=`delete${t.sid}: deleteMattertag(modelId: $modelId, mattertagId: "${t.sid}") `}const n=v.gql`
      mutation batchDeleteMattertag($modelId: ID!) {
        ${i}
      }
    `;return this.mutate(n,{modelId:t}).then((()=>{}))}}var G=i(45018),$=i(39591),_=i(68909),K=i(87243),X=i(61334),W=i(55415);class Y extends n.n{constructor(){super(...arguments),this.name="mattertag-data",this.monitor=null,this.filesToUnattach=[],this.refreshIds=new Set,this.getDiscPositions=(()=>{const e=[],t={},i={},n=new _.Vector3;return async a=>(e.length=0,a.tags.forEach((a=>{const s=this.data.getTag(a);s&&(i[a]||(i[a]=new _.Vector3),i[a].copy(s.anchorPosition).add(s.stemVector),t[a]||(t[a]=new _.Vector2),(0,$.bz)(this.cameraData,i[a],t[a],n),e.push({sid:a,screen:n.z>1?null:t[a],world:i[a]}))})),e)})(),this.addTag=async e=>{const t=[];return this.data.atomic((()=>{var i,n,a;for(const s of e){const{positionOptions:e,standardOptions:r,mediaOptions:d}=s,l=Object.assign(Object.assign({},e),r),h=this.createTag(s.id||(0,o.D)(11),l,(null===(i=s.attachmentOptions)||void 0===i?void 0:i.fileAttachments)||[],d);h.externalAttachments.concat((null===(n=s.attachmentOptions)||void 0===n?void 0:n.externalAttachments)||[]),h.modified=new Date,h.commit(),t.push(h.sid);for(const e of(null===(a=s.attachmentOptions)||void 0===a?void 0:a.refreshIds)||[])this.refreshIds.add(e);this.data.updateOnStaleCallbacks(h.sid)}})),t},this.editTag=async e=>{const{sid:t,positionOptions:i,standardOptions:n,mediaOptions:a}=e,s=Object.assign(Object.assign({},i),n),o=this.data.getTag(t);o&&(this.updateTag(o,s,a),o.modified=new Date,o.commit())},this.editTagAttachments=async({sid:e,attachmentOptions:t,operation:i})=>{const n=this.data.getTag(e);if(!n)return;({[m.nO.Operation.REPLACE]:function(){n.fileAttachments.replace(t.fileAttachments),n.externalAttachments.replace(t.externalAttachments)},[m.nO.Operation.ADD]:function(){n.fileAttachments.push(...t.fileAttachments),n.externalAttachments.push(...t.externalAttachments)}})[i](),n.modified=new Date,n.commit();for(const e of t.refreshIds||[])this.refreshIds.add(e);this.data.updateOnStaleCallbacks(n.sid)},this.removeTag=async e=>{const t=this.data.getTag(e.sid);if(void 0!==t&&this.data.removeTag(e.sid))return t&&t.objectAnnotationId&&this.engine.commandBinder.issueCommand(new K.lg(t.objectAnnotationId)),e.sid},this.saveNewTag=async e=>{const{id:t,properties:i,embed:n,fileAttachments:a}=e,s=n?{mediaSrc:n.src,mediaType:(0,u.KP)(n.mediaType)}:void 0;return this.createTag(t,i,a,s),this.engine.commandBinder.issueCommand(new d.F({dataTypes:[r.p.MATTERTAGS]}))},this.saveTag=async e=>{const{id:t,properties:i,pendingAttachments:n,removedAttachments:a,embed:s}=e,o=this.data.getTag(t);if(!o)return void this.log.debug("Cannot save non-existent tag");const l=s?(0,u.KP)(s.mediaType):g.q.none,h=s?s.src:"";void 0!==s&&(h===o.mediaSrc&&l!==o.mediaType||this.updateExternalAttachment(o,s));const c=void 0!==s?{mediaSrc:h,mediaType:l}:void 0;return this.updateTag(o,i,c),n.forEach((e=>{o.fileAttachments.push(e)})),this.removeFileAttachments(o,a),this.data.addTag(o),this.data.updateOnStaleCallbacks(t),this.engine.commandBinder.issueCommand(new d.F({dataTypes:[r.p.MATTERTAGS]}))}}async init(e,t){const{readonly:i,baseUrl:n,store:s,inferMeshIds:o=!1}=e;this.engine=t,this.descParser=new y.g({supportLinks:!0,keepLinkLabels:!0}),[this.cameraData,this.layersData]=await Promise.all([t.market.waitForData(G.M),t.market.waitForData(X.P)]),e.inferMeshIds&&(this.meshQueryModule=await t.getModuleBySymbol(a.PM)),this.store=s||new z({context:this.layersData.mdsContext,readonly:i,includeDisabled:!i,baseUrl:n},e.objectTagsEnabled);const d=await t.getModuleBySymbol(a.T9);this.data=new p.j,this.bindings.push(this.store.onNewData((async t=>{this.initializeTagData(t,o,e.parserOptions)})),t.commandBinder.addBinding(m.HI,this.getDiscPositions),t.commandBinder.addBinding(m.aw,this.addTag),t.commandBinder.addBinding(m.rn,this.editTag),t.commandBinder.addBinding(m.nO,this.editTagAttachments),t.commandBinder.addBinding(m.l,this.removeTag)),await this.store.refresh(),i||(this.bindings.push(t.commandBinder.addBinding(m.Ee,this.saveNewTag),t.commandBinder.addBinding(m.vZ,this.saveTag),d.onSave((()=>this.save()),{dataType:r.p.MATTERTAGS})),this.monitor=new h.F(this.data.collection,{aggregationType:c.D.Manual,shallow:!0})),this.registerRoomAssociationSource(t),t.market.register(this,p.j,this.data)}dispose(e){this.store.dispose(),super.dispose(e)}async save(){if(this.monitor&&this.monitor.commitChanges(),!this.store||!this.monitor)return void this.log.warn("Mattertags changes will NOT be saved");const e=this.monitor.getDiffRecord();this.monitor.clearDiffRecord();const t=e.map((e=>{var t;const i=e.diff.layerId||(null===(t=this.data.getTag(e.index))||void 0===t?void 0:t.layerId);return Object.assign({layerId:i},e)})).filter((e=>!this.layersData.isInMemoryLayer(e.layerId))),i=t.filter((e=>e.action===l.Xw.removed)).map((e=>({sid:e.index,layerId:e.layerId}))),n=t.filter((e=>e.action===l.Xw.added)).map((e=>this.data.getTag(e.index))),a=t.filter((e=>e.action===l.Xw.updated)).map((e=>{const t=Object.assign({sid:e.index,layerId:e.layerId},e.diff),i=this.data.getTag(e.index);return"mediaSrc"in t&&(t.mediaType=i.mediaType),t.objectAnnotationId=i.objectAnnotationId,!t.roomId&&i.roomId&&(t.roomId=i.roomId),t}));await this.store.delete(i),await this.store.create(n),await this.store.update(a,this.filesToUnattach)}initializeTagData(e,t,i){var n;const a=i?new y.g(i):this.descParser;this.data.atomic((()=>{this.layersData.replaceBackendLayers(this.data.collection,{})})),this.data.atomic((()=>{var i;for(const n in e){const s=e[n];s.parsedDescription=a.parse(e[n].description,this.layersData.currentViewId),t&&(null===(i=this.meshQueryModule)||void 0===i||i.inferMeshIdsFromPoint(s,s.anchorPosition,!1)),this.data.addTag(s)}})),this.data.onStale=async()=>{const e=[this.store.refreshFileAttachments()];for(const t of this.refreshIds)e.push(this.store.refreshFileAttachments({modelId:t}));return(await Promise.all(e)).reduce(((e,t)=>Object.assign(Object.assign({},e),t)),{})},this.data.updateOnStaleCallbacks(),null===(n=this.monitor)||void 0===n||n.clearDiffRecord()}createTag(e,t,i,n){let a=e;for(;this.data.getTag(a);)a=(0,o.D)(11);const r=new s.Q;if(r.sid=a,r.layerId=this.layersData.activeLayerId,n){const e=(0,u.n4)(n.mediaType);if(n.mediaSrc&&e){const t=(0,u.sM)(a,n.mediaSrc,e);t&&r.externalAttachments.push(t)}}t.objectAnnotationId&&(r.objectAnnotationId=t.objectAnnotationId),t.keywords&&r.keywords.replace(t.keywords);for(const e of i)r.fileAttachments.push(e);return this.updateTag(r,t,n),this.data.addTag(r),this.data.updateOnStaleCallbacks(a),r}updateTag(e,t,i){e.updateFromOptions(t,this.descParser,this.layersData.currentViewId),void 0!==(null==i?void 0:i.mediaType)&&(e.mediaType=i.mediaType),void 0!==(null==i?void 0:i.mediaSrc)&&(e.mediaSrc=i.mediaSrc.slice())}removeFileAttachments(e,t){const{fileAttachments:i}=e;t.forEach((t=>{const n=i.findIndex((e=>e.id===t.id));-1!==n?(i.splice(n,1),this.filesToUnattach.push({attachment:t,layerId:e.layerId})):this.log.debug("Attempting to remove an attachment that is not in the tag")}))}updateExternalAttachment(e,t){const{mediaSrc:i}=e;i&&e.externalAttachments.replace([]),t&&e.externalAttachments.replace([t])}registerRoomAssociationSource(e){const t=this.data;e.commandBinder.issueCommandWhenBound(new W.l({type:"mattertags",getPositionId:function*(){for(const e of t)yield{id:e.sid,roomId:e.roomId,floorId:e.floorId,position:e.anchorPosition,layerId:e.layerId}},updateRoomForId:(e,t)=>{const i=this.data.getTag(e);if(!i)throw new Error("Invalid tag id!");i.roomId=t||void 0}}))}}},20052:(e,t,i)=>{"use strict";i.d(t,{P:()=>a});var n=i(18268);class a extends n.u{constructor(e,t,i){super(),this.payload={enabled:e,previewCirclePosition:t,size:i}}}a.id="MESH_PREVIEW_POSITION"},69179:(e,t,i)=>{"use strict";i.d(t,{w:()=>s});var n=i(18268),a=i(24081);class s extends n.u{constructor(e){super(),this.payload={mode:e}}}s.modes=a.f,s.id="SET_CHUNK_RENDER_MODE"},92508:(e,t,i)=>{"use strict";i.r(t),i.d(t,{AddCommentCommand:()=>ne.YC,CancelCommentChangesCommand:()=>ne.up,CancelNewNoteCommand:()=>ne.eg,CloseNoteCommand:()=>ne.sL,Comment:()=>De,DeleteCommentCommand:()=>ne.IN,DeleteNoteCommand:()=>ne.T0,EditCommentCommand:()=>ne.lf,FilterVisibleNotesCommand:()=>ne.Xt,FocusCommentMessage:()=>ae.F,HashtagData:()=>ie.b,Note:()=>Q,NoteColorVariant:()=>_.D,NoteResolutionChangeMessage:()=>ae.a,NotesData:()=>ee,NotesFilter:()=>_.S,NotesModeToggleCommand:()=>ne.I8,NotesPhase:()=>$.f,NotesViewData:()=>te.b,NotesVisibilityFilterEnabledCommand:()=>ne.e3,OpenNoteCommentCommand:()=>ne.FV,RegisterNotesTool:()=>ne.RJ,ResolveNoteCommand:()=>ne.kr,SaveNewNoteCommand:()=>ne.x7,SaveNoteAppearanceCommand:()=>ne.Xc,SaveNoteChangesCommand:()=>ne.iT,StartNewNoteCommand:()=>ne.C0,ToggleNoteToolEditorCommand:()=>ne.dz,ToggleNotesFilterCommand:()=>ne.$l,UpdateCommentCommand:()=>ne.er,default:()=>at});var n=i(23205),a=i(9389),s=i(1803),o=i(54244),r=i(19533);const d=i.p+"images/NoteColor.png";var l=i(95226),h=i(60282),c=i(71136),m=i(57682),u=i(25591),g=i(65413),p=i(521),y=i(9321),v=i(59839),w=i(26956),f=i(55649),b=i(85217),T=i(7930),D=i(2040),C=i(33020),P=i(49191),A=i(48064),S=i(28997),I=i(80399),k=i(92590),N=i(61334),E=i(20560),O=i(27483),M=i(1902),x=i(7628),B=i(89998),V=i(30411),R=i(19974),F=i(91902),L=i(9876),j=i(87513),U=i(5272),H=i(21891),z=i(4234),G=i(89552),$=i(8085),_=i(57863),K=i(68909),X=i(61693),W=i(45021),Y=i(27974),q=i(16616);class Q extends X.v{constructor(e){super(),this.id="",this.layerId="",this.color=q.Jz,this.anchorPosition=new K.Vector3,this.stemNormal=new K.Vector3,this.stemLength=q.Ay.stem.length,this.stemEnabled=!0,this.created=new Date,this.modified=new Date,this.lastCommentMs=(new Date).getTime(),this.resolved=!1,this.user=(0,Y.A)(""),this.comments=(0,W.Z)([]),e&&Object.assign(this,e)}copy(e){return this.id=e.id,this.user=e.user,this.resolved=e.resolved,this.color=e.color,this.floorId=e.floorId,this.roomId=e.roomId,this.anchorPosition.copy(e.anchorPosition),this.stemNormal.copy(e.stemNormal),this.stemLength=e.stemLength,this.stemEnabled=e.stemEnabled,this.created.setTime(e.created.getTime()),this.modified.setTime(e.modified.getTime()),this.lastCommentMs=e.lastCommentMs,this.comments.replace(e.comments.values()),this.commit(),this}getComment(e){return this.comments.find((t=>t.id===e))||null}updateComment(e){const t=this.comments.findIndex((t=>t.id===e.id));-1!==t&&(e.assetId=this.id,this.comments.update(t,e))}deleteComment(e){const t=this.comments.findIndex((t=>t.id===e));-1!==t&&this.comments.splice(t,1)}}var J=i(61589),Z=i(54998);class ee extends J.B{constructor(e){super(),this.name="notes-data",this.notes=(0,Z.y)(e)}iterate(e){for(const t of this.notes)e(t)}updateNote(e){this.notes.has(e.id)?this.notes.get(e.id).copy(e):this.notes.set(e.id,e)}updateNoteProperties(e,t){if(this.notes.has(e)){const i=this.notes.get(e);let n=!1;void 0!==t.resolved&&t.resolved!==i.resolved&&(i.resolved=t.resolved,n=!0),void 0!==t.color&&t.color!==i.color&&(i.color=t.color,n=!0),void 0!==t.anchorPosition&&t.anchorPosition!==i.anchorPosition&&(i.anchorPosition=t.anchorPosition,n=!0),void 0!==t.stemNormal&&t.stemNormal!==i.stemNormal&&(i.stemNormal=t.stemNormal,n=!0),void 0!==t.stemLength&&t.stemLength!==i.stemLength&&(i.stemLength=t.stemLength,n=!0),void 0!==t.stemEnabled&&t.stemEnabled!==i.stemEnabled&&(i.stemEnabled=t.stemEnabled,n=!0),void 0!==t.floorId&&t.floorId!==i.floorId&&(i.floorId=t.floorId,n=!0),void 0!==t.roomId&&t.roomId!==i.roomId&&(i.roomId=t.roomId,n=!0),n&&i.commit()}}removeNote(e){this.notes.has(e)&&(this.notes.delete(e),this.commit())}getNote(e){return this.notes.get(e)}getNoteProperties(e){const t=this.notes.get(e);if(!t)return null;return Object.assign({},t)}get collection(){return this.notes}}var te=i(31717),ie=i(44045),ne=i(11707),ae=i(16457),se=i(66083),oe=i(10657),re=i(61373),de=i(35652),le=i(91183),he=i(86014),ce=i(15151),me=i(76735);const ue=new de.Ay("mds-note-serialize");class ge{constructor(){this.getNoteDetails=(e,t,i)=>{const n={enabled:!0,floorId:"",roomId:void 0};void 0!==e.floorId&&""!==e.floorId&&(n.floorId=e.floorId),void 0!==e.roomId&&""!==e.roomId&&(n.roomId=e.roomId),void 0!==e.color&&""!==e.color&&(n.color=e.color),void 0!==e.stemEnabled&&(n.stemEnabled=e.stemEnabled),void 0!==e.stemLength&&(n.stemLength=e.stemLength),void 0!==e.anchorPosition&&(0,ce.Z)(e.anchorPosition)&&(n.anchorPosition=me.U$.toVisionVector(e.anchorPosition)),void 0!==e.stemNormal&&(0,ce.Z)(e.stemNormal)&&(n.stemNormal=me.U$.toVisionVector(e.stemNormal)),void 0!==e.resolved&&(n.resolution=e.resolved?o.$X.RESOLVED:o.$X.OPEN),i&&e.layerId&&(n.layerId=e.layerId);const a={text:t};return n.comment=a,Object.keys(n).length>0?n:null},this.validate=e=>{if(!e)return!1;const t=["floorId","roomId","enabled"].filter((t=>!(t in e))),i=0===t.length,n=!!e.floorId&&"string"==typeof e.floorId,a=!!e.anchorPosition&&(0,ce.Z)(e.anchorPosition),s=i&&n&&a;return s||ue.debug("Note invalid:",{missingFields:t,validPosition:a}),s}}serialize(e,t,i){const n=this.getNoteDetails(e,t,i);return this.validate(n)?n:null}}class pe{constructor(){this.getNotePatch=(e,t)=>{if(!e)return null;const i={};return void 0!==e.floorId&&""!==e.floorId&&(i.floorId=e.floorId),void 0!==e.roomId&&""!==e.roomId&&(i.roomId=e.roomId),void 0!==e.color&&""!==e.color&&(i.color=e.color),void 0!==e.stemEnabled&&(i.stemEnabled=e.stemEnabled),void 0!==e.stemLength&&(i.stemLength=e.stemLength),void 0!==e.anchorPosition&&(0,ce.Z)(e.anchorPosition)&&(i.anchorPosition=me.U$.toVisionVector(e.anchorPosition)),void 0!==e.stemNormal&&(0,ce.Z)(e.stemNormal)&&(i.stemNormal=me.U$.toVisionVector(e.stemNormal.normalize())),t&&e.layerId&&(i.layerId=e.layerId),Object.keys(i).length>0?i:null},this.validate=e=>{if(!e)return!1;const t=["floorId","roomId","color","anchorPosition","stemNormal","stemLength","stemEnabled","stemNormal","enabled"];return Object.keys(e).every((e=>t.includes(e)))}}serialize(e,t){const i=this.getNotePatch(e,t);return i&&this.validate(i)?i:null}}var ye=i(88488),ve=i(55150);function we(e){return Object.assign({modelAccess:o.OQ.PUBLIC},e)}const fe=new de.Ay("mds-note-deserializer");class be{constructor(e,t){this.commentDeserializer=e,this.userData=t,this.validate=e=>{if(!e)return!1;const t=["id","created","modified","floor","resolution"].filter((t=>!(t in e))),i=0===t.length,n=!(!e.floor||!e.floor.id);return i&&n||fe.debug("Note invalid:",{missingFields:t,validFloor:n}),i&&n}}deserialize(e){var t;if(!e||!this.validate(e)||!e.floor)return fe.debug("Deserialized invalid Note data from MDS",e),null;const i=new Q;i.id=e.id,i.layerId=(null===(t=e.layer)||void 0===t?void 0:t.id)||"",i.floorId=e.floor.id,e.room&&e.room.id&&(i.roomId=e.room.id),i.resolved=e.resolution===o.$X.RESOLVED,i.created=(0,ye.X)(e.created),i.modified=(0,ye.X)(e.modified),i.user=this.userData.loadContributor(we(e.createdBy)),i.lastCommentMs=(0,ye.X)(e.lastCommentAt).getTime();const n=this.deserializeComments(e);if(!(n.length>0))return fe.error("Note without a comment:",i.id),null;i.comments.replace(n),e.color&&(i.color=e.color);const a=e.anchorPosition?me.U$.fromVisionVector(e.anchorPosition):void 0;a&&(i.anchorPosition=a),(0,ve.Et)(e.stemLength)&&(i.stemLength=e.stemLength);const s=e.stemNormal?me.U$.fromVisionVector(e.stemNormal):void 0;return s?(i.stemNormal=s,i.stemEnabled=!!e.stemEnabled):(i.stemNormal=new K.Vector3(0,0,0),i.stemEnabled=!!e.stemEnabled),i}deserializeComments(e){var t;const i=(null===(t=e.comments)||void 0===t?void 0:t.results)||[],n=[];return i.forEach((t=>{const i=this.commentDeserializer.deserialize(t);i&&(i.assetId=e.id,n.push(i))})),n}}class Te{constructor(){this.validate=e=>!!e}serialize(e){if(void 0===e.text)return null;const t={text:e.text};return t&&this.validate(t)?t:null}}class De extends X.v{constructor(e){super(),this.id="",this.assetId="",this.text="",this.user=(0,Y.A)(""),this.created=new Date,this.modified=new Date,this.edited=!1,this.attachments=(0,W.Z)([]),e&&Object.assign(this,e)}copy(e){return this.id=e.id,this.user=e.user,this.assetId=e.assetId,this.created.setTime(e.created.getTime()),this.modified.setTime(e.modified.getTime()),this.text=e.text,this.edited=e.edited,this.attachments=e.attachments,this.commit(),this}}const Ce=new de.Ay("mds-comment-deserializer");class Pe{constructor(e,t,i){this.fileDeserializer=e,this.embedDeserializer=t,this.userData=i}deserialize(e){if(!e||!this.validate(e))return Ce.debug("Deserialized invalid Comment data from MDS",e),null;const t=new De;t.id=e.id,t.created=(0,ye.X)(e.created),t.modified=(0,ye.X)(e.modified),e.text&&(t.text=e.text),t.edited=e.edited,t.user=this.userData.loadContributor(we(e.createdBy));const i=this.deserializeExternalAttachments(e),n=this.deserializeFileAttachments(e),a=i.concat(n).sort(((e,t)=>e.created.getTime()-t.created.getTime()));return a.length>0&&t.attachments.replace(a),t}deserializeExternalAttachments(e){const t=e.externalAttachments||[],i=[];return t.forEach((t=>{const n=this.embedDeserializer.deserialize(t);n&&(n.parentId=e.id,n.parentType=o.pi.COMMENT,i.push(n))})),i}deserializeFileAttachments(e){const t=e.fileAttachments||[],i=[];return t.forEach((t=>{const n=this.fileDeserializer.deserialize(t);n&&(n.parentId=e.id,n.parentType=o.pi.COMMENT,i.push(n))})),i}validate(e){if(!e)return!1;const t=["id","created","modified","edited","createdBy"].filter((t=>!(t in e))),i=0===t.length;return i||Ce.debug("Comment invalid:",{missingFields:t}),i}}var Ae=i(44919),Se=i(6150);const Ie=new de.Ay("MdsNoteStore");class ke extends oe.g{constructor(e,t){super(e),this.userData=t,this.layeredType=o.jM.NOTE,this.embedDeserializer=new le.g,this.fileDeserializer=new he.x,this.commentDeserializer=new Pe(this.fileDeserializer,this.embedDeserializer,this.userData),this.deserializer=new be(this.commentDeserializer,this.userData),this.createSerializer=new ge,this.patchSerializer=new pe,this.commentSerializer=new Te}async read(e){const t={modelId:this.getViewId(),ids:null,includeLayers:this.readLayerId()};return this.query(Ae.GetNotes,t,e).then((e=>{var t,i;const n=null===(i=null===(t=null==e?void 0:e.data)||void 0===t?void 0:t.model)||void 0===i?void 0:i.notes;if(!n||!Array.isArray(n))return{};const a=[];for(const e of n){const t=this.deserializer.deserialize(e);t&&a.push(t)}return a.reduce(((e,t)=>(e[t.id]=t,e)),{})}))}async readNote(e,t){const i={modelId:this.getViewId(),ids:[e],includeLayers:this.readLayerId()};return this.query(Ae.GetNotes,i,t).then((e=>{var t,i;const n=null===(i=null===(t=null==e?void 0:e.data)||void 0===t?void 0:t.model)||void 0===i?void 0:i.notes;return n&&Array.isArray(n)&&1===n.length?this.deserializer.deserialize(n[0]):null}))}async create(e,t){var i;const n=this.getViewId(),a=this.createSerializer.serialize(e,t,this.writeLayerId(e.layerId));if(!a)throw Ie.error("Failure creating note:",e.id,e),new Error("Could not create Note");const s={modelId:n,data:a,includeLayers:this.readLayerId()},o=await this.mutate(Ae.AddNote,s).catch((e=>{throw new re.YA(e)}));if(null===(i=o.data)||void 0===i?void 0:i.addNote){const e=this.deserializer.deserialize(o.data.addNote);if(e)return e.layerId&&await this.context.updateForAutoProvisionedLayer(e.layerId),e}throw new Error("Unable to create new Note")}async update(e){const t=this.getViewId(),i=e.id,n=this.patchSerializer.serialize(e,!1);if(!n||!i)throw Ie.error("Failure updating note:",i),new Error("Could not update Note");const a={modelId:t,noteId:i,data:n,includeLayers:this.readLayerId()};return this.mutate(Ae.PatchNote,a).then((e=>{var t,i;return(null===(t=e.data)||void 0===t?void 0:t.patchNote)?this.deserializer.deserialize(null===(i=e.data)||void 0===i?void 0:i.patchNote):null}))}async updateResolution(e,t){const i={modelId:this.getViewId(),noteId:e};return t?this.mutate(Ae.ResolveNote,i).then((e=>{var t;return null===(t=e.data)||void 0===t?void 0:t.resolveNote})):this.mutate(Ae.ReopenNote,i).then((e=>{var t;return null===(t=e.data)||void 0===t?void 0:t.reopenNote}))}async delete(e){const t=this.getViewId();for(const i of e)await this.mutate(Ae.DeleteNote,{modelId:t,noteId:i.id})}async createComment(e,t){const i=this.getViewId(),n=this.commentSerializer.serialize(t);if(!n)throw Ie.error("Failure creating comment:",t),new Error("Could not create Comment");const a={modelId:i,noteId:e,data:n};return this.mutate(Ae.AddNoteComment,a).then((e=>{var t;return(null===(t=e.data)||void 0===t?void 0:t.addNoteComment)?this.commentDeserializer.deserialize(e.data.addNoteComment):null}))}async updateComment(e){const t=this.getViewId(),i=e.id,n=this.commentSerializer.serialize(e);if(!n||!i)throw Ie.error("Failure updating comment:",i),new Error("Could not update Comment");const a={modelId:t,commentId:i,data:n};return this.mutate(Se.PatchComment,a).then((e=>{var t,i;return(null===(t=e.data)||void 0===t?void 0:t.patchComment)?this.commentDeserializer.deserialize(null===(i=e.data)||void 0===i?void 0:i.patchComment):null}))}async deleteComment(e){const t=this.getViewId();if(!e||!(null==e?void 0:e.id))throw new Error("MdsNoteStore.deleteComment failed");const i={modelId:t,commentId:e.id};await this.mutate(Se.DeleteComment,i)}}var Ne=i(35596),Ee=i(2789),Oe=i(87312),Me=i(57440),xe=i(93424);class Be extends Me.r{constructor(e,t,i,n,a,s,r){super(e,t,i),this.comment=n,this.note=a,this.textParser=s,this.asWholeNote=r,this.id=this.comment.id,this.parentId=this.note.id,this.title=this.comment.user.name,this.description=this.textParser.getPlainText(this.comment.text),this.icon="icon-comment",this.typeId=o.jM.NOTE,this.floorId=this.note.floorId,this.roomId=this.note.roomId||"",this.layerId=this.note.layerId,this.dateBucket=this.getNoteOrCommentDateBucket(),this.color=this.note.color,this.resolved=this.note.resolved,this.numAttachments=this.comment.attachments.length,this.numComments=this.note.comments.length,this.user=this.comment.user,this.enabled=!this.note.resolved,this.onSelect=async(e,t,i)=>{super.onSelect(),await this.commandBinder.issueCommand(new F.mS);const n=t===p.S0.NOTES||i||e;this.commandBinder.issueCommand(new ne.FV(this.note.id,n,!1,this.comment.id))}}supportsLayeredCopyMove(){return!0}supportsBatchDelete(){return!0}getNoteOrCommentDateBucket(){return(0,xe.n)(new Date(this.asWholeNote?this.note.lastCommentMs:this.comment.created))}}var Ve=i(99366);const{NOTES:Re}=Ve.A.SHOWCASE;var Fe=i(80379),Le=i(26325),je=i(68340),Ue=i(55415),He=i(74848),ze=i(82856),Ge=i(77704),$e=i(75716),_e=i(95178),Ke=i(72322),Xe=i(39204),We=i(86889),Ye=i(57037),qe=i(86890);const{NOTES:Qe}=Ve.A.SHOWCASE;function Je(){const e=(0,Ge.r)(),t=ze.Hj.DATE,i=!!(0===(0,$e.W)().length)||void 0;let n;const a=(0,Ke.X)();if(!(0,_e.M)())switch(a){case _.S.OPEN:n=Qe.HAVE_NONE_OPEN;break;case _.S.RESOLVED:n=Qe.HAVE_NONE_RESOLVED;break;default:n=Qe.HAVE_NONE}return(0,He.jsx)(Xe._,{children:(0,He.jsx)("div",Object.assign({className:"panel-list"},{children:(0,He.jsx)(Ye.x,{renderItem:We.B,renderGroup:qe.m,activeItemId:null==e?void 0:e.id,grouping:t,excludeEmptyGroups:i,emptyPhrase:n})}))})}var Ze=i(3744),et=i(33810);class tt{constructor(){this.renderPanel=()=>(0,He.jsx)(Je,{}),this.renderPersistentOverlay=()=>(0,He.jsx)(et.T,{parentTool:p.S0.NOTES},"notes-panel-ui"),this.renderOverlay=()=>(0,He.jsx)(Ze.A,{})}}var it=i(47544);class nt extends n.n{constructor(){super(...arguments),this.name="notes",this.activated=!1,this.registered=!1,this.activeBindings=[],this.refreshPromise=null,this.pollOnNotes=()=>{let e;return(0,s.Sh)((()=>{clearInterval(e),e=window.setInterval((()=>{this.refreshNotes()}),1e3*q.RU)}),(()=>{window.clearInterval(e)}),!0)},this.modelViewChanged=()=>{this.cancelNoteCreation(!0)},this.updatePerSettings=()=>{const e=this.settingsData.tryGetProperty(q.nH,!1),t=!this.in360View(),i=!this.interactionmodeData.isVR(),n=t&&i&&e,a=n?this.getFilteredNoteIds(!1):[];this.engine.commandBinder.issueCommand(new x.FI(B.yY.NOTE,n?1:0,a)),n||this.closeNoteBillboard()},this.registerNotesTool=async()=>{const e=new g.N({id:p.S0.NOTES,deepLinkParam:"note",searchModeType:o.jM.NOTE,namePhraseKey:Ve.A.TOOLS.NOTES,panel:!0,icon:"icon-comment-outline",analytic:"notes",palette:p.o6.VIEW_BASED,order:80,dimmed:!1,enabled:this.settingsData.tryGetProperty(se.nc,!1),hidesAppBar:!0,ui:new tt,manager:new it.y(this.engine,this.settingsData),helpMessagePhraseKey:Ve.A.TOOLS.NOTES_HELP_MESSAGE,helpHref:"https://support.matterport.com/s/article/Matterport-Notes"});this.engine.commandBinder.issueCommand(new y.Kw([e]))},this.toggleNotesMode=async e=>{e.opened?this.activateTool():this.deactivateTool()},this.togglePinAssetEditor=async e=>{this.viewData.setActiveNotation(null),e.opened?this.changeNotesPhase($.f.EDITING):this.viewData.notesPhase===$.f.EDITING&&this.changeNotesPhase($.f.OPEN)},this.toggleNotesFilter=async e=>{const{filter:t,enabled:i}=e;i?this.viewData.setNotesFilter(t):this.viewData.setNotesFilter(_.S.ALL)},this.openNoteToComment=async e=>{const{noteId:t,commentId:i,dock:n,edit:a,transition:s}=e,o=this.viewData,r=o.getNoteView(t);if(!r)return void this.log.error(`Missing note ${t}`);const{notesFilter:d}=o,l=d===_.S.RESOLVED;d!==_.S.ALL&&r.resolved!==l&&o.setNotesFilter(_.S.ALL);const h=n||a,m=this.toolsData.toolPanelLayout===p.L$.SIDE_PANEL?c.fl.FadeToBlack:c.fl.Instant;await this.openNote(t,s||m,h,i,a),this.openAnnotation(t,h)},this.onAppChange=()=>{this.deactivateTool(),this.updatePerSettings(),this.displayNotes()},this.onNotesPhaseChanged=()=>{let e=!0;const t=this.toolsData.toolPanelLayout===p.L$.BOTTOM_PANEL;switch(this.viewData.notesPhase){case $.f.EDITING:case $.f.CREATING:e=!1;break;case $.f.OPENING:case $.f.OPEN:e=!t}this.engine.broadcast(new v.Vk(e))},this.changeNotesPhase=e=>{e!==this.viewData.notesPhase&&this.viewData.setNotesPhase(e)},this.onCloseNote=async()=>{this.closeNote()},this.pinAddCancelled=e=>{e.pinType===B.yY.NOTE&&this.cancelNoteCreation(!1)},this.onCancelNewNote=async()=>{this.cancelNoteCreation(!0)},this.cancelNoteCreation=e=>{var t;if(!this.userData.isCommenter())return;const i=this.viewData,n=null===(t=i.openNoteView)||void 0===t?void 0:t.id;n&&(e&&this.engine.commandBinder.issueCommand(new x.hd(n,B.yY.NOTE)),this.engine.commandBinder.issueCommand(new F.XK(n,L.U.NOTE))),this.cancelAttachmentChanges(),i.setActiveNotation(null),i.setOpenNoteView(null),i.setFocusedComment(null),i.isNewNote=!1,i.commit(),this.changeNotesPhase($.f.IDLE)},this.notesWereChanged=()=>{this.parseNotes(),this.updateNoteViewData(),this.displayNotes()},this.onNoteFilterChanged=()=>{this.viewData.setOpenNoteView(null),this.viewData.setFocusedComment(null),this.updateNoteViewData(),this.displayNotes()},this.onViewModeOrFloorChanged=()=>{this.updatePerSettings()},this.onLayersChanged=()=>{this.closeNoteBillboard(),this.displayNotes()},this.onElementsChanged=({added:e,updated:t,removed:i})=>{if(e&&e.length){const t=e.map((([,e])=>this.getPinUpdate(e)));this.engine.commandBinder.issueCommand(new x.wn(t))}if(t&&t.length){const e=t.map((([,e])=>this.getPinUpdate(e)));this.engine.commandBinder.issueCommand(new x.wn(e))}null==i||i.forEach((([,e])=>{this.removeNotePin(e)}))},this.onOpenNoteViewChanged=()=>{const e=this.viewData.openNoteView;e&&this.updateNotePin(e)},this.startNoteCreation=async()=>{if(!this.userData.isCommenter())return;this.toolsData.softOpening&&await this.engine.commandBinder.issueCommand(new y.Wm(p.S0.NOTES,!1));const e=this.viewData,t=this.appData.application===Ne.lg.WORKSHOP;let i=(0,h.D)(11);for(;this.notesData.getNote(i);)i=(0,h.D)(11);const n=new Q;n.user=this.userData.getCurrentUser(),n.id=i,n.floorId=this.floorsViewData.getHighestVisibleFloorId(),n.layerId=this.layersData.getNotesLayerId(t);const a=e.createNoteView(n);e.isNewNote=!0,e.commit(),this.changeNotesPhase($.f.CREATING),e.setOpenNoteView(a),e.setFocusedComment(null),this.engine.commandBinder.issueCommand(new x.Zs(n.id,this.getPinUpdate(n),B.yY.NOTE,a.backgroundTexture))},this.saveNewNote=async e=>{if(!this.userData.isCommenter())return;const{text:t}=e,i=this.viewData,n=i.getPendingNote();if(n){if(this.layersData.isInMemoryLayer(n.layerId)){const e=new Q(n);return this.notesData.updateNote(e),i.setActiveNotation(null),i.isNewNote=!1,i.commit(),void this.updateNoteViewData()}const e=await this.store.create(n,t);if(!e)return void this.log.error("MDS Note saved failed");const a=e.comments.get(0);if(!a)throw new Error("No root comment in the new note");const s=await this.confirmAttachmentChanges(a.id,n.id);this.notesData.updateNote(e),s&&await this.refreshNote(e.id),this.parseMarkdown(t),i.setOpenNoteView(i.getNoteView(e.id));const o=i.openNoteView;if(o){const t=(0,H.q2)(this.userData,L.U.NOTE,o.user);this.engine.commandBinder.issueCommand(new x.Rg(e.id,B.yY.NOTE,t)),this.engine.commandBinder.issueCommand(new x.z5(n.id,B.yY.NOTE))}i.setActiveNotation(null),i.isNewNote=!1,i.commit(),this.updateNoteViewData()}else this.log.debug("No pending note")},this.pinMoved=async e=>{const{id:t,pinType:i,pinPos:n}=e,a=this.viewData.openNoteView;if(a&&i===B.yY.NOTE&&t===a.id){const e=this.notesData.getNote(t);if(e){if(this.layersData.isInMemoryLayer(e.layerId))return;const{anchorPosition:i,stemNormal:a,floorId:s,roomId:o}=n;this.store.update({id:t,anchorPosition:i,stemNormal:a,floorId:s,roomId:o}).then((e=>{e&&this.notesData.updateNote(e)}))}else this.log.debug("Cannot move a non-existent note")}},this.pinPlaced=e=>{const t=this.viewData.openNoteView;t&&e.pinType===B.yY.NOTE&&e.id===t.id&&(this.viewData.updateOpenNoteView(e.pinPos),this.changeNotesPhase($.f.OPEN),this.viewData.setActiveNotation(t.id),this.openAnnotation(t.id,!0))},this.onEditComment=async e=>{this.viewData.setActiveNotation(e.id)},this.handlePinFocusChange=async()=>{const{openNoteView:e,isNewNote:t}=this.viewData;if(t)return;const{commandBinder:i}=this.engine,{focusedPin:n,selectedPinId:a}=this.pinsViewData,{billboardAnnotation:s,billboardSelected:o}=this.annotationsViewData;if(!n)return void(s&&s.annotationType===L.U.NOTE&&s.id!==a&&this.closeNoteBillboard());const r=(null==e?void 0:e.id)===(null==s?void 0:s.id)&&o,d=e&&(null==e?void 0:e.id)===(null==n?void 0:n.id);if(e&&r&&!d&&this.closeNote(),n.pinType===B.yY.NOTE){const t=this.viewData.getNoteView(n.id);if(!t)return void this.log.debug("Focused pin changed, but no note view.");t.id!==(null==e?void 0:e.id)&&i.issueCommand(new F.Zx(t.id,L.U.NOTE))}},this.handleAnnotationsChanged=async()=>{const{openNoteView:e,isNewNote:t,focusedComment:i}=this.viewData;if(t)return;const{softOpening:n}=this.toolsData,{dockedAnnotation:a,selectedAnnotation:s}=this.annotationsViewData,o=a||s,r=(null==a?void 0:a.annotationType)===L.U.NOTE&&a,d=(null==s?void 0:s.annotationType)===L.U.NOTE&&s,l=r||d,h=!!r;l&&l.id!==(null==e?void 0:e.id)?await this.openNote(l.id,null,h):e&&e.id!==(null==o?void 0:o.id)&&this.closeNote(),h?(this.activated||await this.engine.commandBinder.issueCommand(new y.Wm(p.S0.NOTES,!0)),i&&this.engine.broadcast(new ae.F(i.id))):this.activated&&n&&await this.engine.commandBinder.issueCommand(new y.u3(p.S0.NOTES))},this.handlePinSelectionChange=async()=>{const{openNoteView:e,activeNotation:t}=this.viewData,{selectedPinId:i}=this.pinsViewData;if(t||(null==e?void 0:e.id)===i)return;const n=i?this.pinsViewData.getPin(i):null;if(!e||n&&n.pinType===B.yY.NOTE){if(i&&n&&n.pinType===B.yY.NOTE){const t=(0,H.q2)(this.userData,L.U.NOTE,null==e?void 0:e.user);this.engine.commandBinder.issueCommand(new x.HR(i,!!t));const n=!0;await this.openNote(i,c.fl.Interpolate,n),this.openAnnotation(i,n)}}else{const e=!this.toolsData.softOpening;this.activated&&!e?await this.engine.commandBinder.issueCommand(new y.u3(p.S0.NOTES)):this.closeNote()}},this.handleViewingAttachment=e=>{const{annotationType:t,id:i,attachmentId:n}=e;if(t!==L.U.NOTE)return;const a=this.viewData.getNoteAttachments(i),s=a.find((e=>e.id===n));if(s&&(0,G.rV)(s)){const e=a.filter((e=>(0,G.rV)(e)));this.engine.commandBinder.issueCommand(new z.ht(!0,e,n))}},this.deleteNote=async e=>{const t=e.noteId,i=this.notesData.getNote(t);if(i){this.engine.commandBinder.issueCommand(new f.r),this.layersData.isInMemoryLayer(i.layerId)||this.store.delete([i]),this.notesData.removeNote(t);const e=this.viewData.openNoteView;e&&e.id===t&&this.closeNote(),this.engine.commandBinder.issueCommand(new x.z5(t,B.yY.NOTE))}else this.log.debug("Cannot delete a non-existent note")},this.onResolveNoteCommand=async e=>{const{noteId:t,resolved:i}=e;i?await this.resolveNote(t):await this.reopenNote(t)},this.onSaveNoteChanges=async e=>{const{noteId:t,text:i}=e,n=this.notesData.getNote(t);if(n){const e=n.comments.get(0);if(e)return this.updateNoteComment(t,e.id,i);this.log.warn("no root comment")}else this.log.debug("Cannot update a non-existent note")},this.cancelCommentChanges=async e=>{this.cancelAttachmentChanges(),this.viewData.setActiveNotation(null)},this.saveNoteAppearance=async e=>{const t=this.notesData,{noteId:i,properties:n}=e,a=t.getNote(i);if(a){const e=this.viewData,{openNoteView:s}=e;if(Object.keys(n)){const o=this.layersData.isInMemoryLayer(a.layerId)?Object.assign(a,n):await this.store.update(Object.assign({id:i},n));o&&(this.updateNotePin(o),t.updateNote(o),(null==s?void 0:s.id)===i&&e.updateOpenNoteView(n))}}else this.log.debug("Cannot update a non-existent note")},this.addComment=async e=>{const{noteId:t,text:i,replyId:n}=e,a=this.notesData.getNote(t);if(a){a.resolved&&(this.viewData.setNotesFilter(_.S.ALL),this.reopenNote(a.id));const e=await this.store.createComment(t,{text:i});return e?(this.viewData.setActiveNotation(null),this.parseMarkdown(i),await this.confirmAttachmentChanges(e.id,n),await this.refreshNote(a.id),this.refreshNotes(),e):(this.log.error("Cannot create MDS comment"),null)}return this.log.debug("Cannot add a comment to a non-existent note"),null},this.onUpdateComment=async e=>{const{noteId:t,commentId:i,text:n}=e;return this.updateNoteComment(t,i,n)},this.deleteComment=async e=>{const{commentId:t,noteId:i}=e,n=this.notesData.getNote(i);if(n){const e=n.getComment(t);e&&(this.layersData.isInMemoryLayer(n.layerId)||await this.store.deleteComment(e),n.deleteComment(t)),this.refreshNotes()}else this.log.debug("Cannot delete a comment in a non-existent note")},this.notationBlockClicked=async e=>{const{annotationType:t,block:i}=e;t===L.U.NOTE&&(i.blockType!==u.n.USER&&i.blockType!==u.n.HASH||(this.activated&&!this.toolsData.softOpening||await this.engine.commandBinder.issueCommand(new y.Wm(p.S0.NOTES,!1)),this.engine.commandBinder.issueCommand(new Oe.tA(i.text||"")),i.text&&this.closeNote()))},this.filterVisibleNotes=async e=>{const{idVisibility:t}=this.viewData;t.clear(),e.ids.forEach((e=>t.add(e))),this.viewData.commit(),this.displayNotes()},this.noteVisbilityFilterEnabled=async e=>{this.viewData.idVisibilityEnabled=e.enabled,this.viewData.commit(),this.displayNotes()}}async init(e,t){const[i,n,s,l]=await Promise.all([t.market.waitForData(S.o),t.market.waitForData(I.O),t.market.waitForData(b.E),t.market.waitForData(Ne.zH)]);if(!s.isLoggedIn()||n.isVR()||!i.tryGetProperty(se.nc,!1))return;this.engine=t,this.config=e,this.interactionmodeData=n,this.userData=s,this.settingsData=i,this.appData=l;const[h,c,u,g,p,y,v]=await Promise.all([t.market.waitForData(w.M),t.market.waitForData(P.A),t.market.waitForData(A.X),t.market.waitForData(k.X),t.market.waitForData(j.o),t.getModuleBySymbol(a.r),t.market.waitForData(N.P)]);this.toolsData=h,this.sweepData=c,this.viewmodeData=u,this.floorsViewData=g,this.annotationsViewData=p,this.linkHandler=y,this.layersData=v;const{readonly:f,baseUrl:T}=this.config;this.store=new ke({context:v.mdsContext,readonly:f,includeDisabled:!0,baseUrl:T},this.userData);const D=()=>{this.store.setStoreViewId(v.getNonworkshopViewId())};D(),this.bindings.push(v.onPropertyChanged("currentViewId",D),v.onPropertyChanged("activeLayerId",(()=>this.updatePendingNote())),this.store.onNewData((async e=>{this.loadNewNotes(e)}))),this.notesData=new ee({}),this.textParser=new m.r({links:!0,hashtags:!0,users:this.userData}),this.backgroundTexture=(0,r.y)(d),this.viewData=new te.b(this.notesData,this.textParser,this.linkHandler,this.backgroundTexture),this.hashtagData=new ie.b,t.market.register(this,ie.b,this.hashtagData),this.pinsViewData=await t.market.waitForData(V.U),this.bindings.push(i.onPropertyChanged(q.nH,this.updatePerSettings),t.commandBinder.addBinding(ne.RJ,this.registerNotesTool),t.commandBinder.addBinding(ne.I8,this.toggleNotesMode),t.commandBinder.addBinding(ne.T0,this.modifyInsideSaveCommand(this.deleteNote)),this.pinsViewData.onFocusedPinChanged(this.handlePinFocusChange),this.pinsViewData.onSelectedPinChanged(this.handlePinSelectionChange),p.onChanged(this.handleAnnotationsChanged),t.subscribe(U.z,this.handleViewingAttachment),t.subscribe(U.v,this.notationBlockClicked),t.commandBinder.addBinding(ne.FV,this.openNoteToComment),t.subscribe(C.E5,this.onAppChange),u.makeModeChangeSubscription(this.onViewModeOrFloorChanged),g.makeFloorChangeSubscription(this.onViewModeOrFloorChanged),t.subscribe(E.A,this.updatePerSettings),t.subscribe(O.b,this.updatePerSettings),this.layersData.onCurrentLayersChanged(this.onLayersChanged),t.commandBinder.addBinding(ne.Xt,this.filterVisibleNotes),t.commandBinder.addBinding(ne.e3,this.noteVisbilityFilterEnabled),this.pollOnNotes(),this.viewData.onOpenNoteViewChanged(this.onOpenNoteViewChanged),this.notesData.onChanged(this.notesWereChanged),this.notesData.collection.onElementsChanged(this.onElementsChanged.bind(this)),t.subscribe(je.tj,this.modelViewChanged)),t.market.register(this,te.b,this.viewData),this.updatePerSettings(),this.parseNotes(),this.registerRoomAssociationSource(t),async function(e,t,i,n,a,s,r){let d=n.application===Ne.lg.WORKSHOP;const l=(n,s,o,r=[])=>{const l=[],h=t.getFilteredNotesMap().values,c=!o,m=[];return 0===r.length&&h.forEach((t=>{if(!d&&!i.layerToggled(t.layerId))return;let o=0;t.comments.forEach(((r,d)=>{c&&d>0||n(r.user.name,a.getPlainText(r.text))&&(o++,l.push(new Be(e,i,s,r,t,a,c)))})),o>0&&m.push(t.id)})),e.issueCommand(new ne.Xt(m)),l},h=t=>{e.issueCommand(new ne.e3(!!t))},c=e=>new Ee.P(t.getFilteredNotesMap().onChanged(e),s.onChanged(e)),m={renew:()=>{e.issueCommandWhenBound(new Oe.Oc({id:o.jM.NOTE,groupPhraseKey:Re.SEARCH_GROUP_HEADER_NOTES,groupMatchingPhraseKey:Re.SEARCH_GROUP_HEADER,getSimpleMatches:l,registerChangeObserver:c,onSearchActivatedChanged:h,groupOrder:50,groupIcon:"comment-outline",batchSupported:!0}))},cancel:()=>{e.issueCommandWhenBound(new Oe.tf(o.jM.NOTE))}},u=()=>{d=n.application===Ne.lg.WORKSHOP,r.tryGetProperty(se.nc,!1)||d?m.renew():m.cancel()},g=n.onPropertyChanged("application",u),p=r.onPropertyChanged(se.nc,u);return u(),new Ee.P(m,g,p)}(t.commandBinder,this.viewData,this.layersData,l,this.textParser,this.userData,this.settingsData).then((e=>this.bindings.push(e))),await this.refreshNotes(),t.market.register(this,ee,this.notesData)}dispose(e){this.deactivateTool(),this.bindings.forEach((e=>{e.cancel()})),this.bindings=[],this.activeBindings=[],this.engine.commandBinder.issueCommand(new x.Ni(B.yY.NOTE)),this.backgroundTexture.dispose(),this.store.dispose(),super.dispose(e)}onUpdate(){}async refreshNotes(){if(this.refreshPromise)return;const e=this.viewData,{isNewNote:t,notesPhase:i}=e;t||i===$.f.EDITING||(this.refreshPromise=this.store.refresh().finally((()=>{this.refreshPromise=null})))}loadNewNotes(e){var t;const{viewData:i}=this,n=null===(t=i.openNoteView)||void 0===t?void 0:t.id,a=n?{[n]:this.notesData.getNote(n)}:{};this.notesData.atomic((()=>{this.layersData.replaceBackendLayers(this.notesData.collection,a)})),this.notesData.atomic((()=>{this.layersData.replaceBackendLayers(this.notesData.collection,e)})),n&&!e[n]&&(this.log.debug("Open note was deleted"),i.setOpenNoteView(null),i.setFocusedComment(null),i.setActiveNotation(null),i.setNotesPhase($.f.IDLE))}async refreshNote(e){if(this.refreshPromise)return;const t=this.notesData.getNote(e);if(this.layersData.isInMemoryLayer(null==t?void 0:t.layerId))this.notesData.updateNote(t);else{const t=await this.store.readNote(e);t&&this.notesData.updateNote(t)}}activateTool(){this.activated||(this.engine.commandBinder.issueCommand(new F.mS(L.U.NOTE)),this.userData.isCommenter()&&this.engine.commandBinder.issueCommand(new x.fZ(!0)),this.changeNotesPhase($.f.IDLE),this.updateNoteViewData(),this.registered?this.activeBindings.forEach((e=>{e.renew()})):this.registerHandlers(),this.activated=!0)}deactivateTool(e){var t;if(!this.activated)return;this.activated=!1;const{isNewNote:i,openNoteView:n}=this.viewData,a=(null===(t=this.annotationsViewData.dockedAnnotation)||void 0===t?void 0:t.annotationType)===L.U.NOTE;i?this.cancelNoteCreation(!0):n&&(e||a)&&this.closeNote(),this.changeNotesPhase($.f.CLOSED),this.engine.commandBinder.issueCommand(new x.mf),this.engine.commandBinder.issueCommand(new x.fZ(!1)),this.activeBindings.forEach((e=>{e.cancel()}))}registerHandlers(){const e=this.engine.commandBinder;this.activeBindings.push(this.engine.subscribe(R.yi,this.pinPlaced),this.engine.subscribe(R.cC,this.modifyInsideSaveCommand(this.pinMoved)),this.engine.subscribe(R.lY,this.pinAddCancelled),e.addBinding(ne.C0,this.startNoteCreation),e.addBinding(ne.x7,this.modifyInsideSaveCommand(this.saveNewNote)),e.addBinding(ne.eg,this.onCancelNewNote),e.addBinding(ne.sL,this.onCloseNote),e.addBinding(ne.iT,this.modifyInsideSaveCommand(this.onSaveNoteChanges)),e.addBinding(ne.up,this.cancelCommentChanges),e.addBinding(ne.lf,this.onEditComment),e.addBinding(ne.kr,this.modifyInsideSaveCommand(this.onResolveNoteCommand)),e.addBinding(ne.YC,this.modifyInsideSaveCommand(this.addComment)),e.addBinding(ne.er,this.modifyInsideSaveCommand(this.onUpdateComment)),e.addBinding(ne.IN,this.modifyInsideSaveCommand(this.deleteComment)),e.addBinding(ne.Xc,this.modifyInsideSaveCommand(this.saveNoteAppearance)),e.addBinding(ne.dz,this.togglePinAssetEditor),e.addBinding(ne.$l,this.toggleNotesFilter),this.viewData.onNotesFilterChanged(this.onNoteFilterChanged),this.viewData.onNotesPhaseChanged(this.onNotesPhaseChanged)),this.registered=!0}async parseNotes(){const e=[],t=[];return this.notesData.iterate((i=>{i.comments.forEach((i=>{const n=this.getUserMentionsAndHashtags(i.text);n.emails.forEach((t=>{e.push({email:t,userStatus:T._.MENTIONED})})),t.push(...n.hashtags)}))})),this.hashtagData.addHashtags(t),this.engine.commandBinder.issueCommand(new D.qO(e))}async parseMarkdown(e){const t=[],i=this.getUserMentionsAndHashtags(e);return i.emails.forEach((e=>{t.push({email:e,userStatus:T._.MENTIONED})})),this.hashtagData.addHashtags(i.hashtags),this.engine.commandBinder.issueCommand(new D.qO(t))}getUserMentionsAndHashtags(e){const t=[],i=[];for(const n of this.textParser.parse(e))n.blockType===u.n.USER&&n.value?t.push(n.value):n.blockType===u.n.HASH&&i.push(n.text);return{emails:t,hashtags:i}}closeNoteBillboard(){const{billboardAnnotation:e}=this.annotationsViewData;e&&e.annotationType===L.U.NOTE&&this.engine.commandBinder.issueCommand(new F.XK(e.id,L.U.NOTE))}openAnnotation(e,t){t?this.engine.commandBinder.issueCommand(new F.y8(e,L.U.NOTE)):this.engine.commandBinder.issueCommand(new F.xo(e,L.U.NOTE))}in360View(){const e=this.sweepData.currentSweep?this.sweepData.currentSweep:"";return this.viewmodeData.isInside()&&this.sweepData.isSweepUnaligned(e)}async closeNote(){var e;const{commandBinder:t}=this.engine,{openNoteView:i,notesPhase:n}=this.viewData;if(this.viewData.setActiveNotation(null),this.viewData.setOpenNoteView(null),this.viewData.setFocusedComment(null),n!==$.f.CLOSED&&this.changeNotesPhase($.f.IDLE),i){const n=i.id;this.cancelAttachmentChanges(),t.issueCommand(new Oe.Xx(null)),t.issueCommand(new z.ht(!1));const a=this.notesData.getNote(n);a&&(t.issueCommand(new x.mP(n,B.yY.NOTE)),t.issueCommand(new x.f5(n,B.yY.NOTE,this.getNoteVisibility(n,a.layerId,i.resolved))));(null===(e=this.annotationsViewData.dockedAnnotation)||void 0===e?void 0:e.annotationType)===L.U.NOTE&&await t.issueCommand(new F.Tj)}}updateNoteViewData(){this.viewData.updateNoteViews()}getFilteredNoteIds(e){const t=[];return this.notesData.iterate((i=>{this.getNoteVisibility(i.id,i.layerId,i.resolved)===e&&t.push(i.id)})),t}getNoteVisibility(e,t,i){if(!this.settingsData.tryGetProperty(q.nH,!1))return!1;const{notesFilter:n,openNoteView:a,idVisibilityEnabled:s,idVisibility:o}=this.viewData,r=this.appData.application===Ne.lg.WORKSHOP||this.layersData.layerToggled(t),d=this.layersData.layerVisible(t),l=(null==a?void 0:a.id)===e,h=!s||o.has(e),c=n===_.S.ALL||i&&n===_.S.RESOLVED||!i&&n===_.S.OPEN;return r&&(l||c&&h&&d)}displayNotes(){const e=[];this.notesData.iterate((t=>{const i=this.getPinUpdate(t);e.push(i)})),e.length&&this.engine.commandBinder.issueCommand(new x.wn(e))}updateNotePin(e){const t=this.getPinUpdate(e);this.engine.commandBinder.issueCommand(new x.wn([t]))}getPinUpdate(e){const{id:t,layerId:i,resolved:n,anchorPosition:a,color:s,stemEnabled:o,floorId:r,roomId:d,stemNormal:l,stemLength:h}=e;return{id:t,anchorPosition:a,color:s,floorId:r,roomId:d,stemEnabled:o,stemNormal:l,stemLength:h,pinType:B.yY.NOTE,backgroundTexture:this.backgroundTexture,icon:B.tf[B.yY.NOTE],visible:this.getNoteVisibility(t,i,n)}}removeNotePin(e){this.engine.commandBinder.issueCommand(new x.z5(e.id,B.yY.NOTE))}async confirmAttachmentChanges(e,t){return this.engine.commandBinder.issueCommand(new z.ov(e,o.pi.COMMENT,t))}async cancelAttachmentChanges(){return this.engine.commandBinder.issueCommand(new z.OK)}updatePendingNote(){const e=this.viewData.getPendingNote(),t=this.appData.application===Ne.lg.WORKSHOP;e&&t&&!this.layersData.isInMemoryLayer(e.layerId)&&(e.layerId=this.layersData.getNotesLayerId(t))}setFocusedNoteComment(e,t){if(t){const i=this.viewData.getComment(e,t);this.viewData.setFocusedComment(i)}else this.viewData.setFocusedComment(null)}async openNote(e,t,i,n,a){var s;const r=(null===(s=this.annotationsViewData.dockedAnnotation)||void 0===s?void 0:s.annotationType)===L.U.NOTE,d=null!==i?i:r;return this.engine.commandBinder.issueCommand(new Oe.Xx(e,o.jM.NOTE)),d?this.dockNote(e,t,n,a):this.selectNote(e,t,n)}async selectNote(e,t,i){var n;const{commandBinder:a}=this.engine;this.setFocusedNoteComment(e,i);const s=this.viewData.getNoteView(e);if(s){const{openNoteView:i}=this.viewData,o=(null==i?void 0:i.id)===e,r=(null===(n=this.annotationsViewData.dockedAnnotation)||void 0===n?void 0:n.id)===e;if(o&&!r&&i)return void this.log.debug("Note is already selected");this.activated&&await a.issueCommand(new y.u3(p.S0.NOTES)),a.issueCommand(new z.ht(!1)),i&&(a.issueCommand(new F.XK(i.id,L.U.NOTE)),a.issueCommand(new x.mP(i.id,B.yY.NOTE))),this.viewData.setOpenNoteView(s),await a.issueCommand(new x.Rg(e,B.yY.NOTE,!1)),null!==t&&await a.issueCommand(new M.E4({pinPosition:s,transition:t}))}else this.log.debug("Cannot select a non-existent note")}async dockNote(e,t,i,n=!1){var a;const{toolsData:s,viewData:o,engine:r,activated:d,userData:l}=this,h=o.getNoteView(e);if(h){const{openNoteView:c,focusedComment:m}=this.viewData,u=(null==c?void 0:c.id)===e,g=(null===(a=this.annotationsViewData.dockedAnnotation)||void 0===a?void 0:a.id)===e;if(s.toolCollapsed&&r.commandBinder.issueCommand(new y.li(!1)),this.setFocusedNoteComment(e,i),u&&g)return void(o.focusedComment&&i!==(null==m?void 0:m.id)&&this.engine.broadcast(new ae.F(o.focusedComment.id)));r.commandBinder.issueCommand(new f.r),d||await r.commandBinder.issueCommand(new y.Wm(p.S0.NOTES,!0)),u||o.setOpenNoteView(h);const v=(0,H.q2)(l,L.U.NOTE,h.user);if(r.commandBinder.issueCommand(new x.Rg(e,B.yY.NOTE,v)),this.changeNotesPhase($.f.OPENING),null!==t&&await r.commandBinder.issueCommand(new M.E4({pinPosition:h,transition:t})),this.changeNotesPhase($.f.OPEN),n){const t=h.comments.get(0);let n=i?o.getComment(e,i):void 0;if(n||(n=t),!n)throw new Error("No root comment in the note");const a=(0,H.q2)(l,L.U.NOTE,n.user);o.setActiveNotation(a?n.id:null)}else o.setActiveNotation(null)}else this.log.debug("Cannot open a non-existent note")}async resolveNote(e){const t=this.notesData.getNote(e);if(t){if(t.resolved)return;this.closeNote(),await(0,l.cb)(350),this.engine.broadcast(new ae.a(e,!0));!!this.layersData.isInMemoryLayer(t.layerId)||await this.store.updateResolution(e,!0)?this.notesData.updateNoteProperties(e,{resolved:!0}):this.log.error("Resolving note failed")}else this.log.debug("Cannot resolve a non-existent note")}async reopenNote(e){const t=this.notesData.getNote(e);if(t){if(!t.resolved)return;this.viewData.updateOpenNoteView({resolved:!1});!!this.layersData.isInMemoryLayer(t.layerId)||await this.store.updateResolution(e,!1)?this.notesData.updateNoteProperties(e,{resolved:!1}):this.log.error("Reopen note failed")}else this.log.debug("Cannot reopen a non-existent note")}modifyInsideSaveCommand(e){return async(...t)=>{await this.engine.commandBinder.issueCommand(new Fe.F({dataTypes:[Le.p.NOTES],onCallback:()=>e(...t),skipDirtyUpdate:!0}))}}async updateNoteComment(e,t,i){const n=this.notesData.getNote(e);if(n){const a=this.layersData.isInMemoryLayer(n.layerId),s=n.getComment(t);if(s)if(s.user.id===this.userData.getCurrentUserId()){const r=!a&&await this.confirmAttachmentChanges(t,o.pi.COMMENT),d=i!==s.text;if(d){if(a)s.text=i;else{const e=await this.store.updateComment({id:t,text:i});e&&n.updateComment(e)}this.parseMarkdown(i)}(r||d)&&(await this.refreshNote(n.id),n.resolved&&(this.viewData.setNotesFilter(_.S.ALL),this.reopenNote(e))),this.viewData.setActiveNotation(null)}else this.log.debug("Cannot update another user's comment");else this.log.debug("Cannot update a non-existent comment")}else this.log.debug("Cannot update a comment in a non-existent note")}registerRoomAssociationSource(e){const t=this.notesData;e.commandBinder.issueCommandWhenBound(new Ue.l({type:"notes",getPositionId:function*(){for(const e of t.collection.values)yield{id:e.id,roomId:e.roomId,floorId:e.floorId,position:e.anchorPosition,layerId:e.layerId}},updateRoomForId:(e,t)=>{const i=this.notesData.getNote(e);if(!i)throw new Error("Invalid note id!");i.roomId=t||void 0}}))}}const at=nt},14362:(e,t,i)=>{"use strict";i.r(t),i.d(t,{default:()=>ge});var n=i(23205),a=i(35223),s=i(68909),o=i(54244),r=i(80379),d=i(26325),l=i(71136),h=i(1902),c=i(89998),m=i(7628),u=i(30411),g=i(91902),p=i(87513),y=i(87243),v=i(69831),w=i(35596),f=i(2789),b=i(87312),T=i(57440),D=i(93424),C=i(26179);function P(e){const t=e.toLowerCase().replace(" & "," ").replace(" ","-");return C.R.includes(`object-${t}`)?`object-${t}`:"simple-tag-small"}class A extends T.r{constructor(e,t,i,n,a){var s,r,d;super(e,t,i),this.suggestion=n,this.mattertag=a,this.id=this.suggestion.id,this.title=this.suggestion.displayLabel,this.description=this.suggestion.displayCategory,this.icon=`icon-${P(this.suggestion.displayLabel)}`,this.color=this.suggestion.color,this.enabled=this.suggestion.visible,this.typeId=o.jM.OBJECTANNOTATION,this.floorId=this.suggestion.floorId,this.roomId=this.suggestion.roomId||"",this.dateBucket=(0,D.n)(this.suggestion.created),this.layerId=this.suggestion.layerId,this.onSelect=()=>{super.onSelect(),this.commandBinder.issueCommand(new y.lA(this.suggestion.id))},this.title=(null===(s=this.mattertag)||void 0===s?void 0:s.label)?this.mattertag.label:this.suggestion.displayLabel,this.description=(null===(r=this.mattertag)||void 0===r?void 0:r.description)?this.mattertag.description:this.suggestion.displayCategory,this.color=(null===(d=this.mattertag)||void 0===d?void 0:d.color)?`#${this.mattertag.color.getHexString()}`:this.suggestion.color}supportsLayeredCopyMove(){return!0}supportsBatchDelete(){return!0}}var S=i(74848),I=i(96540),k=i(40826),N=i(99366),E=i(38216),O=i(9876),M=i(87987),x=i(99224),B=i(52385),V=i(27447);const{OBJECT_TAG_SUGGESTION:R}=N.A.WORKSHOP,F=({item:e})=>{const{id:t,typeId:i}=e,{analytics:n,commandBinder:a,editMode:s}=(0,I.useContext)(k.BR),r=(0,E.Y)();if(!s||i!==o.jM.OBJECTANNOTATION)return null;function d(e){n.track("showcase_gui",{tool:"object_tags",gui_action:e})}return(0,S.jsxs)(M.e,{children:[(0,S.jsx)(V.e,{item:e,onToggle:e=>{a.issueCommand(new y._8(t,e)),d(e?"object_tags_show_click":"object_tags_hide_click")}}),(0,S.jsxs)(x.y,Object.assign({icon:"more-vert",ariaLabel:r.t(N.A.MORE_OPTIONS),menuArrow:!0,menuClassName:"search-result-menu"},{children:[(0,S.jsx)(B.$n,{label:r.t(R.SEARCH_ITEM_EDIT),onClick:()=>{a.issueCommand(new b.Xx(t,i)),a.issueCommand(new y.y_(t)),d("object_tags_edit_click")},variant:B.Ak.TERTIARY,size:B.Mp.SMALL}),(0,S.jsx)(B.$n,{className:"menu-delete-btn",label:r.t(R.SEARCH_ITEM_DELETE),onClick:()=>{a.issueCommand(new y.lg(t)),a.issueCommand(new m.z5(t,c.yY.OBJECT)),a.issueCommand(new g.XK(t,O.U.OBJECT)),d("object_tags_delete_click")},variant:B.Ak.TERTIARY,size:B.Mp.SMALL})]}))]})};var L=i(31200);const{OBJECT_TAG_SUGGESTION:j}=N.A.WORKSHOP,U=({group:e})=>{const{analytics:t,commandBinder:i,editMode:n}=(0,I.useContext)(k.BR),a=(0,E.Y)(),s=(0,L._)(),{matches:o}=e;if(!n)return null;if(0===o.length)return null;const r=o.filter((e=>e.enabled)).length,d=r===o.length,l=0===r;function h(e){t.track("showcase_gui",{tool:"object_tags",gui_action:e})}const c=!s||!s.canBatchDeleteInActiveView();return(0,S.jsx)(M.e,{children:(0,S.jsxs)(x.y,Object.assign({icon:"more-vert",ariaLabel:a.t(N.A.MORE_OPTIONS),menuArrow:!0,menuClassName:"search-result-menu"},{children:[(0,S.jsx)(B.$n,{label:a.t(j.SEARCH_GROUP_HIDE_ALL),onClick:()=>{i.issueCommand(new y.ye(!1,...o.map((e=>e.id)))),h("hide_all_click")},variant:B.Ak.TERTIARY,size:B.Mp.SMALL,disabled:l}),(0,S.jsx)(B.$n,{label:a.t(j.SEARCH_GROUP_SHOW_ALL),onClick:()=>{i.issueCommand(new y.ye(!0,...o.map((e=>e.id)))),h("show_all_click")},variant:B.Ak.TERTIARY,size:B.Mp.SMALL,disabled:d}),c&&(0,S.jsx)(B.$n,{className:"menu-delete-btn",label:a.t(j.SEARCH_GROUP_DELETE_ALL),onClick:()=>{i.issueCommand(new y.lg(...o.map((e=>e.id)))),h("delete_all_click")},variant:B.Ak.TERTIARY,size:B.Mp.SMALL})]}))})};var H=i(44354),z=i(76735),G=i(10657),$=i(29337),_=i(61693);const K=.065;class X extends _.v{constructor(e){super(),this.created=new Date,this.modified=new Date,this.position=new s.Vector3,this.stemDirection=new s.Vector3,this.stemLength=K,this.stemEnabled=!1,this.enabled=!0,this.icon="simple-tag",e&&(Object.assign(this,e),this.keywords=e.keywords||[],this.label&&(this.icon=P(this.label)))}get displayLabel(){return this.localizedName?this.localizedName:this.label}get displayCategory(){return this.localizedCategory?this.localizedCategory:""}get visible(){return this.enabled}set visible(e){this.enabled=e,this.commit()}getMattertagOptions(){return{color:new s.Color(this.color),description:this.displayCategory,enabled:!0,floorId:this.floorId,roomId:this.roomId,label:this.displayLabel,normal:this.stemDirection.clone(),objectAnnotationId:this.id,position:this.position.clone(),stemHeight:this.stemLength,stemVisible:!0,keywords:this.keywords.slice(),icon:this.icon}}getPin(e){return{id:this.id,floorId:this.floorId,anchorPosition:this.position.clone(),stemNormal:this.stemDirection.clone(),stemEnabled:!1,stemLength:K,color:e?`#${e.color.getHexString()}`:this.color,roomId:this.roomId,icon:this.icon}}toTagView(e){return{id:this.id,label:e?e.label:this.displayLabel,description:e?e.description:this.displayCategory,enabled:this.enabled,backgroundTexture:ue,attachments:(null==e?void 0:e.fileAttachments.values())||[],created:this.created,modified:this.modified,stemEnabled:this.stemEnabled,color:this.color,anchorPosition:this.position.clone(),stemNormal:this.stemDirection.clone(),stemLength:this.stemLength,floorId:this.floorId,roomId:this.roomId,layerId:this.layerId,keywords:e?null==e?void 0:e.keywords.values():this.keywords.slice(),icon:this.icon}}}var W,Y=i(88488),q=i(35652);!function(e){e.APPLIANCE="Appliance",e.CONSUMER_ELECTRONICS="Consumer Electronics",e.FIXTURE="Fixture",e.FURNITURE="Furniture",e.LIGHTING="Lighting"}(W||(W={}));var Q=i(59421);const J="WORKSHOP.OBJECT_TAG_SUGGESTION.VISION.";class Z{constructor(e){this.locale=e,this.locale=e,this.log=new q.Ay("Object-tag-deserializer"),this.keywordList=Object.values(W)}deserialize(e){var t,i,n,a;if(!e||!this.validate(e))return null;const s=e.region,o=(null==s?void 0:s.anchorPosition)?z.U$.fromVisionVector(s.anchorPosition):void 0,r=(null==s?void 0:s.stemNormal)?z.U$.fromVisionVector(s.stemNormal):void 0,d=new X({id:e.id,confidence:null!==(t=e.confidence)&&void 0!==t?t:0,created:(0,Y.X)(e.created),modified:(0,Y.X)(e.created),enabled:e.enabled});(null===(i=e.region)||void 0===i?void 0:i.stemLength)&&(d.stemLength=e.region.stemLength),e.floor&&e.floor.id&&(d.floorId=e.floor.id),e.room&&e.room.id&&(d.roomId=e.room.id),e.layer&&e.layer.id&&(d.layerId=e.layer.id),o&&(d.position=o),r&&(d.stemDirection=r),d.mattertagId=null===(n=e.tag)||void 0===n?void 0:n.id;let l=e.keywords||[],h=e.label||"";if(e.classification){const t=e.classification,i=J+this.formatStringToPhraseKey(t.label);this.locale.has(i)&&(d.localizedName=this.locale.t(i));const{defaultKeywords:n}=t;if(n&&n.length>0){const e=n[n.length-1],t=J+this.formatStringToPhraseKey(e);this.locale.has(t)&&(d.localizedCategory=this.locale.t(t))}t.label&&(h=t.label,d.icon=P(h)),t.defaultKeywords&&(l=t.defaultKeywords);const a=[];for(const e of l){const t=J+this.formatStringToPhraseKey(e);this.locale.has(t)?a.push(this.locale.t(t)):a.push(e)}l=a}return d.keywords=l,d.label=h,this.postProcess(d,null===(a=e.classification)||void 0===a?void 0:a.defaultKeywords),d}formatStringToPhraseKey(e){return e.trim().replace(/\s/,"_").toUpperCase()}validate(e){if(!e)return!1;const t=["id","label","created","modified","region"];for(const i of t){if(!(i in e))return this.log.error("Missing field: ",i),!1}return!0}postProcess(e,t){let[i,n]=e.label.split(".").slice(1);if(i&&!e.localizedCategory){const t=J+i.toUpperCase();this.locale.has(t)?e.localizedCategory=this.locale.t(t):e.localizedCategory=i}if(n&&!e.localizedName){const t=J+n.toUpperCase();this.locale.has(t)?e.localizedName=this.locale.t(t):e.localizedName=n}if(t&&t.length>0)for(const e of this.keywordList)if(t.includes(e)){i=e;break}e.color=this.getCategoryColor(i)}getCategoryColor(e){switch(e){case"appliances":return Q.B.cerulean;case"consumer_electronics":return Q.B.emerald;case"fixtures":return Q.B.sunset;case W.APPLIANCE:return Q.B.cerulean;case W.CONSUMER_ELECTRONICS:return Q.B.emerald;case W.FIXTURE:return Q.B.sunset;case W.FURNITURE:return Q.B.canary;case W.LIGHTING:return Q.B.fog;default:return Q.B.forest}}}class ee extends G.g{constructor(e,t,i){super(e),this.classifications=[],this.layeredType=o.jM.OBJECTANNOTATION,this.confidence=i||.9,this.objectDeserializer=new Z(t),this.deserializer=new $.n({deserializer:this.objectDeserializer})}async read(e){const t={modelId:this.getViewId(),minConfidence:this.confidence,includeDisabled:!0,inferenceEvents:null,ids:null,includeLayers:this.readLayerId()};return this.query(H.GetObjectAnnotations,t,e).then((e=>{var t,i;const n=null===(i=null===(t=null==e?void 0:e.data)||void 0===t?void 0:t.model)||void 0===i?void 0:i.objectAnnotations;if(!n||!Array.isArray(n))return null;return(this.deserializer.deserialize(n)||[]).reduce(((e,t)=>(e[t.id]=t,e)),{})}))}async toggleEnabled(e,t){const i={modelId:this.getViewId(),objectAnnotationId:e,data:{enabled:t},includeLayers:this.readLayerId()};return this.mutate(H.PatchObjectAnnotation,i).then((e=>{var t;const i=null===(t=e.data)||void 0===t?void 0:t.patchObjectAnnotation;if(i){const e=this.objectDeserializer.deserialize(i);if(e)return e}throw new Error("Could not update Object Annotation")}))}async toggleAllEnabled(e,...t){const i={modelId:this.getViewId(),objectAnnotationIds:t,setEnabled:e,includeLayers:this.readLayerId()};return this.mutate(H.SetBulkObjectAnnotationsEnabled,i).then((e=>{var t;const i=null===(t=null==e?void 0:e.data)||void 0===t?void 0:t.setBulkObjectAnnotationsEnabled;if(!i)throw new Error("Could not update Object Annotations");return i.map((e=>e.id))}))}async deleteObjectAnnotation(e){const t={modelId:this.getViewId(),objectAnnotationId:e};return this.mutate(H.DeleteObjectAnnotation,t).then((e=>{var t;return!!(null===(t=null==e?void 0:e.data)||void 0===t?void 0:t.deleteObjectAnnotation)}))}async createObjectTag(e){const t={label:e.label,keywords:e.keywords||[],floorId:e.floorId,layerId:this.writeLayerId(e.layerId)?e.layerId:void 0,enabled:!0,vectorRegion:{anchorPosition:z.U$.toVisionVector(e.position),stemNormal:z.U$.toVisionVector(e.stemDirection),stemLength:e.stemLength}},i={modelId:this.getViewId(),objectAnnotation:t,includeLayers:this.readLayerId()};return this.mutate(H.AddObjectAnnotation,i).then((e=>{var t;const i=null===(t=null==e?void 0:e.data)||void 0===t?void 0:t.addObjectAnnotation;if(i){const e=this.objectDeserializer.deserialize(i);if(e)return e}throw new Error("Could not create Object Annotation")}))}}var te=i(19533);const ie=i.p+"images/objectColor.png";var ne=i(57642),ae=i(93612),se=i(89375),oe=i(60282),re=i(71306),de=i(9321),le=i(521),he=i(4143),ce=i(61334),me=i(55415);const ue=(0,te.y)(ie);class ge extends n.n{constructor(){super(...arguments),this.name="object-tag-suggestions-data",this.visibilityEnabled=!1,this.idVisibility=new Set,this.createdTag=null,this.onPinSelectionChange=e=>{const{commandBinder:t}=this.engine,{billboardAnnotation:i}=this.annotationsViewData,n=e?this.data.getObjectTag(e):null;n?(t.issueCommand(new b.Xx(n.id,o.jM.OBJECTANNOTATION)),t.issueCommand(new g.Zx(n.id,O.U.OBJECT))):i&&i.annotationType===O.U.OBJECT&&t.issueCommand(new g.XK(i.id,O.U.OBJECT))},this.onPinFocusChange=async()=>{const{commandBinder:e}=this.engine,{focusedPin:t,selectedPinId:i}=this.pinsViewData,{billboardAnnotation:n,dockedAnnotation:a}=this.annotationsViewData;if(!t)return void(n&&n.annotationType===O.U.OBJECT&&n.id!==i&&await e.issueCommand(new g.XK(n.id,O.U.OBJECT)));const s=i?this.pinsViewData.getPin(i):null;s&&s.pinType===c.yY.OBJECT&&(e.issueCommand(new m.mP(s.id,c.yY.OBJECT)),e.issueCommand(new b.Xx(null))),t.pinType===c.yY.OBJECT&&t.id!==(null==a?void 0:a.id)&&e.issueCommand(new g.Zx(t.id,O.U.OBJECT))},this.onLayersChanged=()=>{this.unselectObjectPin(),this.unselectObjectSearchResult(),this.displayObjects()},this.toggleObjectAnnotations=async e=>{const{enabled:t}=e;this.visibilityEnabled=t,this.engine.commandBinder.issueCommand(new m.g4(c.yY.OBJECT,t)),t||(this.unselectObjectPin(),this.unselectObjectSearchResult()),this.displayObjects()},this.selectedItemChanged=()=>{const{activeItemId:e,selectedType:t}=this.searchData;if(e&&t===o.jM.OBJECTANNOTATION){const t=this.data.getObjectTag(e);t&&this.updatePin(t)}},this.setAllObjectTagsEnabled=async e=>{const{ids:t,enabled:i}=e;0!==t.length&&(await this.store.toggleAllEnabled(i,...t),this.data.atomic((()=>{for(const e of this.data.collection)t.includes(e.id)&&(e.enabled=i,e.commit())})),this.unselectObjectPin(),this.unselectObjectSearchResult())},this.toggleObjectTagEnabled=async e=>{const{id:t,enabled:i}=e,n=this.data.getObjectTag(t);if(!n)throw new Error("Object tag not found!");if(n.enabled===i)return;await this.store.toggleEnabled(t,i)&&(n.enabled=i,n.commit(),this.unselectObjectPin(t),this.unselectObjectSearchResult(t))},this.deleteTags=async e=>{const{ids:t}=e;if(0===t.length)return;const i=this.annotationsViewData.billboardAnnotation;(null==i?void 0:i.annotationType)===O.U.OBJECT&&this.engine.commandBinder.issueCommand(new g.XK(i.id,i.annotationType));for(const e of t){if(!await this.store.deleteObjectAnnotation(e))throw new Error("Could not delete Object Annotation");{this.data.removeObjectTag(e);const t=this.data.getObjectTag(e);t&&t.mattertagId&&await this.engine.commandBinder.issueCommand(new se.RL(t.mattertagId,"search_menu_object_tag"))}}},this.createObjectTag=async e=>{const{id:t,options:i,pendingAttachments:n,embed:a}=e,r=new X,d=null==i?void 0:i.color,l=d?`#${new s.Color(d.r,d.g,d.b).getHexString(s.LinearSRGBColorSpace)}`:"#ffffff";if(r.label=i.label||"",r.floorId=i.floorId||"",r.keywords=i.keywords||[],r.stemDirection=i.normal||new s.Vector3,r.stemLength=i.stemHeight?Math.max(i.stemHeight,K):K,r.position=i.position||new s.Vector3,r.color=l,r.layerId=this.layersData.activeLayerId,await this.modifyInsideSaveCommand((async()=>{this.createdTag=await this.store.createObjectTag(r)}))(),!this.createdTag)return;const h=this.createdTag.id,{commandBinder:u}=this.engine;i.objectAnnotationId=h,await u.issueCommand(new se.Bu(t,i,n,void 0,a)),this.createdTag.mattertagId=t,this.data.updateObjectTag(this.createdTag);const g=this.getPinUpdate(this.createdTag);this.createdTag=null,u.issueCommand(new m.gx(h,c.yY.OBJECT,g)),await u.issueCommand(new de.u3(le.S0.TAGS)),u.issueCommand(new he.x),await u.issueCommand(new de.Wm(le.S0.LAYERS)),u.issueCommand(new he._),u.issueCommand(new b.Xx(h,o.jM.OBJECTANNOTATION)),await u.issueCommand(new y.lA(h))},this.dockObjectTag=async e=>{const{id:t}=e,i=this.data.getObjectTag(t);if(!i)return;const{commandBinder:n}=this.engine;if(!i.mattertagId){const e=i.getMattertagOptions(),t=(0,oe.D)(11);n.issueCommand(new re.Ee(t,e)),i.mattertagId=t}n.issueCommand(new se.Ki(i.mattertagId,{dock:!0,objectTag:!0}))}}async init(e,t){super.init(e,t),this.engine=t,[this.locale,this.pinsViewData,this.annotationsViewData,this.mattertagsData,this.layersData,this.searchData,this.appData]=await Promise.all([t.getModuleBySymbol(a.gS),t.market.waitForData(u.U),t.market.waitForData(p.o),t.market.waitForData(ae.j),t.market.waitForData(ce.P),t.market.waitForData(ne.L),t.market.waitForData(w.zH)]),this.store=new ee({context:this.layersData.mdsContext,readonly:!1,baseUrl:e.baseUrl},this.locale,e.minConfidence),this.engine.commandBinder.issueCommand(new m.g4(c.yY.OBJECT,!1)),this.data=new v.$,this.store.onNewData(this.loadNewData.bind(this));const{commandBinder:i}=this.engine;this.bindings.push(i.addBinding(y.vX,this.toggleObjectAnnotations),i.addBinding(y.HZ,(async e=>this.filterObjectTagSuggestions(e.ids))),i.addBinding(y.lA,(async({id:e})=>this.navigateToSuggestion(e))),i.addBinding(y.ye,this.modifyInsideSaveCommand(this.setAllObjectTagsEnabled)),i.addBinding(y._8,this.modifyInsideSaveCommand(this.toggleObjectTagEnabled)),i.addBinding(y.lg,this.modifyInsideSaveCommand(this.deleteTags)),i.addBinding(y.R5,this.createObjectTag),i.addBinding(y.y_,(async e=>this.dockObjectTag(e))),this.appData.onChanged((()=>this.displayObjects())),this.layersData.onCurrentLayersChanged(this.onLayersChanged),this.searchData.onPropertyChanged("activeItemId",this.selectedItemChanged),this.pinsViewData.onSelectedPinChanged(this.onPinSelectionChange),this.pinsViewData.onFocusedPinChanged((()=>this.onPinFocusChange())),this.data.onChanged((()=>this.displayObjects())),this.data.collection.onElementChanged({onAdded:this.updatePin.bind(this),onUpdated:this.updatePin.bind(this),onRemoved:this.removePin.bind(this)})),await this.store.refresh(),this.engine.market.register(this,v.$,this.data),this.registerRoomAssociationSource(t),async function(e,t,i,n){const a=await e.market.waitForData(w.zH);let s=a.application===w.lg.WORKSHOP;const r=(a,o,r,l=[])=>{const h=[];return t.iterate((t=>{if(!(s||t.visible&&n.layerToggled(t.layerId)))return;const r=[t.displayLabel,t.displayCategory],d=[...t.keywords],c=t.mattertagId?i.getTag(t.mattertagId):void 0;c&&(r.length=0,d.length=0,r.push(c.label,c.description),d.push(...c.keywords));const m=r.filter((e=>!!e));let u=a(...m);u&&l.length>0&&(u=d.length>0&&d.some((e=>l.includes(e)))),u&&h.push(new A(e.commandBinder,n,o,t,c))})),e.commandBinder.issueCommand(new y.HZ(h.map((e=>e.id)))),d(h),h},d=e=>{e.sort(((e,t)=>{var i;const n=e,a=t,s=null===(i=n.description)||void 0===i?void 0:i.localeCompare(a.description);return 0!==s?s:n.title.localeCompare(a.title)}))},l=t=>{e.commandBinder.issueCommand(new y.vX(!!t))},h=()=>{let e=[];return t.iterate((t=>{t.visible&&t.keywords.length&&!t.mattertagId&&(e=e.concat(t.keywords))})),e},c=e=>new f.P(t.onChanged(e),i.onChanged(e)),m=()=>{e.commandBinder.issueCommandWhenBound(new b.Oc({id:o.jM.OBJECTANNOTATION,groupPhraseKey:"WORKSHOP.OBJECT_TAG_SUGGESTION.SEARCH_GROUP_HEADER",getSimpleMatches:r,registerChangeObserver:c,onSearchActivatedChanged:l,getKeywords:h,groupOrder:90,groupIcon:"snap",groupActionsFC:U,itemActionsFC:F,batchSupported:!0}))},u=()=>{e.commandBinder.issueCommandWhenBound(new b.tf(o.jM.OBJECTANNOTATION))},g={renew:m,cancel:u},p=e=>{s=e===w.lg.WORKSHOP,u(),m()},v=a.onPropertyChanged("application",p);return p(a.application),new f.P(g,v)}(t,this.data,this.mattertagsData,this.layersData).then((e=>this.bindings.push(e)))}loadNewData(e){this.data.atomic((()=>{this.layersData.replaceBackendLayers(this.data.collection,e||{})}))}dispose(e){super.dispose(e),this.data&&e.market.unregister(this,v.$)}modifyInsideSaveCommand(e){return async(...t)=>{await this.engine.commandBinder.issueCommand(new r.F({dataTypes:[d.p.OBJECT_ANNOTATIONS],onCallback:()=>e(...t),skipDirtyUpdate:!0}))}}displayObjects(){const e=[];this.data.collection.values.forEach((t=>{e.push(this.getPinUpdate(t))})),this.engine.commandBinder.issueCommand(new m.wn(e))}removePin(e){this.engine.commandBinder.issueCommand(new m.z5(e.id,c.yY.OBJECT))}updatePin(e){const t=this.getPinUpdate(e);this.engine.commandBinder.issueCommand(new m.wn([t]))}getPinUpdate(e){const t=this.mattertagsData.getTag(e.mattertagId||""),i=e.getPin(t);return Object.assign({id:e.id,pinType:c.yY.OBJECT,backgroundTexture:ue,visible:this.getObjectVisibility(e.id,e.layerId,e.visible),scale:new s.Vector3(.75,.75,.75)},i)}getObjectVisibility(e,t,i){if(!this.visibilityEnabled)return!1;const{activeItemId:n,selectedType:a}=this.searchData,s=this.appData.application===w.lg.WORKSHOP||this.layersData.layerToggled(t),r=this.layersData.layerVisible(t),d=this.idVisibility.has(e),l=n===e&&a===o.jM.OBJECTANNOTATION;return s&&(l||i&&d&&r)}async filterObjectTagSuggestions(e){this.idVisibility.clear(),e.forEach((e=>this.idVisibility.add(e))),this.displayObjects()}async navigateToSuggestion(e){const t=this.data.getObjectTag(e);if(!t)return;const i={anchorPosition:t.position.clone(),stemNormal:t.stemDirection.clone(),stemLength:t.stemLength,stemEnabled:!0,color:"",floorId:t.floorId,roomId:t.roomId};await this.engine.commandBinder.issueCommand(new h.E4({pinPosition:i,transition:l.fl.FadeToBlack})),this.engine.commandBinder.issueCommand(new m.Rg(e,c.yY.OBJECT,!1))}unselectObjectPin(e){const{selectedPinId:t}=this.pinsViewData;if(t){const i=this.pinsViewData.getPin(t);i&&(i.pinType!==c.yY.OBJECT||e&&e!==t||this.engine.commandBinder.issueCommand(new m.mP(t,c.yY.OBJECT)))}}unselectObjectSearchResult(e){const{selectedType:t,activeItemId:i}=this.searchData;i&&t===o.jM.OBJECTANNOTATION&&(e&&e!==i||this.engine.commandBinder.issueCommand(new b.Xx(null)))}registerRoomAssociationSource(e){const t=this.data;e.commandBinder.issueCommandWhenBound(new me.l({type:"objectAnnotations",getPositionId:function*(){for(const e of t.collection.values)yield e},updateRoomForId:(e,i)=>{const n=t.getObjectTag(e);if(!n)throw new Error("Invalid object detection id!");n.roomId=i||void 0}}))}}},42155:(e,t,i)=>{"use strict";i.d(t,{Y:()=>s});var n=i(61589),a=i(54998);class s extends n.B{constructor(e){super(),this.name="ordered-list-data",this.lists=(0,a.y)(e)}replace(e){this.lists.replace(e)}getOrderedLists(){return this.lists.values}getOrderedList(e){return this.lists.get(e)}updateOrderedList(e){this.lists.has(e.name)?this.lists.get(e.name).copy(e):this.lists.set(e.name,e)}}},51003:(e,t,i)=>{"use strict";i.d(t,{N3:()=>s,Qm:()=>o,lr:()=>a});var n=i(18268);class a extends n.u{constructor(e,t){super(),this.payload={name:e,entries:t}}}a.id="ORDERED_LIST_NAMED_SAVE";class s extends n.u{constructor(e,t){super(),this.payload={name:e,entries:t}}}s.id="ORDERED_LIST_CREATE";class o extends n.u{constructor(e,t,i){super(),this.payload={id:e,name:t,entries:i}}}o.id="ORDERED_LIST_UPDATE"},8743:(e,t,i)=>{"use strict";var n;i.d(t,{_:()=>n}),function(e){e.TAG="tag"}(n||(n={}))},61115:(e,t,i)=>{"use strict";i.r(t),i.d(t,{CreateOrderedListCommand:()=>b.N3,MdsOrderedListDeserializer:()=>y,MdsOrderedListStore:()=>w,OrderedList:()=>d,OrderedListData:()=>f.Y,OrderedListEntryType:()=>C._,SaveNamedOrderedListCommand:()=>b.lr,TAG_ORDERED_LIST_NAME:()=>P.K,UpdateOrderedListCommand:()=>b.Qm,default:()=>A});var n=i(23205),a=i(35223),s=i(26325),o=i(80379),r=i(61693);class d extends r.v{constructor(e){super(),this.id="",this.name="",this.description="",this.entries=[],this.layerId="",e&&Object.assign(this,e)}copy(e){return this.id=e.id,this.name=e.name,e.description&&(this.description=e.description),this.entries=e.entries.slice(),this.commit(),this}}var l=i(10657),h=i(61373),c=i(80788),m=i(64260),u=i(35652),g=i(92711);const p=new u.Ay("ordered-list-deserializer");class y{deserialize(e){var t,i,n;return e&&this.validate(e)?new d({id:e.id,name:null!==(t=e.label)&&void 0!==t?t:"",layerId:null!==(n=null===(i=e.layer)||void 0===i?void 0:i.id)&&void 0!==n?n:"",entries:e.entries.filter((e=>!!e)).map((e=>({id:e.id,type:e.type})))}):(p.debug("Deserialized invalid ordered list data from Mds",e),null)}validate(e){return["id","label","entries"].every((t=>t in e))}}const v=new u.Ay("MdsOrderedListStore");class w extends l.g{constructor(e){super(e),this.prefetchKey="data.model.orderedLists",this.deserializer=new y}async read(){const e={modelId:this.getViewId(),includeLayers:this.readLayerId()};return this.query(g.GetOrderedLists,e).then((e=>{var t,i;const n=null===(i=null===(t=e.data)||void 0===t?void 0:t.model)||void 0===i?void 0:i.orderedLists;if(!n||!Array.isArray(n))return v.debug("GetOrderedLists failed"),{};return n.reduce(((e,t)=>{const i=this.deserializer.deserialize(t);return i&&(e[i.name]&&v.debug(`Duplicate orderedList found with label: ${i.name}`),e[i.name]=i),e}),{})}))}async create(e,t){return 0===e.length?[]:Promise.all(e.map((e=>this.createOrderedList(e,t))))}async createOrderedList(e,t){var i;const n={modelId:this.getViewId(),label:e.name,description:e.description,entries:e.entries,includeLayers:this.readLayerId()};let a;if(t&&this.writeLayerId(t)){const e=Object.assign({layerId:t},n);a=await this.mutate(g.AddOrderedListWithLayer,e).catch((e=>{throw new h.YA(e)}))}else a=await this.mutate(g.AddOrderedList,n).catch((e=>{throw new h.YA(e)}));if(null===(i=a.data)||void 0===i?void 0:i.addOrderedList){const e=this.deserializer.deserialize(a.data.addOrderedList);if(e)return e.layerId&&await this.context.updateForAutoProvisionedLayer(e.layerId),e}throw new Error("Unable to create new OrderedList")}async update(e){if(0===e.length)return;const t=this.getViewId();let i="";const n={};n.modelId=t;let a="";for(const t of e){const e=t.id;i+=`\n        , $label${e}: String!\n        , $description${e}: String!\n        , $entries${e}: [EntryInput!]\n      `,n[`label${e}`]=t.name,n[`description${e}`]=t.description,n[`entries${e}`]=t.entries,a+=`\n        update${e}:\n        patchOrderedList(modelId: $modelId,\n                         orderedListId: "${e}",\n                         label: $label${e},\n                         description: $description${e},\n                         entries: $entries${e}) {\n          id\n          label\n          entries {\n            id\n            type\n          }\n        }\n      `}const s=c.gql`
      mutation orderedListsUpdate($modelId: ID! ${i}) {
        ${a}
      }
    `;return this.mutate(s,n).then((e=>{v.debug(Object.assign({type:"patchOrderedList"},Object.values((0,m.L)(e,"data"))))}))}}var f=i(42155),b=i(51003),T=i(61334);class D extends n.n{constructor(){super(...arguments),this.name="ordered-lists",this.saveNamedOrderedList=async e=>{const{name:t,entries:i}=e;let n=this.data.getOrderedList(t);return n?n.entries=i:n=new d({name:t,entries:i}),this.data.updateOrderedList(n),this.engine.commandBinder.issueCommand(new o.F({dataTypes:[s.p.ORDERED_LISTS]}))}}async init(e,t){const{baseUrl:i,workshop:n}=e;if(this.engine=t,this.layersData=await t.market.waitForData(T.P),this.store=new w({context:this.layersData.mdsContext,baseUrl:i,readonly:!n}),this.bindings.push(this.store.onNewData((async e=>{this.data.replace(e)}))),this.data=new f.Y({}),await this.store.refresh(),n){const e=await t.getModuleBySymbol(a.T9);this.bindings.push(t.commandBinder.addBinding(b.lr,this.saveNamedOrderedList),e.onSave((()=>this.save()),{dataType:s.p.ORDERED_LISTS}))}t.market.register(this,f.Y,this.data)}dispose(e){this.store.dispose(),super.dispose(e)}onUpdate(){}async save(){const e=this.data.getOrderedLists(),t=[],i=[];e.forEach((e=>{""===e.id?t.push(e):i.push(e)}));return Promise.all([this.store.create(t,this.layersData.getOrderedListsLayerId()),this.store.update(i)]).then((e=>{e[0].forEach((e=>{e&&this.data.updateOrderedList(e)}))}))}}var C=i(8743),P=i(55912);const A=D},55912:(e,t,i)=>{"use strict";i.d(t,{K:()=>n});const n="mp.tags"},79760:(e,t,i)=>{"use strict";i.d(t,{V$:()=>d,g1:()=>r,ol:()=>o,qD:()=>a,vc:()=>s});var n=i(75673);const a=1e3/60,s=(0,n.pu)(70),o=-s,r=.05,d=.1/60},14746:(e,t,i)=>{"use strict";i.r(t),i.d(t,{default:()=>P,lookAccelerationKey:()=>C});var n=i(68909),a=i(48071),s=i(79760),o=i(60840),r=i(43998),d=i(18007),l=i(71294),h=i(71136);class c extends d.A{constructor(e){super(),this.cameraPoseProxy=e,this.lookVelocity=new n.Vector2,this.lookAccel=new n.Vector2,this.tempAxis=new n.Vector3,this.tempOrientation=new n.Quaternion,this.currentOrientation=new n.Quaternion,this.tempEuler=new n.Euler,this.transition={active:!1,startTime:0,elapsed:0,progress:0,duration:0,updateParameters:{},easeOut:!1,externalTransitionActive:!0}}setController(e){return null==e&&this.stop(),super.setController(e)}setLookAcceleration(e,t=!1){this.transition.active||(t&&(e.x&&this.lookVelocity.x&&Math.sign(e.x)!==Math.sign(this.lookVelocity.x)&&(this.lookVelocity.x=0),e.y&&this.lookVelocity.y&&Math.sign(e.y)!==Math.sign(this.lookVelocity.y)&&(this.lookVelocity.y=0)),this.lookAccel.x=void 0!==e.x?e.x:this.lookAccel.x,this.lookAccel.y=void 0!==e.y?e.y:this.lookAccel.y)}async rotateBetweenOrientations(e,t,i,n,a=!1){if(!e)return this.startTransition(n,{startRotation:t,endRotation:i},!1,a).nativePromise();if(this.poseController){const e=this.cameraPoseProxy.pose.clone();return e.rotation.copy(i),this.poseController.moveTo({transitionType:h.fl.FadeToBlack,pose:e,transitionTime:n}).nativePromise()}}startTransition(e,t,i,n=!0){var a;const s=new l.i;if(this.transition.active=!0,this.transition.duration=e,this.transition.elapsed=0,this.transition.startTime=Date.now(),this.transition.deferred=s,this.transition.easeOut=i,this.transition.externalTransitionActive=!n,this.transition.updateParameters=t,this.lookAccel.set(0,0),t.velocity)this.lookVelocity.copy(t.velocity),this.transition.updateParameters.velocity=t.velocity.clone(),this.transition.updateParameters.startRotation=this.transition.updateParameters.endRotation=void 0;else if(this.lookVelocity.set(0,0),!t.startRotation||!t.endRotation)throw new Error("startTransition: must specify velocity or both startRotation & endRotation");return n||null===(a=this.poseController)||void 0===a||a.beginExternalTransition(),s.promise()}stopTransition(){var e;const t=this.transition.active;this.transition.active&&(this.transition.externalTransitionActive&&(null===(e=this.poseController)||void 0===e||e.endExternalTransition()),this.transition.active=!1),this.transition.deferred&&(t&&this.transition.deferred.resolve(),this.transition.deferred=void 0)}updateTransitionForVelocityMovement(e,t){if(this.transition.updateParameters.velocity)if(this.lookVelocity.copy(this.transition.updateParameters.velocity),this.transition.elapsed>=this.transition.duration){const e=this.transition.duration-(this.transition.elapsed-t);this.lookVelocity.multiplyScalar(e/t)}else this.lookVelocity.multiplyScalar(e)}updateTransitionForRotationalMovement(){var e;if(!this.transition.updateParameters.startRotation||!this.transition.updateParameters.endRotation)return;const t=this.transition.updateParameters.startRotation,i=this.transition.updateParameters.endRotation;this.currentOrientation.copy(t).slerp(i,this.transition.progress),null===(e=this.poseController)||void 0===e||e.updateCameraRotation(this.currentOrientation)}updateTransition(e,t){this.transition.elapsed+=t,this.transition.progress=this.transition.elapsed/this.transition.duration,this.transition.updateParameters.velocity?this.updateTransitionForVelocityMovement(e,t):this.updateTransitionForRotationalMovement()}updateCameraParametersForVelocityMovement(){var e;const t=this.cameraPoseProxy.pose;this.tempEuler.setFromQuaternion(t.rotation,"YXZ");const i=this.tempEuler.x,n=(0,r.qE)(this.lookVelocity.y,s.ol-i,s.vc-i);this.tempAxis.copy(a.B1.RIGHT),this.tempOrientation.setFromAxisAngle(this.tempAxis.applyQuaternion(t.rotation),n),this.currentOrientation.copy(t.rotation).premultiply(this.tempOrientation),this.tempOrientation.setFromAxisAngle(a.B1.UP,this.lookVelocity.x),this.currentOrientation.premultiply(this.tempOrientation),t.rotation.equals(this.currentOrientation)||(this.tempOrientation.copy(this.currentOrientation).normalize(),null===(e=this.poseController)||void 0===e||e.updateCameraRotation(this.tempOrientation))}update(e){this.cameraPoseProxy.pose.rotation.equals(this.currentOrientation)||this.currentOrientation.copy(this.cameraPoseProxy.pose.rotation);const t=e/s.qD;this.transition.active?(this.updateTransition(t,e),this.transition.updateParameters.velocity&&this.updateCameraParametersForVelocityMovement(),this.transition.elapsed>=this.transition.duration&&(this.stop(this.transition.easeOut),this.transition.active=!1)):(this.lookAccel.length()>o.A.epsilon||this.lookVelocity.length()>o.A.epsilon)&&(this.lookVelocity.addScaledVector(this.lookAccel,t),this.updateCameraParametersForVelocityMovement(),this.lookVelocity.multiplyScalar(Math.pow(1-s.g1,t)))}stop(e=!1){this.stopTransition(),this.lookAccel.set(0,0),e||this.lookVelocity.set(0,0)}startRotateTransition(e,t,i){return this.beforeStartRotationTransition&&this.beforeStartRotationTransition(),this.startTransition(e,{velocity:t.clone().multiplyScalar(s.qD)},i).nativePromise()}startTranslateTransition(e,t,i=!0){throw new Error("Panning isn't supported in Panorama Controls")}startZoomTransition(e,t,i){throw new Error("Zooming isn't supported in Panorama Controls")}}var m=i(80399),u=i(82110),g=i(79105),p=i(44158),y=i(44634),v=i(32981),w=i(33518),f=i(28997),b=i(35223),T=i(45018),D=i(66175);const C="Rotation speed";class P extends D.A{constructor(){super(...arguments),this.name="panorama-controls",this.controlsEngaged=!1,this.lookAccelerationSpeed=s.V$,this.calcRotationAngle=(()=>{const e=new n.Matrix4,t=new n.Vector3,i=new n.Vector3;return(a,s)=>{e.copy(this.cameraData.pose.projection.asThreeMatrix4()),e.invert(),t.set(a.x-s.x,a.y-s.y,-1).applyMatrix4(e),i.set(a.x,a.y,-1).applyMatrix4(e);const o=Math.sqrt(t.x*t.x+t.z*t.z),r=Math.sqrt(i.x*i.x+i.z*i.z),d=Math.atan2(t.y,o),l=Math.atan2(i.y,r)-d;t.y=0,i.y=0,t.normalize(),i.normalize();const h=Math.acos(t.dot(i));let c=0;return isNaN(h)||(c=h,s.x>0&&(c*=-1)),new n.Vector2(-c,-l)}})()}async init(e,t){const i=await t.getModuleBySymbol(b.X7);this.controls=new c(i.cameraPoseProxy),this.cameraData=await t.market.waitForData(T.M);const n=this.cameraData;this.controls.beforeStartRotationTransition=()=>{n.transition&&n.transition.activeInternal&&n.transition.to.rotation&&(n.transition.to.rotation=void 0)},i.addControls(u.N3.Panorama,this.controls),i.addControls(u.N3.Mesh,this.controls),this.market=t.market,this.registerActiveStateChangeBinding(),t.getModuleBySymbol(b.mL).then((e=>{e.registerHandler(v.SK,(e=>{this.shouldBeActive()&&this.controls.stop()})),e.registerHandler(v.jF,(e=>{this.shouldBeActive()&&e.buttons&g.O.PRIMARY&&(this.controlsEngaged=!0,this.onDrag(e.position,e.delta),this.controls.update(s.qD),this.controls.stop())})),e.registerHandler(v._w,(e=>{this.shouldBeActive()&&this.controlsEngaged&&(e.timeSinceLastMove<100&&!(e.buttons&g.O.PRIMARY)&&(this.onDrag(e.position,e.delta),this.controls.update(s.qD),this.controls.setLookAcceleration({x:0,y:0})),this.controlsEngaged=!1)})),e.registerHandler(w.k,(e=>{this.shouldBeActive()&&this.onKey(e.key,e.state)})),this.updateInputBindings()}))}onUpdate(e){this.shouldBeActive()&&this.controls.update(e)}onDrag(e,t){this.controls.setLookAcceleration(this.calcRotationAngle(e,t))}onKey(e,t){var i,n;const a=null!==(n=null===(i=this.market.tryGetData(f.o))||void 0===i?void 0:i.tryGetProperty(C,null))&&void 0!==n?n:null;this.lookAccelerationSpeed=a?a*(Math.PI/180)/60:this.lookAccelerationSpeed;const s=t===y.$.DOWN;switch(e){case p.D.LEFTARROW:case p.D.J:this.controls.setLookAcceleration({x:s?this.lookAccelerationSpeed:0},!0);break;case p.D.RIGHTARROW:case p.D.L:this.controls.setLookAcceleration({x:s?-this.lookAccelerationSpeed:0},!0);break;case p.D.K:this.controls.setLookAcceleration({y:s?-this.lookAccelerationSpeed:0},!0);break;case p.D.I:this.controls.setLookAcceleration({y:s?this.lookAccelerationSpeed:0},!0)}}shouldBeActive(){var e,t;return null!==(t=!(null===(e=this.market.tryGetData(m.O))||void 0===e?void 0:e.isVR()))&&void 0!==t&&t}}},29403:(e,t,i)=>{"use strict";i.r(t),i.d(t,{CancelNewPinCommand:()=>W.hd,ChangePinOpacityByTypeCommand:()=>W.FI,ChangePinOpacityCommand:()=>W.uf,ChangePinOpacityScaleCommand:()=>W.Ct,ChangePinVisibilityByTypeCommand:()=>W.g4,ChangePinVisibilityCommand:()=>W.f5,ClearPinSelectionCommand:()=>W.mf,ClickOffPinCommand:()=>W.wd,CreatePinCommand:()=>W.Zs,EnablePinCreationCommand:()=>W.fZ,MovePinCommand:()=>W.Mx,NewPinReadyMessage:()=>Y.wk,PinAddCancelledMessage:()=>Y.lY,PinAnchorMesh:()=>X,PinClickedMessage:()=>Y.oX,PinColorVariant:()=>U.ob,PinEditor:()=>Z,PinEditorState:()=>U.ce,PinHeadMesh:()=>H.R,PinHoverChangeMessage:()=>Y.RG,PinMovedMessage:()=>Y.cC,PinPlacedMessage:()=>Y.yi,PinPlacementCancelledMessage:()=>Y.fD,PinPreviewDirection:()=>U.DH,PinRenderer:()=>ge,PinType:()=>U.yY,PinsViewData:()=>D.U,PlacePinCommand:()=>W.yq,RemovePinCommand:()=>W.z5,RemovePinsByTypeCommand:()=>W.Ni,SelectPinCommand:()=>W.Rg,TogglePinEditingCommand:()=>W.HR,UnselectPinCommand:()=>W.mP,UpdatePinCommand:()=>W.gx,UpdatePinViewsCommand:()=>W.wn,default:()=>Pe});var n=i(68909),a=i(23205),s=i(35223),o=i(39591),r=i(8430),d=i(35596),l=i(53366),h=i(92590),c=i(80399),m=i(45018),u=i(49191),g=i(48064),p=i(82110),y=i(21959),v=i(75092),w=i(28883),f=i(20560),b=i(48094),T=i(36827),D=i(30411),C=i(2789),P=i(40653),A=i(20052),S=i(90302),I=i(94221);var k=i(59935),N=i(35652),E=i(86407),O=i(79105),M=i(75650),x=i(42311),B=i(32981),V=i(74568),R=i(33518),F=i(18461),L=i(44634),j=i(44158),U=i(89998),H=i(8468),z=i(12183),G=i(19533);const $=i.p+"images/pinAnchor.png";var _=i(90627),K=i(90280);class X extends n.Mesh{constructor(e){super(new n.PlaneGeometry(_.A.anchor.size,_.A.anchor.size),new n.MeshBasicMaterial({depthTest:!1,depthWrite:!1,transparent:!0,map:X.getTexture(),side:n.DoubleSide})),this.visible=!1,this.layers.mask=e.mask,this.renderOrder=z.X.pins,this.worldPosition=new n.Vector3}update(e,t,i){const n=_.A.pinHeadMesh.scale;this.getWorldPosition(this.worldPosition);const a=(0,K.cv)(this.worldPosition,e,t,i,n);this.scale.set(a,a,a)}static getTexture(){return X.anchorTexture||(X.anchorTexture=(0,G.y)($)),X.anchorTexture}}var W=i(7628),Y=i(19974),q=i(34040),Q=i(58421),J=i(1902);class Z{constructor(e,t,i,a){this.viewData=e,this.engine=t,this.input=i,this.pinRenderer=a,this.editEnabled=!1,this.handlersRegistered=!1,this.bindings=[],this.externalBehaviorsBlocked=!1,this.touchDevice=(0,r.C8)(),this.ndcPoint=new n.Vector3,this.movingPin=!1,this.anchored=!1,this.inAnchorClick=!1,this.startingPinData=void 0,this.log=new N.Ay("pin-editor"),this.stopEventPropagation=()=>!0,this.updateMeshPreviewSphere=async(e,t)=>{this.engine.commandBinder.issueCommand(new A.P(e,t))},this.startPinCreation=()=>{this.editEnabled&&(this.viewData.setPinEditorState(U.ce.CREATING),this.addingHandlers.renew(),this.touchDevice||this.engine.commandBinder.issueCommand(new v.X(w.b.XHAIR)),this.engine.commandBinder.issueCommand(new Q._p))},this.endPinCreation=()=>{this.editEnabled&&(this.draggingHandlers.cancel(),this.addingHandlers.cancel(),this.viewData.setPinEditorState(U.ce.IDLE),this.allowExternalBehaviors(!0),this.engine.commandBinder.issueCommand(new v.X(w.b.DEFAULT)),this.engine.commandBinder.issueCommand(new Q.tA))},this.onSelectedPinChanged=()=>{const{selectedPinId:e}=this.viewData;e?this.selectedHandlers.renew():this.selectedHandlers.cancel(),this.updateAnchorMesh()},this.onPinStateUpdated=()=>{const e=this.viewData.pinEditorState;switch(this.updateAnchorMesh(),e){case U.ce.PLACING:this.draggingHandlers.renew();break;case U.ce.IDLE:this.allowExternalBehaviors(!0)}},this.updateAnchorMesh=()=>{if(!this.editEnabled)return;const{pinEditorState:e,isPinEditable:t,selectedPinId:i}=this.viewData,n=i?this.viewData.getPin(i):null;n&&e!==U.ce.CREATING?([U.ce.PLACING,U.ce.PLACED].includes(e)||t?(this.pinRenderer.showAnchorMesh(n.pinType,n.id,n),this.anchored=!0):this.removePinAnchorMesh(),this.editableSelectedHandlers.renew()):(this.editableSelectedHandlers.cancel(),this.anchored&&this.removePinAnchorMesh(),this.updateMeshPreviewSphere(!1))},this.placePin=()=>{this.viewData.pinEditorState===U.ce.PLACING&&(this.engine.commandBinder.issueCommand(new v.X(w.b.DEFAULT)),this.engine.commandBinder.issueCommand(new W.yq),this.engine.broadcast(new Y.wk),this.updateMeshPreviewSphere(!1))},this.onDragEvent=e=>{e.buttons!==O.O.PRIMARY&&(this.touchDevice||this.viewData.selectedPinId)||this.positionPin(e)},this.onDragEnd=e=>{const{creatingNewPin:t,pinEditorState:i,selectedPinId:n}=this.viewData,a=n?this.viewData.getPin(n):null;t&&!this.touchDevice&&i===U.ce.PLACING||(a&&!t&&(this.engine.commandBinder.issueCommand(new W.Mx(a.id,this.copyPinData(a),this.startingPinData)),this.updateMeshPreviewSphere(!1)),this.doneMovingPin(),this.inAnchorClick=!1)},this.positionPin=(()=>{const e=new n.Vector3;return async t=>{if(this.touchDevice&&t.buttons!==O.O.PRIMARY)return!1;const i=this.viewData,{pinEditorState:n,selectedPinId:a}=i;if(n===U.ce.CREATING)this.engine.commandBinder.issueCommand(new y.j(!0));else if(n!==U.ce.PLACING&&!this.movingPin)return!1;const s=a?i.getPin(a):null;if(!s)return!1;this.saveScreenPosition(t.position.x,t.position.y);const o=this.getModelIntersection();if(o&&o.face){this.engine.commandBinder.issueCommand(new v.X(w.b.XHAIR)),i.setCanPlace(!0);const t=((e,t,i)=>{var n;return null!==(n=t.floorIdFromObject(i.object))&&void 0!==n?n:e.getClosestFloorAtHeight(i.point.y).id})(this.floorsData,this.meshQuery,o);if(null===t)return!1;const a=this.meshQuery.mdsRoomIdFromObject(o.object);e.copy(s.stemNormal).setLength(s.stemLength),this.updateMeshPreviewSphere(!0,s.anchorPosition);const r={anchorPosition:s.anchorPosition.copy(o.point),stemNormal:s.stemNormal.copy(o.face.normal).normalize(),floorId:t,roomId:a};return this.engine.commandBinder.issueCommand(new W.gx(s.id,s.pinType,r)),n===U.ce.CREATING&&i.setPinEditorState(U.ce.PLACING),!0}return this.engine.commandBinder.issueCommand(new v.X(w.b.NOPE)),i.setCanPlace(!1),!1}})(),this.allowExternalBehaviors=async e=>{e||this.externalBehaviorsBlocked?e&&this.externalBehaviorsBlocked&&(this.dragInterceptor.cancel(),this.engine.commandBinder.issueCommand(new J.sD),this.engine.commandBinder.issueCommand(new F.RK),this.externalBehaviorsBlocked=!1):(this.dragInterceptor.renew(),this.engine.commandBinder.issueCommand(new J.Jq),this.engine.commandBinder.issueCommand(new F.WH),this.externalBehaviorsBlocked=!0)},this.getModelIntersection=()=>this.fatcaster.cast(.05,(e=>!!(0,S.aV)(e)&&(!this.viewmodeData.isDollhouse()&&!this.viewmodeData.isFloorplan()||this.floorsViewData.isCurrentMeshGroupOrAllFloors(e.meshGroup))),P.X.Filter.CENTER_GROUP(.05)),this.onPointerButton=e=>{e.down||this.viewData.pinEditorState!==U.ce.PLACED||(this.allowExternalBehaviors(!0),this.engine.commandBinder.issueCommand(new y.j(!1)))},this.onAnchorDragBegin=e=>{const{isPinEditable:t,pinEditorState:i,selectedPinId:n}=this.viewData,a=n?this.viewData.getPin(n):null;!a||e.buttons!==O.O.PRIMARY||i!==U.ce.PLACED&&i!==U.ce.IDLE||(t?(this.movingPin=!0,this.startingPinData=this.copyPinData(a),this.allowExternalBehaviors(!1),this.draggingHandlers.renew(),this.engine.commandBinder.issueCommand(new v.X(w.b.GRABBING)),this.engine.commandBinder.issueCommand(new y.j(!0)),this.engine.commandBinder.issueCommand(new F.WH),this.inAnchorClick=!0):this.log.debug("onAnchorSelect called on a non-editable pin"))},this.doneMovingPin=()=>{this.viewData.selectedPinId&&this.movingPin&&(this.draggingHandlers.cancel(),this.engine.commandBinder.issueCommand(new v.X(null)),this.engine.commandBinder.issueCommand(new y.j(!1)),this.engine.commandBinder.issueCommand(new F.RK),this.movingPin=!1,this.startingPinData=void 0,this.allowExternalBehaviors(!0),this.updateMeshPreviewSphere(!1))},this.onClickElsewhere=e=>{const{selectedPinId:t,pinEditorState:i}=this.viewData;if(!(i===U.ce.CREATING&&t||this.inAnchorClick))return t&&(this.movingPin?this.doneMovingPin():this.engine.commandBinder.issueCommand(new W.wd)),!0},this.onLongPressStart=async e=>{if(e.buttons!==O.O.PRIMARY)return;const t=this.viewData;t.pinEditorState===U.ce.CREATING&&(t.setProgress(0),t.setPinEditorState(U.ce.PRESSING),this.allowExternalBehaviors(!1),this.saveScreenPosition(e.position.x,e.position.y))},this.onLongPressProgress=e=>{const{viewData:t}=this;t.pinEditorState===U.ce.PRESSING&&t.setProgress(e.progress)},this.onLongPressSuccess=async e=>{const{viewData:t}=this;t.setPinEditorState(U.ce.PLACING);await this.positionPin(e)||(t.setPinEditorState(U.ce.CREATING),t.setCanPlace(!1))},this.onLongPressEnd=()=>{const e=this.viewData.pinEditorState;e===U.ce.PRESSING?(this.log.debug("Did not press long enough"),this.endPinCreation()):e===U.ce.PLACING&&this.placePin()},this.onPointerEvent=e=>{const t=this.viewData.pinEditorState;t!==U.ce.PLACING&&t!==U.ce.CREATING||this.positionPin(e)},this.onClickToPlacePin=()=>{this.placePin()},this.onKeyEvent=e=>{if(e.state===L.$.PRESSED&&e.key===j.D.ESCAPE)this.viewData.creatingNewPin&&this.engine.broadcast(new Y.fD)},Promise.all([t.market.waitForData(m.M),t.market.waitForData(q.q),t.market.waitForData(h.X),t.market.waitForData(g.X),t.getModuleBySymbol(s.yR),t.getModuleBySymbol(s.PM)]).then((([t,n,a,s,o,r])=>{this.cameraData=t,this.floorsData=n,this.floorsViewData=a,this.viewmodeData=s,this.fatcaster=o,this.meshQuery=r,this.bindings.push(i.registerPriorityHandler(M.CD,H.R,this.stopEventPropagation),e.onSelectedPinChanged(this.onSelectedPinChanged)),this.selectedHandlers=new C.P(i.registerPriorityHandler(x.rX,I.r,this.onClickElsewhere),i.registerPriorityHandler(x.rX,k.W,this.onClickElsewhere)),this.selectedHandlers.cancel()}))}dispose(){var e,t,i,n,a;this.removePinAnchorMesh(),null===(e=this.dragInterceptor)||void 0===e||e.cancel(),null===(t=this.addingHandlers)||void 0===t||t.cancel(),null===(i=this.draggingHandlers)||void 0===i||i.cancel(),null===(n=this.selectedHandlers)||void 0===n||n.cancel(),null===(a=this.editableSelectedHandlers)||void 0===a||a.cancel(),this.bindings.forEach((e=>{e.cancel()}))}toggleEditing(e){e!==this.editEnabled&&(this.editEnabled=e,e?(this.handlersRegistered?this.creationHandlers.renew():this.registerHandlers(),this.updateAnchorMesh()):(this.inAnchorClick=!1,this.anchored=!1,this.movingPin=!1,this.creationHandlers.cancel(),this.allowExternalBehaviors(!0),this.removePinAnchorMesh(),this.updateMeshPreviewSphere(!1)),this.dragInterceptor.cancel(),this.draggingHandlers.cancel(),this.addingHandlers.cancel(),this.editableSelectedHandlers.cancel())}registerHandlers(){const e=this.input,t=this.viewData;this.creationHandlers=new C.P(t.onPinEditorStateChanged(this.onPinStateUpdated)),this.dragInterceptor=new C.P(e.registerPriorityHandler(B.jF,I.r,(()=>!0)),e.registerPriorityHandler(B.jF,k.W,(()=>!0))),this.draggingHandlers=new C.P(e.registerUnfilteredHandler(B.jF,this.onDragEvent),e.registerUnfilteredHandler(B._w,this.onDragEnd)),this.editableSelectedHandlers=new C.P(e.registerMeshHandler(B.SK,E.f.isType(X),this.onAnchorDragBegin)),this.touchDevice?this.addingHandlers=new C.P(e.registerHandler(M.CD,this.onPointerButton),e.registerUnfilteredHandler(V.OR,this.onLongPressStart),e.registerUnfilteredHandler(V.v0,this.onLongPressProgress),e.registerUnfilteredHandler(V.Zl,this.onLongPressSuccess),e.registerUnfilteredHandler(V.vp,this.onLongPressEnd)):this.addingHandlers=new C.P(e.registerHandler(R.k,this.onKeyEvent),e.registerHandler(M.CD,this.onPointerButton),e.registerUnfilteredHandler(x.rX,this.onClickToPlacePin),e.registerHandler(M.$3,this.onPointerEvent))}removePinAnchorMesh(){this.pinRenderer.hideAnchorMesh(),this.anchored=!1}copyPinData(e){return{anchorPosition:e.anchorPosition.clone(),stemNormal:e.stemNormal.clone(),floorId:e.floorId,roomId:e.roomId,stemLength:e.stemLength,stemEnabled:e.stemEnabled,color:e.color}}saveScreenPosition(e,t){this.ndcPoint.set(e,t,0);const i=(0,o.zH)(this.cameraData.width,this.cameraData.height,this.ndcPoint);this.viewData.setScreenPosition(i)}}var ee=i(24213),te=i(43998),ie=i(60840),ne=i(48071),ae=i(2785),se=i(45610),oe=i(10691),re=i(79953),de=i(14048);class le extends n.Mesh{constructor(e){super(new n.PlaneGeometry(_.A.selection.size,_.A.selection.size),new de.Kg),this.visible=!1,this.layers.mask=e.mask,this.renderOrder=z.X.pinSelectedHalo}}var he=i(47568);class ce{constructor(e,t,i=1){this.atlasMaxSize=e,this.iconSize=t,this.padding=i,this.uvRects=new Map,this.iconCount=0,this.onResize=new he.y;const a=this.canvas=document.createElement("canvas");a.width=e,a.height=t,this.texture=new n.CanvasTexture(a),this.texture.colorSpace=n.SRGBColorSpace}addIcon(e,t){var i,n;const{atlasMaxSize:a,iconSize:s,padding:o,canvas:r,uvRects:d}=this,l=r.getContext("2d");let h=!1,c=d.get(e);if(!c){const t=this.iconCount++,i=a/s,n=Math.floor(t/i),o=t%i;if((n+1)*s>r.height){const e=l.getImageData(0,0,r.width,r.height);r.height*=2,l.putImageData(e,0,r.height/2),this.texture.dispose(),d.forEach((e=>{e.minV/=2,e.maxV/=2})),h=!0}c={minU:o/i,minV:n/(r.height/s),maxU:(o+1)/i,maxV:(n+1)/(r.height/s)},d.set(e,c)}const m=c.minU*a,u=(1-c.maxV)*r.height;return l.clearRect(m,u,s,s),"font"===t.type?(l.font=`${s-2*o}px ${t.family}`,l.textAlign="center",l.textBaseline="top",l.fillStyle="#fff",l.fillText(String.fromCodePoint(t.codePoint),m+s/2+((null===(i=t.offset)||void 0===i?void 0:i.x)||0),u+o+((null===(n=t.offset)||void 0===n?void 0:n.y)||0))):l.drawImage(t.image,m+o,u+o,s-2*o,s-2*o),this.texture.needsUpdate=!0,h&&this.onResize.notify(),c}}var me=i(39404),ue=i(59105);class ge{constructor(e,t,i,a,s,o,r=!1){this.input=e,this.camera=t,this.canvasData=i,this.layer=a,this.commandBinder=s,this.raycaster=o,this.iconsEnabled=r,this.container=new n.Object3D,this.floorIdToContainer=new Map,this.hexColorToColor=new Map,this.bindings=[],this.anchor=null,this.selected=null,this.haloEasing=(0,re.v)(.5,.52,0,1.98),this.pinViews=new Map,this.pinsWithOverrideTexture=new Set,this.refreshPins=()=>{this.pinViews.forEach(((e,t)=>{this.updatePin(t,e.pinType,e,e.backgroundTexture)}))},this.updateAnchorPosition=(()=>{const e=new n.Vector3,t=new n.Vector3,i=new n.Vector3;return n=>{const a=this.anchorMesh;if(!a)return;const s=this.raycaster.picking;e.copy(n.stemNormal).normalize(),t.copy(e).multiplyScalar(.2).add(n.anchorPosition),i.copy(e).multiplyScalar(-1);const o=s.pick(t,i,(e=>e instanceof oe.B));if(o){const e=Math.min(.2,o.distance);a.position.copy(t).add(i.multiplyScalar(.999*e))}else a.position.copy(t).add(i.multiplyScalar(.999*n.stemLength));a.lookAt(t)}})(),this.onAnchorHover=()=>{this.commandBinder.issueCommand(new v.X(w.b.GRAB)),this.commandBinder.issueCommand(new y.j(!0))},this.onAnchorUnhover=()=>{this.commandBinder.issueCommand(new v.X(null)),this.commandBinder.issueCommand(new y.j(!1))},this.iconAtlas=new ce(4096,128,4),this.iconAtlas.onResize.observe({notify:this.refreshPins})}init(){this.container.name="PinContainer",this.container.layers.mask=this.layer.mask,this.anchorMesh=new X(this.layer),this.anchorMesh.name="Anchor Mesh",this.container.add(this.anchorMesh),this.selectedMesh=new le(this.layer),this.selectedMesh.name="Selected Mesh",this.container.add(this.selectedMesh);for(const e of Object.values(U.tf))this.iconAtlas.addIcon(e,{type:"font",family:"mp-font",codePoint:+me.J[e],offset:(0,ue.hs)(e)})}dispose(){this.container.parent&&this.container.parent.remove(this.container);for(const e of[this.anchorMesh,this.selectedMesh])e&&e.parent&&e.parent.remove(e)}activate(e){this.bindings.length>0||this.bindings.push(this.input.registerMeshHandler(ae.L,E.f.isType(X),this.onAnchorHover),this.input.registerMeshHandler(ae.q,E.f.isType(X),this.onAnchorUnhover))}deactivate(e){for(const e of this.bindings)e.cancel();this.bindings.length=0}render(e){if(this.selected){const{animation:e,hideWhenDoneAnimating:t}=this.selected,i=this.selectedMesh;if(i&&i.visible&&e){const a=this.pinHeadTransform(this.selected.id),s=new n.Vector3,o=new n.Quaternion,r=new n.Vector3;a.decompose(s,o,r),r.multiplyScalar(e.getUpdatedValue()),t&&!e.isAnimating?(i.visible=!1,this.selected=null):(i.position.copy(s),i.quaternion.copy(o),i.scale.copy(r))}}if(this.anchorMesh&&this.anchorMesh.visible){const e=this.getViewportScale(this.canvasData);this.anchorMesh.update(this.camera,e,this.canvasData)}}updatePin(e,t,i,n,a){this.anchorMesh&&this.anchorMesh.visible&&this.anchor&&this.anchor.pinType===t&&this.anchor.id===e&&this.updateAnchorPosition(i),this.pinViews.set(e,Object.assign(Object.assign({},i),{id:e,pinType:t,backgroundTexture:n}))}removePin(e){this.selected&&this.selected.id===e&&this.clearSelected(),this.pinViews.delete(e)}removePinsByType(e){this.removePinsByPredicate((t=>t===e))}removePinsByPredicate(e){}setPinVisible(e,t){}setPinColorVariant(e,t){}setPinColorVariants(e,t){}setPinColorVariantByType(e,t,i){}setPinOpacity(e,t){}setPinOpacityByType(e,t,i){}fadePinOpacity(e,t){}fadePinOpacityByType(e,t,i=[]){}setPinRenderOverrides(e,t,i){t?(this.pinsWithOverrideTexture.add(e),this.selected&&this.selected.id===e&&this.clearSelected()):this.pinsWithOverrideTexture.delete(e)}setFloorsHidden(e){this.floorIdToContainer.forEach(((t,i)=>{t.visible=!e(i)}))}setPinTypeVisible(e,t){this.floorIdToContainer.forEach((i=>{i.userData.typeContainers[e].visible=t}))}showAnchorMesh(e,t,i){this.anchor={pinType:e,id:t},this.anchorMesh&&!this.anchorMesh.visible&&(this.anchorMesh.visible=!0,this.input.registerMesh(this.anchorMesh,!1)),this.updateAnchorPosition(i)}hideAnchorMesh(){this.anchorMesh&&this.anchorMesh.visible&&(this.anchorMesh.visible=!1,this.input.unregisterMesh(this.anchorMesh))}showSelectedMesh(e,t){const i=this.selected&&this.selected.pinType===e&&this.selected.id===t;this.selected&&i||this.pinsWithOverrideTexture.has(t)||(this.selected={pinType:e,id:t,hideWhenDoneAnimating:!1,animation:new se.A({startValue:1,endValue:1.4,duration:300,easingFunction:this.haloEasing})},this.selectedMesh.visible=!0)}hideSelectedMesh(){this.selected&&(this.selected.animation=new se.A({startValue:1.4,endValue:1,duration:300}),this.selected.hideWhenDoneAnimating=!0)}getFloorContainer(e){let t=this.floorIdToContainer.get(e);if(t)return t;t=new n.Object3D,t.name="Floor "+e,t.userData.typeContainers={},t.layers.mask=this.layer.mask;for(const e of Object.values(U.yY)){const i=new n.Object3D;i.name=e,i.layers.mask=this.layer.mask,t.add(i),t.userData.typeContainers[e]=i}return this.container.add(t),this.floorIdToContainer.set(e,t),t.userData.floorId=e,t}getColor(e){let t=this.hexColorToColor.get(e);if(t)return t;const i=new n.Color(e),a={h:0,s:0,l:0};i.getHSL(a);return t={baseColor:i,hoverColor:(new n.Color).setHSL(a.h,a.s,.8*a.l),dimmedColor:(new n.Color).setHSL(a.h,.5*a.s,a.l)},this.hexColorToColor.set(e,t),t}getViewportScale(e){return Math.sqrt(Math.min(e.width,e.height)/_.A.pinHeadMesh.scale.baseViewportSize)}clearSelected(){this.selectedMesh.visible=!1,this.selected=null}}var pe=i(2747);const ye=new de.Zo,ve=new N.Ay("InstancedPinHeads");class we extends n.InstancedMesh{constructor(e){const t=new n.BufferGeometry,i=new Float32Array(6);i[0]=i[1]=i[2]=0,i[3]=1,i[4]=1,i[5]=1,t.setAttribute("position",new n.BufferAttribute(i,3));const a=new Float32Array(3*e),s=new n.InstancedBufferAttribute(a,3);t.setAttribute("stemVector",s);const o=new Float32Array(e),r=new n.InstancedBufferAttribute(o,1);t.setAttribute("instanceAlpha",r);const d=[],l=[];for(let i=0;i<4;i++){const a=new Float32Array(4*e),s=new n.InstancedBufferAttribute(a,4);t.setAttribute(`pinHeadMatrixCol${i}`,s),d.push(a),l.push(s)}super(t,ye,e),this.maxCount=e,this.stemVectorArray=a,this.stemVectorAttrib=s,this.pinHeadMatrixArray=d,this.pinHeadMatrixAttrib=l,this.opacityArray=o,this.opacityAttrib=r,this.renderOrder=z.X.lines,this.posMatrix=new n.Matrix4,this.isLine=!0,this.isMesh=!1}update(e,t){let i=0;for(const t of e){if(!t.visible||!t.stemEnabled||t.stemLength<.001)continue;if(i>=this.maxCount){ve.error("Instance count is too small!");continue}this.posMatrix.setPosition(t.anchorPosition),this.setMatrixAt(i,this.posMatrix),this.opacityArray[i]=t.opacity*t.opacityAnimation.value*t.opacityScale;const e=3*i;t.pinHeadObjPosition.toArray(this.stemVectorArray,e);let n=0;for(let e=0;e<4;e++)for(let a=0;a<4;a++)this.pinHeadMatrixArray[e][a+4*i]=t.pinHeadMatrix.elements[n++];i++}this.count=i,this.visible=this.count>0,this.instanceMatrix.needsUpdate=!0,this.stemVectorAttrib.needsUpdate=!0;for(const e of this.pinHeadMatrixAttrib)e.needsUpdate=!0;this.opacityAttrib.needsUpdate=!0,ye.uniforms.resolution.value.set(t.width,t.height),ye.uniformsNeedUpdate=!0,this.computeBoundingSphere()}}var fe=i(83916);const be=new N.Ay("InstancedPinRenderer");class Te extends ge{constructor(e,t,i,a,s,o,r,d=!1){super(e,t,i,a,s,o,d),this.pins=new Map,this.idToPin=new Map,this.keyToRenderObjs=new Map,this.updatePinHeadMatrix=(()=>{const e=new n.Vector3,t=new n.Vector3,i=new n.Vector3,a=new n.Vector3,s=new n.Vector3,o=new n.Vector3,r=new n.Vector3;return n=>{const d=_.A.pinHeadMesh.scale,l=this.getViewportScale(this.canvasData),h=1+d.responsiveness/100*(l-1);this.camera.getWorldPosition(o);const c=this.camera.quaternion,m=this.canvasData;for(const l of n){r.copy(l.pinHeadObjPosition).add(l.anchorPosition);const n=o.distanceTo(r),u=d.maxSize-(d.maxSize-d.minSize)*(0,ee.T)(n,d.nearBound,d.farBound);t.copy(r).project(this.camera),i.set(m.width/2,m.height/2,1).multiply(t),a.set(u/2,0,0).add(i),s.set(2/m.width,2/m.height,1).multiply(a);const g=s.unproject(this.camera).distanceTo(r)*h,p=(0,te.qE)(g,ie.A.epsilon,g),y=l.geomScale||ne.B1.UNIT;e.set(p*y.x,p*y.y,p*y.z),l.pinHeadMatrix.compose(r,c,e)}}})(),this.inputCallbacks=r}dispose(){super.dispose()}activate(e){this.bindings.length>0||(super.activate(e),this.bindings.push(this.input.registerPriorityHandler(x.rX,pe.k,((e,t,i)=>{if(!i||void 0===i.instanceId)return!0;const n=t.renderedPins[i.instanceId];return this.inputCallbacks.onClick(n.id,n.pinType),!0}))),(0,r.C8)()||(this.bindings.push(this.input.registerMeshHandler(ae.L,E.f.isType(pe.k),((e,t,i)=>{if(!i||void 0===i.instanceId)return;const n=t.renderedPins[i.instanceId];this.lastHoverId=n.id,this.lastHoverType=n.pinType,this.inputCallbacks.onHover(n.id,n.pinType)}))),this.bindings.push(this.input.registerMeshHandler(ae.q,E.f.isType(pe.k),(()=>{this.inputCallbacks.onUnhover(this.lastHoverId,this.lastHoverType)})))))}render(e){var t,i,n,a;for(const s of this.pins.values()){const o=Array.from(s.values());if(0===o.length)continue;const r=this.keyFromPin(o[0]),d=this.keyToRenderObjs.get(r);if(!d){be.error("Expecting renderObjs for this key.",this.keyToRenderObjs,this.keyFromPin(o[0]));continue}let{lines:l,pinHeads:h}=d;if(o.forEach((t=>t.opacityAnimation.tick(e))),this.updatePinHeadMatrix(o),l.maxCount<o.length){const e=l.parent;if(!e){be.error("Expecting a parent.");continue}e.remove(l),l.dispose(),e.remove(h),this.input.unregisterMesh(h);const{backgroundTexture:t,maskTexture:i,overrideTexture:n}=o[0];h.dispose(),Object.assign(d,this.createInstances(e,d.id,o.length+16,t,i,n)),l=d.lines,h=d.pinHeads}l.update(o,this.canvasData),(null===(t=o[0].maskTexture)||void 0===t?void 0:t.uuid)&&(null===(a=null===(n=null===(i=h.material.uniforms)||void 0===i?void 0:i.mask)||void 0===n?void 0:n.value)||void 0===a?void 0:a.uuid)&&o[0].maskTexture.uuid!==h.material.uniforms.mask.value.uuid&&h.updateMaskTexture(o[0].maskTexture),h.update(o)}super.render(e)}updatePin(e,t,i,a,s){var o;super.updatePin(e,t,i,a,s);let r=this.idToPin.get(e);const d=i.floorId,l=this.getColor(i.color).baseColor,h=`${d}_${t}_${(null===(o=null==r?void 0:r.overrideTexture)||void 0===o?void 0:o.uuid)||a.uuid}`,c=(0,ue.RN)(t,i.icon,this.iconsEnabled);let m=this.iconAtlas.uvRects.get(c);m||(m=this.iconAtlas.addIcon(c,{type:"font",family:"mp-font",codePoint:+me.J[c],offset:(0,ue.hs)(c)}));const u=t===U.yY.OBJECT?0:.06;if(!r){r=Object.assign(Object.assign({id:e},i),{visible:!0,opacity:1,opacityScale:1,pinType:t,opacityAnimation:new fe.z(0),backgroundTexture:a,maskTexture:this.iconAtlas.texture,pinHeadMatrix:new n.Matrix4,pinHeadObjPosition:new n.Vector3,pinColor:l,colorVariant:U.ob.DEFAULT,overrideTexture:null,geomScale:null,pinIconUVRect:m,pinStrokeWidth:u,needsEntryAnimation:!0}),this.idToPin.set(e,r);let s=this.pins.get(h);s||(s=new Map,this.pins.set(h,s)),s.set(e,r),this.createRenderObjsForPin(r)}const g=this.keyFromPin(r);Object.assign(r,i,{pinType:t,textureId:a.uuid,maskTexture:this.iconAtlas.texture}),this.changePinHeadGroupIfNeeded(g,h,r),r.pinHeadObjPosition.copy(r.stemNormal).setLength(r.stemLength),r.pinColor=(0,ue.nK)(this.getColor(r.color),r.colorVariant),r.pinIconUVRect=m,r.pinStrokeWidth=u,void 0!==s&&this.setPinVisible(e,s),m&&r.needsEntryAnimation&&(r.opacityAnimation.modifyAnimation(r.opacityAnimation.value,1,500,re.lu),r.opacityAnimation.onComplete((()=>{r&&(r.needsEntryAnimation=!1)})))}removePin(e){super.removePin(e);const t=this.idToPin.get(e);if(!t)return;this.idToPin.delete(e);const i=this.keyFromPin(t),n=this.pins.get(i);n&&(n.delete(e),this.cleanupRenderObjIfNeeded(i))}removePinsByPredicate(e){this.idToPin.forEach(((t,i)=>{e(t.pinType)&&this.removePin(i)}))}setPinVisible(e,t){const i=this.idToPin.get(e);i?i.visible=t:be.error("setPinVisible on a pin that doesn't exist.",e)}setPinColorVariant(e,t){const i=this.idToPin.get(e);i?(i.colorVariant=t,i.pinColor=(0,ue.nK)(this.getColor(i.color),t)):be.error("setPinColorVariant on a pin that doesn't exist.")}setPinColorVariants(e,t){this.idToPin.forEach(((i,n)=>{n!==t&&this.setPinColorVariant(n,e)}))}setPinColorVariantByType(e,t,i){this.idToPin.forEach(((n,a)=>{n.pinType===e&&a!==i&&this.setPinColorVariant(a,t)}))}setPinOpacity(e,t){const i=this.idToPin.get(e);i?i.opacity=t:be.error("setPinOpacity on a pin that doesn't exist.")}setPinOpacityScale(e,t){const i=this.idToPin.get(e);i?i.opacityScale=t:be.error("setPinOpacityScale on a pin that doesn't exist.")}fadePinOpacity(e,t){const i=this.idToPin.get(e);i?(t>0&&this.setPinVisible(e,!0),i.opacityAnimation.modifyAnimation(i.opacityAnimation.value,t,300).onComplete((()=>{i.opacityAnimation.endValue<=0&&this.setPinVisible(e,!1)}))):be.error("setPinVisible on a pin that doesn't exist.",e)}setPinOpacityByType(e,t,i){this.idToPin.forEach(((n,a)=>{n.pinType===e&&a!==i&&this.setPinOpacity(a,t)}))}fadePinOpacityByType(e,t,i=[]){this.idToPin.forEach(((n,a)=>{n.pinType!==e||i.includes(a)||this.fadePinOpacity(a,t)}))}setPinRenderOverrides(e,t,i){super.setPinRenderOverrides(e,t,i);const n=this.idToPin.get(e);if(!n)return void be.error("setPinRenderOverrides on a pin that doesn't exist.");const a=this.keyFromPin(n);if(!this.keyToRenderObjs.get(a))return void be.error("Expecting renderObjs while setting override material");n.overrideTexture=t,n.geomScale=i;const s=this.keyFromPin(n);this.changePinHeadGroupIfNeeded(a,s,n)}pinHeadTransform(e){const t=this.idToPin.get(e);return t?t.pinHeadMatrix:(be.error("pinHeadTransform on a pin that doesn't exist."),new n.Matrix4)}keyFromPin(e){return`${e.floorId}_${e.pinType}_${e.overrideTexture?e.overrideTexture.uuid:e.backgroundTexture.uuid}`}createRenderObjsForPin(e){const{backgroundTexture:t,maskTexture:i,overrideTexture:n}=e,a=this.keyFromPin(e);if(this.keyToRenderObjs.get(a))return;const s=this.getFloorContainer(e.floorId).userData.typeContainers[e.pinType];s.userData||(s.userData={});const o=e.overrideTexture?e.overrideTexture.uuid:e.backgroundTexture.uuid;if(!s.userData[o]){const e=this.createInstances(s,o,16,t,i,n);s.userData[o]=e,this.keyToRenderObjs.set(a,e)}}createInstances(e,t,i,n,a,s){const o=new we(i);o.layers.mask=this.layer.mask,e.add(o);const r=new pe.k(i,s||n,s?null:a,!s);return r.layers.mask=this.layer.mask,e.add(r),this.input.registerMesh(r,!1),{lines:o,pinHeads:r,id:t}}changePinHeadGroupIfNeeded(e,t,i){if(e!==t){let n=this.pins.get(t);n||(n=new Map,this.pins.set(t,n)),n.set(i.id,i),this.createRenderObjsForPin(i);const a=this.pins.get(e);a&&(null==a||a.delete(i.id),this.cleanupRenderObjIfNeeded(e))}}cleanupRenderObjIfNeeded(e){const t=this.pins.get(e),i=this.keyToRenderObjs.get(e);if(t&&0===t.size&&i){const t=i.lines.parent;if(this.input.unregisterMesh(i.pinHeads),this.pins.delete(e),this.keyToRenderObjs.delete(e),!t)return void be.error("Expecting pinTypeObj!");t.userData[i.id]=void 0,t.remove(i.lines),t.remove(i.pinHeads)}}}var De=i(61334);class Ce extends a.n{constructor(){super(...arguments),this.name="pins",this.editActivated=!1,this.editBindings=[],this.touchDevice=(0,r.C8)(),this.worldPosition=new n.Vector3,this.visibilityChanged=()=>{const e=!this.in360View(),t=!this.interactionmodeData.isVR();this.pinRenderer.container.visible=e&&t;const{floorsViewData:i}=this,n=this.viewmode===p.N3.Dollhouse||this.viewmode===p.N3.Floorplan,a=i.transition.progress.active?()=>!0:i.isHidden;this.pinRenderer.setFloorsHidden(n?a:()=>!1)},this.viewmodeChanged=e=>{this.viewmode=e.toMode,this.visibilityChanged()},this.onEnablePinEditing=async e=>{e.enabled?this.enableEditing():this.disableEditing()},this.updateCurrentPin=()=>{const{pinEditorState:e,focusedPin:t,selectedPinId:i}=this.viewData;if(e!==U.ce.CREATING){const e=i?this.viewData.getPin(i):null,n=t||e;if(this.pinEditor.updateAnchorMesh(),n){const{id:e,pinType:t,backgroundTexture:i}=n;this.pinRenderer.updatePin(e,t,n,i),this.pinRenderer.setPinColorVariant(e,U.ob.HIGHLIGHTED),this.pinRenderer.setPinColorVariants(U.ob.DEFAULT,e)}else this.pinRenderer.setPinColorVariants(U.ob.DEFAULT)}},this.onUpdatePin=async e=>{const{id:t,pinType:i,properties:n}=e,a=this.viewData.getPin(t);if(a&&a.pinType===i){const{focusedPin:e,selectedPinId:i}=this.viewData,s=i?this.viewData.getPin(i):null,o=Object.assign(Object.assign({},a),n);this.viewData.updatePin(o),this.pinRenderer.updatePin(o.id,o.pinType,o,o.backgroundTexture),(null==s?void 0:s.id)===t&&(this.saveScreenPosition(o),this.updateCurrentPin()),(null==e?void 0:e.id)===t&&this.saveScreenPosition(o)}else this.log.debug(`Cannot update non-existent ${i} pin`)},this.onUpdatePinViews=async e=>{const{pinViews:t}=e;t.forEach((e=>{this.viewData.updatePin(e),this.pinRenderer.updatePin(e.id,e.pinType,e,e.backgroundTexture,e.visible),this.viewData.selectedPinId===e.id&&(this.viewData.updatePin(e),this.updateCurrentPin()),void 0!==e.opacity&&this.pinRenderer.setPinOpacity(e.id,e.opacity),void 0!==e.scale&&this.pinRenderer.setPinRenderOverrides(e.id,null,e.scale)}))},this.onChangePinVisibility=async e=>{const{id:t,pinType:i,visible:n}=e,a=this.viewData.getPin(t);if(a&&a.pinType===i){this.pinRenderer.setPinVisible(t,n);const{selectedPinId:e,focusedPin:i}=this.viewData;n||e!==t||this.changeSelectedPin(null),n||(null==i?void 0:i.id)!==t||this.viewData.setFocusedPin(null)}else this.log.debug(`Cannot change visibility of non-existent ${i} pin`)},this.onChangePinVisibilityByType=async e=>{const{pinType:t,visible:i}=e;this.pinRenderer.setPinTypeVisible(t,i)},this.onChangePinOpacity=async e=>{const{id:t,pinType:i,opacity:n}=e,a=this.viewData.getPin(t);a&&a.pinType===i?this.pinRenderer.setPinOpacity(t,n):this.log.debug(`Cannot change opacity of non-existent ${i} pin`)},this.onChangePinOpacityScale=async e=>{const{id:t,pinType:i,scale:n}=e,a=this.viewData.getPin(t);a&&a.pinType===i?this.pinRenderer.setPinOpacityScale(t,n):this.log.debug(`Cannot change opacity scaling of non-existent ${i} pin`)},this.onChangePinOpacityByType=async e=>{const{pinType:t,opacity:i,skipIds:n}=e;this.pinRenderer.fadePinOpacityByType(t,i,n)},this.onUnselectPin=async e=>{const{pinType:t,id:i}=e,{selectedPinId:n}=this.viewData,a=n?this.viewData.getPin(n):null;(null==a?void 0:a.pinType)===t&&(null==a?void 0:a.id)===i&&this.changeSelectedPin(null)},this.clearPinSelection=async()=>{this.changeSelectedPin(null)},this.onStartPinCreation=async e=>{const{id:t,pin:i,pinType:n,backgroundTexture:a}=e,s=this.viewData,o=Object.assign(Object.assign({id:t,pinType:n},i),{backgroundTexture:a});s.setEditablePin(!0),s.setPinEditorState(U.ce.CREATING),this.changeSelectedPin(o),this.pinEditor.startPinCreation()},this.saveScreenPosition=e=>{const t=this.viewData,i=e.stemNormal.clone().normalize();this.worldPosition.copy(e.anchorPosition).addScaledVector(i,e.stemLength);const n=(0,o.bz)(this.cameraData,this.worldPosition);t.setScreenPosition(n.ndcPosition.z>1?null:n.screenPosition)},this.onCameraUpdate=()=>{const{creatingNewPin:e,focusedPin:t,selectedPinId:i}=this.viewData,n=i?this.viewData.getPin(i):null;!e&&t?this.saveScreenPosition(t):n&&this.saveScreenPosition(n)},this.handleSweepChange=()=>this.handleSweepAndViewModeChange(),this.handleViewModeChange=()=>this.handleSweepAndViewModeChange(),this.cancelPinCreation=()=>{const{creatingNewPin:e,selectedPinId:t}=this.viewData;if(this.changeSelectedPin(null),t){const i=t?this.viewData.getPin(t):null;e&&i&&(this.engine.broadcast(new Y.lY(i.id,i.pinType)),this.removePin(i.id,i.pinType),this.pinEditor.endPinCreation())}this.resetEditingState()},this.onPinPlacementCancelled=()=>{this.cancelPinCreation()},this.onCancelNewPin=async()=>{this.cancelPinCreation()},this.onViewChange=()=>{this.cancelPinCreation()},this.handleRemovingPin=async e=>{const{pinType:t,id:i}=e;this.removePin(i,t)},this.handleRemovingPinsByType=async e=>{const{pinType:t}=e,{focusedPin:i,selectedPinId:n}=this.viewData,a=n?this.viewData.getPin(n):null;(null==a?void 0:a.pinType)===t&&this.changeSelectedPin(null),(null==i?void 0:i.pinType)===t&&this.viewData.setFocusedPin(null),this.viewData.removePinsByType(t),this.pinRenderer.removePinsByType(t)},this.onTogglePinEditing=async e=>{const{id:t,editable:i}=e;this.viewData.getPin(t)&&this.viewData.setEditablePin(i)},this.onPinClicked=e=>{const{pinType:t,id:i}=e,{creatingNewPin:n,selectedPinId:a}=this.viewData,s=a?this.viewData.getPin(a):null,o=i===(null==s?void 0:s.id)&&t===(null==s?void 0:s.pinType);if(s&&o){if(n)return;this.changeSelectedPin(null)}else if(n)this.cancelPinCreation();else{if(!(i===(null==s?void 0:s.id)&&t===(null==s?void 0:s.pinType))){const e=this.viewData.getPin(i);e&&this.changeSelectedPin(e)}}},this.onHoverChanged=e=>{const{pinType:t,id:i,hovering:n}=e,{creatingNewPin:a,focusedPin:s,selectedPinId:o}=this.viewData;if(!a)if(n){const e=this.viewData.getPin(i);if(!e)return void this.log.debug("Cannot find pin to focus");const n=o?this.viewData.getPin(o):null;if(this.viewData.setFocusedPin(e),n&&n.id===i&&n.pinType===t)return;this.saveScreenPosition(e),this.pinRenderer.setPinColorVariantByType(t,U.ob.DEFAULT,null==s?void 0:s.id),this.pinRenderer.setPinColorVariant(i,U.ob.HIGHLIGHTED)}else s&&(this.pinRenderer.setPinColorVariant(s.id,U.ob.DEFAULT),this.viewData.setFocusedPin(null))},this.onSelectPin=async e=>{const{id:t,pinType:i,editable:n}=e,a=this.viewData,{selectedPinId:s,isPinEditable:o}=a;if(a.setPinEditorState(U.ce.IDLE),t===s&&n===o)return void this.log.debug("Pin is already selected");const r=this.viewData.getPin(t);r&&r.pinType===i?(a.setEditablePin(n),this.changeSelectedPin(r)):this.log.debug(`Cannot select ${i} pin`)},this.clickOffPin=async()=>{this.viewData.creatingNewPin||this.changeSelectedPin(null)},this.movePin=async e=>{const{isPinEditable:t,selectedPinId:i}=this.viewData;if(!t)return;const{pos:n,previousPos:a,id:s}=e,o=i?this.viewData.getPin(i):null;if(o&&o.id===s){const t=Object.assign(Object.assign({},o),e.pos);this.viewData.updatePin(t),this.updateCurrentPin(),this.engine.broadcast(new Y.cC(o.id,o.pinType,n,a))}else this.log.debug("Cannot move the pin, not open for edit")},this.placePin=async e=>{const{isPinEditable:t,canPlace:i,selectedPinId:n}=this.viewData;if(!t)return;const a=n?this.viewData.getPin(n):null;a&&i?(this.viewData.setPinEditorState(U.ce.PLACED),this.engine.broadcast(new Y.yi(a.id,a.pinType,a))):(this.log.debug("Cannot place pin because there is no open pin"),this.cancelPinCreation())}}async init(e,t){this.engine=t;const[i,n,a,o,r,p]=await Promise.all([t.getModuleBySymbol(s.mL),t.getModuleBySymbol(s.M7),t.market.waitForData(l.p),t.market.waitForData(d.zH),t.getModuleBySymbol(s.sA),t.market.waitForData(De.P),document.fonts.ready]);this.input=i;const C={onClick:(e,i)=>{t.broadcast(new Y.oX(e,i))},onHover:(e,i)=>{t.broadcast(new Y.RG(e,!0,i)),t.commandBinder.issueCommand(new v.X(w.b.FINGER)),t.commandBinder.issueCommand(new y.j(!0))},onUnhover(e,i){t.broadcast(new Y.RG(e,!1,i)),t.commandBinder.issueCommand(new v.X(null)),t.commandBinder.issueCommand(new y.j(!1))}},P=t.claimRenderLayer(this.name);this.pinRenderer=new Te(i,n.getCamera(),a,P,t.commandBinder,r,C,e.tagIconsEnabled),n.getScene().add(this.pinRenderer.container),t.addComponent(this,this.pinRenderer),[this.floorsViewData,this.viewmodeData,this.interactionmodeData,this.sweepData,this.cameraData]=await Promise.all([t.market.waitForData(h.X),t.market.waitForData(g.X),t.market.waitForData(c.O),t.market.waitForData(u.A),t.market.waitForData(m.M)]),this.viewData=new D.U,this.pinEditor=new Z(this.viewData,this.engine,this.input,this.pinRenderer),this.floorsViewData.iterate((e=>this.pinRenderer.getFloorContainer(e.id))),this.viewmode=this.viewmodeData.currentMode,this.bindings.push(t.commandBinder.addBinding(W.fZ,this.onEnablePinEditing),t.commandBinder.addBinding(W.Rg,this.onSelectPin),t.commandBinder.addBinding(W.mP,this.onUnselectPin),t.commandBinder.addBinding(W.mf,this.clearPinSelection),t.commandBinder.addBinding(W.wd,this.clickOffPin),t.commandBinder.addBinding(W.gx,this.onUpdatePin),t.commandBinder.addBinding(W.wn,this.onUpdatePinViews),t.commandBinder.addBinding(W.f5,this.onChangePinVisibility),t.commandBinder.addBinding(W.g4,this.onChangePinVisibilityByType),t.commandBinder.addBinding(W.uf,this.onChangePinOpacity),t.commandBinder.addBinding(W.Ct,this.onChangePinOpacityScale),t.commandBinder.addBinding(W.FI,this.onChangePinOpacityByType),t.commandBinder.addBinding(W.Zs,this.onStartPinCreation),t.commandBinder.addBinding(W.z5,this.handleRemovingPin),t.commandBinder.addBinding(W.Ni,this.handleRemovingPinsByType),t.commandBinder.addBinding(W.Mx,this.movePin),t.commandBinder.addBinding(W.HR,this.onTogglePinEditing),this.interactionmodeData.onChanged(this.visibilityChanged),this.floorsViewData.onChanged(this.visibilityChanged),this.viewmodeData.makeModeChangeSubscription(this.visibilityChanged),t.subscribe(f.A,this.visibilityChanged),t.subscribe(T.Y,this.viewmodeChanged),t.subscribe(b.A,this.viewmodeChanged),t.subscribe(Y.oX,this.onPinClicked),this.viewData.onPinEditorStateChanged(this.updateCurrentPin),this.viewData.onSelectedPinChanged(this.updateCurrentPin),this.viewData.onFocusedPinChanged(this.updateCurrentPin),this.viewData.onPinEditableChanged(this.updateCurrentPin),this.cameraData.onChanged(this.onCameraUpdate),p.onPropertyChanged("currentViewId",this.onViewChange)),this.touchDevice||this.bindings.push(t.subscribe(Y.RG,this.onHoverChanged));let A=o.application;this.bindings.push(o.onPropertyChanged("application",(e=>{e!==A&&(this.visibilityChanged(),this.viewData.creatingNewPin?this.cancelPinCreation():(this.changeSelectedPin(null),this.viewData.setFocusedPin(null),this.resetEditingState()),A=e)}))),this.visibilityChanged(),t.market.register(this,D.U,this.viewData)}dispose(e){this.disableEditing(),this.pinEditor.dispose(),this.pinRenderer.dispose(),this.bindings.forEach((e=>{e.cancel()})),this.bindings=[],this.editBindings=[],super.dispose(e)}in360View(){const e=this.sweepData.currentSweep?this.sweepData.currentSweep:"";return this.viewmodeData.isInside()&&this.sweepData.isSweepUnaligned(e)}enableEditing(){if(!this.editActivated){if(this.editActivated=!0,this.pinEditor.toggleEditing(!0),0===this.editBindings.length){const e=this.engine,t=e.commandBinder;this.editBindings.push(t.addBinding(W.yq,this.placePin),t.addBinding(W.hd,this.onCancelNewPin),this.sweepData.makeSweepChangeSubscription(this.handleSweepChange),e.subscribe(b.A,this.handleViewModeChange),e.subscribe(Y.fD,this.onPinPlacementCancelled))}else this.editBindings.forEach((e=>{e.renew()}));this.handleSweepAndViewModeChange()}}disableEditing(){this.editActivated&&(this.editActivated=!1,this.pinEditor.toggleEditing(!1),this.cancelPinCreation(),this.editBindings.forEach((e=>{e.cancel()})))}changeSelectedPin(e){const{selectedPinId:t}=this.viewData;if(((null==e?void 0:e.id)||null)===t)return void this.log.debug("Pin selection did not change");(t?this.viewData.getPin(t):null)&&this.pinRenderer.hideSelectedMesh(),e?(this.saveScreenPosition(e),this.viewData.setSelectedPinId(e.id),this.pinRenderer.showSelectedMesh(e.pinType,e.id)):(this.viewData.setScreenPosition(null),this.viewData.setSelectedPinId(null))}handleSweepAndViewModeChange(){const e=this.viewData,t=!this.in360View();e.creatingNewPin&&!t?this.cancelPinCreation():e.setCanAdd(t)}resetEditingState(){const e=this.viewData;e.setPinEditorState(U.ce.IDLE),e.setEditablePin(!1),e.setCanPlace(!0),e.setCanAdd(!this.in360View())}removePin(e,t){const{focusedPin:i,selectedPinId:n}=this.viewData;n===e&&this.changeSelectedPin(null),(null==i?void 0:i.id)===e&&(null==i?void 0:i.pinType)===t&&this.viewData.setFocusedPin(null),this.viewData.removePin(e),this.pinRenderer.removePin(e)}}const Pe=Ce},66837:(e,t,i)=>{"use strict";i.r(t),i.d(t,{default:()=>m});var n,a=i(23205),s=i(35223),o=i(49191),r=i(48917),d=i(50441),l=i(95226);!function(e){e.None="none",e.Queued="queued",e.Rendering="loading",e.Rendered="loaded"}(n||(n={}));class h{constructor(e){this.panoRenderer=e,this.statusMap={},this.active=[],this.queued=[]}processQueued(){let e=0;for(const t of Object.keys(this.statusMap))this.statusMap[t]===n.Rendering&&e++;if(0===e&&this.queued.length>0){const e=this.queued.shift();if(e){this.active.push(e),this.statusMap[e]=n.Rendering;this.panoRenderer.activateSweep(e,!1).then((()=>{this.statusMap[e]=n.Rendered}))}}}tryPreRender(e){return this.getPreRenderState(e)===n.None&&(this.queued.push(e),this.statusMap[e]=n.Queued,!0)}getPreRenderState(e){const t=this.statusMap[e];return void 0!==t?t:n.None}cleanup(e=[]){const t=(0,l.Z9)(e),i=[];for(const e of this.queued)t[e]?i.push(e):this.statusMap[e]=n.None;this.queued.length=0,this.queued.push(...i);const a=[];for(const e of this.active)t[e]?a.push(e):this.statusMap[e]=n.None;this.active.length=0,this.active.push(...a)}}var c=i(28997);class m extends a.n{constructor(){super(...arguments),this.name="prerenderer-module",this.lastPrerendered=null}async init(e,t){[this.settings,this.sweepData]=await Promise.all([await t.market.waitForData(c.o),await t.market.waitForData(o.A)]),this.panoRenderer=(await t.getModuleBySymbol(s.qD)).getRenderer(),this.preRenderer=new h(this.panoRenderer),this.bindings.push(t.subscribe(r.A,(e=>this.onRestrictSweepsSet(e.sweepIds))),t.subscribe(d.A,(()=>this.onRestrictedSweepsClear())))}enabled(){return this.settings.getOverrideParam("pre",true)}onUpdate(){this.enabled()&&this.preRenderer.processQueued()}getCurrentSweeps(){return this.currentRestrictedSweeps||[]}onRestrictSweepsSet(e){this.enabled()&&(this.lastPrerendered=null,e&&e.length>=3&&(this.lastPrerendered=e[2],this.preRenderer.tryPreRender(this.lastPrerendered)),this.cleanup(this.sweepData),this.currentRestrictedSweeps=e)}onRestrictedSweepsClear(){this.enabled()&&(this.cleanup(this.sweepData,!0),this.currentRestrictedSweeps=null)}cleanup(e,t=!1){const i=[];e.transition.active?(e.transition.from&&i.push(e.transition.from),e.transition.to&&i.push(e.transition.to)):e.currentSweep&&i.push(e.currentSweep),this.lastPrerendered&&i.push(this.lastPrerendered),t&&this.panoRenderer.freeAllTextures(i),this.preRenderer.cleanup(i)}}},34616:(e,t,i)=>{"use strict";i.r(t),i.d(t,{default:()=>v});var n=i(23205),a=i(35223),s=i(94298),o=i(28743),r=i(68909),d=i(1803),l=i(2789),h=i(75650),c=i(42311),m=i(86407);const u=new r.Vector2;class g{constructor(e,t){this.inputIni=e,this.rendererModule=t,this.registrations=new Map,this.hovered=new Map,this.checkPointerLeave=()=>{if(this.hovered.size){const e=y(this.inputIni.getCurrentRayHits());this.hovered.forEach(((t,i)=>{var n,a,s,o,r,d;if(!e.find((e=>e.object===i))){this.hovered.delete(i);const l=Object.assign(Object.assign({},t),{intersections:e});null===(s=null===(n=i.__r3f)||void 0===n?void 0:(a=n.handlers).onPointerOut)||void 0===s||s.call(a,l),null===(d=null===(o=i.__r3f)||void 0===o?void 0:(r=o.handlers).onPointerLeave)||void 0===d||d.call(r,l)}}))}},this.checkPointerMissed=()=>{var e,t,i;const n=new Set(this.inputIni.getCurrentRayHits().map((e=>e.object)));for(const a of this.registrations.keys())n.has(a)||null===(i=null===(e=a.__r3f)||void 0===e?void 0:(t=e.handlers).onPointerMissed)||void 0===i||i.call(t,new MouseEvent("click",this.lastPointerUp.nativeEvent))},this.handlers=[this.initMeshHandlers(),e.registerUnfilteredHandler(h.$3,this.checkPointerLeave),e.registerUnfilteredHandler(c.rX,this.checkPointerMissed),e.registerUnfilteredHandler(h.CD,(e=>{e.down?this.lastPointerDown=e:this.lastPointerUp=e}))]}dispose(){[...this.handlers,...this.registrations.values()].forEach((e=>e.cancel()))}registerObject3D(e){const t=this.registrations.get(e);if(t)return t;const i=(0,d.Sh)((()=>{this.registrations.set(e,i),this.inputIni.registerMesh(e,!1,(t=>function(e){let t=e;for(;t&&!p(t);)t=t.parent;return t}(t)===e))}),(()=>{this.registrations.delete(e),this.hovered.delete(e),this.inputIni.unregisterMesh(e)}),!1);return i.renew(),i}initMeshHandlers(){const e=new WeakMap,t=(t,i,n)=>{var a,s,o,d,l,m,g,v,w,f,b,T;let D=null;for(let e=i;e;e=e.parent)p(e)&&(D||(D=[])).push(e);if(!D)return!1;const C=this.rendererModule.getCamera(),P=new r.Vector2(t.position.x,t.position.y);let A;n||(n=e.get(i)||{});let S=0;if(t instanceof c.rX){const{x:e,y:t}=this.lastPointerDown.clientPosition,{x:i,y:n}=this.lastPointerUp.clientPosition;S=u.set(i-e,n-t).length(),A=new MouseEvent("click",this.lastPointerUp.nativeEvent)}else A=t.nativeEvent;const I=y(this.inputIni.getCurrentRayHits()),k={};for(const e in A)"function"!=typeof A[e]&&(k[e]=A[e]);const N=Object.assign(Object.assign(Object.assign({},k),n),{intersections:I,camera:C,delta:S,eventObject:i,nativeEvent:A,sourceEvent:A,pointer:P,ray:this.inputIni.getCurrentPointerRay(),stopPropagation:()=>{N.stopped=!0,this.handleStopPropagation(N.eventObject,I),t.stopPropagation(),t.preventDefault()},stopped:!1,unprojectedPoint:new r.Vector3(P.x,P.y,0).unproject(C),spaceX:P.x,spaceY:P.y});for(const i of D){e.set(i,n);const r=i.__r3f;if(r&&p(i)&&(N.eventObject=i,t instanceof h.CD?t.down?null===(s=(a=r.handlers).onPointerDown)||void 0===s||s.call(a,N):null===(d=(o=r.handlers).onPointerUp)||void 0===d||d.call(o,N):t instanceof h.$3?(this.hovered.has(i)||(this.hovered.set(i,N),null===(m=(l=r.handlers).onPointerOver)||void 0===m||m.call(l,N),null===(v=(g=r.handlers).onPointerEnter)||void 0===v||v.call(g,N)),null===(f=(w=r.handlers).onPointerMove)||void 0===f||f.call(w,N)):t instanceof c.rX&&(null===(T=(b=r.handlers).onClick)||void 0===T||T.call(b,N)),N.stopped))return!0}return!1},i=[h.CD,h.$3,c.rX];return new l.P(...i.map((e=>this.inputIni.registerMeshHandler(e,m.f.isAny(),t))))}handleStopPropagation(e,t){if(this.hovered.has(e)){const i=t.findIndex((t=>t.object===e));if(i>-1){const e=[];for(let n=i+1;n<t.length;n++)for(let i=t[n].object;i;i=i.parent){const t=this.hovered.get(i);t&&e.push({obj:i,origEvent:t})}e.forEach((({obj:e,origEvent:i})=>{var n,a,s;const o=Object.assign(Object.assign({},i),{intersections:t,eventObject:e});this.hovered.delete(e);const r=null===(n=e.__r3f)||void 0===n?void 0:n.handlers;null===(a=null==r?void 0:r.onPointerOut)||void 0===a||a.call(r,o),null===(s=null==r?void 0:r.onPointerLeave)||void 0===s||s.call(r,o)}))}}}}function p(e){const t=e.__r3f;return!!t&&(t.hasOwnProperty("eventCount")?(t.eventCount||0)>0:t.handlers&&Object.keys(t.handlers).length>0)}function y(e){const t=new Set;return e.filter((e=>{const i=t.has(e.object);return t.add(e.object),!i}))}class v extends n.n{constructor(){super(...arguments),this.name="react-three-fiber-external",this.onPlayerResized=e=>{var t;null===(t=this.externalCallbacks)||void 0===t||t.onSizeChange(e.width,e.height)},this.onPixelRatioChanged=e=>{var t;null===(t=this.externalCallbacks)||void 0===t||t.onPixelRatioChange(e.pixelRatio)}}async init(e,t){this.bindings.push(t.subscribe(s.h,this.onPlayerResized),t.subscribe(o.lo,this.onPixelRatioChanged));const[i,n]=await Promise.all([t.getModuleBySymbol(a.mL),t.getModuleBySymbol(a.M7)]);this.rendererModule=n,this.eventsAdapter=new g(i,n)}dispose(e){this.eventsAdapter.dispose(),super.dispose(e)}onUpdate(e){var t;null===(t=this.externalCallbacks)||void 0===t||t.onFrame()}registerExternalR3F(e){if(this.externalCallbacks)throw new Error("registerExternalR3F called twice");return this.externalCallbacks=e,{renderer:this.rendererModule.threeRenderer,scene:this.rendererModule.getScene().scene,camera:this.rendererModule.getCamera(),registerMeshEvents:e=>this.eventsAdapter.registerObject3D(e)}}}},55415:(e,t,i)=>{"use strict";i.d(t,{l:()=>a});var n=i(18268);class a extends n.u{constructor(e){super(),this.payload={roomAssociation:e}}}a.id="REGISTER_ROOM_ASSOCIATION_SOURCE"},75881:(e,t,i)=>{"use strict";i.r(t),i.d(t,{default:()=>v});var n=i(23205),a=i(80328),s=i(35223),o=i(53366),r=i(23847),d=i(8430),l=i(32785),h=i(69179),c=i(68909),m=i(11116),u=i(48064),g=i(81866),p=i(71136),y=i(82110);class v extends n.n{constructor(){super(...arguments),this.name="screenshots-module",this.capturer=new w}async init(e,t){this.engine=t,[this.settingsModule,this.canvas,this.renderer,this.renderToTexture]=await Promise.all([t.getModuleBySymbol(a.ZF),t.market.waitForData(o.p),t.getModuleBySymbol(s.M7),t.getModuleBySymbol(s.kM)]),this.settingsModule.registerButton("Debug","Take screenshot",(async()=>{const e=Date.now();await this.takeAndDownloadScreenshot({height:this.canvas.height,width:this.canvas.width},`image_${e}.jpg`,r.H.ALL)})),this.settingsModule.registerButton("Debug","Take 4k screenshot",(async()=>{const e=Date.now();await this.takeAndDownloadScreenshot({height:2304,width:4096},`image_${e}.jpg`,r.H.ALL)})),this.settingsModule.registerButton("Debug","Take 8k screenshot",(async()=>{const e=Date.now();await this.takeAndDownloadScreenshot({height:4608,width:8192},`image_${e}.jpg`,r.H.ALL)})),this.settingsModule.registerButton("Debug","Take 16k screenshot",(async()=>{const e=Date.now();await this.takeAndDownloadScreenshot({height:9e3,width:16e3},`image_${e}.jpg`,r.H.ALL)})),this.settingsModule.registerButton("Debug","Take FB 3D screenshot",(async()=>{const e=Date.now(),t=this.engine.getRenderLayer("model-mesh"),i=this.engine.getRenderLayer("skybox"),n=t.clone();n.addLayers(i);const a=(await this.engine.market.waitForData(u.X)).currentMode;try{await this.takeAndDownloadScreenshot({height:this.canvas.height,width:this.canvas.width},`image_${e}.jpg`,n),await this.engine.commandBinder.issueCommand(new h.w(h.w.modes.Depth)),await this.engine.commandBinder.issueCommand(new g.S2(g.w5.MESH,p.fl.Instant)),await this.takeAndDownloadScreenshot({height:Math.floor(this.canvas.height/4),width:Math.floor(this.canvas.width/4)},`image_${e}_depth.jpg`,t)}catch(e){throw this.log.error("Could not take screenshot"),e}finally{await this.engine.commandBinder.issueCommand(new h.w(null)),await this.engine.commandBinder.issueCommand(new g.S2(g.De[a||y.N3.Panorama]))}}))}async takeAndDownloadScreenshot(e,t,i){this.renderTarget||(this.renderTarget=await this.engine.commandBinder.issueCommandWhenBound(new m.q6));const n=await this.capturer.capture(i,e,this.renderer,this.renderToTexture,this.renderTarget);(0,d.x_)((0,l.y)(n),t)}}class w{constructor(){this.captureCamera=new c.PerspectiveCamera}async capture(e,t,i,n,a){const{camera:s,scene:o}=i.getScene();return s.getWorldPosition(this.captureCamera.position),s.getWorldQuaternion(this.captureCamera.quaternion),this.captureCamera.projectionMatrix.copy(s.projectionMatrix),this.captureCamera.layers.mask=e.mask,a.setSize(t.width,t.height),n.render(a.target,o,this.captureCamera),await(0,l.uz)(a)}}},57440:(e,t,i)=>{"use strict";i.d(t,{r:()=>r});var n=i(57682),a=i(87312),s=i(82856);const o=new n.r({});class r{constructor(e,t,i){this.commandBinder=e,this.layersData=t,this.dataTypeGroup=i,this.textParser=o,this.enabled=!0,this.bindings=[]}getLayerType(){var e;const t=this.getLayerGroupId();if(!t)return;const i=null===(e=this.layersData)||void 0===e?void 0:e.getLayer(t);return null==i?void 0:i.layerType}getGroupingId(e){switch(e){case s.Hj.TYPE:return this.getTypeId();case s.Hj.FLOOR:return this.getFloorId();case s.Hj.ROOM:return this.getRoomId();case s.Hj.LAYER:return this.getLayerGroupId();case s.Hj.DATE:return this.dateBucket}}getFloorId(){return this.floorId}getRoomId(){return this.roomId}getDateBucket(){return this.dateBucket}getTypeId(){return this.typeId}supportsBatchDelete(){return!1}supportsLayeredCopyMove(){return!1}getLayerGroupId(){var e,t;const i=null===(e=this.layersData)||void 0===e?void 0:e.getBaseLayerId(),n=null===(t=this.layersData)||void 0===t?void 0:t.getViewLayerId();return this.layerId&&n&&this.layerId===i?n:this.layerId}isLayerVisible(){return!this.layersData||!this.layerId||this.layersData.layerVisible(this.layerId)}onSelect(e,t,i){this.commandBinder.issueCommand(new a.Xx(this.id,this.typeId))}registerBindings(){}cancelBindings(){this.bindings.forEach((e=>e.cancel()))}}},86890:(e,t,i)=>{"use strict";i.d(t,{m:()=>p});var n=i(74848),a=i(99366),s=i(38216),o=i(82856),r=i(13673),d=i(21994),l=i(10718),h=i(44314),c=i(26775);function m({id:e,numItems:t}){const i=(0,l.G)(),a=(0,h._)(e,i);return(0,n.jsx)(c.u,{id:e,title:a,className:"layers-group-header",decals:(0,n.jsx)("span",Object.assign({className:"mp-list-item-text"},{children:`(${t})`}))})}var u=i(38093),g=i(86880);const p=({group:e})=>{const{id:t,items:i,grouping:a}=e;switch(a){case o.Hj.TYPE:return(0,n.jsx)(u.N,{id:t,numItems:i.length});case o.Hj.FLOOR:return(0,n.jsx)(y,{id:t,numItems:i.length});case o.Hj.ROOM:return(0,n.jsx)(v,{id:t,numItems:i.length});case o.Hj.DATE:return(0,n.jsx)(g.v,{id:t,numItems:i.length});case o.Hj.LAYER:return(0,n.jsx)(m,{id:t,numItems:i.length})}};function y({id:e,numItems:t}){const i=(0,r._)();let o=(0,s.Y)().t(a.A.FLOOR_ALL);return i&&e&&(o=i.getFloorName(e)),(0,n.jsx)(c.u,{id:e,title:o,decals:(0,n.jsx)("span",Object.assign({className:"mp-list-item-text"},{children:`(${t})`}))})}function v({id:e,numItems:t}){const i=(0,d.z)(e);return(0,n.jsx)(c.u,{id:e,title:i,decals:(0,n.jsx)("span",Object.assign({className:"mp-list-item-text"},{children:`(${t})`}))})}},70211:(e,t,i)=>{"use strict";i.r(t),i.d(t,{ChangeSearchGroupingCommand:()=>S.xg,ClearSearchFiltersCommand:()=>S._d,DeregisterSearchGroupCommand:()=>S.tf,RegisterSearchGroupCommand:()=>S.Oc,SelectSearchResultCommand:()=>S.Xx,ToggleSearchFilterCommand:()=>S._w,ToggleSearchQueryKeywordCommand:()=>S.$M,UpdateSearchQueryCommand:()=>S.tA,UpdateSearchQueryKeywordsCommand:()=>S.Pb,default:()=>ee});var n=i(23205),a=i(35223),s=i(99366),o=i(74435),r=i(33020),d=i(35596),l=i(28997),h=i(4222),c=i(26956),m=i(521),u=i(9321),g=i(65413),p=i(64536);class y{constructor(e){this.engine=e}async activate(){await this.engine.commandBinder.issueCommandWhenBound(new p.S(!0,!1,!1))}async deactivate(){await this.engine.commandBinder.issueCommandWhenBound(new p.S(!1,!1,!1))}}var v=i(74848),w=i(96540),f=i(40826),b=i(38216),T=i(43802),D=i(57642);const C=(0,T.r)(D.L,"grouping",D.L.defaultGrouping);var P=i(75716),A=i(20487),S=i(87312),I=i(40270),k=i(32513),N=i(66368),E=i(95692),O=i(86890),M=i(32485),x=i.n(M),B=i(91902),V=i(35216),R=i(80898),F=i(37086);const{SEARCH:L}=s.A.SHOWCASE,j=({item:e})=>{const t=(0,b.Y)();if(!e){const e=t.t(L.EMPTY_LIST_MESSAGE);return(0,v.jsx)(N.t,{message:e})}const{dataTypeGroup:i}=e;return(null==i?void 0:i.itemFC)?(0,v.jsx)(i.itemFC,{item:e}):(0,v.jsx)(U,{item:e},e.id)};function U({item:e,className:t}){const i=(0,A.H)(),n=e.id,a=!!i&&n===i,{analytics:s,commandBinder:o}=(0,w.useContext)(f.BR),r=(0,v.jsx)(R.f,{item:e}),d=(0,v.jsx)(F.$,{item:e});return(0,v.jsx)(V.c,{id:n,className:x()("search-result-item",t),title:d,active:a,disabled:!e.enabled,onClick:async()=>{const t="search_item_"+e.typeId.toLowerCase()+"_click";s.track("showcase_gui",{tool:"search",gui_action:t}),o.issueCommand(new u.oe(!0)),await o.issueCommand(new B.mS),e.onSelect()},badge:r||void 0},n)}var H=i(57037),z=i(97300),G=i(32381),$=i(20255);const{SEARCH:_}=s.A.SHOWCASE;function K(){const{commandBinder:e}=(0,w.useContext)(f.BR),t=C(),i=(0,P.W)(),n=(0,A.H)(),a=(0,b.Y)();const s=i.length,o=a.t(_.ITEMS,s),r=a.t(_.EMPTY_LIST_MESSAGE),d=(0,v.jsx)(G.M,{filter:(0,v.jsx)(z.$,{}),filterPills:!0,shareEnabled:!0});return(0,v.jsxs)($.h,Object.assign({toolId:m.S0.SEARCH,className:"search-tool-panel",title:o,subheader:d,subheaderCollapsedHeight:I.on},{children:[(0,v.jsx)(k.H,Object.assign({className:"list-panel-controls"},{children:(0,v.jsx)(E.$,{grouping:t,onGroupBy:function(t){e.issueCommand(new S.xg(t))}})})),(0,v.jsx)("div",Object.assign({className:"panel-list search-panel-list"},{children:0===s?(0,v.jsx)(N.t,{message:r}):(0,v.jsx)(H.x,{renderGroup:O.m,renderItem:j,activeItemId:n,grouping:t,excludeEmptyGroups:!0})}))]}))}var X=i(5929);class W{constructor(){this.renderPanel=()=>(0,v.jsx)(K,{}),this.renderOverlay=()=>(0,v.jsx)(X.P,{})}}function Y(...e){return!0}function q(...e){return!1}class Q{constructor(e){this.searchData=e,this.subscriptions=[],this.isSearchingGroup=e=>{const t=this.searchData.searchMode;return!0===t||t===e},this.onFiltersChanged=()=>{this.updateAvailableKeywords(),this.clearUnavailableKeywordFilters(),this.searchData.getSearchDataTypeList().forEach(this.updateMatches),this.updateResults()},this.updateAvailableKeywords=()=>{const e=this.getActiveSearchDataTypeList().reduce(((e,{getKeywords:t})=>{if(t){t().forEach((t=>{e[t]?e[t]++:e[t]=1}))}return e}),{});this.searchData.setKeywordCounts(e)},this.updateMatches=e=>{const{id:t,getSimpleMatches:i}=e,n=this.searchData.getTypeFilters(),a=this.searchData.getQuery(),s=0===n.length||n.includes(t)?function(e){if(!e)return Y;const t=e.toLowerCase();return(...e)=>function(e,...t){return t.some((t=>t.toLowerCase().includes(e)))}(t,...e)}(a):q,o=this.searchData.getKeywordFilters();e.matches=i(s,e,a,o)},this.activationChanged=e=>{e?this.updateAllMatchesAndResults():this.searchData.getSearchDataTypeList().forEach(this.revealItems)},this.revealItems=e=>{e.getSimpleMatches(Y,e,"",[])},this.updateAllMatchesAndResults=(0,o.s)((()=>{this.updateAvailableKeywords(),this.searchData.getSearchDataTypeList().forEach(this.updateMatches),this.updateResults()}),200),this.subscriptions.push(e.onPropertyChanged("query",this.updateAllMatchesAndResults),e.onPropertyChanged("keywordFilters",this.updateAllMatchesAndResults),e.onPropertyChanged("searchMode",this.activationChanged),e.typeFilters.onChanged(this.onFiltersChanged))}dispose(){const e=e=>e.cancel();this.subscriptions.forEach(e),this.searchData.getSearchDataTypeList().forEach((t=>t.subscriptions.forEach(e)))}registerSearchGroup(e,t,i){const n=()=>{this.updateMatches(e),this.updateResults(),this.updateAvailableKeywords()};let a=!1,s=!1;const r=(0,o.s)((()=>{s?(n(),a=!1):a=!0}),200);t&&e.subscriptions.push(t(r));const d=t=>{const n=s;s=this.isSearchingGroup(e.id),i&&n!==s&&i(s&&t),s&&a&&r()};e.subscriptions.push(this.searchData.onPropertyChanged("searchMode",d)),d(this.searchData.searchMode)}deregisterSearchGroup(e){e.subscriptions.forEach((e=>e.cancel())),this.updateResults()}clearUnavailableKeywordFilters(){const e=this.searchData.getTypeFilters().length>0,t=this.getActiveSearchDataTypeList().find((e=>!!e.getKeywords));e&&!t&&this.searchData.setKeywordFilters([])}getActiveSearchDataTypeList(){const e=this.searchData.typeFilters;return this.searchData.getSearchDataTypeList().filter((t=>0===e.length||e.includes(t.id)))}updateResults(){const e=this.searchData.getSearchDataTypeList().reduce(((e,t)=>(e.push(...t.matches),e)),[]);this.searchData.setResults(e)}}const{TOOLS:J}=s.A;class Z extends n.n{constructor(){super(...arguments),this.name="search",this.searchData=new D.L,this.deactivateTimeout=0,this.hasStartedTrackingQueries=!1,this.onApplicationChange=async()=>{this.updateFeatureEnablement()},this.registerSearchGroup=async e=>{const{id:t,groupPhraseKey:i,groupMatchingPhraseKey:n,getSimpleMatches:a,getKeywords:s,groupOrder:o,groupIcon:r,registerChangeObserver:d,onSearchActivatedChanged:l,itemFC:h,itemActionsFC:c,groupActionsFC:m,batchSupported:u=!1}=e;if(this.searchData.dataTypeGroups[t])return void this.log.debug("Search group already registered");const g={id:t,groupPhraseKey:i,groupMatchingPhraseKey:n,getSimpleMatches:a,getKeywords:s,groupOrder:o,groupIcon:r,matches:[],subscriptions:[],itemFC:h,itemActionsFC:c,groupActionsFC:m,batchSupported:u};this.searchData.dataTypeGroups[t]=g,this.searchResultsUpdater.registerSearchGroup(g,d,l)},this.deregisterSearchGroup=async e=>{const{id:t}=e,i=this.searchData.dataTypeGroups[t];i?(delete this.searchData.dataTypeGroups[t],this.searchResultsUpdater.deregisterSearchGroup(i)):this.log.debug("Search group not found to deregister")},this.updateQuery=async e=>{this.searchData.setQuery(e.query),this.searchData.commit()},this.updateQueryKeywords=async e=>{this.searchData.setKeywordFilters(e.keywords)},this.toggleQueryKeyword=async({keywordId:e})=>{const t=[...this.searchData.getKeywordFilters()];t.includes(e)?t.splice(t.indexOf(e),1):t.push(e),this.searchData.setKeywordFilters(t)},this.selectSearchResult=async e=>{const{id:t,typeId:i}=e,{activeItemId:n,selectedType:a}=this.searchData;t===n&&i===a||(this.searchData.activeItemId=t,this.searchData.selectedType=t&&i||null,this.searchData.commit())},this.changeGrouping=async e=>{this.searchData.grouping=e.grouping,this.searchData.commit()},this.toggleSearchFilter=async e=>{const{groupId:t,enabled:i}=e;this.searchData.toggleSearchFilter(t,i);this.searchData.getTypeFilters().length===Object.keys(this.searchData.dataTypeGroups).length&&this.searchData.clearTypeFilters()},this.onToolChanged=()=>{const e=this.toolsData.getActiveTool(),t=null==e?void 0:e.searchModeType;if(window.clearTimeout(this.deactivateTimeout),t){const e="string"==typeof t?t:void 0;this.activateSearchMode(e),e?this.searchData.setTypeFilter(e):this.searchData.clearTypeFilters()}else this.deactivateSearchMode()},this.trackQuery=(0,o.s)((()=>{const e=this.searchData.query.substring(0,1e3),t=this.searchData.getKeywordFilters().map((e=>e.trim())).sort().join(",");if(!e&&!t)return;const i=!this.hasStartedTrackingQueries&&e===this.config.urlQuery;this.analytics.track("space_search_queried",{query:e,queryKeywords:t,submittedByUrlParam:i}),this.hasStartedTrackingQueries=!0}),1e3)}async init(e,t){if(this.config=e,this.engine=t,[this.toolsData,this.appData,this.settingsData,this.analytics]=await Promise.all([t.market.waitForData(c.M),t.market.waitForData(d.zH),t.market.waitForData(l.o),t.getModuleBySymbol(a.aF)]),this.searchResultsUpdater=new Q(this.searchData),this.bindings.push(t.subscribe(r.E5,this.onApplicationChange),this.searchData.onPropertyChanged("query",this.trackQuery),this.searchData.onPropertyChanged("keywordFilters",this.trackQuery),this.toolsData.onPropertyChanged("activeToolName",this.onToolChanged),t.commandBinder.addBinding(S.tA,this.updateQuery),t.commandBinder.addBinding(S.Pb,this.updateQueryKeywords),t.commandBinder.addBinding(S.$M,this.toggleQueryKeyword),t.commandBinder.addBinding(S.xg,this.changeGrouping),t.commandBinder.addBinding(S._w,this.toggleSearchFilter),t.commandBinder.addBinding(S._d,(async()=>this.searchData.clearTypeFilters())),t.commandBinder.addBinding(S.Xx,this.selectSearchResult),t.commandBinder.addBinding(S.Oc,this.registerSearchGroup),t.commandBinder.addBinding(S.tf,this.deregisterSearchGroup)),this.updateFeatureEnablement(),(0,h.W)(this.settingsData)&&(void 0!==e.urlQuery||void 0!==e.urlQueryKeywords||void 0!==e.urlQueryFilters)){const t=decodeURIComponent(e.urlQuery||"");this.searchData.setQuery(t),this.searchData.commit();const i=decodeURIComponent(e.urlQueryFilters||"").trim(),n=i?i.split(","):[];n.length>0&&this.searchData.setTypeFilters(n);const a=decodeURIComponent(e.urlQueryKeywords||"").trim(),s=a?a.split(","):[];s.length>0&&this.searchData.setKeywordFilters(s);const o=this.toolsData.getTool(m.S0.LAYERS)?m.S0.LAYERS:m.S0.SEARCH;this.engine.commandBinder.issueCommand(new u.yU(o,!0))}t.market.register(this,D.L,this.searchData)}dispose(e){super.dispose(e),window.clearTimeout(this.deactivateTimeout),this.searchResultsUpdater&&this.searchResultsUpdater.dispose()}updateFeatureEnablement(){if(!(this.appData.application===d.lg.WORKSHOP)&&(0,h.W)(this.settingsData)&&!this.toolsData.getTool(m.S0.SEARCH)){const e=new g.N({id:m.S0.SEARCH,searchModeType:!0,namePhraseKey:J.SEARCH,panel:!0,panelLeft:!0,icon:"icon-magnifying-glass",analytic:"search",dimmed:!1,enabled:!0,hidesAppBar:!0,order:1,ui:new W,manager:new y(this.engine)});this.engine.commandBinder.issueCommand(new u.Kw([e]))}}activateSearchMode(e){const t=e||!0;this.searchData.searchMode!==t&&(this.searchData.searchMode=t,this.searchData.commit())}deactivateSearchMode(){this.searchData.searchMode&&(this.searchData.setKeywordFilters([]),this.searchData.searchMode=!1,this.searchData.activeItemId=null,this.searchData.commit(),this.deactivateTimeout=window.setTimeout((()=>{this.searchData.clearTypeFilters()}),300))}}const ee=Z},75457:(e,t,i)=>{"use strict";i.r(t),i.d(t,{default:()=>X});var n,a=i(23205),s=i(35223),o=i(23847),r=i(49191),d=i(45018),l=i(82110),h=i(48064),c=i(11116),m=i(32785),u=i(61543),g=i(26693),p=i(34144),y=i(75673),v=i(48071),w=i(90280),f=i(95226),b=i(50281),T=i(19533),D=i(41733),C=i(98925),P=i(32361),A=i(92590),S=i(8371),I=i(1902),k=i(50593);!function(e){e.CAPTURING="capturing",e.UPLOADING="uploading",e.ERROR="error",e.DONE="done"}(n||(n={}));var N=i(13539),E=i(4143),O=i(26956),M=i(521),x=i(28997),B=i(99817),V=i(61334),R=i(33848),F=i(53593),L=i(84229);class j extends L.t{constructor(e,t="72002"){super(e,t),this.name="SnapshotCaptureError"}}class U extends L.t{constructor(e,t="73002"){super(e,t),this.name="SnapshotUploadError"}}class H extends L.t{constructor(e,t="74002"){super(e,t),this.name="SnapshotEncodingError"}}var z=i(9419);const G=i.p+"images/ai-watermark-512.svg";var $=i(12165);const _=p.W0.uploadIntervalDelay,K=!!new URLSearchParams(window.location.search).get("snapshotRoomNames");class X extends a.n{constructor(){super(...arguments),this.name="snapshots-editor",this.peekabooActive=!1}async init(e,t){this.engine=t,[this.renderer,this.sweepRenderer,this.rtt]=await Promise.all([t.getModuleBySymbol(s.M7),t.getModuleBySymbol(s.qD),t.getModuleBySymbol(s.kM)]),[this.sweepData,this.viewmodeData,this.cameraData,this.floorsViewData,this.layersData]=await Promise.all([t.market.waitForData(r.A),t.market.waitForData(h.X),t.market.waitForData(d.M),t.market.waitForData(A.X),t.market.waitForData(V.P),t.market.waitForData(C.O)]),t.market.waitForData($.A).then((e=>this.roomBoundData=e)),[this.snapshotTarget,this.snapshotOverlayTarget]=await Promise.all([t.commandBinder.issueCommandWhenBound(new c.q6),t.commandBinder.issueCommandWhenBound(new c.q6)]);const[i,n]=await Promise.all([t.market.waitForData(O.M),t.market.waitForData(x.o)]);this.peekabooActive=n.tryGetProperty(B.gT,!1),this.bindings.push(i.onPropertyChanged("activeToolName",this.onToolChanged.bind(this)),t.commandBinder.addBinding(z.Y,this.onCaptureSnapshotCommand.bind(this)),t.commandBinder.addBinding(z.E,this.onCaptureEquirectCommand.bind(this)))}onToolChanged(e){this.sweepRenderer.setPreloadQuality(e===M.S0.PHOTOS||e===M.S0.START_LOCATION?this.sweepRenderer.enum.resolution.ULTRAHIGH:null)}async onCaptureEquirectCommand(e){const t=e.onProgress||(0,D.p)(0);t.value=10,this.engine.commandBinder.issueCommand(new I.Jq),await(0,f.cb)(50);const i=this.sweepData.currentSweepObject;if(!i)throw new j("Equirectangular capture is only supported in Panorama mode");const n=this.queryIdealEqResolution();this.snapshotTarget.setSize(n.width,n.height);const a=v.B1.FORWARD.clone().applyQuaternion(i.rotation).setY(0),s=v.B1.FORWARD.clone().applyQuaternion(this.cameraData.pose.rotation).setY(0),o=(0,w.Vg)(a,s)+Math.PI;await this.fetchHighestAvailable(!0,u.MF.ULTRAHIGH,(e=>t.value=Math.max(10,e))),await this.takeEquirectangular(o),await this.sweepRenderer.resetSweep(i.id),this.engine.commandBinder.issueCommand(new I.sD);const r=(0,m._h)(this.snapshotTarget.width,this.snapshotTarget.height,o,0),d=this.uploadAndAddSnapshot(P.X.PANORAMA,r).then((e=>e&&e.sid)).catch((e=>{throw this.log.error(e),this.engine.broadcast(new F.G(e)),e}));return e.waitForUpload?d:null}async onCaptureSnapshotCommand(e){const t=e.onProgress||(0,D.p)(0);t.value=10,this.engine.commandBinder.issueCommand(new I.Jq),this.engine.commandBinder.issueCommand(new E.x);const i=this.queryIdealResolution(e.maxSize,e.aspect);this.snapshotTarget.setSize(i.width,i.height),this.snapshotOverlayTarget.setSize(i.width,i.height),await this.fetchHighestAvailable(!1,e.maxSize,(e=>t.value=Math.max(10,e))),await(0,f.cb)(2*_),await this.takeScreenshot();const n=this.sweepData.currentSweepObject;n&&this.viewmodeData.currentMode===l.N3.Panorama&&await this.sweepRenderer.resetSweep(n.id),this.engine.commandBinder.issueCommand(new I.sD),this.engine.commandBinder.issueCommand(new E._);let a=e.category;n&&(n.alignmentType===S.c$.UNALIGNED||n.placementType===S.EO.MANUAL)&&a===P.X.USER&&(a=P.X.UNALIGNED);const s=this.uploadAndAddSnapshot(a).then((e=>e&&e.sid)).catch((e=>{throw this.log.error(e),this.engine.broadcast(new F.G(e)),e}));return e.waitForUpload?s:null}async uploadAndAddSnapshot(e,t){const i=this.createSnapshot(e);i.state=n.CAPTURING;try{const e=await(0,m.uz)(this.snapshotTarget,t);i.imageBlob=(0,m.y)(e)}catch(e){throw i.state=n.ERROR,this.log.error(e),new H(e)}i.state=n.UPLOADING;try{const e=await this.engine.commandBinder.issueCommand(new N.Ns(i));if(!e)throw i.state=n.ERROR,this.log.error("Exception during snapshot upload"),new U("Exception during snapshot upload");return i.state=n.DONE,e}catch(e){throw i.state=n.ERROR,this.log.error(e),new U(e)}}createSnapshot(e){const t=this.viewmodeData.isInside(),i=this.floorsViewData.currentFloorId,{position:n,viewmode:a}=(0,b.nF)(this.cameraData,this.floorsViewData,this.viewmodeData,this.peekabooActive);let s=(0,f.Rt)(new Date);if(K&&this.roomBoundData&&t&&i){const e=this.roomBoundData.findRoomIdForPosition(n,i),t=e?this.roomBoundData.getRoomLabel(e,""):"";t&&(s=`${s}_${t}`)}const o=new k.F;return(0,R.AF)(this.layersData.getCurrentView())&&(s+="_defurnished",o.sourceViewId=this.layersData.getCurrentView().id),o.name=s,o.category=e,o.is360=t&&!this.sweepData.currentAlignedSweepObject,o.metadata={cameraMode:a,cameraPosition:n,cameraQuaternion:this.cameraData.pose.rotation.clone(),orthoZoom:a===l.N3.Floorplan?this.cameraData.zoom():-1,ssZoom:this.cameraData.zoom(),scanId:this.sweepData.currentSweep&&t?this.sweepData.getSweep(this.sweepData.currentSweep).platformId:void 0,floorId:i,floorVisibility:this.floorsViewData.getFloorsVisibility()},o}queryIdealResolution(e=u.MF.ULTRAHIGH,t){var i,n;const a=1/Math.max(t,Number.EPSILON);let s=3840,o=s*a;const r=this.renderer.maxTextureSize;if(s>r&&(this.log.warn(`The active gl context does not support 4k x 2k equirectangular capture\nCapture is limited to a max size of ${r}`),s=r,o=s*a),this.viewmodeData.currentMode===l.N3.Panorama){const a=null!==(n=null===(i=this.sweepData.currentSweepObject)||void 0===i?void 0:i.availableResolution(e))&&void 0!==n?n:u.MF.STANDARD,d=g.A.getPanoSize(a)*(this.cameraData.fovY()*y.tm)/90;s=Math.min(Math.round(d*t),r),o=Math.round(s/t)}return{width:s,height:o}}queryIdealEqResolution(){let e=8192,t=.5*e;const i=this.renderer.maxTextureSize;return e>i&&this.log.warn(`The active gl context does not support 4k x 2k equirectangular capture\nCapture is limited to a max size of ${i}`),e=Math.min(i,e),t=.5*e,{width:e,height:t}}fetchHighestAvailable(e,t=u.MF.ULTRAHIGH,i){const n=this.sweepData.currentSweepObject;if(n&&this.viewmodeData.currentMode===l.N3.Panorama){const a=e?this.sweepRenderer.enum.queueStyle.FullPanorama:this.sweepRenderer.enum.queueStyle.CurrentView,s=i?e=>i(e*X.captureProgressFudgeFactor):void 0;return this.sweepRenderer.requestResolution({sweepId:n.id,resolution:t,queueType:a,quickly:!0,onProgress:s}).promise}return i&&i(X.captureProgressFudgeFactor),Promise.resolve()}async takeScreenshot(){const e=o.H.ALL;e.removeLayers(this.engine.getRenderLayer("grid-underlay")),e.removeLayers(this.engine.getRenderLayer("cursor-mesh")),e.removeLayers(this.engine.getRenderLayer("current-pano-marker"));const t=this.renderer.getScene().scene,i=this.renderer.getScene().camera,n=i.layers.mask;i.layers.mask=e.mask,this.rtt.render(this.snapshotTarget.target,t,i,void 0,!0),(0,R.AF)(this.layersData.getCurrentView())&&(this.watermarkTexture||(this.watermarkTexture=await(0,T.S)(G)),this.rtt.compose(this.snapshotTarget.target,this.watermarkTexture,{sourceMask:this.watermarkTexture,sourceResize:!1,sourceScale:.5})),i.layers.mask=n}async takeEquirectangular(e){const t=this.sweepData.currentSweep;if(t){const i=this.sweepRenderer.getRenderer(),n=i.useTexture(t),a=this.engine.commandBinder.issueCommand(new c.cl(this.snapshotTarget,n,e));await a,i.freeTexture(t)}}}X.captureProgressFudgeFactor=90},26693:(e,t,i)=>{"use strict";i.d(t,{A:()=>o});var n,a=i(61543),s=i(34144);!function(e){e[e.Untested=0]="Untested",e[e.Testing=1]="Testing",e[e.Success=2]="Success",e[e.Fail=3]="Fail"}(n||(n={}));class o{constructor(e,t,i,n){this.maxCubemapSize=e,this.maxNavPanoSize=t,this.maxZoomPanoSize=i,this.overrideWindow=!1,this.navPanoSize=a.c5.STANDARD,this.zoomPanoSize=a.c5.STANDARD,this.defaultMaxNavPanoSize=this.maxNavPanoSize,this.resolution=n,this.highQualityThreshold=s.W0.windowHeightHighQualityThresholdOverride||s.W0.windowHeightHighQualityThreshold,this.updateMaximums()}update({height:e,fov:t}){this.resolution=e,this.updateMaximums()}overrideWindowMaximums(e){this.overrideWindow=e,this.updateMaximums()}overrideNavPanoSize(e){this.maxNavPanoSize=null!=e?e:this.defaultMaxNavPanoSize,this.updateMaximums()}updateMaximums(){this.resolution<this.highQualityThreshold&&!this.overrideWindow?(this.navPanoSize=Math.min(o.getPanoSize(a.MF.STANDARD),this.maxNavPanoSize),this.zoomPanoSize=Math.min(o.getPanoSize(a.MF.HIGH),this.maxZoomPanoSize)):(this.navPanoSize=this.maxNavPanoSize,this.zoomPanoSize=this.maxZoomPanoSize),this.zoomPanoSize<this.navPanoSize&&(this.navPanoSize=this.zoomPanoSize),this.zoomPanoSize=Math.min(this.maxCubemapSize,this.zoomPanoSize),this.navPanoSize=Math.min(this.maxCubemapSize,this.navPanoSize)}static getPanoSize(e){if(e in a.oY)return a.oY[e];throw new Error(`Not a panoSizeClass: ${e}`)}static getPanoSizeClass(e){if(e in a.Mo)return a.Mo[e];throw new Error(`Not a valid pano resolution: ${e}`)}getNavPanoSize(){return this.navPanoSize}getZoomPanoSize(){return this.zoomPanoSize}}},50441:(e,t,i)=>{"use strict";i.d(t,{A:()=>a});var n=i(14754);class a extends n.QB{constructor(){super()}}},48917:(e,t,i)=>{"use strict";i.d(t,{A:()=>a});var n=i(14754);class a extends n.QB{constructor(e){super(),this.sweepIds=e}}},6665:(e,t,i)=>{"use strict";i.r(t),i.d(t,{default:()=>h});var n=i(68909),a=i(23205),s=i(59957),o=i(35223),r=i(48917),d=i(50441);const l=Object.freeze({sweeps:{maxNeighborDistance:50}});class h extends a.n{constructor(e,t){super(),this.distanceMap={},this.name="sweep-path",this.getDistance=(()=>{const e=new n.Vector3(0,0,0);return(t,i)=>{var n;const a=this.distanceMap[t],s=this.distanceMap[i];a||(this.distanceMap[t]={}),s||(this.distanceMap[i]={});let o=null!==(n=this.distanceMap[t][i])&&void 0!==n?n:this.distanceMap[i][t];if(void 0!==o)return o;const r=this.getSweep(t),d=this.getSweep(i);e.copy(r.position).sub(d.position);let l=Math.max(0,Math.abs(e.y)-.2),h=Math.sqrt(e.x*e.x+e.z*e.z);return l>0?(l=Math.pow(4*l,2),h=Math.pow(h,2),o=Math.sqrt(l*l+h*h)):o=e.length(),r.sourceViewId!==d.sourceViewId&&(o*=1.5),this.distanceMap[t][i]=o,this.distanceMap[i][t]=o,o}})(),this.validNeighbors={},this.distanceMap={},this.maxNeighborDistance=l.sweeps.maxNeighborDistance,t&&(this.engine=t),e&&(this.sweepDataModule=e),this.getValidNeighbors=this.getValidNeighbors.bind(this),this.findShortestPath=this.findShortestPath.bind(this),this.addSweepsNearPath=this.addSweepsNearPath.bind(this)}async init(e,t){this.engine=t,this.sweepDataModule||(this.sweepDataModule=await t.getModuleBySymbol(o.Wh)),void 0!==e.maxNeighborDistance&&(this.maxNeighborDistance=e.maxNeighborDistance)}setRestrictedSweeps(e,t=0){if(this.restrictedSweeps=[],e){for(let i=t;i<e.length;i++)this.restrictedSweeps.push(e[i].id);this.engine.broadcast(new r.A(this.restrictedSweeps))}else this.restrictedSweeps=void 0,this.engine.broadcast(new d.A)}findShortestPath(e,t,i,n,a,o=5e3){const r=this.getSweep(e),d=this.getSweep(t);if(!r||!d)return null;const l=this,h=(0,s.G)({start:r,isEnd:e=>e.platformId===d.platformId,*neighbors(e){for(const t of e.neighbours)yield l.getSweep(t)},distance:(e,t)=>l.getDistance(e.id,t.id),heuristic:(e,t)=>1,timeout:o});return h.status===s.E.Success&&h.path.length<a?(this.addSweepsNearPath(h.path,i),this.filterCloseSweepsFromPath(h.path,n)):null}addSweepsNearPath(e,t){const i=new n.Vector3,a=new n.Vector3,s=new n.Vector3,o=new n.Vector3,r=new n.Vector3,d=new n.Vector3,l=[],h=new n.Vector3,c=(e,t,i)=>(s.copy(t).sub(e),s.dot(i)),m=(e,t)=>c(h,e.position,i)-c(h,t.position,i);let u=0;for(;u<e.length-1;){const n=e[u].id,c=e[u+1].id,g=this.getSweep(n),p=this.getSweep(c);h.copy(g.position),l.length=0,i.copy(p.position).sub(h).normalize();const y=this.findConnectedSweeps(g,this.maxNeighborDistance),v=this.findConnectedSweeps(p,this.maxNeighborDistance),w=y.concat(v);for(const e of w){const n=s.copy(e.position).sub(h).dot(i);if(n>0){r.copy(i),r.multiplyScalar(n),o.copy(s),o.sub(r);if(o.length()<t){a.copy(i).negate(),d.copy(e.position).sub(p.position);d.dot(a)>0&&l.push(e)}}}if(l.length>0){l.sort(m);for(let t=e.length+l.length-1;t>=u+l.length;t--)e[t]=e[t-l.length];for(let t=0;t<l.length;t++)e[t+u+1]=l[t]}u+=l.length+1}}findConnectedSweeps(e,t,i=2){const n=[];return this._findConnectedSweeps(e,e,t,n,{},i,0),n}_findConnectedSweeps(e,t,i,n,a,s,o){const r=this.getValidNeighbors(e.id);for(const e of r)if(!a[e.id]){e.position.distanceTo(t.position)<i&&(n.push(e),a[e.id]=!0,o<s&&this._findConnectedSweeps(e,t,i,n,a,s,o+1))}}getValidNeighbors(e){let t=this.validNeighbors[e];if(!t){t=[],this.validNeighbors[e]=t;const i=this.getSweep(e);if(!i)throw new Error(`sweep not found! ${e}`);const n=i.neighbours;for(const i of n){const n=this.getSweep(i);if(!n)continue;if(!n.enabled)continue;this.getDistance(e,i)>this.maxNeighborDistance||t.push(n)}}return t}filterCloseSweepsFromPath(e,t){const i=[];let n=null,a=!1;for(const s of e)a=n&&s.position.distanceTo(n.position)<t||!1,n&&a||(i.push(s),n=s);return i.length<2?e:(a&&e.length>1&&(i[i.length-1]=e[e.length-1]),i)}getCurveForPath(e){let t=0;const i=[0];for(let n=1;n<e.length;n++)t+=e[n-1].distanceTo(e[n]),i.push(t);const a=[0];for(let n=1;n<e.length;n++)a.push(i[n]/t);const s=new n.CatmullRomCurve3(e,!1);return{curve:new n.CatmullRomCurve3(s.getSpacedPoints(2*t).concat(e[e.length-1])),totalLength:t,sourceDistances:i,normalSourceDistances:a}}getSweep(e){return this.sweepDataModule.data.getSweep(e)||this.sweepDataModule.getSweepOnView(e)}}},40943:(e,t,i)=>{"use strict";i.r(t),i.d(t,{default:()=>N});var n=i(23205),a=i(35223),s=i(68909),o=i(67902),r=i(77010),d=i(61543),l=i(88696),h=i(2785),c=i(35652),m=i(58421),u=i(86407);const g=new c.Ay("pin-mesh"),p=e=>(0,l.OX)()(e)&&(0,l.GS)(e);class y{constructor(e,t,i,n,a,o){this.sweepViewData=e,this.scene=t,this.sweepTextureLoader=i,this.input=n,this.layer=o,this.container=new s.Object3D,this.bindings=[],this.visibilityFilter=()=>!0,this.hoverSweep=(e,t)=>{this.issueCommand(new m.WW(e,t,0));const i=this.sweepViewData.selectedSweep===e;this.highlightPin(e,t||i)},this.meshes=[],this.meshToDataMap={},this.dataToMeshMap={},this.cameraData=a;const d=e.data.getCollection(),l=({added:e,updated:t,removed:i})=>{if(e)for(const[,t]of e)p(t)&&this.createPinMesh(t,this.cameraData);if(t)for(const[e,i]of t){const t=this.sweepViewData.getIndexByAlignment(!1,e);p(i)?(this.dataToMeshMap[e]||(this.createPinMesh(i,this.cameraData),this.engine.broadcast(new r.k(e,t,!0))),this.updatePinMeshPosition(e,i.position)):this.dataToMeshMap[e]&&(this.removePinMesh(i),this.engine.broadcast(new r.k(e,t,!1)))}if(i)for(const[,e]of i)this.removePinMesh(e)};this.bindings.push(d.onElementsChanged(l)),l({added:d.entries()})}updatePinMeshPosition(e,t){this.mapSweepToMesh(e).updatePosition(t)}mapSweepToMesh(e){return this.dataToMeshMap[e]}mapColliderToSweep(e){const t=e.hasOwnProperty("collider")?e:e.parent;if(t){const e=this.meshToDataMap[t.id];if(e)return e.sweep}return null}filter(e){this.visibilityFilter=e;for(const e of this.meshes)this.filterMesh(e)}init(){}dispose(){for(const e in this.meshToDataMap){const t=this.meshToDataMap[e];this.removePinMesh(t.sweep)}}render(e){for(const t of this.meshes)t.render(e)}activate(e){this.engine=e,this.issueCommand=e.commandBinder.issueCommand.bind(e.commandBinder),this.bindings.push(this.input.registerMeshHandler(h.L,u.f.isType(o.im),((e,t)=>this.onHoverEvent(t,!0)))),this.bindings.push(this.input.registerMeshHandler(h.q,u.f.isType(o.im),((e,t)=>this.onHoverEvent(t,!1)))),this.scene.add(this.container)}deactivate(e){for(const e of this.bindings)e.cancel();this.bindings.length=0,this.scene.remove(this.container)}getMeshes(){return this.meshToDataMap}highlightPin(e,t,i=!1){this.dataToMeshMap[e]&&(t&&i&&Object.entries(this.dataToMeshMap).forEach((([t,i])=>{t!==e&&i.unhover()})),this.dataToMeshMap[e].setPinHover(t?1:0,!1))}lockSelection(e,t){return t&&(this.engine.broadcast(new r.N(e.id,!0)),this.hoverSweep(e.id,!0)),!0}createPinMesh(e,t){const i=new o.jd(e.position,null,t,this.layer);this.meshes.push(i),this.dataToMeshMap[e.id]=i,this.meshToDataMap[i.id]={id:i.id,sweep:e},this.container.add(i),this.filterMesh(i),this.sweepTextureLoader.loadFace(e,d.MF.BASE,1,{flipY:!0}).then((e=>{i.material.uniforms.tPinHole.value=e})).catch((t=>{g.error(`${e.id} failed to load texture: ${t}`)}))}removePinMesh(e){const t=this.dataToMeshMap[e.id];if(!t)return;const i=this.meshes.findIndex((e=>e.id===t.id));this.meshes.splice(i,1),this.container.remove(t),this.deactivateMesh(t),delete this.meshToDataMap[t.id],delete this.dataToMeshMap[e.id],t.dispose()}filterMesh(e){const t=this.meshToDataMap[e.id];if(t){const i=t.sweep;this.visibilityFilter(i)?this.activateMesh(e):this.deactivateMesh(e)}}onHoverEvent(e,t){const i=this.mapColliderToSweep(e);i&&this.hoverSweep(i.id,t)}activateMesh(e){this.input.registerMesh(e.collider,!1),e.activate()}deactivateMesh(e){this.input.unregisterMesh(e.collider);const t=this.meshToDataMap[e.id];t&&e.isActive()&&(this.hoverSweep(t.sweep.id,!1),e.deactivate())}}y.MENU_CLEAR_DEBOUNCE=100;var v=i(67408),w=i(35596),f=i(45018),b=i(48064),T=i(28997),D=i(82110),C=i(92590),P=i(92812),A=i(23310),S=i(10995),I=i(12837),k=i(54839);class N extends n.n{constructor(){super(...arguments),this.name="sweep-pin-mesh",this.onChange=()=>{const e=this.sweepViewData,t=e.selectedSweep,i=e.toolState===A.j.ROTATING||e.toolState===A.j.ROTATED;this.pinRenderer.filter((e=>{if(!this.settingsData.tryGetProperty(k.s,!0))return!1;if(i&&t===e.id)return!1;if(this.viewmodeData.transition.active&&(0,D.nI)(this.viewmodeData.transition.to))return!1;const n=!this.nextFloor||this.nextFloor===e.floorId||!e.floorId,a=this.config.showPinsInFloorplanDollhouse||this.applicationData.application===w.lg.WORKSHOP,s=this.viewmodeData.closestMode===D.N3.Dollhouse||this.viewmodeData.closestMode===D.N3.Floorplan;return n&&s&&a}))},this.onSelectedPinChange=()=>{const e=this.sweepViewData.selectedSweep;e&&(this.engine.commandBinder.issueCommand(new m.S2(e,!0,0)),this.pinRenderer.highlightPin(e,!0,!0))}}async init(e,t){var i;[this.webglRenderer,this.input,this.sweepViewData,this.cameraData,this.settingsData,this.viewmodeData,this.floorsViewData,this.applicationData]=await Promise.all([t.getModuleBySymbol(a.M7),t.getModuleBySymbol(a.mL),t.market.waitForData(P.O),t.market.waitForData(f.M),t.market.waitForData(T.o),t.market.waitForData(b.X),t.market.waitForData(C.X),t.market.waitForData(w.zH)]);const n=await t.getModuleBySymbol(a.wY),s=t.claimRenderLayer(this.name),o=this.webglRenderer.getScene().scene;this.config={showPinsInFloorplanDollhouse:null===(i=e&&e.showPinsInFloorplanDollhouse)||void 0===i||i},this.engine=t,this.pinRenderer=new y(this.sweepViewData,o,n,this.input,this.cameraData,s),t.addComponent(this,this.pinRenderer),this.bindings.push(this.applicationData.onPropertyChanged("application",this.onChange),this.settingsData.onPropertyChanged(k.s,this.onChange),this.viewmodeData.onChanged(this.onChange),this.sweepViewData.onSelectedSweepChanged(this.onSelectedPinChange),t.subscribe(S.G,(e=>{this.nextFloor=e.to,this.onChange()})),t.subscribe(I.LW,this.onChange),t.subscribe(I.iM,this.onChange),t.commandBinder.addBinding(v.A,(async e=>{this.pinRenderer.highlightPin(e.id,!1)}))),this.nextFloor=this.floorsViewData.currentFloorId,this.onChange()}mapColliderToSweep(e){return this.pinRenderer.mapColliderToSweep(e)}selectPinMesh(e,t){return this.pinRenderer.lockSelection(e,t)}highlightPinMesh(e,t){this.pinRenderer.highlightPin(e,t)}mapSweepToMesh(e){return this.pinRenderer.mapSweepToMesh(e)}updatePosition(e,t){this.pinRenderer.updatePinMeshPosition(e,t)}}},42723:(e,t,i)=>{"use strict";i.r(t),i.d(t,{default:()=>p});var n=i(23205),a=i(35223),s=i(67902),o=i(75092),r=i(28883),d=i(82110),l=i(71136),h=i(48064),c=i(68909),m=i(42311),u=i(2785),g=i(86407);class p extends n.n{constructor(){super(...arguments),this.name="sweep-pin-navigation"}async init(e,t){const[i,n,p,y]=await Promise.all([t.getModuleBySymbol(a.gk),t.getModuleBySymbol(a.SD),t.market.waitForData(h.X),t.getModuleBySymbol(a.mL)]),v=new c.Quaternion;this.bindings.push(y.registerMeshHandler(m.rX,g.f.isType(s.im),((e,t,a)=>{const s=i.mapColliderToSweep(t);return!(!s||p.transition.active)&&(v.set(0,0,0,1).multiply(s.rotation),o=s.id,r=v,p.currentMode&&p.currentMode!==d.N3.Panorama&&n.switchToMode(d.N3.Panorama,l.fl.FadeToBlack,{sweepID:o,rotation:r}),!0);var o,r})),y.registerMeshHandler(u.L,g.f.isType(s.im),((e,n)=>{i.mapColliderToSweep(n)&&t.commandBinder.issueCommand(new o.X(r.b.FINGER))})),y.registerMeshHandler(u.q,g.f.isType(s.im),((e,n)=>{i.mapColliderToSweep(n)&&t.commandBinder.issueCommand(new o.X(null))})))}}},820:(e,t,i)=>{"use strict";i.d(t,{z:()=>g,E:()=>l});var n=i(68909),a=i(24235),s=i.n(a),o=i(38581),r=i.n(o);class d extends n.ShaderMaterial{constructor(e,t){const i=n.UniformsUtils.clone(d.uniforms);i.tNoHover.value=e,i.tHover.value=t,i.tPortal.value=null,super({vertexShader:s(),fragmentShader:r(),uniforms:i,name:"PortalMaterial",transparent:!0})}}d.uniforms={tNoHover:{value:null},tHover:{value:null},tPortal:{value:null},progress:{value:1},opacity:{value:1}};var l,h=i(32677),c=i(43998),m=i(12183),u=i(6152);!function(e){e[e.HIDE=0]="HIDE",e[e.SHOW=1]="SHOW",e[e.ONTOP=2]="ONTOP"}(l||(l={}));class g extends n.Mesh{constructor(e,t){const i=new d(h.l.get().toInteriorTexture,h.l.get().toInteriorHoverTexture);super(g.geometry,i),this.layers.mask=t.mask,this.uniforms=i.uniforms,this.renderOrder=m.X.portals,this.setState(l.HIDE),this.update(e)}update(e){if(this.portalData=e,this.position.copy(e.position),null!==e.lookDirection){const t=e.lookDirection.clone().add(e.position);this.lookAt(t)}this.hoverProgress=0,this.hovered=!1,e.toExterior?(this.uniforms.tNoHover.value=h.l.get().toExteriorTexture,this.uniforms.tHover.value=h.l.get().toExteriorHoverTexture):(this.uniforms.tNoHover.value=h.l.get().toInteriorTexture,this.uniforms.tHover.value=h.l.get().toInteriorHoverTexture)}resetMesh(e=0,t=!1,i=!1){this.uniforms.opacity.value=e,this.visible=0!==e,this.material.depthTest=t,this.material.depthWrite=i}setHover(e){this.hovered=e}setState(e){switch(e){case l.HIDE:this.resetMesh(0,!0,!0);break;case l.SHOW:this.resetMesh(1,!0,!0);break;case l.ONTOP:this.resetMesh(1)}}render(e,t){var i;if(this.hovered&&this.hoverProgress<1?this.hoverProgress+=e/300:!this.hovered&&this.hoverProgress>0&&(this.hoverProgress-=e/300),this.hoverProgress=(0,c.qE)(this.hoverProgress,0,1),this.uniforms.progress.value=this.hoverProgress,null===(i=this.portalData)||void 0===i?void 0:i.billboard){const e=t.pose.position,i=this.position.copy(this.portalData.position),n=e.distanceTo(i);n<u._9?i.lerpVectors(e,i,u._9/n):n>u.SM&&i.lerpVectors(e,i,u.SM/n),this.lookAt(t.pose.position)}}updatePortalTexture(e){this.uniforms.tPortal.value=e}raycast(e,t){if(!this.visible)return;const i=[];super.raycast(e,i),i.length>0&&(i[0].distance/=1e4,t.push(i[0]))}}g.geometry=new n.PlaneGeometry(u.yb,u.yb)},46733:(e,t,i)=>{"use strict";i.r(t),i.d(t,{default:()=>I});var n=i(68909),a=i(23205),s=i(35223),o=i(90302),r=i(45018),d=i(49191),l=i(8371),h=i(88696),c=i(57762),m=i(61543),u=i(20736),g=i.n(u),p=i(39142),y=i.n(p);class v extends n.ShaderMaterial{constructor(){const e=n.UniformsUtils.clone(v.uniforms);super({vertexShader:g(),fragmentShader:y(),uniforms:e,name:"PortalViewportMaterial",side:n.BackSide})}updateTexture(e){this.uniforms.tMap.value=e}}v.uniforms={tMap:{value:null}};class w{constructor(e,t,i,a){this.tempLookDirection=new n.Vector3,this.worldCamera=a,this.camera=new n.PerspectiveCamera,this.renderSize=i,this.sweepTextureLoader=e,this.textureRenderer=t,this.renderTargets={},this.renderCube=new n.Mesh(new n.BoxGeometry(4,4,4),new v)}async getPortalTexture(e,t,i){const n=this.renderTargets[e.id]||this.textureRenderer.createRenderTarget2D(this.renderSize,this.renderSize),a=await this.sweepTextureLoader.load(e,m.MF.BASE);return this.renderCube.material.updateTexture(a),this.renderCube.quaternion.copy(t),this.camera.projectionMatrix.copy(this.worldCamera.projectionMatrix),this.worldCamera.getWorldPosition(this.tempLookDirection),this.camera.lookAt(this.tempLookDirection.sub(i).negate()),this.textureRenderer.render(n,this.renderCube,this.camera),n.texture}releasePortalTexture(e){const t=this.renderTargets[e];t&&this.textureRenderer.disposeRenderTarget2D(t)}}var f=i(820),b=i(81585),T=i(2785),D=i(42311),C=i(86407),P=i(20361);class A{constructor(e,t,i,a,s){this.container=new n.Object3D,this.bindings=[],this.visibilityFilter=e=>f.E.HIDE,this.scene=e,this.input=t,this.layer=a,this.cameraData=s,this.viewportLoader=i,this.meshes=[],this.activeMeshes={},this.meshToDataMap={},this.dataToMeshMap={},this.activeTexturePromises={},this.meshPool=new b.i}addPortal(e){let t;const i=this.meshPool.get();i?(t=i.object,t.update(e)):t=this.meshPool.add(new f.z(e,this.layer)).object,this.meshes.push(t),this.container.add(t),this.meshToDataMap[t.id]=e,this.dataToMeshMap[e.index]=t,this.activateMesh(t,this.visibilityFilter(e))}removePortal(e){const t=this.dataToMeshMap[e.index];if(t){this.meshPool.free(t);const i=this.meshes.findIndex((e=>e.id===t.id));this.meshes.splice(i,1),this.container.remove(t),this.deactivateMesh(t),delete this.meshToDataMap[t.id],delete this.dataToMeshMap[e.index]}}init(){}activate(e){this.broadcast=e.broadcast.bind(e),this.bindings.push(this.input.registerMeshHandler(T.L,C.f.isType(f.z),((e,t)=>{this.onPuckSelect(t)}))),this.bindings.push(this.input.registerMeshHandler(T.q,C.f.isType(f.z),((e,t)=>{this.onPuckDeselect(t)}))),this.bindings.push(this.input.registerMeshHandler(D.rX,C.f.isType(f.z),((e,t)=>{this.onPuckClick(t)}))),this.scene.add(this.container)}dispose(){for(const e of Object.keys(this.meshToDataMap)){const t=this.meshToDataMap[e],i=this.dataToMeshMap[t.index];this.removePortal(t),i.material.dispose(),i.geometry.dispose()}}deactivate(e){for(const e of this.bindings)e.cancel();this.bindings.length=0,this.scene.remove(this.container)}render(e){for(const t of this.meshes)t.render(e,this.cameraData)}filter(e){this.visibilityFilter=e;for(const t of this.meshes){const i=e(this.meshToDataMap[t.id]);i===f.E.HIDE?this.deactivateMesh(t):this.activateMesh(t,i)}}mapSweepToMesh(e){for(const t in this.meshToDataMap){const i=this.meshToDataMap[t];if(i.toSweep.id===e&&i.toExterior&&i.fromInterior)return this.dataToMeshMap[i.index]}return null}activateMesh(e,t=0){this.activeMeshes[e.id]||(this.input.registerMesh(e,!1),this.activeMeshes[e.id]=!0),e.setState(t)}deactivateMesh(e){this.input.unregisterMesh(e),this.activeMeshes[e.id]=!1,this.onPuckDeselect(e),e.setState(f.E.HIDE)}onPuckClick(e){this.broadcast(new P.G(this.meshToDataMap[e.id]))}onPuckSelect(e){this.broadcast(new P.w(!0));const t=this.meshToDataMap[e.id].toSweep,i=this.viewportLoader.getPortalTexture(t,t.rotation,e.position);this.activeTexturePromises[e.id]=i,i.then((t=>{this.activeTexturePromises.hasOwnProperty(e.id)&&i===this.activeTexturePromises[e.id]&&(e.updatePortalTexture(t),e.setHover(!0))}))}onPuckDeselect(e){this.broadcast(new P.w(!1)),e.setHover(!1),this.viewportLoader.releasePortalTexture(this.meshToDataMap[e.id].toSweep.id),delete this.activeTexturePromises[e.id]}}var S=i(6152);class I extends a.n{constructor(){super(...arguments),this.name="sweep-portal-mesh",this.portalCount=0}async init(e,t){const[i,n,a,o,c,m,u]=await Promise.all([t.getModuleBySymbol(s.wY),t.getModuleBySymbol(s.sA),t.getModuleBySymbol(s.mL),t.getModuleBySymbol(s.kM),t.getModuleBySymbol(s.M7),t.market.waitForData(d.A),t.market.waitForData(r.M)]),g=t.claimRenderLayer(this.name);this.portalData={};const p=c.getScene().camera;this.raycaster=n;const y=new w(i,o,256,p),v=c.getScene().scene;this.portalRenderer=new A(v,a,y,g,u),await Promise.all([t.getModuleBySymbol(s.Ne)]);const f=new Map,b=e=>{var t;this.portalData[e.id]&&(this.removePortals(e.id,this.portalRenderer),null===(t=f.get(e.id))||void 0===t||t.cancel(),f.delete(e.id),delete this.portalData[e.id])},T=e=>{if(!this.portalData[e.id]){this.portalData[e.id]=[],h.GS(e)&&this.addPortals(e,this.portalRenderer,m,m.filter((e=>h.GS(e))));let t=e.placementType;f.set(e.id,e.onPropertyChanged("placementType",(i=>{t!==l.EO.MANUAL&&i===l.EO.MANUAL&&this.addPortals(e,this.portalRenderer,m,m.filter((e=>h.GS(e)))),t===l.EO.MANUAL&&i!==l.EO.MANUAL&&this.removePortals(e.id,this.portalRenderer),t=i})))}},D=m.getCollection();this.bindings.push(D.onElementsChanged((e=>{var t,i,n;null===(t=e.removed)||void 0===t||t.forEach((([e,t])=>b(t))),null===(i=e.added)||void 0===i||i.forEach((([e,t])=>T(t))),null===(n=e.updated)||void 0===n||n.forEach((([e,t])=>{this.portalData[t.id]&&h.GS(t)&&(this.removePortals(t.id,this.portalRenderer),this.addPortals(t,this.portalRenderer,m,m.filter((e=>h.GS(e)))))}))}))),D.forEach(T),t.addComponent(this,this.portalRenderer)}filter(e){this.portalRenderer.filter(e)}getPortalToExterior(e){return this.portalRenderer.mapSweepToMesh(e)}removePortals(e,t){for(const i of this.portalData[e])t.removePortal(i);this.portalData[e].length=0}addPortals(e,t,i,n){const a=this.nearestAlignedSweep(e,i);if(a){const i=this.entryLinks(e,a),s=this.neighborLinks(e,n);this.portalData[e.id].length=0,this.portalData[e.id].push(...i,...s);for(const i of this.portalData[e.id])t.addPortal(i)}else this.log.debug(`Couldn't find the nearest sweep for a 360 on floor ${e.floorId}; not adding portals`)}nearestAlignedSweep(e,t){const i=[h.AU(e),h.Ol(),h.Zx(),h.sT(e)],n=[c.Io(e.position)],a=t.sortByScore(i,n)[0];return a?a.sweep:null}modelIntersection(e,t,i=1/0){const a=(new n.Vector3).copy(e.position).sub(t.position).setY(0).normalize(),s=this.raycaster.picking.pick(t.position,a,o.c$);return{intersect:s&&s.distance<=i?s:null,rayDirection:a}}entryLinks(e,t){const i=[],a=e.position.distanceTo(t.position),s=this.modelIntersection(e,t,a+S.yb);let o,r,d=!1;s.intersect&&s.intersect.face?(o=s.intersect.face.normal.clone().setY(0).normalize(),Math.abs(s.rayDirection.dot(o))<.3&&o.copy(s.rayDirection).multiplyScalar(-1),r=s.intersect.point.clone().addScaledVector(o,S.Wf)):(o=null,d=!0,r=e.position.clone()),r.y=t.position.y,i.push({index:this.portalCount++,toSweep:e,fromSweep:t,position:r,lookDirection:o,billboard:d,toExterior:!0,fromInterior:!0});const l=(new n.Vector3).lerpVectors(e.position,t.position,2/a).setY(e.position.y);return i.push({index:this.portalCount++,toSweep:t,fromSweep:e,position:l,lookDirection:o?o.clone().negate():null,billboard:d,toExterior:!1,fromInterior:!1}),i}neighborLinks(e,t){const i=[];for(const n of t)if(e!==n&&n.floorId===e.floorId&&e.position.distanceTo(n.position)<S.Ml){const t=e.position.distanceTo(n.position);if(this.modelIntersection(e,n,t).intersect||this.modelIntersection(n,e,t).intersect)continue;const a=e.position.clone().sub(n.position).setY(0).normalize(),s=n.position.clone(),o=S.SM;t>o&&s.addScaledVector(a,t-o),i.push({index:this.portalCount++,toSweep:n,fromSweep:e,position:s,lookDirection:a,billboard:!1,toExterior:!0,fromInterior:!1})}return i}}},20361:(e,t,i)=>{"use strict";i.d(t,{G:()=>a,w:()=>s});var n=i(14754);class a extends n.QB{constructor(e){super(),this.toSweep=e.toSweep,this.toExterior=e.toExterior,this.fromInterior=e.fromInterior,this.meshPosition=e.position}}class s extends n.QB{constructor(e){super(),this.hovered=e}}},6152:(e,t,i)=>{"use strict";i.d(t,{Ml:()=>n,SM:()=>r,Wf:()=>a,_9:()=>o,yb:()=>s});const n=15,a=.1,s=.3,o=.75,r=4},68859:(e,t,i)=>{"use strict";i.r(t),i.d(t,{default:()=>f});const n=(0,i(93475).hV)(20);var a=i(23205),s=i(35223),o=i(8371),r=i(82110),d=i(71136),l=i(45018),h=i(49191),c=i(48064),m=i(820),u=i(20361),g=i(1902),p=i(28997),y=i(54839),v=i(28883),w=i(75092);class f extends a.n{constructor(){super(...arguments),this.name="sweep-portal-navigation",this.onChange=()=>{this.portalRenderer.filter((e=>{if(!this.settingsData.tryGetProperty(y.s,!0))return m.E.HIDE;if(!(0,r.nI)(this.viewmodeData.closestMode))return m.E.HIDE;const t=this.sweepData.getSweep(this.sweepData.currentSweep||"");if(t)if(t.alignmentType===o.c$.ALIGNED){if(e.fromInterior&&e.toExterior&&e.position.distanceTo(t.position)<n)return m.E.SHOW}else if(t.placementType===o.EO.MANUAL&&e.fromSweep.id===t.id)return m.E.ONTOP;return m.E.HIDE}))}}async init(e,t){this.engine=t,[this.portalRenderer,this.cameraData,this.viewmodeModule,this.viewmodeData,this.sweepData,this.settingsData]=await Promise.all([t.getModuleBySymbol(s.f0),t.market.waitForData(l.M),t.getModuleBySymbol(s.SD),t.market.waitForData(c.X),t.market.waitForData(h.A),t.market.waitForData(p.o)]);const i=(e,i)=>{this.viewmodeData.currentMode&&this.cameraData.canTransition()&&(this.viewmodeData.currentMode!==r.N3.Panorama?this.viewmodeModule.switchToMode(r.N3.Panorama,d.fl.FadeToBlack,{sweepID:e,rotation:i}):t.commandBinder.issueCommand(new g.aj({sweep:e,rotation:i,transition:d.fl.FadeToBlack})))};this.settingsData.onPropertyChanged(y.s,this.onChange),this.bindings.push(t.subscribe(u.G,(e=>{i(e.toSweep.id)})),t.subscribe(u.w,(e=>this.onPortalHover(e.hovered))),this.viewmodeData.onChanged(this.onChange),this.sweepData.onChanged(this.onChange)),this.onChange()}onPortalHover(e){const t=e?v.b.FINGER:null;this.engine.commandBinder.issueCommand(new w.X(t))}}},37396:(e,t,i)=>{"use strict";i.r(t),i.d(t,{default:()=>l});var n=i(23205),a=i(61543),s=i(68909),o=i(35223);const r=new(i(35652).Ay)("sweep-textures"),d={[a.MF.BASE]:256,[a.MF.STANDARD]:1024,[a.MF.HIGH]:2048,[a.MF.ULTRAHIGH]:4096};class l extends n.n{constructor(){super(...arguments),this.name="sweep-textures",this.sweepCubeTextures={}}async init({sizes:e=d},t){this.api=(await t.getModuleBySymbol(o.qL)).getApi(),this.sizes=e}useTexture(e){const t=this.getTexture(e);if(!t)throw Error("Texture for sweep not loaded before using");return t}loadFace(e,t,i,n){return this.loadFaceImage(e,t,i,n).then((e=>{const t=new s.Texture(e);return t.colorSpace=s.SRGBColorSpace,t.needsUpdate=!0,t}))}load(e,t=a.MF.STANDARD){const i=this.sweepCubeTextures[e.id];if(i)return r.debug("Skipping load of pano, already loaded"),new Promise((function(e,t){e(i)}));const n=[2,4,0,5,1,3].map((i=>this.loadFaceImage(e,t,i))),o=Promise.all(n).then((t=>{const i=new s.CubeTexture(t);return i.flipY=!1,i.needsUpdate=!0,i.colorSpace=s.SRGBColorSpace,this.sweepCubeTextures[e.id]=i,i}));return o.catch((()=>{r.error(`Downloading cubemap for pano ${e.id} failed`)})),o}unload(e){var t;const i=this.sweepCubeTextures[e];if(!i)throw Error("Texture for sweep not loaded before unloading");i.dispose(),null===(t=i.images)||void 0===t||t.forEach((e=>{var t,i;null===(i=(t=e).close)||void 0===i||i.call(t)})),this.sweepCubeTextures[e]=null}async loadFaceImage(e,t,i,n){const a=this.sizes[t],s=await e.getFaceUrl(t,i);return this.api.getImageBitmap(s,a,a,n)}getTexture(e){return this.sweepCubeTextures[e]}}},19742:(e,t,i)=>{"use strict";i.r(t),i.d(t,{CancelTagEditsCommand:()=>B.J9,CloseTagCommand:()=>B.KH,DeleteTagCommand:()=>B.RL,EditTagCommand:()=>B.YN,FilterVisibleTagsCommand:()=>B.$m,OpenTagCommand:()=>B.Ki,RegisterTagsToolCommand:()=>B.eo,SaveCustomTagOrderCommand:()=>B.mg,SaveTagCommand:()=>B.Bu,SaveTagVisibilityCommand:()=>B.br,SetEmbedErrorTagIdCommand:()=>B.kd,SetTagOrderByCommand:()=>B.l7,SetTagsModeCommand:()=>B.ir,StartNewTagCommand:()=>B.aH,TagOrderBy:()=>x.k,TagsMode:()=>x.j,TagsToolToggleCommand:()=>B.NR,TagsViewData:()=>de.r,TagsVisibilityFilterEnabledCommand:()=>B.wJ,ToggleDirtyTagStateCommand:()=>B.jC,UpdateOpenTagViewCommand:()=>B.OT,default:()=>it});var n=i(23205),a=i(35223),s=i(9389),o=i(54244),r=i(99366),d=i(60282),l=i(19533);const h=i.p+"images/tagColor.png";var c=i(26325),m=i(80379),u=i(71136),g=i(1902),p=i(57682),y=i(61343),v=i(20560),w=i(27483),f=i(64464),b=i(26197),T=i(35596),D=i(2789),C=i(68909),P=i(57440),A=i(93424),S=i(91902),I=i(9876),k=i(59105),N=i(89998),E=i(64599);class O extends P.r{constructor(e,t,i,n,a,s,r,d){super(e,t,i),this.containerData=n,this.tag=a,this.tagIconsEnabled=r,this.defaultTagLabel=d,this.id=this.tag.id,this.title=this.tag.label||this.textParser.getPlainText(this.tag.description)||this.defaultTagLabel,this.description=this.tag.label?this.textParser.getPlainText(this.tag.description):"",this.icon=`icon-${(0,k.RN)(N.yY.MATTERTAG,this.tag.icon,this.tagIconsEnabled)}`,this.typeId=o.jM.MATTERTAG,this.floorId=this.tag.floorId,this.roomId=this.tag.roomId||"",this.layerId=this.tag.layerId,this.dateBucket=(0,A.n)(this.tag.created),this.color=function(e){const t=new C.Color(e);return`rgb(${255*t.r}, ${255*t.g}, ${255*t.b})`}(this.tag.color),this.enabled=this.tag.enabled,this.onSelect=async()=>{await this.commandBinder.issueCommand(new S.mS),await this.commandBinder.issueCommand(new g.E4({pinPosition:this.tag,transition:u.fl.FadeToBlack})),(0,E.w)(this.containerData.size)?this.commandBinder.issueCommand(new S.y8(this.id,I.U.TAG)):this.commandBinder.issueCommand(new S.xo(this.id,I.U.TAG))},this.textParser=s}supportsLayeredCopyMove(){return!0}supportsBatchDelete(){return!0}}var M=i(95149),x=i(23643),B=i(89375),V=i(87312),R=i(20764);const{TAGS:F}=r.A.SHOWCASE,L=new p.r({links:!0}),j="0"===(0,M.P3)("mt");function U(e,t,i,n,a,s,r,d){let l=r.application===T.lg.WORKSHOP;const h=s.tryGetProperty(R.Jr,!1),c=(t,s,o,r=[])=>{const c=[];return(i.tagOrder===x.k.ALPHABETICAL?i.getAlphabeticTagViewMapFilter().values:i.getOrderedTagViewMapFilter().values).forEach((i=>{if(!(l||i.enabled&&n.layerToggled(i.layerId)))return;if(i.objectAnnotationId)return;let o=t(i.label,L.getPlainText(i.description));o&&r.length>0&&(o=i.keywords.length>0&&i.keywords.some((e=>r.includes(e)))),o&&c.push(new O(e,n,s,a,i,L,h,d))})),e.issueCommand(new B.$m(c.map((e=>e.id)))),c},m=t=>{e.issueCommand(new B.wJ(!!t))},u=e=>new D.P(i.getOrderedTagViewMapFilter().onChanged(e),i.onPropertyChanged("tagOrder",e)),g={renew:()=>{e.issueCommandWhenBound(new V.Oc({id:o.jM.MATTERTAG,groupPhraseKey:F.SEARCH_GROUP_HEADER,getSimpleMatches:c,registerChangeObserver:u,onSearchActivatedChanged:m,getKeywords:t.getTagKeywords.bind(t),groupOrder:20,groupIcon:"toolbar-mattertags",batchSupported:!0}))},cancel:()=>{e.issueCommandWhenBound(new V.tf(o.jM.MATTERTAG))}},p=e=>{l=e===T.lg.WORKSHOP;!j||l?g.renew():g.cancel()},y=r.onPropertyChanged("application",p);return p(r.application),new D.P(g,y)}var H=i(5573),z=i(51889),G=i(7628),$=i(30411),_=i(19974),K=i(87513),X=i(5272),W=i(65413),Y=i(521),q=i(9321),Q=i(59839),J=i(26956),Z=i(55649),ee=i(8743),te=i(51003),ie=i(42155),ne=i(55912),ae=i(2409),se=i(71306),oe=i(95577),re=i(93612),de=i(44901),le=i(4234),he=i(89552),ce=i(92590),me=i(49191),ue=i(28997),ge=i(48064),pe=i(76035),ye=i(45018),ve=i(34040),we=i(61334),fe=i(68340),be=i(66172),Te=i(69426),De=i(4913),Ce=i(74848),Pe=i(96540),Ae=i(40826),Se=i(19591),Ie=i(97137),ke=i(75414),Ne=i(83910),Ee=i(99167),Oe=i(54550),Me=i(32485),xe=i.n(Me),Be=i(52147),Ve=i(76573),Re=i(47952),Fe=i(16603),Le=i(34368),je=i(24850),Ue=i(52385),He=i(16552),ze=i(63348),Ge=i(40194),$e=i(61643),_e=i(89339);function Ke(){const{commandBinder:e}=(0,Pe.useContext)(Ae.BR),t=(0,Le.D)(),i=(0,je.J)(),n=(0,Re.V)(re.j),a=(0,Re.V)(de.r),s=(0,Re.V)(K.o),[o,r]=(0,Pe.useState)(null),[d,l]=(0,Pe.useState)(!0),h=(0,Fe.i)(R.GK,!0),c=(0,Fe.i)(Be.qu,!1),m=(0,Fe.i)(R.Jr,!1);(0,Pe.useEffect)((()=>{if(!(n&&a&&t&&(null==n?void 0:n.getTag(t.id))))return;const e=n.getTag(t.id);function i(e){const t=null==s?void 0:s.getCapabilities(e);return t&&l(t.share),t}r(Object.assign({},t));const o=i(t.id),d=null==o?void 0:o.onChanged((()=>i(t.id))),h=e.onChanged((()=>{const e=a.getTagView(t.id);r(e?Object.assign({},e):null)}));return()=>{h.cancel(),null==d||d.cancel()}}),[s,t,n,a]);const u=t=>{e.issueCommand(new le.ht(!0,w,t))};if(!o)return null;const{id:g,description:y,label:v,attachments:w,keywords:f,icon:b,color:T}=o,D=new p.r({links:!0}),C=(0,he.c9)(w),P=(0,he.rg)(w),A=C.length>0,S=d&&h;return(0,Ce.jsxs)("div",Object.assign({className:xe()("tag-view-panel",{"viewable-media":A})},{children:[A&&!c&&(0,Ce.jsx)(ze.P,{attachments:C,onClick:(e,t)=>{u(t)}}),(0,Ce.jsxs)("div",Object.assign({className:xe()("tag-view-panel-header",{"no-media":c||!A})},{children:[(0,Ce.jsx)(_e.E,{badgeStyle:{background:T},iconClass:`icon-${(0,k.RN)(N.yY.MATTERTAG,b,m)}`}),(0,Ce.jsxs)("div",Object.assign({className:"tag-view-panel-header-contents"},{children:[(0,Ce.jsxs)("div",Object.assign({className:"tag-view-panel-top"},{children:[v&&(0,Ce.jsx)("div",Object.assign({className:"tag-view-panel-title"},{children:v})),(void 0===S||S)&&(0,Ce.jsx)($e.k,{prefix:"tag",pin:o,id:o.id,darkTheme:!1,includeCameraView:!0,analyticAction:"tags_copy_share_link",buttonVariant:Ue.Ak.TERTIARY},o.id)]})),f&&(0,Ce.jsx)(He.B,{className:"tag-view-panel-keywords",keywords:f,maxVisible:5}),(0,Ce.jsx)(Ge.$,{text:y,textParser:D,linkHandler:i,annotationType:I.U.TAG,annotationId:g,attachments:[],onViewAttachment:u})]}))]})),P.length>0&&(0,Ce.jsxs)("div",Object.assign({className:"tag-view-panel-attachments"},{children:[(0,Ce.jsx)("h4",{children:"Attachments"}),(0,Ce.jsx)(Ve.E,{annotationType:I.U.TAG,attachments:P})]}))]}))}var Xe=i(6199);const{TAGS:We}=r.A.SHOWCASE;function Ye(){const e=(0,Se.c)(),t=(0,Ie.O)(),i=(0,ke.t)(),n=(0,Fe.i)(R.rp,"1"),{commandBinder:a,locale:s}=(0,Pe.useContext)(Ae.BR),o=e&&(e===Y.S0.SEARCH||e===Y.S0.LAYERS),r=()=>{o?a.issueCommand(new q.kC).then((()=>{a.issueCommand(new q.oe(!1))})):a.issueCommand(new q.u3(Y.S0.TAGS))},d=e?"back":"close",l=s.t(o?We.NAV_BACK_LABEL:We.CLOSE_TAG_LABEL),h=t===Y.L$.BOTTOM_PANEL,c=i&&i!==Ne.a.CONFIRM,m=!h||!c;return(0,Ce.jsxs)(Oe.q,Object.assign({className:"tags-panel",open:m,scrollingDisabled:!1,onClose:r},{children:[(0,Ce.jsxs)("div",Object.assign({className:"detail-panel-header"},{children:[(0,Ce.jsx)(Ee.J,{icon:d,label:l,onClose:r}),n&&(0,Ce.jsx)(Xe.T,{analyticAction:"tags_navigate_in_panel"})]})),(0,Ce.jsx)(Ke,{})]}))}var qe=i(33810),Qe=i(66094);class Je{constructor(){this.renderPanel=()=>(0,Ce.jsx)(Ye,{})}renderPersistentOverlay(){return(0,Ce.jsxs)("div",{children:[(0,Ce.jsx)(qe.T,{parentTool:Y.S0.TAGS}),(0,Ce.jsx)(Qe.W,{})]},"tags-panel-ui")}}var Ze=i(765),et=i(67433);class tt extends n.n{constructor(){super(...arguments),this.name="tags-module",this.opening=null,this.activated=!1,this.registered=!1,this.activeBindings=[],this.updatePerSettings=()=>{const e=this.settingsData.tryGetProperty(ae.qE,!1),t=!this.in360View()&&e;this.engine.commandBinder.issueCommand(new G.g4(N.yY.MATTERTAG,t)),t||this.closeTagBillboard()},this.registerTagsTool=async()=>{const e=new W.N({id:Y.S0.TAGS,namePhraseKey:r.A.TOOLS.TAGS,deepLinkParam:"tag",panel:!0,icon:"icon-toolbar-mattertags",analytic:"tags",dimmed:!1,enabled:!0,hidesAppBar:!0,ui:new Je,manager:new Ze.l(this.engine,this.settingsData)});this.engine.commandBinder.issueCommand(new q.Kw([e]))},this.tagsToolToggled=async e=>{e.opened?this.activateTool():this.deactivateTool()},this.updateViewingControls=()=>{const{openTagView:e}=this.viewData,t=this.toolsData.toolPanelLayout===Y.L$.BOTTOM_PANEL,i=!this.activated||!t&&!e;this.engine.broadcast(new Q.Vk(i))},this.onCloseTag=async()=>{this.closeTag()},this.pinAddCancelled=e=>{e.pinType===N.yY.MATTERTAG&&this.cancelTagCreation(!1)},this.cancelTagEdits=async()=>{this.viewData.creatingTag?this.cancelTagCreation(!0):this.closeTag()},this.cancelTagCreation=e=>{var t;const i=this.viewData,n=null===(t=i.openTagView)||void 0===t?void 0:t.id;this.cancelAttachmentChanges(),i.setOpenTagView(null),i.creatingTag=!1,i.openTagIsDirty=!1,i.commit(),n&&(e&&this.engine.commandBinder.issueCommand(new G.hd(n,N.yY.MATTERTAG)),this.engine.commandBinder.issueCommand(new S.XK(n,I.U.TAG)))},this.tagsWereChanged=()=>{this.refreshTagViews(),this.displayTags()},this.refreshTagViews=()=>{this.viewData.refreshTagViews(this.getCustomTagOrder())},this.onTagRemoved=e=>{const t=e.objectAnnotationId?N.yY.OBJECT:N.yY.MATTERTAG;this.engine.commandBinder.issueCommand(new G.z5(e.sid,t))},this.handleModelViewChange=()=>{if(this.viewData.openTagView)if(this.viewData.creatingTag)this.cancelTagCreation(!0);else{this.tagsData.getTag(this.viewData.openTagView.id)||this.closeTag()}},this.onLayersChanged=()=>{this.closeTagBillboard(),this.displayTags()},this.onOpenTagViewChanged=()=>{const e=this.viewData.openTagView;e&&this.updateTagPin(e)},this.startTagCreation=async()=>{const e=this.viewData;e.setTagsMode(x.j.DEFAULT),await this.closeTag();let t=(0,d.D)(11);for(;this.tagsData.getTag(t);)t=(0,d.D)(11);const i=new oe.Q;i.sid=t,i.floorId=this.floorsViewData.getHighestVisibleFloor().id,i.layerId=this.layersData.activeLayerId,i.anchorPosition.y=1e9;const n=e.createTagView(i);return e.creatingTag=!0,e.commit(),e.setOpenTagView(n),this.engine.commandBinder.issueCommand(new G.Zs(n.id,this.getPinUpdate(n),N.yY.MATTERTAG,n.backgroundTexture)),t},this.saveTag=async e=>{const{id:t,properties:i,pendingAttachments:n,removedAttachments:a,embed:s}=e,o=this.viewData,{openTagView:r,creatingTag:d}=o;if(!r)return void this.log.debug("No open tag");const l=Object.assign({},r,i);this.trackChanges(t,l,s),d?(o.creatingTag=!1,o.openTagIsDirty=!1,o.commit(),await this.engine.commandBinder.issueCommand(new se.Ee(t,l,n,s))):await this.engine.commandBinder.issueCommand(new se.vZ(t,l,n,a,s)),l.objectAnnotationId||this.selectPin(t,!0),await this.engine.commandBinder.issueCommand(new le.dX),this.closeTag()},this.saveTagVisibility=async e=>{const{id:t,visible:i}=e,n=this.tagsData.getTag(t);if(!n)throw new Error("Tag not found!");this.engine.commandBinder.issueCommand(new G.f5(t,N.yY.MATTERTAG,this.getTagVisibility(t,n.layerId,i)));const a={enabled:i};return this.trackChanges(t,a),i||this.closeTag(),this.engine.commandBinder.issueCommand(new se.vZ(t,a))},this.onDeleteTag=async e=>{const t=e.id;this.tagsData.getTag(t)?(this.toggleTagDirty(!1),this.engine.commandBinder.issueCommand(new Z.r),this.engine.broadcast(new H.Fj(t,e.removalMethod)),this.engine.commandBinder.issueCommand(new se.l(t)).then((()=>{this.saveTags().then((()=>{this.engine.commandBinder.issueCommand(new G.z5(t,N.yY.MATTERTAG));const e=this.viewData.openTagView;e&&e.id===t&&this.closeTag()}))})),this.engine.commandBinder.issueCommand(new le.dX)):this.log.debug("Cannot delete a non-existent tag")},this.onEditTag=async e=>{const{tagId:t}=e;this.tagsData.getTag(t)?(await this.engine.commandBinder.issueCommand(new le.dX),await this.openTag(t,u.fl.FadeToBlack,!0,!0),this.openAnnotation(t,!0),this.selectPin(t,!0)):this.log.debug("Cannot edit a non-existent tag")},this.updateOpenTagView=async e=>{const{updates:t}=e,i=this.viewData.openTagView;if(i){this.viewData.setOpenTagView(Object.assign(Object.assign({},i),t));const e=i.objectAnnotationId||i.id,n=i.objectAnnotationId?N.yY.OBJECT:N.yY.MATTERTAG;await this.engine.commandBinder.issueCommand(new G.gx(e,n,t))}else this.log.debug("No open tag to update")},this.onSaveCustomTagOrder=async e=>{const{ids:t}=e,i=t.map((e=>({id:e,type:ee._.TAG})));await this.engine.commandBinder.issueCommand(new te.lr(ne.K,i)),this.viewData.refreshTagViews(t)},this.setEmbedErrorTagId=async e=>{this.viewData.setEmbedErrorTagId(e.id)},this.pinMoved=e=>{const{id:t,pinType:i,pinPos:n,previousPos:a}=e,s=this.viewData.openTagView;if(s&&i===N.yY.MATTERTAG&&t===s.id){if(this.tagsData.getTag(t)){const{anchorPosition:e,stemNormal:i,floorId:s,roomId:o}=n,r={position:e,normal:i,floorId:s,roomId:o};this.engine.broadcast(new H.oO(t,r.position,r.position.distanceTo(this.cameraData.pose.position),a?r.position.distanceTo(a.anchorPosition):0)),this.engine.commandBinder.issueCommand(new se.vZ(t,r))}else this.log.debug("Cannot move a non-existent tag")}},this.pinPlaced=e=>{const{openTagView:t}=this.viewData;t&&e.pinType===N.yY.MATTERTAG&&e.id===t.id&&(Object.assign(t,e.pinPos),this.openAnnotation(t.id,!0))},this.handlePinFocusChange=async()=>{const{openTagView:e,creatingTag:t}=this.viewData;if(t)return;const{commandBinder:i}=this.engine,{focusedPin:n,selectedPinId:a}=this.pinsViewData,{billboardAnnotation:s}=this.annotationsViewData;if(!n)return void(s&&s.annotationType===I.U.TAG&&s.id!==a&&await i.issueCommand(new S.XK(s.id,I.U.TAG)));const o=this.getSelectedTag(),r=o&&(null==o?void 0:o.id)===(null==e?void 0:e.id),d=e&&(null==e?void 0:e.id)===(null==n?void 0:n.id);if(e&&r&&!d&&this.closeTag(),n.pinType===N.yY.MATTERTAG){const t=this.viewData.getTagView(n.id);if(!t)return void this.log.debug("Focused pin changed, but no tag view.");t.id!==(null==e?void 0:e.id)&&(i.issueCommand(new S.Zx(t.id,I.U.TAG)),this.engine.broadcast(new be.T8(t.id,Te.h.HOVER)))}},this.handlePinSelectionChange=async()=>{const{openTagView:e,openTagIsDirty:t}=this.viewData,{selectedPinId:i}=this.pinsViewData;if(t||(null==e?void 0:e.id)===i)return;const n=i?this.pinsViewData.getPin(i):null,a=this.appData.application===T.lg.WORKSHOP;if(e&&!n)!a&&this.activated?await this.engine.commandBinder.issueCommand(new q.u3(Y.S0.TAGS)):this.closeTag();else if(n&&n.pinType===N.yY.MATTERTAG){(0,E.w)(this.containerData.size)&&await this.engine.commandBinder.issueCommand(new S.y8(n.id,I.U.TAG));const e=this.isTagDocked()||!!this.getSelectedTag(),t=a&&e;this.engine.commandBinder.issueCommand(new G.HR(n.id,t)),this.engine.broadcast(new be.T8(n.id,Te.h.OPEN));const i=this.isDocking();await this.openTag(n.id,u.fl.Interpolate,i),this.openAnnotation(n.id,i)}},this.isDocking=()=>(0,E.w)(this.containerData.size)||this.activated&&this.isTagDocked(),this.handleAnnotationsChanged=async()=>{const{openTagView:e,creatingTag:t}=this.viewData;if(t||this.opening)return;const i=this.getDockedTag(),n=this.getSelectedTag(),a=i||n,s=!!i,{dockedAnnotation:o}=this.annotationsViewData;if(e&&!a&&(null==o?void 0:o.annotationType)!==I.U.OBJECT)this.closeTag();else if(a&&a.id!==(null==e?void 0:e.id)){this.engine.broadcast(new be.T8(a.id,Te.h.OPEN));const e=this.appData.application!==T.lg.WORKSHOP||!s;await this.openTag(a.id,u.fl.Interpolate,s,e),await this.selectPin(a.id,s)}s?(this.activated||await this.engine.commandBinder.issueCommand(new q.Wm(Y.S0.TAGS,!0)),a&&await this.selectPin(a.id,s)):this.activated&&this.toolsData.softOpening&&await this.engine.commandBinder.issueCommand(new q.u3(Y.S0.TAGS))},this.handleViewingAttachment=e=>{const{annotationType:t,id:i,attachmentId:n}=e;if(t!==I.U.TAG)return;const a=this.viewData.getTagView(i);if(!a)return void this.log.debug("Cannot view attachment for a non-existent tag");const s=a.attachments,o=s.find((e=>e.id===n));if(o&&(0,he.rV)(o)){const e=s.filter((e=>(0,he.rV)(e)));this.engine.commandBinder.issueCommand(new le.ht(!0,e,n))}},this.onOpenTag=async e=>{const{tagId:t,dock:i,transition:n,objectTag:a,forceOpen:s}=e;this.toggleTagDirty(!1);const o=this.annotationsViewData.getCapabilities(t).dock,r=!(!i||!o),d=null===i&&this.isTagDocked()&&o,l=r||d||!(!i||!s);l&&a?this.dockObjectTag(t):(await this.openTag(t,n,l),this.openAnnotation(t,l,s),this.selectPin(t,l))},this.filterVisibleTags=async e=>{const{idVisibility:t}=this.viewData;t.clear(),e.ids.forEach((e=>t.add(e))),this.viewData.commit(),this.displayTags()},this.tagVisbilityFilterEnabled=async e=>{this.viewData.idVisibilityEnabled=e.enabled,this.viewData.commit(),this.displayTags()},this.setTagOrderBy=async({order:e})=>{e!==this.viewData.tagOrder&&(this.viewData.tagOrder=e,this.viewData.commit())},this.setTagsMode=async({mode:e})=>{e===x.j.REORDERING&&this.closeTag(),this.viewData.setTagsMode(e)}}async init(e,t){const[i,n,o,d,c,m,u,g,f,b,D,C,P]=await Promise.all([t.market.waitForData(ye.M),t.market.waitForData(re.j),t.market.waitForData(J.M),t.market.waitForData(me.A),t.market.waitForData(ue.o),t.market.waitForData(ge.X),t.market.waitForData(K.o),t.market.waitForData(T.zH),t.market.waitForData(ce.X),t.market.waitForData(ie.Y),t.market.waitForData(we.P),t.market.waitForData(De.G),t.getModuleBySymbol(a.gS)]),[A,S,I]=await Promise.all([t.market.waitForData(ve.q),t.market.waitForData(pe.G),t.getModuleBySymbol(s.r)]);this.cameraData=i,this.tagsData=n,this.toolsData=o,this.sweepData=d,this.settingsData=c,this.viewmodeData=m,this.annotationsViewData=u,this.appData=g,this.floorsViewData=f,this.orderedListData=b,this.layersData=D,this.containerData=C,this.engine=t,this.backgroundTexture=(0,l.y)(h),this.descriptionParser=new y.g({supportLinks:!0,keepLinkLabels:!0});const k=new p.r({links:!0,hashtags:!1}),N=this.getCustomTagOrder(),E=P.t(r.A.WORKSHOP.MATTERTAGS.DEFAULT_TAG_TITLE);this.viewData=new de.r(this.tagsData,A,S,N,k,I,E,this.backgroundTexture,e.objectTagsEnabled),this.pinsViewData=await t.market.waitForData($.U),this.bindings.push(c.onPropertyChanged(ae.qE,this.updatePerSettings),t.commandBinder.addBinding(B.eo,this.registerTagsTool),t.commandBinder.addBinding(B.NR,this.tagsToolToggled),t.subscribe(X.z,this.handleViewingAttachment),t.subscribe(v.A,this.updatePerSettings),t.subscribe(w.b,this.updatePerSettings),m.makeModeChangeSubscription(this.updatePerSettings),t.commandBinder.addBinding(B.KH,this.onCloseTag),t.commandBinder.addBinding(B.Ki,this.onOpenTag),t.commandBinder.addBinding(B.ir,this.setTagsMode),t.commandBinder.addBinding(B.l7,this.setTagOrderBy),t.commandBinder.addBinding(B.Bu,this.saveTag),t.commandBinder.addBinding(B.jC,(async e=>this.toggleTagDirty(e.dirty))),t.commandBinder.addBinding(B.RL,this.onDeleteTag),t.commandBinder.addBinding(B.br,this.saveTagVisibility),t.commandBinder.addBinding(B.YN,this.onEditTag),t.commandBinder.addBinding(B.OT,this.updateOpenTagView),t.commandBinder.addBinding(B.kd,this.setEmbedErrorTagId),this.pinsViewData.onSelectedPinChanged(this.handlePinSelectionChange),this.pinsViewData.onFocusedPinChanged(this.handlePinFocusChange),this.annotationsViewData.onChanged(this.handleAnnotationsChanged),this.viewData.onOpenTagViewChanged(this.onOpenTagViewChanged),this.orderedListData.onChanged(this.refreshTagViews),this.tagsData.onChanged(this.tagsWereChanged),this.tagsData.collection.onElementChanged({onRemoved:this.onTagRemoved}),this.appData.onChanged((()=>this.displayTags())),this.layersData.onCurrentLayersChanged(this.onLayersChanged),this.layersData.onPropertyChanged("activeLayerId",(()=>this.updatePendingTag())),t.commandBinder.addBinding(B.$m,this.filterVisibleTags),t.commandBinder.addBinding(B.wJ,this.tagVisbilityFilterEnabled),t.subscribe(fe.tj,this.handleModelViewChange)),t.market.register(this,de.r,this.viewData),this.updatePerSettings(),this.displayTags();const O=U(t.commandBinder,this.tagsData,this.viewData,this.layersData,C,this.settingsData,this.appData,E);this.bindings.push(O)}dispose(e){this.deactivateTool(!0),this.bindings.forEach((e=>{e.cancel()})),this.bindings=[],this.activeBindings=[],this.engine.commandBinder.issueCommand(new G.Ni(N.yY.MATTERTAG)),this.backgroundTexture.dispose(),super.dispose(e)}onUpdate(){}activateTool(){this.activated||(this.engine.commandBinder.issueCommand(new S.mS(I.U.TAG)),this.engine.commandBinder.issueCommand(new G.fZ(!0)),this.registered?this.activeBindings.forEach((e=>{e.renew()})):this.registerHandlers(),this.activated=!0,this.updateViewingControls())}deactivateTool(e){if(!this.activated)return;this.activated=!1;const{creatingTag:t,openTagView:i,tagsMode:n}=this.viewData;n!==x.j.DEFAULT&&this.viewData.setTagsMode(x.j.DEFAULT),t?this.cancelTagCreation(!0):i&&this.closeTag(),this.engine.commandBinder.issueCommand(new G.mf),this.engine.commandBinder.issueCommand(new G.fZ(!1)),this.activeBindings.forEach((e=>{e.cancel()})),this.updateViewingControls(),this.engine.commandBinder.issueCommand(new le.dX)}registerHandlers(){const e=this.engine.commandBinder;this.activeBindings.push(this.engine.subscribe(_.yi,this.pinPlaced),this.engine.subscribe(_.cC,this.pinMoved),this.engine.subscribe(_.lY,this.pinAddCancelled),e.addBinding(B.aH,this.startTagCreation),e.addBinding(B.J9,this.cancelTagEdits),e.addBinding(B.mg,this.onSaveCustomTagOrder),this.viewData.onOpenTagViewChanged(this.updateViewingControls),this.viewData.onPropertyChanged("creatingTag",this.updateViewingControls),this.viewData.onPropertyChanged("tagsMode",(()=>this.displayTags()))),this.registered=!0}closeTagBillboard(){const{billboardAnnotation:e}=this.annotationsViewData;e&&e.annotationType===I.U.TAG&&this.engine.commandBinder.issueCommand(new S.XK(e.id,I.U.TAG))}in360View(){const e=this.sweepData.currentSweep?this.sweepData.currentSweep:"";return this.viewmodeData.isInside()&&this.sweepData.isSweepUnaligned(e)}async closeTag(){const{commandBinder:e}=this.engine,t=this.viewData,{openTagView:i}=t;if(this.toggleTagDirty(!1),i){const{id:n,layerId:a,enabled:s}=i;t.setOpenTagView(null),this.cancelAttachmentChanges(),e.issueCommand(new V.Xx(null)),e.issueCommand(new le.ht(!1));const o=this.tagsData.getTag(n);o&&(e.issueCommand(new G.mP(n,N.yY.MATTERTAG)),o.objectAnnotationId?e.issueCommand(new G.z5(n,N.yY.MATTERTAG)):(e.issueCommand(new G.f5(n,N.yY.MATTERTAG,this.getTagVisibility(n,a,s))),e.issueCommand(new G.gx(n,N.yY.MATTERTAG,o.getPin())))),await e.issueCommand(new S.XK(n,I.U.TAG))}this.engine.commandBinder.issueCommand(new le.dX)}getTagVisibility(e,t,i){const{openTagView:n,idVisibilityEnabled:a,idVisibility:s,tagsMode:o}=this.viewData,r=this.appData.application===T.lg.WORKSHOP||this.layersData.layerToggled(t),d=this.layersData.layerVisible(t),l=o===x.j.REORDERING,h=!a||s.has(e),c=(null==n?void 0:n.id)===e;return r&&(c||i&&l||i&&h&&d)}displayTags(){const e=[];this.viewData.getOrderedTags(!1).forEach((t=>{if(!t.objectAnnotationId){const i=this.getPinUpdate(t);e.push(i)}})),this.engine.commandBinder.issueCommand(new G.wn(e))}updateTagPin(e){if(!e.objectAnnotationId){const t=this.getPinUpdate(e);this.engine.commandBinder.issueCommand(new G.wn([t]))}}getPinUpdate(e){const{openTagView:t}=this.viewData,i=t&&t.id===e.id?t:e,{id:n,layerId:a,enabled:s,anchorPosition:o,color:r,icon:d,stemEnabled:l,floorId:h,roomId:c,stemNormal:m,stemLength:u}=i;return{id:n,anchorPosition:o,color:r,floorId:h,roomId:c,stemEnabled:l,stemNormal:m,stemLength:u,pinType:N.yY.MATTERTAG,backgroundTexture:this.backgroundTexture,icon:d,visible:this.getTagVisibility(n,a,s)}}updatePendingTag(){const{creatingTag:e,openTagView:t}=this.viewData;e&&t&&(this.layersData.isInMemoryLayer(t.layerId)||(t.layerId=this.layersData.activeLayerId))}async cancelAttachmentChanges(){return this.engine.commandBinder.issueCommand(new le.OK)}toggleTagDirty(e){this.viewData.openTagIsDirty=e,this.viewData.commit()}getCustomTagOrder(){const e=this.orderedListData.getOrderedList(ne.K);return e?e.entries.map((e=>e.id)):[]}async saveTags(){this.engine.commandBinder.issueCommand(new m.F({dataTypes:[c.p.MATTERTAGS]}))}openAnnotation(e,t,i=!1){const n=this.annotationsViewData.getCapabilities(e);t?(n.dock||i)&&this.engine.commandBinder.issueCommand(new S.y8(e,I.U.TAG,i)):(n.preview||i)&&this.engine.commandBinder.issueCommand(new S.xo(e,I.U.TAG,i))}async selectPin(e,t=!1){const i=t&&this.activated&&this.appData.application===T.lg.WORKSHOP;t?this.engine.broadcast(new be.T8(e,Te.h.DOCKED)):this.engine.broadcast(new be.T8(e,Te.h.OPEN)),await this.engine.commandBinder.issueCommand(new G.Rg(e,N.yY.MATTERTAG,i))}dockObjectTag(e){const t=this.viewData.getTagView(e);t?(this.engine.commandBinder.issueCommand(new S.y8(e,I.U.OBJECT)),this.viewData.setOpenTagView(Object.assign({},t)),this.selectPin(e,!0),this.toolsData.toolCollapsed&&this.engine.commandBinder.issueCommand(new q.li(!1))):this.log.debug("Cannot dock a non-existent tag")}async openTag(e,t,i,n=!0){const a=this.viewData,s=a.getTagView(e);if(s){const{openTagView:r,tagsMode:d}=this.viewData,{commandBinder:l}=this.engine,{dockedAnnotation:h,selectedAnnotation:c}=this.annotationsViewData;i&&d===x.j.REORDERING&&a.setTagsMode(x.j.DEFAULT),i&&this.toolsData.toolCollapsed&&this.activated&&l.issueCommand(new q.li(!1));const m=(null==r?void 0:r.id)===e;if(m&&this.activated===i)return void this.log.debug("Tag is already open and "+(i?"docked":"undocked"));if(i!==!!h){const t=this.annotationsViewData.getCapabilities(e);i?t.dock&&!this.activated&&await this.engine.commandBinder.issueCommand(new q.Wm(Y.S0.TAGS,!0)):h&&await this.engine.commandBinder.issueCommand(new S.XK(h.id,h.annotationType))}if(!m&&this.opening!==e){this.opening=e,l.issueCommand(new Z.r),c&&c.id!==e&&await this.engine.commandBinder.issueCommand(new S.XK(c.id,c.annotationType)),a.setOpenTagView(Object.assign({},s));const i=a.getCapabilities(e);null!==t&&i.focus&&(n||this.viewmodeData.isInside())&&await this.engine.commandBinder.issueCommand(new g.E4({pinPosition:s,transition:t})).then((()=>{this.engine.broadcast(new be.Yt(s.id))})),this.engine.commandBinder.issueCommand(new V.Xx(s.id,o.jM.MATTERTAG)),setTimeout((()=>{this.opening=null}),0)}}else this.log.debug("Cannot open a non-existent tag")}isTagDocked(){const{dockedAnnotation:e}=this.annotationsViewData;return(null==e?void 0:e.annotationType)===I.U.TAG}getDockedTag(){const{dockedAnnotation:e}=this.annotationsViewData;return e&&e.annotationType===I.U.TAG?this.viewData.getTagView(e.id):null}getSelectedTag(){const{billboardAnnotation:e,billboardSelected:t}=this.annotationsViewData;return e&&t&&e.annotationType===I.U.TAG||(null==e?void 0:e.annotationType)===I.U.OBJECT?this.viewData.getTagView(e.id):null}trackChanges(e,t,i){const n=this.tagsData.getTag(e),{position:a,color:s,description:o,label:r,stemHeight:d,stemVisible:l,enabled:h,keywords:c}=t;if(!n&&a)return void this.engine.broadcast(new H.Y_(e,a,a.distanceTo(this.cameraData.pose.position)));if(void 0!==h&&n.enabled!==h&&this.engine.broadcast(new H.KW(e,z.U.ENABLED,h)),s){const t=new et.I(s.r,s.g,s.b).getHexString();n.color.getHexString()!==t&&this.engine.broadcast(new H.KW(e,z.U.DISC_COLOR,`#${t}`))}if(void 0!==d&&n.stemHeight!==d&&this.engine.broadcast(new H.KW(e,z.U.STEM_LENGTH,d)),void 0!==l&&n.stemVisible!==l&&this.engine.broadcast(new H.KW(e,z.U.STEM_VISIBLE,l)),void 0!==r&&n.label!==r&&(this.engine.broadcast(new H.KW(e,z.U.TITLE,r.length)),this.engine.broadcast(new H.On(e,r.length))),void 0!==o&&n.description!==o){this.engine.broadcast(new H.KW(e,z.U.DESCRIPTION,o.length));const t=this.descriptionParser.parse(o,this.layersData.getNonworkshopViewId());this.engine.broadcast(new H.GN(e,o.length,t));const i=y.g.getNumLinks(t);y.g.getNumLinks(n.parsedDescription)!==i&&this.engine.broadcast(new H.KW(e,z.U.LINKS,i))}if(i){const t=i?i.src:"",a=i?(0,f.KP)(i.mediaType):b.q.none;n.mediaSrc===t&&n.mediaType===a||(this.engine.broadcast(new H.KW(e,z.U.MEDIA,a)),this.engine.broadcast(new H.EX(e,a,t)))}const m=n.keywords.every((e=>!!c&&c.includes(e)));if((null==c?void 0:c.length)!==n.keywords.length||!m){const t=(null==c?void 0:c.length)||0;this.engine.broadcast(new H.KW(e,z.U.KEYWORDS,t))}}}const it=tt},81585:(e,t,i)=>{"use strict";i.d(t,{i:()=>n});class n{constructor(e){this.comparer=e||this.defaultComparer,this.poolArray=[]}add(e){const t=this.createObjectDescriptor(e);return t.object=e,t.inUse=!0,this.addObjectDescriptorToPool(t),t}get(e){for(const t of this.poolArray)if(!t.inUse&&this.comparer(t,e))return t.inUse=!0,t;return null}free(e){for(const t of this.poolArray)if(t.object===e)return t.inUse=!1,!0;return!1}all(){return this.poolArray}remove(e){const t=this.poolArray.findIndex((t=>t.object===e));return-1!==t&&(this.poolArray.splice(t,1),!0)}defaultComparer(e,t){return!0}createObjectDescriptor(e){return{object:e,inUse:!1}}addObjectDescriptorToPool(e){this.poolArray.push(e)}}},61825:(e,t,i)=>{"use strict";i.d(t,{Mq:()=>r,Zd:()=>o,_o:()=>d});var n=i(68909);const a=()=>Math.random(),s={},o=(e,t=a())=>(s[t]||(s[t]=new n.Vector4(a(),a(),a(),e)),s[t]),r=()=>new n.Color(a(),a(),a()),d=e=>e instanceof Object&&"r"in e&&"g"in e&&"b"in e},39142:e=>{e.exports="precision highp float;precision highp int;uniform samplerCube tMap;varying vec3 vUvw;void main(){vec4 color=textureCube(tMap,vec3(-vUvw.x,vUvw.yz));gl_FragColor=linearToOutputTexel(vec4(color.rgb,1.));}"},20736:e=>{e.exports="precision highp float;precision highp int;varying vec3 vUvw;void main(){vUvw=position;gl_Position=projectionMatrix*modelViewMatrix*vec4(position,1.);}"},38581:e=>{e.exports="precision highp float;precision highp int;varying vec2 vUv;uniform float progress;uniform float opacity;uniform sampler2D tNoHover;uniform sampler2D tHover;uniform sampler2D tPortal;void main(){vec4 noHoverColor=texture2D(tNoHover,vUv);vec4 hoverColor=texture2D(tHover,vUv);vec4 portalColor=texture2D(tPortal,vUv);float xToCtr=2.*vUv.x-1.;float yToCtr=2.*vUv.y-1.;float withinRadius=step(xToCtr*xToCtr+yToCtr*yToCtr,0.9);vec4 mixedPortalColor=mix(hoverColor,portalColor,withinRadius);mixedPortalColor=mix(mixedPortalColor,hoverColor,hoverColor.a);mixedPortalColor=mix(noHoverColor,mixedPortalColor,progress);mixedPortalColor.a=min(mixedPortalColor.a,opacity);gl_FragColor=linearToOutputTexel(mixedPortalColor);}"},24235:e=>{e.exports="precision highp float;precision highp int;varying vec2 vUv;void main(){vUv=uv;gl_Position=projectionMatrix*modelViewMatrix*vec4(position,1.);}"}}]);