"use strict";(self.webpackChunkmp_webgl=self.webpackChunkmp_webgl||[]).push([[6457],{66871:(t,a,i)=>{i.d(a,{d:()=>s});var e=i(84229);class s extends e.t{constructor(t="Unhandled Transition Exception"){super(t),this.name="TransitionException"}}},82634:(t,a,i)=>{i.d(a,{cm:()=>o,dZ:()=>s,tf:()=>r});var e=i(18268);class s extends e.u{}s.id="RESET_PITCH";class o extends e.u{}o.id="ENABLE_AUTO_ORTHO";class r extends e.u{}r.id="DISABLE_AUTO_ORTHO"},60052:(t,a,i)=>{i.r(a),i.d(a,{TRANSITION_DISTANCE_MULTIPLIER:()=>E,baseTransitionSpeedKey:()=>j,default:()=>A});var e=i(68909);var s=i(40888),o=i(90280),r=i(94298),n=i(23205),c=i(45018),h=i(14754);class m extends h.QB{constructor(t,a){super(),this.from=a,this.to=t,this.timestamp=Date.now()}}class l extends m{}var p=i(71294),u=i(79953),d=i(99817),D=i(28997),T=i(53366),f=i(43998),v=i(24009),y=i(71136),b=i(82634),g=i(66871);class x extends g.d{constructor(t="Unhandled Camera Exception"){super(t),this.name="CameraTransitionException"}}class k extends g.d{constructor(t="Cannot move while the camera is already moving"){super(t),this.name="CameraTransitionException"}}var P=i(1803);class C{constructor(t,a){this.proxy=t,this.target=a}updateCameraPose(t){this.proxy.activeSession(this)&&this.target.updateCameraPose(t)}beginExternalTransition(){this.proxy.activeSession(this)&&this.target.beginExternalTransition()}endExternalTransition(){this.proxy.activeSession(this)&&this.target.endExternalTransition()}updateCameraPosition(t){this.proxy.activeSession(this)&&this.target.updateCameraPosition(t)}updateCameraRotation(t){this.proxy.activeSession(this)&&this.target.updateCameraRotation(t)}updateCameraFocus(t){this.proxy.activeSession(this)&&this.target.updateCameraFocus(t)}updateCameraProjection(t){this.proxy.activeSession(this)&&this.target.updateCameraProjection(t)}moveTo(t){return this.proxy.activeSession(this)?this.target.moveTo(t):p.i.resolve()}}class B{constructor(t,a){this.controller=t,this.data=a,this.proxies=[]}get pose(){return this.data}activeSession(t){if(0===this.proxies.length)return!1;return this.proxies[this.proxies.length-1].controller===t}newSession(t){let a=null;if(-1!==this.proxies.findIndex((a=>a.requester===t)))throw new Error("Cannot create two sessions with the same requester");return(0,P.Sh)((()=>{if(!a){if(this.proxies.length>0){const t=this.proxies[this.proxies.length-1];t.requester.onAccessRevoked(t.controller)}a=new C(this,this.controller),this.proxies.push({controller:a,requester:t}),t.onAccessGranted(a)}}),(()=>{if(a){const t=this.proxies.findIndex((t=>t.controller===a));if(-1!==t){const a=this.proxies[t],i=t===this.proxies.length-1;if(i&&a.requester.onAccessRevoked(a.controller),this.proxies.splice(t,1),this.proxies.length>0&&i){const t=this.proxies[this.proxies.length-1];t.requester.onAccessGranted(t.controller)}}}}))}}var w=i(39591),S=i(35223);const O={[y.fl.Instant]:{blackoutTime:0,transitionTime:0},[y.fl.FadeToBlack]:{blackoutTime:d.Ay.camera.transitionBlackoutTime,transitionTime:2*d.Ay.camera.transitionBlackoutTime},[y.fl.Interpolate]:{blackoutTime:0,transitionTime:d.Ay.camera.transitionFadeTime},[y.fl.MoveToBlack]:{blackoutTime:d.Ay.camera.transitionBlackoutTime,transitionTime:d.Ay.camera.transitionFadeTime},[y.fl.OrbitTo]:{blackoutTime:0,transitionTime:d.Ay.camera.transitionFadeTime}},E=166,j="Transition time";class A extends n.n{constructor(){super(...arguments),this.name="camera-data",this.transitionSpeed=d.Ay.camera.transitionSpeed,this.baseTransitionTime=d.Ay.camera.baseTransitionTime,this.eulerCache=new e.Euler,this.quaternionCache=new e.Quaternion,this.computeOrbitDistance=()=>{if(this.visibleMeshBounds){const t=this.cameraData.pose,a=new e.Ray(t.position.clone(),t.forward().clone());return this.visibleMeshBounds.computeFocusPoint(a).distanceTo(t.position)/t.fovDistanceScale()}return this.cameraData.pose.fovCorrectedFocalDistance()}}async init(t,a){this.engine=a,this.market=a.market,this.canvas=await a.market.waitForData(T.p),this.cameraData=new c.M(this.canvas.width,this.canvas.height),this.market.register(this,c.M,this.cameraData),this.cameraPoseProxy=((t,a)=>new B(t,a))(this,this.cameraData.pose),a.market.waitForData(D.o).then((t=>{this.bindings.push(t.onPropertyChanged(j,(t=>{this.baseTransitionTime=t})),a.commandBinder.addBinding(b.cm,(async()=>{this.cameraData.setAutoOrtho(!0)})),a.commandBinder.addBinding(b.tf,(async()=>{this.cameraData.setAutoOrtho(!1)})))})),a.getModuleBySymbol(S.UN).then((t=>this.visibleMeshBounds=t)),this.bindings.push(a.commandBinder.addBinding(b.dZ,(async()=>this.resetPitch())),a.subscribe(r.h,(t=>this.cameraData.setCameraDimensions(t.width,t.height))))}onUpdate(t){}fromPose(t=!1){const a=this.cameraData.pose;return{position:t?a.fovCorrectedPosition().clone():a.position.clone(),rotation:a.rotation.clone(),projection:a.projection.clone(),focalDistance:t?a.fovCorrectedFocalDistance():a.focalDistance}}updateCameraPosition(t){this.cameraData.pose.position.copy(t),this.cameraData.pose.commit()}updateCameraProjection(t){this.cameraData.pose.projection.copy(t),this.cameraData.pose.commit()}updateCameraFocus(t){this.cameraData.pose.focalDistance=t,this.cameraData.pose.commit()}updateCameraRotation(t){this.cameraData.pose.rotation.copy(t),this.cameraData.pose.commit()}updateCameraPose(t){this.cameraData.pose.copy(t),this.cameraData.pose.commit()}resetPitch(){this.eulerCache.setFromQuaternion(this.cameraData.pose.rotation,"YXZ"),this.eulerCache.x=0,this.eulerCache.z=0,this.quaternionCache.setFromEuler(this.eulerCache),this.updateCameraRotation(this.quaternionCache)}canTransition(){return this.cameraData.canTransition()}moveTo(t){if(!this.canTransition())return p.i.reject(new k("Tried to start transition while another transition was active"));const a=O[t.transitionType],i=t.pose.rotation,e=t.pose.position,s=null==t.fadeToBlackSubType?y.pw.Full:t.fadeToBlackSubType;let r=t.projection;t.autoOrtho?r=void 0:t.pose.zoom&&(r&&(0,o.Gp)(r)||this.cameraData.isOrtho())&&(r=this.adjustProjectionZoom(r||this.cameraData.pose.projection.clone(),t.pose.zoom));const n=void 0!==t.blackoutTime?t.blackoutTime:a.blackoutTime,c=t.transitionType,h=t.transitionSpeedMultiplier?1/t.transitionSpeedMultiplier:1;let d=c===y.fl.Instant?0:t.transitionTime;if(void 0===d)if(t.transitionType===y.fl.Interpolate&&e){const t=e.distanceTo(this.cameraData.pose.position);d=this.baseTransitionTime+Math.log2(1+t)*E*this.transitionSpeed*h}else d=a.transitionTime;const D=this.fromPose(!!t.autoOrtho),T=c===y.fl.OrbitTo?t.targetPhi:void 0,b=c===y.fl.OrbitTo?u.p9:t.easing;this.beginInternalTransition({transitionType:c,transitionTime:d,blackoutTime:n,pose:{position:e,rotation:i},autoOrtho:!!t.autoOrtho,projection:r,easing:b,rotationDelay:t.rotationDelay||0,rotationDuration:t.rotationDuration||1,matrixDelay:t.matrixDelay||0,matrixDuration:t.matrixDuration||1,focalDistance:t.focalDistance||D.focalDistance,targetPhi:T,fadeToBlackSubType:s});const g={position:t.pose.position?t.pose.position.clone():void 0,rotation:t.pose.rotation?t.pose.rotation.clone():void 0,projection:t.projection?t.projection.clone():void 0,focalDistance:t.focalDistance?t.focalDistance:void 0};this.engine.broadcast(new m(g,D));const P=this.cameraData.transition.promise;if(!P)return p.i.reject(new x("Expected promise to have been created."));const C=this.progressInternalTransition.bind(this),B=this.shouldProgressInternalTransition.bind(this),w=this.endInternalTransition.bind(this),S=this;return P.notify(0),this.engine.startGenerator((function*(){let a=16;for(a>=S.cameraData.transition.duration&&(P.notify(.5),yield new v.oN);B(a);){C(a,n);const t=(0,f.qE)(a/S.cameraData.transition.duration,0,1);P.notify(t),yield new v.oN,a=16+Date.now()-S.cameraData.transition.startTime}w(t.transitionType),S.cameraData.commit(),P.notify(1),P.resolve(),S.engine.broadcast(new l(g,D))})),P.promise()}get transitionActive(){return this.cameraData.transition.active}setBaseProjection(t){this.cameraData.setBaseProjection(t)}async cancelTransition(){if(this.cameraData.transition.active)return new Promise((t=>{(0,c.q)(this.cameraData.pose,this.cameraData.transition.to,!1);const a=Date.now()-this.cameraData.transition.startTime;this.cameraData.transition.duration=a,this.cameraData.transition.progress.stop(1),this.cameraData.pose.commit(),this.cameraData.transition.commit();const i=this.cameraData.transition.onPropertyChanged("active",(a=>{a||(i&&i.cancel(),t())}))}))}updateTransitionSpeed(t){if(this.cameraData.transition.active){const a=Date.now(),i=a-this.cameraData.transition.startTime,e=i/t,s=this.cameraData.transition.progress,o=(s.duration-i)/t+e;this.cameraData.transition.duration=o,this.cameraData.transition.startTime=a-e,s.modifyAnimation(s.value,s.endValue,o,s.easing,e),this.cameraData.transition.commit()}}beginExternalTransition(){this.cameraData.transition.activeInternal||(this.cameraData.transition.startTime=Date.now(),this.cameraData.transition.active=!0,this.cameraData.transition.promise=new p.i,this.cameraData.transition.commit())}endExternalTransition(){var t;this.cameraData.transition.activeInternal||(this.cameraData.transition.active=!1,null===(t=this.cameraData.transition.promise)||void 0===t||t.resolve(),this.cameraData.transition.commit())}beginInternalTransition(t){const a=t.transitionTime||0;if(this.cameraData.transition.startTime=Date.now(),this.cameraData.transition.duration=a,this.cameraData.transition.active=!0,this.cameraData.transition.promise=new p.i,this.cameraData.transition.activeInternal=!0,this.cameraData.transition.type=t.transitionType,this.cameraData.transition.progress.modifyAnimation(0,1,a,t.easing||u.dV),this.cameraData.transition.rotationDelay=t.rotationDelay||0,this.cameraData.transition.rotationDuration=t.rotationDuration||1,this.cameraData.transition.matrixDelay=t.matrixDelay||0,this.cameraData.transition.matrixDuration=t.matrixDuration||1,this.cameraData.transition.autoOrtho=!!t.autoOrtho,this.cameraData.transition.fadeToBlackSubType=t.fadeToBlackSubType||y.pw.Full,t.transitionType===y.fl.FadeToBlack&&(this.cameraData.transition.blackoutProgress.modifyAnimation(0,1,t.blackoutTime,u.p9),this.cameraData.transition.fadeToBlackSubType===y.pw.BlackToClear&&this.cameraData.transition.blackoutProgress.updateAbsolute(t.blackoutTime)),t.transitionType===y.fl.MoveToBlack){const t=500;this.cameraData.transition.blackoutProgress.modifyAnimation(0,1,a-2*t,u.sP,0,t)}this.cameraData.transition.from=this.fromPose(!!t.autoOrtho),this.cameraData.transition.to.position=t.pose.position?t.pose.position.clone():void 0,this.cameraData.transition.to.rotation=t.pose.rotation?t.pose.rotation.clone():void 0,this.cameraData.transition.to.projection=t.projection?t.projection.clone():void 0,this.cameraData.transition.to.focalDistance=t.focalDistance?t.focalDistance:void 0,t.transitionType===y.fl.FadeToBlack&&this.cameraData.transition.fadeToBlackSubType===y.pw.BlackToClear&&(0,c.q)(this.cameraData.transition.to,this.cameraData.pose,!1),null!=t.targetPhi&&(this.cameraData.transition.orbitStartDistance=this.computeOrbitDistance(),this.cameraData.transition.orbitTarget=t.targetPhi,this.cameraData.transition.orbitStartPhi=this.cameraData.pose.phi(),this.cameraData.transition.instantOrbit=!(a>0),this.cameraData.pose.focalDistance=this.cameraData.transition.orbitStartDistance*this.cameraData.pose.fovDistanceScale()),this.cameraData.transition.commit()}shouldProgressInternalTransition(t){return this.cameraData.transition.type===y.fl.OrbitTo?this.cameraData.transition.progress.value<1:t<this.cameraData.transition.duration}progressInternalTransition(t,a){if(this.cameraData.transition.active){if(this.cameraData.transition.progress.updateAbsolute(t),this.cameraData.transition.type===y.fl.Interpolate)this.updateInterpolateTransition();else if(this.cameraData.transition.type===y.fl.FadeToBlack){let i=0;const e=this.cameraData.transition.duration;this.cameraData.transition.fadeToBlackSubType===y.pw.Full?t<=a?i=t:((0,c.q)(this.cameraData.transition.to,this.cameraData.pose,!1),i=t>=e-a?e-t:a):this.cameraData.transition.fadeToBlackSubType===y.pw.ClearToBlack?t<=a?i=t:((0,c.q)(this.cameraData.transition.to,this.cameraData.pose,!1),i=a):this.cameraData.transition.fadeToBlackSubType===y.pw.BlackToClear&&(i=t>=e-a?e-t:a),this.cameraData.transition.blackoutProgress.updateAbsolute(i),this.cameraData.transition.progress.updateAbsolute(t<=a?0:e)}else if(this.cameraData.transition.type===y.fl.MoveToBlack){const a=this.cameraData.transition.blackoutProgress;this.updateInterpolateTransition(),a.updateAbsolute(t-a.delay)}else this.cameraData.transition.type===y.fl.OrbitTo&&this.updateOrbitToTransition();this.cameraData.pose.commit(),this.cameraData.transition.commit()}}updateOrbitToTransition(){if(null!=this.cameraData.transition.orbitTarget){const t=(0,w.n4)(this.cameraData.pose,this.cameraData.transition.orbitTarget,this.cameraData.transition.orbitStartPhi,this.cameraData.transition.orbitStartDistance,this.cameraData.transition.instantOrbit,this.cameraData.pose);this.cameraData.transition.progress.updateProgress(t)}}updateInterpolateTransition(){const t=this.cameraData.transition.from,a=this.cameraData.transition.to;if(a.position&&t.position&&this.cameraData.pose.position.copy(t.position).lerp(a.position,this.cameraData.transition.progress.value),a.focalDistance&&t.focalDistance&&(this.cameraData.pose.focalDistance=(0,s.C)(t.focalDistance,a.focalDistance,this.cameraData.transition.progress.value)),a.rotation&&t.rotation){const i=(0,u.jv)(this.cameraData.transition.progress.easing,this.cameraData.transition.progress.value,this.cameraData.transition.progress.elapsed,this.cameraData.transition.progress.duration*this.cameraData.transition.rotationDuration,this.cameraData.transition.rotationDelay);this.cameraData.pose.rotation.copy(t.rotation).slerp(a.rotation,i)}if(this.cameraData.transition.autoOrtho)this.cameraData.pose.resetProjMatrix(),this.cameraData.pose.applyPhiBasedFovSquish();else if(a.projection&&t.projection){const i=(0,u.jv)(u.p_,this.cameraData.transition.progress.value,this.cameraData.transition.progress.elapsed,this.cameraData.transition.progress.duration*this.cameraData.transition.matrixDuration,this.cameraData.transition.matrixDelay);!function(t,a,i,e){const s=e.elements,o=t.elements,r=a.elements;for(let t=0;t<16;t++)s[t]=o[t]*(1-i)+r[t]*i}(t.projection,a.projection,i,this.cameraData.pose.projection)}}endInternalTransition(t){t!==y.fl.OrbitTo&&((0,c.q)(this.cameraData.transition.to,this.cameraData.pose,!1),this.cameraData.transition.autoOrtho&&(this.cameraData.pose.resetProjMatrix(),this.cameraData.pose.applyPhiBasedFovSquish())),this.cameraData.transition.type=null,this.cameraData.transition.active=!1,this.cameraData.transition.activeInternal=!1,this.cameraData.transition.progress.stop(1),t!==y.fl.FadeToBlack&&t!==y.fl.MoveToBlack||(this.cameraData.transition.fadeToBlackSubType===y.pw.ClearToBlack?this.cameraData.transition.blackoutProgress.stop(1):this.cameraData.transition.blackoutProgress.stop(0)),this.cameraData.pose.commit(),this.cameraData.transition.commit()}adjustProjectionZoom(t,a){const i=1/a;return t.elements[0]=i/this.canvas.aspectRatio,t.elements[5]=i,t}}},32981:(t,a,i)=>{i.d(a,{Qm:()=>n,SK:()=>s,Ve:()=>c,_w:()=>r,jF:()=>o});var e=i(13686);class s extends e.E{constructor(t,a,i,e,s=0){super(),this.position=t,this.buttons=a,this.device=i,this.ctrlKey=e,this.pointerId=s}}class o extends e.E{constructor(t,a,i,e,s,o=0){super(),this.ctrlKey=!1,this.position=t,this.clientPosition=e,this.delta=a,this.buttons=i,this.device=s,this.pointerId=o}}class r extends e.E{constructor(t,a,i,e,s,o,r=0){super(),this.ctrlKey=!1,this.position=t,this.delta=a,this.buttons=i,this.timeSinceLastMove=e,this.fullDelta=s,this.device=o,this.pointerId=r}}class n extends e.E{constructor(t,a){super(),this.position=t,this.pointer=a}}class c extends e.E{constructor(t,a,i,e){super(),this.position=t,this.startPosition=a,this.fullDelta=i,this.pointer=e}}},33518:(t,a,i)=>{i.d(a,{k:()=>s});var e=i(42399);class s extends e.T{constructor(t,a,i){super(),this.key=t,this.state=a,this.modifiers=i}}},75650:(t,a,i)=>{i.d(a,{$3:()=>r,CD:()=>o});var e=i(42399);class s extends e.T{}class o extends s{constructor(t,a,i,e,s,o,r){super(),this.id=t,this.position=a,this.clientPosition=i,this.button=e,this.down=s,this.device=o,this.nativeEvent=r}}class r extends s{constructor(t,a,i,e,s,o){super(),this.id=t,this.position=a,this.clientPosition=i,this.buttons=e,this.device=s,this.nativeEvent=o}}},80399:(t,a,i)=>{i.d(a,{O:()=>o});var e=i(61589),s=i(78652);class o extends e.B{constructor(){super(...arguments),this.name="interaction",this._source=o.defaultSource,this._mode=o.defaultMode}static get defaultMode(){return s.o.Desktop}static get defaultSource(){return s.m.None}get mode(){return this._mode}get source(){return this._source}updateSource(t){this._source=t}updateMode(t){this._mode=t}hasController(t=this.mode){return t===s.o.VrWithController||t===s.o.VrWithTrackedController}isVR(t=this.mode){return t===s.o.VrOrientOnly||t===s.o.VrWithTrackedController||t===s.o.VrWithController||t===s.o.VrTransientPointer||-1!==t.indexOf(s.o.VrUnknown)}isMobile(t=this.mode){return t===s.o.Mobile}}},27483:(t,a,i)=>{i.d(a,{J:()=>o,b:()=>s});var e=i(14754);class s extends e.QB{constructor(t,a){super(),this.mode=t,this.fromMode=a}}class o extends e.QB{constructor(t){super(),this.source=t}}},90302:(t,a,i)=>{i.d(a,{aV:()=>r,c$:()=>o,f_:()=>n});var e=i(94221);const s=t=>t instanceof e.r,o=t=>s(t),r=t=>s(t)&&t.raycastEnabled&&t.visible,n=t=>{let a=t.visible;a&&t.traverseAncestors((t=>{a&&(a=t.visible)}));return!o(t)&&a||r(t)}},80379:(t,a,i)=>{i.d(a,{F:()=>s});var e=i(18268);class s extends e.u{constructor(t){super(),this.payload=t}}s.id="SAVE_COMMAND"},28743:(t,a,i)=>{i.d(a,{aF:()=>r,lo:()=>s,ul:()=>o});var e=i(14754);class s extends e.QB{constructor(t){super(),this.pixelRatio=t}}class o extends e.QB{constructor(t){super(),this.event=t}}class r extends e.QB{constructor(t){super(),this.event=t}}},15151:(t,a,i)=>{i.d(a,{Z:()=>s});var e=i(55150);function s(t){if(t&&"object"==typeof t&&"x"in t&&"y"in t&&"z"in t){const a=t;return(0,e.Et)(a.x)&&(0,e.Et)(a.y)&&(0,e.Et)(a.z)}return!1}}}]);