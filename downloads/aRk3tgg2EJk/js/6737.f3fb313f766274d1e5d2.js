"use strict";(self.webpackChunkmp_webgl=self.webpackChunkmp_webgl||[]).push([[6737],{76879:(i,n,t)=>{t.d(n,{Z:()=>s,u:()=>a});var e=t(14754);class a extends e.QB{constructor(i,n,t){super(),this.name=i,this.version=n,this.loadTime=t}}class s{constructor(){this.handlers=[{msgType:a,func:(i,n,t)=>{i.track("plugin_loaded",{name:n.name,version:n.version,time:n.loadTime})}}]}}},98741:(i,n,t)=>{t.d(n,{My:()=>d,W:()=>r,YB:()=>s,ho:()=>a,nq:()=>o,u3:()=>l});var e=t(18268);class a extends e.u{constructor(i){super(),this.payload={exclude:i||[]}}}a.id="PLUGIN_RESET_ALL";class s extends e.u{constructor(i,n,t,e){super(),this.payload={name:i,config:n,configMeta:t,permissions:e||{}}}}s.id="PLUGIN_RELOAD";class o extends e.u{constructor(i,n,t,e){super(),this.payload={name:i,config:n,configMeta:t,permissions:e||{}}}}o.id="PLUGIN_LOAD";class l extends e.u{constructor(i){super(),this.payload={name:i}}}l.id="PLUGIN_UNLOAD";class d extends e.u{constructor(i,n){super(),this.payload={operation:i,callback:n}}}d.id="PLUGIN_CONFIG_FETCH_DATA";class r extends e.u{constructor(i,n){super(),this.payload={attachmentId:i,pluginId:n}}}r.id="ATTACHMENT_ASSOCIATE_WITH_PLUGIN";class c extends e.u{constructor(i,n){super(),this.payload={attachmentId:i,pluginId:n}}}c.id="ATTACHMENT_DISSOCIATE_FROM_PLUGIN"},41391:(i,n,t)=>{t.r(n),t.d(n,{default:()=>P});var e=t(80328),a=t(35223),s=t(36038),o=t(23205),l=t(23893),d=t(40859),r=t(47905),c=t(64294),u=t(98741),g=t(76879),h=t(35596),p=t(33020),f=t(74435),m=t(60966),y=t(59712),v=t(28997);class w{getFactory(i){return i.messengerFactory}}class P extends o.n{constructor(){super(...arguments),this.name="plugin",this.data=new d.C,this.allowLoad=!1,this.allowLiveReload=!0,this.pluginOverlayElements=new Map,this.applicationType=void 0,this.onResetPlugins=async({exclude:i})=>{await this.unloadPlugins(i),await this.loadConfigured(i)},this.onLoadPlugin=async({config:i,configMeta:n,permissions:t},e)=>{var a;if(this.allowLiveReload&&e){const s={properties:n,required:[]};for(const i of Object.keys(s.properties)){(null===(a=s.properties[i].required)||void 0===a?void 0:a.includes(i))&&s.required.push(i)}if(!this.jsonSchemaValidator.validate(s,i))return;await this.load(Object.assign(Object.assign(Object.assign({},e),{config:i}),t))}},this.onUnloadPlugin=async i=>{if(this.allowLiveReload&&i){const n={applicationKey:i.applicationKey,id:i.id};await this.unload(n)}},this.onReloadPlugin=async({name:i,config:n,configMeta:t,permissions:e},a)=>{this.allowLiveReload&&(await this.onUnloadPlugin(a),this.debouncedOnLoadPlugin({name:i,config:n,configMeta:t,permissions:e},a))},this.debouncedOnReloadPlugin=(0,f.s)(this.onReloadPlugin,500),this.onReloadPluginCommand=async i=>{if(!this.allowLiveReload)return;let n=this.configuredPlugins.find((n=>n.id===i.name));n||(n=this.createLoadableConfig(i.name)),this.debouncedOnReloadPlugin(i,n)},this.debouncedOnLoadPlugin=(0,f.s)(this.onLoadPlugin,500),this.onLoadPluginCommand=async i=>{this.debouncedOnLoadPlugin(i,this.createLoadableConfig(i.name))},this.debouncedOnUnloadPlugin=(0,f.s)(this.onUnloadPlugin,500),this.onUnloadPluginCommand=async i=>{let n=this.configuredPlugins.find((n=>n.id===i.name));if(!n){const t=this.availablePlugins.get(i.name);t&&(n={applicationKey:t.applicationKey,id:t.name})}this.debouncedOnUnloadPlugin(n)},this.onFetchSdkDataCommand=async i=>{const n=await this.engine.diContainer.resolve("$ServiceSdk"),[t,e]=i.operation.split(".");let a;try{const i=n[t][e];a=i.subscribe?await new Promise(((n,t)=>{const e=i.subscribe((i=>{e.cancel(),n(i)}))})):await i()}catch(n){throw new Error("Failed to run command: "+i.operation)}i.callback(a)}}async init(i,n){if(this.jsonSchemaValidator=i.jsonSchemaValidator,this.commandBinder=n.commandBinder,[this.ses,this.sdk,this.pluginConfigDataModule,this.pluginUIData,this.settings]=await Promise.all([n.getModuleBySymbol(a.JY),n.getModuleBySymbol(e.S1),n.getModuleBySymbol(a.lf),n.market.waitForData(l.kR),n.market.waitForData(v.o)]),this.separator=this.pluginUIData.separator,this.engine=n,this.allowLoad=i.pluginPolicies.enabled,this.allowLiveReload=this.allowLoad&&!this.pluginConfigDataModule.pluginConfigData.disabled&&!this.pluginConfigDataModule.pluginConfigData.preventLiveEdit,this.allowLoad&&this.initializeServiceConnection(),this.allowLoad){const i=n.subscribe(p.uv,(async({phase:t,application:e})=>{if(t===h.Jj.PLAYING)if(i.cancel(),this.applicationType=e,this.allowLiveReload){if(await this.loadConfigured(),!this.settings.getOverrideParam(c.L$,!1)){const t=n.subscribe(p.Fj,(async n=>{this.log.devInfo("Switch in active application detected by plugin system: ",n.application),n.application===h.lg.WORKSHOP&&(await this.loadEditOnly(),i.cancel())}));this.bindings.push(t)}}else this.log.devInfo("Reached PLAYING stage, checking whether configured plugins need to load to start: ",e),e===h.lg.SHOWCASE&&await this.loadConfigured(),this.bindings.push(n.subscribe(p.Fj,(async i=>{if(this.log.devInfo("Switch in active application detected by plugin system: ",i.application),i.application===h.lg.WORKSHOP)try{await this.disposeAll()}catch(i){this.log.debugWarn("Entering workshop, one or more plugins failed to dispose properly:",i)}else i.application===h.lg.SHOWCASE&&await this.loadConfigured()})))}))}this.bindings.push(n.commandBinder.addBinding(u.ho,this.onResetPlugins),n.commandBinder.addBinding(u.YB,this.onReloadPluginCommand),n.commandBinder.addBinding(u.nq,this.onLoadPluginCommand),n.commandBinder.addBinding(u.u3,this.onUnloadPluginCommand),n.commandBinder.addBinding(u.My,this.onFetchSdkDataCommand),n.commandBinder.addBinding(m.J,this.handlePluginVisibility.bind(this))),n.market.register(this,d.C,this.data)}initializeServiceConnection(){const i=this.pluginConfigDataModule.serviceSdkKey;this.engine.diContainer.bindAsyncFactory("$ServiceSdk",(()=>s.p.connect({connect:()=>this.sdk.connectPlugin(i,"PluginConfigRootConnection"),cancelConnecting:()=>{}},new w,window)))}async handlePluginVisibility(i){for(const n of i.ids)this.data.visibilityData.set(n,i.value),this.toggleVisibility(n,i.value)}toggleVisibility(i,n){var t;null===(t=this.pluginOverlayElements.get(i))||void 0===t||t.classList.toggle("hidden",!n),this.commandBinder.issueCommand(new y.b(i,n))}async loadEditOnly(){var i,n;this.availablePlugins=this.pluginConfigDataModule.pluginConfigData.availablePlugins;const t=this.availablePlugins.values.filter((i=>{var n;return null===(n=i.options)||void 0===n?void 0:n.editOnly}));if(t.length>0){const e=t.map((i=>i.name));this.log.debug("Loading editOnly plugins: "+e.join(", "));const a=[];for(const e of t){const t={id:e.name,src:e.src,config:e.config,outputs:e.outputs,applicationKey:e.applicationKey,strict:e.strict,peerDependencies:e.peerDependencies,canPlaceInGrid:null===(i=e.options)||void 0===i?void 0:i.canPlaceInGrid,hideViewToggle:null===(n=e.options)||void 0===n?void 0:n.hideViewToggle};a.push(this.load(t))}await Promise.all(a)}}async loadConfigured(i=[]){if(!this.pluginConfigDataModule.pluginConfigData.disabled)return this.pluginConfigDataModule.registryLoaded?void await this.updatePluginDataAndLoad(i):new Promise((n=>{this.registrySubscription=this.pluginConfigDataModule.registryLoadedObservable.onChanged((async t=>{t&&(await this.updatePluginDataAndLoad(i),n())}))}));this.log.debug("Cannot load plugins! Disabled by URL parameter.")}async updatePluginDataAndLoad(i){this.configuredPlugins=await this.pluginConfigDataModule.getConfiguredPlugins(this.applicationType),this.availablePlugins=this.pluginConfigDataModule.pluginConfigData.availablePlugins,this.data.visibilityData.replace(this.configuredPlugins.filter((i=>!i.hideViewToggle)).reduce(((i,n)=>{var t;return i[n.id]=null===(t=this.data.visibilityData.get(n.id))||void 0===t||t,i}),{})),this.log.debug("Combined configuration with registry data, loading plugins: "+JSON.stringify(this.configuredPlugins,void 0,2)),await this.waitForPluginLoad(i)}async waitForPluginLoad(i){var n;if(!this.configuredPlugins)return void this.log.error("Waiting for load before plugin records fetched.");const t=[];for(const i of this.configuredPlugins)t.push(this.load(i).then((()=>{this.engine.broadcast(new g.u(i.id,i.src,Date.now()-performance.timing.navigationStart))})));try{await Promise.all(t)}catch(i){this.log.warn("Issues were encountered loading configured plugins.")}for(const t of this.pluginOverlayElements.keys()){if(i.includes(t))continue;const e=this.data.visibilityData.get(t);null===(n=this.pluginOverlayElements.get(t))||void 0===n||n.classList.toggle("hidden",!e)}}async fetchPlugin(i,n,t,e,a){e.strict&&this.ses.freezeForStrict();const s=await this.ses.makeSecureEnvironment(i+`${t?this.separator+t:""}`,n,e,this.pluginConfigDataModule.pluginConfigData.eventTarget,a);if(s){return[s,s.compartment.globalThis.plugin]}return null}async unload(i){const n=i.id&&""!==i.id?i.id:"default",t={applicationKey:i.applicationKey,id:n},e=this.data.get(t);let a=null;if(e){try{a=e.dispose()}catch(i){this.log.warn("An error occurred when disposing a plugin, it may be in a partially disposed state",i)}this.data.delete(t)}return a||Promise.resolve()}async load(i){var n;const{applicationKey:t,src:e,id:a,strict:s,fetchLevel:o=r.D.None,peerDependencies:l,canPlaceInGrid:d}=i;if(!this.allowLoad){const i=e.startsWith("http")?e:`${e.substring(0,16)}...`;return Promise.reject(`Load for plugin <${a}:${i}> requested, but plugin system is not available.`)}if(t.includes(this.separator))return Promise.reject(`Application Key cannot contain the separator character: ${this.separator}`);if(a.includes(this.separator))return Promise.reject(`Plugin ID cannot contain the separator character: ${this.separator}`);const c=void 0===s||s,u=a||"default",g={applicationKey:t,id:u};if(this.data.get(g))return Promise.reject(`Plugin for ${t}-${u} already loaded.`);const h={strict:c,canFetch:o>=r.D.AnonymousFetch,canFetchAsUser:o>=r.D.UserFetch,canStoreLocal:!0,canPlaceInGrid:d||!1},[p,f]=await this.fetchPlugin(t,e,u,h,l)||[];if(p&&f){const e=null===(n=p.overlayElement)||void 0===n?void 0:n.querySelector(`.${t}${this.separator}${a}`);e&&!i.hideViewToggle&&(this.pluginOverlayElements.set(u,e),this.data.visibilityData.set(u,!0)),await this.initPlugin(p,f.factory,i,u)}}async initPlugin(i,n,t,e){const a=n(),{applicationKey:o,id:l,config:d}=t;let r=()=>{};const c=a.onInit||a.init;let u=Promise.resolve();if(c){class i{constructor(i){this.sdk=i}connect(){return this.sdk.connectPlugin(o,l)}cancelConnecting(){}}const n=await s.p.connect(new i(this.sdk),new w,window);u=c.call(a,n,d),r=()=>n.disconnect()}const g=this.pluginConfigDataModule.pluginConfigData.eventTarget,h=this.setupVisibilityEvents(g);async function p(){const n=a.onDestroy||a.dispose;return((null==n?void 0:n.call(a))||Promise.resolve()).finally((()=>{r(),h.cancel(),g.delete(e),i.dispose()}))}const f={applicationKey:o,id:l};try{return await u,this.data.set(f,a,p),Promise.resolve()}catch(i){this.log.warn("Plugin initialization failed: ",i),this.log.debugWarn("Attemptying dispose for clean up...");try{await p()}catch(i){this.log.warn("Auto-cleanup of plugin had errors: ",i)}return Promise.reject(i)}}setupVisibilityEvents(i){const n=async(i,n)=>{"_CLOSE_"===i.name&&await this.engine.commandBinder.issueCommand(new m.J([n],!1))};return i.onElementChanged({onAdded:n,onUpdated:n})}dispose(i){super.dispose(i),this.registrySubscription.cancel(),this.disposeAll().catch((i=>{this.log.warn("One or more plugins failed to dispose properly.",i)}))}disposeAll(){return this.configuredPlugins=[],this.unloadPlugins()}unloadPlugins(i=[]){this.log.devInfo("Unloading all plugins...except: "+i.join(", "));const n=[];for(const[t,e]of this.data.plugins.entries()){const a=t.split(".")[1];i.includes(a)||(n.push(e.dispose()),this.data.plugins.delete(t))}return Promise.all(n)}createLoadableConfig(i){var n,t;const e=this.availablePlugins.get(i),{src:a,config:s,applicationKey:o,strict:l,outputs:d,peerDependencies:r}=e;return{id:i,src:a,config:s,outputs:d,applicationKey:o,strict:l,peerDependencies:r,canPlaceInGrid:null===(n=e.options)||void 0===n?void 0:n.canPlaceInGrid,hideViewToggle:null===(t=e.options)||void 0===t?void 0:t.hideViewToggle}}}},59712:(i,n,t)=>{t.d(n,{b:()=>a});var e=t(18268);class a extends e.u{constructor(i,n){super(),this.payload={owner:i,isVisible:n}}}a.id="TOGGLE_SCENES_BY_OWNER"},36038:(i,n,t)=>{t.d(n,{p:()=>e});var e,a=t(51196);!function(i){const n=new a.o;i.connect=async function(i,t,e){let a;try{a=await i.connect()}finally{i.cancelConnecting()}return function(i,n,t,e){return new n(t,i).build(e)}(e,await async function(i){if(!i)throw new Error("Unabled to load the sdk");try{const t=await n.load(i,"sdk-client");if(t&&t.SdkBuilder&&"function"==typeof t.SdkBuilder)return t.SdkBuilder}catch(i){}throw Error(`Could not load the sdk from ${i}`)}(a.scriptUrl),t.getFactory(a),a.serializedInterface)}}(e||(e={}))}}]);