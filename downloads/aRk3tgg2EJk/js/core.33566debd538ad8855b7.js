(self.webpackChunkmp_webgl=self.webpackChunkmp_webgl||[]).push([[9114],{11826:(e,t,i)=>{var s={kind:"Document",definitions:[{kind:"OperationDefinition",operation:"query",name:{kind:"Name",value:"GetModelOptions"},variableDefinitions:[{kind:"VariableDefinition",variable:{kind:"Variable",name:{kind:"Name",value:"modelId"}},type:{kind:"NonNullType",type:{kind:"NamedType",name:{kind:"Name",value:"ID"}}},directives:[]}],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"model"},arguments:[{kind:"Argument",name:{kind:"Name",value:"id"},value:{kind:"Variable",name:{kind:"Name",value:"modelId"}}}],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"id"},arguments:[],directives:[]},{kind:"FragmentSpread",name:{kind:"Name",value:"ModelPlayerOptions"},directives:[]}]}}]}},{kind:"OperationDefinition",operation:"mutation",name:{kind:"Name",value:"PatchModel"},variableDefinitions:[{kind:"VariableDefinition",variable:{kind:"Variable",name:{kind:"Name",value:"modelId"}},type:{kind:"NonNullType",type:{kind:"NamedType",name:{kind:"Name",value:"ID"}}},directives:[]},{kind:"VariableDefinition",variable:{kind:"Variable",name:{kind:"Name",value:"patch"}},type:{kind:"NonNullType",type:{kind:"NamedType",name:{kind:"Name",value:"ModelPatch"}}},directives:[]}],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"patchModel"},arguments:[{kind:"Argument",name:{kind:"Name",value:"id"},value:{kind:"Variable",name:{kind:"Name",value:"modelId"}}},{kind:"Argument",name:{kind:"Name",value:"patch"},value:{kind:"Variable",name:{kind:"Name",value:"patch"}}}],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"id"},arguments:[],directives:[]}]}}]}}],loc:{start:0,end:261}};s.loc.source={body:'#import "./model-options-fragments.gql"\n\nquery GetModelOptions($modelId: ID!) {\n  model(id: $modelId) {\n    id\n    ...ModelPlayerOptions\n  }\n}\n\nmutation PatchModel($modelId: ID!, $patch: ModelPatch!) {\n  patchModel(id: $modelId, , patch: $patch) {\n    id\n  }\n}\n',name:"GraphQL request",locationOffset:{line:1,column:1}};var o={};function n(e,t){if("FragmentSpread"===e.kind)t.add(e.name.value);else if("VariableDefinition"===e.kind){var i=e.type;"NamedType"===i.kind&&t.add(i.name.value)}e.selectionSet&&e.selectionSet.selections.forEach((function(e){n(e,t)})),e.variableDefinitions&&e.variableDefinitions.forEach((function(e){n(e,t)})),e.definitions&&e.definitions.forEach((function(e){n(e,t)}))}s.definitions=s.definitions.concat(i(82038).definitions.filter((function(e){if("FragmentDefinition"!==e.kind)return!0;var t=e.name.value;return!o[t]&&(o[t]=!0,!0)})));var r={};function a(e,t){for(var i=0;i<e.definitions.length;i++){var s=e.definitions[i];if(s.name&&s.name.value==t)return s}}function l(e,t){var i={kind:e.kind,definitions:[a(e,t)]};e.hasOwnProperty("loc")&&(i.loc=e.loc);var s=r[t]||new Set,o=new Set,n=new Set;for(s.forEach((function(e){n.add(e)}));n.size>0;){var l=n;n=new Set,l.forEach((function(e){o.has(e)||(o.add(e),(r[e]||new Set).forEach((function(e){n.add(e)})))}))}return o.forEach((function(t){var s=a(e,t);s&&i.definitions.push(s)})),i}s.definitions.forEach((function(e){if(e.name){var t=new Set;n(e,t),r[e.name.value]=t}})),e.exports=s,e.exports.GetModelOptions=l(s,"GetModelOptions"),e.exports.PatchModel=l(s,"PatchModel")},57975:e=>{"use strict";function t(e){if("string"!=typeof e)throw new TypeError("Path must be a string. Received "+JSON.stringify(e))}function i(e,t){for(var i,s="",o=0,n=-1,r=0,a=0;a<=e.length;++a){if(a<e.length)i=e.charCodeAt(a);else{if(47===i)break;i=47}if(47===i){if(n===a-1||1===r);else if(n!==a-1&&2===r){if(s.length<2||2!==o||46!==s.charCodeAt(s.length-1)||46!==s.charCodeAt(s.length-2))if(s.length>2){var l=s.lastIndexOf("/");if(l!==s.length-1){-1===l?(s="",o=0):o=(s=s.slice(0,l)).length-1-s.lastIndexOf("/"),n=a,r=0;continue}}else if(2===s.length||1===s.length){s="",o=0,n=a,r=0;continue}t&&(s.length>0?s+="/..":s="..",o=2)}else s.length>0?s+="/"+e.slice(n+1,a):s=e.slice(n+1,a),o=a-n-1;n=a,r=0}else 46===i&&-1!==r?++r:r=-1}return s}var s={resolve:function(){for(var e,s="",o=!1,n=arguments.length-1;n>=-1&&!o;n--){var r;n>=0?r=arguments[n]:(void 0===e&&(e=process.cwd()),r=e),t(r),0!==r.length&&(s=r+"/"+s,o=47===r.charCodeAt(0))}return s=i(s,!o),o?s.length>0?"/"+s:"/":s.length>0?s:"."},normalize:function(e){if(t(e),0===e.length)return".";var s=47===e.charCodeAt(0),o=47===e.charCodeAt(e.length-1);return 0!==(e=i(e,!s)).length||s||(e="."),e.length>0&&o&&(e+="/"),s?"/"+e:e},isAbsolute:function(e){return t(e),e.length>0&&47===e.charCodeAt(0)},join:function(){if(0===arguments.length)return".";for(var e,i=0;i<arguments.length;++i){var o=arguments[i];t(o),o.length>0&&(void 0===e?e=o:e+="/"+o)}return void 0===e?".":s.normalize(e)},relative:function(e,i){if(t(e),t(i),e===i)return"";if((e=s.resolve(e))===(i=s.resolve(i)))return"";for(var o=1;o<e.length&&47===e.charCodeAt(o);++o);for(var n=e.length,r=n-o,a=1;a<i.length&&47===i.charCodeAt(a);++a);for(var l=i.length-a,h=r<l?r:l,c=-1,d=0;d<=h;++d){if(d===h){if(l>h){if(47===i.charCodeAt(a+d))return i.slice(a+d+1);if(0===d)return i.slice(a+d)}else r>h&&(47===e.charCodeAt(o+d)?c=d:0===d&&(c=0));break}var u=e.charCodeAt(o+d);if(u!==i.charCodeAt(a+d))break;47===u&&(c=d)}var m="";for(d=o+c+1;d<=n;++d)d!==n&&47!==e.charCodeAt(d)||(0===m.length?m+="..":m+="/..");return m.length>0?m+i.slice(a+c):(a+=c,47===i.charCodeAt(a)&&++a,i.slice(a))},_makeLong:function(e){return e},dirname:function(e){if(t(e),0===e.length)return".";for(var i=e.charCodeAt(0),s=47===i,o=-1,n=!0,r=e.length-1;r>=1;--r)if(47===(i=e.charCodeAt(r))){if(!n){o=r;break}}else n=!1;return-1===o?s?"/":".":s&&1===o?"//":e.slice(0,o)},basename:function(e,i){if(void 0!==i&&"string"!=typeof i)throw new TypeError('"ext" argument must be a string');t(e);var s,o=0,n=-1,r=!0;if(void 0!==i&&i.length>0&&i.length<=e.length){if(i.length===e.length&&i===e)return"";var a=i.length-1,l=-1;for(s=e.length-1;s>=0;--s){var h=e.charCodeAt(s);if(47===h){if(!r){o=s+1;break}}else-1===l&&(r=!1,l=s+1),a>=0&&(h===i.charCodeAt(a)?-1==--a&&(n=s):(a=-1,n=l))}return o===n?n=l:-1===n&&(n=e.length),e.slice(o,n)}for(s=e.length-1;s>=0;--s)if(47===e.charCodeAt(s)){if(!r){o=s+1;break}}else-1===n&&(r=!1,n=s+1);return-1===n?"":e.slice(o,n)},extname:function(e){t(e);for(var i=-1,s=0,o=-1,n=!0,r=0,a=e.length-1;a>=0;--a){var l=e.charCodeAt(a);if(47!==l)-1===o&&(n=!1,o=a+1),46===l?-1===i?i=a:1!==r&&(r=1):-1!==i&&(r=-1);else if(!n){s=a+1;break}}return-1===i||-1===o||0===r||1===r&&i===o-1&&i===s+1?"":e.slice(i,o)},format:function(e){if(null===e||"object"!=typeof e)throw new TypeError('The "pathObject" argument must be of type Object. Received type '+typeof e);return function(e,t){var i=t.dir||t.root,s=t.base||(t.name||"")+(t.ext||"");return i?i===t.root?i+s:i+e+s:s}("/",e)},parse:function(e){t(e);var i={root:"",dir:"",base:"",ext:"",name:""};if(0===e.length)return i;var s,o=e.charCodeAt(0),n=47===o;n?(i.root="/",s=1):s=0;for(var r=-1,a=0,l=-1,h=!0,c=e.length-1,d=0;c>=s;--c)if(47!==(o=e.charCodeAt(c)))-1===l&&(h=!1,l=c+1),46===o?-1===r?r=c:1!==d&&(d=1):-1!==r&&(d=-1);else if(!h){a=c+1;break}return-1===r||-1===l||0===d||1===d&&r===l-1&&r===a+1?-1!==l&&(i.base=i.name=0===a&&n?e.slice(1,l):e.slice(a,l)):(0===a&&n?(i.name=e.slice(1,r),i.base=e.slice(1,l)):(i.name=e.slice(a,r),i.base=e.slice(a,l)),i.ext=e.slice(r,l)),a>0?i.dir=e.slice(0,a-1):n&&(i.dir="/"),i},sep:"/",delimiter:":",win32:null,posix:null};s.posix=s,e.exports=s},27419:(e,t)=>{"use strict";var i=t.binary_mesh={};i.read=function(e,t){return e.readFields(i._readField,{chunk:[],quantized_chunk:[]},t)},i._readField=function(e,t,i){1===e?t.chunk.push(n.read(i,i.readVarint()+i.pos)):2===e&&t.quantized_chunk.push(h.read(i,i.readVarint()+i.pos))},i.write=function(e,t){if(e.chunk)for(var i=0;i<e.chunk.length;i++)t.writeMessage(1,n.write,e.chunk[i]);if(e.quantized_chunk)for(i=0;i<e.quantized_chunk.length;i++)t.writeMessage(2,h.write,e.quantized_chunk[i])};var s=t.vertices_simple={};s.read=function(e,t){return e.readFields(s._readField,{xyz:[],uv:[]},t)},s._readField=function(e,t,i){1===e?i.readPackedFloat(t.xyz):2===e&&i.readPackedFloat(t.uv)},s.write=function(e,t){e.xyz&&t.writePackedFloat(1,e.xyz),e.uv&&t.writePackedFloat(2,e.uv)};var o=t.faces_simple={};o.read=function(e,t){return e.readFields(o._readField,{faces:[]},t)},o._readField=function(e,t,i){1===e&&i.readPackedVarint(t.faces)},o.write=function(e,t){e.faces&&t.writePackedVarint(1,e.faces)};var n=t.chunk_simple={};n.read=function(e,t){return e.readFields(n._readField,{vertices:null,faces:null,chunk_name:"",material_name:""},t)},n._readField=function(e,t,i){1===e?t.vertices=s.read(i,i.readVarint()+i.pos):2===e?t.faces=o.read(i,i.readVarint()+i.pos):3===e?t.chunk_name=i.readString():4===e&&(t.material_name=i.readString())},n.write=function(e,t){e.vertices&&t.writeMessage(1,s.write,e.vertices),e.faces&&t.writeMessage(2,o.write,e.faces),e.chunk_name&&t.writeStringField(3,e.chunk_name),e.material_name&&t.writeStringField(4,e.material_name)};var r=t.vertices_quantized={};r.read=function(e,t){return e.readFields(r._readField,{quantization:0,translation:[],x:[],y:[],z:[]},t)},r._readField=function(e,t,i){1===e?t.quantization=i.readFloat():2===e?i.readPackedFloat(t.translation):3===e?i.readPackedSVarint(t.x):4===e?i.readPackedSVarint(t.y):5===e&&i.readPackedSVarint(t.z)},r.write=function(e,t){e.quantization&&t.writeFloatField(1,e.quantization),e.translation&&t.writePackedFloat(2,e.translation),e.x&&t.writePackedSVarint(3,e.x),e.y&&t.writePackedSVarint(4,e.y),e.z&&t.writePackedSVarint(5,e.z)};var a=t.uv_quantized={};a.read=function(e,t){return e.readFields(a._readField,{name:"",quantization:0,u:[],v:[]},t)},a._readField=function(e,t,i){1===e?t.name=i.readString():2===e?t.quantization=i.readFloat():3===e?i.readPackedSVarint(t.u):4===e&&i.readPackedSVarint(t.v)},a.write=function(e,t){e.name&&t.writeStringField(1,e.name),e.quantization&&t.writeFloatField(2,e.quantization),e.u&&t.writePackedSVarint(3,e.u),e.v&&t.writePackedSVarint(4,e.v)};var l=t.faces_compressed={};l.read=function(e,t){return e.readFields(l._readField,{faces:[]},t)},l._readField=function(e,t,i){1===e&&i.readPackedSVarint(t.faces)},l.write=function(e,t){e.faces&&t.writePackedSVarint(1,e.faces)};var h=t.chunk_quantized={};h.read=function(e,t){return e.readFields(h._readField,{chunk_name:"",material_name:"",vertices:null,uvs:[],faces:null},t)},h._readField=function(e,t,i){1===e?t.chunk_name=i.readString():2===e?t.material_name=i.readString():3===e?t.vertices=r.read(i,i.readVarint()+i.pos):4===e?t.uvs.push(a.read(i,i.readVarint()+i.pos)):5===e&&(t.faces=o.read(i,i.readVarint()+i.pos))},h.write=function(e,t){if(e.chunk_name&&t.writeStringField(1,e.chunk_name),e.material_name&&t.writeStringField(2,e.material_name),e.vertices&&t.writeMessage(3,r.write,e.vertices),e.uvs)for(var i=0;i<e.uvs.length;i++)t.writeMessage(4,a.write,e.uvs[i]);e.faces&&t.writeMessage(5,o.write,e.faces)}},15335:(e,t,i)=>{"use strict";e.exports=o;var s=i(251);function o(e){this.buf=ArrayBuffer.isView&&ArrayBuffer.isView(e)?e:new Uint8Array(e||0),this.pos=0,this.type=0,this.length=this.buf.length}o.Varint=0,o.Fixed64=1,o.Bytes=2,o.Fixed32=5;var n=4294967296,r=1/n;function a(e){return e.type===o.Bytes?e.readVarint()+e.pos:e.pos+1}function l(e,t,i){return i?4294967296*t+(e>>>0):4294967296*(t>>>0)+(e>>>0)}function h(e,t,i){var s=t<=16383?1:t<=2097151?2:t<=268435455?3:Math.ceil(Math.log(t)/(7*Math.LN2));i.realloc(s);for(var o=i.pos-1;o>=e;o--)i.buf[o+s]=i.buf[o]}function c(e,t){for(var i=0;i<e.length;i++)t.writeVarint(e[i])}function d(e,t){for(var i=0;i<e.length;i++)t.writeSVarint(e[i])}function u(e,t){for(var i=0;i<e.length;i++)t.writeFloat(e[i])}function m(e,t){for(var i=0;i<e.length;i++)t.writeDouble(e[i])}function p(e,t){for(var i=0;i<e.length;i++)t.writeBoolean(e[i])}function g(e,t){for(var i=0;i<e.length;i++)t.writeFixed32(e[i])}function f(e,t){for(var i=0;i<e.length;i++)t.writeSFixed32(e[i])}function y(e,t){for(var i=0;i<e.length;i++)t.writeFixed64(e[i])}function w(e,t){for(var i=0;i<e.length;i++)t.writeSFixed64(e[i])}function v(e,t){return(e[t]|e[t+1]<<8|e[t+2]<<16)+16777216*e[t+3]}function b(e,t,i){e[i]=t,e[i+1]=t>>>8,e[i+2]=t>>>16,e[i+3]=t>>>24}function x(e,t){return(e[t]|e[t+1]<<8|e[t+2]<<16)+(e[t+3]<<24)}o.prototype={destroy:function(){this.buf=null},readFields:function(e,t,i){for(i=i||this.length;this.pos<i;){var s=this.readVarint(),o=s>>3,n=this.pos;this.type=7&s,e(o,t,this),this.pos===n&&this.skip(s)}return t},readMessage:function(e,t){return this.readFields(e,t,this.readVarint()+this.pos)},readFixed32:function(){var e=v(this.buf,this.pos);return this.pos+=4,e},readSFixed32:function(){var e=x(this.buf,this.pos);return this.pos+=4,e},readFixed64:function(){var e=v(this.buf,this.pos)+v(this.buf,this.pos+4)*n;return this.pos+=8,e},readSFixed64:function(){var e=v(this.buf,this.pos)+x(this.buf,this.pos+4)*n;return this.pos+=8,e},readFloat:function(){var e=s.read(this.buf,this.pos,!0,23,4);return this.pos+=4,e},readDouble:function(){var e=s.read(this.buf,this.pos,!0,52,8);return this.pos+=8,e},readVarint:function(e){var t,i,s=this.buf;return t=127&(i=s[this.pos++]),i<128?t:(t|=(127&(i=s[this.pos++]))<<7,i<128?t:(t|=(127&(i=s[this.pos++]))<<14,i<128?t:(t|=(127&(i=s[this.pos++]))<<21,i<128?t:function(e,t,i){var s,o,n=i.buf;if(o=n[i.pos++],s=(112&o)>>4,o<128)return l(e,s,t);if(o=n[i.pos++],s|=(127&o)<<3,o<128)return l(e,s,t);if(o=n[i.pos++],s|=(127&o)<<10,o<128)return l(e,s,t);if(o=n[i.pos++],s|=(127&o)<<17,o<128)return l(e,s,t);if(o=n[i.pos++],s|=(127&o)<<24,o<128)return l(e,s,t);if(o=n[i.pos++],s|=(1&o)<<31,o<128)return l(e,s,t);throw new Error("Expected varint not more than 10 bytes")}(t|=(15&(i=s[this.pos]))<<28,e,this))))},readVarint64:function(){return this.readVarint(!0)},readSVarint:function(){var e=this.readVarint();return e%2==1?(e+1)/-2:e/2},readBoolean:function(){return Boolean(this.readVarint())},readString:function(){var e=this.readVarint()+this.pos,t=function(e,t,i){var s="",o=t;for(;o<i;){var n,r,a,l=e[o],h=null,c=l>239?4:l>223?3:l>191?2:1;if(o+c>i)break;1===c?l<128&&(h=l):2===c?128==(192&(n=e[o+1]))&&(h=(31&l)<<6|63&n)<=127&&(h=null):3===c?(n=e[o+1],r=e[o+2],128==(192&n)&&128==(192&r)&&((h=(15&l)<<12|(63&n)<<6|63&r)<=2047||h>=55296&&h<=57343)&&(h=null)):4===c&&(n=e[o+1],r=e[o+2],a=e[o+3],128==(192&n)&&128==(192&r)&&128==(192&a)&&((h=(15&l)<<18|(63&n)<<12|(63&r)<<6|63&a)<=65535||h>=1114112)&&(h=null)),null===h?(h=65533,c=1):h>65535&&(h-=65536,s+=String.fromCharCode(h>>>10&1023|55296),h=56320|1023&h),s+=String.fromCharCode(h),o+=c}return s}(this.buf,this.pos,e);return this.pos=e,t},readBytes:function(){var e=this.readVarint()+this.pos,t=this.buf.subarray(this.pos,e);return this.pos=e,t},readPackedVarint:function(e,t){var i=a(this);for(e=e||[];this.pos<i;)e.push(this.readVarint(t));return e},readPackedSVarint:function(e){var t=a(this);for(e=e||[];this.pos<t;)e.push(this.readSVarint());return e},readPackedBoolean:function(e){var t=a(this);for(e=e||[];this.pos<t;)e.push(this.readBoolean());return e},readPackedFloat:function(e){var t=a(this);for(e=e||[];this.pos<t;)e.push(this.readFloat());return e},readPackedDouble:function(e){var t=a(this);for(e=e||[];this.pos<t;)e.push(this.readDouble());return e},readPackedFixed32:function(e){var t=a(this);for(e=e||[];this.pos<t;)e.push(this.readFixed32());return e},readPackedSFixed32:function(e){var t=a(this);for(e=e||[];this.pos<t;)e.push(this.readSFixed32());return e},readPackedFixed64:function(e){var t=a(this);for(e=e||[];this.pos<t;)e.push(this.readFixed64());return e},readPackedSFixed64:function(e){var t=a(this);for(e=e||[];this.pos<t;)e.push(this.readSFixed64());return e},skip:function(e){var t=7&e;if(t===o.Varint)for(;this.buf[this.pos++]>127;);else if(t===o.Bytes)this.pos=this.readVarint()+this.pos;else if(t===o.Fixed32)this.pos+=4;else{if(t!==o.Fixed64)throw new Error("Unimplemented type: "+t);this.pos+=8}},writeTag:function(e,t){this.writeVarint(e<<3|t)},realloc:function(e){for(var t=this.length||16;t<this.pos+e;)t*=2;if(t!==this.length){var i=new Uint8Array(t);i.set(this.buf),this.buf=i,this.length=t}},finish:function(){return this.length=this.pos,this.pos=0,this.buf.subarray(0,this.length)},writeFixed32:function(e){this.realloc(4),b(this.buf,e,this.pos),this.pos+=4},writeSFixed32:function(e){this.realloc(4),b(this.buf,e,this.pos),this.pos+=4},writeFixed64:function(e){this.realloc(8),b(this.buf,-1&e,this.pos),b(this.buf,Math.floor(e*r),this.pos+4),this.pos+=8},writeSFixed64:function(e){this.realloc(8),b(this.buf,-1&e,this.pos),b(this.buf,Math.floor(e*r),this.pos+4),this.pos+=8},writeVarint:function(e){(e=+e||0)>268435455||e<0?function(e,t){var i,s;e>=0?(i=e%4294967296|0,s=e/4294967296|0):(s=~(-e/4294967296),4294967295^(i=~(-e%4294967296))?i=i+1|0:(i=0,s=s+1|0));if(e>=0x10000000000000000||e<-0x10000000000000000)throw new Error("Given varint doesn't fit into 10 bytes");t.realloc(10),function(e,t,i){i.buf[i.pos++]=127&e|128,e>>>=7,i.buf[i.pos++]=127&e|128,e>>>=7,i.buf[i.pos++]=127&e|128,e>>>=7,i.buf[i.pos++]=127&e|128,e>>>=7,i.buf[i.pos]=127&e}(i,0,t),function(e,t){var i=(7&e)<<4;if(t.buf[t.pos++]|=i|((e>>>=3)?128:0),!e)return;if(t.buf[t.pos++]=127&e|((e>>>=7)?128:0),!e)return;if(t.buf[t.pos++]=127&e|((e>>>=7)?128:0),!e)return;if(t.buf[t.pos++]=127&e|((e>>>=7)?128:0),!e)return;if(t.buf[t.pos++]=127&e|((e>>>=7)?128:0),!e)return;t.buf[t.pos++]=127&e}(s,t)}(e,this):(this.realloc(4),this.buf[this.pos++]=127&e|(e>127?128:0),e<=127||(this.buf[this.pos++]=127&(e>>>=7)|(e>127?128:0),e<=127||(this.buf[this.pos++]=127&(e>>>=7)|(e>127?128:0),e<=127||(this.buf[this.pos++]=e>>>7&127))))},writeSVarint:function(e){this.writeVarint(e<0?2*-e-1:2*e)},writeBoolean:function(e){this.writeVarint(Boolean(e))},writeString:function(e){e=String(e),this.realloc(4*e.length),this.pos++;var t=this.pos;this.pos=function(e,t,i){for(var s,o,n=0;n<t.length;n++){if((s=t.charCodeAt(n))>55295&&s<57344){if(!o){s>56319||n+1===t.length?(e[i++]=239,e[i++]=191,e[i++]=189):o=s;continue}if(s<56320){e[i++]=239,e[i++]=191,e[i++]=189,o=s;continue}s=o-55296<<10|s-56320|65536,o=null}else o&&(e[i++]=239,e[i++]=191,e[i++]=189,o=null);s<128?e[i++]=s:(s<2048?e[i++]=s>>6|192:(s<65536?e[i++]=s>>12|224:(e[i++]=s>>18|240,e[i++]=s>>12&63|128),e[i++]=s>>6&63|128),e[i++]=63&s|128)}return i}(this.buf,e,this.pos);var i=this.pos-t;i>=128&&h(t,i,this),this.pos=t-1,this.writeVarint(i),this.pos+=i},writeFloat:function(e){this.realloc(4),s.write(this.buf,e,this.pos,!0,23,4),this.pos+=4},writeDouble:function(e){this.realloc(8),s.write(this.buf,e,this.pos,!0,52,8),this.pos+=8},writeBytes:function(e){var t=e.length;this.writeVarint(t),this.realloc(t);for(var i=0;i<t;i++)this.buf[this.pos++]=e[i]},writeRawMessage:function(e,t){this.pos++;var i=this.pos;e(t,this);var s=this.pos-i;s>=128&&h(i,s,this),this.pos=i-1,this.writeVarint(s),this.pos+=s},writeMessage:function(e,t,i){this.writeTag(e,o.Bytes),this.writeRawMessage(t,i)},writePackedVarint:function(e,t){this.writeMessage(e,c,t)},writePackedSVarint:function(e,t){this.writeMessage(e,d,t)},writePackedBoolean:function(e,t){this.writeMessage(e,p,t)},writePackedFloat:function(e,t){this.writeMessage(e,u,t)},writePackedDouble:function(e,t){this.writeMessage(e,m,t)},writePackedFixed32:function(e,t){this.writeMessage(e,g,t)},writePackedSFixed32:function(e,t){this.writeMessage(e,f,t)},writePackedFixed64:function(e,t){this.writeMessage(e,y,t)},writePackedSFixed64:function(e,t){this.writeMessage(e,w,t)},writeBytesField:function(e,t){this.writeTag(e,o.Bytes),this.writeBytes(t)},writeFixed32Field:function(e,t){this.writeTag(e,o.Fixed32),this.writeFixed32(t)},writeSFixed32Field:function(e,t){this.writeTag(e,o.Fixed32),this.writeSFixed32(t)},writeFixed64Field:function(e,t){this.writeTag(e,o.Fixed64),this.writeFixed64(t)},writeSFixed64Field:function(e,t){this.writeTag(e,o.Fixed64),this.writeSFixed64(t)},writeVarintField:function(e,t){this.writeTag(e,o.Varint),this.writeVarint(t)},writeSVarintField:function(e,t){this.writeTag(e,o.Varint),this.writeSVarint(t)},writeStringField:function(e,t){this.writeTag(e,o.Bytes),this.writeString(t)},writeFloatField:function(e,t){this.writeTag(e,o.Fixed32),this.writeFloat(t)},writeDoubleField:function(e,t){this.writeTag(e,o.Fixed64),this.writeDouble(t)},writeBooleanField:function(e,t){this.writeVarintField(e,Boolean(t))}}},86437:(e,t,i)=>{"use strict";i.r(t),i.d(t,{default:()=>D});var s=i(23205),o=i(35223),n=i(35596),r=i(49191),a=i(48064),l=i(93227),h=i(27483),c=i(39425),d=i(49545),u=i(20560),m=i(54522),p=i(3954),g=i(48094),f=i(78652),y=i(77475),w=i(27987),v=i(65576),b=i(82110),x=i(80399);class M extends s.n{constructor(){super(...arguments),this.name="mesh-quality",this.measurementModeData=null,this.updateMaxQuality=(()=>{let e,t,i;return({modeChange:s,criticalChange:o,interactionChange:n})=>{void 0!==o&&(t=o),void 0!==s&&(e=s),void 0!==n&&(i=n);const r=i===f.o.VrOrientOnly||i===f.o.VrWithController||i===f.o.VrTransientPointer||i===f.o.VrWithTrackedController,a=this.modelMeshModule.stats(),l=a.textureCount<=this.config.textureLODThreshold?Math.max(y.M.ULTRA,this.config.maxQuality):y.M.MEDIUM,h=Math.max(l,e===b.N3.Panorama&&0===this.modelMeshModule.meshGroupVisuals.meshTextureOpacity.value?l:this.config.maxQuality);this.modelMeshModule.setTextureLimits(l,h);const c=this.viewmodeData.currentMode!==b.N3.Mesh&&this.viewmodeData.currentMode!==b.N3.Dollhouse&&this.viewmodeData.currentMode!==b.N3.Floorplan,d=this.viewmodeData.transition.active&&(0,b.nI)(this.viewmodeData.transition.to);r||d||(a.streaming||t)&&c?this.modelMeshModule.setTextureStreamMode(w.R.NONE):this.modelMeshModule.setTextureStreamMode(this.config.textureLOD)}})()}async init(e,t){this.config=e,this.engine=t,[this.modelMeshModule,this.viewmodeData,this.sweepData,this.appData,this.interactionModeData]=await Promise.all([t.getModuleBySymbol(o.GR),t.market.waitForData(a.X),t.market.waitForData(r.A),t.market.waitForData(n.zH),t.market.waitForData(x.O)]),await this.modelMeshModule.firstMeshLoadPromise,this.bindAppEventsToTextureQuality(),this.bindAppEventsToTextureVisibility(),this.updateMaxQuality({}),this.showcaseMeshDetailRules()}bindAppEventsToTextureQuality(){let e=0;const t=this.modelMeshModule.meshGroupVisuals.meshTextureOpacity;this.bindings.push(t.onChanged((()=>{t.value!==e&&this.updateMaxQuality({}),e=t.value})),this.appData.onPhase((()=>{this.updateMaxQuality({})})),this.engine.subscribe(p.A,(e=>{this.updateMaxQuality({criticalChange:!0,modeChange:e.toMode})})),this.engine.subscribe(g.A,(e=>{this.updateMaxQuality({criticalChange:!1,modeChange:e.toMode})})),this.engine.subscribe(m.zM,(()=>{this.updateMaxQuality({criticalChange:!0})})),this.engine.subscribe(m.pT,(()=>{this.updateMaxQuality({criticalChange:!1})})),this.engine.subscribe(c.A,(()=>{this.updateMaxQuality({criticalChange:!0})})),this.engine.subscribe(d.A,(()=>{this.updateMaxQuality({criticalChange:!1})})),this.engine.subscribe(h.b,(e=>{this.updateMaxQuality({interactionChange:e.mode})})))}showcaseMeshDetailRules(){const{modelMeshModule:e,log:t}=this,i=()=>this.appData.phase<=this.appData.phases.LOADING,s=()=>this.appData.phase===this.appData.phases.STARTING,o=()=>this.appData.phase>=this.appData.phases.PLAYING&&this.appData.phase!==this.appData.phases.ERROR,n=()=>this.appData.phase===this.appData.phases.ERROR,r=e=>this.viewmodeData.closestMode===e,a=()=>r(b.N3.Dollhouse)||r(b.N3.Floorplan)||r(b.N3.Mesh),h=()=>r(b.N3.Panorama),c=()=>this.viewmodeData.transition.active,d=e=>c()&&this.viewmodeData.transition.to===e,u=()=>{var e,t;return null!==(t=null===(e=this.measurementModeData)||void 0===e?void 0:e.isEditingOrCreating())&&void 0!==t&&t},m=()=>this.interactionModeData.isVR()&&!a(),p=()=>void 0!==this.sweepData.currentAlignedSweepObject;function g(){const r=e.getMeshDetail();let l=r;o()?c()?(d(b.N3.Dollhouse)||d(b.N3.Floorplan)||d(b.N3.Mesh))&&(l="max"):(l="default",h()&&m()&&(l="minimal"),h()&&!p()&&(l="minimal"),h()&&u()&&(l="max"),a()&&(l="max")):(i()&&(l="minimal"),n()&&(l="minimal"),s()&&(l="default")),r!==l&&(t.debug(`overrideMaxDetail from ${r} to ${l}`),e.setMeshOptions({overrideMaxDetail:l}))}this.bindings.push(this.appData.onPhase(g),this.viewmodeData.onChanged(g),this.modelMeshModule.meshGroupVisuals.meshTextureOpacity.onComplete(g),this.interactionModeData.onChanged(g)),this.engine.market.waitForData(l.s).then((e=>{this.bindings.push(e.onPhaseChanged(g)),this.measurementModeData=e})),g()}bindAppEventsToTextureVisibility(){this.bindings.push(this.engine.subscribe(u.A,(e=>{const t=this.sweepData.isSweepUnaligned(e.toSweep);t!==this.sweepData.isSweepUnaligned(e.fromSweep)&&this.modelMeshModule.setRenderMode(t?v.p.PanoramaCube:v.p.PanoramaMesh)})))}}const D=M},72083:(e,t,i)=>{"use strict";i.r(t),i.d(t,{default:()=>g});var s=i(35223),o=i(33518),n=i(44158),r=i(81866),a=i(23205),l=i(44634),h=i(48064),c=i(82110),d=i(28997),u=i(97624),m=i(45018),p=i(23730);class g extends a.n{constructor(){super(...arguments),this.name="showcase-hotkeys",this.inputCommandMap={[l.$.PRESSED]:{[n.D.ONE]:()=>(this.viewmodeData.currentMode===c.N3.Panorama&&(this.settings.setProperty(u._Z,!1),this.currentView=0),this.switchToMode(r.w5.INSIDE)),[n.D.TWO]:()=>this.switchToMode(r.w5.DOLLHOUSE),[n.D.THREE]:()=>this.switchToMode(r.w5.FLOORPLAN),[n.D.ZERO]:()=>{const e=this.currentView++%this.meshViews.length;return this.meshViews[e]()},[n.D.FOUR]:()=>this.engine.commandBinder.issueCommand(new p.zH)}},this.currentView=0,this.meshViews=[()=>(this.settings.setProperty(u._Z,!1),this.switchToMode(r.w5.MESH)),()=>(this.settings.setProperty(u._Z,!0),this.switchToMode(r.w5.MESH)),()=>(this.settings.setProperty(u._Z,!0),this.switchToMode(r.w5.INSIDE)),()=>(this.settings.setProperty(u._Z,!1),this.switchToMode(r.w5.INSIDE))]}async init(e,t){this.engine=t;const i=await t.getModuleBySymbol(s.mL);[this.viewmodeData,this.settings,this.cameraData]=await Promise.all([t.market.waitForData(h.X),t.market.waitForData(d.o),t.market.waitForData(m.M)]),this.issueCommand=t.commandBinder.issueCommand.bind(t.commandBinder);let n=null;i.registerHandler(o.k,(async e=>{!n&&this.inputCommandMap[e.state]&&this.inputCommandMap[e.state][e.key]&&(n=this.inputCommandMap[e.state][e.key](),await n,n=null)}))}async switchToMode(e){const{currentMode:t}=this.viewmodeData;if(t!==c.N3.Transition){const i=(0,c.nI)(t)&&(e===r.w5.MESH||e===r.w5.INSIDE)?this.cameraData.pose.rotation:void 0;try{await this.issueCommand(new r.S2(e,void 0,{rotation:i}))}catch(e){this.log.debug("Unable to switchToMode",e)}}}}},37611:(e,t,i)=>{"use strict";i.r(t),i.d(t,{default:()=>_});var s=i(23205),o=i(80328),n=i(29278),r=i(59810),a=i(26325),l=i(35223),h=i(41309),c=i(61287),d=i(71136),u=i(80379),m=i(61334),p=i(10657),g=i(35652),f=i(82030),y=i(58770),w=i(23706),v=i(54244);const b=new g.Ay("mds-player-options-deserializer"),x={[v.Zw.LEFT]:y.ND.Left,[v.Zw.RIGHT]:y.ND.Right,[v.Zw.AUTO]:y.ND.Auto},M={[v.zf.BLACK]:w.v.black,[v.zf.GREY]:w.v.grey,[v.zf.WHITE]:w.v.white};class D{deserialize(e){var t;if(!e||!this.validate(e))return b.debug("Deserialized invalid options data from MDS",e),null;const i=(null===(t=e.publication)||void 0===t?void 0:t.options)||{},s=e.options||{},o=(null==s?void 0:s.tourPanDirection)?x[s.tourPanDirection]:y.ND.Auto,n={defurnish_view:s.defurnishViewEnabled,address:i.address,contact_email:i.contactEmail,contact_name:i.contactName,contact_phone:i.contactPhone,dollhouse:s.dollhouseEnabled,external_url:i.externalUrl,floor_plan:s.floorplanEnabled,floor_select:s.floorSelectEnabled,highlight_reel:s.highlightReelEnabled,labels:s.labelsEnabled,labels_dh:s.dollhouseLabelsEnabled,model_name:i.modelName,model_summary:i.modelSummary,presented_by:i.presentedBy,measurements:s.measurements!==v.jG.DISABLED,measurements_saved:s.measurements===v.jG.MEASUREANDVIEW,room_bounds:s.roomBoundsEnabled,unit_type:s.unitType===v.WU.IMPERIAL?f.t.IMPERIAL:f.t.METRIC,background_color:(null==s?void 0:s.backgroundColor)?M[s.backgroundColor]:w.v.black,tour_buttons:s.tourButtonsEnabled,fast_transitions:s.tourFastTransitionsEnabled,transition_speed:s.tourTransitionSpeed,transition_time:s.tourTransitionTime,pan_speed:s.tourPanSpeed,dollhouse_pan_speed:s.tourDollhousePanSpeed,zoom_duration:s.tourZoomDuration,pan_angle:s.tourPanAngle,pan_direction:o,space_search:s.spaceSearchEnabled};return new h.EY(n)}validate(e){if(!e)return!1;return["id","options","publication"].every((t=>t in e))}}var T=i(20203);const S=(0,T.h)(x),P=(0,T.h)(M);class C{serialize(e){const t={},i=e.options||{};if(void 0!==i.defurnish_view&&(t.defurnishViewOverride=i.defurnish_view?v.D6.ENABLED:v.D6.DISABLED),void 0!==i.dollhouse&&(t.dollhouseOverride=i.dollhouse?v.D6.ENABLED:v.D6.DISABLED),void 0!==i.floor_plan&&(t.floorplanOverride=i.floor_plan?v.D6.ENABLED:v.D6.DISABLED),void 0!==i.floor_select&&(t.floorSelectOverride=i.floor_select?v.D6.ENABLED:v.D6.DISABLED),void 0!==i.room_bounds&&(t.roomBoundsOverride=i.room_bounds?v.D6.ENABLED:v.D6.DISABLED),void 0!==i.space_search&&(t.spaceSearchOverride=i.space_search?v.D6.ENABLED:v.D6.DISABLED),void 0!==i.labels&&(t.labelsOverride=i.labels?v.D6.ENABLED:v.D6.DISABLED),void 0!==i.labels_dh&&(t.dollhouseLabelsOverride=i.labels_dh?v.D6.ENABLED:v.D6.DISABLED),void 0!==i.highlight_reel&&(t.highlightReelOverride=i.highlight_reel?v.D6.ENABLED:v.D6.DISABLED),void 0!==i.background_color&&(t.backgroundColor={set:P[i.background_color]||v.zf.BLACK}),void 0!==i.unit_type){const e=i.unit_type===f.t.METRIC?v.WU.METRIC:v.WU.IMPERIAL;t.unitType={set:e}}if(void 0!==i.measurements||void 0!==i.measurements_saved){const e=i.measurements&&i.measurements_saved?v.jG.MEASUREANDVIEW:i.measurements?v.jG.MEASURE:v.jG.DISABLED;t.measurements={set:e}}void 0!==i.tour_buttons&&(t.tourButtonsOverride=i.tour_buttons?v.D6.ENABLED:v.D6.DISABLED),void 0!==i.fast_transitions&&(t.tourFastTransitionsOverride=i.fast_transitions?v.D6.ENABLED:v.D6.DISABLED),void 0!==i.pan_angle&&(t.tourPanAngle={set:i.pan_angle}),void 0!==i.pan_direction&&(t.tourPanDirection={set:S[i.pan_direction]}),void 0!==i.pan_speed&&(t.tourPanSpeed={set:i.pan_speed}),void 0!==i.transition_speed&&(t.tourTransitionSpeed={set:i.transition_speed}),void 0!==i.transition_time&&(t.tourTransitionTime={set:i.transition_time}),void 0!==i.zoom_duration&&(t.tourZoomDuration={set:i.zoom_duration}),void 0!==i.dollhouse_pan_speed&&(t.tourDollhousePanSpeed={set:i.dollhouse_pan_speed});const s={};void 0!==i.presented_by&&(s.presentedByOverride=i.presented_by?v.D6.ENABLED:v.D6.DISABLED),void 0!==i.contact_email&&(s.contactEmailOverride=i.contact_email?v.D6.ENABLED:v.D6.DISABLED),void 0!==i.contact_name&&(s.contactNameOverride=i.contact_name?v.D6.ENABLED:v.D6.DISABLED),void 0!==i.contact_phone&&(s.contactPhoneOverride=i.contact_phone?v.D6.ENABLED:v.D6.DISABLED),void 0!==i.external_url&&(s.externalUrlOverride=i.external_url?v.D6.ENABLED:v.D6.DISABLED),void 0!==i.model_name&&(s.modelNameOverride=i.model_name?v.D6.ENABLED:v.D6.DISABLED),void 0!==i.model_summary&&(s.modelSummaryOverride=i.model_summary?v.D6.ENABLED:v.D6.DISABLED),void 0!==i.address&&(s.addressOverride=i.address?v.D6.ENABLED:v.D6.DISABLED);return{options:t,publication:Object.keys(s).length>0?{options:s}:void 0}}}var A=i(11826);const O=new g.Ay("mds-player-options-store");class B extends p.g{constructor(){super(...arguments),this.serializer=new C,this.deserializer=new D,this.prefetchKey="data.model.publication.options"}async read(e={}){const t={modelId:this.getViewId()};return this.query(A.GetModelOptions,t,e).then((e=>{var t;return this.deserializer.deserialize(null===(t=null==e?void 0:e.data)||void 0===t?void 0:t.model)}))}async update(e){const t=this.getViewId(),i=this.serializer.serialize(e);if(0===Object.keys(i).length)throw new Error("No data to update?");return this.mutate(A.PatchModel,{modelId:t,patch:i}).then((e=>{O.debug(e)}))}}var F,k=i(1803);!function(e){e.ShowcaseOptionsChanged="showcase-options-changed"}(F||(F={}));class _ extends s.n{constructor(){super(...arguments),this.name="showcase-settings",this.data=new h.EY,this.updateTransitionType=(e,t)=>{const i=e.options.fast_transitions?d.fl.FadeToBlack:d.fl.Interpolate;t.settingsData.hasProperty(c.zk)?t.settingsData.setProperty(c.zk,i):t.registerSetting("player_options",c.zk,i)}}async init(e,t){const{baseModelId:i,readonly:s,baseUrl:c}=e;this.engine=t;const d=await t.market.waitForData(m.P);this.store=new B({context:d.mdsContext,readonly:s,baseUrl:c,viewId:i}),this.data.copy(await this.store.read()),t.market.register(this,h.EY,this.data),this.bindings.push(function(e,t){const i=window!==window.parent,s=i=>{var s;(null===(s=i.data)||void 0===s?void 0:s.action)===e&&t(i)};return(0,k.Sh)((()=>{i&&window.addEventListener("message",s)}),(()=>{i&&window.removeEventListener("message",s)}),!0)}(F.ShowcaseOptionsChanged,(()=>this.refresh())));const p=await t.getModuleBySymbol(o.ZF);for(const e in h.Q$){const t=h.Q$[e],i=this.data.options[t];if(p.hasProperty(t)){const e=p.getProperty(t);p.updateSetting(t,i&&e),this.log.debug(`Updated player_options setting ${t} = ${i&&e}`)}else p.registerSetting("player_options",t,i),this.log.debug(`Registered player_options setting ${t} = ${i}`);this.bindings.push(this.data.options.onPropertyChanged(t,(e=>{this.log.debugInfo("PlayerOption changed",{key:t,previousValue:p.getProperty(t),newValue:this.data.options[t]}),p.updateSetting(t,e)})))}if(this.updateTransitionType(this.data,p),this.bindings.push(p.settingsData.onPropertyChanged(h.Q$.InstantTransitions,(()=>this.updateTransitionType(this.data,p)))),!s){const[e]=await Promise.all([t.getModuleBySymbol(l.T9)]);this.bindings.push(e.onSave((()=>this.save()),{dataType:a.p.SETTINGS})),this.monitor=new n.V(this.data,{aggregationType:r.D.NextFrame},this.engine),this.monitor.onChanged((()=>this.engine.commandBinder.issueCommand(new u.F({dataTypes:[a.p.SETTINGS]}))))}}async refresh(){const e=await this.store.read({fetchPolicy:"no-cache"});e&&this.data.copy(e)}async save(){if(!this.store||!this.monitor)return void this.log.warn("Settings changes will NOT be saved");const e=this.monitor.getDiffRecord(),t=e.options;return t&&(t&&void 0===t.measurements&&void 0!==t.measurements_saved&&(t.measurements=this.data.options.measurements),t&&void 0!==t.measurements&&void 0===t.measurements_saved&&(t.measurements_saved=this.data.options.measurements_saved),void 0!==(null==t?void 0:t.floor_select)&&(t.floor_select=this.data.options.floor_select),void 0!==(null==t?void 0:t.labels_dh)&&(t.labels_dh=this.data.options.labels_dh),void 0===t.presented_by&&void 0===t.contact_email&&void 0===t.contact_name&&void 0===t.contact_phone&&void 0===t.external_url&&void 0===t.model_name&&void 0===t.model_summary&&void 0===t.address||(t.presented_by=this.data.options.presented_by,t.contact_email=this.data.options.contact_email,t.contact_name=this.data.options.contact_name,t.contact_phone=this.data.options.contact_phone,t.external_url=this.data.options.external_url,t.model_name=this.data.options.model_name,t.model_summary=this.data.options.model_summary,t.address=this.data.options.address)),this.monitor.clearDiffRecord(),this.store.update(e)}}},11468:(e,t,i)=>{"use strict";i.r(t),i.d(t,{default:()=>S});var s=i(68909),o=i(23205),n=i(35223),r=i(49191),a=i(82110),l=i(74533),h=i(93795),c=i(76035),d=i(71136),u=i(8371),m=i(95226),p=i(28997),g=i(83636),f=i(76735),y=i(71294),w=i(93605),v=i(52775),b=i(28606),x=i(68340),M=i(35596),D=i(71958),T=i(41309);class S extends o.n{constructor(){super(...arguments),this.name="showcase-start",this.firstRenderPromise=new y.i,this.flyInPromise=new y.i,this.handleFlyIn=async(e,t,i)=>{this.renderer.startRender(!1);try{await this.doStandardStart(e,t,i,!0)}catch(e){this.log.error(e),this.renderer.startRender(!0)}}}async init(e,t){const[i,s,o]=await Promise.all([t.market.waitForData(p.o),t.market.waitForData(c.G),t.market.waitForData(T.EY)]);[this.sweepData,this.sweepModule,this.cameraModule,this.renderer,this.appData]=await Promise.all([t.market.waitForData(r.A),t.getModuleBySymbol(n.Wh),t.getModuleBySymbol(n.jh),t.getModuleBySymbol(n.M7),t.market.waitForData(M.zH)]);const a=i.tryGetProperty("quickstart",!1),l=this.getStartingPose(s,o);return(a?this.doQuickStart(l,t,d.fl.Instant):this.doStandardStart(l,t,i,!1)).catch((e=>{this.log.error("Handling error during initial fly-in, attempting recover",{startingPose:l,error:e}),this.doQuickStart(l,t,d.fl.FadeToBlack),this.renderBeforeStarting(t)})).finally((()=>this.flyInPromise.resolve())),this.bindings.push(t.commandBinder.addBinding(g.c,(async e=>{this.handleFlyIn(e.pose||s.getStartingPose(),t,i)})),t.commandBinder.addBinding(g.W,(async e=>{this.fadeToStartLocation(s,t)})),t.subscribe(x.tj,(async()=>{this.appData.application!==M.lg.WORKSHOP&&s.moveCameraOnViewChange&&this.fadeToStartLocation(s,t)}))),this.waitForFirstRender}getStartingPose(e,t){const i=e.getStartingPose(),s=!t.options.dollhouse,o=!t.options.floor_plan;return s&&i.mode===a.N3.Dollhouse||o&&i.mode===a.N3.Floorplan?new c.n:i}fadeToStartLocation(e,t){const i=e.getStartingPose();this.doQuickStart(i,t,d.fl.FadeToBlack)}get waitForFirstRender(){return this.firstRenderPromise.nativePromise()}get waitForFlyin(){return this.flyInPromise.nativePromise()}async doQuickStart(e,t,i){const s=this.sweepData.getStartSweep(e),o=s&&s.id,r=await t.getModuleBySymbol(n.SD);return await r.switchToMode(e.mode,i,{sweepID:o,position:e.camera.position||s&&s.position,rotation:e.camera.rotation,zoom:-1!==e.camera.zoom?e.camera.zoom:void 0}),t.broadcast(new v.c7(!1)),e.mode!==a.N3.Dollhouse&&e.mode!==a.N3.Floorplan||e.floorVisibility&&await t.commandBinder.issueCommandWhenBound(new w.q8(e.floorVisibility.lastIndexOf(1),!0,0)),this.renderBeforeStarting(t)}async doStandardStart(e,t,i,o){var r;const[c]=await Promise.all([t.getModuleBySymbol(n.SD)]);await t.getModuleBySymbol(D.K4);const u=!i.tryGetProperty(h.n9,!1),p=!i.tryGetProperty(h._z,!1);e&&(e.mode===a.N3.Dollhouse&&u||e.mode===a.N3.Floorplan&&p||e.mode===a.N3.Panorama&&!e.pano)&&(e=null);const g=!e||e&&(e.mode===a.N3.Dollhouse||e.mode===a.N3.Floorplan),y=!e||e&&!this.is360Pano(e)&&(0,a.nI)(e.mode)&&!u,x=e?e.mode:a.N3.Panorama,M=this.sweepData.getStartSweep(e),T=M&&M.id,S=this.sweepData.getFirstSweep();let P=S&&S.rotation;if((null===(r=null==e?void 0:e.camera)||void 0===r?void 0:r.rotation)&&!(0,b.PH)(e.camera.rotation)&&(P=e.camera.rotation),P&&x!==a.N3.Floorplan&&(P=(0,f.V5)(P)),y){await(await t.getModuleBySymbol(n.GR)).firstMeshLoadPromise;const i=await c.getFlyinEndPose({sweepID:T,position:e?e.camera.position:void 0,rotation:P}),r=c.getFlyinStartPose(i,o?new s.Vector3(0,0,0):void 0);t.broadcast(new v.c7(!0));const h=T?this.sweepModule.activateSweepUnsafe({sweepId:T}):Promise.resolve();await c.switchToMode(a.N3.Dollhouse,d.fl.Instant,r),await this.renderBeforeStarting(t),await(0,m.cb)(750),await this.cameraModule.moveTo({transitionType:d.fl.Interpolate,pose:i}).nativePromise(),await h,t.broadcast(new v.c7(!1)),await c.switchToMode(x,d.fl.Interpolate,{sweepID:T,rotation:P},l.Ou)}else await c.switchToMode(x,d.fl.Instant,{sweepID:T,position:e?e.camera.position:void 0,rotation:P,zoom:e&&-1!==e.camera.zoom?e.camera.zoom:void 0}),g&&e&&(e.floorVisibility?await t.commandBinder.issueCommandWhenBound(new w.q8(e.floorVisibility.lastIndexOf(1),!0,0)):await t.commandBinder.issueCommandWhenBound(new w.i1(null))),await this.renderBeforeStarting(t)}is360Pano(e){if(e.pano.uuid){const t=this.sweepData.getSweep(e.pano.uuid);if(t)return t.alignmentType!==u.c$.ALIGNED}else{const e=this.sweepData.getFirstSweep();if(void 0!==e)return e.alignmentType!==u.c$.ALIGNED}return!1}async renderBeforeStarting(e){await this.renderer.renderOnce(),await e.getModuleBySymbol(D.XT),this.renderer.startRender(!0),this.firstRenderPromise.resolve()}}},41234:(e,t,i)=>{"use strict";i.d(t,{EH:()=>n,nB:()=>o,v6:()=>r});var s=i(68857);const o=(e,t=200)=>{let i=0,o=0;const n=1/e,r=e=>e.width/e.height;return{resizeDimensions:[{property:s.U.width,setDimension:t=>(i=r(t)<e?t.width:t.height*e,i),duration:t},{property:s.U.height,setDimension:t=>(o=r(t)<e?t.width*n:t.height,o),duration:t},{property:s.U.top,setDimension:t=>r(t)<e?(t.height-o)/2:0,duration:t},{property:s.U.left,setDimension:t=>r(t)<e?0:(t.width-i)/2,duration:t}]}},n=(e=200)=>({resizeDimensions:[{property:s.U.width,setDimension:e=>e.width,duration:e},{property:s.U.height,setDimension:e=>e.height,duration:e},{property:s.U.top,setDimension:()=>0,duration:e},{property:s.U.left,setDimension:()=>0,duration:e}]}),r=(e,t,i,o=200)=>{const n=[];return void 0!==e&&n.push({property:s.U.width,setDimension:t=>t.width+e,duration:o}),void 0!==t&&n.push({property:s.U.height,setDimension:e=>e.height+t,duration:o}),void 0!==i&&n.push({property:s.U.left,setDimension:()=>i,duration:o}),{resizeDimensions:n}}},68857:(e,t,i)=>{"use strict";i.d(t,{E:()=>n,U:()=>s});var s,o=i(18268);!function(e){e.left="left",e.top="top",e.width="width",e.height="height"}(s||(s={}));class n extends o.u{constructor(e){super(),this.name="resize-canvas",this.payload=Object.assign({},e)}}n.id="RESIZE_CANVAS"},66175:(e,t,i)=>{"use strict";i.d(t,{A:()=>o});var s=i(23205);class o extends s.n{constructor(){super(...arguments),this.name="base-controls",this.inputBindings=[]}registerActiveStateChangeBinding(){this.bindings.push(this.controls.onActiveStateChanged((()=>this.onActiveStateChanged())))}updateInputBindings(){this.controls.isActive?this.inputBindings.forEach((e=>e.renew())):this.inputBindings.forEach((e=>e.cancel()))}onActiveStateChanged(){this.controls.stop(),this.updateInputBindings()}dispose(e){super.dispose(e);for(const e of this.inputBindings)e.cancel();this.inputBindings=[]}}},18007:(e,t,i)=>{"use strict";i.d(t,{A:()=>o});var s=i(41733);class o{constructor(){this.poseControllerObservable=(0,s.p)(null)}rotateBetweenOrientations(e,t,i,s,o){return console.warn("rotateBetweenOrientations(): not implemented"),Promise.resolve()}get poseController(){return this.poseControllerObservable.value}setController(e){return this.poseControllerObservable.value=e,this}get isActive(){return null!=this.poseController}onActiveStateChanged(e){return this.poseControllerObservable.onChanged(e)}}},83202:(e,t,i)=>{"use strict";i.r(t),i.d(t,{default:()=>r});var s=i(23205),o=i(48064),n=i(35223);class r extends s.n{constructor(){super(...arguments),this.name="common-controls",this.modeControls=new Map,this.poseController=null}async init(e,t){this.modeControls=new Map,t.market.waitForData(o.X).then((e=>{this.viewmodeData=e,this.bindings.push(this.viewmodeData.onChanged((()=>this.setControllerForCurrViewmode()))),this.setControllerForCurrViewmode()})),this.cameraPoseProxy=(await t.getModuleBySymbol(n.jh)).cameraPoseProxy,this.cameraPoseProxy.newSession(this)}onAccessGranted(e){this.poseController=e,this.setControllerForCurrViewmode(),this.bindings.forEach((e=>e.renew()))}onAccessRevoked(e){this.stop(),this.bindings.forEach((e=>e.cancel())),this.poseController=null;for(const e of this.modeControls.values())e.controls.setController(null)}startRotateTransition(e,t,i=!0){return this.checkControlsForAction((s=>s.startRotateTransition(e,t,i)))}startZoomTransition(e,t,i=!0){return this.checkControlsForAction((s=>s.startZoomTransition(e,t,i)))}startTranslateTransition(e,t,i=!0){return this.checkControlsForAction((s=>s.startTranslateTransition(e,t,i)))}stop(){return this.checkControlsForAction((e=>(e.stop(),Promise.resolve())))}rotateBetweenOrientations(e,t,i,s,o=!1){return this.checkControlsForAction((n=>n.rotateBetweenOrientations(e,t,i,s,o)))}setControllerForCurrViewmode(){var e;if(this.viewmodeData&&this.viewmodeData.currentMode){const t=null===(e=this.modeControls.get(this.viewmodeData.currentMode))||void 0===e?void 0:e.controls;if(t){t.setController(this.poseController);for(const e of this.modeControls.values()){const i=e.controls;i!==t&&i.setController(null)}}}}checkControlsForAction(e){if(this.viewmodeData&&null!==this.viewmodeData.currentMode){const t=this.modeControls.get(this.viewmodeData.currentMode);if(t){return e(t.controls)}}return Promise.reject("checkControlsForAction() -> Current view mode is null")}addControls(e,t,i){this.modeControls.get(e)&&!i||(this.modeControls.set(e,{mode:e,controls:t}),this.setControllerForCurrViewmode())}}},98780:(e,t,i)=>{"use strict";i.d(t,{$w:()=>n,s8:()=>r,sB:()=>o});var s=i(18268);class o extends s.u{constructor(e){super(),this.payload=e}}o.id="DOLLHOUSE_VERTICAL_LIMITS";class n extends s.u{constructor(){super()}}n.id="SWAP_MOUSE_BTN_ACTION";class r extends s.u{constructor(){super()}}r.id="RESTORE_MOUSE_BTN_ACTION"},9264:(e,t,i)=>{"use strict";i.d(t,{$V:()=>c,DQ:()=>r,Dw:()=>w,X8:()=>d,Yf:()=>f,Yp:()=>h,aY:()=>m,bI:()=>y,eW:()=>l,g1:()=>g,mK:()=>u,ol:()=>a,pz:()=>p,qD:()=>o,vc:()=>n});var s=i(75673);const o=1e3/60,n=89*s.fy,r=90*s.fy,a=.001*s.fy,l=10*s.fy,h=20*s.fy,c=30*s.fy,d=.25,u=500,m=.1,p=.16,g=.08,f=Math.PI/1e3,y=.02,w=150},34998:(e,t,i)=>{"use strict";i.r(t),i.d(t,{default:()=>q});var s,o=i(35223),n=i(48071),r=i(46464),a=i(32981),l=i(33518),h=i(44158),c=i(44634),d=i(82110),u=i(75673),m=i(68909),p=i(8423),g=i(79105),f=i(60840),y=i(18007),w=i(43998),v=i(71294),b=i(71136),x=i(9264),M=i(45490),D=i(39591);!function(e){e[e.NONE=0]="NONE",e[e.ROTATE=1]="ROTATE",e[e.PAN=2]="PAN",e[e.ZOOM=3]="ZOOM"}(s||(s={}));const T={[g.O.NONE]:s.NONE,[g.O.PRIMARY]:s.ROTATE,[g.O.SECONDARY]:s.PAN,[g.O.MIDDLE]:s.ZOOM,[g.O.BACK]:s.NONE,[g.O.FORWARD]:s.NONE,[g.O.ALL]:s.NONE},S={[g.O.NONE]:s.NONE,[g.O.PRIMARY]:s.PAN,[g.O.SECONDARY]:s.ROTATE,[g.O.MIDDLE]:s.ZOOM,[g.O.BACK]:s.NONE,[g.O.FORWARD]:s.NONE,[g.O.ALL]:s.NONE};var P;!function(e){e[e.NONE=0]="NONE",e[e.MOUSE=1]="MOUSE",e[e.KEYBOARD=2]="KEYBOARD",e[e.TOUCH=3]="TOUCH"}(P||(P={}));class C{constructor(e,t,i,s,o,r){this.poseProxy=e,this.poseConstrainer=t,this.getRayPoint=i,this.getFocusPoint=s,this.invalidateParentOrbitCache=o,this.movingCamera=!1,this.smoothedTouch0=new m.Vector2,this.smoothedTouch1=new m.Vector2,this.origTouchAxis=new m.Vector2,this.origCenterPt=new m.Vector2,this.plane=new m.Plane(n.B1.UP.clone(),0),this.focusPlane=new m.Plane(n.B1.UP.clone(),0),this.maxScale=1,this.minScale=1,this.originalPinchLength=0,this.pointersMoved=(()=>{const e=new m.Vector2,t=new m.Vector3,i=new m.Vector3,s=new m.Vector2,o=new M.J(1),r=new m.Ray,a=new m.Vector3;return l=>{if(!this.poseController||!this.movingCamera)return;o.copy(this.poseProxy.pose);this.smoothedTouch0.lerp(l[0].position,.2),this.smoothedTouch1.lerp(l[1].position,.2),s.copy(this.smoothedTouch1).sub(this.smoothedTouch0).normalize();const h=this.origTouchAxis.angle()-s.angle();t.copy(this.initialPose.fovCorrectedPosition());const c=new m.Vector3(-this.intersectionPt.x,0,-this.intersectionPt.z);t.add(c),t.applyAxisAngle(n.B1.UP,h),c.negate(),t.add(c);const d=(new m.Quaternion).copy(this.initialPose.rotation),u=(new m.Quaternion).setFromAxisAngle(n.B1.UP,h);d.premultiply(u);const p=this.smoothedTouch0.clone().lerp(this.smoothedTouch1,.5),g=new m.Vector3;if(i.copy(n.B1.FORWARD).applyQuaternion(d),this.castFrom(p.x,p.y,g),isNaN(g.x))return void(this.movingCamera=!1);g.sub(this.intersectionPt),g.negate(),g.applyAxisAngle(n.B1.UP,h);const f=e.subVectors(this.smoothedTouch0,this.smoothedTouch1).length()/this.originalPinchLength,y=1-1/(0,w.qE)(f,this.minScale,this.maxScale),v=t.add(g).lerp(this.intersectionPt,y).clone();if(r.set(v,i),r.intersectPlane(this.focusPlane,a)){const e=a.distanceTo(v);o.position.copy(v),o.rotation.copy(d),o.focalDistance=e,o.resetProjMatrix(),o.applyPhiBasedFovSquish(),this.poseConstrainer.constrain(o),this.poseController.updateCameraPose(o),this.invalidateParentOrbitCache()}}})(),this.initMove=(()=>{const e=new m.Vector2,t=new m.Ray;return i=>{const s=i[0].position,o=i[1].position;this.smoothedTouch0.copy(s),this.smoothedTouch1.copy(o),this.originalPinchLength=e.subVectors(s,o).length(),this.origTouchAxis.copy(o).sub(s).normalize(),this.origCenterPt.copy(s).lerp(o,.5);const{pose:r}=this.poseProxy;this.initialPose=r.clone();const a=new m.Vector3,l=new m.Vector3;(0,D.Ft)(this.initialPose,a.set(this.origCenterPt.x,this.origCenterPt.y,-1),a),(0,D.Ft)(this.initialPose,l.set(this.origCenterPt.x,this.origCenterPt.y,1),l),l.sub(a).normalize(),t.set(a,l),this.intersectionPt=this.getRayPoint(t);const h=this.getFocusPoint();r.focalDistance=r.position.distanceTo(h),this.initialPose.focalDistance=r.position.distanceTo(h),this.maxScale=this.initialPose.fovCorrectedFocalDistance()/this.poseConstrainer.minZoomDistance,this.minScale=this.initialPose.fovCorrectedFocalDistance()/this.poseConstrainer.maxZoomDistance,this.poseConstrainer.setStartPose(this.initialPose);const c=r.phi()<x.Yp?r.forward().clone().multiplyScalar(-1):n.B1.UP;this.plane.setFromNormalAndCoplanarPoint(c,this.intersectionPt),this.focusPlane.setFromNormalAndCoplanarPoint(c,h)}})(),this.castFrom=(()=>{const e=new m.Ray,t=new m.Vector3,i=new m.Vector3;return(s,o,n)=>{(0,D.Ft)(this.initialPose,t.set(s,o,-1),t),(0,D.Ft)(this.initialPose,i.set(s,o,1),i),i.sub(t).normalize(),e.set(t,i),e.intersectPlane(this.plane,n)&&!n.equals(t)||(n.x=NaN)}})(),r.onGrabStart((e=>{this.movingCamera=!0,this.initMove(e.pointers)})),r.onGrabEnd((()=>{this.movingCamera=!1}))}isMovingCamera(){return this.movingCamera}rawPointerUpdate(e){this.pointersMoved(e.pointers)}setController(e){e?this.poseController=e:(this.poseController=void 0,this.movingCamera=!1)}}var A=i(40888),O=i(1803);var B;!function(e){e.NONE="none",e.GRAB="grab",e.SPIN="spin"}(B||(B={}));class F{constructor(){this.t1=new m.Vector2,this.t2=new m.Vector2,this.initT1=new m.Vector2,this.initT2=new m.Vector2,this.deltaT1=new m.Vector2,this.deltaT2=new m.Vector2,this.twoFingerEventCt=0,this.currGesture=B.NONE,this.contiguousGrabEventCt=0,this.grabStartObservers=new Set,this.grabEndObservers=new Set,this.spinStartObservers=new Set,this.spinEndObservers=new Set,this.gesturePointerIds=[null,null],this.currPos=new m.Vector2}rawPointerUpdate(e){if(e.pointers.length>=2){0===this.twoFingerEventCt?(this.t1.copy(e.pointers[0].clientPosition),this.t2.copy(e.pointers[1].clientPosition),this.initT1.copy(e.pointers[0].clientPosition),this.initT2.copy(e.pointers[1].clientPosition),this.gestureStartPointers=e,this.gesturePointerIds[0]=e.pointers[0].id,this.gesturePointerIds[1]=e.pointers[1].id,this.setCurrGesureAndNotifyObservers(B.NONE)):(this.t1.lerp(e.pointers[0].clientPosition,.2),this.t2.lerp(e.pointers[1].clientPosition,.2),(this.currGesture===B.NONE||this.currGesture===B.GRAB&&this.contiguousGrabEventCt<30)&&this.setCurrGesureAndNotifyObservers(this.nextGesture()));const t=(e.pointers[0].position.x+e.pointers[1].position.x)/2,i=(e.pointers[0].position.y+e.pointers[1].position.y)/2;this.currPos.set(t,i),this.twoFingerEventCt++}else this.twoFingerEventCt=0,this.setCurrGesureAndNotifyObservers(B.NONE);this.currGesture===B.GRAB&&this.contiguousGrabEventCt++}onGrabStart(e){return(0,O.Sh)((()=>this.grabStartObservers.add(e)),(()=>this.grabStartObservers.delete(e)),!0)}onGrabEnd(e){return(0,O.Sh)((()=>this.grabEndObservers.add(e)),(()=>this.grabEndObservers.delete(e)),!0)}onSpinStart(e){return(0,O.Sh)((()=>this.spinStartObservers.add(e)),(()=>this.spinStartObservers.delete(e)),!0)}onSpinEnd(e){return(0,O.Sh)((()=>this.spinEndObservers.add(e)),(()=>this.spinEndObservers.delete(e)),!0)}setCurrGesureAndNotifyObservers(e){const t=this.currGesture;if(this.currGesture=e,t===B.NONE)e===B.GRAB?this.notifyGrabStartObservers():e===B.SPIN&&this.notifySpinStartObservers();else if(t===B.GRAB)e===B.SPIN?(this.notifyGrabEndObservers(),this.notifySpinStartObservers()):e===B.NONE&&this.notifyGrabEndObservers();else if(t===B.SPIN)if(e===B.NONE)this.notifySpinEndObservers();else if(e===B.GRAB)throw new Error("Gesture recognizer should never switch from SPIN -> GRAB")}notifyGrabStartObservers(){for(const e of this.grabStartObservers)e(this.gestureStartPointers)}notifySpinStartObservers(){for(const e of this.spinStartObservers)e(this.gestureStartPointers)}notifyGrabEndObservers(){this.contiguousGrabEventCt=0;for(const e of this.grabEndObservers)e()}notifySpinEndObservers(){for(const e of this.spinEndObservers)e()}nextGesture(){if(this.twoFingerEventCt>5){const e=this.t1.y-this.initT1.y,t=this.t2.y-this.initT2.y,i=this.t1.x-this.initT1.x,s=this.t2.x-this.initT2.x;this.deltaT1.set(i,e),this.deltaT2.set(s,t);const o=this.deltaT1.length(),n=this.deltaT2.length(),r=Math.min(o,n)/Math.max(o,n)>.7,a=this.deltaT1.normalize().dot(this.deltaT2.normalize())>.7;return r&&a&&o>2&&n>2?B.SPIN:B.GRAB}return B.NONE}}var k=i(8430),_=i(18294);const V=f.A.epsilon,E=x.DQ,I=.15*Math.PI;class R extends y.A{constructor(e,t,i,o,r,a,l){super(),this.cameraPoseProxy=e,this.poseConstrainer=t,this.getOrbitPoint=i,this.getGrabPoint=o,this.constrolsData=a,this.messageBus=l,this.tempOrientation=new m.Quaternion,this.tempAxis=new m.Vector3,this.nextPosition=new m.Vector3,this.nextOrientation=new m.Quaternion,this.currentPose=new M.J(1),this.positionDelta=new m.Vector3,this.angularAccel=new m.Vector2,this.angularVelocity=new m.Vector2,this.linearAccel=new m.Vector2,this.linearVelocity=new m.Vector2,this.grabPlane=(new m.Plane).setFromNormalAndCoplanarPoint(n.B1.UP,n.B1.ZERO),this.grabPt=new m.Vector3,this.ndcPos=new m.Vector2,this.zoomAccel=0,this.zoomVelocity=0,this.orbitPoint=new m.Vector3,this.orbitDistance=0,this.orbitPlane=new m.Plane,this.needsOrbitDataInit=!0,this.autoOrbitStartPhi=0,this.aimTarget=new m.Vector3,this.currentPhiLowerLimit=x.ol,this.currentPhiUpperLimit=x.vc,this.activeAction=s.NONE,this.activeDevice=P.NONE,this.touchGestureRecognizer=new F,this.isTouchSpinning=!1,this.prevTouchY=0,this.prevTouchX=0,this.zoomDirection=new m.Vector3,this.castFromNdc=(()=>{const e=new m.Vector3,t=new m.Vector3(0,0,-1),i=new m.Ray(e,t),s=new m.Vector3;return()=>{(0,D.Ft)(this.grabCameraPose,e.set(this.ndcPos.x,this.ndcPos.y,-1),e),(0,D.Ft)(this.grabCameraPose,t.set(this.ndcPos.x,this.ndcPos.y,1),t),t.sub(e).normalize(),i.set(e,t);return i.intersectPlane(this.grabPlane,s)}})(),this.dampedZoomDir=(()=>{const e=new m.Vector3,t=new m.Quaternion,i=new m.Vector3,s=new m.Vector3,o=new m.Quaternion;return(n=x.qD)=>{const r=this.cameraPoseProxy.pose,a=r.forward().clone(),l=this.getGrabPoint(),h=l.clone().sub(this.cameraPoseProxy.pose.fovCorrectedPosition()).normalize(),c=this.poseConstrainer.modelBoundingBox.containsPoint(l)&&r.phi()>x.eW?h:a,d=o.angleTo(r.rotation)>1e-8;if(o.copy(r.rotation),e.length()<.1||d)e.copy(c),this.zoomDirection.copy(c);else{const o=e.angleTo(c);s.crossVectors(e,c);const r=(0,u.pu)(1*n),a=Math.min(o,r);t.setFromAxisAngle(s,a);const l=i.copy(e).applyQuaternion(t);e.copy(l),this.zoomDirection.copy(l)}}})(),this.touchControls=new C(e,t,r,i,(()=>this.invalidateOrbitMetadata()),this.touchGestureRecognizer),e.pose.autoOrtho&&(this.currentPhiUpperLimit=x.DQ),this.transition={active:!1,startTime:0,elapsed:0,duration:0,angularVelocity:new m.Vector2,linearVelocity:new m.Vector2,zoomVelocity:0,easeOut:!1},this.touchGestureRecognizer.onGrabStart((()=>{this.messageBus.broadcast(new _.i),this.stopAndClearState()})),this.touchGestureRecognizer.onGrabEnd((()=>this.stopAndClearState())),this.touchGestureRecognizer.onSpinStart((e=>{this.isTouchSpinning=!0,this.prevTouchX=(e.pointers[0].position.x+e.pointers[1].position.x)/2,this.prevTouchY=(e.pointers[0].position.y+e.pointers[1].position.y)/2,this.initMove(s.ROTATE,P.MOUSE)})),this.touchGestureRecognizer.onSpinEnd((()=>{this.endMove(),this.isTouchSpinning=!1}))}touchGestureIds(){return this.touchGestureRecognizer.gesturePointerIds}rawPointerUpdate(e){this.touchGestureRecognizer.rawPointerUpdate(e),this.touchControls.rawPointerUpdate(e)}setController(e){return super.setController(e),this.touchControls.setController(e),null===e&&this.activeAction!==s.NONE&&this.endMove(),this}setOrbitalAcceleration(e,t=!1){this.transition.active||(t&&this.haltVelocity(e,this.angularVelocity),this.angularAccel.x=void 0!==e.x?e.x:this.angularAccel.x,this.angularAccel.y=void 0!==e.y?e.y:this.angularAccel.y)}setPanAcceleration(e,t=!1){this.transition.active||(t&&this.haltVelocity(e,this.linearVelocity),this.linearAccel.x=void 0!==e.x?e.x:this.linearAccel.x,this.linearAccel.y=void 0!==e.y?e.y:this.linearAccel.y)}setNdcPos(e){this.ndcPos.copy(e)}initMove(e,t,i){if(t!==P.KEYBOARD&&(this.setPanAcceleration({x:0,y:0}),this.stop()),i&&this.setNdcPos(i),e!==this.activeAction||t!==this.activeDevice){this.updateOrbitState(),this.activeDevice=t,this.activeAction=e;const i=this.cameraPoseProxy.pose;this.poseConstrainer.setStartPose(i);const o=this.getGrabPoint(),r=i.phi()<x.Yp?i.forward().clone().multiplyScalar(-1):n.B1.UP;this.grabPlane.setFromNormalAndCoplanarPoint(r,o),this.grabCameraPose=this.cameraPoseProxy.pose.clone(),this.grabPt.copy(o),e===s.ROTATE&&this.messageBus.broadcast(new _.i)}}stopAndClearState(e=!1){((0,k.Fr)()||e)&&this.stop(),this.updateOrbitState(),this.activeDevice=P.NONE,this.activeAction=s.NONE}softStopAndClearState(){this.stopAcceleration(),this.updateOrbitState(),this.activeDevice=P.NONE,this.activeAction=s.NONE}endMove(e){e&&this.setNdcPos(e),this.isTouchSpinning?this.softStopAndClearState():this.stopAndClearState();const t=this.cameraPoseProxy.pose.pitchFactor();!this.isAutoOrbitting&&t<1&&t>1e-10&&this.cameraPoseProxy.pose.autoOrtho&&this.startAutoOrbitTo()}startAutoOrbitTo(e="top"){const t="top"===e?E:x.$V;if(Math.abs(this.cameraPoseProxy.pose.phi()-t)<1e-10)return Promise.resolve();const i=this.constrolsData.startAutoOrbit(e);return this.autoOrbitStartPhi=this.cameraPoseProxy.pose.phi(),i}stopAutoOrbit(){this.stopAndClearState(!0),this.constrolsData.stopAutoOrbit(),this.invalidateOrbitMetadata()}invalidateOrbitMetadata(){this.needsOrbitDataInit=!0}get isAutoOrbitting(){return this.constrolsData.isAutoOrbitting}get mouseDown(){return this.activeDevice===P.MOUSE||this.activeDevice===P.TOUCH}updateOrbitState(){if(this.activeAction!==s.ROTATE||this.needsOrbitDataInit){const e=this.cameraPoseProxy.pose,t=this.getOrbitPoint();this.orbitPoint.copy(t);const i=e.position.distanceTo(this.orbitPoint);this.orbitDistance=i/e.fovDistanceScale(),this.orbitPlane.setFromNormalAndCoplanarPoint(n.B1.UP,this.orbitPoint),this.cameraPoseProxy.pose.focalDistance=i,this.needsOrbitDataInit=!1}}setZoomAcceleration(e){this.transition.active||(this.zoomAccel=e)}async setPhiLimits(e,t,i){this.currentPhiLowerLimit=e,this.currentPhiUpperLimit=t;const s=this.cameraPoseProxy.pose.phi(),o=(0,w.qE)(0,this.currentPhiLowerLimit-s,this.currentPhiUpperLimit-s);Math.abs(o)>V&&i&&await this.orbit(new m.Vector2,!0)}haltVelocity(e,t){e.x&&t.x&&Math.sign(e.x)!==Math.sign(t.x)&&(t.x=0),e.y&&t.y&&Math.sign(e.y)!==Math.sign(t.y)&&(t.y=0)}startTransition(e,t,i,s,o){if(null===this.poseController)return v.i.reject("Unable to start transition, since controller is unavailable.");const n=new v.i;return this.transition.active=!0,this.transition.duration=e,this.transition.elapsed=0,this.transition.startTime=Date.now(),this.transition.deferred=n,this.transition.angularVelocity.copy(t),this.transition.linearVelocity.copy(i),this.transition.zoomVelocity=s,this.transition.easeOut=o,this.angularAccel.set(0,0),this.linearAccel.set(0,0),this.zoomAccel=0,this.angularVelocity.copy(t),this.linearVelocity.copy(i),this.zoomVelocity=s,this.poseController.beginExternalTransition(),n.promise()}stopTransition(){this.transition.active&&(this.poseController&&this.poseController.endExternalTransition(),this.transition.active=!1,this.endMove()),this.transition.deferred&&(this.transition.deferred.resolve(),this.transition.deferred=void 0)}updateTransition(e,t,i,s){let o=1,n=e/x.qD;if(this.transition.elapsed+=e,this.transition.elapsed>=this.transition.duration){o=(this.transition.duration-(this.transition.elapsed-e))/e,n=1}t&&(this.angularVelocity.copy(this.transition.angularVelocity).multiplyScalar(o*n),this.orbit(this.angularVelocity)),i&&(this.linearVelocity.copy(this.transition.linearVelocity).multiplyScalar(o*n),this.pan(this.linearVelocity)),s&&(this.zoomVelocity=this.transition.zoomVelocity*o*n,this.zoom(this.zoomVelocity)),this.transition.elapsed>=this.transition.duration&&(this.stop(this.transition.easeOut),this.transition.active=!1)}updateDefault(e,t,i,s){if(this.touchControls.isMovingCamera())return;const o=e/x.qD;if(t&&!s){this.angularVelocity.addScaledVector(this.angularAccel,o);const e=this.isTouchSpinning?1.1:1;this.orbit(this.angularVelocity.clone().multiplyScalar(o/e)),this.angularVelocity.multiplyScalar(Math.pow(1-x.g1,o)/e)}i&&(this.linearVelocity.addScaledVector(this.linearAccel,o),this.pan(this.linearVelocity),this.linearVelocity.multiplyScalar(Math.pow(1-x.g1,o))),s&&(this.zoomVelocity+=this.zoomAccel*o,this.zoom(this.zoomVelocity),this.zoomVelocity*=Math.pow(1-x.pz,o),this.angularVelocity.set(0,0),this.angularAccel.set(0,0))}startRotateTransition(e,t,i){return t.x*=-1,this.orbitDistance=this.cameraPoseProxy.pose.focalDistance,this.initMove(s.ROTATE,P.KEYBOARD),this.startTransition(e,t.clone().multiplyScalar(x.qD),new m.Vector2,0,i).nativePromise()}startTranslateTransition(e,t,i=!0){return this.initMove(s.PAN,P.KEYBOARD),this.startTransition(e,new m.Vector2,t.clone().multiplyScalar(x.qD),0,i).nativePromise()}startZoomTransition(e,t,i){return this.startTransition(e,new m.Vector2(0,0),new m.Vector2(0,0),t,i).nativePromise()}update(e){const t=this.linearAccel.length()>V||this.linearVelocity.length()>V,i=this.angularAccel.length()>V||this.angularVelocity.length()>V,o=Math.abs(this.zoomAccel)>V||Math.abs(this.zoomVelocity)>V,n=i||this.isAutoOrbitting,r=t||this.mouseDown&&this.activeAction===s.PAN,a=o;this.dampedZoomDir(e),this.updateMultiTouchGesture(e),this.activeDevice!==P.KEYBOARD||t||i||o?this.transition.active?this.updateTransition(e,n,r,a):this.updateDefault(e,n,r,a):this.endMove()}stopMomentum(){this.transition.active||(this.angularVelocity.set(0,0),this.linearVelocity.set(0,0),this.zoomVelocity=0)}stopAcceleration(){this.transition.active||(this.setOrbitalAcceleration({x:0,y:0}),this.setPanAcceleration({x:0,y:0}),this.setZoomAcceleration(0))}stop(e=!1){this.stopTransition(),this.stopAcceleration(),e||this.stopMomentum()}pan(e){if(!this.poseController)return;this.setupCurrentPose();const t=this.cameraPoseProxy.pose;if(this.mouseDown){const e=this.castFromNdc();if(e){const t=e.sub(this.grabPt);t.lengthSq()>0&&(this.nextPosition.copy(this.grabCameraPose.fovCorrectedPosition()).addScaledVector(t,-1),this.currentPose.position.copy(this.nextPosition),this.currentPose.applyPhiBasedFovSquish(),this.poseConstrainer.constrain(this.currentPose),this.poseController.updateCameraPose(this.currentPose))}}else this.positionDelta.x=e.x,this.positionDelta.z=e.y,this.positionDelta.y=0,this.nextPosition.copy(t.fovCorrectedPosition()).add(this.positionDelta),this.currentPose.position.copy(this.nextPosition),this.currentPose.applyPhiBasedFovSquish(),this.poseConstrainer.constrain(this.currentPose),this.poseController.updateCameraPose(this.currentPose)}orbit(e,t=!1){if(!this.poseController)return;this.setupCurrentPose();const i=this.cameraPoseProxy.pose,s=i.phi(),o=this.isAutoOrbitting?this.calcAutoOrbitVelocity(s):e,r=this.isAutoOrbitting?E:this.currentPhiUpperLimit,a=this.isAutoOrbitting?x.$V:this.currentPhiLowerLimit,l=(0,w.qE)(o.y,a-s,r-s),h=r-s<1e-10,c=s-a<1e-10,d="top"===this.constrolsData.autoOrbitTarget?h:c;if(this.isAutoOrbitting&&d)return void this.stopAutoOrbit();if(h&&l>0&&!(Math.abs(e.x)>0))return this.angularVelocity.y=0,void(this.angularAccel.y=0);const u=this.orbitDistance;if(this.aimTarget.copy(n.B1.FORWARD).applyQuaternion(i.rotation),this.aimTarget.setLength(u),this.aimTarget.addVectors(i.fovCorrectedPosition(),this.aimTarget),this.tempAxis.copy(n.B1.RIGHT),this.tempOrientation.setFromAxisAngle(this.tempAxis.applyQuaternion(i.rotation),-l),this.nextPosition.copy(i.fovCorrectedPosition()).sub(this.aimTarget).applyQuaternion(this.tempOrientation),this.nextOrientation.copy(i.rotation).premultiply(this.tempOrientation),this.tempOrientation.setFromAxisAngle(n.B1.UP,o.x),this.nextPosition.applyQuaternion(this.tempOrientation),this.nextOrientation.premultiply(this.tempOrientation),this.nextPosition=this.nextPosition.add(this.aimTarget),this.nextOrientation.normalize(),this.currentPose.position.copy(this.nextPosition),this.currentPose.rotation.copy(this.nextOrientation),this.currentPose.focalDistance=u,this.currentPose.applyPhiBasedFovSquish(),t)return this.poseController.moveTo({transitionType:b.fl.Interpolate,pose:{position:this.currentPose.position.clone(),rotation:this.currentPose.rotation.clone()},transitionTime:500}).nativePromise();this.poseController.updateCameraPose(this.currentPose)}zoom(e){if(!this.poseController)return;this.setupCurrentPose(),this.updateOrbitState();const t=this.cameraPoseProxy.pose;this.poseConstrainer.setStartPose(t);const i=t.forward().clone(),s=1/(this.getGrabPoint().distanceTo(t.position)/t.fovDistanceScale())*2,o=this.poseConstrainer.modelSize,n=e*x.aY/(s*o*x.mK),r=this.zoomDirection,a=this.orbitPoint,l=this.poseConstrainer.maxZoomDistance-this.poseConstrainer.minZoomDistance,h=a.distanceTo(t.position)/t.fovDistanceScale(),c=(0,w.qE)(n*l+h,this.poseConstrainer.minZoomDistance,this.poseConstrainer.maxZoomDistance)-h,d=r.setLength(-c);this.nextPosition.copy(t.fovCorrectedPosition()).add(d);const u=new m.Ray(this.nextPosition,i),p=new m.Vector3;let g=u.intersectPlane(this.orbitPlane,p);g&&!g.equals(this.nextPosition)||(g=a),this.currentPose.position.copy(this.nextPosition),this.currentPose.focalDistance=g.distanceTo(this.nextPosition),this.currentPose.resetProjMatrix(),this.currentPose.applyPhiBasedFovSquish(),this.poseConstrainer.constrain(this.currentPose),this.poseController.updateCameraPose(this.currentPose)}setupCurrentPose(){const e=this.cameraPoseProxy.pose;this.currentPose.copy(e),this.currentPose.unapplyPhiBasedFovSquish()}calcAutoOrbitVelocity(e){const t="top"===this.constrolsData.autoOrbitTarget?1:-1,i="top"===this.constrolsData.autoOrbitTarget?E:x.$V,s=Math.abs((i-e)/(i-this.autoOrbitStartPhi)),o=(0,A.C)(.002,.08,s);return new m.Vector2(0,t*o)}getDebugState(){return{plane:this.orbitPlane.clone(),orbitPt:this.orbitPoint.clone(),zoomDir:this.zoomDirection.clone().normalize()}}updateMultiTouchGesture(e){if(this.isTouchSpinning){const t=this.touchGestureRecognizer.currPos.x,i=this.touchGestureRecognizer.currPos.y,s=this.prevTouchX-t,o=this.prevTouchY-i,n=Math.abs(s)>.001?s:0,r=Math.abs(o)>.001?o:0,a=e/x.qD;this.setOrbitalAcceleration({x:I*n*a,y:I*r*a}),this.prevTouchX=t,this.prevTouchY=i}}}var L=i(98780),N=i(53950);class U{constructor(e){this.idealOrbitCenter=new m.Vector3,this.gestureStartPose=new M.J(1),this.constrain=(()=>{const e=new m.Vector3,t=new m.Vector3,i=new m.Vector3,s=new m.Vector3,o=new m.Ray,r=new m.Plane;return a=>{const l=this.gestureStartPose.focalPoint(),h=a.focalPoint();if(h.distanceTo(l)<1e-10)return;const c=i.subVectors(a.position,this.gestureStartPose.position);o.set(this.gestureStartPose.position,c);const d=this.maxDeviationOfOrbitPoint.clampPoint(h,e),u=a.fovDistanceScale(),m=this.minOrbitDistance*u,p=this.maxOrbitDistance*u,g=(0,w.qE)(a.focalDistance,m,p),f=t.copy(d).addScaledVector(a.forward(),-1*g);Math.abs(c.y)>1e-8&&(r.setFromNormalAndCoplanarPoint(n.B1.UP,f),o.intersectPlane(r,s)&&f.copy(s)),a.focalDistance=g,a.position.copy(f),a.commit()}})(),this.updateConstraints(e)}updateConstraints(e){const t=e.getSize(new m.Vector3);this.modelSize=Math.max(t.length(),1),this.modelBoundingBox=e,this.idealOrbitCenter=e.getCenter(this.idealOrbitCenter);const i=e.max.distanceTo(this.idealOrbitCenter);this.minOrbitDistance=2;const s=2*i;this.maxOrbitDistance=s/Math.tan(N.Bv.fov/2*u.fy);const o=2*i;this.maxDeviationOfOrbitPoint=new m.Box3(this.idealOrbitCenter.clone().add(new m.Vector3(-o,0,-o)),this.idealOrbitCenter.clone().add(new m.Vector3(o,0,o))),this.maxDeviationOfOrbitPoint.min.y=this.modelBoundingBox.min.y,this.maxDeviationOfOrbitPoint.max.y=this.modelBoundingBox.max.y}get minZoomDistance(){return this.minOrbitDistance}get maxZoomDistance(){return this.maxOrbitDistance}setStartPose(e){this.gestureStartPose.copy(e)}containsPoint(e){return this.maxDeviationOfOrbitPoint.containsPoint(e)}}var z=i(48439),G=i(66175),H=i(28997),j=i(99817),W=i(37878),Q=i(80328),$=i(48064);class q extends G.A{constructor(){super(...arguments),this.name="dollhouse-controls",this.controlState=s.NONE,this.movementKeys=new m.Vector2,this.didDrag=!1,this.peekabooActive=!1,this.swapMouseBoutton=!1,this.displayDollhouseMetadata=!1,this.resetControlState=()=>{this.controlState=s.NONE},this.convertDeltaToLocal=(()=>{const e=new m.Vector3,t=new m.Vector3;return i=>{const s=i.x||0,o=i.y||0,r=this.cameraPoseProxy.pose.phi()>(0,u.pu)(85)?n.B1.UP:n.B1.FORWARD,a=2*s*this.cameraPoseProxy.pose.fovCorrectedFocalDistance(),l=2*o*this.cameraPoseProxy.pose.fovCorrectedFocalDistance()/this.cameraPoseProxy.pose.aspect();return e.copy(n.B1.RIGHT).applyQuaternion(this.cameraPoseProxy.pose.rotation).setY(0).setLength(a),t.copy(r).applyQuaternion(this.cameraPoseProxy.pose.rotation),e.add(t.setY(0).setLength(l)),e}})()}async init(e,t){[this.visibleMeshBounds,this.commonControlsModule,this.inputIni,this.raycaster,this.renderer,this.settings,this.viewmodeData]=await Promise.all([t.getModuleBySymbol(o.UN),t.getModuleBySymbol(o.X7),t.getModuleBySymbol(o.mL),t.getModuleBySymbol(o.sA),t.getModuleBySymbol(o.M7),t.getModuleBySymbol(Q.ZF),t.market.waitForData($.X)]);const i=await t.market.waitForData(H.o);this.peekabooActive=i.tryGetProperty(j.gT,!1),this.bindings.push(i.onPropertyChanged(j.gT,(e=>{this.peekabooActive=e}))),this.settings.registerMenuButton({header:"Dollhouse",buttonName:"Toggle Orbit point display",callback:()=>{this.displayDollhouseMetadata=!this.displayDollhouseMetadata,this.displayDollhouseMetadata?this.createDebugObjects():this.removeDebugObjects()}}),this.cameraPoseProxy=this.commonControlsModule.cameraPoseProxy,this.poseConstrainer=new U(this.visibleMeshBounds.getVisibleBounds()),this.controlsData=new W.m,t.market.register(this,W.m,this.controlsData),this.controls=new R(this.cameraPoseProxy,this.poseConstrainer,(()=>this.computeOrbitPoint()),(()=>this.computeGrabPoint()),(e=>this.focusPointHelper(e)),this.controlsData,t.msgBus),this.bindings.push(this.visibleMeshBounds.onVisibleBoundsChanged((e=>{this.poseConstrainer.updateConstraints(e),this.controls.invalidateOrbitMetadata()})),t.commandBinder.addBinding(L.sB,(async e=>this.controls.setPhiLimits(void 0!==e.phiLowerLimitDegrees?e.phiLowerLimitDegrees*u.fy:this.getDefaultPhiLowerLimit(),void 0!==e.phiUpperLimitDegrees?e.phiUpperLimitDegrees*u.fy:this.getDefaultPhiUpperLimit(),void 0!==e.noTransition?!e.noTransition:this.controls.isActive))),t.commandBinder.addBinding(L.$w,(async()=>{this.peekabooActive||(this.swapMouseBoutton=!0)})),t.commandBinder.addBinding(L.s8,(async()=>{this.peekabooActive||(this.swapMouseBoutton=!1)}))),this.registerActiveStateChangeBinding();const s=this.inputIni;this.commonControlsModule.addControls(d.N3.Dollhouse,this.controls);const n=e=>{this.didDrag=!1,this.onDragBegin(e.buttons,e.position,e.device,e.ctrlKey)},h=e=>{e.timeSinceLastMove<100&&this.didDrag&&(this.onDrag(e.delta,e.position),this.controls.update(x.qD),this.controls.stopAcceleration()),this.onDragEnd(e.delta,e.buttons,e.position)},m=e=>{this.didDrag=!0,this.onDrag(e.delta,e.position),this.controls.update(x.qD),this.controls.stop()};this.inputBindings.push(s.registerHandler(r.s,(e=>{this.onScrollWheel(e)}))),this.inputBindings.push(s.registerHandler(a.SK,(e=>{this.isTouchDrag(e.pointerId)||n(e)}))),this.inputBindings.push(s.registerHandler(a._w,(e=>{this.isTouchDrag(e.pointerId)||h(e)}))),this.inputBindings.push(s.registerHandler(a.jF,(e=>{this.isTouchDrag(e.pointerId)||m(e)}))),this.inputBindings.push(s.registerHandler(p.H,(e=>{this.controls.rawPointerUpdate(e)}))),this.inputBindings.push(s.registerHandler(l.k,(e=>{e.state!==c.$.PRESSED&&this.onKey(e.key,e.state)}))),this.updateInputBindings(),this.peekabooActive&&(this.controls.setPhiLimits(this.getDefaultPhiLowerLimit(),this.getDefaultPhiUpperLimit(),!1),this.swapMouseBoutton=!0)}onUpdate(e){this.controls.isActive&&(this.controls.update(e),this.updateDebugObjects())}isTouchDrag(e){const t=this.controls.touchGestureIds();return t[0]===e||t[1]===e}getDefaultPhiUpperLimit(){return this.viewmodeData.isFloorplanDisabled()?j.oO-.01*u.fy:this.cameraPoseProxy.pose.autoOrtho?x.DQ:x.vc}getDefaultPhiLowerLimit(){return this.viewmodeData.isDollhouseDisabled()?x.DQ:x.ol}onActiveStateChanged(){super.onActiveStateChanged(),this.resetControlState()}onScrollWheel(e){this.zoom(e.delta.y)}zoom(e){0!==e&&(this.controls.setZoomAcceleration(e),this.controls.update(x.qD),this.controls.setZoomAcceleration(0))}onDragBegin(e,t,i,o=!1){if(this.controlState===s.NONE){const t=this.swapMouseBoutton?S:T;if(i===z.o.MOUSE){const i=this.applyKeyboardModifier(e,o);this.controlState=t[i]}else this.controlState=this.peekabooActive?s.PAN:s.ROTATE}const n=i===z.o.TOUCH?P.TOUCH:P.MOUSE;this.controls.initMove(this.controlState,n,t)}onDrag(e,t){switch(this.controls.setNdcPos(t),this.controlState){case s.ROTATE:this.controls.setOrbitalAcceleration({x:-Math.PI*e.x,y:-Math.PI*e.y});break;case s.ZOOM:0!==e.y&&this.controls.setZoomAcceleration(-e.y)}}onDragEnd(e,t,i){t&this.controlState||(this.controlState=s.NONE,this.controls.endMove(i))}onKey(e,t){const i=t===c.$.DOWN;let o=!1;switch(e){case h.D.LEFTARROW:case h.D.J:this.controls.setOrbitalAcceleration({x:i?x.Yf:0},!0),this.controls.initMove(s.ROTATE,P.KEYBOARD);break;case h.D.RIGHTARROW:case h.D.L:this.controls.setOrbitalAcceleration({x:i?-x.Yf:0},!0),this.controls.initMove(s.ROTATE,P.KEYBOARD);break;case h.D.UPARROW:case h.D.I:this.controls.setOrbitalAcceleration({y:i?-x.Yf:0},!0),this.controls.initMove(s.ROTATE,P.KEYBOARD);break;case h.D.DOWNARROW:case h.D.K:this.controls.setOrbitalAcceleration({y:i?x.Yf:0},!0),this.controls.initMove(s.ROTATE,P.KEYBOARD);break;case h.D.W:this.movementKeys.y=i?1:0,o=!0;break;case h.D.S:this.movementKeys.y=i?-1:0,o=!0;break;case h.D.D:this.movementKeys.x=i?1:0,o=!0;break;case h.D.A:this.movementKeys.x=i?-1:0,o=!0;break;case h.D.PLUSEQUALS:this.zoom(-x.Dw);break;case h.D.DASHUNDERSCORE:this.zoom(x.Dw)}if(o){const e=this.convertDeltaToLocal(this.movementKeys).setLength(x.bI);this.controls.setPanAcceleration({x:e.x,y:e.z}),this.controls.initMove(s.PAN,P.KEYBOARD)}}computeGrabPoint(){const e=this.inputIni.getCurrentPointerRay();return this.focusPointHelper(e,!0)}computeOrbitPoint(){const e=this.cameraPoseProxy.pose,t=new m.Ray(e.position.clone(),e.forward().clone());return this.focusPointHelper(t)}focusPointHelper(e,t=!1){const i=()=>this.visibleMeshBounds.computeFocusPoint(e,(e=>this.poseConstrainer.containsPoint(e)));if(this.cameraPoseProxy.pose.autoOrtho&&!t)return i();{const t=this.raycaster.picking.pick(e.origin,e.direction);return t?t.point.clone():i()}}applyKeyboardModifier(e,t){let i=e;return t&&e===g.O.PRIMARY&&(i=g.O.SECONDARY),i}createDebugObjects(){if(null==this.debugPlane){const e=new m.PlaneHelper(new m.Plane,100,16711680);e.material.depthTest=!1,this.debugPlane=e}if(null==this.debugOrbit){const e=new m.SphereGeometry(.1,2,2),t=new m.MeshBasicMaterial({color:16711680,side:m.DoubleSide,depthTest:!1}),i=new m.Mesh(e,t);this.debugOrbit=i}if(null==this.debugZoom){const e=new m.SphereGeometry(.2,2,2),t=new m.MeshBasicMaterial({color:65280,side:m.DoubleSide,depthTest:!1}),i=new m.Mesh(e,t);this.debugZoom=i}if(null==this.debugVisibleBounds){const e=new m.Box3Helper(this.visibleMeshBounds.getVisibleBounds(),new m.Color(0,0,0));this.debugVisibleBounds=e}if(null==this.debugSceneBounds){const e=new m.Box3Helper(this.visibleMeshBounds.getFullBounds(),new m.Color(0,0,1));this.debugSceneBounds=e}this.renderer.getScene().add(this.debugPlane,this.debugOrbit,this.debugZoom,this.debugVisibleBounds,this.debugSceneBounds)}removeDebugObjects(){null!=this.debugPlane&&(this.renderer.getScene().remove(this.debugPlane),this.debugPlane=null),null!=this.debugOrbit&&(this.renderer.getScene().remove(this.debugOrbit),this.debugOrbit=null),null!=this.debugZoom&&(this.renderer.getScene().remove(this.debugZoom),this.debugZoom=null),null!=this.debugVisibleBounds&&(this.renderer.getScene().remove(this.debugVisibleBounds),this.debugVisibleBounds=null),null!=this.debugSceneBounds&&(this.renderer.getScene().remove(this.debugSceneBounds),this.debugSceneBounds=null)}updateDebugObjects(){if(this.displayDollhouseMetadata){const{plane:e,orbitPt:t,zoomDir:i}=this.controls.getDebugState();if(null!=this.debugPlane&&(this.debugPlane.plane=e,this.debugPlane.updateMatrixWorld(!0)),null!=this.debugOrbit&&this.debugOrbit.position.copy(t),null!=this.debugZoom){const e=this.cameraPoseProxy.pose.fovCorrectedPosition().clone().addScaledVector(i,this.cameraPoseProxy.pose.fovCorrectedFocalDistance());this.debugZoom.position.copy(e)}null!=this.debugVisibleBounds&&this.debugVisibleBounds.box.copy(this.visibleMeshBounds.getVisibleBounds()),null!=this.debugSceneBounds&&this.debugSceneBounds.box.copy(this.visibleMeshBounds.getFullBounds())}}}},64788:(e,t,i)=>{"use strict";i.r(t),i.d(t,{default:()=>u});var s=i(14499),o=i(92078),n=i(48071);class r extends o.a{constructor(e,t,i,s,o=!1){super(e,t,i,s,o,!1,!0),this.cameraPoseProxy=e}calculateAimTarget(e,t){t.copy(n.B1.FORWARD).applyQuaternion(e.rotation),t.setLength(e.focalDistance),t.add(e.position)}}var a=i(57090),l=i(35223),h=i(82110),c=i(99817),d=i(87705);class u extends s.default{constructor(){super(...arguments),this.name="floorplan-controls"}async init(e,t){await super.init(e,t),t.getModuleBySymbol(l.mL).then((e=>{this.inputBindings.push(e.registerHandler(a.K,(e=>{this.controls.isActive&&(this.controls.setOrbitalAcceleration({x:e.rotateDelta,y:0}),this.controls.update(d.qD),this.controls.stop())})),e.registerHandler(a.t,this.resetControlState)),this.updateInputBindings()}))}createCameraControls(e,t,i,s){const o=this.commonControlsModule.cameraPoseProxy;this.controls=new r(o,s,e.extendedBounds,e.meshCenter,!0),i.tryGetProperty(c.gT,!1)||this.commonControlsModule.addControls(h.N3.Floorplan,this.controls)}}},42321:(e,t,i)=>{"use strict";i.r(t),i.d(t,{default:()=>C});var s=i(23205),o=i(35223),n=i(59810),r=i(68781),a=i(27230),l=i(34040),h=i(26325),c=i(80379),d=i(98585),u=i(10657),m=i(35652),p=i(68909);class g{constructor(){this.list=[]}insort(e){const t=this.binarySearch(e);let i=t.index;if(!t.success)for(;this.compare(e,this.list[i])>=0&&i<this.list.length;)i++;for(let e=this.list.length;e>i;e--)this.list[e]=this.list[e-1];this.list[i]=e}removeIndex(e){if(e>this.list.length)throw Error("OrderList.removeIndex() -> Invalid index: "+e);this.list.splice(e,1)}getElement(e){if(e>=0&&e<this.list.length)return this.list[e];throw new Error("OrderList.getElement() -> Invalid index: "+e)}get length(){return this.list.length}find(e){const t=this.binarySearch(e);return t.success?t.index:-1}compare(e,t){return void 0===t?1:"number"==typeof e?e===t?0:e<t?-1:1:e.compare(t)}binarySearch(e){let t,i=0,s=this.list.length-1,o=-1,n=0;for(;i<=s;){if(o=Math.floor((i+s)/2),t=this.list[o],n=this.compare(e,t),0===n)return{success:!0,index:o};n<0?s=o-1:i=o+1}return{success:!1,index:o}}}var f=i(16730),y=i(61693),w=i(48071),v=i(41733);class b extends y.v{constructor(e={}){super(),this.name="",this.center=new p.Vector3,this.centerOfMass=new p.Vector3,this._boundingBox=new v.L(new p.Box3),this.size=new p.Vector3,this.sweepHeights=new g,this.sweepFloorHeights=new g,this._groundPlane=new p.Plane,this._groundPt=new p.Vector3,this.medianSweepHeight=()=>this.sweepHeights.length>0?this.sweepHeights.getElement(Math.floor(this.sweepHeights.length/2)):this.center.y,this.minSweepFloorHeight=()=>this.sweepFloorHeights.length>0?this.sweepFloorHeights.getElement(0):this.boundingBox.min.y,Object.assign(this,e)}get boundingBox(){return this._boundingBox.value}set boundingBox(e){this.setBounds(e)}setBounds(e){this._boundingBox.value.copy(e),this._boundingBox.value.getSize(this.size),this._boundingBox.value.getCenter(this.center),this._boundingBox.setDirty(!0)}setCenterOfMass(e){this.centerOfMass.copy(e)}onBoundsChanged(e){return this._boundingBox.onChanged(e)}addSweep(e,t){this.sweepHeights.insort(e.y),this.sweepFloorHeights.insort(t.y)}medianSweepFloorHeight(){return this.sweepFloorHeights.length>0?this.sweepFloorHeights.getElement(Math.floor(this.sweepFloorHeights.length/2)):this.bottom}get bottom(){return this.minSweepFloorHeight()}get groundPlane(){return this._groundPt.set(0,this.bottom,0),this._groundPlane.setFromNormalAndCoplanarPoint(w.B1.UP,this._groundPt),this._groundPlane}get top(){return this.sweepFloorHeights.length>0?this.sweepFloorHeights.getElement(this.sweepFloorHeights.length-1):this.boundingBox.max.y}deepCopy(){return(0,f.A4)({id:this.id,meshGroup:this.meshGroup,index:this.index,name:this.name,center:this.center,boundingBox:this.boundingBox,size:this.size,medianSweepHeight:this.medianSweepHeight(),bottom:this.bottom})}}const x=new m.Ay("mds-floor-deserializer");class M{deserialize(e){if(!e||!this.validate(e))return x.debug("Deserialized invalid floor data from MDS",e),null;const t=e.label||"",i=e.dimensions||{areaFloor:-1},{areaFloor:s}=i;return new b({id:e.id,index:e.sequence,meshGroup:e.meshId,name:t,areaFloor:s||-1})}validate(e){return["id","sequence","meshId"].every((t=>t in e))}}class D{serialize(e){return{label:e.name}}}class T extends u.g{constructor(){super(...arguments),this.deserializer=new M,this.prefetchKey="data.model.floors"}async read(e={}){const t={modelId:this.getViewId()};return this.query(d.GetFloors,t,e).then((e=>{var t,i;const s=null===(i=null===(t=null==e?void 0:e.data)||void 0===t?void 0:t.model)||void 0===i?void 0:i.floors;if(!s||!Array.isArray(s))return null;return s.reduce(((e,t)=>{const i=this.deserializer.deserialize(t);return i&&(e[t.id]=i),e}),{})}))}async update(e,t){const i=this.getViewId(),s=(new D).serialize(t);if(!s)throw new Error("Could not update Floor");return this.mutate(d.PatchFloor,{modelId:i,floorId:e,data:s})}}var S=i(63770),P=i(61334);class C extends s.n{constructor(){super(...arguments),this.name="floors"}async init(e,t){const{readonly:i,baseUrl:s,baseModelId:r}=e;this.engine=t;const{mdsContext:d}=await t.market.waitForData(P.P);this.store=new T({context:d,readonly:i,baseUrl:s,viewId:r});const[u]=await Promise.all([this.store.read()]);if(this.data=new l.q(u||{}),t.market.register(this,l.q,this.data),!1===i){const e=this.data.getCollection();this.monitor=new a.F(e,{aggregationType:n.D.NextFrame,shallow:!0},t),this.monitor.onChanged((()=>this.engine.commandBinder.issueCommand(new c.F({dataTypes:[h.p.FLOORS]}))));const[i]=await Promise.all([t.getModuleBySymbol(o.T9)]);this.bindings.push(i.onSave((()=>this.save()),{dataType:h.p.FLOORS}))}}onUpdate(){}async save(){const e=this.monitor.getDiffRecord();this.monitor.clearDiffRecord();const t=[];for(const i of e){const e=i.index;if(!e)throw new S.v(`Invalid floor '${i.index}'`);i.action===r.Xw.updated&&t.push(this.store.update(e,i.diff))}return Promise.all(t)}}},57621:(e,t,i)=>{"use strict";i.r(t),i.d(t,{default:()=>ne});var s=i(23205),o=i(35223),n=i(33518),r=i(2785),a=i(44158),l=i(44634),h=i(49191),c=i(48064),d=i(45018),u=i(94325),m=i(20804),p=i(13438),g=i(49545),f=i(3954),y=i(33630),w=i(82110),v=i(3032),b=i(35596),x=i(33020),M=i(34040),D=i(43998),T=i(40888),S=i(97624);class P{constructor(e,t,i,s,o,n,r,a,l){this.getAngleModifier=e,this.floorsViewData=t,this.meshQuery=i,this.viewmodeData=s,this.raycasterData=o,this.cameraData=n,this.applicationData=r,this.touchDevice=a,this.meshModule=l}activate(){}init(){}dispose(){}deactivate(){const{floorOpacity:e}=this.meshModule.meshGroupVisuals;for(const t of e.keys)e.set(t,0)}beforeRender(){const e=this.floorsViewData.nearestFloor,t=this.floorsViewData.transition.progress.active,{meshGroupVisuals:i}=this.meshModule,s=!(!e||this.viewmodeData.isInside()),o=S.u7.FADE_OPAQUE;let n=o,r=o;const a=this.getAngleModifier(),l=this.floorsViewData.onlyShowActiveFloor.value?0:1;i.globalOpacityModifier.value=i.allFloorsVisibleInOrtho.value||this.floorsViewData.isInAllFloorsMode||this.applicationData.application!==b.lg.SHOWCASE?1:this.cameraData.pose.pitchFactor(),s&&(this.viewmodeData.isDollhouse()||this.viewmodeData.isOrthographic()?(n=o*a*l*S.u7.FADE_IN_VALUE,r=n*S.u7.FADE_BELOW_MULT+S.u7.FADE_BELOW_START):(n=S.u7.FADE_ABOVE,r=S.u7.FADE_BELOW));const{floorOpacity:h}=i;for(const e of h.keys){const i=this.floorsViewData.floors.getFloorByMeshGroup(Number(e));let s=o;const a=this.isBelowSelectedFloor(i)?r:n;let l=(0,D.qE)(a+S.u7.FADE_IN_HOVER_BOOST_VALUE,0,1);this.floorsViewData.roomSelectModeActive&&(l=a),s=this.isHoveredFloor(null==i?void 0:i.id)&&!t&&a>0?l:a,s=this.isFloorTransitioningOut(i)?a:s;const c=this.isSelectedFloor(null==i?void 0:i.id)||this.isFloorTransitioningIn(i);if(s=c?o:s,s=this.clampForViewmodeTransitions(s),c)h.set(e,s);else{const t=h.get(e);if(null==t)h.set(e,s);else if(t!==s){let i=(0,T.C)(t,s,.2);Math.abs(s-i)<1e-4&&(i=s),h.set(e,i)}}}}render(){}clampForViewmodeTransitions(e){if(this.viewmodeData.currentMode===w.N3.Transition){const{to:t}=this.viewmodeData.transition;if(t===w.N3.Panorama)return Math.max(1-this.meshModule.meshGroupVisuals.meshTextureOpacity.value,e)}return e}isHoveredFloor(e){if(void 0!==e&&this.raycasterData.hit&&(this.viewmodeData.isDollhouse()||this.viewmodeData.isOrthographic())&&!this.touchDevice&&this.floorsViewData.isNavigable(e)){const t=this.raycasterData.hit.object;return e===this.meshQuery.floorIdFromObject(t)}return!1}isSelectedFloor(e){const t=this.floorsViewData.nearestFloor;return!t||!(!e||t.id!==e)}isBelowSelectedFloor(e){const t=this.floorsViewData.nearestFloor;return!!(e&&t&&t.index>e.index)}isFloorTransitioningIn(e){return!(!e||!this.floorsViewData.transition.progress.active||this.floorsViewData.transition.to&&this.floorsViewData.transition.to!==e.id)}isFloorTransitioningOut(e){return!(!e||!this.floorsViewData.transition.progress.active||this.floorsViewData.transition.from&&this.floorsViewData.transition.from!==e.id&&this.floorsViewData.transition.to===e.id)}}var C=i(71294),A=i(10995),O=i(24009),B=i(71136),F=i(1902),k=i(68909),_=i(48071),V=i(90280),E=i(88696),I=i(57762),R=i(63770),L=i(58421),N=i(97318),U=i(39591),z=i(99817);class G{constructor(e,t,i,s,o,n,r,a,l,h){this.engine=e,this.floorsData=t,this.floorsViewData=i,this.sweepData=s,this.cameraData=o,this.cameraModule=n,this.viewmodeData=r,this.updateCurrentFloor=a,this.meshData=l,this.settingsData=h,this.MOVE_TO_BLACK_TRANSITION_TIME=2e3,this.moveFloorUp=(e=!1,t)=>{const i=this.floorsViewData.currentFloorId,s=this.floorsViewData.getNavigableFloorIds(),o=i?s.indexOf(i):-1;let n=s[o+1];return void 0===n&&(n=this.viewmodeData.isInside()?s[s.length-1]:s[0]),this.moveToFloor(n,e,t)},this.moveFloorDown=(e=!1,t)=>{const i=this.floorsViewData.currentFloorId,s=this.floorsViewData.getNavigableFloorIds(),o=i?s.indexOf(i):s.length;let n=s[o-1];return void 0===n&&(n=this.viewmodeData.isInside()?s[0]:s[s.length-1]),this.moveToFloor(n,e,t)},this.moveToFloor=(e,t=!1,i,s)=>{const o=this.floorsViewData.currentFloorId,n=o===e,r=this.floorsViewData.totalFloors<2&&!e,a=e?this.floorsViewData.floors.getFloor(e):null;if(n||r||!this.floorsViewData.floorsEnabled)return this.updateCurrentFloor(e),C.i.resolve();if(a&&!this.canMoveToFloor(a,t))return C.i.reject(new R.v("Invalid floor ID"));this.engine.broadcast(new A.G(o,e)),void 0===i&&(i=N.t$);const l=new C.i;let h;this.floorsViewData.transitionToFloor(o,e,i,l.nativePromise()),this.floorsViewData.commit();let c,d=s;if(this.viewmodeData.isInside()){const t=e=>e=>this.floorsViewData.isCurrentOrAllFloors(e.floorId),i=!!e?E.Eo:t,o=[(0,E.Zx)(),(0,E.Ol)(),i(e)],n=[(0,I.cv)(s||this.cameraData.pose.position)],r=this.sweepData.sortByScore(o,n).shift();r&&(d=r.sweep.position,h=r.sweep.id)}else null!==e&&this.engine.commandBinder.issueCommand(new L.HP);c=t?Promise.resolve():this.getCameraTransition(e,i,h,d);const u=this,m=C.i.all([l,c]);return this.engine.startGenerator((function*(){let e=Date.now();for(;u.floorsViewData.transition.progress.active;){yield new O.oN;const t=Date.now(),i=t-e;u.floorsViewData.transition.progress.tick(i),u.floorsViewData.commit(),e=t}u.updateCurrentFloor(u.floorsViewData.transition.to),l.resolve()})),m}}moveToFloorIndex(e,t=!1,i,s){let o=null;if(e!==N.Zu){const t=this.floorsViewData.floors.getFloorAtIndex(e);if(!t)return C.i.reject(new R.v(`Invalid floor index ${e}`));o=t.id}return this.moveToFloor(o,t,i,s)}canMoveToFloor(e,t=!1){if(!e)return!1;const i=this.floorsViewData.transition.progress.active,s=this.cameraData.canTransition()||t,o=e.index<=this.floorsViewData.totalFloors-1,n=e.index>=-1;return!i&&s&&o&&n}getCameraTransition(e,t,i,s){if(this.settingsData.tryGetProperty(z.gT,!1)?this.viewmodeData.currentMode===w.N3.Dollhouse&&!(0,U.aY)(this.cameraData.pose.pitchFactor()):this.viewmodeData.currentMode===w.N3.Dollhouse||this.viewmodeData.currentMode===w.N3.Floorplan){const i=this.getPoseForFloor(e,s);return this.cameraModule.moveTo({transitionType:B.fl.Interpolate,pose:i.pose,focalDistance:i.focalDistance,transitionTime:t,autoOrtho:this.cameraData.pose.autoOrtho}).nativePromise()}return this.viewmodeData.isInside()&&i?this.engine.commandBinder.issueCommand(new F.aj({transition:B.fl.MoveToBlack,sweep:i,transitionTime:this.MOVE_TO_BLACK_TRANSITION_TIME})):Promise.resolve()}getPoseForFloor(e,t){const i=this.cameraData.pose.fovCorrectedPosition(),s=this.cameraData.pose.rotation,o=e?this.floorsData.getFloor(e):null,n=o?o.medianSweepHeight():this.meshData.meshCenter.y,r=o?o.center:this.meshData.meshCenter;r.setY(n);const a=_.B1.FORWARD.clone().applyQuaternion(s),l=i.clone();let h,c;if(t){const e=i.clone().addScaledVector(a,this.cameraData.pose.fovCorrectedFocalDistance()),s=(new k.Vector3).set(0,i.y,0),o=(new k.Vector3).set(0,e.y,0),r=s.distanceTo(o);l.setY(n+r);const d=e.clone().setY(t.y);c=d.distanceTo(l),this.viewmodeData.isDollhouse()&&(h=(0,V.kf)(l,d))}else{const e=(o?o.size.y:H)/2+H*-a.y;l.setY(n+e),c=l.distanceTo(r)}return{focalDistance:c,pose:{position:l,rotation:h}}}}const H=8;var j=i(92590),W=i(93605),Q=i(79953),$=i(76735),q=i(75673);class K{constructor(e,t,i){this.floorsViewData=e,this.viewmodeData=t,this.pose=i,this.vectors={lookDir:new k.Vector3,flattenedLookDir:new k.Vector3},this.getAngleModifier=this.getAngleModifier.bind(this)}update(){const e=this.getAngleModifier(),t=1===this.floorsViewData.totalFloors,i=!!this.floorsViewData.nearestFloor,s=!this.viewmodeData.isInside()&&!this.viewmodeData.transitionActive();this.floorsViewData.roomSelectModeActive=s&&(t||i&&e<1||this.viewmodeData.isFloorplan()),this.floorsViewData.floorSelectModeActive=s&&1===e&&!t,this.floorsViewData.showFloorSelection=!this.viewmodeData.transitionActive()&&(this.viewmodeData.isDollhouse()||this.viewmodeData.isFloorplan())&&i&&!t,this.floorsViewData.floorSelectable=this.viewmodeData.isDollhouse()||this.viewmodeData.isOrthographic()}getAngleModifier(){const e=this.vectors.lookDir.copy(_.B1.FORWARD).applyQuaternion(this.pose.rotation),t=this.vectors.flattenedLookDir.copy(e).setY(0),i=e.angleTo(t)*q.tm,s=S.u7.FADE_IN_START_ANGLE,o=S.u7.FADE_IN_END_ANGLE,n=1-(0,$.m9)(i,s,o,0,1);return(0,Q.Do)(n,0,1,1)}}var X=i(8430),Z=i(2789),Y=i(86407),J=i(75092),ee=i(28883),te=i(28997),ie=i(64530),se=i(48094),oe=i(41309);class ne extends s.n{constructor(){super(),this.name="floors-viewdata",this.floorHoverBindings=[],this.onEndMoveToSweepMessage=e=>{const t=this.sweepData.getSweep(e.toSweep);(0,w.nI)(this.viewmodeData.closestMode)&&t&&this.updateCurrentFloor(t.floorId)},this.onMoveToFloorIndexCommand=async e=>this.floorNavigation.moveToFloorIndex(e.floorIndex,e.suppressCameraMovement,e.transitionTime,e.focusPoint),this.onShowAllFloorsCommand=async e=>{const t="boolean"==typeof e.moveCamera&&!e.moveCamera;await this.engine.commandBinder.issueCommand(new W.i1(null,t))},this.onEnableAllFloorsOptionCommand=async()=>{this.floorsViewData.showAllFloorsOption=!0,this.floorsViewData.commit()},this.onDisableAllFloorsOptionCommand=async()=>{this.floorsViewData.currentFloorIndex===N.Zu&&await this.floorNavigation.moveToFloorIndex(0,!0),this.floorsViewData.showAllFloorsOption=!1,this.floorsViewData.commit()},this.applicationChanged=()=>{this.floorsViewData.updateViewData()},this.updateCurrentFloor=e=>{this.config.allowFloorChanges&&this.floorsViewData.currentFloorId!==e&&(this.floorsViewData.transitionToFloorInstant(e),this.engine.broadcast(new p.P(e,this.floorsViewData.getFloorName(e))))},this.updateFloorSelectMode=()=>{var e;null===(e=this.floorsSelectModeHelper)||void 0===e||e.update()},this.floorSelectFeatureEnabledCheck=()=>{const e=this.settingsData.tryGetProperty(ie.p,!0),t=this.settingsData.tryGetProperty(oe.Q$.FloorSelect,!0),i=this.applicationData.application===b.lg.WORKSHOP;this.toggleFloors(i||e&&t)},this.onMoveToFloorCommand=this.onMoveToFloorCommand.bind(this)}async init(e,t){var i,s,n;this.engine=t,this.config=e,[this.floorsData,this.settingsData,this.applicationData,this.sweepData,this.viewmodeData]=await Promise.all([t.market.waitForData(M.q),t.market.waitForData(te.o),t.market.waitForData(b.zH),t.market.waitForData(h.A),t.market.waitForData(c.X)]);const r=await t.getModuleBySymbol(o.gS),a={floorChangesEnabled:()=>this.config.allowFloorChanges};if(this.floorsViewData=new j.X(this.floorsData,this.viewmodeData,this.sweepData,this.applicationData,r.t.bind(r),a),t.market.register(this,j.X,this.floorsViewData),[this.cameraData,this.input,this.raycasterData]=await Promise.all([t.market.waitForData(d.M),t.getModuleBySymbol(o.mL),t.market.waitForData(y.$)]),this.floorSelectFeatureEnabledCheck(),this.config.allowFloorChanges){const e=null===(i=this.config.startingFloorsVisibility)||void 0===i?void 0:i.lastIndexOf(1),t=null===(s=this.floorsData.getFloorAtIndex(e))||void 0===s?void 0:s.id,o=null===(n=this.sweepData.currentSweepObject)||void 0===n?void 0:n.floorId,r=o||t||null;(o||t)&&(this.log.debug(`Set initial floor to ${r} from current pose`),this.updateCurrentFloor(r))}const[l,m,p]=await Promise.all([t.getModuleBySymbol(o.jh),t.market.waitForData(u.U),t.getModuleBySymbol(o.GR)]);this.floorNavigation=new G(t,this.floorsData,this.floorsViewData,this.sweepData,this.cameraData,l,this.viewmodeData,this.updateCurrentFloor,m,this.settingsData),this.floorsSelectModeHelper=new K(this.floorsViewData,this.viewmodeData,this.cameraData.pose);const D=await t.getModuleBySymbol(o.PM),T=new P(this.floorsSelectModeHelper.getAngleModifier,this.floorsViewData,D,this.viewmodeData,this.raycasterData,this.cameraData,this.applicationData,(0,X.C8)(),p);t.addComponent(this,T),this.config.allowFloorChanges&&this.registerFloorHoverCursorEffect(),this.bindings.push(this.registerKeys(),t.subscribe(x.E5,this.applicationChanged),this.floorsData.onChanged(this.floorsViewData.updateViewData),t.subscribe(g.A,this.onEndMoveToSweepMessage),t.subscribe(f.A,function(e,t,i,s,o){const n=s.tryGetProperty(z.gT,!1);let r=n;return s=>{const a=e.tryGetData(v.R);if(!a||a&&a.isTourActive())return;!(0,w.nI)(s.toMode)||n&&o.phase!==b.Jj.PLAYING||(r=null!==i.currentFloorId);const l=(0,w.nI)(s.fromMode),h=s.toMode===w.N3.Floorplan,c=s.toMode===w.N3.Dollhouse;if(!l||!c&&!h)return;const d=r||h?i.currentFloorId:null;t(new W.i1(d,!0,0))}}(t.market,t.commandBinder.issueCommand,this.floorsViewData,this.settingsData,this.applicationData)),t.commandBinder.addBinding(W.i1,this.onMoveToFloorCommand),t.commandBinder.addBinding(W.q8,this.onMoveToFloorIndexCommand),t.commandBinder.addBinding(W.$9,this.onShowAllFloorsCommand),t.commandBinder.addBinding(W.Qd,this.onEnableAllFloorsOptionCommand),t.commandBinder.addBinding(W.vr,this.onDisableAllFloorsOptionCommand),t.subscribe(se.A,this.updateFloorSelectMode),this.cameraData.pose.onChanged(this.updateFloorSelectMode),this.floorsViewData.onChanged(this.updateFloorSelectMode),this.settingsData.onPropertyChanged(ie.p,this.floorSelectFeatureEnabledCheck),this.settingsData.onPropertyChanged(oe.Q$.FloorSelect,this.floorSelectFeatureEnabledCheck),this.applicationData.onPropertyChanged("application",this.floorSelectFeatureEnabledCheck)),this.updateFloorSelectMode(),this.sweepData.currentSweepObject&&this.updateCurrentFloor(this.sweepData.currentSweepObject.floorId)}onUpdate(){}async onMoveToFloorCommand(e){return this.floorNavigation.moveToFloor(e.floorId,e.suppressCameraMovement,e.transitionTime,e.focusPoint).nativePromise()}toggleFloors(e){e||null===this.floorsViewData.currentFloorId||this.updateCurrentFloor(null),this.config.allowFloorChanges=e,this.updateFloorSelectMode(),this.config.allowFloorChanges?this.registerFloorHoverCursorEffect():this.clearFloorHoverBindings()}registerKeys(){return this.input.registerHandler(n.k,(async e=>{if(!this.cameraData.canTransition())return;const t=e.modifiers.shiftKey;if(e.state===l.$.PRESSED)switch(e.key){case a.D.UPARROW:t&&this.floorNavigation.moveFloorUp();break;case a.D.DOWNARROW:t&&this.floorNavigation.moveFloorDown();break;case a.D.R:this.floorNavigation.moveFloorUp();break;case a.D.F:this.floorNavigation.moveFloorDown();break;case a.D.Y:this.floorNavigation.moveToFloor(null)}}))}registerFloorHoverCursorEffect(){if(0===this.floorHoverBindings.length){const e=Y.f.is((e=>m.m2.isRoomMesh(e)&&e.raycastEnabled&&this.floorsViewData.floorSelectable)),t=new Z.P(this.input.registerMeshHandler(r.L,e,(e=>{this.engine.commandBinder.issueCommand(new J.X(ee.b.FINGER))})),this.input.registerMeshHandler(r.q,e,(e=>{this.engine.commandBinder.issueCommand(new J.X(ee.b.DEFAULT))})));t.cancel();const i=(()=>{let e=!1;return()=>{const i=this.floorsViewData.floorSelectHoverEnabled;i!==e&&(e=i,e?t.renew():(t.cancel(),this.engine.commandBinder.issueCommand(new J.X(ee.b.DEFAULT))))}})();i();const s=()=>{this.floorsViewData.floorSelectHoverEnabled=!1,i()},o=()=>{this.floorsViewData.floorSelectHoverEnabled=!0,i()};this.floorHoverBindings.push(this.viewmodeData.onChanged(i),this.floorsViewData.onFloorSelectModeChange(i),this.floorsViewData.makeFloorChangeSubscription(i),this.engine.commandBinder.addBinding(W.uh,(async()=>s())),this.engine.commandBinder.addBinding(W.V6,(async()=>o())),t)}}clearFloorHoverBindings(){for(const e of this.floorHoverBindings)e.cancel();this.floorHoverBindings=[]}dispose(e){super.dispose(e),this.clearFloorHoverBindings()}}},64599:(e,t,i)=>{"use strict";i.d(t,{w:()=>o});var s=i(40270);function o(e){return e.width<=s._8}},85239:(e,t,i)=>{"use strict";i.d(t,{g:()=>n,l:()=>o});var s=i(13686);class o extends s.E{constructor(e){super(),this.pinchDelta=e}}class n extends s.E{constructor(e,t){super(),this.pinchDelta=e,this.timeSinceLastMove=t}}},8423:(e,t,i)=>{"use strict";i.d(t,{H:()=>o});var s=i(13686);class o extends s.E{constructor(e){super(),this.pointers=e}}},57090:(e,t,i)=>{"use strict";i.d(t,{K:()=>o,t:()=>n});var s=i(13686);class o extends s.E{constructor(e){super(),this.rotateDelta=e}}class n extends s.E{constructor(e,t){super(),this.rotateDelta=e,this.timeSinceLastMove=t}}},46464:(e,t,i)=>{"use strict";i.d(t,{s:()=>o});var s=i(13686);class o extends s.E{constructor(e,t){super(),this.position=e,this.delta=t}}},46195:(e,t,i)=>{"use strict";i.r(t),i.d(t,{default:()=>u});var s=i(23205),o=i(35223),n=i(75650),r=i(48439),a=i(33518),l=i(80399),h=i(78652),c=i(27483),d=i(8430);class u extends s.n{constructor(){super(...arguments),this.name="interactionmode",this.onPointerButtonEvent=e=>{let t=this.data.source;switch(e.device){case r.o.TOUCH:t=h.m.Touch;break;case r.o.MOUSE:t=h.m.Mouse;break;case r.o.PEN:t=h.m.Pen;break;case r.o.GAMEPAD:this.renderer.xr.enabled&&this.renderer.xr.isPresenting&&(t=h.m.XRController);break;default:this.log.debug("source:",e.device,e)}this.updateSource(t)},this.onKeyEvent=()=>{this.updateSource(h.m.Key)}}async init(e,t){this.engine=t,this.data=new l.O,this.mobileBrowser=(0,d.Fr)();const i=await t.getModuleBySymbol(o.M7);this.renderer=i.threeRenderer,this.updateMode(this.getInteractionMode(),this.data.mode),this.engine.market.register(this,l.O,this.data),t.getModuleBySymbol(o.mL).then((e=>{this.bindings.push(e.registerHandler(n.CD,this.onPointerButtonEvent),e.registerHandler(a.k,this.onKeyEvent))}))}onUpdate(e){const t=this.getInteractionMode();this.updateMode(t,this.data.mode)}getInteractionMode(){if(this.renderer.xr.enabled&&this.renderer.xr.isPresenting){let e=h.o.VrUnknown+"unknown",t=!1;const i=this.renderer.xr.getSession();if(null!==i&&i.inputSources.length>0)for(const s of i.inputSources)switch(s.targetRayMode){case"gaze":case"screen":e=h.o.VrOrientOnly,t=!0;break;case"tracked-pointer":e=h.o.VrWithTrackedController,t=!0;break;case"transient-pointer":e=h.o.VrTransientPointer,t=!0;break;default:t||"string"!=typeof s.targetRayMode||(e=h.o.VrUnknown+s.targetRayMode)}return e}return this.mobileBrowser?h.o.Mobile:h.o.Desktop}updateMode(e,t){e!==this.data.mode&&(this.data.updateMode(e),this.data.commit(),this.engine.broadcast(new c.b(this.data.mode,t)))}updateSource(e){e!==this.data.source&&(this.data.updateSource(e),this.data.commit(),this.engine.broadcast(new c.J(this.data.source)))}}},52392:(e,t,i)=>{"use strict";i.r(t),i.d(t,{default:()=>c});var s=i(23205),o=i(35223),n=i(34040),r=i(94325),a=i(49191),l=i(55415),h=i(24563);class c extends s.n{constructor(){super(...arguments),this.name="mesh-api-data-fixups"}async init(e,t){const{market:i}=t;[this.floorData,this.sweepData,this.meshData,this.meshQuery,this.analytics]=await Promise.all([i.waitForData(n.q),i.waitForData(a.A),i.waitForData(r.U),t.getModuleBySymbol(o.PM),t.getModuleBySymbol(o.aF)]),this.assignSweepToFloors(),this.assignBoundingBoxesToFloors(),this.assignMissingSweepFloors(),this.registerRoomAssociationSource(t)}assignBoundingBoxesToFloors(){const e=this.meshData.meshGroups.floors;this.floorData.iterate(((t,i)=>{const s=e.get(t.meshGroup);s&&(t.setBounds(s.boundingBox),t.setCenterOfMass(s.centerOfMass))})),this.floorData.commit()}assignMissingSweepFloors(){let e=0;try{this.sweepData.getSweepList().forEach((t=>{var i;if(t.isUnplaced())return;let s;if(null===t.floorId||!this.floorData.hasFloor(t.floorId)){const o=this.meshQuery.floorIdFromObject(null===(i=this.meshQuery.nearestMeshInfo(t.position))||void 0===i?void 0:i.object);o&&this.floorData.hasFloor(o)&&(s=this.floorData.getFloor(o)),(null==s?void 0:s.id)&&s.id!==t.floorId&&(this.log.debug(`Setting ${t.alignmentType} sweep ${t.id} from floor ${t.floorId} to ${s.id}`),t.floorId=s.id,t.commit(),e++)}}))}finally{0!==e&&this.analytics.track("mesh_api_data_fixup_sweeps_assigned",{missing_floor_count:e})}}assignSweepToFloors(){this.sweepData.getSweepList().forEach((e=>{var t;if(!e.isUnplaced()&&e.isAligned()){let i;if(e.floorId&&this.floorData.hasFloor(e.floorId))i=this.floorData.getFloor(e.floorId);else{const s=this.meshQuery.floorIdFromObject(null===(t=this.meshQuery.nearestMeshInfo(e.position))||void 0===t?void 0:t.object);s&&this.floorData.hasFloor(s)&&(i=this.floorData.getFloor(s))}i&&i.addSweep(e.position,e.floorPosition)}})),this.floorData.commit()}registerRoomAssociationSource(e){const t=this.sweepData;e.commandBinder.issueCommandWhenBound(new l.l({type:"locations",getPositionId:function*(){for(const e of t.sweeps())yield{id:e.id,roomId:e.roomId||void 0,floorId:e.floorId||void 0,position:e.position,layerId:h.qw}},updateRoomForId:(e,i)=>{const s=t.getSweep(e);if(!s)throw new Error("Invalid sweep id!");s.roomId=i||null,s.commit()}}))}}},26642:(e,t,i)=>{"use strict";i.r(t),i.d(t,{default:()=>m});var s=i(23205),o=i(35223),n=i(77028),r=i(34040);const a=(...e)=>function(t){return e.every((e=>e(t)))};var l=i(20804),h=i(68909),c=i(12165),d=i(61334),u=i(82309);class m extends s.n{constructor(){super(...arguments),this.name="mesh-query",this.roomBoundData=null}async init(e,t){const{market:i}=t;[this.raycaster,this.floorData,this.roomData,this.layersData]=await Promise.all([t.getModuleBySymbol(o.sA),i.waitForData(r.q),i.waitForData(n.q),i.waitForData(d.P)]),i.waitForData(c.A).then((e=>this.roomBoundData=e))}nearestMeshInfoOnFloor(e,t){const i=a(l.m2.isRoomMesh,this.matchesFloorId(t));return this.raycaster.picking.nearest((new h.Vector3).set(e.x,e.y,e.z),i)}nearestMeshInfo(e){return this.raycaster.picking.nearest((new h.Vector3).set(e.x,e.y,e.z),l.m2.isRoomMesh)}inferMeshIdsFromPoint(e,t,i=!0){const s=i&&(0,u.C)(this.roomBoundData,this.layersData,e.layerId),o=!!this.roomBoundData&&this.roomBoundData.hasRooms()&&s;let n=!s||!e.roomId||!this.roomData.get(e.roomId);const r=!e.floorId||!this.floorData.hasFloor(e.floorId);if(!r&&n&&o&&this.roomBoundData){const i=this.roomBoundData.findRoomIdForPosition(t,e.floorId);i&&(e.roomId=i,n=!1)}if(n||r){const i=r?l.m2.isRoomMesh:a(l.m2.isRoomMesh,this.matchesFloorId(e.floorId)),s=this.raycaster.picking.nearest((new h.Vector3).set(t.x,t.y,t.z),i);let c;if(this.roomBoundData&&this.roomBoundData.hasRooms()){if(s){const e=s.object.meshGroup;if(void 0!==e){const i=this.floorData.getFloorByMeshGroup(e);i&&(c={floorId:i.id,roomId:o&&this.roomBoundData.findRoomIdForPosition(t,i.id)||void 0})}}}else c=s&&this.roomIdFloorIdFromObject(s.object);if(c){const{roomId:t,floorId:i}=c;this.log.debug("data-fixup:",n?{roomId:t,prev:e.roomId}:"",r?{floorId:i,prev:e.floorId}:"",{data:e}),n&&(e.roomId=t),r&&(e.floorId=i)}else this.log.warn("Nearest Room/Floor not found for:",{point:t,data:e,invalidRoomId:n,invalidFloorId:r})}return e}roomIdFloorIdFromObject(e){if(!l.m2.hasMeshGroup(e))return;const t=this.floorData.getFloorByMeshGroup(e.meshGroup);if(void 0===t)return;const i=(0,u.C)(this.roomBoundData,this.layersData,null)&&l.m2.hasMeshSubgroup(e)?this.roomData.getByMeshSubgroup(e.meshSubgroup):void 0;return{floorId:t.id,roomId:null==i?void 0:i.id}}floorIdFromObject(e){if(l.m2.hasMeshGroup(e)){const t=this.floorData.getFloorByMeshGroup(e.meshGroup);return null==t?void 0:t.id}}mdsRoomIdFromObject(e){if(!(0,u.C)(this.roomBoundData,this.layersData,null)||!l.m2.hasMeshSubgroup(e)||!l.m2.hasMeshGroup(e))return;const t=this.roomData.getByMeshSubgroup(e.meshSubgroup);if(!t)return;const i=this.floorData.getFloorByMeshGroup(e.meshGroup);return t.floorId===(null==i?void 0:i.id)?t.id:void 0}mdsFloorIdFromObject(e){if(!l.m2.hasMeshGroup(e))return;const t=this.floorData.getFloorByMeshGroup(e.meshGroup);return t?t.id:void 0}matchesFloorId(e){return t=>{const i=this.roomIdFloorIdFromObject(t);return(null==i?void 0:i.floorId)===e}}}},24081:(e,t,i)=>{"use strict";var s;i.d(t,{f:()=>s}),function(e){e[e.Standard=0]="Standard",e[e.Depth=1]="Depth",e[e.Transparent=2]="Transparent",e[e.Wireframe=3]="Wireframe",e[e.UV=4]="UV",e[e.CeilingSample=5]="CeilingSample",e[e.FloorSample=6]="FloorSample"}(s||(s={}))},81483:(e,t,i)=>{"use strict";i.d(t,{$:()=>r});var s=i(12183),o=i(68909),n=i(97624);class r extends o.Mesh{constructor(e){super(),this.roomMesh=e,this.excludeFromOctree=!0,this.layers.mask=e.layers.mask,this.name=`DepthPassRoomMesh:${e.meshGroup}-${e.meshSubgroup}`,this.renderOrder=s.X.ghostFloorDepthPrepass,this.visible=!1,this.roomMesh.onOpacityUpdate=e=>{this.visible=e<n.u7.FADE_OPAQUE},this.roomMesh.onBuild=()=>{this.geometry=this.roomMesh.geometry,this.material=this.roomMesh.material},this.roomMesh.onMaterialUpdate=()=>{this.material=this.roomMesh.material};let t=!0,i=!0;this.onBeforeRender=(e,s,o,n,r,a)=>{this.roomMesh.updateUniforms(r,a),t=r.colorWrite,i=r.depthWrite,r.colorWrite=!1,r.depthWrite=!0},this.onAfterRender=(e,s,o,n,r,a)=>{r.colorWrite=t,r.depthWrite=i}}}},51966:(e,t,i)=>{"use strict";i.d(t,{o:()=>h});var s=i(68909),o=i(1803),n=i(76735),r=i(97624);class a{constructor(){this._configs={},this._orders={},this._maxLod=-1/0,this._maxTs=1/0,this._streamAbove=0}static encodeKey(e,t){return e-t}get maxLod(){return this._maxLod}get maxTexelSize(){return this._maxTs}limitStreamingBelow(e){this._streamAbove=e}order(e,t=!1){return t&&!this._orders[e]&&(this._orders[e]=[]),this._orders[e]}reset(){this._configs={},this._orders={},this._maxTs=1/0,this._maxLod=-1/0}lods(){return Object.keys(this._orders).map((e=>Number.parseInt(e,10)))}valid(e){return e in this._configs}get(e){if(!this.valid(e))throw new Error("invalid quality level "+e);return this._configs[e]}max(e){return e<this._streamAbove?this.min(e):this.order(e)[this.order(e).length-1]}min(e){return this.order(e)[0]}fromPixelSize(e,t){const i=this.order(e),s=this.min(e);let o=this.max(e);for(let e=i.length-1;e>=0;e--)t>this.get(i[e]).texelSize&&i.indexOf(o)>i.indexOf(s)&&(o=i[e]);return o}moreDetailed(e,t){let i=this.min(e);const s=this.max(e),o=this.order(e),n=o.indexOf(t);return n+1===o.length?s:(-1!==n&&(i=Math.min(s,o[n+1%o.length])),i)}lessDetailed(e,t){const i=this.order(e),s=i.indexOf(t);let o=t;return-1!==s&&(o=i[Math.max(0,s-1)]),o}minSize(){return Object.values(this._configs).sort(l)[0]}maxSize(){const e=Object.values(this._configs).sort(l);return e[e.length-1]}nearestQuality(e,t){const i=this.order(e),s=this.max(e),o=(0,n.OF)(t,1,4,0,i.length-1);return Math.min(s,i[Math.round(o)])}registerQualities(e,t,i,s,o="max"){const n=this._configs,l=this.order(e,!0),h=t*s;for(let s=t,c=i;s>=h;s*=.5,c*=2){const i=a.encodeKey(e,c),h=n[i];(!h||h&&h.assetSize<t)&&(this._maxTs=Math.min(this._maxTs,c),this._maxLod=Math.max(this._maxLod,e),n[i]={key:i,lod:e,texelSize:c,textureSize:s,assetSize:t,assetType:o,tileSize:Math.min(s,r.Ay.textureTileSize)}),-1===l.indexOf(i)&&l.push(i)}l.sort(((e,t)=>n[t].texelSize-n[e].texelSize))}}function l(e,t){return e.textureSize>t.textureSize?1:-1}class h extends s.Object3D{constructor(){super(...arguments),this.boundingBox=new s.Box3,this.size=new s.Vector3,this.center=new s.Vector3,this._detail="default",this.textureQualityMap=new a,this.addToOctree=!0,this._chunks=[],this.onChunksLoaded=new Set,this.flipDownload=!0,this.flipUpload=!0}get detail(){return this._detail}get chunks(){return this._chunks}get visibleChunks(){return this._chunks}notifyOnChunksLoaded(e){return(0,o.Sh)((()=>this.onChunksLoaded.add(e)),(()=>this.onChunksLoaded.delete(e)),!0)}dispose(){for(const e of this._chunks)e.dispose();this._chunks.length=0}overrideMaxDetail(e){}}},15372:(e,t,i)=>{"use strict";i.r(t),i.d(t,{default:()=>qe});var s=i(68909),o=i(23205),n=i(41733),r=i(54998),a=i(71294),l=i(80328),h=i(35223),c=i(48071),d=i(83916),u=i(79953),m=i(8430),p=i(93279),g=i(83372),f=i(45018),y=i(49191),w=i(97318),v=i(5799),b=i(28743),x=i(48064),M=i(82110),D=i(7662),T=i(79545);const S=new s.Ray,P=new s.Matrix4,C=s.Mesh.prototype.raycast;function A(e,t){if(this.geometry.boundsTree){if(void 0===this.material)return;P.copy(this.matrixWorld).invert(),S.copy(e.ray).applyMatrix4(P);const i=this.geometry.boundsTree;if(!0===e.firstHitOnly){const s=(0,D.sP)(i.raycastFirst(S,this.material),this,e);s&&t.push(s)}else{const s=i.raycast(S,this.material);for(let i=0,o=s.length;i<o;i++){const o=(0,D.sP)(s[i],this,e);o&&t.push(o)}}}else C.call(this,e,t)}function O(e){return this.boundsTree=new T.G(this,e),this.boundsTree}function B(){this.boundsTree=null}let F=!1;var k=i(20052),_=i(69179),V=i(95836),E=i(17413),I=i(18268);class R extends I.u{constructor(e){super(),this.payload={enabled:e}}}R.id="TOGGLE_MESH_OVERLAY_COLOR";var L=i(65576),N=i(27987),U=i(94325),z=i(80172);class G{constructor(e){this.floorUniforms={},this.sharedFloorUniforms={},this.isPanoMode=e}getSharedFloorUniforms(e){return void 0===this.sharedFloorUniforms[`${e}`]&&(this.sharedFloorUniforms[`${e}`]=this.getEmptyCacheUniforms(),this.floorUniforms[`${e}`]?this.updateSharedFloorUniforms(e):this.updateMeshTrimArrays(e,[])),this.sharedFloorUniforms[`${e}`]}updateMeshTrimArrays(e,t){const i=[],o=[];let n=!1;t.forEach((e=>{i.push(this.computeTrimMatrixFromTrim(e,new s.Matrix4)),o.push(e.discardContents),n||(n=e.enabled&&!e.discardContents)})),this.setFloorUniforms(e,{meshTrimMatrices:i,meshTrimsDiscardContents:o,hasKeepVolume:n});`${e}`==`${w.Zu}`?Object.keys(this.sharedFloorUniforms).forEach((e=>{this.updateSharedFloorUniforms(e)})):this.updateSharedFloorUniforms(e)}computeTrimMatrixFromTrim(e,t=new s.Matrix4){return e.enabled&&(!this.isPanoMode||this.isPanoMode&&e.activeInPanoMode)?(t.compose(e.position,e.rotation,e.scale),t.invert()):t.set(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0),t}updateSharedFloorUniforms(e){const t=this.getSharedFloorUniforms(e),i=`${e}`!=`${w.Zu}`?this.getFloorUniforms(e):this.getEmptyCacheUniforms(),o=this.getFloorUniforms(w.Zu),n=new s.Matrix4;n.set(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0),this.concatUniformArrays(t.meshTrimMatrices,o.meshTrimMatrices,i.meshTrimMatrices,n),this.concatUniformArrays(t.meshTrimsDiscardContents,o.meshTrimsDiscardContents,i.meshTrimsDiscardContents,!0),t.hasKeepVolume=o.hasKeepVolume||i.hasKeepVolume,this.sharedFloorUniforms[`${e}`]=t}concatUniformArrays(e,t,i,s){const o=t.concat(i).slice(0,z.HN);for(let e=o.length;e<z.HN;e++)o.push(s);return e.length=0,e.push(...o),e}getFloorUniforms(e){return this.floorUniforms[`${e}`]||this.getEmptyCacheUniforms()}setFloorUniforms(e,t){this.floorUniforms[`${e}`]=t}getEmptyCacheUniforms(){return{meshTrimMatrices:[],meshTrimsDiscardContents:[],hasKeepVolume:!1}}}var H=i(35596),j=i(28997),W=i(61825),Q=i(24081),$=i(12183),q=i(1803),K=i(95226);function X(e,t){if(null==t)return t;if(t.isVector3||t.isVector4||t.isMatrix3||t.isMatrix4||t.isColor)return null!=e?(e.copy(t),e):t.clone();if(Array.isArray(t)&&(Array.isArray(e)||null==e)){null==e&&(e=[]);const i=0===e.length;let s=e.length===t.length;for(let o=0;o<t.length;o++){s=s||void 0===e[o]||e[o]!==t[o];const n=X(i?void 0:e[o],t[o]);i?e.push(n):s&&(e[o]=n)}return e}return t}var Z=i(44588);class Y extends s.ShaderMaterial{constructor(e,t,i,s){const o={};for(const e of t)o[e]=!0;super({fragmentShader:z.fu.fragmentShader,vertexShader:z.fu.vertexShader,uniforms:i,name:e,defines:o}),this.getSide=s,this.capabilities=t}get side(){return this.getSide()}set side(e){}}var J=i(60110),ee=i(27153),te=i(97624);let ie,se=1;try{ie=(0,ee.QN)(0,0)}catch(e){}const oe=5+z.HN,ne=[{key:J.d.PanoTextureTransition,enabled:function(e){return e.progress.value>0&&e.progress.value<1&&e.pano0Map.value!==e.pano1Map.value},dependsOn:[J.d.PanoTexture],uniformsUsed:["progress","pano0Map","pano1Map"]},{key:J.d.PanoTexture,enabled:function(e){return e.panoOpacity.value>0},dependsOn:[],uniformsUsed:["panoOpacity"]},{key:J.d.ColorOverlay,enabled:function(e){return null!==e.colorOverlay.value},dependsOn:[],uniformsUsed:["colorOverlay"]},{key:J.d.MeshPreviewSphere,enabled:function(e){return null!==e.meshPreviewCenter.value},dependsOn:[J.d.MeshTexture],uniformsUsed:[]},{key:J.d.MeshTexture,enabled:function(e){return e.meshOpacity.value>0&&e.map.value},dependsOn:[],uniformsUsed:["meshOpacity","map"]},{key:J.d.Wireframe,enabled:function(e){return!1},dependsOn:[],uniformsUsed:[]},{key:J.d.FlatShading,enabled:function(e){return!1},dependsOn:[],uniformsUsed:[]},{key:J.d.PanoOverlay,enabled:function(e){return!!e.overlay0Map.value},dependsOn:[J.d.PanoTexture],uniformsUsed:["overlay0Map"]},{key:J.d.PanoOverlayTransition,enabled:function(e){return!!(e.progress.value>0&&e.progress.value<1&&e.overlay0Map.value&&e.overlay1Map.value&&e.overlay0Map.value!==e.overlay1Map.value)},dependsOn:[J.d.PanoOverlay,J.d.PanoTexture,J.d.PanoTextureTransition],uniformsUsed:["progress","overlay0Map","overlay1Map"]},{key:J.d.MeshTrimVertex,enabled:function(e,{maxVaryings:t}){return t>oe&&e.meshTrimMatrices.value.some((e=>!!e.elements[15]))},dependsOn:[J.d.MeshTexture],uniformsUsed:[]},{key:J.d.MeshTrimPixel,enabled:function(e,{maxVaryings:t}){return t<=oe&&e.meshTrimMatrices.value.some((e=>!!e.elements[15]))},dependsOn:[J.d.MeshTexture],uniformsUsed:[]},{key:J.d.FloorTrimVertex,enabled:function(e){return!!(e.floorTrimHeight.value<1&&1===e.opacity.value)},dependsOn:[J.d.MeshTexture],uniformsUsed:["floorTrimHeight"]},{key:J.d.FloorTrimPixel,enabled:function(e){return!!(e.floorTrimHeight.value<1&&1===e.opacity.value)},dependsOn:[J.d.MeshTexture],uniformsUsed:["floorTrimHeight"]}],re=new Set(ne.map((e=>e.uniformsUsed)).reduce(((e,t)=>e.concat(t)),[])),ae=new Set(["progress","panoOpacity","meshOpacity","pano0Map","pano0Position","pano0Matrix1","pano0Matrix2","pano1Map","pano1Position","pano1Matrix1","pano1Matrix2","overlay0Map","overlay0Matrix","overlay1Map","overlay1Matrix"]);class le{constructor(e,t,i,o,n="",r="",a=!1){this.meshGroup=e,this.meshSubgroup=t,this.geometry=i,this.sharedState=o,this.textureName=n,this.sourceKey=r,this.id=se++,this.name="",this.lod=Z.X.Standard,this.capabilityOverrides={},this.onMaterialUpdate=new Set,this.uniformCache=le.getUniformDefaults(),this.opacity=1,this.needsVertexNormalRecompute=!0,this.temp={m1:new s.Matrix4,m2:new s.Matrix4,quat:new s.Quaternion,m3:null},this.textureCacheKey=`${r}${n}`,this.standardMaterial=this.getChunkMaterial(this.getCapabilities(),!1),this.updateRenderingMode(),a&&this.setMaterialsUniform(o.globalUniforms)}dispose(){this.geometry.dispose()}static getUniformDefaults(){const e={};for(const t in z.fu.uniforms){const i=s.UniformsUtils.clone(z.fu.uniforms[t]);for(const t in i)e[t]=i[t]}return e}set material(e){if(this._material!==e&&this.onMaterialUpdate)for(const t of this.onMaterialUpdate.values())t(e);this._material=e}get material(){return this._material}notifyOnMaterialUpdated(e){return(0,q.Sh)((()=>this.onMaterialUpdate.add(e)),(()=>this.onMaterialUpdate.delete(e)),!0)}setMeshTexture(e){this.setMaterialsUniform({map:e})}getColorOverlay(){return this._colorOverlay}setColorOverlay(e){this._colorOverlay!==e&&(this.setMaterialsUniform({colorOverlay:e}),this._colorOverlay=e)}setMeshTextureOpacity(e){e!==this._meshTextureOpacity&&(this.setMaterialsUniform({meshOpacity:e,panoOpacity:1-e}),this._meshTextureOpacity=e)}setProgress(e){this._progress!==e&&(this.setMaterialsUniform({progress:e}),this._progress=e)}needsTransparent(){return this.opacity<te.u7.FADE_OPAQUE}setOpacity(e){this.opacity=e;const t=this.needsTransparent();return this.onOpacityUpdate&&this.onOpacityUpdate(e),t!==this._material.transparent}getOpacity(){return this.opacity}setTime(e){this.sharedState.renderingMode===Q.f.Wireframe&&this.setMaterialsUniform({time:e})}setMeshPreviewSphere(e,t=.3){this.setMaterialsUniform({meshPreviewCenter:e,meshPreviewSize:t})}setWireframe(e){if(e){if(this.geometry.getIndex()){const e=this.geometry;e.boundsTree&&(e.boundsTree.geometry=this.geometry.clone()),this.geometry.copy(this.geometry.toNonIndexed())}(0,ee.tn)(this.geometry)}this.overrideCapability(J.d.Wireframe,e)}setFlatShading(e){e&&this.computeVertexNormals(),this.overrideCapability(J.d.FlatShading,e)}computeVertexNormals(){this.needsVertexNormalRecompute&&(this.geometry.computeVertexNormals(),this.needsVertexNormalRecompute=!1)}getCapabilities(){const e=new Set;for(const t in this.capabilityOverrides)this.capabilityOverrides[t]&&e.add(t);for(const t of ne)if(!e.has(t.key)&&t.enabled(this.uniformCache,this.sharedState)){e.add(t.key);for(const i of t.dependsOn)e.add(i)}return e}overrideCapability(e,t){this.capabilityOverrides[e]=t,this.updateMaterialCapabilities()}updateMaterialCapabilities(){const e=this.getCapabilities(),t=this.standardMaterial,i=this.needsTransparent();if((0,K.Mq)(t.capabilities,e)&&i===t.transparent)return this._material;const s=this.getChunkMaterial(e,i);return this.standardMaterial=s,this.sharedState.renderingMode===Q.f.Standard&&(this.material=s),this._material}getChunkMaterial(e,t){let i=`chunkMaterial_${this.sourceKey}`;for(const t of ne)i+=e.has(t.key)?"1":"0";const o=-1===this.meshGroup&&-1===this.meshSubgroup;i+=o?"f":t?"1":"0";const{chunkMaterials:n}=this.sharedState;if(!n[i]){const r=new Y(i,e,this.getUniformsForCapabilities(e),(()=>o?s.BackSide:this.sharedState.side));o?(r.transparent=!0,r.depthWrite=!1):(r.transparent=t,r.depthWrite=!t),n[i]=r}return n[i]}getUniformsForCapabilities(e){const t={};for(const i of e){const e=z.fu.uniforms[i];for(const i in e)t[i]=this.uniformCache[i]}return s.UniformsUtils.clone(t)}setMaterialsUniform(e,t=!1){let i,s=!1;for(const o in e){let n=!1;const r=e[o];if(!(o in this.uniformCache))throw new Error(`Uniform ${o} does not exist in Chunk`);const a=this.uniformCache[o],l=a.value;n="meshPreviewCenter"===o?n||null===l!=(null===r):"meshTrimMatrices"===o||(n||re.has(o)&&l!==r),a.value=X(a.value,r),"opacity"===o&&(i=r),t&&ae.has(o)&&(this.sharedState.globalUniforms[o]=X(this.sharedState.globalUniforms[o],r)),s=s||n}return void 0!==i&&(s=this.setOpacity(i)||s),s&&this.updateMaterialCapabilities(),this._material}updateRenderingMode(){const{renderingMode:e,modeMaterials:t}=this.sharedState;e===Q.f.Standard?this.material=this.standardMaterial:(e!==Q.f.CeilingSample&&e!==Q.f.FloorSample||this.computeVertexNormals(),this.material=t.get(e))}setProjectedPano(e,t,i,s,o=!1){let n=1===e?"pano1Map":"pano0Map";const r={};r[n]=s||ie,t&&(n=1===e?"pano1Position":"pano0Position",r[n]=t),i&&t&&(n=1===e?"pano1Matrix":"pano0Matrix",this.temp.m1.makeRotationFromQuaternion(this.temp.quat.copy(i).invert()),this.temp.m2.makeScale(-1,1,1),r[`${n}1`]=this.temp.m1,r[`${n}2`]=this.temp.m2),this.setMaterialsUniform(r,o)}setOverlayPano(e,t,i,o=!1){const n=`overlay${e}`,r={};if(t){this.temp.m3||(this.temp.m3=new s.Matrix4);const e=this.temp.m3.makeRotationFromQuaternion(t);r[n+"Matrix"]=e}r[n+"Map"]=i||ie,this.setMaterialsUniform(r,o)}onBeforeDraw(e){if(this.sharedState.renderingMode===Q.f.Standard){for(const t of Object.keys(e.uniforms))this.uniformCache[t]&&null!==this.uniformCache[t].value&&(e.uniforms[t].value=this.uniformCache[t].value);e.uniformsNeedUpdate=!0}}getSortKey(){var e,t,i;return null!==(i=null===(t=null===(e=this.uniformCache.map)||void 0===e?void 0:e.value)||void 0===t?void 0:t.id)&&void 0!==i?i:0}}const he=new s.Vector3(0,0,0),ce=new s.Vector3(100,100,100),de=new s.Vector3,ue=new s.Vector3,me=new s.Box3;class pe extends s.Mesh{constructor(e){super(),this.bounds=new s.Box3,this.geometry=new s.BoxGeometry(1,1,1),this.geometry.computeBoundingBox(),this.geometry.computeBoundingSphere(),this.chunk=new le(-1,-1,this.geometry,e);const t=e=>{this.material=e};this.chunk.notifyOnMaterialUpdated(t),t(this.chunk.material),this.name="FallbackMesh",this.renderOrder=$.X.boundingSkybox,this.setFromCenterAndSize(he,ce),this.onBeforeRender=(e,t,i,o,n,r)=>{n instanceof s.ShaderMaterial&&this.chunk.onBeforeDraw(n)}}setBounds(e){if(this.bounds.equals(e))return;this.bounds.copy(e);const t=e.getSize(de);this.position.copy(e.getCenter(ue)),this.scale.set(t.x,t.y,t.z),this.updateMatrixWorld(!0)}setFromCenterAndSize(e,t=ce){this.setBounds(me.setFromCenterAndSize(e,t))}}var ge=i(73657);class fe{constructor(e,t,i,o,n,r,a,l){this.meshModule=e,this.scene=t,this.container=i,this.mesh=o,this.meshData=n,this.sweepData=r,this.chunkSharedState=a,this.renderOptions=l,this.chunkRenderingModeOverride=null,this.lastChunkRenderingModeOverride=null,this.fallbackMesh=new pe(this.chunkSharedState),this.overlayColors=[],this.toolMeshColorEnabled=!1,this.TOOL_MESH_COLOR_OVERLAY=new s.Vector4(0,0,0,.3),this.overlayTextures=[{sweepId:void 0,texture:void 0,renderTarget:new s.WebGLCubeRenderTarget(2048,{format:s.RGBAFormat}),quaternion:new s.Quaternion},{sweepId:void 0,texture:void 0,renderTarget:new s.WebGLCubeRenderTarget(2048,{format:s.RGBAFormat}),quaternion:new s.Quaternion}],this.overlayEnabled=!1,this.bindings=[],this.updateFallbackMesh=(()=>{const e=new s.Box3;return t=>{if(this.sweepData.currentAlignedSweepObject&&this.viewmodeData.isInside()){const t=e.copy(this.meshData.extendedBounds).expandByScalar(.2);this.fallbackMesh.setBounds(t)}else this.cameraData&&this.fallbackMesh.setFromCenterAndSize(this.cameraData.pose.position);this.fallbackMesh.material&&(this.fallbackMesh.material.transparent=!(t<1e-5))}})(),this.opacity=null,this.debugColorizeChunks=(()=>{let e=!1;return(t,i)=>{const o=new s.Vector4(1,1,1,0);e=!e,(e=>{for(const t of this.mesh.chunks){const s=i?100*t.id:100*t.meshSubgroup,n=e?(0,W.Zd)(.5,s):o;t.setColorOverlay(n)}})(t||e)}})()}init(){}dispose(){}async activate(e){[this.applicationData,this.viewmodeData,this.settings,this.cameraData,this.renderer]=await Promise.all([e.market.waitForData(H.zH),e.market.waitForData(x.X),e.market.waitForData(j.o),e.market.waitForData(f.M),e.getModuleBySymbol(h.M7)]),this.panoRenderer=(await e.getModuleBySymbol(h.qD)).getRenderer(),this.scene.add(this.container),this.scene.add(this.fallbackMesh),this.fallbackMesh.layers.mask=this.container.layers.mask,this.updateRenderState(),this.bindings.push(this.viewmodeData.onChanged(this.updateRenderState.bind(this)),this.sweepData.onChanged(this.updateRenderState.bind(this)),this.settings.onChanged(this.updateRenderState.bind(this)),this.settings.onPropertyChanged(te._Z,(e=>this.toggleWireframe(e)))),this.bindings.push(this.mesh.notifyOnChunksLoaded((t=>{for(const e of this.overlayColors)e(t);e.msgBus.broadcast(new ge.qZ)}))),this.renderOptions.colorizeRooms&&this.debugColorizeChunks(!0),this.renderOptions.colorizeChunks&&this.debugColorizeChunks(!0,!0),this.renderOptions.wireframe&&this.toggleWireframe(!0)}deactivate(){for(const e of this.bindings)e.cancel();this.bindings=[],this.scene.remove(this.container),this.scene.remove(this.fallbackMesh),this.currentSweepId&&this.panoRenderer.freeTexture(this.currentSweepId),this.currentSweepId=null,this.targetSweepId=null}updateSweepRenderTarget(e,t,i,s){const o=this.panoRenderer.useTexture(t);if(o){let t=!0;for(const n of this.allChunks())n.setProjectedPano(e,i,s,o,t),t=!1}}*allChunks(){yield*this.mesh.chunks,yield this.fallbackMesh.chunk}updateExistingTexture(e,t,i,s){let o=!0;for(const n of this.allChunks())e===this.currentSweepId&&n.setProjectedPano(0,i,s,t,o),e===this.targetSweepId&&n.setProjectedPano(1,i,s,t,o),o=!1}render(){}beforeRender(){var e;const{floorOpacity:t,globalOpacityModifier:i,meshTextureOpacity:s}=this.meshModule.meshGroupVisuals;for(const o of this.mesh.visibleChunks){const n=(null!==(e=t.get(`${o.meshGroup}`))&&void 0!==e?e:1)*i.value;o.setMaterialsUniform({meshOpacity:s.value,panoOpacity:1-s.value,opacity:null!==this.opacity?this.opacity:n,progress:this.sweepData.transition.progress.value})}const o=(0,u.p_)(s.value,0,1,1);this.fallbackMesh.chunk.setMeshTextureOpacity(o),this.fallbackMesh.chunk.setProgress(this.sweepData.transition.progress.value),this.updateFallbackMesh(o)}updateChunkMaterialMode(e,t){const i=e?s.DoubleSide:s.FrontSide;this.chunkSharedState.side=i,this.chunkSharedState.renderingMode=t||Q.f.Standard;for(const e of this.mesh.chunks)e.updateRenderingMode()}updateRenderState(){if(this.viewmodeData.currentMode!==this.lastViewmode||this.lastChunkRenderingModeOverride!==this.chunkRenderingModeOverride){this.lastChunkRenderingModeOverride=this.chunkRenderingModeOverride;const e=this.viewmodeData.isInside();this.updateChunkMaterialMode(e,this.chunkRenderingModeOverride),this.lastViewmode=this.viewmodeData.currentMode}if(this.viewmodeData.transition.active&&(0,M.nI)(this.viewmodeData.transition.to)||this.viewmodeData.isInside()){const e=this.sweepData.currentSweep,t=this.sweepData.transition,i=t.active&&(this.applicationData.phase===H.Jj.PLAYING||this.applicationData.phase===H.Jj.STARTING),s=i?t.from:e,o=i?t.to:e,n=this.currentSweepId,r=this.targetSweepId;this.currentSweepId=s||null,this.targetSweepId=o||null,this.handleSweepChange(0,n,this.currentSweepId),this.handleSweepChange(1,r,this.targetSweepId)}if(this.overlayEnabled){const e=this.overlayTextures.find((e=>e.sweepId===this.currentSweepId)),t=this.overlayTextures.find((e=>e.sweepId===this.targetSweepId));let i=!0;for(const s of this.allChunks())s.setOverlayPano(0,e?e.quaternion:void 0,e?e.texture:void 0,i),s.setOverlayPano(1,t?t.quaternion:void 0,t?t.texture:void 0,i),i=!1}}handleSweepChange(e,t,i){if(t!==i&&(t&&this.panoRenderer.freeTexture(t),i)){const t=this.sweepData.getSweep(i);this.updateSweepRenderTarget(e,i,t.position,t.rotation)}}async onPanoOverlayCommand(e){this.overlayEnabled=!0;const t=t=>{const i=t.renderTarget;t.renderTarget.width=e.texture.image.width,t.renderTarget.height=e.texture.image.height,t.sweepId=e.sweepId,t.texture=i.texture,t.quaternion=e.quaternion,this.renderer.cwfRenderer.copyCubemap(e.texture,t.renderTarget)};let i=!1;for(const s of this.overlayTextures)i||s.sweepId!==e.sweepId||(t(s),i=!0);for(const e of this.overlayTextures)i||e.sweepId===this.targetSweepId||e.sweepId===this.currentSweepId||(t(e),i=!0);this.updateRenderState()}async onMeshOverlayCommand(e){let t=()=>!0;switch(e.selectBy){case V.T.selectBy.all:t=()=>!0,this.overlayColors.length=0;break;case V.T.selectBy.byMeshGroup:t=t=>t.meshGroup===e.index;break;case V.T.selectBy.byMeshSubGroup:t=t=>t.meshSubgroup===e.index}if(!t)return;let i="rand";e.colorStyle===V.T.colorBy.explicit&&(i=e.color?new s.Vector4(e.color.x,e.color.y,e.color.z,e.color.w):null);const o=s=>{for(const o of s)t(o)&&o.setColorOverlay("rand"===i?(0,W.Zd)(e.alpha):i)};o([...this.allChunks()]),e.selectBy===V.T.selectBy.all&&null===i||this.overlayColors.push(o)}async toggleMeshOverlayColor({enabled:e}){if(e!==this.toolMeshColorEnabled)return this.toolMeshColorEnabled=e,this.onMeshOverlayCommand({color:e?this.TOOL_MESH_COLOR_OVERLAY:null,selectBy:V.T.selectBy.all,colorStyle:V.T.colorBy.explicit,alpha:.5})}onSetChunkRenderStateCommand(e){this.chunkRenderingModeOverride=e,this.updateRenderState()}toggleWireframe(e){for(const t of this.mesh.chunks)t.setWireframe(e)}}var ye=i(14495),we=i(46785),ve=i(35652),be=i(44383),xe=i(43998),Me=i(90280),De=i(82873),Te=i(77475),Se=i(84619);class Pe{constructor(e,t,i=Z.X.Standard,s){this.textureName=e,this.mesh=t,this.lod=i,this.chunkedTexInfo=s,this.chunks=new Set,this.loading=!1,this.unloaded=!1,this.screenCoverage=0,this.screenCoverageScore=0,this.sightings=new Se.C(te.xT.sightingMaxAge),s&&(this.textureQualityMap.registerQualities(i,s.maxTextureSize,s.maxTexelSize,s.minScale),this.quality=this.textureQualityMap.min(i),this.targetQuality=this.quality),this.minQuality=this.textureQualityMap.min(i),this.maxQuality=this.minQuality}get textureQualityMap(){return this.mesh.textureQualityMap}setTexture(e){const t=this.texture;if(this.texture=e,t&&t!==e&&t.dispose(),e)for(const t of this.chunks)t.setMeshTexture(e)}getEmbeddedTexture(){var e;const t=null===(e=this.chunks.entries().next())||void 0===e?void 0:e.value;return t?t[0].embeddedTexture:void 0}}class Ce{constructor(e,t,i=.85){this.renderer=e,this.maxBudget=t,this.pctTotalMemory=i,this.slots=[],this.lods=new Map,this.orders={},this.slotTexSizes=new Map}dispose(){this.slots=[],this.lods.clear(),this.orders={}}update(e){this.updateBudget(void 0),this.updateTargetQualitiesFromBudget()}updateBudget(e){if(e){this.dispose();const t=new Map;this.slots=e,e.forEach((e=>{const i=this.lods.get(e.lod)||new Set;i.add(e),this.lods.set(e.lod,i);const s=t.get(e.lod)||new Set;e.textureQualityMap.order(e.lod).forEach((e=>s.add(e))),t.set(e.lod,s)}));for(const e of t.keys()){const i=t.get(e);i&&(this.orders[e]=Array.from(i.values()).sort())}}if(this.shouldRestrictBudget()){const e=this.calcCurrentTexturesSize(),t=this.renderer.estimatedGPUMemoryAllocated()-e,i=this.maxBudget()-t;this.budget=i*this.pctTotalMemory}else this.budget=1/0;return this}updateTargetQualitiesFromBudget(){let e=0;for(const t of this.slots)this.updateBudgetSize(t),t.targetQuality=t.minQuality,e+=this.getBudgetSize(t,t.targetQuality);const t=(t,i)=>t.maxQuality<i||!t.textureQualityMap.valid(i)||(e-=this.getBudgetSize(t,t.targetQuality),e+=this.getBudgetSize(t,i),!(e>this.budget)&&(t.targetQuality=i,!0));if(this.shouldRestrictBudget()){for(const e of this.slots)for(const i of this.orders[e.lod])if(!t(e,i))return}else for(const[e,i]of this.lods.entries())for(const s of this.orders[e])for(const e of i)if(!t(e,s))return}shouldRestrictBudget(){return this.maxBudget()!==1/0}getBudgetSize(e,t){if(!t)return 0;const i=e.textureQualityMap.get(t);let s=0;if(e){const i=e.textureQualityMap.min(e.lod);i!==t&&e.getEmbeddedTexture()&&(s=this.getBudgetSize(e,i));const o=e.textureName+t,n=this.slotTexSizes.get(o);if(n)return n+s}return(i?i.textureSize:4096)**2*4+s}updateBudgetSize(e){var t;const i=e.textureName+e.quality,s=null!==(t=e.texture)&&void 0!==t?t:e.getEmbeddedTexture();this.slotTexSizes.set(i,this.texSizeBytes(s))}calcCurrentTexturesSize(){return this.slots.reduce(((e,t)=>{var i;const s=t.getEmbeddedTexture(),o=null!==(i=t.texture)&&void 0!==i?i:s;return o===s?e+this.texSizeBytes(o):e+this.texSizeBytes(o)+this.texSizeBytes(s)}),0)}texSizeBytes(e){var t;if(!e)return 0;if(null===(t=e.mipmaps)||void 0===t?void 0:t.length){let t=0;for(const i of e.mipmaps)if("data"in i)t+=i.data.length;else{const{width:e,height:s}="image"in i?i.image:i;t+=e*s*4}return t}let i=e.image.width*e.image.height*4,s=i/4;for(;s>=1;)i+=s,s/=4;return i}}const Ae=new ve.Ay("tex-lod");class Oe{constructor(e,t,i,s,o,n,r){this.textureLOD=e,this.api=t,this.camera=i,this.renderToTextureModule=s,this.engine=o,this.chunkVisibilityChecker=n,this.rendererModule=r,this.name="texture-streaming",this.limitMemoryUsage=!1,this.allocatedMegsBeforeLimitingLod=350,this.slots=[],this.textureKeyToSlot={},this.chunkSourceToMesh=new Map,this.meshes=new Map,this.chunkIdToSlot={},this._systemMin=Te.M.LOW,this._systemMax=Te.M.ULTRA,this.meshMinMax=new Map,this.allowTextureDownload=()=>!0,this.concurrentLoadingTextures=1,this.concurrentDownloadingTiles=12,this.autoLoadTiles=!1,this.lastSortedAt=0,this.loadingTextures=0,this.downloadingTiles=0,this.totalTextures={},this.totalTiles=0,this.abortController=new AbortController,this.bindings=[],this.textureApiInfo=new Map,this._chunkSlotsSet=new Set,this.loadImage=async(e,t,i,s,o)=>{var n;const r=e.textureQualityMap.get(t),{assetType:a,lod:l}=r,h=(null===(n=e.chunkedTexInfo)||void 0===n?void 0:n.maxTextureSize)||r.assetSize;let c,d=e.textureName;if(this.textureApiInfo){if(!e.chunkedTexInfo){const e=d.match(/[_.]([0-9]{3})[_.]/);if(!e)throw new Error(`Could not parse texture index from texture name: ${d}`);d=e[1]}const t=this.textureApiInfo.get(e.mesh);if(!t)throw new Error(`No texture URLs found for mesh: ${e}`);c=(await t[a].get()).urlTemplate.replace("<folder>",`${l}`).replace("<texture>",d)}else{const e=d.match(/^([a-f0-9]+(_10k|_50k)?)/);if(!e)throw new Error(`Unknown format for texture name: ${d}`);c=`${e[0]}_texture_jpg_${a}/${d}`}const{sourceSize:u=h,sourceX:m=0,sourceY:p=0,destSize:g=u}=s,f={};return g!==u&&(f.width=`${g}`),u!==h&&(f.crop=`${u},${u},x${m/h},y${p/h}`),c=(0,be.Gm)(c,f),i.getImageBitmap(c,g,g,o)},this.textureBudgeter=new Ce(this.rendererModule,(()=>this.limitMemoryUsage?this.allocatedMegsBeforeLimitingLod*2**20:1/0)),this.bindings.push(this.chunkVisibilityChecker.notifyOnNewSighting(((e,t)=>{const i=this.chunkSourceToMesh.get(e.sourceKey);if(i){const s=this.addChunkSlots(i,[e]);for(const e of s)e.sightings.push(t)}})))}setModel(e,t,i){if(this.textureApiInfo.set(e,i),0===t.length)throw new Error("Chunks required");this.addChunkSlots(e,[...t]),this.textureBudgeter.updateBudget(this.slots),this.updateSystemQualityRanges()}clearSlots(){this.abortController.abort(),this.slots.forEach((e=>{this.removeChunks([...e.chunks])})),this.abortController=new AbortController}dispose(){this.abortController.abort(),this.bindings.forEach((e=>e.cancel())),this.bindings.length=0,this.clearSlots(),this._chunkSlotsSet.clear(),this.textureBudgeter.dispose(),this.textureApiInfo.clear()}addChunkSlots(e,t){const i=this.meshes.get(e)||0;this.meshes.set(e,i+t.length),t.forEach((t=>{this.chunkSourceToMesh.set(t.sourceKey,e)})),this._chunkSlotsSet.clear();let s=!1;for(const i of t){const t=i.textureName;let o=this.textureKeyToSlot[i.textureCacheKey];o||(s=!0,o=new Pe(t,e,i.lod,i.textureLODInfo),i.embeddedTexture&&o.setTexture(i.embeddedTexture),this.textureKeyToSlot[i.textureCacheKey]=o,this.slots.push(o)),o.chunks.has(i)||(s=!0,o.chunks.add(i),o.texture&&i.setMeshTexture(o.texture)),this._chunkSlotsSet.add(o),this.chunkIdToSlot[i.id]=o}return s&&this.textureBudgeter&&(this.textureBudgeter.updateBudget(this.slots),this.updateSystemQualityRanges()),this._chunkSlotsSet}removeChunks(e){var t;for(const i of e){const e=this.chunkIdToSlot[i.id];if(!e){Ae.error("Missing slot for chunk!",i.id,i.textureCacheKey,i);continue}if(e.chunks.delete(i),0===e.chunks.size){e.unloaded=!0,e.setTexture(null);const t=this.slots.indexOf(e);this.slots.splice(t,1),delete this.textureKeyToSlot[i.textureCacheKey]}delete this.chunkIdToSlot[i.id];const s=this.chunkSourceToMesh.get(i.sourceKey);if(s){(null!==(t=this.meshes.get(s))&&void 0!==t?t:1)-1<=0&&(this.meshes.delete(s),this.meshMinMax.delete(s.textureQualityMap))}this.chunkSourceToMesh.delete(i.sourceKey)}}setQuality(e,t){this._systemMin=e,this._systemMax=t,this.updateSystemQualityRanges()}updateSystemQualityRanges(){this.meshMinMax.clear();for(const e of this.meshes.keys()){const t=e.textureQualityMap.lods(),i={min:{},max:{}};for(const s of t)i.min[s]=e.textureQualityMap.nearestQuality(s,this._systemMin),i.max[s]=e.textureQualityMap.nearestQuality(s,this._systemMax);this.meshMinMax.set(e.textureQualityMap,i)}for(const e of this.slots){const t=this.meshMinMax.get(e.textureQualityMap);t?(e.minQuality=t.min[e.lod],e.maxQuality=e.maxQuality?Math.min(t.max[e.lod],e.maxQuality):t.max[e.lod]):Ae.error("Missing min/max lod for slot")}}get textureCount(){return this.slots.length}async loadAll(e,t){const i=this.slots.filter((t=>t.mesh===e));i[0]&&i[0].textureName&&await this.loadSlots(i,t)}async loadSlots(e,t=(e.length>0?e[0].textureQualityMap.min(Z.X.Standard):Z.X.Standard)){if(!e.length)return;const i=e[0].textureQualityMap;i.valid(t)?await Promise.all(e.map((e=>this.loadTexture(e,t,!1)))):Ae.warn(t,"not found in",i)}onWebGLContextLost(){this.abortController.abort();for(const e of this.slots)e.texture=null}onWebGLContextRestored(){this.abortController=new AbortController;for(const e of this.slots)this.loadTexture(e,e.quality)}async loadTexture(e,t,i=!0){var s,o;const n=e.textureQualityMap;n.valid(t)||Ae.warn(t,"not found in",n);const r=n.get(t),a=(null===(s=e.chunkedTexInfo)||void 0===s?void 0:s.maxTextureSize)||r.assetSize,l=Math.min(a,r.textureSize);e.lastLoadedAt=performance.now();let h=e.texture;if(!h||t!==e.quality)if(h&&t<e.quality&&e.texture){const i=null===(o=e.chunks.values().next().value)||void 0===o?void 0:o.embeddedTexture;if(i&&i.image.width>=l&&i.mipmaps[0].data.length<=l*l*4)e.quality=t,e.setTexture(i);else{const i=this.renderToTextureModule.resizeTexture(h,l);Be(i,e),e.quality=t,e.setTexture(i)}this.engine.msgBus.broadcast(new ge.Ny)}else{e.loading=!0,this.loadingTextures++,this.totalTextures[l]=(this.totalTextures[l]||0)+1;try{h=this.textureLOD!==N.R.NONE&&i?await this.loadTextureTiled(l,t,e,this.abortController.signal):await this.loadTextureSolid(l,t,e,this.abortController.signal),e.unloaded?h.dispose():(Be(h,e),e.setTexture(h),this.engine.msgBus.broadcast(new ge.Gf))}catch(e){}finally{this.loadingTextures--,e.quality=t,e.loading=!1}}}async loadTextureTiled(e,t,i,o){var n;const r=this.rendererModule.cwfRenderer,a=r.initSizedTexture2D(e,{generateMipmaps:!1,minFilter:s.LinearFilter,magFilter:s.LinearFilter}),l=i.textureQualityMap,h=(null===(n=i.chunkedTexInfo)||void 0===n?void 0:n.maxTextureSize)||l.get(t).assetSize,c=Math.min(h,l.get(t).textureSize),d=Math.min(c,l.get(t).tileSize),u=async(e,s)=>{let n;this.downloadingTiles+=1,this.totalTiles+=1;const l=i.mesh.flipDownload;try{n=await this.loadImage(i,t,this.api,{sourceSize:h*(d/c),sourceX:h*(e/c),sourceY:h*(s/c),destSize:d},{priority:ye.QK.LOW,flipY:l,signal:o})}finally{this.downloadingTiles-=1}const u=e,m=i.mesh.flipUpload?c-s-d:s,p=new De.m("mesh/texture/upload-tiles",(()=>this.engine.after(we.R.End).then((()=>{if(o.aborted)throw new DOMException("Aborted","AbortError");a.flipY=l&&n instanceof HTMLImageElement,r.uploadTexture2D(n,a,u,m)}))),100);return(await this.engine.commandBinder.issueCommand(p)).promise.finally((()=>{var e,t;n&&(null===(t=(e=n).close)||void 0===t||t.call(e))}))},m=[];for(let e=0;e<c;e+=d)for(let t=0;t<c;t+=d)m.push(u(e,t));try{await Promise.all(m)}catch(e){throw a.dispose(),e}return a}async loadTextureSolid(e,t,i,s){var o,n;const r=this.rendererModule.cwfRenderer,a=r.initSizedTexture2D(e);let l=null;try{const e=i.textureQualityMap.get(t).textureSize,o=i.mesh.flipDownload;l=await this.loadImage(i,t,this.api,{destSize:e},{priority:ye.QK.LOW,flipY:o,signal:s}),a.flipY=o&&l instanceof HTMLImageElement,r.uploadTexture2D(l,a,0,0)}catch(e){throw a.dispose(),e}finally{l&&(null===(n=(o=l).close)||void 0===n||n.call(o))}return a}setImageLoader(e){this.loadImage=e}analyzeTextureScreenCoverageFromRaycasts(){const e=this.rendererModule.cwfRenderer.getSize().x,t=this.camera.getWorldPosition(new s.Vector3);for(const i of this.slots){i.screenCoverage=0,i.screenCoverageScore=0,i.maxQuality=i.minQuality;const s=i.sightings.getList(),o=i.sightings.index-1;for(let n=0;n<s.length;n++){const r=s[(o-n+s.length)%s.length];if(r.raycastAge<this.chunkVisibilityChecker.raycastCounter-te.Ay.sightingMaxAge)break;const a=t.distanceTo(r.point),l=(0,Me.ff)(a,this.camera.projectionMatrix,e);let h=i.textureQualityMap.fromPixelSize(i.lod,l);const c=this.meshMinMax.get(i.textureQualityMap);h=Math.min(h,c?c.max[i.lod]:this._systemMax),i.screenCoverageScore+=h,i.screenCoverage+=1,i.maxQuality=Math.max(h,i.maxQuality)}}this.slots.sort(((e,t)=>t.screenCoverageScore-e.screenCoverageScore)),this.textureBudgeter.updateTargetQualitiesFromBudget()}update(e){if(!this.camera||!this.autoLoadTiles||this.abortController.signal.aborted)return;this.textureBudgeter.update(e);const t=performance.now();this.textureLOD===N.R.RAYCAST&&this.scheduleRaycastTasks(t);let i=!1;for(let e=this.slots.length-1;e>=0;e--){const s=this.slots[e],o=(0,xe.qE)(s.targetQuality,s.minQuality,s.maxQuality),n=t-s.lastLoadedAt<1e3;if(!s.loading&&s.quality>o){n?i=!0:this.loadTexture(s,o);break}}if(this.allowTextureDownload()&&!i)for(const e of this.slots){if(this.loadingTextures>=this.concurrentLoadingTextures||this.downloadingTiles>=this.concurrentDownloadingTiles)break;const t=(0,xe.qE)(e.targetQuality,e.minQuality,e.maxQuality);!e.loading&&e.quality<t&&this.loadTexture(e,e.textureQualityMap.moreDetailed(e.lod,e.quality))}}scheduleRaycastTasks(e){if(!this.analyzeTaskPromise&&e-this.lastSortedAt>200){const e=()=>{this.analyzeTextureScreenCoverageFromRaycasts(),this.lastSortedAt=performance.now()},t=async e=>{await e.promise,this.analyzeTaskPromise=null},i=new De.m("mesh/texture/analyze-screen-coverage",e,100);this.analyzeTaskPromise=this.engine.commandBinder.issueCommand(i).then(t)}}}function Be(e,t){e.addEventListener("dispose",(()=>{e===t.texture&&Ae.warn("Streamed texture disposed while still in use")}))}var Fe=i(85843),ke=i(90302),_e=i(10691),Ve=i(96822);const Ee=Math.round(te.Ay.sightingMaxAge/60/5)||1;class Ie{resetCounter(){this.lastReset=this.raycastCounter}constructor(e,t,i){this.scene=e,this.raycaster=t,this.pose=i,this.raycastCounter=0,this.onNewSighting=new Set,this.lastReset=0,this.raycastRandomScreenLocation=(()=>{const e=new s.Vector3,t=new s.Vector3,i=new s.Vector3;function o(e){return!!((0,ke.aV)(e)&&e instanceof _e.B)&&e.chunks.some((e=>e.getOpacity()>te.u7.FADE_TILE_VISIBLE_THRESHOLD))}return(s,n,r)=>{this.raycastCounter++;const a=(2-2*n)/s,l=-1+n,h=this.raycastCounter%(s*s),c=h%s,d=l+(h-c)/s*a,u=l+c*a+Math.random()*a,m=d+Math.random()*a;e.set(u,m,-1).unproject(this.camera),t.set(u,m,1).unproject(this.camera),i.subVectors(t,e).normalize();const p=this.raycaster.pick(e,i,o);if(p){if(p.face&&p.object instanceof _e.B){const e=p.object.getChunk(p.face.materialIndex),t={point:p.point.clone(),raycastAge:this.raycastCounter};for(const i of this.onNewSighting.values())i(e,t)}r&&r(p)}}})(),this.camera=e.camera}update(){const e=te.Ay.debugLOD?(0,Ve.rt)(65280,this.scene,this.pose):void 0,t=performance.now();for(let i=0;i<Ee&&performance.now()-t<.5&&this.raycastCounter<=this.lastReset+te.Ay.sightingMaxAge;i++)this.raycastRandomScreenLocation(5,.05,e)}notifyOnNewSighting(e){return(0,q.Sh)((()=>this.onNewSighting.add(e)),(()=>this.onNewSighting.delete(e)),!0)}}var Re=i(19533);const Le=i.p+"images/uv_grid_opengl.jpg",Ne=e=>new s.RawShaderMaterial({fragmentShader:z.Ay.ceilingProcess.fragmentShader,vertexShader:z.Ay.ceilingProcess.vertexShader,transparent:!0,defines:e,uniforms:{},side:s.BackSide,name:"materialFloorProcess",glslVersion:s.GLSL3,stencilRef:1,stencilFuncMask:65535,stencilWrite:!0,stencilFunc:s.EqualStencilFunc,stencilFail:s.KeepStencilOp,stencilZFail:s.KeepStencilOp,stencilZPass:s.KeepStencilOp,blending:s.MultiplyBlending});class Ue{constructor(){this.materials=new Map}get(e){let t=this.materials.get(e);return t||(t=ze[e](),this.materials.set(e,t)),t}}const ze={[Q.f.Depth](){const e=s.UniformsUtils.clone(z.Ay.depth.uniforms);return new s.ShaderMaterial({fragmentShader:z.Ay.depth.fragmentShader,vertexShader:z.Ay.depth.vertexShader,uniforms:e,side:s.FrontSide,name:"materialDepth"})},[Q.f.Transparent](){const e=s.UniformsUtils.clone(z.Ay.modelOutside.uniforms);return e.opacity.value=.2,e.colorOverlay.value.set(1,1,1,1),new s.ShaderMaterial({fragmentShader:z.Ay.modelOutside.fragmentShader,vertexShader:z.Ay.modelOutside.vertexShader,uniforms:e,side:s.FrontSide,transparent:!0,name:"materialTransparent"})},[Q.f.Wireframe](){const e=s.UniformsUtils.clone(z.Ay.modelOutside.uniforms);return e.opacity.value=.5,e.colorOverlay.value.set(1,1,1,1),new s.ShaderMaterial({fragmentShader:z.Ay.modelOutside.fragmentShader,vertexShader:z.Ay.modelOutside.vertexShader,uniforms:e,side:s.FrontSide,transparent:!0,wireframe:!0,name:"materialWireframe"})},[Q.f.UV]:()=>new s.MeshBasicMaterial({name:"uv-debug",map:(0,Re.y)(Le)}),[Q.f.CeilingSample]:()=>Ne({CEILING_SAMPLE:!0}),[Q.f.FloorSample]:()=>Ne({FLOOR_SAMPLE:!0})};class Ge{constructor(){this.side=s.FrontSide,this.renderingMode=Q.f.Standard,this.chunkMaterials={},this.modeMaterials=new Ue,this.globalUniforms={}}forEachChunkMaterial(e){const{chunkMaterials:t}=this;for(const i in t)e(t[i])}dispose(){const{chunkMaterials:e}=this;for(const t in e){const i=e[t];for(const e in i.uniforms)i.uniforms[e].value instanceof s.Texture&&i.uniforms[e].value.dispose();i.dispose(),delete e[t]}}}var He=i(61589),je=i(45021),We=i(39486);const Qe=new ve.Ay("MeshTrimData");class $e extends He.B{constructor(){super(),this.maxTrimsPerFloor=z.HN,this.maxAllFloorsTrims=z.HN,this.numberOfTrims=0,this.meshTrimsByMeshGroup=new r.E,this.meshTrimsById=new r.E,this.onMeshGroupChangedCallbacks=new Set,this.onMeshTrimChangedCallbacks=new Set,this.updateMeshTrim=e=>{for(const t of this.onMeshTrimChangedCallbacks)t(e)},this.notifyMeshGroupChanges=e=>{for(const t of this.onMeshGroupChangedCallbacks)t(e)},this.meshTrimsByMeshGroup.set(`${w.Zu}`,new je.X)}addMeshGroups(e){for(const t of e)if(!this.meshTrimsByMeshGroup.has(`${t}`)){const e=new je.X;this.meshTrimsByMeshGroup.set(`${t}`,e)}this.singleFloorMeshGroup||1!==e.length||(this.singleFloorMeshGroup=e[0])}add(...e){const t=new Set;let i=!1;if(this.meshTrimsById.atomic((()=>{this.meshTrimsByMeshGroup.atomic((()=>{for(const s of e){void 0!==this.singleFloorMeshGroup&&(s.meshGroup=this.singleFloorMeshGroup);const e=s.meshGroup===w.Zu,o=`${s.meshGroup}`;this.meshTrimsByMeshGroup.has(o)||this.meshTrimsByMeshGroup.set(o,new je.X);const n=this.meshTrimsByMeshGroup.get(o);n.length<(e?this.maxAllFloorsTrims:this.maxTrimsPerFloor)?(n.push(s),this.meshTrimsById.set(s.id,s),t.add(s.meshGroup),s.onChanged(this.updateMeshTrim)):(Qe.debugWarn("Trims exceed floor limit (trimId, meshGroup):",s.id,s.meshGroup),i=!0)}}))})),t.forEach((e=>{const t=this.meshTrimsByMeshGroup.get(`${e}`);this.sortList(t),this.reassignIndexes(t),this.notifyMeshGroupChanges(e)})),this.updateDerivedProperties(),i)throw new We.J("Exceeding max trims")}delete(...e){const t=new Set;this.meshTrimsByMeshGroup.atomic((()=>{for(const i of e){const e=this.meshTrimsByMeshGroup.get(`${i.meshGroup}`),s=e.indexOf(i);if(s>=0){e.splice(s,1)[0].enabled=!1,t.add(i.meshGroup),i.removeOnChanged(this.updateMeshTrim)}else Qe.error("Could not delete mesh trim:"+i.id)}})),t.forEach((e=>{const t=this.meshTrimsByMeshGroup.get(`${e}`);this.reassignIndexes(t),this.notifyMeshGroupChanges(e)})),this.meshTrimsById.atomic((()=>{e.forEach((e=>{this.meshTrimsById.delete(e.id)}))})),this.updateDerivedProperties()}updateDerivedProperties(){this.numberOfTrims=this.meshTrimsById.length,this.maxTrimsPerFloor=z.HN-this.meshTrimsByMeshGroup.get(`${w.Zu}`).length,this.maxAllFloorsTrims=z.HN-this.getLongestTrimListLength(),this.commit()}onMeshGroupChanged(e){return(0,q.Sh)((()=>this.onMeshGroupChangedCallbacks.add(e)),(()=>this.onMeshGroupChangedCallbacks.delete(e)))}onMeshTrimChanged(e){return(0,q.Sh)((()=>this.onMeshTrimChangedCallbacks.add(e)),(()=>this.onMeshTrimChangedCallbacks.delete(e)))}getTrimById(e){return this.meshTrimsById.get(e)}getTrim(e,t){return this.meshTrimsByMeshGroup.has(`${e}`)?this.meshTrimsByMeshGroup.get(`${e}`).get(t):null}getTrimsForMeshGroup(e){return this.meshTrimsByMeshGroup.has(`${e}`)?this.meshTrimsByMeshGroup.get(`${e}`).values():[]}getAllMeshGroups(){return this.meshTrimsByMeshGroup.keys}*activeTrimsForMeshGroup(e){if(this.meshTrimsByMeshGroup.has(`${e}`))for(const t of this.meshTrimsByMeshGroup.get(`${e}`))t.enabled&&(yield t);if(this.meshTrimsByMeshGroup.has(`${w.Zu}`))for(const e of this.meshTrimsByMeshGroup.get(`${w.Zu}`))e.enabled&&(yield e)}reassignIndexes(e){e.forEach(((e,t)=>{e.index=t}))}sortList(e){e.sort(((e,t)=>e.index-t.index))}getLongestTrimListLength(){let e=0;return this.meshTrimsByMeshGroup.keys.forEach((t=>{if(t===`${w.Zu}`)return;const i=this.meshTrimsByMeshGroup.get(t);e=Math.max(i.length,e)})),e}}class qe extends o.n{constructor(){super(...arguments),this.name="model-mesh",this.commands={MeshPreviewSetPositonCommand:k.P,SetChunkRenderModeCommand:_.w,SetMeshOverlayCommand:V.T,SetPanoOverlayCommand:E.a,ToggleMeshOverlayColorCommand:R},this.meshTrimData=new $e,this.meshes=new Map,this.inactiveMeshes=new Map,this.meshGroupVisuals={allFloorsVisibleInOrtho:new n.L(!0),floorOpacity:new r.E,globalOpacityModifier:new n.L(1),meshTextureOpacity:new d.z(1)},this.meshesLoaded=0,this.meshLoadPromises=new Map,this._firstMeshLoadPromise=new a.i,this._renderMode=L.p.Hidden,this.onMeshOverlayCommand=e=>{for(const t of this.allMeshes())t.renderer.onMeshOverlayCommand(e)},this.toggleMeshOverlayColor=e=>{for(const t of this.allMeshes())t.renderer.toggleMeshOverlayColor(e)},this.onSetChunkRenderStateCommand=e=>{this.setChunkRenderMode(e.mode)},this.onPanoOverlayCommand=e=>{for(const t of this.allMeshes())t.renderer.onPanoOverlayCommand(e)},this.meshTrimUpdateRenderMode=e=>{this.meshTrimUniforms&&e!==this.meshTrimUniforms.isPanoMode&&(this.meshTrimUniforms.isPanoMode=e,this.meshTrimUpdate(-1))},this.meshTrimFilter=e=>{const t=e.object,i=e.point;let s=!1,o=!1;if(this.meshTrimData&&this.viewmodeData&&(0,ke.aV)(t)){for(const e of this.meshTrimData.activeTrimsForMeshGroup(t.meshGroup)){const t=e.isPointTrimmed(i,this.viewmodeData.isPano());if(e.discardContents){if(t)return!1}else s=s||!t,o=!0}if(o)return s}return!0}}get firstMeshLoadPromise(){return this._firstMeshLoadPromise.nativePromise()}async getMeshLoadPromise(e){return this.meshLoadPromises.get(e)||null}*allMeshes(){yield*this.meshes.values(),yield*this.inactiveMeshes.values()}getAllMeshes(){const e=[];for(const t of this.allMeshes())e.push(t.modelMesh);return e}getMesh(e){var t,i;return(null===(t=this.meshes.get(e))||void 0===t?void 0:t.modelMesh)||(null===(i=this.inactiveMeshes.get(e))||void 0===i?void 0:i.modelMesh)||null}hasMesh(e){return this.meshes.has(e)||this.inactiveMeshes.has(e)||this.meshLoadPromises.has(e)}async init(e,t){F||(s.Mesh.prototype.raycast=A,s.BufferGeometry.prototype.computeBoundsTree=O,s.BufferGeometry.prototype.disposeBoundsTree=B,F=!0),this.engine=t,this.config=e,this.market=t.market;const[i,o,n,r,a,l,c]=await Promise.all([t.getModuleBySymbol(h.qL),t.market.waitForData(f.M),t.getModuleBySymbol(h.mL),t.getModuleBySymbol(h.M7),t.getModuleBySymbol(h.sA),t.getModuleBySymbol(h.kM),t.market.waitForData(x.X)]);this.viewmodeData=c,this.webglScene=r.getScene(),this.raycasterModule=a,this.input=n,this.chunkVisibilityChecker=new Ie(this.webglScene,a.picking,o.pose),o.pose.onChanged((()=>this.chunkVisibilityChecker.resetCounter())),this.meshGroupVisuals.floorOpacity.onChanged((()=>this.chunkVisibilityChecker.resetCounter())),this.chunkSharedState=new Ge,this.chunkSharedState.maxVaryings=r.maxVaryings,this.meshTextureLoader=new Oe(e.textureLOD,i.getApi(),this.webglScene.camera,l,t,this.chunkVisibilityChecker,r),this.initRenderMode(e.startingMode,c),this.meshTrimInit(this.meshTrimData,a);const d=this.meshGroupVisuals.meshTextureOpacity;this.bindings.push(d.onActivate((()=>{this.meshTrimUpdateRenderMode(0===d.endValue)})),d.onComplete((()=>{this.meshTrimUpdateRenderMode(0===d.value)}))),this.bindings.push(this.engine.subscribe(v.A,(e=>{this.meshes.forEach((t=>{t.renderer.updateExistingTexture(e.sweepId,e.renderTarget.texture)}))}))),this.bindings.push(t.commandBinder.addBinding(k.P,this.setPreviewPosition.bind(this)),t.subscribe(b.ul,(()=>{this.meshTextureLoader.onWebGLContextLost()})),t.subscribe(b.aF,(()=>{this.meshTextureLoader.onWebGLContextRestored()})),t.commandBinder.addBinding(V.T,this.onMeshOverlayCommand.bind(this)),t.commandBinder.addBinding(R,this.toggleMeshOverlayColor.bind(this)),t.commandBinder.addBinding(_.w,this.onSetChunkRenderStateCommand.bind(this)),t.commandBinder.addBinding(E.a,this.onPanoOverlayCommand.bind(this))),t.broadcast(new p.sb(g.D.ModelMesh)),t.broadcast(new p.sb(g.D.StreamingMesh)),t.broadcast(new p.sb(g.D.StreamingTexture))}onUpdate(e){this.chunkVisibilityChecker&&this.chunkVisibilityChecker.update(),this.meshTextureLoader&&!te.Ay.debugPauseTexStream&&this.meshTextureLoader.update(e),this.meshGroupVisuals.meshTextureOpacity.active&&(this.viewmodeData.transition.active?(this.meshGroupVisuals.meshTextureOpacity.updateProgress(this.viewmodeData.transition.progress),this.meshGroupVisuals.meshTextureOpacity.commit()):(this.meshGroupVisuals.meshTextureOpacity.tick(e),this.meshGroupVisuals.meshTextureOpacity.commit()));const t=performance.now()/1e3;this.meshes.forEach((i=>{for(const e of i.modelMesh.chunks)e.setTime(t);i.modelMesh.onUpdate(e)}))}dispose(e){super.dispose(e),this.meshTextureLoader.dispose();const t=e=>{e.modelMesh.dispose(),e.roomMeshData.floors.clear(),e.roomMeshData.rooms.clear(),this.meshLoadPromises.delete(e.id)};for(const e of this.allMeshes())t(e);this.meshLoadPromises.size>0&&Promise.all(this.meshLoadPromises.values()).then((e=>{e.forEach(t)}))}async removeMesh(e){const t=this.meshes.get(e)||this.inactiveMeshes.get(e)||await this.meshLoadPromises.get(e)||null;t&&(await this.engine.removeComponent(this,t.renderer),t.modelMesh.dispose(),t.roomMeshData.floors.clear(),t.roomMeshData.rooms.clear(),t.modelMesh.unregisterCollision(this.input),this.meshes.delete(e),this.inactiveMeshes.delete(e),this.meshLoadPromises.delete(e))}async isolateMesh(e){this.meshes.forEach((e=>{this.log.debug("hiding",e),this.meshes.delete(e.id),this.inactiveMeshes.set(e.id,e),e.modelMesh.unregisterCollision(this.input),e.renderer.opacity=0}));const t=this.meshes.get(e.sid)||this.inactiveMeshes.get(e.sid)||await this.meshLoadPromises.get(e.sid)||await this.loadMesh(e,e.sid);this.inactiveMeshes.has(e.sid)&&(this.log.debug("showing",t,e),this.inactiveMeshes.delete(e.sid),await this.engine.addComponent(this,t.renderer),this.meshes.set(e.sid,t),t.modelMesh.registerCollision(this.input),t.renderer.opacity=null,t.renderer.beforeRender(),this.onUpdate(0)),this.inactiveMeshes.forEach((e=>{this.engine.removeComponent(this,e.renderer)}))}async loadMesh(e,t){const i=this.meshLoadPromises.get(t);if(i)return i;const s=(async()=>{this.meshesLoaded++;const{engine:i,config:s,meshTrimUniforms:o,chunkVisibilityChecker:n,chunkSharedState:r}=this,a=i.claimRenderLayer(this.name),l=this.isTiled(e),h=await this.getModelMeshFactory(l),c=new Fe.$,d=await h({uuid:e.uuid,model:e,renderLayer:a,engine:i,settings:te.Ay,roomMeshData:c,chunkSharedState:r,chunkFactory:(t,i,s,n)=>{const a=e.key()||"unknown",l=new le(t,i,s,r,n,a,!0);if(o){const e=o.getSharedFloorUniforms(t);l.setMaterialsUniform(e)}return l},chunkVisibilityChecker:n,gltfConfig:s.gltfConfig});d.addToOctree=!this.config.registerMeshAsDynamic;const u=d.initTextureLoader(this.meshTextureLoader,e.textures),m=await i.market.waitForData(y.A),p=this.makeMeshData(d.chunks,m);1===this.meshesLoaded&&(this.raycasterModule.setupOctree(d.boundingBox.clone().applyMatrix4(d.matrixWorld)),this.market.register(this,Fe.$,c),this.market.register(this,U.U,p)),this.setupRaycasting(d,this.input);const g=new fe(this,this.webglScene.scene,d,d,p,m,r,s);await i.addComponent(this,g),this.setRenderModeMesh(d,g,this.getRenderMode()),d.overrideMaxDetail(this.getMeshDetail()),await u;return{id:t,meshData:p,modelMesh:d,roomMeshData:c,renderer:g,tiled:l}})();this.meshLoadPromises.set(t,s);const o=await s;return this.meshes.set(t,o),1===this.meshesLoaded&&this._firstMeshLoadPromise.resolve(),o}async getModelMeshFactory(e=!0){return(e?await Promise.all([i.e(8893),i.e(3893),i.e(7888),i.e(172),i.e(8287),i.e(6457),i.e(3153),i.e(9114)]).then(i.bind(i,92132)):await Promise.all([i.e(8893),i.e(3893),i.e(7888),i.e(172),i.e(8287),i.e(6457),i.e(3153),i.e(9114)]).then(i.bind(i,49753))).createModelMesh}setupRaycasting(e,t){e.registerCollision(t)}setChunkSide(e){const t=this.chunkSharedState.side;return this.chunkSharedState.side=e,t}getChunkRenderMode(){return this.chunkSharedState.renderingMode}stats(){const e={};return e.textureCount=this.meshTextureLoader.textureCount,e.streaming=[...this.meshes.values()].some((e=>e.tiled)),e}getRenderMode(){return this._renderMode}setRenderMode(e,t=0,i=u.AU){for(const s of this.allMeshes())this.setRenderModeMesh(s.modelMesh,s.renderer,e,t,i);this.log.debug(`setRenderMode from ${this._renderMode} to ${e}`),this._renderMode=e}setMeshOptions(e){var t;for(const i of this.allMeshes()){const s=null!==(t=e.overrideMaxDetail)&&void 0!==t?t:i.modelMesh.detail;i.modelMesh.overrideMaxDetail(s)}}getMeshDetail(){let e="default";return this.meshes.forEach((t=>e=t.modelMesh.detail)),e}setTextureLimits(e,t){for(const i of this.allMeshes())i.modelMesh.setTextureQuality(this.meshTextureLoader,e,t)}setTextureStreamMode(e){switch(e){case N.R.NONE:this.meshTextureLoader.autoLoadTiles=!1;break;case N.R.RAYCAST:this.meshTextureLoader.autoLoadTiles=!0}}setRenderModeMesh(e,t,i,s=0,o=u.AU){let n=1;switch(i){case L.p.Hidden:n=1,e.visible=!1;break;case L.p.Mesh:n=1,e.visible=!0;break;case L.p.PanoramaMesh:n=0,e.visible=!0;break;case L.p.PanoramaCube:n=0,e.visible=!1;break;default:throw new Error(`unknown mode ${i}!`)}const r=this.meshGroupVisuals.meshTextureOpacity;return r.value===n&&r.easing===o&&r.duration===s||(r.modifyAnimation(r.value,n,s,o),0===s&&t.beforeRender()),n}initRenderMode(e,t){let i=e;switch(null===i&&(i=t.transition.active?t.transition.to:t.currentMode),i){case M.N3.Dollhouse:case M.N3.Floorplan:case M.N3.Mesh:this.setRenderMode(L.p.Mesh);break;default:this.setRenderMode(L.p.PanoramaMesh)}this.bindings.push(t.transitionActiveObservable.onChanged((e=>{if(e){const e=this.viewmodeData.transition.to===M.N3.Panorama,t=this.viewmodeData.transition.from!==M.N3.Panorama,i=e?L.p.PanoramaMesh:L.p.Mesh,s=t?100:0,o=e?u.AU:u.p_;this.setRenderMode(i,s,o)}})))}makeMeshData(e,t){var i;const o=new Map,n=new Map,r=new Map,a=new s.Box3,l=new s.Vector3;e.forEach((t=>{if(t.geometry.boundingBox&&a.union(t.geometry.boundingBox),t.geometry){const i=(0,ee.yL)(t.geometry);r.set(t,i),l.addScaledVector(i,1/e.length)}o.set(t.meshGroup,(o.get(t.meshGroup)||[]).concat(t)),n.set(t.meshSubgroup,(n.get(t.meshSubgroup)||[]).concat(t))}));const h=a.clone(),d=new s.Box3;t.iterate((e=>{e.isUnplaced()||(d.setFromCenterAndSize(e.position,c.B1.UNIT),h.union(d))}));const u=new U.U([...a.min.toArray(),...a.max.toArray()],[...h.min.toArray(),...h.max.toArray()],l);for(const[e,t]of o.entries()){const o=new s.Box3,a=new s.Vector3;t.forEach((e=>{e.geometry.boundingBox&&o.union(e.geometry.boundingBox);const i=r.get(e);i&&a.addScaledVector(i,1/t.length)})),u.meshGroups.floors.set(e,{meshGroup:e,boundingBox:o,parentMeshGroup:null,centerOfMass:a});const l=[...new Set(t.map((e=>e.meshSubgroup)))].sort(((e,t)=>t-e));u.meshGroups.roomsByFloor.set(e,l);const h=u.meshGroups.rooms;for(const t of l){const o=new s.Box3,a=new s.Vector3,l=n.get(t)||[];l.forEach((e=>{e.geometry.boundingBox&&o.union(e.geometry.boundingBox);const t=r.get(e);t&&a.addScaledVector(t,1/l.length)}));const c={meshGroup:t,boundingBox:o,parentMeshGroup:e,centerOfMass:a},d=h.get(t);d?d.parentMeshGroup=Math.min(null!==(i=d.parentMeshGroup)&&void 0!==i?i:1/0,e):h.set(t,c)}this.meshGroupVisuals.floorOpacity.set(`${e}`,1)}const m=[...u.meshGroups.floors.keys()].sort();return this.meshTrimData.addMeshGroups(m),u}async setPreviewPosition(e){const t=e.enabled&&e.previewCirclePosition?e.previewCirclePosition:null,i=e.size?e.size:.3;this.meshes.forEach((e=>{e.modelMesh.chunks.forEach((e=>{e.setMeshPreviewSphere(t,i)}))}))}setMeshOpacity(e,t){const i=e.length>0?e:this.meshes.keys();for(const e of i){const i=this.meshes.get(e);if(!i)throw Error("Unknown mesh id");i.renderer.opacity=t}}setChunkRenderMode(e){for(const t of this.allMeshes())t.renderer.onSetChunkRenderStateCommand(e)}isTiled(e){var t,i;const s=null!==(i=null===(t=this.engine.tryGetModuleBySymbolSync(l.ZF))||void 0===t?void 0:t.tryGetProperty(te.sz,!1))&&void 0!==i&&i;return!!e.tileset&&s&&!(0,m.w2)()}meshTrimInit(e,t){this.meshTrimUniforms=new G(this.getRenderMode()===L.p.PanoramaMesh);const{meshTrimsByMeshGroup:i}=e;this.bindings.push(e.onMeshGroupChanged((e=>this.meshTrimUpdate(e))),e.onMeshTrimChanged((e=>{this.meshTrimUpdate(e.meshGroup)}))),i.keys.forEach((e=>{this.meshTrimUpdate(e)}));const s=()=>{t.setIntersectionFilter(e.meshTrimsById.values.some((e=>e.enabled))?this.meshTrimFilter:null)};this.bindings.push(e.onChanged(s)),s()}meshTrimUpdate(e){const t=e!==w.Zu?[e]:this.meshTrimData.getAllMeshGroups();for(const e of t){const t=this.meshTrimData.getTrimsForMeshGroup(e);this.meshTrimUniforms.updateMeshTrimArrays(e,t);for(const e of this.allMeshes())e.modelMesh.chunks.forEach((e=>{e.setMaterialsUniform(this.meshTrimUniforms.getSharedFloorUniforms(e.meshGroup))}))}}}},10691:(e,t,i)=>{"use strict";i.d(t,{B:()=>h});var s=i(68909),o=i(23847),n=i(34944),r=i(12183),a=i(94221),l=i(97624);class h extends a.r{constructor(e,t,i=o.H.ALL){super(),this._opacity=1,this._chunks=[],this.size=new s.Vector3,this.center=new s.Vector3,this.built=!1,this.layers.mask=i.mask,this.name=`RoomMesh:${e}-${t}`,this.meshGroup=e,this.meshSubgroup=t,this.renderOrder=r.X.default,this.castShadow=h.ShouldCastShadow,this.onBeforeRender=(e,t,i,s,o,n)=>{this.updateUniforms(o,n)}}dispose(){this.reset()}reset(){this._chunks.length=0,this.geometry.dispose(),delete this.onBuild,delete this.onOpacityUpdate,this.built=!1}addChunk(e){-1===this._chunks.indexOf(e)&&this._chunks.push(e)}getChunk(e){return this._chunks[e]}build(){if(this.built)throw new Error("build() should only be called once");if(!this._chunks.length)return;const e=(0,n.h0)(this._chunks.map((e=>e.geometry)));e.clearGroups();let t=0;this.material=[],this._chunks.forEach(((i,s)=>{i.geometry&&i.geometry.index&&(e.addGroup(t,i.geometry.index.count,s),t+=i.geometry.index.count,i.geometry.dispose(),i.geometry=e,i.notifyOnMaterialUpdated((e=>{Array.isArray(this.material)&&(this.material[s]=e),this.onMaterialUpdate&&this.onMaterialUpdate()})),i.onOpacityUpdate=e=>{this.opacity=e})})),this.geometry=e,this.geometry.computeBoundingBox(),this.geometry.computeBoundingSphere(),this.material=this._chunks.map((e=>e.material)),this.size=this.boundingBox.getSize(this.size),this.center=this.boundingBox.getCenter(this.center),this.built=!0,this.onBuild&&this.onBuild()}buildWithSingleChunk(e){if(this.built)return;const{meshGroup:t,meshSubgroup:i,lod:s}=e;this.name=`RoomMesh:${s}-${t}-${i}-${e.chunkIndex}`,this.meshGroup=t,this.meshSubgroup=i,this._chunks.push(e),e.notifyOnMaterialUpdated((e=>{this.material=e,this.onMaterialUpdate&&this.onMaterialUpdate()})),e.onOpacityUpdate=e=>{this.opacity=e},this.size=this.boundingBox.getSize(this.size),this.center=this.boundingBox.getCenter(this.center),this.built=!0,this.onBuild&&this.onBuild()}updateUniforms(e,t){e instanceof s.ShaderMaterial&&(t?this.chunks[t.materialIndex].onBeforeDraw(e):this.chunks.length&&this.chunks[0].onBeforeDraw(e))}get boundingBox(){return(0,n.UX)(this.geometry)}set opacity(e){e!==this.opacity&&(this._opacity=e,this.raycastEnabled=e>l.u7.FADE_CLICKABLE_THRESHOLD,this.renderOrder=e<l.u7.FADE_OPAQUE?r.X.ghostFloor:r.X.default,this.onOpacityUpdate&&this.onOpacityUpdate(e))}get opacity(){return this._opacity}get chunks(){return this._chunks}getSortKey(){return this.chunks.length?this._chunks[0].getSortKey():0}}h.ShouldCastShadow=!1},85843:(e,t,i)=>{"use strict";i.d(t,{$:()=>o});var s=i(61589);class o extends s.B{constructor(){super(),this.name="room-mesh-data",this.floors=new Set,this.rooms=new Set}}},20052:(e,t,i)=>{"use strict";i.d(t,{P:()=>o});var s=i(18268);class o extends s.u{constructor(e,t,i){super(),this.payload={enabled:e,previewCirclePosition:t,size:i}}}o.id="MESH_PREVIEW_POSITION"},69179:(e,t,i)=>{"use strict";i.d(t,{w:()=>n});var s=i(18268),o=i(24081);class n extends s.u{constructor(e){super(),this.payload={mode:e}}}n.modes=o.f,n.id="SET_CHUNK_RENDER_MODE"},95836:(e,t,i)=>{"use strict";i.d(t,{T:()=>r});var s,o,n=i(18268);!function(e){e.all="all",e.byMeshGroup="byMeshGroup",e.byMeshSubGroup="byMeshSubGroup"}(s||(s={})),function(e){e.explicit="explicit",e.random="random"}(o||(o={}));class r extends n.u{constructor(e,t,i){super(),this.payload={meshIds:null!=i?i:[],selectBy:(null==t?void 0:t.style)||s.all,colorStyle:(null==e?void 0:e.style)||o.explicit,color:(null==e?void 0:e.color)||null,alpha:(null==e?void 0:e.alpha)||.5,index:null==t?void 0:t.index}}}r.id="SET_MESH_OVERLAY_COLOR",r.selectBy=s,r.colorBy=o,r.COLOR_DIM={x:0,y:0,z:0,w:.3}},17413:(e,t,i)=>{"use strict";i.d(t,{a:()=>o});var s=i(18268);class o extends s.u{constructor(e,t,i){super(),this.payload={sweepId:e,texture:t,quaternion:i}}}o.id="SET_PANO_OVERLAY"},44588:(e,t,i)=>{"use strict";var s;i.d(t,{X:()=>s}),function(e){e[e.Min=0]="Min",e[e.Standard=1]="Standard",e[e.High=2]="High",e[e.Detail=3]="Detail"}(s||(s={}))},65576:(e,t,i)=>{"use strict";var s;i.d(t,{p:()=>s}),function(e){e.Mesh="mesh",e.PanoramaMesh="mesh.inside",e.PanoramaCube="cubemap.inside",e.Hidden="mesh.hidden"}(s||(s={}))},49753:(e,t,i)=>{"use strict";i.r(t),i.d(t,{createModelMesh:()=>T});var s=i(35223),o=i(73657),n=i(68909),r=i(23847),a=i(35652),l=i(62569),h=i(8430),c=i(10691),d=i(81483);class u extends n.Object3D{constructor(e,t=r.H.ALL){super(),this.renderLayer=t,this.roomMeshes=new l.A((e=>e.meshSubgroup)),this.boundingBox=new n.Box3,this.size=new n.Vector3,this.center=new n.Vector3,this._chunks=[],this.built=!1,this.name=`FloorMesh:${e}`,this.meshGroup=e}dispose(){this.reset(),this.roomMeshes.clear()}reset(){for(const e of this.roomMeshes)e.dispose(),this.remove(e);this._chunks.length=0,this.built=!1}addChunk(e){const t=this.getOrCreateRoomMesh(e.meshSubgroup);this._chunks.push(e),t.addChunk(e)}build(){if(this.built)throw new Error("build() should only be called once");this.boundingBox.makeEmpty();for(const e of this.roomMeshes)this.add(e),this.boundingBox.union(e.boundingBox);this.center=this.boundingBox.getCenter(this.center),this.size=this.boundingBox.getSize(this.size),this.built=!0}get chunks(){return this._chunks}getOrCreateRoomMesh(e){let t=this.roomMeshes.get(e);if(!t){t=new c.B(this.meshGroup,e,this.renderLayer);const i=new d.$(t);this.roomMeshes.add(t),this.add(t),this.add(i)}return t}}var m=i(84229);class p extends m.t{constructor(e){super(e),this.name="MeshCreationException"}}var g=i(51966),f=i(44588);var y=i(15335),w=i(27153);const v=new a.Ay("dam-loader");class b{constructor(e){this.chunkFactory=e,this.decoder=i(27419)}async load(e,t,i){v.time("download");const s=await t.get(e,{responseType:"arraybuffer",onProgress:i});return v.timeEnd("download"),this.parse(s)}parse(e){v.time("parse proto");const t=this.decoder.binary_mesh.read(new y(e));v.timeEnd("parse proto"),v.time("convert to webgl");const i=this.convertProtobufToSceneObject(t);return v.timeEnd("convert to webgl"),i}convertProtobufToSceneObject(e){if(0===e.chunk.length)return v.warn("No chunks in damfile..."),[];const t=new n.Matrix4;t.set(1,0,0,0,0,0,1,0,0,-1,0,0,0,0,0,1);return e.chunk.map((e=>{const i=new n.BufferGeometry;i.setAttribute("position",new n.BufferAttribute(new Float32Array(e.vertices.xyz),3)),e.vertices.uv.length>0&&i.setAttribute("uv",new n.BufferAttribute(new Float32Array(e.vertices.uv),2)),i.setIndex(new n.BufferAttribute(new Uint32Array(e.faces.faces),1)),i.applyMatrix4(t),i.computeBoundingBox();const{group:s,subgroup:o}=(0,w.g8)(e.chunk_name);return this.chunkFactory(s,o,i,e.material_name)}))}}class x{static async load(e,t,i,s,o=0){const n=new b(t),r=i[o];if(!r)return Promise.reject("No suitable model file found...");const a=await r.url.get();return n.load(a,e,s).catch((()=>this.load(e,t,i,s,++o)))}}const M=new a.Ay("mesh");class D extends g.o{constructor(e,t,i=r.H.ALL,s){var o;super(),this.uuid=e,this.api=t,this.renderLayer=i,this.damMeshUrls=s,this.floorMeshes=new l.A((e=>e.meshGroup)),this.built=!1,this.name=`ModelMesh:${e}`,this.layers.mask=i.mask,(o=this.textureQualityMap).reset(),o.registerQualities(f.X.Standard,512,.048,.5,"low"),o.registerQualities(f.X.Standard,2048,.012,.5,"high")}dispose(){super.dispose(),this.floorMeshes.mapElements((e=>{e.dispose(),this.remove(e)})),this.floorMeshes.clear(),this.built=!1}reset(){this.floorMeshes.mapElements((e=>{e.reset(),this.remove(e)})),this._chunks.length=0,this.built=!1}async load(e){const{roomMeshData:t}=e;(0,h.w2)()&&(e.chunks=[]);let i=e.chunks?e.chunks:await x.load(this.api,e.chunkFactory,this.damMeshUrls,e.onProgress).catch((e=>{M.error(e);const t=e instanceof Error?e.message:"Failed to load model mesh";throw new p(t)}));if(0===i.length){M.warn("No geometry found for model, loading faux geometry, disabling outside view-mode");const t=new n.PlaneGeometry(5,5,1,1);t.rotateX(-Math.PI/2),t.computeBoundingBox();const s=e.chunkFactory(0,0,t);s.sharedState.forEachChunkMaterial((e=>e.visible=!1)),i=[s]}i.forEach((e=>{this.addChunk(e)})),this.build(t)}addChunk(e){const t=this.getOrCreateFloorMesh(e.meshGroup);this._chunks.push(e),t.addChunk(e)}build(e){var t,i;if(this.built)throw new Error("build() should only be called once");let s=0,o=0;for(const e of this.floorMeshes){this.add(e);for(const o of e.roomMeshes)o.build(),o.geometry.boundsTree||null===(i=(t=o.geometry).computeBoundsTree)||void 0===i||i.call(t),s++;e.build(),o++}M.debug(`FloorMeshes: ${o} RoomMeshes: ${s} Chunks: ${this._chunks.length}`),this.boundingBox.makeEmpty();for(const e of this.floorMeshes)this.boundingBox.union(e.boundingBox);this.size=this.boundingBox.getSize(this.size),this.center=this.boundingBox.getCenter(this.center),e.root=this,e.floors=new Set(this.floorMeshes),e.rooms=this.roomMeshes,e.commit(),this.built=!0}get roomMeshes(){const e=new Set;for(const t of this.floorMeshes)for(const i of t.roomMeshes)e.add(i);return e}async initTextureLoader(e,t){e.limitMemoryUsage=!1,e.setModel(this,this.chunks,t),await e.loadAll(this,this.textureQualityMap.min(f.X.Standard))}registerCollision(e){e.registerMesh(this,this.addToOctree);for(const t of this.roomMeshes)e.registerSnappingMeshGeometry(t.name,t.geometry,{meshGroup:t.meshGroup})}unregisterCollision(e){e.unregisterMesh(this);for(const t of this.roomMeshes)e.unregisterSnappingMeshGeometry(t.name)}setTextureQuality(e,t,i){e.setQuality(t,i)}onUpdate(){}getOrCreateFloorMesh(e){let t=this.floorMeshes.get(e);return t||(t=new u(e,this.renderLayer),this.floorMeshes.add(t),this.add(t)),t}}const T=async function({model:e,renderLayer:t,engine:i,chunkFactory:n,roomMeshData:r}){var a;const[l]=await Promise.all([i.getModuleBySymbol(s.qL)]),h=e.meshUrls||[],c=new D(null===(a=h[0])||void 0===a?void 0:a.uuid,l.getApi(),t,h);return await c.load({roomMeshData:r,chunkFactory:n,onProgress:e=>{i.broadcast(new o.EX(e.loaded,e.total))}}),c}},2173:(e,t,i)=>{"use strict";i.d(t,{W:()=>r});var s=i(8430),o=i(95149),n=i(44588);const r={urlTemplateToken:"<file>",initialMaxLOD:n.X.Min,nonMeshMaxLOD:n.X.Standard,maxLOD:n.X.High,minLOD:n.X.Min,loadSiblings:!0,displayActiveTiles:!1,autoDisableRendererCulling:!0,optimizeRaycast:!1,stopAtEmptyTiles:!1,disableTileUpdates:!1,disposeModel:!1,limitMemoryUsage:(0,s.Fr)(),allocatedMegsBeforeLimitingLod:350,lruMinExtraTiles:(0,s.Fr)()?0:100,lruMaxTiles:800,lruUnloadPercent:.05,downloadQueueConcurrency:8,parseQueueConcurrency:10,snappingMaxLOD:n.X.Standard,errorTarget:Number((0,o.P3)("errorTarget",(0,s.Fr)()?6:4)),errorMultiplierHiddenFloors:.01,errorMultiplierRaycastOcclusion:.1,smallMeshThreshold:Number((0,o.P3)("smallMeshThreshold",40)),smallMeshErrorMultiplier:Number((0,o.P3)("smallMeshErrorMultiplier",.1))}},92132:(e,t,i)=>{"use strict";i.r(t),i.d(t,{createModelMesh:()=>it});var s=i(35223),o=i(45018),n=i(23847),r=i(94298),a=i(68909);const l=new a.Vector3,h=(new a.Matrix4).set(1,0,0,0,0,0,-1,0,0,1,0,0,0,0,0,1),c=h.clone().invert();function d(e,t){if(!1!==t(e)&&e.children)for(const i of e.children)d(i,t)}function u(e,t){const{box:i,boxTransformInverse:s}=function(e){let t=m.get(e);if(!t){const i=e.boundingVolume.box,s=new a.Box3,o=new a.Matrix4,n=new a.Vector3(i[3],i[4],i[5]),r=new a.Vector3(i[6],i[7],i[8]),l=new a.Vector3(i[9],i[10],i[11]),h=n.length(),c=r.length(),d=l.length();n.normalize(),r.normalize(),l.normalize(),0===h&&n.crossVectors(r,l),0===c&&r.crossVectors(n,l),0===d&&l.crossVectors(n,r),o.set(n.x,r.x,l.x,i[0],n.y,r.y,l.y,i[1],n.z,r.z,l.z,i[2],0,0,0,1).invert(),s.min.set(-h,-c,-d),s.max.set(h,c,d),t={box:s,boxTransformInverse:o},m.set(e,t)}return t}(t);return l.copy(e).applyMatrix4(h).applyMatrix4(s),i.containsPoint(l)}const m=new WeakMap;function p(e){for(var t;e;){const i=null===(t=e.extras)||void 0===t?void 0:t.level;if("number"==typeof i)return i;e=e.parent}return-1}var g=i(20804),f=i(77475),y=i(51966),w=i(73657),v=i(1803),b=i(71294),x=i(35652),M=i(44940),D=i(82873),T=i(57975);function S(e){let t;try{t=new URL(e,"http://fakehost.com/")}catch(e){return null}const i=t.pathname.split("/").pop(),s=i.lastIndexOf(".");if(-1===s||s===i.length-1)return null;return i.substring(s+1)}class P{constructor(){this.maxSize=800,this.minSize=600,this.unloadPercent=.05,this.itemSet=new Map,this.itemList=[],this.usedSet=new Set,this.callbacks=new Map,this.unloadPriorityCallback=null;const e=this.itemSet;this.defaultPriorityCallback=t=>e.get(t)}isFull(){return this.itemSet.size>=this.maxSize}add(e,t){const i=this.itemSet;if(i.has(e))return!1;if(this.isFull())return!1;const s=this.usedSet,o=this.itemList,n=this.callbacks;return o.push(e),s.add(e),i.set(e,Date.now()),n.set(e,t),!0}remove(e){const t=this.usedSet,i=this.itemSet,s=this.itemList,o=this.callbacks;if(i.has(e)){o.get(e)(e);const n=s.indexOf(e);return s.splice(n,1),t.delete(e),i.delete(e),o.delete(e),!0}return!1}markUsed(e){const t=this.itemSet,i=this.usedSet;t.has(e)&&!i.has(e)&&(t.set(e,Date.now()),i.add(e))}markAllUnused(){this.usedSet.clear()}unloadUnusedContent(){const e=this.unloadPercent,t=this.minSize,i=this.itemList,s=this.itemSet,o=this.usedSet,n=this.callbacks,r=i.length-o.size,a=i.length-t,l=this.unloadPriorityCallback||this.defaultPriorityCallback;if(a>0&&r>0){i.sort(((e,t)=>{const i=o.has(e),s=o.has(t);return i&&s?0:i||s?i?1:-1:l(t)-l(e)}));const h=Math.min(a,r),c=Math.max(t*e,h*e);let d=Math.min(c,r);d=Math.ceil(d);const u=i.splice(0,d);for(let e=0,t=u.length;e<t;e++){const t=u[e];n.get(t)(t),s.delete(t),n.delete(t)}}}scheduleUnload(e=!0){var t;this.scheduled||(this.scheduled=!0,t=()=>{this.scheduled=!1,this.unloadUnusedContent(),e&&this.markAllUnused()},Promise.resolve().then(t))}}class C{constructor(){this.maxJobs=6,this.items=[],this.callbacks=new Map,this.currJobs=0,this.scheduled=!1,this.autoUpdate=!0,this.priorityCallback=()=>{throw new Error("PriorityQueue: PriorityCallback function not defined.")},this.schedulingCallback=e=>{requestAnimationFrame(e)},this._runjobs=()=>{this.tryRunJobs(),this.scheduled=!1}}sort(){const e=this.priorityCallback;this.items.sort(e)}add(e,t){return new Promise(((i,s)=>{const o=this.items,n=this.callbacks;o.push(e),n.set(e,((...e)=>t(...e).then(i).catch(s))),this.autoUpdate&&this.scheduleJobRun()}))}remove(e){const t=this.items,i=this.callbacks,s=t.indexOf(e);-1!==s&&(t.splice(s,1),i.delete(e))}tryRunJobs(){this.sort();const e=this.items,t=this.callbacks,i=this.maxJobs;let s=this.currJobs;for(;i>s&&e.length>0;){s++;const i=e.pop(),o=t.get(i);t.delete(i),o(i).then((()=>{this.currJobs--,this.autoUpdate&&this.scheduleJobRun()})).catch((()=>{this.currJobs--,this.autoUpdate&&this.scheduleJobRun()}))}this.currJobs=s}scheduleJobRun(){this.scheduled||(this.schedulingCallback(this._runjobs),this.scheduled=!0)}}function A(e){return 3===e||4===e}function O(e,t){return e.__lastFrameVisited===t&&e.__used}function B(e,t){e.__lastFrameVisited!==t&&(e.__lastFrameVisited=t,e.__used=!1,e.__inFrustum=!1,e.__isLeaf=!1,e.__visible=!1,e.__active=!1,e.__error=1/0,e.__distanceFromCamera=1/0,e.__childrenWereVisible=!1,e.__allChildrenLoaded=!1)}function F(e,t,i){if(B(e,t),e.__used=!0,i.markUsed(e),e.__contentEmpty){const s=e.children;for(let e=0,o=s.length;e<o;e++)F(s[e],t,i)}}function k(e,t,i){if(e.__contentEmpty&&(!e.__externalTileSet||A(e.__loadingState))){const s=e.children;for(let e=0,o=s.length;e<o;e++){const o=s[e];o.__depthFromRenderedParent=t,k(o,t,i)}}else i.requestTileContents(e)}function _(e,t=null,i=null,s=null,o=0){if(t&&t(e,s,o))return void(i&&i(e,s,o));const n=e.children;for(let s=0,r=n.length;s<r;s++)_(n[s],t,i,e,o+1);i&&i(e,s,o)}function V(e,t){const i=t.stats,s=t.frameCount,o=t.errorTarget,n=t.maxDepth,r=t.loadSiblings,a=t.lruCache,l=t.stopAtEmptyTiles;B(e,s);if(!1===t.tileInView(e))return!1;if(e.__used=!0,a.markUsed(e),e.__inFrustum=!0,i.inFrustum++,(l||!e.__contentEmpty)&&!e.__externalTileSet){t.calculateError(e);if(e.__error<=o)return!0;if(t.maxDepth>0&&e.__depth+1>=n)return!0}let h=!1;const c=e.children;for(let e=0,i=c.length;e<i;e++){const i=V(c[e],t);h=h||i}if(h&&r)for(let e=0,t=c.length;e<t;e++){F(c[e],s,a)}return!0}function E(e,t){const i=t.stats,s=t.frameCount;if(!O(e,s))return;i.used++;const o=e.children;let n=!1;for(let e=0,t=o.length;e<t;e++){const t=o[e];n=n||O(t,s)}if(n){let i=!1,n=!0;for(let e=0,r=o.length;e<r;e++){const r=o[e];if(E(r,t),i=i||r.__wasSetVisible||r.__childrenWereVisible,O(r,s)){const e=r.__allChildrenLoaded||!r.__contentEmpty&&A(r.__loadingState)||r.__externalTileSet&&4===r.__loadingState;n=n&&e}}e.__childrenWereVisible=i,e.__allChildrenLoaded=n}else e.__isLeaf=!0}function I(e,t){const i=t.stats,s=t.frameCount;if(!O(e,s))return;const o=e.parent,n=o?o.__depthFromRenderedParent:-1;e.__depthFromRenderedParent=n;const r=t.lruCache;if(e.__isLeaf)return e.__depthFromRenderedParent++,void(3===e.__loadingState?(e.__inFrustum&&(e.__visible=!0,i.visible++),e.__active=!0,i.active++):r.isFull()||e.__contentEmpty&&!e.__externalTileSet||t.requestTileContents(e));const a=(t.errorTarget+1)*t.errorThreshold,l=e.__error<=a,h=l||"ADD"===e.refine,c=!e.__contentEmpty,d=c||e.__externalTileSet,u=A(e.__loadingState)&&d,m=e.__childrenWereVisible,p=e.children;let g=e.__allChildrenLoaded;if(h&&c&&e.__depthFromRenderedParent++,h&&!u&&!r.isFull()&&d&&t.requestTileContents(e),(l&&!g&&!m&&u||"ADD"===e.refine&&u)&&(e.__inFrustum&&(e.__visible=!0,i.visible++),e.__active=!0,i.active++),"ADD"!==e.refine&&l&&!g&&u)for(let i=0,o=p.length;i<o;i++){const o=p[i];O(o,s)&&!r.isFull()&&(o.__depthFromRenderedParent=e.__depthFromRenderedParent+1,k(o,o.__depthFromRenderedParent,t))}else for(let e=0,i=p.length;e<i;e++){const i=p[e];O(i,s)&&I(i,t)}}function R(e,t){const i=O(e,t.frameCount);if(i||e.__usedLastFrame){let s=!1,o=!1;i&&(s=e.__active,o=t.displayActiveTiles&&e.__active||e.__visible),e.__contentEmpty||3!==e.__loadingState||(e.__wasSetActive!==s&&t.setTileActive(e,s),e.__wasSetVisible!==o&&t.setTileVisible(e,o)),e.__wasSetActive=s,e.__wasSetVisible=o,e.__usedLastFrame=i;const n=e.children;for(let e=0,i=n.length;e<i;e++){R(n[e],t)}}}const L=(e,t)=>e.__depth!==t.__depth?e.__depth>t.__depth?-1:1:e.__inFrustum!==t.__inFrustum?e.__inFrustum?1:-1:e.__used!==t.__used?e.__used?1:-1:e.__error!==t.__error?e.__error>t.__error?1:-1:e.__distanceFromCamera!==t.__distanceFromCamera?e.__distanceFromCamera>t.__distanceFromCamera?-1:1:0,N=e=>1/(e.__depthFromRenderedParent+1);class U{get rootTileSet(){const e=this.tileSets[this.rootURL];return!e||e instanceof Promise?null:e}get root(){const e=this.rootTileSet;return e?e.root:null}constructor(e){this.tileSets={},this.rootURL=e,this.fetchOptions={},this.preprocessURL=null;const t=new P;t.unloadPriorityCallback=N;const i=new C;i.maxJobs=4,i.priorityCallback=L;const s=new C;s.maxJobs=1,s.priorityCallback=L,this.lruCache=t,this.downloadQueue=i,this.parseQueue=s,this.stats={parsing:0,downloading:0,failed:0,inFrustum:0,used:0,active:0,visible:0},this.frameCount=0,this.errorTarget=6,this.errorThreshold=1/0,this.loadSiblings=!0,this.displayActiveTiles=!1,this.maxDepth=1/0,this.stopAtEmptyTiles=!0}traverse(e,t){const i=this.tileSets[this.rootURL];i&&i.root&&_(i.root,e,t)}update(){const e=this.stats,t=this.lruCache,i=this.tileSets,s=i[this.rootURL];if(!(this.rootURL in i))return void this.loadRootTileSet(this.rootURL);if(!s||!s.root)return;const o=s.root;e.inFrustum=0,e.used=0,e.active=0,e.visible=0,this.frameCount++,V(o,this),E(o,this),I(o,this),R(o,this),t.scheduleUnload()}parseTile(e,t,i){return null}disposeTile(e){}preprocessNode(e,t,i){e.content&&(!("uri"in e.content)&&"url"in e.content&&(e.content.uri=e.content.url,delete e.content.url),e.content.uri&&(e.content.uri=function(...e){const t=/^[a-zA-Z]+:\/\//;let i=-1;for(let s=0,o=e.length;s<o;s++)t.test(e[s])&&(i=s);if(-1===i)return T.join(...e).replace(/\\/g,"/");{const s=i<=0?e:e.slice(i),o=s[0].match(t)[0];return s[0]=s[0].substring(o.length),(o+T.join(...s)).replace(/\\/g,"/")}}(i,e.content.uri)),e.content.boundingVolume&&!("box"in e.content.boundingVolume||"sphere"in e.content.boundingVolume||"region"in e.content.boundingVolume)&&delete e.content.boundingVolume),e.parent=t,e.children=e.children||[];if(e.content&&e.content.uri){const t=S(e.content.uri),i=Boolean(t&&"json"===t.toLowerCase());e.__externalTileSet=i,e.__contentEmpty=i}else e.__externalTileSet=!1,e.__contentEmpty=!0;e.__distanceFromCamera=1/0,e.__error=1/0,e.__inFrustum=!1,e.__isLeaf=!1,e.__usedLastFrame=!1,e.__used=!1,e.__wasSetVisible=!1,e.__visible=!1,e.__childrenWereVisible=!1,e.__allChildrenLoaded=!1,e.__wasSetActive=!1,e.__active=!1,e.__loadingState=0,e.__loadIndex=0,e.__loadAbort=null,e.__depthFromRenderedParent=-1,null===t?(e.__depth=0,e.refine=e.refine||"REPLACE"):(e.__depth=t.__depth+1,e.refine=e.refine||t.refine)}setTileActive(e,t){}setTileVisible(e,t){}calculateError(e){return 0}tileInView(e){return!0}fetchTileSet(e,t,i=null){return fetch(e,t).then((t=>{if(t.ok)return t.json();throw new Error(`TilesRenderer: Failed to load tileset "${e}" with status ${t.status} : ${t.statusText}`)})).then((t=>{const s=t.asset.version;console.assert("1.0"===s||"0.0"===s,'asset.version is expected to be a string of "1.0" or "0.0"');const o=T.dirname(e);return _(t.root,((e,t)=>this.preprocessNode(e,t,o)),null,i,i?i.__depth:0),t}))}loadRootTileSet(e){const t=this.tileSets;if(e in t)return t[e]instanceof Error?Promise.reject(t[e]):Promise.resolve(t[e]);{const i=this.fetchTileSet(this.preprocessURL?this.preprocessURL(e):e,this.fetchOptions).then((i=>{t[e]=i}));return i.catch((i=>{console.error(i),t[e]=i})),t[e]=i,i}}requestTileContents(e){if(0!==e.__loadingState)return;const t=this.stats,i=this.lruCache,s=this.downloadQueue,o=this.parseQueue,n=e.__externalTileSet;i.add(e,(e=>{1===e.__loadingState?(e.__loadAbort.abort(),e.__loadAbort=null):n?e.children.length=0:this.disposeTile(e),1===e.__loadingState?t.downloading--:2===e.__loadingState&&t.parsing--,e.__loadingState=0,e.__loadIndex++,o.remove(e),s.remove(e)})),e.__loadIndex++;const r=e.__loadIndex,a=new AbortController,l=a.signal;t.downloading++,e.__loadAbort=a,e.__loadingState=1;const h=n=>{e.__loadIndex===r&&("AbortError"!==n.name?(o.remove(e),s.remove(e),2===e.__loadingState?t.parsing--:1===e.__loadingState&&t.downloading--,t.failed++,console.error(`TilesRenderer : Failed to load tile at url "${e.content.uri}".`),console.error(n),e.__loadingState=4):i.remove(e))};n?s.add(e,(e=>{if(e.__loadIndex!==r)return Promise.resolve();const t=this.preprocessURL?this.preprocessURL(e.content.uri):e.content.uri;return this.fetchTileSet(t,Object.assign({signal:l},this.fetchOptions),e)})).then((i=>{e.__loadIndex===r&&(t.downloading--,e.__loadAbort=null,e.__loadingState=3,e.children.push(i.root))})).catch(h):s.add(e,(e=>{if(e.__loadIndex!==r)return Promise.resolve();const t=this.preprocessURL?this.preprocessURL(e.content.uri):e.content.uri;return fetch(t,Object.assign({signal:l},this.fetchOptions))})).then((t=>{if(e.__loadIndex===r){if(t.ok)return t.arrayBuffer();throw new Error(`Failed to load model with error code ${t.status}`)}})).then((i=>{if(e.__loadIndex===r)return t.downloading--,t.parsing++,e.__loadAbort=null,e.__loadingState=2,o.add(e,(e=>{if(e.__loadIndex!==r)return Promise.resolve();const t=S(e.content.uri);return this.parseTile(i,e,t)}))})).then((()=>{e.__loadIndex===r&&(t.parsing--,e.__loadingState=3,e.__wasSetVisible&&this.setTileVisible(e,!0),e.__wasSetActive&&this.setTileActive(e,!0))})).catch(h)}dispose(){const e=this.lruCache;this.traverse((t=>{e.remove(t)}))}}function z(e){return(new TextDecoder).decode(e)}class G{constructor(e,t,i,s){this.buffer=e,this.binOffset=t+i,this.binLength=s;let o=null;if(0!==i){const s=new Uint8Array(e,t,i);o=JSON.parse(z(s))}else o={};this.header=o}getKeys(){return Object.keys(this.header)}getData(e,t,i=null,s=null){const o=this.header;if(!(e in o))return null;const n=o[e];if(n instanceof Object){if(Array.isArray(n))return n;{const{buffer:o,binOffset:r,binLength:a}=this,l=n.byteOffset||0,h=n.type||s,c=n.componentType||i;if("type"in n&&s&&n.type!==s)throw new Error("FeatureTable: Specified type does not match expected type.");let d,u;switch(h){case"SCALAR":d=1;break;case"VEC2":d=2;break;case"VEC3":d=3;break;case"VEC4":d=4;break;default:throw new Error(`FeatureTable : Feature type not provided for "${e}".`)}const m=r+l,p=t*d;switch(c){case"BYTE":u=new Int8Array(o,m,p);break;case"UNSIGNED_BYTE":u=new Uint8Array(o,m,p);break;case"SHORT":u=new Int16Array(o,m,p);break;case"UNSIGNED_SHORT":u=new Uint16Array(o,m,p);break;case"INT":u=new Int32Array(o,m,p);break;case"UNSIGNED_INT":u=new Uint32Array(o,m,p);break;case"FLOAT":u=new Float32Array(o,m,p);break;case"DOUBLE":u=new Float64Array(o,m,p);break;default:throw new Error(`FeatureTable : Feature component type not provided for "${e}".`)}if(m+p*u.BYTES_PER_ELEMENT>r+a)throw new Error("FeatureTable: Feature data read outside binary body length.");return u}}return n}}class H extends G{constructor(e,t,i,s,o){super(e,i,s,o),this.batchSize=t}getData(e,t=null,i=null){return super.getData(e,this.batchSize,t,i)}}class j{constructor(){this.fetchOptions={},this.workingPath=""}load(e){return fetch(e,this.fetchOptions).then((t=>{if(!t.ok)throw new Error(`Failed to load file "${e}" with status ${t.status} : ${t.statusText}`);return t.arrayBuffer()})).then((t=>(""===this.workingPath&&(this.workingPath=this.workingPathForURL(e)),this.parse(t))))}resolveExternalURL(e){return/^[^\\/]/.test(e)?this.workingPath+"/"+e:e}workingPathForURL(e){const t=e.split(/[\\/]/g);t.pop();return t.join("/")+"/"}parse(e){throw new Error("LoaderBase: Parse not implemented.")}}class W extends j{parse(e){const t=new DataView(e),i=String.fromCharCode(t.getUint8(0))+String.fromCharCode(t.getUint8(1))+String.fromCharCode(t.getUint8(2))+String.fromCharCode(t.getUint8(3));console.assert("b3dm"===i);const s=t.getUint32(4,!0);console.assert(1===s);const o=t.getUint32(8,!0);console.assert(o===e.byteLength);const n=t.getUint32(12,!0),r=t.getUint32(16,!0),a=t.getUint32(20,!0),l=t.getUint32(24,!0),h=e.slice(28,28+n+r),c=new G(h,0,n,r),d=28+n+r,u=e.slice(d,d+a+l),m=new H(u,c.getData("BATCH_LENGTH"),0,a,l),p=d+a+l;return{version:s,featureTable:c,batchTable:m,glbBytes:new Uint8Array(e,p,o-p)}}}var Q=i(17888);class $ extends W{constructor(e=a.DefaultLoadingManager){super(),this.manager=e}parse(e){const t=super.parse(e),i=t.glbBytes.slice().buffer;return new Promise(((e,s)=>{const o=this.manager,n=this.fetchOptions,r=o.getHandler("path.gltf")||new Q.GLTFLoader(o);"include"===n.credentials&&"cors"===n.mode&&r.setCrossOrigin("use-credentials"),"credentials"in n&&r.setWithCredentials("include"===n.credentials),n.headers&&r.setRequestHeader(n.headers);let a=this.workingPath;!/[\\/]$/.test(a)&&a.length&&(a+="/"),r.parse(i,a,(i=>{const{batchTable:s,featureTable:o}=t,{scene:n}=i,r=o.getData("RTC_CENTER");r&&(n.position.x+=r[0],n.position.y+=r[1],n.position.z+=r[2]),i.batchTable=s,i.featureTable=o,n.batchTable=s,n.featureTable=o,e(i)}),s)}))}}class q extends j{parse(e){const t=new DataView(e),i=String.fromCharCode(t.getUint8(0))+String.fromCharCode(t.getUint8(1))+String.fromCharCode(t.getUint8(2))+String.fromCharCode(t.getUint8(3));console.assert("pnts"===i);const s=t.getUint32(4,!0);console.assert(1===s);const o=t.getUint32(8,!0);console.assert(o===e.byteLength);const n=t.getUint32(12,!0),r=t.getUint32(16,!0),a=t.getUint32(20,!0),l=t.getUint32(24,!0),h=e.slice(28,28+n+r),c=new G(h,0,n,r),d=28+n+r,u=e.slice(d,d+a+l),m=new H(u,c.getData("BATCH_LENGTH")||c.getData("POINTS_LENGTH"),0,a,l);return Promise.resolve({version:s,featureTable:c,batchTable:m})}}class K extends q{constructor(e=a.DefaultLoadingManager){super(),this.manager=e}parse(e){return super.parse(e).then((e=>{const{featureTable:t}=e,i=t.getData("POINTS_LENGTH"),s=t.getData("POSITION",i,"FLOAT","VEC3"),o=t.getData("RGB",i,"UNSIGNED_BYTE","VEC3");["RTC_CENTER","QUANTIZED_VOLUME_OFFSET","QUANTIZED_VOLUME_SCALE","CONSTANT_RGBA","BATCH_LENGTH","POSITION_QUANTIZED","RGBA","RGB565","NORMAL","NORMAL_OCT16P"].forEach((e=>{e in t.header&&console.warn(`PNTSLoader: Unsupported FeatureTable feature "${e}" detected.`)}));const n=new a.BufferGeometry;n.setAttribute("position",new a.BufferAttribute(s,3,!1));const r=new a.PointsMaterial;r.size=2,r.sizeAttenuation=!1,null!==o&&(n.setAttribute("color",new a.BufferAttribute(o,3,!0)),r.vertexColors=!0);const l=new a.Points(n,r);e.scene=l,e.scene.featureTable=t;const h=t.getData("RTC_CENTER");return h&&(e.scene.position.x+=h[0],e.scene.position.y+=h[1],e.scene.position.z+=h[2]),e}))}}class X extends j{parse(e){const t=new DataView(e),i=String.fromCharCode(t.getUint8(0))+String.fromCharCode(t.getUint8(1))+String.fromCharCode(t.getUint8(2))+String.fromCharCode(t.getUint8(3));console.assert("i3dm"===i);const s=t.getUint32(4,!0);console.assert(1===s);const o=t.getUint32(8,!0);console.assert(o===e.byteLength);const n=t.getUint32(12,!0),r=t.getUint32(16,!0),a=t.getUint32(20,!0),l=t.getUint32(24,!0),h=t.getUint32(28,!0),c=e.slice(32,32+n+r),d=new G(c,0,n,r),u=32+n+r,m=e.slice(u,u+a+l),p=new H(m,d.getData("INSTANCES_LENGTH"),0,a,l),g=u+a+l,f=new Uint8Array(e,g,o-g);let y=null,w=null;if(h)y=f,w=Promise.resolve();else{const e=this.resolveExternalURL(z(f));w=fetch(e,this.fetchOptions).then((t=>{if(!t.ok)throw new Error(`I3DMLoaderBase : Failed to load file "${e}" with status ${t.status} : ${t.statusText}`);return t.arrayBuffer()})).then((e=>{y=new Uint8Array(e)}))}return w.then((()=>({version:s,featureTable:d,batchTable:p,glbBytes:y})))}}const Z=new a.Vector3,Y=new a.Vector3,J=new a.Vector3,ee=new a.Vector3,te=new a.Quaternion,ie=new a.Vector3,se=new a.Matrix4;class oe extends X{constructor(e=a.DefaultLoadingManager){super(),this.manager=e}resolveExternalURL(e){return this.manager.resolveURL(super.resolveExternalURL(e))}parse(e){return super.parse(e).then((e=>{const{featureTable:t,batchTable:i}=e,s=e.glbBytes.slice().buffer;return new Promise(((e,o)=>{const n=this.fetchOptions,r=this.manager,l=r.getHandler("path.gltf")||new Q.GLTFLoader(r);"include"===n.credentials&&"cors"===n.mode&&l.setCrossOrigin("use-credentials"),"credentials"in n&&l.setWithCredentials("include"===n.credentials),n.headers&&l.setRequestHeader(n.headers);let h=this.workingPath;/[\\/]$/.test(h)||(h+="/"),l.parse(s,h,(s=>{const o=t.getData("INSTANCES_LENGTH"),n=t.getData("POSITION",o,"FLOAT","VEC3"),r=t.getData("NORMAL_UP",o,"FLOAT","VEC3"),l=t.getData("NORMAL_RIGHT",o,"FLOAT","VEC3"),h=t.getData("SCALE_NON_UNIFORM",o,"FLOAT","VEC3"),c=t.getData("SCALE",o,"FLOAT","SCALAR");["RTC_CENTER","QUANTIZED_VOLUME_OFFSET","QUANTIZED_VOLUME_SCALE","EAST_NORTH_UP","POSITION_QUANTIZED","NORMAL_UP_OCT32P","NORMAL_RIGHT_OCT32P"].forEach((e=>{e in t.header&&console.warn(`I3DMLoader: Unsupported FeatureTable feature "${e}" detected.`)}));const d=new Map,u=[];s.scene.traverse((e=>{if(e.isMesh){const{geometry:t,material:i}=e,s=new a.InstancedMesh(t,i,o);s.position.copy(e.position),s.rotation.copy(e.rotation),s.scale.copy(e.scale),u.push(s),d.set(e,s)}}));const m=new a.Vector3;for(let e=0;e<o;e++)m.x+=n[3*e+0]/o,m.y+=n[3*e+1]/o,m.z+=n[3*e+2]/o;d.forEach(((e,t)=>{const i=t.parent;i&&(i.remove(t),i.add(e),e.updateMatrixWorld(),e.position.copy(m).applyMatrix4(e.matrixWorld))}));for(let e=0;e<o;e++){ee.set(n[3*e+0]-m.x,n[3*e+1]-m.y,n[3*e+2]-m.z),r?(Y.set(r[3*e+0],r[3*e+1],r[3*e+2]),J.set(l[3*e+0],l[3*e+1],l[3*e+2]),Z.crossVectors(J,Y).normalize(),se.makeBasis(J,Y,Z),te.setFromRotationMatrix(se)):te.set(0,0,0,1),c?ie.setScalar(c[e]):h?ie.set(h[3*e+0],h[3*e+1],h[3*e+2]):ie.set(1,1,1),se.compose(ee,te,ie);for(let t=0,i=u.length;t<i;t++){u[t].setMatrixAt(e,se)}}s.batchTable=i,s.featureTable=t,s.scene.batchTable=i,s.scene.featureTable=t,e(s)}),o)}))}))}}class ne extends j{parse(e){const t=new DataView(e),i=String.fromCharCode(t.getUint8(0))+String.fromCharCode(t.getUint8(1))+String.fromCharCode(t.getUint8(2))+String.fromCharCode(t.getUint8(3));console.assert("cmpt"===i,'CMPTLoader: The magic bytes equal "cmpt".');const s=t.getUint32(4,!0);console.assert(1===s,'CMPTLoader: The version listed in the header is "1".');const o=t.getUint32(8,!0);console.assert(o===e.byteLength,"CMPTLoader: The contents buffer length listed in the header matches the file.");const n=t.getUint32(12,!0),r=[];let a=16;for(let t=0;t<n;t++){const t=new DataView(e,a,12),i=String.fromCharCode(t.getUint8(0))+String.fromCharCode(t.getUint8(1))+String.fromCharCode(t.getUint8(2))+String.fromCharCode(t.getUint8(3)),s=t.getUint32(4,!0),o=t.getUint32(8,!0),n=new Uint8Array(e,a,o);r.push({type:i,buffer:n,version:s}),a+=o}return{version:s,tiles:r}}}class re extends ne{constructor(e=a.DefaultLoadingManager){super(),this.manager=e}parse(e){const t=super.parse(e),i=this.manager,s=[];for(const e in t.tiles){const{type:o,buffer:n}=t.tiles[e];switch(o){case"b3dm":{const e=n.slice(),t=new $(i);t.workingPath=this.workingPath,t.fetchOptions=this.fetchOptions;const o=t.parse(e.buffer);s.push(o);break}case"pnts":{const e=n.slice(),t=new K(i);t.workingPath=this.workingPath,t.fetchOptions=this.fetchOptions;const o=t.parse(e.buffer);s.push(o);break}case"i3dm":{const e=n.slice(),t=new oe(i);t.workingPath=this.workingPath,t.fetchOptions=this.fetchOptions;const o=t.parse(e.buffer);s.push(o);break}}}return Promise.all(s).then((e=>{const t=new a.Group;return e.forEach((e=>{t.add(e.scene)})),{tiles:e,scene:t}}))}}class ae extends j{constructor(e=a.DefaultLoadingManager){super(),this.manager=e}parse(e){return new Promise(((t,i)=>{const s=this.manager,o=this.fetchOptions;let n=s.getHandler("path.gltf")||s.getHandler("path.glb");n||(n=new Q.GLTFLoader(s),"include"===o.credentials&&"cors"===o.mode&&n.setCrossOrigin("use-credentials"),"credentials"in o&&n.setWithCredentials("include"===o.credentials),o.headers&&n.setRequestHeader(o.headers));let r=n.resourcePath||n.path||this.workingPath;!/[\\/]$/.test(r)&&r.length&&(r+="/"),n.parse(e,r,(e=>{t(e)}),i)}))}}const le=new a.Matrix4;class he extends a.Group{constructor(e){super(),this.name="TilesRenderer.TilesGroup",this.tilesRenderer=e}raycast(e,t){this.tilesRenderer.optimizeRaycast&&this.tilesRenderer.raycast(e,t)}updateMatrixWorld(e){if(this.matrixAutoUpdate&&this.updateMatrix(),this.matrixWorldNeedsUpdate||e){null===this.parent?le.copy(this.matrix):le.multiplyMatrices(this.parent.matrixWorld,this.matrix),this.matrixWorldNeedsUpdate=!1;const e=le.elements,t=this.matrixWorld.elements;let i=!1;for(let s=0;s<16;s++){const o=e[s],n=t[s];if(Math.abs(o-n)>Number.EPSILON){i=!0;break}}if(i){this.matrixWorld.copy(le);const e=this.children;for(let t=0,i=e.length;t<i;t++)e[t].updateMatrixWorld()}}}}const ce=new a.Sphere,de=new a.Matrix4,ue=new a.Vector3,me=new a.Vector3,pe=new a.Ray,ge=[];function fe(e,t){return e.distance-t.distance}function ye(e,t,i){e.traverse((e=>{Object.getPrototypeOf(e).raycast.call(e,t,i)}))}function we(e,t,i,s){if(i.has(e)){if(ye(e.cached.scene,s,ge),ge.length>0){ge.length>1&&ge.sort(fe);const e=ge[0];return ge.length=0,e}return null}const o=[],n=e.children;for(let e=0,i=n.length;e<i;e++){const i=n[e],r=i.cached,a=t.matrixWorld;de.copy(a);const l=r.sphere;if(l&&(ce.copy(l),ce.applyMatrix4(de),!s.ray.intersectsSphere(ce)))continue;const h=r.box,c=r.boxTransform;if(h){if(de.multiply(c).invert(),pe.copy(s.ray),pe.applyMatrix4(de),!pe.intersectBox(h,ue))continue;{let e;me.setFromMatrixScale(de),e=me.x,Math.abs(Math.max(me.x-me.y,me.x-me.z))>1e-6&&console.warn("ThreeTilesRenderer : Non uniform scale used for tile which may cause issues when raycasting.");let t={distance:1/0,tile:null};o.push(t),t.distance=ue.distanceToSquared(pe.origin)*e*e,t.tile=i}}}o.sort(fe);let r=1/0,a=null;for(let e=0,n=o.length;e<n;e++){const n=o[e];if(n.distance>r)break;{const e=n.tile,o=e.cached.scene;let l=null;if(i.has(e)?(ye(o,s,ge),ge.length>0&&(ge.length>1&&ge.sort(fe),l=ge[0])):l=we(e,t,i,s),l){const e=l.distance*l.distance;e<r&&(r=e,a=l),ge.length=0}}}return a}function ve(e,t,i,s,o){const n=e.cached,r=t.matrixWorld;de.copy(r);const a=n.sphere;if(a&&(ce.copy(a),ce.applyMatrix4(de),!s.ray.intersectsSphere(ce)))return;const l=n.box,h=n.boxTransform;if(l&&(de.multiply(h).invert(),pe.copy(s.ray).applyMatrix4(de),!pe.intersectsBox(l)))return;const c=n.scene;if(i.has(e))return void ye(c,s,o);const d=e.children;for(let e=0,n=d.length;e<n;e++)ve(d[e],t,i,s,o)}const be=Symbol("INITIAL_FRUSTUM_CULLED"),xe=new a.Matrix4,Me=new a.Matrix4,De=new a.Vector3,Te=new a.Vector3,Se=new a.Vector3,Pe=new a.Vector3,Ce=new a.Vector3(1,0,0),Ae=new a.Vector3(0,1,0);function Oe(e,t){e.traverse((e=>{e.frustumCulled=e[be]&&t}))}class Be extends U{get autoDisableRendererCulling(){return this._autoDisableRendererCulling}set autoDisableRendererCulling(e){this._autoDisableRendererCulling!==e&&(super._autoDisableRendererCulling=e,this.forEachLoadedModel((t=>{Oe(t,!e)})))}constructor(...e){super(...e),this.group=new he(this),this.cameras=[],this.cameraMap=new Map,this.cameraInfo=[],this.activeTiles=new Set,this.visibleTiles=new Set,this._autoDisableRendererCulling=!0,this.optimizeRaycast=!0,this.onLoadTileSet=null,this.onLoadModel=null,this.onDisposeModel=null,this.onTileVisibilityChange=null;const t=new a.LoadingManager;t.setURLModifier((e=>this.preprocessURL?this.preprocessURL(e):e)),this.manager=t;const i=this;this._overridenRaycast=function(e,t){i.optimizeRaycast||Object.getPrototypeOf(this).raycast.call(this,e,t)}}getBounds(e){if(!this.root)return!1;const t=this.root.cached,i=t.box,s=t.boxTransform;return!!i&&(e.copy(i),e.applyMatrix4(s),!0)}getOrientedBounds(e,t){if(!this.root)return!1;const i=this.root.cached,s=i.box,o=i.boxTransform;return!!s&&(e.copy(s),t.copy(o),!0)}getBoundingSphere(e){if(!this.root)return!1;const t=this.root.cached.sphere;return!!t&&(e.copy(t),!0)}forEachLoadedModel(e){this.traverse((t=>{const i=t.cached.scene;i&&e(i,t)}))}raycast(e,t){if(this.root)if(e.firstHitOnly){const i=we(this.root,this.group,this.activeTiles,e);i&&t.push(i)}else ve(this.root,this.group,this.activeTiles,e,t)}hasCamera(e){return this.cameraMap.has(e)}setCamera(e){const t=this.cameras,i=this.cameraMap;return!i.has(e)&&(i.set(e,new a.Vector2),t.push(e),!0)}setResolution(e,t,i){const s=this.cameraMap;return!!s.has(e)&&(t instanceof a.Vector2?s.get(e).copy(t):s.get(e).set(t,i),!0)}setResolutionFromRenderer(e,t){const i=this.cameraMap;if(!i.has(e))return!1;const s=i.get(e);return t.getSize(s),s.multiplyScalar(t.getPixelRatio()),!0}deleteCamera(e){const t=this.cameras,i=this.cameraMap;if(i.has(e)){const s=t.indexOf(e);return t.splice(s,1),i.delete(e),!0}return!1}fetchTileSet(e,...t){const i=super.fetchTileSet(e,...t);return i.then((t=>{this.onLoadTileSet&&Promise.resolve().then((()=>{this.onLoadTileSet(t,e)}))})),i}update(){const e=this.group,t=this.cameras,i=this.cameraMap,s=this.cameraInfo;if(0===t.length)return void console.warn("TilesRenderer: no cameras defined. Cannot update 3d tiles.");for(;s.length>t.length;)s.pop();for(;s.length<t.length;)s.push({frustum:new a.Frustum,isOrthographic:!1,sseDenominator:-1,position:new a.Vector3,invScale:-1,pixelSize:0});let o;Me.copy(e.matrixWorld).invert(),De.setFromMatrixScale(Me),o=De.x,Math.abs(Math.max(De.x-De.y,De.x-De.z))>1e-6&&console.warn("ThreeTilesRenderer : Non uniform scale used for tile which may cause issues when calculating screen space error.");for(let n=0,r=s.length;n<r;n++){const r=t[n],a=s[n],l=a.frustum,h=a.position,c=i.get(r);0!==c.width&&0!==c.height||console.warn("TilesRenderer: resolution for camera error calculation is not set.");const d=r.projectionMatrix.elements;if(a.isOrthographic=1===d[15],a.isOrthographic){const e=2/d[0],t=2/d[5];a.pixelSize=Math.max(t/c.height,e/c.width)}else a.sseDenominator=2/d[5]/c.height;a.invScale=o,xe.copy(e.matrixWorld),xe.premultiply(r.matrixWorldInverse),xe.premultiply(r.projectionMatrix),l.setFromProjectionMatrix(xe),h.set(0,0,0),h.applyMatrix4(r.matrixWorld),h.applyMatrix4(Me)}super.update()}preprocessNode(e,t,i){super.preprocessNode(e,t,i);const s=new a.Matrix4;if(e.transform){const t=e.transform;for(let e=0;e<16;e++)s.elements[e]=t[e]}else s.identity();t&&s.premultiply(t.cached.transform);const o=(new a.Matrix4).copy(s).invert();let n=null,r=null,l=null;if("box"in e.boundingVolume){const t=e.boundingVolume.box;n=new a.Box3,r=new a.Matrix4,l=new a.Matrix4,Te.set(t[3],t[4],t[5]),Se.set(t[6],t[7],t[8]),Pe.set(t[9],t[10],t[11]);const i=Te.length(),o=Se.length(),h=Pe.length();Te.normalize(),Se.normalize(),Pe.normalize(),0===i&&Te.crossVectors(Se,Pe),0===o&&Se.crossVectors(Te,Pe),0===h&&Pe.crossVectors(Te,Se),r.set(Te.x,Se.x,Pe.x,t[0],Te.y,Se.y,Pe.y,t[1],Te.z,Se.z,Pe.z,t[2],0,0,0,1),r.premultiply(s),l.copy(r).invert(),n.min.set(-i,-o,-h),n.max.set(i,o,h)}let h=null;if("sphere"in e.boundingVolume){const t=e.boundingVolume.sphere;h=new a.Sphere,h.center.set(t[0],t[1],t[2]),h.radius=t[3],h.applyMatrix4(s)}else if("box"in e.boundingVolume){const t=e.boundingVolume.box;h=new a.Sphere,n.getBoundingSphere(h),h.center.set(t[0],t[1],t[2]),h.applyMatrix4(s)}"region"in e.boundingVolume&&console.warn("ThreeTilesRenderer: region bounding volume not supported."),e.cached={loadIndex:0,transform:s,transformInverse:o,active:!1,inFrustum:[],box:n,boxTransform:r,boxTransformInverse:l,sphere:h,region:null,scene:null,geometry:null,material:null}}parseTile(e,t,i){t._loadIndex=t._loadIndex||0,t._loadIndex++;const s=t.content.uri.split(/[\\\/]/g);s.pop();const o=s.join("/"),n=this.fetchOptions,r=this.manager,a=t._loadIndex;let l=null;switch(i){case"b3dm":{const t=new $(r);t.workingPath=o,t.fetchOptions=n,l=t.parse(e).then((e=>e.scene));break}case"pnts":{const t=new K(r);t.workingPath=o,t.fetchOptions=n,l=t.parse(e).then((e=>e.scene));break}case"i3dm":{const t=new oe(r);t.workingPath=o,t.fetchOptions=n,l=t.parse(e).then((e=>e.scene));break}case"cmpt":{const t=new re(r);t.workingPath=o,t.fetchOptions=n,l=t.parse(e).then((e=>e.scene));break}case"gltf":case"glb":const t=new ae(r);t.workingPath=o,t.fetchOptions=n,l=t.parse(e).then((e=>e.scene));break;default:console.warn(`TilesRenderer: Content type "${i}" not supported.`),l=Promise.resolve(null)}return l.then((e=>{if(t._loadIndex!==a)return;const s=this.rootTileSet.asset&&this.rootTileSet.asset.gltfUpAxis||"y",o=t.cached,n=o.transform;switch(s.toLowerCase()){case"x":xe.makeRotationAxis(Ae,-Math.PI/2);break;case"y":xe.makeRotationAxis(Ce,Math.PI/2);break;case"z":xe.identity()}e.updateMatrix(),"pnts"!==i&&e.matrix.multiply(xe),e.matrix.premultiply(n),e.matrix.decompose(e.position,e.quaternion,e.scale),e.traverse((e=>{e[be]=e.frustumCulled})),Oe(e,!this.autoDisableRendererCulling),o.scene=e,e.traverse((e=>{e.raycast=this._overridenRaycast}));const r=[],l=[],h=[];e.traverse((e=>{if(e.geometry&&l.push(e.geometry),e.material){const t=e.material;r.push(e.material);for(const e in t){const i=t[e];i&&i.isTexture&&h.push(i)}}})),o.materials=r,o.geometry=l,o.textures=h,this.onLoadModel&&this.onLoadModel(e,t)}))}disposeTile(e){const t=e.cached;if(t.scene){const i=t.materials,s=t.geometry,o=t.textures;for(let e=0,t=s.length;e<t;e++)s[e].dispose();for(let e=0,t=i.length;e<t;e++)i[e].dispose();for(let e=0,t=o.length;e<t;e++){o[e].dispose()}this.onDisposeModel&&this.onDisposeModel(t.scene,e),t.scene=null,t.materials=null,t.textures=null,t.geometry=null}e._loadIndex++}setTileVisible(e,t){const i=e.cached.scene,s=this.visibleTiles,o=this.group;t?(o.add(i),s.add(e),i.updateMatrixWorld(!0)):(o.remove(i),s.delete(e)),this.onTileVisibilityChange&&this.onTileVisibilityChange(i,e,t)}setTileActive(e,t){const i=this.activeTiles;t?i.add(e):i.delete(e)}calculateError(e){const t=e.cached,i=t.inFrustum,s=this.cameras,o=this.cameraInfo,n=e.boundingVolume;if("box"in n||"sphere"in n){const n=t.sphere,r=t.box,a=t.boxTransformInverse,l=t.transformInverse,h=r&&a;let c=-1/0,d=1/0;for(let t=0,u=s.length;t<u;t++){if(!i[t])continue;const s=o[t],u=s.invScale;let m;if(s.isOrthographic){const t=s.pixelSize;m=e.geometricError/(t*u)}else{let t;De.copy(s.position),h?(De.applyMatrix4(a),t=r.distanceToPoint(De)):(De.applyMatrix4(l),t=Math.max(n.distanceToPoint(De),0));const i=t*u,o=s.sseDenominator;m=e.geometricError/(i*o),d=Math.min(d,i)}c=Math.max(c,m)}e.__distanceFromCamera=d,e.__error=c}else"region"in n&&console.warn("ThreeTilesRenderer : Region bounds not supported.")}tileInView(e){const t=e.cached,i=t.sphere,s=t.inFrustum;if(i){const e=this.cameraInfo;let t=!1;for(let o=0,n=e.length;o<n;o++){e[o].frustum.intersectsSphere(i)?(t=!0,s[o]=!0):s[o]=!1}return t}return!0}}var Fe=i(61728);class ke{constructor(){this.caches=new Map}registerPlugin(e,t){this.caches.has(e)||this.caches.set(e,new Map);const i=this.caches.get(e);e.pluginCallbacks.unshift((e=>new _e(e,t,i)))}unregisterLoader(e){this.caches.delete(e)}unregisterAllLoaders(){this.caches.clear()}}class _e{constructor(e,t,i){this.parser=e,this.modelKey=t,this.textureCache=i,this.name="CrossModelTextureCache"}key(e){return`${e} @ ${this.modelKey}`}loadTexture(e){var t;const i=this.textureCache,s=this.parser,o=s.json,n=o.textures[e];let r=n.source;Object.keys(n.extensions).forEach((e=>r=r||n.extensions[e].source));const a=null===(t=o.images[r])||void 0===t?void 0:t.uri;if(void 0===a)return null;const l=i.get(this.key(a));if(l)return l;let h=s._invokeOne((t=>t===this?null:t.loadTexture&&t.loadTexture(e)));h||(h=s.loadTexture(e));const c=h.then((e=>{const t=()=>{i.delete(this.key(a)),null==e||e.removeEventListener("dispose",t)};return null==e||e.addEventListener("dispose",t),e}));return i.set(this.key(a),c),c}}var Ve=i(79545),Ee=i(10691);class Ie{constructor(e){this.parser=e,this.name="MTTR_three_mesh_bvh"}async loadMesh(e){const t=async(t,i)=>{var s,o;const n=this.parser.json.meshes[e].primitives[i];if(null===(s=n.extensions)||void 0===s?void 0:s.MTTR_three_mesh_bvh){const e=null===(o=n.extensions)||void 0===o?void 0:o.MTTR_three_mesh_bvh,i={roots:(await Promise.all(e.roots.map((e=>this.parser.loadAccessor(e))))).map((e=>{const t=e.array;return t.byteLength!==t.buffer.byteLength?t.slice().buffer:t.buffer})),index:new Uint8Array(0)};t.geometry.boundsTree=Ve.G.deserialize(i,t.geometry,{setIndex:!1})}},i=[],s=await this.loadMeshInternal(e);if(s)if("Group"===s.type){const e=s;i.push(...e.children.map(((e,i)=>t(e,i))))}else"Mesh"===s.type&&i.push(t(s,0));return await Promise.all(i),s}async loadMeshInternal(e){const t=this.parser,i=t,s=this.parser.json.meshes[e],o=s.primitives,r=[];for(let e=0,s=o.length;e<s;e++){const s=void 0===o[e].material?t.createDefaultMaterial(i.cache):t.getDependency("material",o[e].material);r.push(s)}return r.push(t.loadGeometries(o)),Promise.all(r).then((function(i){const r=i.slice(0,i.length-1),l=i[i.length-1],h=[];for(let i=0,a=l.length;i<a;i++){const a=l[i],c=o[i];let d;const u=r[i];if(c.mode!==Re.TRIANGLES&&void 0!==c.mode)throw new Error("THREE.GLTFLoader: Primitive mode unsupported: "+c.mode);d=new Ee.B(0,0,n.H.DEFAULT),d.geometry=a,d.material=u,d.name=t.createUniqueName(s.name||"mesh_"+e),Le(d,s),t.assignFinalMaterial(d),h.push(d)}if(1===h.length)return h[0];const c=new a.Group;for(let e=0,t=h.length;e<t;e++)c.add(h[e]);return c}))}}const Re={FLOAT:5126,FLOAT_MAT3:35675,FLOAT_MAT4:35676,FLOAT_VEC2:35664,FLOAT_VEC3:35665,FLOAT_VEC4:35666,LINEAR:9729,REPEAT:10497,SAMPLER_2D:35678,POINTS:0,LINES:1,LINE_LOOP:2,LINE_STRIP:3,TRIANGLES:4,TRIANGLE_STRIP:5,TRIANGLE_FAN:6,UNSIGNED_BYTE:5121,UNSIGNED_SHORT:5123};function Le(e,t){void 0!==t.extras&&"object"==typeof t.extras&&Object.assign(e.userData,t.extras)}var Ne=i(71916),Ue=i(14495);class ze extends Ne.KTX2Loader{constructor(e,t,i){super(i),this.urlSigner=e,this.api=t,this.taskCache=new WeakMap}load(e,t,i,s){const o=new a.CompressedTexture([],0,0,a.RGB_ETC2_Format);return this.urlSigner(e).then((async e=>{const s=await this.api.get(e,{onProgress:i,responseType:"arraybuffer",priority:Ue.QK.MEDIUM});let n=this.taskCache.get(s);if(!n){n={promise:this._createTexture(s)},this.taskCache.set(s,n)}const r=await n.promise;o.copy(r),o.needsUpdate=!0,t(o)})).catch(s),o}preload(){this.init()}}let Ge;const He=/\gltf$/,je=/\glb$/;var We,Qe=i(44588);class $e extends C{constructor(e,t,i,s){super(),this.urlSigner=e,this.api=t,this.onProgress=s,this.priorityCallback=i}add(e,t){return super.add(e,(async e=>{var i,s,o;if(null===(i=null==e?void 0:e.content)||void 0===i?void 0:i.uri){const i=e.content.uri;try{const n=null===(s=this.onProgress)||void 0===s?void 0:s.bind(this,e);if(e.content.uri=await this.urlSigner(i),(null===(o=e.extras)||void 0===o?void 0:o.level)===Qe.X.Min)return t(e).then((e=>n?function(e,t){if(e.ok&&e.body){const i=e.body.getReader(),s=e.headers.get("Content-Length");let o=s?+s:0,n=0!==o,r=0;const a=new ReadableStream({async start(e){for(;;){const{done:s,value:a}=await i.read();if(a&&(r+=a.byteLength,e.enqueue(a)),s&&(o=r,n=!0),null==t||t(new ProgressEvent("progress",{lengthComputable:n,loaded:r,total:o})),s){e.close();break}}}});e=new Response(a)}return e}(e,n):e));{const i=window.fetch;try{return window.fetch=async(e,t)=>{const i=await this.api.get(e,{responseType:"blob",priority:Ue.QK.MEDIUM,onProgress:n,signal:null==t?void 0:t.signal});return new Response(i)},t(e)}finally{window.fetch=i}}}finally{e.content.uri=i}}}))}}class qe extends C{constructor(e){super(),this.settings=e,this.prioritizeBy=We.FRUSTUM_ERROR_THRESH,this.priorityCallback=(e,t)=>this.prioritizeBy===We.FRUSTUM_ERROR_THRESH?this.sortBySelectors(e,t,[e=>Number(e.__inFrustum),e=>Number(e.__error<=this.settings.errorTarget),e=>e.__error,e=>e.__distanceFromCamera]):this.defaultPriorityCallback(e,t)}sortBySelectors(e,t,i){for(const s of i){const i=this.compareTile(e,t,s);if(null!==i)return i}return 0}compareTile(e,t,i){const s=i(e),o=i(t);return s===o?null:s>o?1:-1}defaultPriorityCallback(e,t){return e.__depth!==t.__depth?e.__depth>t.__depth?-1:1:e.__inFrustum!==t.__inFrustum?e.__inFrustum?1:-1:e.__used!==t.__used?e.__used?1:-1:e.__error!==t.__error?e.__error>t.__error?1:-1:e.__distanceFromCamera!==t.__distanceFromCamera?e.__distanceFromCamera>t.__distanceFromCamera?-1:1:0}}!function(e){e.DEFAULT="DEFAULT",e.FRUSTUM_ERROR_THRESH="FRUSTUM_ERROR_THRESH"}(We||(We={}));var Ke=i(81483),Xe=i(27153);const Ze=3;class Ye{constructor(e,t,i,s,o,n,r,a){this.container=e,this.threeRenderer=t,this.chunkFactory=i,this.tilesetInfo=s,this.commandBinder=o,this.api=n,this.gltfConfig=r,this.settings=a,this.name="MttrTileLoader",this.log=new x.Ay("3d-tiles"),this.loadStats={startTimes:{start:0,tileset:0,lod0:0},timings:{tileset:"",lod0:""}},this.lodDeferreds=[],this.tileProgress=new WeakMap,this.onChunksLoaded=new Set,this.onChunksUnloaded=new Set,this.tileSetLoaded=!1,this.minimalLoaded=!1,this.minimalTileCount=0,this.signUrl=async e=>{if(e.startsWith("blob"))return e;return(await this.tilesetInfo.urlTemplate.get()).replace(this.settings.urlTemplateToken,e)},this.onTileGltfDownloadProgress=(e,t)=>{this.tileProgress.set(e,t.lengthComputable?.5*t.loaded/t.total:0),this.checkLoadStatus()},this.checkLoadStatus=(()=>{const e=[];let t=!1,i=!1;return(0,M.n)((()=>{t&&i||!this.tileSetLoaded||(0===e.length&&(e.push([],[]),this.tilesRenderer.traverse(((t,i,s)=>{var o;const n=null===(o=t.extras)||void 0===o?void 0:o.level;return 0!==n&&1!==n||e[n].push(t),!1}),null)),t||(t=this.notifyIfFullyLoaded(0,e,!0),t&&(this.tilesRenderer.update(),this.log.debug("LOD0 fully downloaded, allow showing more lods"),this.minimalLoaded=!0,this.minimalTileCount=e[0].length,this.loadStats.timings.lod0=(performance.now()-this.loadStats.startTimes.lod0).toFixed(1)+"ms")),i||(i=this.notifyIfFullyLoaded(1,e,!1),i&&(e.length=0)))}),16)})()}async init(){this.loadStats.startTimes.start=performance.now();const e=await this.signUrl(this.tilesetInfo.rootFilename);this.tilesRenderer=new Be(e),this.tilesRenderer.manager=new a.LoadingManager;const t=function(e,t,i,s,o,n){const r=new Fe.DRACOLoader(t);r.setDecoderPath(`${o.dracoDecoderPath}`),r.preload();const a=new Q.GLTFLoader(t);a.setDRACOLoader(r),a.register((e=>new Ie(e))),Ge||(Ge=new ke),Ge.registerPlugin(a,n);const l=new ze(i,s,t);return l.setTranscoderPath(o.basisTranscoderPath),l.detectSupport(e),l.preload(),a.setKTX2Loader(l),t.removeHandler(He),t.addHandler(He,a),t.removeHandler(je),t.addHandler(je,a),a}(this.threeRenderer,this.tilesRenderer.manager,this.signUrl,this.api,this.gltfConfig,e);this.configureTilesRenderer(this.tilesRenderer,t)}setCamera(e,t,i){this.tilesRenderer.setCamera(e),this.tilesRenderer.setResolution(e,t,i)}hasCamera(e){return this.tilesRenderer.hasCamera(e)}deleteCamera(e){return this.tilesRenderer.deleteCamera(e)}notifyOnChunksLoaded(e){return(0,v.Sh)((()=>this.onChunksLoaded.add(e)),(()=>this.onChunksLoaded.delete(e)),!0)}notifyOnChunksUnloaded(e){return(0,v.Sh)((()=>this.onChunksUnloaded.add(e)),(()=>this.onChunksUnloaded.delete(e)),!0)}notifyOnLodProgress(e,t){this.getLodDeferred(e).progress(t)}awaitLod(e){return this.getLodDeferred(e).nativePromise()}getLodDeferred(e){return this.lodDeferreds[e]||(this.lodDeferreds[e]=new b.i)}update(){const{minimalLoaded:e,tilesRenderer:t}=this;e?(t.displayActiveTiles=this.settings.displayActiveTiles,t.loadSiblings=this.settings.loadSiblings,t.stopAtEmptyTiles=this.settings.stopAtEmptyTiles,t.autoDisableRendererCulling=this.settings.autoDisableRendererCulling,t.downloadQueue.maxJobs=this.settings.downloadQueueConcurrency,t.parseQueue.maxJobs=this.settings.parseQueueConcurrency):(t.loadSiblings=!0,t.downloadQueue.maxJobs=1/0,t.parseQueue.maxJobs=1/0),t.optimizeRaycast=this.settings.optimizeRaycast,t.errorTarget=this.settings.errorTarget,t.lruCache.maxSize=e?Math.max(this.settings.lruMaxTiles,this.minimalTileCount):1/0,t.update(),t.lruCache.minSize=this.settings.lruMinExtraTiles+t.lruCache.usedSet.size,t.lruCache.unloadPercent=this.settings.lruUnloadPercent}getDownloadParseStatus(){return this.tilesRenderer.stats}configureTilesRenderer(e,t){const i=e.calculateError.bind(e);e.calculateError=e=>{i(e),this.adjustScreenSpaceError&&(e.__error=this.adjustScreenSpaceError(e.__error,e))},e.errorTarget=this.settings.errorTarget,e.loadSiblings=this.settings.loadSiblings,e.stopAtEmptyTiles=this.settings.stopAtEmptyTiles,e.displayActiveTiles=this.settings.displayActiveTiles;const s=e.preprocessNode.bind(e);e.preprocessNode=function(e,t,i){return s(e,t,"")},this.configurePriorityQueues(),this.container.add(e.group);const o=(new a.Quaternion).setFromAxisAngle(new a.Vector3(-1,0,0),a.MathUtils.degToRad(90));this.container.quaternion.copy(o),this.container.updateMatrixWorld(!0),e.onLoadTileSet=this.onLoadTileset.bind(this),e.onLoadModel=this.onLoadModel.bind(this),e.onDisposeModel=this.onDisposeModel.bind(this);const n=e.setTileActive.bind(e);e.setTileActive=(e,t)=>{n(e,t),this.onTileActiveChange&&this.onTileActiveChange(e,t)};const r=e.setTileVisible.bind(e);e.setTileVisible=(e,t)=>{r(e,t),this.onTileVisibleChange&&this.onTileVisibleChange(e,t)};const l=e.tileInView.bind(e);e.tileInView=e=>{let t=l(e);return this.adjustTileInView&&(t=this.adjustTileInView(t,e)),t}}configurePriorityQueues(){const{tilesRenderer:e}=this;e.downloadQueue=new $e(this.signUrl,this.api,e.downloadQueue.priorityCallback,this.onTileGltfDownloadProgress),e.parseQueue=new qe(this.settings);const t=e=>{this.commandBinder.issueCommand(new D.m("mesh/tiled/priorityQueue",e,100))};e.parseQueue.schedulingCallback=t,e.downloadQueue.schedulingCallback=t}async onLoadModel(e,t){const i=function(e,t,i){var s;const o=[],n=(null===(s=t.extras)||void 0===s?void 0:s.id)||""+e.id;return e.name=n,e.traverse((s=>{var r,a;if(s.matrixAutoUpdate=!1,s.updateMatrix(),s instanceof Ee.B){const l=new Ke.$(s);e.add(l);const{group:h,subgroup:c,chunkIndex:d}=(0,Xe.g8)(`${n}-${s.name}`),u=s.material,m=u.map;let p=null!==(r=null==m?void 0:m.name)&&void 0!==r?r:u.name;p=p.replace(".jpg","");const g=i(h,c,s.geometry,p);g.textureLODInfo=function(e,t){if(t&&(null==t?void 0:t.maxTextureSize)&&(null==t?void 0:t.texelSize)&&(null==t?void 0:t.textureScale)&&t.textureScale>0){const i=t.textureScale;return{name:e,maxTexelSize:.001*t.texelSize,maxTextureSize:t.maxTextureSize,minTexelSize:1/i*t.texelSize*.001,minTextureSize:i*t.maxTextureSize,minScale:i}}return null}(p,t.extras)||void 0,g.lod=(null===(a=t.extras)||void 0===a?void 0:a.level)||0,g.chunkIndex=d,g.notifyOnMaterialUpdated((e=>{s.material=e}));const f={};f.map=m,s.buildWithSingleChunk(g),s.material=g.setMaterialsUniform(f),g.name=s.name,g.embeddedTexture=f.map,o.push(g)}})),e.matrixWorld.copy(e.matrix),e.matrixWorld.premultiply(c),e.children.forEach((e=>e.updateMatrixWorld(!0))),o}(e,t,this.chunkFactory);for(const e of i)this.container.addChunk(e);for(const e of this.onChunksLoaded.values())e(i,t);this.onModelLoaded&&this.onModelLoaded(e,t),this.tileProgress.set(t,1),await new Promise((e=>setTimeout(e,0))),this.checkLoadStatus()}onDisposeModel(e,t){e.traverse((e=>{if((0,g.PO)(e)){const i=e.chunks;if(!i)return void this.log.error("Missing chunks from RoomMesh");for(const e of i)this.container.removeChunk(e);for(const e of this.onChunksUnloaded.values())e(i,t)}})),this.onModelUnloaded&&this.onModelUnloaded(e,t),e.traverse((e=>{(0,g.PO)(e)&&e.reset()}))}onLoadTileset(e,t){var i;const s=!this.tileSetLoaded;let o="";s&&(o=(performance.now()-this.loadStats.startTimes.start).toFixed(1),this.loadStats.timings.tileset=o+"ms");const n=null===(i=t.match(/[^/]*\.json/))||void 0===i?void 0:i[0];this.log.debug(`Tileset ${n} load${s?`: ${o}ms`:""}`,e),s&&(this.loadStats.startTimes.lod0=performance.now()),this.tileSetLoaded=!0,this.onTilesetLoaded&&this.onTilesetLoaded(e,t),this.tilesRenderer.update()}notifyIfFullyLoaded(e,t,i){if(!t[e])return!1;const s=t[e],o=s.filter((e=>e.__loadingState!==Ze)),n=this.getLodDeferred(e);return i&&n.notify(s.reduce(((e,t)=>e+(this.tileProgress.get(t)||0)/s.length),0)),0===o.length&&n.resolve(),0===o.length}}var Je=i(97624),et=i(2173);class tt extends y.o{constructor(e,t=n.H.ALL,i){super(),this.uuid=e,this.renderLayer=t,this.chunkSharedState=i,this.boundingBox=new a.Box3,this.size=new a.Vector3,this.center=new a.Vector3,this.tilesByChunkId=new Map,this.bindings=[],this.roomMeshesByTile=new Map,this.activeRoomMeshes=new Set,this.visibleRoomMeshes=new Set,this.activeTiles=new Set,this.tileActiveDescendantCounts=new WeakMap,this.isActiveRoomMeshFilter=e=>this.activeRoomMeshes.has(e),this.isActiveRoomMeshSnapFilter=e=>{var t,i,s;const o=null===(t=e.meta)||void 0===t?void 0:t.tile;if(o){const{snappingMaxLOD:e}=this.settings,t=null!==(s=null===(i=o.extras)||void 0===i?void 0:i.level)&&void 0!==s?s:1/0;if(t===e&&(this.tileActiveDescendantCounts.get(o)||0)>0||t<=e&&this.activeTiles.has(o))return!0}return!1},this.settings=Object.assign({},et.W),this.maxLOD=this.settings.maxLOD,this.layers.mask=t.mask,this.overriddenIsTileInView=this.overriddenIsTileInView.bind(this),this.flipDownload=!1,this.flipUpload=!1}dispose(){super.dispose(),this.bindings.forEach((e=>e.cancel())),this.bindings=[]}async load(e,t,i,s,o,n,a,l,h,d){this.renderer=t,this.cameraData=s,n.root=this,this.maxLOD=this.settings.maxLOD=o.maxLOD,this.tileLoader=new Ye(this,t.threeRenderer,a,o,e.commandBinder,h,d,this.settings),await this.tileLoader.init(),this.tileLoader.setCamera(i,s.width,s.height),this.bindings.push(e.subscribe(r.h,(e=>{this.tileLoader.setCamera(i,e.width,e.height)}))),this.tileLoader.onModelLoaded=(e,t)=>{let i=this.roomMeshesByTile.get(t);i||(i=[],this.roomMeshesByTile.set(t,i)),e.traverse((e=>{e.layers.mask=this.renderLayer.mask,(0,g.PO)(e)&&(n.rooms.add(e),i.push(e),this.inputIni&&this.registerMeshForCollision(this.inputIni,e,t))})),n.commit()},this.tileLoader.onModelUnloaded=(e,t)=>{e.traverse((e=>{e instanceof Ee.B&&(n.rooms.delete(e),this.inputIni&&this.unregisterMeshFromCollision(this.inputIni,e))})),n.commit(),this.tileLoader.onTileActiveChange(t,!1),this.tileLoader.onTileVisibleChange(t,!1),this.roomMeshesByTile.delete(t)},this.tileLoader.onTileActiveChange=(e,t)=>{var i;const s=t?"add":"delete";null===(i=this.roomMeshesByTile.get(e))||void 0===i||i.forEach((e=>{this.activeRoomMeshes[s](e)})),this.activeTiles[s](e);for(let i=e.parent;i;i=i.parent){const e=this.tileActiveDescendantCounts.get(i)||0;this.tileActiveDescendantCounts.set(i,e+(t?1:-1))}},this.tileLoader.onTileVisibleChange=(e,t)=>{var i;null===(i=this.roomMeshesByTile.get(e))||void 0===i||i.forEach((e=>{this.visibleRoomMeshes[t?"add":"delete"](e)}))},this.initTileLodAdjustments(this.tileLoader,l),this.tileLoader.notifyOnLodProgress(0,(t=>{e.broadcast(new w.EX(t,1))})),this.tileLoader.notifyOnChunksLoaded(((e,i)=>{var s;0===(null===(s=i.extras)||void 0===s?void 0:s.level)&&e.forEach((e=>{t.threeRenderer.initTexture(e.embeddedTexture)}))})),this.tileLoader.update(),this._detail="minimal",await this.tileLoader.awaitLod(this.settings.initialMaxLOD),this._detail="default",this.tileLoader.tilesRenderer.getBounds(this.boundingBox),this.boundingBox.getSize(this.size).applyMatrix4(c),this.boundingBox.getCenter(this.center).applyMatrix4(c);const u=this.size.clone().multiplyScalar(.5).length(),{smallMeshThreshold:m,smallMeshErrorMultiplier:p}=this.settings;u<m&&(this.settings.errorTarget=Math.min(this.settings.errorTarget,u*p))}initTextureLoader(e,t){return e.limitMemoryUsage=this.settings.limitMemoryUsage,e.setModel(this,this._chunks,t),this.bindings.push(this.tileLoader.notifyOnChunksLoaded((t=>{e.addChunkSlots(this,t);for(const e of this.onChunksLoaded.values())e(t)})),this.tileLoader.notifyOnChunksUnloaded((t=>{e.removeChunks(t)}))),e.allowTextureDownload=()=>{const{downloading:e,parsing:t}=this.tileLoader.getDownloadParseStatus();return 0===e&&0===t},Promise.resolve()}initTileLodAdjustments(e,t){e.adjustTileInView=this.overriddenIsTileInView;const i=this.tilesByChunkId,s=new Map;let o=0;this.bindings.push(e.notifyOnChunksLoaded(((e,t)=>{for(const s of e)i.set(s.id,t)})),t.notifyOnNewSighting(((e,t)=>{o++;const n=i.get(e.id);if(n){for(let e=n.parent;e;e=e.parent)s.set(e,o);d(n,(e=>!(e!==n&&!u(t.point,e))&&(s.set(e,o),!0)))}})),this.tileLoader.notifyOnChunksUnloaded((e=>{for(const t of e)i.delete(t.id),t.dispose()}))),e.adjustScreenSpaceError=(e,t)=>{var i,n;if(1!==this.settings.errorMultiplierRaycastOcclusion){(null!==(i=s.get(t))&&void 0!==i?i:-1/0)<o-Je.xT.sightingMaxAge&&(e*=this.settings.errorMultiplierRaycastOcclusion)}if(1!==this.settings.errorMultiplierHiddenFloors){(null===(n=this.roomMeshesByTile.get(t))||void 0===n?void 0:n.some((e=>e.chunks.some((e=>e.getOpacity()>Je.u7.FADE_TILE_VISIBLE_THRESHOLD)))))||(e*=this.settings.errorMultiplierHiddenFloors)}return p(t)<this.settings.minLOD&&(e=Math.max(e,this.settings.errorTarget+1e-10)),e}}registerCollision(e){this.inputIni=e,this.tileLoader.tilesRenderer.forEachLoadedModel(((t,i)=>{t.traverse((t=>{(0,g.PO)(t)&&this.registerMeshForCollision(e,t,i)}))}))}unregisterCollision(e){this.tileLoader.tilesRenderer.forEachLoadedModel(((t,i)=>{t.traverse((t=>{(0,g.PO)(t)&&this.unregisterMeshFromCollision(e,t)}))}))}addChunk(e){this._chunks.push(e)}removeChunk(e){const t=this._chunks.indexOf(e);this._chunks.splice(t,1)}onUpdate(){this.settings.disableTileUpdates||(this.tileLoader.tilesRenderer.setResolution(this.renderer.getCamera(),this.cameraData.width,this.cameraData.height),this.tileLoader.update(),this.checkDispose()),this.downgradeIfMemoryConstrained()}setTextureQuality(e,t,i){e.setQuality(f.M.LOW,i)}get visibleChunks(){const e=this.visibleRoomMeshes;return{*[Symbol.iterator](){for(const t of e)for(const e of t.chunks)yield e}}}registerMeshForCollision(e,t,i){e.registerMesh(t,this.addToOctree,this.isActiveRoomMeshFilter),t.chunks[0].lod<=this.settings.snappingMaxLOD&&e.registerSnappingMeshGeometry(t.name,t.geometry,{tile:i,meshGroup:t.meshGroup},this.isActiveRoomMeshSnapFilter)}unregisterMeshFromCollision(e,t){e.unregisterMesh(t),e.unregisterSnappingMeshGeometry(t.name)}overriddenIsTileInView(e,t){const i=p(t.parent);if("minimal"===this._detail&&-1===i)return!0;let s=this.settings.nonMeshMaxLOD;return"max"===this._detail&&(s=this.settings.maxLOD),"minimal"===this._detail&&(s=this.settings.initialMaxLOD),!(i>=s)&&e}overrideMaxDetail(e){if(e!==this._detail)switch(this._detail=e,this._detail){case"minimal":this.setMaxLOD(0);break;case"max":this.setMaxLOD(null);break;default:const e=this.size.length()/2<this.settings.smallMeshThreshold;this.setMaxLOD(e?this.settings.maxLOD:this.settings.nonMeshMaxLOD)}}setMaxLOD(e){e=null!=e?e:this.maxLOD,this.settings.maxLOD=e}downgradeIfMemoryConstrained(){this.renderer.estimatedGPUMemoryAllocated()>2**20*(this.settings.limitMemoryUsage?this.settings.allocatedMegsBeforeLimitingLod:1/0)&&this.settings.maxLOD>0&&this.setMaxLOD(this.settings.maxLOD-1)}checkDispose(){if(this.settings.disposeModel){const e=this.tileLoader.tilesRenderer,t=e;for(const e of t.cameras)t.deleteCamera(e);const i=.001,s=new a.OrthographicCamera(-i,i,i,-i,i,2*i);s.position.set(0,-1e4,0),s.rotation.setFromVector3(new a.Vector3(0,-1,0)),s.updateMatrix(),s.updateMatrixWorld(),this.tileLoader.setCamera(s,100,100),e.lruCache.minSize=0,e.lruCache.unloadPercent=1,e.lruCache.markAllUnused(),e.update(),e.dispose(),this.chunkSharedState.dispose(),this.settings.disableTileUpdates=!0}}}const it=async function({uuid:e,model:t,engine:i,renderLayer:n,settings:r,roomMeshData:a,chunkFactory:l,chunkVisibilityChecker:h,chunkSharedState:c,gltfConfig:d}){const[u,m,p]=await Promise.all([i.getModuleBySymbol(s.M7),i.getModuleBySymbol(s.qL),i.market.waitForData(o.M)]),g=new tt(e,n,c);return await g.load(i,u,u.getCamera(),p,t.tileset,a,l,h,m.getApi(),d),g}},20804:(e,t,i)=>{"use strict";i.d(t,{PO:()=>o,m2:()=>n});var s=i(10691);const o=e=>!!e&&e instanceof s.B,n={hasMeshGroup:e=>"object"==typeof e&&!!e&&"meshGroup"in e,hasMeshSubgroup:e=>"object"==typeof e&&!!e&&"meshSubgroup"in e,isRoomMesh:o,isVisibleRoomMesh:e=>o(e)&&e.raycastEnabled&&e.visible}},96822:(e,t,i)=>{"use strict";i.d(t,{Jn:()=>h,rt:()=>l});var s=i(68909);const o=i(97624).Ay.sightingMaxAge,n=new s.Color;let r,a=-1;const l=(e,t,i)=>{r||(r=new s.InstancedMesh(new s.SphereGeometry(.005,8,4),new s.MeshBasicMaterial,o),r.frustumCulled=!1,c(r));const l=new s.Matrix4;return({point:s,distance:h})=>{const c=h/i.fovDistanceScale();l.makeScale(c,c,c).setPosition(s),r.setMatrixAt(++a%o,l),r.instanceMatrix.needsUpdate=!0;for(let t=o;t--;)r.setColorAt((a-t+o)%o,n.setHex(e).multiplyScalar(1-t/o));r.instanceColor&&(r.instanceColor.needsUpdate=!0),r.parent||t.scene.add(r)}},h=()=>{var e;r&&(null===(e=r.parent)||void 0===e||e.remove(r),c(r))};function c(e){const t=(new s.Matrix4).makeScale(0,0,0);for(let i=0;i<o;i++)e.setMatrixAt(i,t)}new s.Vector4(1,0,0,1),new s.Vector4(0,1,0,1),new s.Vector4(0,0,1,1),new s.Vector4(1,1,0,1),new s.Vector4(1,0,1,1),new s.Vector4(1,1,1,1),new s.Vector4(0,1,1,1),new s.Vector4(0,0,0,1)},39486:(e,t,i)=>{"use strict";i.d(t,{J:()=>o});var s=i(84229);class o extends s.t{constructor(e){super(e),this.name="TooManyTrimsError"}}},27153:(e,t,i)=>{"use strict";i.d(t,{QN:()=>r,g8:()=>o,tn:()=>n,yL:()=>a});var s=i(68909);function o(e){const t=e.match(/group([0-9]+)/),i=e.match(/sub([0-9]+)/),s=e.match(/type([0-9]+)/),o=e.match(/mirror([0-9]+)/),n=e.match(/window([0-9]+)/),r=e.match(/chunk([0-9]+)/),a=e.match(/_chunk([0-9]+)/),l=s?parseInt(s[1],10):o&&!isNaN(parseInt(o[1],10))?100:n&&!isNaN(parseInt(n[1],10))?101:0;return{group:t?parseInt(t[1],10):0,subgroup:i?parseInt(i[1],10):0,chunkIndex:r?parseInt(r[1],10):0,nodeIndex:a?parseInt(a[1],10):0,type:l}}function n(e,t=!1){let i=e.getAttribute("barycentric");if(i)return i;const o=(e.getIndex()||e.getAttribute("position")).count/3,n=[];for(let e=0;e<o;e++){const i=t?1:0;e%2==0?n.push(0,0,1,0,1,0,1,0,i):n.push(0,1,0,0,0,1,1,0,i)}const r=new Float32Array(n);return i=new s.BufferAttribute(r,3),e.setAttribute("barycentric",i),i}function r(e=16777215*Math.random(),t=1){const i=function(e,t,i,s=1){const o=document.createElement("canvas");o.width=t,o.height=i;const n=o.getContext("2d");return n&&(n.fillStyle=`rgba(${255*e.r|0},${255*e.g|0},${255*e.b|0}, ${255*s|0})`,n.fillRect(0,0,t,i)),o}((new s.Color).setHex(e),1,1,t),o=new s.CubeTexture([i,i,i,i,i,i]);return o.format=s.RGBAFormat,o.needsUpdate=!0,o}const a=(()=>{const e=new s.Vector3,t=new s.Vector3,i=new s.Vector3,o=new s.Vector3,n=new s.Vector3,r=new s.Vector3;return a=>{const l=new s.Vector3,h=a.index,c=a.getAttribute("position");if(null!=c&&null!=h){let s=0;for(let a=0,d=h.count;a<d;a+=3){const d=h.getX(a+0),u=h.getX(a+1),m=h.getX(a+2);e.fromBufferAttribute(c,d),t.fromBufferAttribute(c,u),i.fromBufferAttribute(c,m),o.subVectors(i,t),n.subVectors(e,t),o.cross(n);const p=o.length()/2;p>0&&(s+=p,r.set(0,0,0).add(e).add(t).add(i).multiplyScalar(1/3*p),l.add(r))}s>0?l.multiplyScalar(1/s):a.boundingBox&&a.boundingBox.getCenter(l)}return l}})()},75092:(e,t,i)=>{"use strict";i.d(t,{X:()=>o});var s=i(18268);class o extends s.u{constructor(e=null){super(),this.payload={cursor:e}}}o.id="SET_MOUSE_CURSOR"},28883:(e,t,i)=>{"use strict";var s;i.d(t,{b:()=>s}),function(e){e.NONE="none",e.DEFAULT="default",e.MOVE="move",e.MOVE_LF="col-resize",e.MOVE_UD="row-resize",e.XHAIR="crosshair",e.PLUS="cell",e.QUESTION="help",e.NOPE="not-allowed",e.FINGER="pointer",e.TEXT="text",e.TEXT_VERT="vertical-text",e.ZOOM_IN="zoom-in",e.ZOOM_OUT="zoom-in",e.GRAB="grab",e.GRABBING="grabbing",e.ARROW_R="e-resize",e.ARROW_L="w-resize",e.ARROW_U="n-resize",e.ARROW_D="s-resize",e.ARROW_UR="ne-resize",e.ARROW_UL="nw-resize",e.ARROW_DR="se-resize",e.ARROW_DL="sw-resize",e.ARROW_LR="ew-resize",e.ARROW_UD="ns-resize",e.ARROW_URDL="nesw-resize",e.ARROW_ULDR="nwse-resize",e.ROOMBOUNDS_DEFAULT="rbe-default",e.ROOMBOUNDS_MOVING="rbe-moving",e.ROOMBOUNDS_PLACE_NODE="rbe-place-node",e.ROOMBOUNDS_FINISH_ROOM="rbe-finish-room"}(s||(s={}))},56597:(e,t,i)=>{"use strict";i.r(t),i.d(t,{Cursor:()=>o.b,SetMouseCursorCommand:()=>n.X,default:()=>r});var s=i(23205),o=i(28883),n=i(75092);class r extends s.n{constructor(){super(...arguments),this.name="mouse-cursor",this.activeCursor=null}async init(e,t){this.config=Object.assign({classPrefix:"cursor"},e),this.bindings.push(t.commandBinder.addBinding(n.X,(async e=>this.changeCursor(e.cursor))))}changeCursor(e){const{container:t,classPrefix:i}=this.config;e!==this.activeCursor&&(this.activeCursor&&t.classList.remove(`${i}-${this.activeCursor}`),e&&t.classList.add(`${i}-${e}`),this.activeCursor=e)}}},1182:(e,t,i)=>{"use strict";i.r(t),i.d(t,{default:()=>Ve});var s=i(23205),o=i(28997),n=i(35223),r=i(45018),a=i(71136),l=i(99817),h=i(80399),c=i(1902),d=i(66871);class u extends d.d{constructor(e){super(e),this.name="NavigationException"}}const m={Locked:"Cannot move while navigation is locked",InsideOnly:"Cannot navigate between panos when not in Panorama mode",InvalidSweep:"Not at a valid sweep",InTransition:"Cannot move while in a transition",NoDestinationFound:"Cannot move in that direction",InvalidMode:"Cannot move to mode"};var p=i(42311),g=i(86407),f=i(59935),y=i(90302),w=i(68909),v=i(93605),b=i(75987),x=i(58421),M=i(75092),D=i(28883),T=i(95226);class S{constructor(e,t,i,s,o,n,r,a,l,h){this.canStartTransition=e,this.commandBinder=t,this.input=i,this.floorsViewData=s,this.navigation=o,this.sweepData=n,this.cameraModule=r,this.meshQuery=a,this.doubleClickToEnter=l,this.hasRoomBounds=h,this.bindings=[],this.cancelTransition=!1,this.targetFloorId=null,this.targetHitPoint=new w.Vector3,this.changeFloorPromise=null,this.toggleInput=e=>{this.bindings.forEach((t=>e?t.renew():t.cancel()))},this.onRoomClick=(e,t,i)=>{if(!this.canStartTransition())return!1;if(this.changeFloorPromise)return!0;if(!i||!i.point)return!1;const s=this.meshQuery.floorIdFromObject(t);if(!s)return!1;if(!this.floorsViewData.isNavigable(s))return this.onBackgroundClick();if(this.cancelTransition)return!0;const o=this.floorsViewData.currentFloorId;return 1!==this.floorsViewData.totalFloors&&s!==o?(this.targetFloorId||(this.targetFloorId=s,this.targetHitPoint.copy(i.point)),!o&&(this.changeFloorIfNeeded(),!0)):this.floorsViewData.roomSelectModeActive||this.floorsViewData.floorSelectModeActive?!!this.doubleClickToEnter||this.roomNavZoom(e,t,i):this.floorsViewData.floorSelectModeActive?(this.cancelTransition=!1,!1):(this.navigation.focus(i.point).then((()=>{this.cancelTransition||this.setFocusSweep(i),this.cancelTransition=!1})),!0)},this.roomNavZoom=(e,t,i)=>!i||(this.cancelTransition=!0,(async()=>{this.doubleClickToEnter||this.hasRoomBounds&&await(0,T.cb)(100),await this.changeFloorPromise,await this.cameraModule.cancelTransition(),await this.navigation.navigateToPanoNearIntersection(i),this.cancelTransition=!1})(),this.commandBinder.issueCommand(new M.X(D.b.DEFAULT)),!0),this.onBackgroundClick=()=>!!this.canStartTransition()&&(!!this.floorsViewData.isMultifloor()&&(!!this.floorsViewData.showAllFloorsOption&&(!this.targetFloorId&&(!!this.cancelTransition||(this.cancelTransition=!0,void this.cameraModule.cancelTransition().then((()=>this.commandBinder.issueCommand(new v.i1(null,!1)))).then((()=>{this.cancelTransition=!1}))))))),this.onFloorChange=()=>{null===this.floorsViewData.currentFloorId&&this.commandBinder.issueCommand(new M.X(D.b.DEFAULT))},this.clearFloorChange=()=>{this.targetFloorId=null},this.changeFloorIfNeeded=async()=>{this.targetFloorId&&(this.changeFloorPromise=this.commandBinder.issueCommand(new v.i1(this.targetFloorId,!1,void 0,this.targetHitPoint)),await this.changeFloorPromise,this.targetFloorId=null,this.changeFloorPromise=null)},this.bindings.push(this.input.registerMeshHandler(p.rX,g.f.is(y.aV),this.onRoomClick,{default:!0}),this.input.registerUnfilteredHandler(p.rX,this.clearFloorChange),this.input.registerHandler(p.rX,this.changeFloorIfNeeded),this.input.registerMeshHandler(p.rX,g.f.isType(f.W),this.onBackgroundClick,{default:!0}),this.floorsViewData.makeFloorChangeSubscription(this.onFloorChange)),l&&this.bindings.push(this.input.registerMeshHandler(p.wR,g.f.is(y.aV),this.roomNavZoom,{default:!0}))}async setFocusSweep(e){if(!this.canStartTransition())return;if(this.cancelTransition)return;const t=(0,b.I9)(this.sweepData,!1,e,this.meshQuery);t.length>0&&t[0].sweep&&await this.commandBinder.issueCommand(new x.HP(t[0].sweep.id))}}var P=i(48071),C=i(44158),A=i(46464),O=i(33518),B=i(44634),F=i(94221),k=i(79105),_=i(35652);const V=new _.Ay("nav-input");class E{constructor(e,t,i){this.navigation=e,this.inputIni=t,this.insideNav=[],this.insideVrNav=[],this.toggleInput=e=>{this.insideNav.forEach((t=>e?t.renew():t.cancel()))},this.toggleVrInput=e=>{this.insideVrNav.forEach((t=>e?t.renew():t.cancel()))},this.registerInsideClickHandlers=e=>[e.registerMeshHandler(p.rX,g.f.is(y.aV),((e,t,i)=>this.tryExecuteAction(((e,t)=>N(e)&&I(t)),((e,t)=>I(t)&&this.navigation.navigateTowardsIntersection(t)),e,i)),{default:!0}),e.registerMeshHandler(p.rX,g.f.isType(f.W),((e,t,i)=>this.tryExecuteAction(((e,t)=>N(e)&&I(t)),((e,t)=>I(t)&&this.navigation.navigateTowardsIntersection(t)),e,i)),{default:!0})],this.registerVrClickHandlers=e=>[e.registerMeshHandler(p.rX,g.f.isInstanceOf(F.r),((e,t,i)=>this.tryExecuteAction(((e,t)=>N(e)&&I(t)),((e,t)=>I(t)&&this.navigation.navigateToPanoNearIntersection(t)),e,i)),{default:!0})],this.registerWheelInput=e=>[e.registerHandler(A.s,(e=>this.tryExecuteAction((e=>!0),(e=>{if(e instanceof A.s){const t=new w.Vector3(0,0,Math.sign(e.delta.y));return!!this.navigation.navigateInLocalDirection(t)}return!1}),e)))],this.hotkeys=e=>[e.registerHandler(O.k,(e=>this.tryExecuteAction((e=>(R(e)||L(e))&&e.key in E.hotkeyDirections),(e=>{if(R(e)){this.continuousMovementHotkey=e.key;const t=E.hotkeyDirections[e.key];this.navigation.setContinuousNavigationLocalDirection(t)}else L(e)&&e.key===this.continuousMovementHotkey&&this.navigation.setContinuousNavigationLocalDirection();return!1}),e)))],this.tryExecuteAction=(e,t,i,s)=>{let o=!1;try{this.navigation.isNavigationInputAllowed()&&e(i,s)&&(o=t(i,s))}catch(e){if(!(e instanceof u))throw V.warn(e),e;V.debug(e)}return o},this.insideVrNav.push(...this.registerVrClickHandlers(this.inputIni)),this.insideNav.push(...this.registerInsideClickHandlers(this.inputIni),...this.hotkeys(this.inputIni)),i&&this.insideNav.push(...this.registerWheelInput(this.inputIni))}get bindings(){return[...this.insideNav,...this.insideVrNav]}}function I(e){return void 0!==e&&void 0!==e.point}function R(e){return e instanceof O.k&&e.state===B.$.DOWN}function L(e){return e instanceof O.k&&e.state===B.$.UP}function N(e){return e instanceof p.rX&&e.button===k.m.PRIMARY}E.hotkeyDirections={[C.D.W]:P.B1.FORWARD,[C.D.A]:P.B1.LEFT,[C.D.S]:P.B1.BACK,[C.D.D]:P.B1.RIGHT,[C.D.UPARROW]:P.B1.FORWARD,[C.D.DOWNARROW]:P.B1.BACK};var U=i(49191),z=i(81866),G=i(48064),H=i(82110),j=i(61287),W=i(92590),Q=i(26956),$=i(90280),q=i(15151);function K(e){if(e&&"object"==typeof e&&"min"in e&&"max"in e){const t=e;if((0,q.Z)(t.min)&&(0,q.Z)(t.max))return!0}return!1}var X=i(55150);function Z(e){if(e&&"object"==typeof e&&"x"in e&&"y"in e){const t=e;return(0,X.Et)(t.x)&&(0,X.Et)(t.y)}return!1}function Y(e){if(e&&"object"==typeof e&&"min"in e&&"max"in e){const t=e;if(Z(t.min)&&Z(t.max))return!0}return!1}var J=i(80461);var ee=i(75673);class te{constructor(e,t,i,s,o){this.canStartTransition=e,this.pose=t,this.cameraData=i,this.cameraModule=s,this.viewmodeData=o,this.focus=this.focus.bind(this),this.focusFloorplan=this.focusFloorplan.bind(this)}async focus(e,t){if(!this.canStartTransition())return;let i,s,o;K(e)?(s=e,i=s.getCenter(new w.Vector3)):Y(e)?(s=new w.Box3,s.min.set(e.min.x,0,e.min.y),s.max.set(e.max.x,0,e.max.y),o=new w.Box2(e.min,e.max),i=s.getCenter(new w.Vector3)):(i=e,s=void 0);const{from:n,transition:r,mode:l}=null!=t?t:{};let{position:h,rotation:c,focalDistance:d}=this.pose;const u=this.pose.pitchFactor()<.01;if(l!==H.N3.Dollhouse||!u&&!1!==(null==t?void 0:t.forceOrtho)||(c=(0,$.MN)(c,-55)),o&&Y(o)||(null==t?void 0:t.forceOrtho)||l===H.N3.Floorplan){if(o||(s&&(o=new w.Box2(new w.Vector2(s.min.x,s.min.z),new w.Vector2(s.max.x,s.max.z))),!s&&i&&(o=new w.Box2(new w.Vector2(i.x-5,i.z-5),new w.Vector2(i.x+5,i.z+5)))),!o)throw new Error("Floorplan mode requires a box or point");return this.focusFloorplan(i,o,l===H.N3.Dollhouse)}n?(h=n,c=(0,$.kf)(h,i)):s?({focalDistance:d,rotation:c,position:h}=this.getPoseForBox({box:s,targetRotation:c})):h=(0,$.fg)(c,i,d);const m={pose:{position:h,rotation:c},transitionType:null!=r?r:a.fl.Interpolate,focalDistance:d,transitionTime:J.U.TRANSITION_TIME_DH,autoOrtho:u};return this.cameraModule.moveTo(m).nativePromise()}async focusFloorplan(e,t,i){i&&await this.cameraModule.moveTo({transitionType:a.fl.OrbitTo,pose:{},autoOrtho:!0,targetPhi:a.mG.Top});const s=function(e,t,i,s){const o=e.pose,n=(new w.Vector3).copy(i());let r=null,a=o.focalDistance;const l=s.min.distanceTo(s.max)/(0,$.ff)(o.position.distanceTo(n),o.projection.asThreeMatrix4(),e.width)/e.screenDiagonalPx,h=l<.2,c=l>1.2,d=(h?.2+.1:1.2-.1)/l;if(t.isFloorplan()&&(n.y=o.position.y,a=o.focalDistance,r=o.projection.clone(),(h||c)&&(r.elements[0]*=d,r.elements[5]*=d)),t.isDollhouse()&&(n.y=o.fovCorrectedPosition().y,a=o.fovCorrectedFocalDistance(),h||c)){const e=o.fovCorrectedFocalDistance()/d,t=o.fovCorrectedPosition().y-o.fovCorrectedFocalDistance()+e;n.y=t,a=e}return{position:n,projection:r,focalDistance:a}}(this.cameraData,this.viewmodeData,(()=>e),t);return this.cameraModule.moveTo({pose:{position:s.position},projection:s.projection?s.projection:void 0,transitionType:a.fl.Interpolate,transitionTime:J.U.TRANSITION_TIME_ROOM,autoOrtho:this.cameraData.pose.autoOrtho,focalDistance:s.focalDistance}).nativePromise()}getPoseForBox({box:e,targetRotation:t}){let i=this.pose;i.pitchFactor()<.01&&(i=i.clone(),i.unapplyPhiBasedFovSquish(),i.resetProjMatrix());const s=t||i.rotation,o=35*ee.fy;(0,$.nk)(s,o);const n=i.aspect(),r=e.getCenter(new w.Vector3),a={targetPosition:r,targetRotation:s.clone(),angleDown:undefined,box:e,fovY:i.fovY(),aspectRatio:n},l=(0,$.hm)(a),h=r.distanceTo(l.position);return{position:l.position,rotation:l.rotation,focalDistance:h}}}var ie=i(88696),se=i(57762),oe=i(76735),ne=i(39591),re=i(79760);const ae=!0,le=8,he=.1,ce=-25,de=500,ue=-2,me=32,pe=32;class ge{constructor(e,t,i,s,o){this.cameraData=e,this.sweepData=t,this.viewmodeModule=i,this.picking=s,this.issueCommand=o,this.tryNavigateToPoint=async(e,t,i,s,o,n,r)=>{const l=r?r.slice():[],h=n?n.slice():[];if(l.push(ie.Zx()),l.push(ie.Ol()),h.push(this.scoreByLatitude(e,me)),t===a.fl.Interpolate&&(0,H.nI)(this.viewmodeModule.currentMode)&&this.sweepData.currentSweep){const t=this.sweepData.currentSweep,i=this.sweepData.getSweep(t),s=i.position.clone().sub(e).normalize();l.push(ie.f(i)),h.push(se.oW(e,s))}l.push(this.withinLatitudeFilter(e)),l.push(this.notTooCloseFilter(e)),ae||l.push(this.notTooFarFilter(e)),h.push(se.d$(e,ue));const d=this.sweepData.sortByScore(l,h),u=this.sweepData.currentSweepObject,m=new w.Vector3;let p=null,g=!1,f=null;const y=(0,H.nI)(this.viewmodeModule.currentMode),v=null!=o?o:15,b=y&&u?new Set(u.neighbours.filter((e=>this.sweepData.getSweep(e).position.distanceTo(u.position)<v)).concat([u.id])):new Set;for(const o of d)if(this.sweepCanSeeNote(e,o.sweep)){if(f=o.sweep,t===a.fl.Interpolate||b.has(f.id)){m.copy(e).sub(f.position).normalize(),g=!0;const o=this.getSweepToPointRotation(f.position,e,s),n=this.cameraData.pose.projection.asThreeMatrix4(),{width:r,height:l}=this.cameraData,h=(0,ne.bA)(e,f.position,o,r,l,n);i&&i(h),p=y?this.issueCommand(new c.aj({transition:a.fl.Interpolate,sweep:f.id,rotation:o})):this.viewmodeModule.switchToMode(H.N3.Panorama,t,{rotation:o,sweepID:f.id})}break}return!(!f||!g&&t===a.fl.Interpolate)&&(p||(p=this.issueCommand(new c.aj({transition:t,transitionTime:de,sweep:f.id,rotation:this.getSweepToPointRotation(f.position,e,s)}))),p&&await p,!0)},this.getSweepToPointRotation=(e,t,i)=>{const s=(0,$.kf)(e,t);return i&&s.multiply(i),(0,oe.V5)(s)},this.sweepCanSeeNote=(()=>{const e=new w.Vector3;return(t,i)=>{e.copy(t).sub(i.position);const s=e.length();e.normalize();let o=this.picking.pick(i.position,e,y.aV);return(!o||o.distance>s)&&(o=this.picking.pick(t,e.negate(),y.aV)),!o||s<=o.distance}})(),this.notTooCloseFilter=e=>t=>Math.abs(t.position.x-e.x)>he||Math.abs(t.position.z-e.z)>he,this.notTooFarFilter=e=>t=>t.position.distanceTo(e)>le,this.withinLatitudeFilter=e=>t=>{const i=(new w.Vector3).copy(e).sub(t.position),s=-Math.atan(i.y/Math.sqrt(i.x*i.x+i.z*i.z)),o=(0,ee.pu)(ce);return re.ol-o<s&&s<re.vc+o},this.scoreByLatitude=(()=>{const e=new w.Vector3;return(t,i)=>s=>{e.copy(t).sub(s.position);const o=Math.abs(Math.atan(e.y/Math.sqrt(e.x*e.x+e.z*e.z)))/(Math.PI/2),n=Math.floor(20*o)/20;return i*(1-n)}})(),this.scoreByDirection=(()=>{const e=new w.Vector3,t=new w.Vector3;return(i,s,o)=>n=>{if(Math.abs(s.dot(P.B1.UP))>.75)return 0;t.copy(s).normalize(),e.copy(i).sub(n.position).normalize();return-1*e.dot(t)*o}})(),this.scoreByFloor=(e,t)=>i=>i.floorId===e?t:0}async focusPin(e,t,i,s,o){const{anchorPosition:n,stemNormal:r,stemLength:a}=e,l=n.clone().add(r.clone().setLength(a)),h=[this.scoreByDirection(l,r,pe),this.scoreByFloor(e.floorId,32)];return this.focusPoint(l,t,i,s,o,h)}focus(e,t){var i;let s;if(K(e))s=e.getCenter(new w.Vector3);else if(Y(e)){const t=e.getCenter(new w.Vector2);s=new w.Vector3(t.x,0,t.y)}else s=e;return this.focusPoint(s,null!==(i=null==t?void 0:t.transition)&&void 0!==i?i:a.fl.Interpolate,void 0,void 0,void 0,(null==t?void 0:t.from)?[se.d$(null==t?void 0:t.from,100)]:[],[ie.Pi(s,.25)])}async focusPoint(e,t,i,s,o,n,r){if(this.cameraData.canTransition()&&this.sweepData.canTransition()&&!await this.tryNavigateToPoint(e,t,i,s,o,n,r)){if(t!==a.fl.Interpolate)return this.goToNearestSweep(e,t,i,s);try{await this.issueCommand(new z.S2(z.w5.DOLLHOUSE,a.fl.Interpolate))}catch(o){await this.goToNearestSweep(e,t,i,s)}await this.tryNavigateToPoint(e,t,i,s,o,n,r)||await this.goToNearestSweep(e,t,i,s)}}async goToNearestSweep(e,t,i,s){const o=e,n=this.sweepData.getClosestSweep(o,!0);if(!n)throw new Error("Cannot find sweep closest to Mattertag disc");const r=this.getSweepToPointRotation(n.position,o,s),l=this.cameraData.pose.projection.asThreeMatrix4(),{width:h,height:d}=this.cameraData,u=(0,ne.bA)(o,n.position,r,h,d,l);i&&i(u),await this.issueCommand(new c.aj({sweep:n.id,rotation:r,transition:t||a.fl.Interpolate}))}}var fe=i(24009),ye=i(61693);class we extends ye.v{get active(){return this._active}get currentValue(){return this._value}get endValue(){return this._endValue}get speed(){return this._speed}get isSlowingDown(){return this._isSlowingDown}get maxSpeed(){return this._maxSpeed}get acceleration(){return this._acceleration}getProgressPercent(){return(this._value-this._startValue)/(this._endValue-this._startValue)}onComplete(e){return this._onComplete=e,this}setStartValue(e){return this._startValue=e,this}setCurrentValue(e){return this._value=e,this}setEndValue(e){return this._endValue=e,this}setInitialSpeed(e){return this._initialSpeed=e,this}setMaxSpeed(e){return this._maxSpeed=e,this}setDesiredAcceleration(e){return this._desiredAcceleration=e,this._jerk=3*Math.abs(this._desiredAcceleration-this._acceleration),this}activate(e){return this._active=e,this}setAccel(e){return this._acceleration=Math.abs(e),this}start(){this._active=!0,this._value=this._startValue,this._speed=this._initialSpeed}setSlowdown(e){return this._slowdown=e,this}constructor(e=1,t=0){super(),this._slowdown=!0,this._initialSpeed=0,this._speed=0,this._acceleration=1,this._desiredAcceleration=1,this._jerk=1,this._maxSpeed=1,this._minSpeed=.05,this._startValue=0,this._value=0,this._endValue=e,this._delay=t}tick(e){if(!this._active||e<=0)return;if(this._delay>0)return void(this._delay-=e);e>33&&(e=33);const t=.001*e,i=this._value,s=this._speed*t,o=(0,oe.cP)(i,this.endValue,s),n=this._endValue-i<=this.getSlowdownDistance(),r=this._slowdown&&n,a=r?this._minSpeed:this._maxSpeed,l=this.acceleration*t;this._speed=(0,oe.cP)(this._speed,a,l),this._isSlowingDown=r;const h=this._desiredAcceleration,c=this._jerk*t;return this._acceleration=(0,oe.cP)(this._acceleration,h,c),this._value=o,o===this.endValue?(this.activate(!1),this.commit(),void(this._onComplete&&this._onComplete())):void 0}getSlowdownDistance(){const e=this.speed,t=this._acceleration,i=e/(0===t?1e-5:t);return this.speed*i+.5*t*i*i}stop(e){this._active=!1,this._endValue=e,this.commit()}}var ve=i(71294),be=i(60052),xe=i(6650);const Me=new _.Ay("walk");class De{get isActive(){return this.active}get targetSweep(){return this.nextSweep}constructor(e,t,i,s,o,n,r){this.cameraPose=e,this.sweepTransition=t,this.sweepControl=i,this.cameraControl=s,this.generators=o,this.navigation=n,this.active=!1,this.path=[],this.lastQueueTime=0,this.repeatedQueueDelayMS=150,this.positionTracker=(new we).setAccel(15).setMaxSpeed(5),this.baseTransitionTime=l.Ay.camera.baseTransitionTime,this.baseTransitionSpeed=l.Ay.camera.transitionSpeed,r.onPropertyChanged(be.baseTransitionSpeedKey,(e=>{this.baseTransitionTime=e}))}setContinuousMovementDirection(e){this.continuousMovementDirection=e,!this.active&&e&&this.navigation.navigateInLocalDirection(e)}stop(){this.path.length=0,this.cameraControl.endExternalTransition(),this.nextSweep=void 0,this.active=!1,this.generator&&(this.generators.stopGenerator(this.generator),this.generator=null)}appendNode(e,t){if(!this.canQueueSweeps(e))return Promise.resolve();if(!e)return Promise.resolve();if(this.path.push(e),this.lastQueueTime=Date.now(),!this.active){this.active=!0;const{generator:t,deferred:i}=this.createTransition();this.generators.startGenerator(t),this.generator=t,this.activePromise=i.nativePromise().then((()=>{this.activePromise=null})),this.positionTracker.setEndValue(this.getDistanceToSweep(e)),this.checkForSpeedIncrease(e)}return this.activePromise?this.activePromise:Promise.resolve()}canQueueSweeps(e){if(e&&this.path.indexOf(e)>=0)return!1;return!(this.path.length>=2)&&!(this.active&&Date.now()-this.lastQueueTime<this.repeatedQueueDelayMS)}attemptContinuousNavigation(){try{this.continuousMovementDirection&&this.navigation.navigateInLocalDirection(this.continuousMovementDirection)}catch(e){if(!(e instanceof u||e instanceof xe.d))throw Me.warn(e),e;Me.debug(e)}}createTransition(){const e=this,t=new ve.i;return{generator:function*(){let i=Date.now();e.cameraControl.beginExternalTransition();const s=(new w.Vector3).copy(e.cameraPose.position),o=new w.Vector3,n=new w.Vector3,r=e.positionTracker;for(r.setMaxSpeed(5).setAccel(15);e.path.length>0;){const t=e.path.shift();if(!t){e.nextSweep=void 0;break}e.nextSweep=t,s.copy(e.cameraPose.position);const a=s.distanceTo(t.position);for(r.setStartValue(0).setEndValue(a).setInitialSpeed(r.speed).activate(!0),n.subVectors(t.position,s),n.normalize(),yield new fe.sv(e.sweepControl.activateSweepUnsafe({sweepId:t.id}).then((()=>{e.sweepControl.beginSweepTransition({sweepId:t.id,internalProgress:!1})}))),r.start(),e.checkForSpeedIncrease(t);r.active;){const a=Date.now()-i,l=0===e.path.length;let h=!1,c=!1;if(!l){const i=e.path[0];h=r.endValue-r.currentValue+t.position.distanceTo(i.position)<r.getSlowdownDistance();const s=o.subVectors(i.position,t.position);s.normalize();n.dot(s)<.3&&(c=!0)}r.setSlowdown(l||h||c),r.tick(a);const d=r.getProgressPercent();e.cameraControl.updateCameraPosition(o.lerpVectors(s,t.position,d)),e.sweepTransition.progress.modifyAnimation(d,1,0),i=Date.now(),e.continuousMovementDirection&&e.canQueueSweeps()&&r.isSlowingDown&&e.attemptContinuousNavigation(),r.active&&(yield new fe.oN)}e.sweepControl.endSweepTransition({sweepId:t.id})}t.resolve(),e.stop()},deferred:t}}getDistanceToSweep(e){return(this.nextSweep?this.nextSweep.position:this.cameraPose.position).distanceTo(e.position)}checkForSpeedIncrease(e){const t=this.positionTracker,i=this.getDistanceToSweep(e),s=t.endValue-t.currentValue,o=s+i-t.getSlowdownDistance();if(s+i>12){const e=this.baseTransitionTime,i=this.baseTransitionSpeed,s=.001*(e+Math.log2(1+o)*be.TRANSITION_DISTANCE_MULTIPLIER*i)-t.maxSpeed/t.acceleration,n=o/s;s>0&&t.setMaxSpeed(n).setDesiredAcceleration(3*n)}else t.setMaxSpeed(5).setDesiredAcceleration(15)}}var Te=i(41309),Se=i(521);class Pe{constructor(e,t,i,s,o,n,r){this.engine=e,this.navigation=t,this.settingsData=i,this.cameraData=s,this.cameraModule=o,this.viewmodeData=n,this.toolsData=r,this.defaultSize=(new w.Vector3).fromArray([3,3,3])}async enforceLabelEditorFriendlyViewmode(){var e;let t=!0;await(null===(e=this.cameraData.transition.promise)||void 0===e?void 0:e.nativePromise());const i=this.determineViewmode();if(this.viewmodeData.currentMode!==i)try{await this.engine.commandBinder.issueCommand(new z.S2(i===H.N3.Dollhouse?z.w5.DOLLHOUSE:z.w5.FLOORPLAN,a.fl.Interpolate))}catch(e){t=!1}return t}async navigateToLabel(e){try{const t=this.determineViewmode();return await this.navigation.focus((new w.Box3).setFromCenterAndSize(new w.Vector3(0,1,0).add(e.position),this.defaultSize),{floorId:e.floorId,mode:t}),this.viewmodeData.currentMode===H.N3.Dollhouse||this.viewmodeData.currentMode===H.N3.Floorplan}catch(e){return!1}}determineViewmode(){const e=this.settingsData.tryGetProperty(l.gT,!1),t=this.toolsData.activeToolName===Se.S0.LABELS||this.settingsData.tryGetProperty(Te.Q$.LabelsDollhouse,!0),i=!this.viewmodeData.isDollhouseDisabled()&&t?H.N3.Dollhouse:H.N3.Floorplan,s=this.viewmodeData.currentMode;return e&&(0,ne.aY)(this.cameraData.pose.pitchFactor())?H.N3.Floorplan:s===H.N3.Floorplan||s===H.N3.Dollhouse?s:i}}var Ce=i(93279),Ae=i(83372),Oe=i(53950);var Be=i(76482),Fe=i(13431),ke=i(58838),_e=i(35596);class Ve extends s.n{constructor(){super(...arguments),this.name="navigation",this.navigationRules=[()=>!0],this.navigationEnabled=!0,this.inputOutside=[],this.addNavigationRule=e=>{-1===this.navigationRules.indexOf(e)&&this.navigationRules.push(e)},this.removeNavigationRule=e=>{const t=this.navigationRules.indexOf(e);-1!==t&&this.navigationRules.splice(t,1)},this.isNavigationInputAllowed=()=>{const e=this.navigationRules.reduce(((e,t)=>e&&t()),!0);return!(!this.navigationEnabled||!e)||(this.log.debug("Cannot move while navigation is locked",{blockedByRules:!e,blockedByCommand:!this.navigationEnabled}),!1)}}async init(e,t){const{market:i}=t;this.commandBinder=t.commandBinder,this.bindings.push(this.commandBinder.addBinding(c.Jq,(async()=>this.lockNavigation())),this.commandBinder.addBinding(c.sD,(async()=>this.unlockNavigation())),this.commandBinder.addBinding(c.rH,(async e=>{const{focusPosition:t,transition:i,orientationAdjust:s,onSweepChosen:o,neighborDistanceThreshold:n}=e;return this.navigationPoint.focusPoint(t,i,o,s,n)})),this.commandBinder.addBinding(c.E4,(async e=>{const{pinPosition:t,transition:i,orientationAdjust:s,onSweepChosen:o,neighborDistanceThreshold:n}=e;return this.navigationPoint.focusPin(t,i,o,s,n)})),this.commandBinder.addBinding(c.aj,(e=>this.navigateToSweep(e.sweep,e.rotation,e.transition,e.transitionTime,e.transitionSpeedMultiplier))),this.commandBinder.addBinding(c.UZ,(async({position:e,floorId:t,viewmodeOnly:i})=>i?this.navigationLabel.enforceLabelEditorFriendlyViewmode():!(!e||!t)&&this.navigationLabel.navigateToLabel({position:e,floorId:t}))),this.commandBinder.addBinding(c.Dd,(async({room:e})=>{var t;const i=isNaN(e.floorHeight)?this.floorsViewData.getFloor(null!==(t=e.floorId)&&void 0!==t?t:this.floorsViewData.topFloorId).medianSweepHeight():e.floorHeight;let s=e.getMinCeilingHeight();isNaN(s)&&(s=.1);const o=new w.Box3(new w.Vector3(e.bbox.min.x,i,e.bbox.min.y),new w.Vector3(e.bbox.max.x,i+s,e.bbox.max.y)),n=!this.viewmodeData.isInside()&&this.cameraData.pose.isPitchFactorOrtho.value||this.viewmodeData.isDollhouseDisabled()?H.N3.Floorplan:H.N3.Dollhouse;return this.focus(o,{mode:n,floorId:e.floorId})})),this.commandBinder.addBinding(c.r,(async e=>this.navigateToPose(e.pose)))),[this.settingsData,this.sweepData,this.sweepModule,this.viewmodeData,this.viewmodeModule,this.cameraData,this.cameraModule,this.interactionmodeData,this.meshQuery]=await Promise.all([i.waitForData(o.o),i.waitForData(U.A),t.getModuleBySymbol(n.Wh),i.waitForData(G.X),t.getModuleBySymbol(n.SD),i.waitForData(r.M),t.getModuleBySymbol(n.jh),i.waitForData(h.O),t.getModuleBySymbol(n.PM)]);const[s,a,d,u,m]=await Promise.all([t.getModuleBySymbol(n.sA),i.waitForData(Q.M),i.waitForData(W.X),i.waitForData(ke.L),i.waitForData(_e.zH)]);this.floorsViewData=d,this.navigationPoint=new ge(this.cameraData,this.sweepData,this.viewmodeModule,null==s?void 0:s.picking,t.commandBinder.issueCommand),this.navigationLabel=new Pe(t,this,this.settingsData,this.cameraData,this.cameraModule,this.viewmodeData,a);const p=await t.getModuleBySymbol(n.mL),g=()=>this.isNavigationInputAllowed()&&this.viewmodeData.canStartTransition()&&this.sweepData.canTransition(),f=()=>g()&&(this.viewmodeData.isDollhouse()||this.viewmodeData.isFloorplan()||this.viewmodeData.isOrthographic());this.navigationOutside=new te(f,this.cameraData.pose,this.cameraData,this.cameraModule,this.viewmodeData),this.inputOutside.push(new S(f,t.commandBinder,p,d,this,this.sweepData,this.cameraModule,this.meshQuery,this.settingsData.tryGetProperty(l.gT,!1),(0,Fe.m2)(u,this.settingsData,m.application===_e.lg.WORKSHOP))),this.inputInside=new E(this,p,!!e.enableWheel),this.inputOutside.forEach((e=>this.bindings.push(...e.bindings))),this.bindings.push(...this.inputInside.bindings),this.updateInputBindings(),this.bindings.push(this.viewmodeData.makeModeChangeSubscription((()=>{this.viewmodeData.currentMode!==H.N3.Transition&&this.updateInputBindings()}))),this.navigationWalk=new De(this.cameraData.pose,this.sweepData.transition,this.sweepModule,this.cameraModule,t,this,this.settingsData),t.broadcast(new Ce.sb(Ae.D.Navigation))}updateInputBindings(){const e=this.interactionmodeData.isVR(),t=this.viewmodeData.isInside();this.inputInside.toggleInput(t&&!e),this.inputInside.toggleVrInput(t&&e),this.inputOutside.forEach((e=>e.toggleInput(!t)))}navigateInLocalDirection(e){const t=this.cameraData.pose.rotation;return this.navigateInDirection(e.clone().applyQuaternion(t))}setContinuousNavigationLocalDirection(e){this.navigationWalk.setContinuousMovementDirection(e)}navigateTowardsIntersection(e){try{this.navigateInDirection(e.point.clone().sub(this.cameraData.pose.position))}catch(e){return!1}return!0}navigateToPanoNearIntersection(e){const t=(0,b.I9)(this.sweepData,this.viewmodeData.isInside(),e,this.meshQuery),i=t.length>0?t[0].sweep:this.sweepData.getClosestSweep(e.point,!0),s=(0,l.xl)(this.interactionmodeData.mode);if(this.viewmodeData.isInside()&&i)return this.navigateToSweep(i.id,void 0,s),!0;if(this.viewmodeData.canSwitchViewMode(H.N3.Panorama)){const e=i?i.id:void 0;return this.commandBinder.issueCommand(new z.S2(z.w5.INSIDE,s,{sweepID:e})),!0}return!1}navigateInDirection(e,t){var i;if(!this.viewmodeData.isInside())throw new u(m.InsideOnly);if(!this.sweepData.currentSweep)throw new u(m.InvalidSweep);const s=(0,l.xl)(this.interactionmodeData.mode),o=null===(i=(0,b.LX)(this.sweepData,e,this.navigationWalk.isActive?.65:void 0,this.navigationWalk.isActive?this.navigationWalk.targetSweep:void 0).find((({sweep:e})=>e&&(!t||t(e)))))||void 0===i?void 0:i.sweep;if(o)return this.navigateToSweep(o.id,void 0,s);throw new u(m.NoDestinationFound)}async focus(e,t){var i;if(!(t=Object.assign({mode:this.viewmodeData.currentMode,transition:a.fl.Interpolate},t)).mode||!this.isNavigationInputAllowed())throw new u(m.Locked);let s;if(await(0,Be.L)(this.cameraData,this.viewmodeData),this.cameraData.pose.autoOrtho&&t.mode===H.N3.Floorplan&&(t.forceOrtho=!0),(t.floorId&&t.floorId!==this.floorsViewData.currentFloorId||null===this.floorsViewData.currentFloorId||this.viewmodeData.isInside())&&(this.viewmodeData.isInside()&&this.floorsViewData.transitionToFloorInstant(null),this.commandBinder.issueCommand(new v.i1(t.floorId||this.floorsViewData.getHighestVisibleFloorId(),!0,J.U.TRANSITION_TIME_DH/2))),this.viewmodeData.isInside()){let o;if(K(e))o=e;else if(Y(e)){const s=this.floorsViewData.floors.getFloor(null!==(i=t.floorId)&&void 0!==i?i:this.floorsViewData.getHighestVisibleFloorId()).medianSweepFloorHeight();o=new w.Box3(new w.Vector3(e.min.x,s,e.min.y),new w.Vector3(e.max.x,s,e.max.y))}s=function(e,t){t||(t=(e.currentFloor||e.getFloor(e.bottomFloorId)).boundingBox);const i=t.min.y,s=t.getCenter(new w.Vector3),o=t.max.clone();o.y=i;const n=s.distanceTo(o)/Math.tan(Oe.Bv.fov/2*ee.fy),r=P.YF.DOWNWARD.clone().multiply((new w.Quaternion).setFromAxisAngle(P.B1.RIGHT,45*ee.fy)),a=P.B1.FORWARD.clone().applyQuaternion(r).multiplyScalar(-1*n);return{position:s.clone().add(a),rotation:r}}(this.floorsViewData,o)}try{switch(t.mode){case H.N3.Panorama:await this.navigationPoint.focus(e,t);break;case H.N3.Dollhouse:await this.viewmodeModule.switchToMode(t.mode,t.transition,s),await this.navigationOutside.focus(e,t);break;case H.N3.Floorplan:await this.viewmodeModule.switchToMode(t.mode,t.transition),await this.navigationOutside.focus(e,t);break;default:throw this.log.warn(`navigation.focus: ${t.mode} not implemented yet`),new u(m.InvalidMode)}}catch(i){throw this.log.debug("Unable to set focus",e,t,i),i}}lockNavigation(){this.navigationEnabled=!1,this.log.debug("Navigation input locked")}unlockNavigation(){this.navigationEnabled=!0,this.log.debug("Navigation input unlocked")}async navigateToSweep(e,t,i,s,o){const n=this.settingsData.tryGetProperty(j.zk,a.fl.Interpolate);let r;void 0===i&&(i=n);const l=this.sweepData.currentSweep;if(i===a.fl.Interpolate){const t=!l||this.sweepData.isSweepAligned(l),s=this.sweepData.isSweepAligned(e),o=l!==e,n=!t||!s,r=this.viewmodeData.isInside();o&&n&&r&&(i=a.fl.FadeToBlack)}if(this.viewmodeData.isInside()){const n=void 0===t&&void 0===s&&void 0===o,l=this.cameraData.canTransition()&&this.sweepData.canTransition();if(i===a.fl.Interpolate&&this.sweepData.currentSweep!==e&&n&&(l||this.navigationWalk.isActive)){const t=this.sweepData.getSweep(e);r=this.navigationWalk.appendNode(t,this.sweepData.currentSweep)}else{if(!l)return this.sweepData.currentSweep;r=this.sweepModule.moveToSweep({transitionType:i,sweepId:e,rotation:t,transitionTime:s,transitionSpeedMultiplier:o})}}else r=this.viewmodeModule.switchToMode(H.N3.Panorama,i,{sweepID:e,rotation:t});return await r,this.sweepData.currentSweep}navigateToPose(e){const t={2:z.w5.DOLLHOUSE,3:z.w5.FLOORPLAN},{sweepIndex:i,quaternion:s,mode:o}=e;let{panoId:n,position:r}=e;if(!n&&void 0!==i){const e=this.sweepData.getSweepByIndex(i);e&&(n=e.id)}if(n)this.commandBinder.issueCommand(new c.aj({sweep:n,rotation:s,transition:a.fl.FadeToBlack}));else{if(!(o in t))throw new Error("Unknown navigation link pose: "+JSON.stringify(e));this.commandBinder.issueCommand(new z.S2(t[o],a.fl.Interpolate,{rotation:s,position:r}))}}}},80461:(e,t,i)=>{"use strict";i.d(t,{U:()=>s});const s={longerTransitionMaxDist:10,TRANSITION_TIME_DH:650,TRANSITION_TIME_ROOM:800}},75987:(e,t,i)=>{"use strict";i.d(t,{I9:()=>d,LX:()=>h,VM:()=>l});var s=i(88696),o=i(57762),n=i(80461);if(5602==i.j)var r=i(1803);if(5602==i.j)var a=i(1902);function l(e){return(0,r.Sh)((()=>e(new a.Jq)),(()=>e(new a.sD)),!1)}const h=(e,t,i,s,...o)=>c({sweepData:e,direction:t,directionFactor:i,sourceSweep:s,ignoreSweeps:o}),c=e=>{const{sweepData:t,direction:i,sourceSweep:n,ignoreSweeps:r,directionFactor:a}=e;if(!t.currentSweepObject)return[];const l=n||t.currentSweepObject,h=[s.AU(l),s.Ol(),s.xg(l),s.jW(l.position,i,a)];for(const e of r)h.push(s.AU(e));const c=[o.oW(l.position,i),o.Io(l.position)],d=t.getSweepNeighbours(l);return t.sortByScore(h,c,d)},d=(e,t,i,r)=>{const a=[s.Ol(),s.Zx()],l=[o.d$(i.point)],h=e.currentSweepObject;t&&h&&a.push(s.AU(h),s.lp(h.position,n.U.longerTransitionMaxDist),s.xg(h)),i.face&&a.push(s.DJ(i.point,i.face.normal));const c=r.floorIdFromObject(i.object);c&&l.push(o.k6(c));const d=e.sortByScore(a,l);if(0===d.length){const t=e.getClosestSweep(i.point,!0);d.push({sweep:t,score:0})}return d}},92078:(e,t,i)=>{"use strict";i.d(t,{a:()=>g});var s=i(68909),o=i(78096),n=i(87705),r=i(60840),a=i(76735),l=i(90280),h=i(18007),c=i(71294),d=i(71136),u=i(43998),m=i(48071),p=i(45490);class g extends h.A{constructor(e,t,i,r,a=!1,l=!1,h=!1){super(),this.cameraPoseProxy=e,this.visibleMeshBounds=t,this.allowPhiRotate=l,this.allowAzimutRotate=h,this.targetProjection=new o.k,this.currentOrientation=new s.Quaternion,this.currentPosition=new s.Vector3,this.positionDelta=new s.Vector3,this.angularAccel=new s.Vector2,this.angularVelocity=new s.Vector2,this.linearAccel=new s.Vector2,this.linearVelocity=new s.Vector2,this.zoomAccel=0,this.zoomVelocity=0,this.scale=1,this.maxZoom=0,this.minZoom=n.WU,this.bindings=[],this.aimTarget=new s.Vector3,this.tempAxis=new s.Vector3,this.tempOrientation=new s.Quaternion,this.nextPosition=new s.Vector3,this.nextOrientation=new s.Quaternion,this.currentPose=new p.J(1),this.checkBounds=a,this.bounds=i.clone(),this.boundsCenter=r.clone(),this.setupBounds(),this.transition={active:!1,startTime:0,elapsed:0,duration:0,linearVelocity:new s.Vector2,angularVelocity:new s.Vector2,zoomVelocity:0,easeOut:!1}}start(){this.scale=1,this.bindings.push(this.visibleMeshBounds.onFullBoundsChanged(this.updateZoomLevels)),this.updateZoomLevels()}setPanAcceleration(e,t=!1,i){if(!this.transition.active){t&&this.haltVelocity(e,this.linearVelocity);const s=this.cameraPoseProxy.pose,o=s.projection.elements[0],n=s.projection.elements[5];this.linearAccel.x=void 0!==e.x?e.x/o:this.linearAccel.x,this.linearAccel.y=void 0!==e.y?e.y/n:this.linearAccel.y,void 0!==i&&this.linearAccel.setLength(i)}}setZoomAcceleration(e){this.transition.active||(this.zoomAccel=e)}setOrbitalAcceleration(e,t=!1){this.transition.active||(t&&this.haltVelocity(e,this.angularVelocity),this.angularAccel.x=void 0!==e.x?e.x:this.angularAccel.x,this.angularAccel.y=void 0!==e.y?e.y:this.angularAccel.y)}haltVelocity(e,t){e.x&&t.x&&Math.sign(e.x)!==Math.sign(t.x)&&(t.x=0),e.y&&t.y&&Math.sign(e.y)!==Math.sign(t.y)&&(t.y=0)}startRotateTransition(e,t,i){return t.x*=-1,this.startTransition(e,t.clone().multiplyScalar(n.qD),new s.Vector2,0,i).nativePromise()}startTranslateTransition(e,t,i=!0){return this.startTransition(e,new s.Vector2,t.clone().multiplyScalar(n.qD),0,i).nativePromise()}startZoomTransition(e,t,i){return this.startTransition(e,new s.Vector2,new s.Vector2(0,0),t,i).nativePromise()}startTransition(e,t,i,s,o){const n=new c.i;return this.poseController?(this.transition.active=!0,this.transition.duration=e,this.transition.elapsed=0,this.transition.startTime=Date.now(),this.transition.deferred=n,this.transition.angularVelocity.copy(t),this.transition.linearVelocity.copy(i),this.transition.zoomVelocity=s,this.transition.easeOut=o,this.angularAccel.set(0,0),this.linearAccel.set(0,0),this.zoomAccel=0,this.angularVelocity.copy(t),this.linearVelocity.copy(i),this.zoomVelocity=s,this.poseController.beginExternalTransition(),n.promise()):n.resolve().promise()}stopTransition(){var e;this.transition.active&&(null===(e=this.poseController)||void 0===e||e.endExternalTransition(),this.transition.active=!1),this.transition.deferred&&(this.transition.deferred.resolve(),this.transition.deferred=void 0)}updateTransition(e,t,i,s){let o=1,r=e/n.qD;this.transition.elapsed+=e;const a=this.getTransitionScale(e);if(this.transition.elapsed>=this.transition.duration){o=(this.transition.duration-(this.transition.elapsed-e))/e,r=1}i&&(this.linearVelocity.copy(this.transition.linearVelocity).multiplyScalar(a),this.pan(this.linearVelocity)),s&&(this.zoomVelocity=this.transition.zoomVelocity*a,this.zoom(this.zoomVelocity)),t&&(this.angularVelocity.copy(this.transition.angularVelocity).multiplyScalar(o*r),this.orbit(this.angularVelocity)),this.transition.elapsed>=this.transition.duration&&(this.stop(this.transition.easeOut),this.transition.active=!1)}getTransitionScale(e){if(this.transition.elapsed>=this.transition.duration){return(this.transition.duration-(this.transition.elapsed-e))/e}return e/n.qD}updateDefault(e,t,i,s){const o=e/n.qD;if(i&&(this.linearVelocity.addScaledVector(this.linearAccel,o),this.pan(this.linearVelocity),this.linearVelocity.multiplyScalar(Math.pow(1-n.g1,o))),s&&(this.zoomVelocity=this.zoomVelocity+this.zoomAccel*o,this.zoom(this.zoomVelocity),this.zoomVelocity*=Math.pow(1-n.pz,o),this.angularVelocity.set(0,0),this.angularAccel.set(0,0)),t&&!s){this.angularVelocity.addScaledVector(this.angularAccel,o);const e=1;this.orbit(this.angularVelocity.clone().multiplyScalar(o/e)),this.angularVelocity.multiplyScalar(Math.pow(1-n.g1,o)/e)}}update(e){const t=this.linearAccel.length()>r.A.epsilon||this.linearVelocity.length()>r.A.epsilon,i=Math.abs(this.zoomAccel)>r.A.epsilon||Math.abs(this.zoomVelocity)>r.A.epsilon,s=this.angularAccel.length()>r.A.epsilon||this.angularVelocity.length()>r.A.epsilon;this.transition.active?this.updateTransition(e,s,t,i):this.updateDefault(e,s,t,i)}stopMomentum(){this.transition.active||(this.linearVelocity.set(0,0),this.zoomVelocity=0,this.angularVelocity.set(0,0))}stopAcceleration(){this.transition.active||(this.setPanAcceleration({x:0,y:0}),this.setZoomAcceleration(0),this.setOrbitalAcceleration({x:0,y:0}))}stop(e=!1){this.stopTransition(),this.stopAcceleration(),e||this.stopMomentum(),this.bindings.forEach((e=>e.cancel())),this.bindings.length=0}pan(e){if(!this.poseController)return;const t=this.cameraPoseProxy.pose;this.positionDelta.x=e.x,this.positionDelta.y=e.y,this.positionDelta.z=0,this.positionDelta.applyQuaternion(t.rotation),this.currentPosition.copy(t.position).add(this.positionDelta),this.checkBounds&&!this.insideBounds(this.currentPosition,t.rotation,t.projection)||this.poseController.updateCameraPosition(this.currentPosition)}zoom(e){if(!this.poseController)return;const t=this.cameraPoseProxy.pose;this.targetProjection.copy(t.projection);const i=this.scale*(1-e);if(Math.abs(i-this.scale)>r.A.epsilon){this.targetProjection.elements[0]*=i/this.scale,this.targetProjection.elements[5]*=i/this.scale;const s=(0,l.BN)(this.targetProjection);if(e<0&&s<=this.minZoom||e>0&&s>=this.maxZoom)return;if(this.checkBounds&&!this.insideBounds(t.position,t.rotation,this.targetProjection))return;this.scale=i,this.poseController.updateCameraProjection(this.targetProjection.clone())}}calculateAimTarget(e,t){t.copy(m.B1.FORWARD).applyQuaternion(e.rotation),t.setLength(e.focalDistance)}orbit(e,t=!1){if(!this.poseController)return;this.currentPose.copy(this.cameraPoseProxy.pose);const i=this.cameraPoseProxy.pose,s=i.phi(),o=e,n=Math.PI/2,r=(0,u.qE)(o.y,0-s,n-s);return n-s<1e-5&&r>0&&!(Math.abs(e.x)>0)?(this.angularVelocity.y=0,void(this.angularAccel.y=0)):(this.calculateAimTarget(i,this.aimTarget),this.nextPosition.copy(i.position).sub(this.aimTarget),this.nextOrientation.copy(i.rotation),this.allowPhiRotate&&(this.tempAxis.copy(m.B1.RIGHT),this.tempOrientation.setFromAxisAngle(this.tempAxis.applyQuaternion(i.rotation),-r),this.nextPosition.applyQuaternion(this.tempOrientation),this.nextOrientation.premultiply(this.tempOrientation)),this.allowAzimutRotate&&(this.tempOrientation.setFromAxisAngle(m.B1.UP,o.x),this.nextPosition.applyQuaternion(this.tempOrientation),this.nextOrientation.premultiply(this.tempOrientation)),this.nextPosition=this.nextPosition.add(this.aimTarget),this.nextOrientation.normalize(),this.currentPose.position.copy(this.nextPosition),this.currentPose.rotation.copy(this.nextOrientation),t?this.poseController.moveTo({transitionType:d.fl.Interpolate,pose:{position:this.currentPose.position.clone(),rotation:this.currentPose.rotation.clone()},transitionTime:500}).nativePromise():void this.poseController.updateCameraPose(this.currentPose))}updateZoomLevels(){const e=this.visibleMeshBounds.getFullBounds().getBoundingSphere(new s.Sphere);this.maxZoom=e.radius*n.SO}setupBounds(){this.bounds.min.x=this.adjustBound(this.bounds.min.x,2),this.bounds.min.y=this.adjustBound(this.bounds.min.y,2),this.bounds.min.z=this.adjustBound(this.bounds.min.z,2),this.bounds.max.x=this.adjustBound(this.bounds.max.x,-2),this.bounds.max.y=this.adjustBound(this.bounds.max.y,-2),this.bounds.max.z=this.adjustBound(this.bounds.max.z,-2),this.worldBounds=(new s.Box3).setFromCenterAndSize(this.boundsCenter,new s.Vector3(this.bounds.max.x-this.bounds.min.x,this.bounds.max.y-this.bounds.min.y,this.bounds.max.z-this.bounds.min.z))}insideBounds(e,t,i){return!!(0,a.i0)(e,t,i,this.worldBounds)}adjustBound(e,t){return Math.sign(e+t)===Math.sign(e)?e+t:0}}},14499:(e,t,i)=>{"use strict";i.r(t),i.d(t,{default:()=>D});var s,o=i(68909),n=i(28997),r=i(92078),a=i(87705),l=i(79105),h=i(44158),c=i(44634),d=i(82110),u=i(48094),m=i(3954),p=i(46464),g=i(32981),f=i(85239),y=i(33518),w=i(94325),v=i(76735),b=i(35223),x=i(45018),M=i(66175);!function(e){e[e.NONE=l.O.NONE]="NONE",e[e.PAN=l.O.PRIMARY]="PAN",e[e.ROTATE=l.O.SECONDARY]="ROTATE",e[e.ZOOM=l.O.MIDDLE]="ZOOM"}(s||(s={}));class D extends M.A{constructor(){super(...arguments),this.name="orthographic-controls",this.controlState=s.NONE,this.controlsEngaged=!1,this.movementKeys=new o.Vector2,this.allowRotation=!1,this.resetControlState=()=>{this.controlState=s.NONE}}async init(e,t){const[i,s,o,r,l,h]=await Promise.all([t.market.waitForData(w.U),t.getModuleBySymbol(b.jh),t.getModuleBySymbol(b.X7),t.market.waitForData(x.M),t.market.waitForData(n.o),t.getModuleBySymbol(b.UN)]);this.meshData=i,this.cameraModule=s,this.allowRotation=e.allowRotation,this.modelSize=Math.max(i.extendedSize.length(),1),this.commonControlsModule=o,this.createCameraControls(i,r,l,h),this.registerActiveStateChangeBinding(),t.getModuleBySymbol(b.mL).then((e=>{this.inputBindings.push(e.registerHandler(p.s,(e=>{this.onScrollWheel(e)}))),this.inputBindings.push(e.registerHandler(g.SK,(e=>{this.onDragBegin(e.buttons)}))),this.inputBindings.push(e.registerHandler(g.jF,(e=>{this.controlsEngaged=!0,this.onDrag(e.delta),this.controls.update(a.qD),this.controls.stop()}))),this.inputBindings.push(e.registerHandler(g._w,(e=>{this.controlsEngaged&&(e.timeSinceLastMove<100&&(this.onDrag(e.delta),this.controls.update(a.qD),this.controls.stopAcceleration()),this.onDragEnd(e.delta,e.buttons),this.controlsEngaged=!1)}))),this.inputBindings.push(e.registerHandler(f.l,(e=>{this.controls.setZoomAcceleration(-e.pinchDelta*a.Tv),this.controls.update(a.qD),this.controls.stop()}))),this.inputBindings.push(e.registerHandler(f.g,this.resetControlState)),this.inputBindings.push(e.registerHandler(y.k,(e=>{e.state!==c.$.PRESSED&&this.onKey(e)}))),this.updateInputBindings()})),this.bindings.push(t.subscribe(u.A,(e=>{this.controls.isActive&&this.controls.start()})),t.subscribe(m.A,(e=>{this.controls.isActive&&this.controls.stop()})))}onUpdate(e){this.controls.isActive&&this.controls.update(e)}createCameraControls(e,t,i,s){const o=this.commonControlsModule.cameraPoseProxy;this.controls=new r.a(o,s,e.extendedBounds,e.meshCenter,!0,this.allowRotation,this.allowRotation),this.commonControlsModule.addControls(d.N3.Orthographic,this.controls)}onActiveStateChanged(){super.onActiveStateChanged(),this.resetControlState()}onScrollWheel(e){if(0!==e.delta.y){const t=(0,v.OF)(this.modelSize,1,1500,2,.125);this.controls.setZoomAcceleration(e.delta.y*a.aY/(t*a.mK)),this.controls.update(a.qD),this.controls.setZoomAcceleration(0)}}onDragBegin(e){if(this.controlState===s.NONE){const t=e;this.controlState=t}this.controls.stop()}onDrag(e){switch(this.controlState){case s.PAN:const t=e;this.controls.setPanAcceleration({x:-t.x,y:-t.y});break;case s.ZOOM:0!==e.y&&this.controls.setZoomAcceleration(-e.y);break;case s.ROTATE:this.controls.setOrbitalAcceleration({x:-Math.PI*e.x,y:-Math.PI*e.y})}}onDragEnd(e,t){t&this.controlState||(this.controlState=s.NONE)}onKey(e){const{key:t,state:i}=e,s=i===c.$.DOWN;let o=!1;switch(t){case h.D.A:this.movementKeys.x=s?-1:0,o=!0;break;case h.D.D:this.movementKeys.x=s?1:0,o=!0;break;case h.D.W:this.movementKeys.y=s?1:0,o=!0;break;case h.D.S:this.movementKeys.y=s?-1:0,o=!0;break;case h.D.K:this.controls.setZoomAcceleration(s?a.Dw:0);break;case h.D.I:this.controls.setZoomAcceleration(s?-a.Dw:0);break;case h.D.J:case h.D.LEFTARROW:this.controls.setOrbitalAcceleration({x:s?a.$6:0,y:0},!0);break;case h.D.L:case h.D.RIGHTARROW:this.controls.setOrbitalAcceleration({x:s?-a.$6:0,y:0},!0)}if(o){const e=this.movementKeys;this.controls.setPanAcceleration({x:e.x,y:e.y},!1,a.bI)}}}},79760:(e,t,i)=>{"use strict";i.d(t,{V$:()=>l,g1:()=>a,ol:()=>r,qD:()=>o,vc:()=>n});var s=i(75673);const o=1e3/60,n=(0,s.pu)(70),r=-n,a=.05,l=.1/60},14746:(e,t,i)=>{"use strict";i.r(t),i.d(t,{default:()=>T,lookAccelerationKey:()=>D});var s=i(68909),o=i(48071),n=i(79760),r=i(60840),a=i(43998),l=i(18007),h=i(71294),c=i(71136);class d extends l.A{constructor(e){super(),this.cameraPoseProxy=e,this.lookVelocity=new s.Vector2,this.lookAccel=new s.Vector2,this.tempAxis=new s.Vector3,this.tempOrientation=new s.Quaternion,this.currentOrientation=new s.Quaternion,this.tempEuler=new s.Euler,this.transition={active:!1,startTime:0,elapsed:0,progress:0,duration:0,updateParameters:{},easeOut:!1,externalTransitionActive:!0}}setController(e){return null==e&&this.stop(),super.setController(e)}setLookAcceleration(e,t=!1){this.transition.active||(t&&(e.x&&this.lookVelocity.x&&Math.sign(e.x)!==Math.sign(this.lookVelocity.x)&&(this.lookVelocity.x=0),e.y&&this.lookVelocity.y&&Math.sign(e.y)!==Math.sign(this.lookVelocity.y)&&(this.lookVelocity.y=0)),this.lookAccel.x=void 0!==e.x?e.x:this.lookAccel.x,this.lookAccel.y=void 0!==e.y?e.y:this.lookAccel.y)}async rotateBetweenOrientations(e,t,i,s,o=!1){if(!e)return this.startTransition(s,{startRotation:t,endRotation:i},!1,o).nativePromise();if(this.poseController){const e=this.cameraPoseProxy.pose.clone();return e.rotation.copy(i),this.poseController.moveTo({transitionType:c.fl.FadeToBlack,pose:e,transitionTime:s}).nativePromise()}}startTransition(e,t,i,s=!0){var o;const n=new h.i;if(this.transition.active=!0,this.transition.duration=e,this.transition.elapsed=0,this.transition.startTime=Date.now(),this.transition.deferred=n,this.transition.easeOut=i,this.transition.externalTransitionActive=!s,this.transition.updateParameters=t,this.lookAccel.set(0,0),t.velocity)this.lookVelocity.copy(t.velocity),this.transition.updateParameters.velocity=t.velocity.clone(),this.transition.updateParameters.startRotation=this.transition.updateParameters.endRotation=void 0;else if(this.lookVelocity.set(0,0),!t.startRotation||!t.endRotation)throw new Error("startTransition: must specify velocity or both startRotation & endRotation");return s||null===(o=this.poseController)||void 0===o||o.beginExternalTransition(),n.promise()}stopTransition(){var e;const t=this.transition.active;this.transition.active&&(this.transition.externalTransitionActive&&(null===(e=this.poseController)||void 0===e||e.endExternalTransition()),this.transition.active=!1),this.transition.deferred&&(t&&this.transition.deferred.resolve(),this.transition.deferred=void 0)}updateTransitionForVelocityMovement(e,t){if(this.transition.updateParameters.velocity)if(this.lookVelocity.copy(this.transition.updateParameters.velocity),this.transition.elapsed>=this.transition.duration){const e=this.transition.duration-(this.transition.elapsed-t);this.lookVelocity.multiplyScalar(e/t)}else this.lookVelocity.multiplyScalar(e)}updateTransitionForRotationalMovement(){var e;if(!this.transition.updateParameters.startRotation||!this.transition.updateParameters.endRotation)return;const t=this.transition.updateParameters.startRotation,i=this.transition.updateParameters.endRotation;this.currentOrientation.copy(t).slerp(i,this.transition.progress),null===(e=this.poseController)||void 0===e||e.updateCameraRotation(this.currentOrientation)}updateTransition(e,t){this.transition.elapsed+=t,this.transition.progress=this.transition.elapsed/this.transition.duration,this.transition.updateParameters.velocity?this.updateTransitionForVelocityMovement(e,t):this.updateTransitionForRotationalMovement()}updateCameraParametersForVelocityMovement(){var e;const t=this.cameraPoseProxy.pose;this.tempEuler.setFromQuaternion(t.rotation,"YXZ");const i=this.tempEuler.x,s=(0,a.qE)(this.lookVelocity.y,n.ol-i,n.vc-i);this.tempAxis.copy(o.B1.RIGHT),this.tempOrientation.setFromAxisAngle(this.tempAxis.applyQuaternion(t.rotation),s),this.currentOrientation.copy(t.rotation).premultiply(this.tempOrientation),this.tempOrientation.setFromAxisAngle(o.B1.UP,this.lookVelocity.x),this.currentOrientation.premultiply(this.tempOrientation),t.rotation.equals(this.currentOrientation)||(this.tempOrientation.copy(this.currentOrientation).normalize(),null===(e=this.poseController)||void 0===e||e.updateCameraRotation(this.tempOrientation))}update(e){this.cameraPoseProxy.pose.rotation.equals(this.currentOrientation)||this.currentOrientation.copy(this.cameraPoseProxy.pose.rotation);const t=e/n.qD;this.transition.active?(this.updateTransition(t,e),this.transition.updateParameters.velocity&&this.updateCameraParametersForVelocityMovement(),this.transition.elapsed>=this.transition.duration&&(this.stop(this.transition.easeOut),this.transition.active=!1)):(this.lookAccel.length()>r.A.epsilon||this.lookVelocity.length()>r.A.epsilon)&&(this.lookVelocity.addScaledVector(this.lookAccel,t),this.updateCameraParametersForVelocityMovement(),this.lookVelocity.multiplyScalar(Math.pow(1-n.g1,t)))}stop(e=!1){this.stopTransition(),this.lookAccel.set(0,0),e||this.lookVelocity.set(0,0)}startRotateTransition(e,t,i){return this.beforeStartRotationTransition&&this.beforeStartRotationTransition(),this.startTransition(e,{velocity:t.clone().multiplyScalar(n.qD)},i).nativePromise()}startTranslateTransition(e,t,i=!0){throw new Error("Panning isn't supported in Panorama Controls")}startZoomTransition(e,t,i){throw new Error("Zooming isn't supported in Panorama Controls")}}var u=i(80399),m=i(82110),p=i(79105),g=i(44158),f=i(44634),y=i(32981),w=i(33518),v=i(28997),b=i(35223),x=i(45018),M=i(66175);const D="Rotation speed";class T extends M.A{constructor(){super(...arguments),this.name="panorama-controls",this.controlsEngaged=!1,this.lookAccelerationSpeed=n.V$,this.calcRotationAngle=(()=>{const e=new s.Matrix4,t=new s.Vector3,i=new s.Vector3;return(o,n)=>{e.copy(this.cameraData.pose.projection.asThreeMatrix4()),e.invert(),t.set(o.x-n.x,o.y-n.y,-1).applyMatrix4(e),i.set(o.x,o.y,-1).applyMatrix4(e);const r=Math.sqrt(t.x*t.x+t.z*t.z),a=Math.sqrt(i.x*i.x+i.z*i.z),l=Math.atan2(t.y,r),h=Math.atan2(i.y,a)-l;t.y=0,i.y=0,t.normalize(),i.normalize();const c=Math.acos(t.dot(i));let d=0;return isNaN(c)||(d=c,n.x>0&&(d*=-1)),new s.Vector2(-d,-h)}})()}async init(e,t){const i=await t.getModuleBySymbol(b.X7);this.controls=new d(i.cameraPoseProxy),this.cameraData=await t.market.waitForData(x.M);const s=this.cameraData;this.controls.beforeStartRotationTransition=()=>{s.transition&&s.transition.activeInternal&&s.transition.to.rotation&&(s.transition.to.rotation=void 0)},i.addControls(m.N3.Panorama,this.controls),i.addControls(m.N3.Mesh,this.controls),this.market=t.market,this.registerActiveStateChangeBinding(),t.getModuleBySymbol(b.mL).then((e=>{e.registerHandler(y.SK,(e=>{this.shouldBeActive()&&this.controls.stop()})),e.registerHandler(y.jF,(e=>{this.shouldBeActive()&&e.buttons&p.O.PRIMARY&&(this.controlsEngaged=!0,this.onDrag(e.position,e.delta),this.controls.update(n.qD),this.controls.stop())})),e.registerHandler(y._w,(e=>{this.shouldBeActive()&&this.controlsEngaged&&(e.timeSinceLastMove<100&&!(e.buttons&p.O.PRIMARY)&&(this.onDrag(e.position,e.delta),this.controls.update(n.qD),this.controls.setLookAcceleration({x:0,y:0})),this.controlsEngaged=!1)})),e.registerHandler(w.k,(e=>{this.shouldBeActive()&&this.onKey(e.key,e.state)})),this.updateInputBindings()}))}onUpdate(e){this.shouldBeActive()&&this.controls.update(e)}onDrag(e,t){this.controls.setLookAcceleration(this.calcRotationAngle(e,t))}onKey(e,t){var i,s;const o=null!==(s=null===(i=this.market.tryGetData(v.o))||void 0===i?void 0:i.tryGetProperty(D,null))&&void 0!==s?s:null;this.lookAccelerationSpeed=o?o*(Math.PI/180)/60:this.lookAccelerationSpeed;const n=t===f.$.DOWN;switch(e){case g.D.LEFTARROW:case g.D.J:this.controls.setLookAcceleration({x:n?this.lookAccelerationSpeed:0},!0);break;case g.D.RIGHTARROW:case g.D.L:this.controls.setLookAcceleration({x:n?-this.lookAccelerationSpeed:0},!0);break;case g.D.K:this.controls.setLookAcceleration({y:n?-this.lookAccelerationSpeed:0},!0);break;case g.D.I:this.controls.setLookAcceleration({y:n?this.lookAccelerationSpeed:0},!0)}}shouldBeActive(){var e,t;return null!==(t=!(null===(e=this.market.tryGetData(u.O))||void 0===e?void 0:e.isVR()))&&void 0!==t&&t}}},57252:(e,t,i)=>{"use strict";i.r(t),i.d(t,{default:()=>P});var s=i(23205),o=i(35223),n=i(23847),r=i(68909),a=i(70694),l=i.n(a),h=i(52492),c=i.n(h),d=i(16249),u=i.n(d),m=i(88140),p=i.n(m),g=i(91254),f=i.n(g),y=i(50652),w=i.n(y);const v={circle_projection:new r.ShaderMaterial({uniforms:{textureSampleScale:{value:5},panoTexture:{value:null},borderSize:{value:0},borderColor:{value:new r.Vector4(1,1,1,1)}},depthWrite:!1,depthTest:!0,side:r.DoubleSide,vertexShader:l(),fragmentShader:c()}),equirectangular:new r.ShaderMaterial({uniforms:{cubemap:{value:null},yaw:{value:0}},depthWrite:!1,depthTest:!1,vertexShader:u(),fragmentShader:p()}),compose:new r.ShaderMaterial({uniforms:{mask:{value:null},bg:{value:null}},transparent:!0,vertexShader:f(),fragmentShader:w()})};var b=i(89103),x=i(11116);class M{constructor(e,t){this._renderer=e,this._renderTarget=t}get target(){return this._renderTarget}get width(){return this._renderTarget.width}get height(){return this._renderTarget.height}get bpp(){return 4}readRenderTargetData(e){const t=this._renderTarget.width,i=this._renderTarget.height;return e=e||new Uint8Array(t*i*4),this._renderer.readRenderTargetPixels(this._renderTarget,0,0,t,i,e),e}setSize(e,t){this._renderTarget.setSize(e,t)}dispose(){this._renderTarget.dispose()}}var D=i(46785),T=i(34944);const S=new r.DataTexture(new Uint8Array([255,255,255,255]),1,1);S.needsUpdate=!0;class P extends s.n{constructor(){super(...arguments),this.name="render-to-texture",this.circleProjectionPlane=new b.m((0,T.Wi)(),v.circle_projection),this.equirectProjectionPlane=new b.m((0,T.Wi)(),v.equirectangular),this.composePlane=new b.m((0,T.Wi)(),v.compose),this.cachedSize=new r.Vector2,this.cachedViewport=new r.Vector4,this.cachedViewport2=new r.Vector4,this.debugRenderOffset=0,this.tempColor=new r.Color}async init(e,t){this.engine=t;const i=await t.getModuleBySymbol(o.M7);this.cwfRenderer=i.cwfRenderer,this.renderer=i.threeRenderer,this.camera=new r.PerspectiveCamera,this.orthoCamera=new r.OrthographicCamera(-.5,.5,.5,-.5,0,1),this.camera.layers.mask=n.H.ALL.mask,this.scene=new r.Scene,this.scene.name="rtt",this.scene.matrixWorldAutoUpdate=!1,this.bindings.push(t.commandBinder.addBinding(x.q6,(async()=>new M(this.renderer,this.createRenderTarget2D(0)))),t.commandBinder.addBinding(x.X7,(async e=>{this.renderContext(e.renderTarget.target,e.context)})),t.commandBinder.addBinding(x.Is,(async e=>{this.render(e.renderTarget.target,e.sceneObject,e.camera)})),t.commandBinder.addBinding(x.cl,(async e=>{this.renderEquirectangular(e.texture,e.renderTarget.target,e.heading)})),t.commandBinder.addBinding(x.aD,(async e=>{this.render(e.renderTarget,e.sceneObject,e.camera)})))}getRenderSize(){const e=this.renderer.getPixelRatio(),t=this.renderer.getSize(this.cachedSize);return t.width*=e,t.height*=e,t}onUpdate(){this.debugRenderOffset=0}createRenderTarget2D(e,t=e,i,s=!0){const o=new r.WebGLRenderTarget(e,t,i);return o.texture.generateMipmaps=s,o}clearRenderTarget2D(e,t,i){const s=this.renderer.getClearColor(this.tempColor),o=this.renderer.getClearAlpha(),n=this.renderer.getRenderTarget();this.renderer.setRenderTarget(e),t&&this.renderer.setClearColor(t),null!=i&&this.renderer.setClearAlpha(i),this.renderer.clear(),this.renderer.setRenderTarget(n),t&&this.renderer.setClearColor(s),null!=i&&this.renderer.setClearAlpha(o)}disposeRenderTarget2D(e){e.texture.dispose(),e.depthTexture&&e.depthTexture.dispose(),e.dispose()}getRenderTargetData(e,t){const i=e.width,s=e.height;return t=t||new Uint8Array(i*s*4),this.renderer.readRenderTargetPixels(e,0,0,i,s,t),t}compose(e,t,i){var s;const o=Object.assign({sourceMask:S,sourceResize:!0,sourceScale:1},i),{uniforms:n}=this.composePlane.material;n.bg.value=this.isRenderTarget(t)?t.texture:t,n.mask.value=this.isRenderTarget(o.sourceMask)?o.sourceMask.texture:o.sourceMask,this.scene.add(this.composePlane);const{z:a,w:l}=null!==(s=null==e?void 0:e.viewport)&&void 0!==s?s:this.renderer.getViewport(new r.Vector4),h=n.bg.value.image.width,c=n.bg.value.image.height,d=!o.sourceResize&&(a!==h||l!==c);if(d){const e=new r.Vector3(o.sourceScale*h/a,o.sourceScale*c/l,1),t=.01,i=new r.Vector3(.5-t-.5*e.x,-.5+t+.5*e.y,0);this.composePlane.applyMatrix4((new r.Matrix4).compose(i,new r.Quaternion,e)),this.composePlane.updateMatrixWorld()}this.overrideRenderTarget(e,(()=>{this.renderer.render(this.scene,this.orthoCamera)})),this.scene.remove(this.composePlane),d&&(this.composePlane.position.set(0,0,0),this.composePlane.scale.set(1,1,1),this.composePlane.updateMatrixWorld()),n.bg.value=null,n.mask.value=null}copyTexture(e,t){return this.compose(e,t)}resizeTexture(e,t){const i=new r.WebGLRenderTarget(t,t);return e.isCompressedTexture?i.texture.format=r.RGBAFormat:i.texture.format=e.format,i.texture.addEventListener("dispose",i.dispose.bind(i)),this.copyTexture(i,e),i.texture}renderToScreen(e,t=!0,i,s){(t?Promise.resolve():this.engine.after(D.R.Render)).then((()=>{const t=this.isRenderTarget(e)?e.width:e.image.width,o=this.isRenderTarget(e)?e.height:e.image.height,n=i?i.x:this.debugRenderOffset,r=i?i.y:60;this.renderer.getViewport(this.cachedViewport),this.renderer.setViewport(n,r,t,o),this.compose(null,e,s?{sourceMask:s}:void 0),this.renderer.setViewport(this.cachedViewport),i||(this.debugRenderOffset+=t+4)}))}isRenderTarget(e){return e.isRenderTarget}renderContext(e,t){e.texture.image=t.canvas,e.texture.needsUpdate=!0}render(e,t,i,s,o=!0){const n=t.parent;if(n&&this.scene.applyMatrix4(n.matrixWorld),this.scene.add(t),e.isWebGLCubeRenderTarget){const t=new r.CubeCamera(.01,1e3,e);i.getWorldPosition(t.position),i.getWorldQuaternion(t.quaternion),this.scene.add(t),this.scene.updateMatrixWorld(),t.layers.mask=s?s.mask:i.layers.mask,t.update(this.renderer,this.scene),this.scene.remove(t)}else{i.getWorldPosition(this.camera.position),i.getWorldQuaternion(this.camera.quaternion),this.camera.projectionMatrix.copy(i.projectionMatrix),this.camera.layers.mask=s?s.mask:i.layers.mask;const t=this.renderer.getSize(this.cachedSize),n=t.width/t.height,r=e.width/e.height,a=this.camera.projectionMatrix;n>r?a.elements[0]=a.elements[5]/r:a.elements[5]=a.elements[0]*r,this.overrideRenderTarget(e,(()=>{o&&this.renderer.clear(),this.renderer.render(this.scene,this.camera)}))}return n&&(n.add(t),this.scene.matrixWorld.identity()),this.scene.remove(t),e}setScissors(e,t){if(e){if(!t)throw Error("Rect to restrict rendering to required when enabling scissors.");this.renderer.setScissorTest(!0),this.renderer.setScissor(t.x,t.y,t.width,t.height)}else{const e=this.renderer.getSize(this.cachedSize);this.renderer.setScissor(0,0,e.width,e.height),this.renderer.setScissorTest(!1)}}renderSphericalProjection(e,t,i,s,o){const n=v.circle_projection;n.uniforms.borderColor.value.copy(o||new r.Vector4(1,1,1,1)),n.uniforms.borderSize.value=s||0,n.uniforms.textureSampleScale.value=i||5,n.uniforms.panoTexture.value=e,this.scene.add(this.circleProjectionPlane),this.circleProjectionPlane.position.z=0,this.overrideRenderTarget(t,(()=>{this.renderer.render(this.scene,this.orthoCamera)})),this.scene.remove(this.circleProjectionPlane),n.uniforms.panoTexture.value=null}renderEquirectangular(e,t,i=0){const s=this.equirectProjectionPlane.material;s.uniforms.cubemap.value=e,s.uniforms.yaw.value=i,this.scene.add(this.equirectProjectionPlane),this.equirectProjectionPlane.position.z=0,this.overrideRenderTarget(t,(()=>{this.renderer.render(this.scene,this.orthoCamera)})),this.scene.remove(this.equirectProjectionPlane),s.uniforms.cubemap.value=null,s.uniforms.yaw.value=0}overrideRenderTarget(e,t){const i=this.renderTargetSwap(e);t(),this.renderTargetRestore(i)}renderTargetSwap(e){const t=this.renderer.xr.enabled,i=this.renderer.getRenderTarget(),s=this.renderer.getViewport(this.cachedViewport2);return this.renderer.xr.enabled=!1,this.renderer.setRenderTarget(e),{xr:t,rtt:i,viewport:s}}renderTargetRestore(e){this.renderer.xr.enabled=e.xr,this.renderer.setRenderTarget(e.rtt),this.renderer.setViewport(e.viewport)}async readFloatPixelsAsync(e,t){for(const t of e.textures)if(t.type!==r.FloatType||t.format!==r.RGBAFormat)throw new Error("[Render to Texture]: All Textures in WebGLRenderTarget.textures must be of type: FloatType and format: RGBAFormat");if(e.textures.length!==t.length)throw new Error("[Render To Texture]: WebGLRenderTarget.textures.length should be equal to buffers.length.");const i=t.length;for(let s=0;s<i;s++){if(t[s].length!==e.width*e.height*4)throw new Error(`[Render To Texture]: Not enough space allocated in buffer at index ${s}`)}const s=this.renderTargetSwap(e),o=this.renderer.getContext(),n=[];for(let s=0;s<i;s++){const i=t[s],r=o.createBuffer();if(null==r)throw new Error(`[Render To Texture]: glCreateBuffer failed at index ${s}`);n.push(r),o.bindBuffer(o.PIXEL_PACK_BUFFER,r),o.bufferData(o.PIXEL_PACK_BUFFER,i.byteLength,o.STREAM_READ),o.readBuffer(o.COLOR_ATTACHMENT0+s),o.readPixels(0,0,e.width,e.height,o.RGBA,o.FLOAT,0)}this.renderTargetRestore(s);const a=o.fenceSync(o.SYNC_GPU_COMMANDS_COMPLETE,0);a&&(o.flush(),await this.waitUntilSync(a,4));for(let e=0;e<i;e++){const i=n[e];o.bindBuffer(o.PIXEL_PACK_BUFFER,i),o.getBufferSubData(o.PIXEL_PACK_BUFFER,0,t[e]),o.deleteBuffer(i)}return o.deleteSync(a),t}async waitUntilSync(e,t){const i=this.renderer.getContext();return new Promise((function(s,o){setTimeout((function n(){switch(i.clientWaitSync(e,i.SYNC_FLUSH_COMMANDS_BIT,0)){case i.WAIT_FAILED:o();break;case i.TIMEOUT_EXPIRED:setTimeout(n,t);break;default:s()}}),t)}))}renderAndReadAsync(e,t,i){const s=i.buffer;if(!this.renderer.capabilities.isWebGL2)return this.log.debug("renderAsync call webgl2, falling back to sync render/read"),this.render(e.target,e.mesh,e.camera),Promise.resolve(this.getRenderTargetData(e.target,s));const o=this.renderTargetSwap(e.target),n=this.renderer.getContext(),r=i.webglBuffer||n.createBuffer();if(!r)throw Error("Unable to create pack buffer");return n.bindBuffer(n.PIXEL_PACK_BUFFER,r),n.bufferData(n.PIXEL_PACK_BUFFER,s.byteLength,n.DYNAMIC_READ),e.clear&&this.renderer.clear(),this.renderer.render(e.mesh,e.camera),n.readPixels(t.x,t.y,t.width,t.height,n.RGBA,n.UNSIGNED_BYTE,0),n.bindBuffer(n.PIXEL_PACK_BUFFER,null),this.renderTargetRestore(o),this.cwfRenderer.fence(n).then((()=>(n.bindBuffer(n.PIXEL_PACK_BUFFER,r),n.getBufferSubData(n.PIXEL_PACK_BUFFER,0,s),n.bindBuffer(n.PIXEL_PACK_BUFFER,null),i.webglBuffer||n.deleteBuffer(r),s)))}}},82309:(e,t,i)=>{"use strict";i.d(t,{C:()=>n});var s=i(82856),o=i(33848);function n(e,t,i){const n=e&&e.hasRooms(),r=i?t.getLayer(i):t.getActiveLayer();return r&&r.layerType===s.ku.COMMON_USER_LAYER?!n:!!(0,o.XF)(t.getCurrentView())||!n}},55415:(e,t,i)=>{"use strict";i.d(t,{l:()=>o});var s=i(18268);class o extends s.u{constructor(e){super(),this.payload={roomAssociation:e}}}o.id="REGISTER_ROOM_ASSOCIATION_SOURCE"},29963:(e,t,i)=>{"use strict";i.d(t,{W:()=>s});class s{constructor(e){this.tags=[],e&&Object.assign(this,e)}}},14961:(e,t,i)=>{"use strict";i.r(t),i.d(t,{default:()=>f});var s=i(23205),o=i(77028),n=i(49191),r=i(48064),a=i(31012),l=i(26172),h=i(10657),c=i(35652),d=i(29963);const u=new c.Ay("mds-floor-deserializer");class m{deserialize(e){var t,i,s,o;if(!e||!this.validate(e))return u.debug("Deserialized invalid room data from MDS",e),null;const n=e=>null!==e?e:void 0,r=e.dimensions||{height:null,width:null,depth:null,areaFloor:null},{height:a,width:l,depth:h,areaFloor:c}=r;return new d.W({id:e.id,meshSubgroup:e.meshId||-1,floorId:null!==(i=null===(t=e.floor)||void 0===t?void 0:t.id)&&void 0!==i?i:"",height:n(a),width:n(l),depth:n(h),areaFloor:n(c),tags:null!==(o=null===(s=e.tags)||void 0===s?void 0:s.filter((e=>e)))&&void 0!==o?o:void 0})}validate(e){const t=["id","meshId"].every((t=>t in e)),i=e.floor&&e.floor.id&&"number"==typeof e.floor.meshId;return t&&!!i}}class p extends h.g{constructor(){super(...arguments),this.prefetchKey="data.model.rooms"}async read(e){const t=new m,i={modelId:this.getViewId()};return this.query(l.GetRooms,i,e).then((e=>{var i,s;const o=null===(s=null===(i=null==e?void 0:e.data)||void 0===i?void 0:i.model)||void 0===s?void 0:s.rooms;if(!o||!Array.isArray(o))return null;return o.reduce(((e,i)=>{const s=t.deserialize(i);return s&&(e[s.id]=s),e}),{})}))}}var g=i(61334);class f extends s.n{constructor(){super(...arguments),this.name="room-data",this.visitedRooms={}}async init(e,t){const{baseModelId:i,baseUrl:s}=e,l=await t.market.waitForData(g.P);this.store=new p({context:l.mdsContext,baseUrl:s,readonly:!0,viewId:i});const h=await this.store.read();this.data=new o.q(h||{}),t.market.register(this,o.q,this.data);const c=await t.market.waitForData(r.X),d=this.data.roomCount,u=e=>{const i=c.closestMode;this.visitedRooms[e.id]||(this.visitedRooms[e.id]={visitCount:0}),this.visitedRooms[e.id].visitCount++;const s=this.visitedRooms[e.id].visitCount;t.broadcast(new a.h(e.id,e.meshSubgroup,i,s,d,""))},m=await t.market.waitForData(n.A),f=m.makeSweepChangeSubscription((e=>{if(e){const t=m.getSweep(e);this.data.selected.value=t.roomId,this.data.commit()}})),y=this.data.selected.onChanged((e=>{if(null!==e){const t=this.data.get(e);t&&u(t)}}));this.bindings.push(f,y)}}},31012:(e,t,i)=>{"use strict";i.d(t,{h:()=>o});var s=i(14754);class o extends s.QB{constructor(e,t,i,s,o,n){super(),this.roomId=e,this.meshSubgroup=t,this.viewmode=i,this.visitCount=s,this.roomCount=o,this.roomType=n}}},82873:(e,t,i)=>{"use strict";i.d(t,{m:()=>o});var s=i(18268);class o extends s.u{constructor(e,t,i){super();const s=function*(){return t()}();this.payload={type:e,func:s,maxDelay:i,steps:1}}}o.id="SCHEDULE_TASK_COMMAND"},62770:(e,t,i)=>{"use strict";i.r(t),i.d(t,{default:()=>g});var s=i(33898),o=i(23205),n=i(35652),r=i(83662);function a(e,t){return fetch(e,Object.assign(Object.assign({},t),{credentials:"omit"}))}function l(e,t){const i=e instanceof Request?e.url:e,s=(0,r.v)(i,{});return fetch(e,Object.assign(Object.assign({},t),{headers:Object.assign(Object.assign({},null==t?void 0:t.headers),s)}))}const h=[1/0,Array,ArrayBuffer,Boolean,DataView,Date,Error,EvalError,Float32Array,Float64Array,Function,Int8Array,Int16Array,Int32Array,JSON,Map,Math,NaN,Number,Object,Promise,Proxy,RangeError,ReferenceError,Reflect,RegExp,Set,String,SyntaxError,TypeError,URIError,Uint8Array,Uint8ClampedArray,Uint16Array,Uint32Array,WeakMap,WeakSet,decodeURI,decodeURIComponent,encodeURI,encodeURIComponent,escape,eval,isFinite,isNaN,parseFloat,parseInt,unescape,XMLHttpRequest,Headers,HTMLIFrameElement,Document,HTMLDocument,HTMLCanvasElement,DOMException,URLSearchParams,ResizeObserver];class c{constructor(e,t){this.originalSetFunc=e,this.originalClearFunc=t,this.disposed=!1,this.ids=new Set}setFunc(e,t){if(this.disposed)return-1;const i=this.originalSetFunc((()=>e()),t);return this.ids.add(i),i}clearFunc(e){this.disposed||this.ids.has(e)&&(this.ids.delete(e),this.originalClearFunc(e))}dispose(){if(!this.disposed){this.disposed=!0;for(const e of this.ids)this.originalClearFunc(e);this.ids.clear()}}}var d=i(23893);class u{constructor(e){if(this.values=new Map,e)for(const[t,i]of e)for(const[e,s]of i)this.set(t,e,s)}set(e,t,i){this.getValuesAtKey(e).set(t,i)}delete(e,t){const i=this.values.get(e);null==i||i.delete(t)}removeKey(e){this.values.delete(e)}getValuesAtKey(e){const t=this.values.get(e)||new Map;return this.values.set(e,t),t}valuesPerKey(e){return this.getValuesAtKey(e).size}get(e,t){var i;return null===(i=this.values.get(e))||void 0===i?void 0:i.get(t)}get keys(){return this.values.keys()}hasKey(e){return this.values.has(e)}has(e,t){var i;return!!(null===(i=this.values.get(e))||void 0===i?void 0:i.has(t))}*[Symbol.iterator](){for(const[e,t]of this.values)for(const[i,s]of t)yield[e,i,s]}}const m=function(e){return Object.freeze(e),Object.getOwnPropertyNames(e).forEach((function(t){const i=Object.getOwnPropertyDescriptor(e,t);(null==i?void 0:i.value)&&"object"==typeof i.value&&m(i.value)})),e};class p extends o.n{constructor(){super(...arguments),this.name="SesModule",this.frozen=!1,this.libraryCache=new u}freezeForStrict(){if(!this.frozen){for(const e of h)m(e);this.frozen=!0}}async init(e,t){[this.semver]=await Promise.all([i.e(9589).then(i.t.bind(i,99589,23)).then((e=>e.default)),i.e(9030).then(i.bind(i,57737))]),this.pluginUIData=await t.market.waitForData(d.kR),globalThis.process&&(globalThis.process.on=()=>{})}async makeSecureEnvironment(e,t,i,o,r){const h=new n.Ay(`plugin ${e}`);if(Object.freeze(h),!this.pluginUIData)return this.log.warn("Not creating a secure env due to missing plugin data"),null;if(t.startsWith("http")||t.startsWith("//")&&window.location.href.match(/^https?:/))try{const e=await fetch(t);t=await e.text()}catch(e){return this.log.warn("There was an error retrieving the plugin source."),null}const d=this.pluginUIData.createRoots(e,i),u=e.split(this.pluginUIData.separator)[1],m=this.setupPluginEnv(h,u,o,d),p=new c(((e,t)=>window.setInterval(e,t)),(e=>window.clearInterval(e))),g=new c(((e,t)=>window.setTimeout(e,t)),(e=>window.clearTimeout(e))),f={log:(...e)=>h.info(...e),error:(...e)=>h.error(...e),info:(...e)=>h.info(...e),warn:(...e)=>h.warn(...e),time:e=>h.time(e),timeEnd:e=>h.timeEnd(e)};function y(e,t){return p.setFunc(e,t)}function w(e){return p.clearFunc(e)}function v(e,t){return g.setFunc(e,t)}function b(e){return g.clearFunc(e)}let x={};for(const[e,t]of Object.entries(r||{}))x=Object.assign(Object.assign({},x),await this.loadLibrary(e,t));const M=Object.assign({setInterval:y,clearInterval:w,setTimeout:v,clearTimeout:b,console:f,window:{setInterval:y,clearInterval:w,setTimeout:v,clearTimeout:b,console:f,parent:{postMessage(e,t,i){(0,s.K)(t)?window.parent.postMessage(e,t,i):window.parent.postMessage(e,t)}}}},x),D=Object.assign(Object.assign({},M.window),{HTMLIFrameElement,location:{href:""},document,getComputedStyle:getComputedStyle.bind(globalThis),parent:window.parent}),T=Object.assign(Object.assign(Object.assign({},M),{window:D,HTMLIFrameElement,Document,HTMLDocument,HTMLCanvasElement,DOMException,URLSearchParams,ResizeObserver,Error,Headers,DOMMatrix,DOMMatrixReadOnly,URL,Blob,FileReader,document,navigator:{userAgent:navigator.userAgent,language:navigator.language}}),m);if(i.canFetch){const e=i.canFetchAsUser?l:a;D.fetch=e,T.fetch=e,T.XMLHttpRequest=XMLHttpRequest}if(i.canStoreLocal){let e;for(e of[T,D])e.indexedDB=indexedDB,e.IDBKeyRange=IDBKeyRange,e.IDBTransaction=IDBTransaction,e.IDBDatabase=IDBDatabase,e.IDBObjectStore=IDBObjectStore,e.IDBIndex=IDBIndex,e.IDBCursor=IDBCursor,e.IDBCursorWithValue=IDBCursorWithValue,e.IDBRequest=IDBRequest,e.IDBOpenDBRequest=IDBOpenDBRequest,e.IDBVersionChangeEvent=IDBVersionChangeEvent,e.IDBFactory=IDBFactory}const{strict:S}=i,P=new Compartment(S?M:T);P.evaluate(t,S?void 0:{__evadeImportExpressionTest__:!0,__evadeHtmlCommentTest__:!0});let C=!1;return{compartment:P,overlayElement:this.pluginUIData.overlayRoot,uiRecords:d,dispose:()=>{C||(C=!0,this.pluginUIData.disposeByKey(e),p.dispose(),g.dispose())}}}setupPluginEnv(e,t,i,s){return{overlaySlot:()=>s[d.nT.OVERLAY].getOrCreateShadowRoot()||null,slot:e=>s[e].getOrCreateShadowRoot()||null,notifyEvent(s,o){((s,o)=>{e.debug("dispatching plugin event:",s,o),i.set(t,{name:s,eventData:o})})(s,o)}}}async loadLibrary(e,t){var i;const s=this.libraryCache.get(e,t);if(s)return s;const o=null===(i=this.semver.coerce(t))||void 0===i?void 0:i.raw;if(!o)throw Error(`${t} is an invalid version for ${e}@${t}`);if(p.libraryManifest.hasKey(e)){const i=p.libraryManifest.getValuesAtKey(e);for(const[t,s]of i)if(this.semver.satisfies(o,t)){const i=await s();return this.libraryCache.set(e,t,i),i}throw Error(`${e}@${t} is unsupported. Supported versions are \n\t${[...i.keys()].join("\n\t")}`)}throw Error(`${e} is unsupported as a peer dependency. Include it as a normal dependency to utilize it.`)}}p.libraryManifest=new u([["three",[["0.171",async()=>({THREE:await Promise.resolve().then(i.t.bind(i,68909,23))})]]],["react",[["19",()=>i.e(3287).then(i.bind(i,83287))],["18",()=>i.e(5680).then(i.bind(i,85680))],["17",()=>i.e(8957).then(i.bind(i,48957))]]],["react-dom",[["19",()=>i.e(3287).then(i.bind(i,83287))],["18",()=>i.e(5680).then(i.bind(i,85680))],["17",()=>i.e(8957).then(i.bind(i,48957))]]]]);const g=p},59935:(e,t,i)=>{"use strict";i.d(t,{W:()=>o});var s=i(68909);class o extends s.Mesh{}},92141:(e,t,i)=>{"use strict";i.r(t),i.d(t,{default:()=>M});var s=i(23205),o=i(35223),n=i(68909),r=i(91177),a=i.n(r),l=i(99515),h=i.n(l);const c={sky:{uniforms:{topColor:{value:new n.Vector3(.094,.102,.11)},bottomColor:{value:new n.Vector3(.2,.216,.235)},cameraMatrix:{value:new n.Matrix4},inverseProjectionMatrix:{value:new n.Matrix4},radius:{value:1e4}},vertexShader:a(),fragmentShader:h()}};class d extends n.ShaderMaterial{constructor(e={}){super(Object.assign({fragmentShader:c.sky.fragmentShader,vertexShader:c.sky.vertexShader,uniforms:n.UniformsUtils.clone(c.sky.uniforms),name:"SkyboxMaterial"},e))}}var u=i(23847),m=i(59935),p=i(12183),g=i(53950),f=i(48071);class y{constructor(e,t,i,s,o=u.H.ALL){this.scene=e,this.cameraData=t,this.addToRaycasting=i,this.removeFromRaycasting=s,this.renderLayer=o,this.bindings=[]}init(){const{visualMesh:e,colliderMesh:t}=this.setupSkysphere();this.skyVisual=e,this.material=this.skyVisual.material,this.skyCollider=t}dispose(){this.material.uniforms.pano0Map&&this.material.uniforms.pano0Map.value.dispose(),this.material.uniforms.pano1Map&&this.material.uniforms.pano1Map.value.dispose(),this.material.dispose(),this.skyVisual.geometry.dispose()}activate(e){this.scene.addChild(this.scene.ids.Root,this.skyVisual),this.skyVisual.updateMatrixWorld(!0),this.skyVisual.visible=!0,this.addToRaycasting(this.skyCollider,!1)}deactivate(e){for(const e of this.bindings)e.cancel();this.bindings=[],this.scene.removeChild(this.scene.ids.Root,this.skyVisual),this.scene.removeChild(this.scene.ids.CameraRig,this.skyCollider),this.removeFromRaycasting(this.skyCollider)}updateBackgroundColors(e,t){const i=new n.Color(e),s=new n.Color(t);this.material.uniforms.topColor.value.set(i.r,i.g,i.b),this.material.uniforms.bottomColor.value.set(s.r,s.g,s.b)}beforeRender(){this.skyCollider.position.copy(this.cameraData.pose.position),this.material.uniforms.cameraMatrix.value.compose(this.cameraData.pose.position,this.cameraData.pose.rotation,f.B1.UNIT),this.material.uniforms.inverseProjectionMatrix.value.copy(this.cameraData.pose.projection.asThreeMatrix4()),this.material.uniforms.inverseProjectionMatrix.value.invert()}render(){}setupSkysphere(e){const t=new n.SphereGeometry(1e4,5,5);t.computeBoundingBox();const i=g.Bv.far-10,s=new Float32Array([-1,1,0,-1,-1,0,1,-1,0,1,1,0]),o=new n.BufferGeometry;o.setAttribute("position",new n.Float32BufferAttribute(s,3)),o.setIndex([0,1,2,0,2,3]),e||(e=new d({side:n.FrontSide}));const r=new m.W(o,e);r.layers.mask=this.renderLayer.mask,r.name="Skysphere",r.renderOrder=p.X.boundingSkybox,r.updateMatrixWorld(!0),r.frustumCulled=!1,e.uniforms.radius.value=i,e.depthWrite=!1,e.depthTest=!1;return{visualMesh:r,colliderMesh:new m.W(t,new n.MeshBasicMaterial({opacity:0,depthWrite:!1,side:n.BackSide}))}}}var w=i(28997),v=i(23706),b=i(41309),x=i(45018);class M extends s.n{constructor(){super(...arguments),this.name="skybox-module"}async init(e,t){const[i,s,n,r]=await Promise.all([t.getModuleBySymbol(o.M7),t.market.waitForData(w.o),t.getModuleBySymbol(o.mL),t.market.waitForData(x.M)]),a=t.claimRenderLayer("skybox"),l=i.getScene();this.skybox=new y(l,r,n.registerMesh,n.unregisterMesh,a),t.addComponent(this,this.skybox);const h=s.tryGetProperty(b.Q$.BackgroundColor,v.v.default);this.skybox.updateBackgroundColors(v.t[h].bgPrimary,v.t[h].bgSecondary),this.bindings.push(s.onPropertyChanged(b.Q$.BackgroundColor,(e=>{this.skybox.updateBackgroundColors(v.t[e].bgPrimary,v.t[e].bgSecondary)})))}}},6650:(e,t,i)=>{"use strict";i.d(t,{d:()=>n,m:()=>o});var s=i(66871);class o extends s.d{constructor(e="SweepException"){super(e),this.name="SweepException"}}class n extends o{constructor(e="Tried to start transition while another transition was active"){super(e),this.name="SweepTransitionActiveException"}}},57762:(e,t,i)=>{"use strict";i.d(t,{Io:()=>h,cv:()=>d,d$:()=>l,k6:()=>u,oW:()=>c});var s=i(68909);const o=-1,n=10,r=5,a=-5,l=(e,t=o)=>i=>e.distanceToSquared(i.position)*t,h=(e,t=o)=>i=>e.distanceTo(i.position)*t,c=(e,t,i=n)=>{const o=new s.Vector3;return s=>o.copy(s.position).sub(e).normalize().dot(t)*i},d=(e,t=o)=>i=>e.distanceToSquared(i.floorPosition)*t,u=(e,t=r,i=a)=>s=>e===s.floorId?t:i},5799:(e,t,i)=>{"use strict";i.d(t,{A:()=>o});var s=i(14754);class o extends s.QB{constructor(e,t,i){super(),this.size=e,this.sweepId=t,this.renderTarget=i}}},61770:(e,t,i)=>{"use strict";i.r(t),i.d(t,{default:()=>u});var s=i(23205),o=i(49191),n=i(92812),r=i(58421),a=i(48064),l=i(13438),h=i(92590),c=i(33020),d=i(54522);class u extends s.n{constructor(){super(...arguments),this.name="sweep-viewdata",this.selectionEnabled=!0,this.nonPanoCurrentPuckVisible=!1,this.enableSweepSelection=async e=>{this.selectionEnabled=!0},this.disableSweepSelection=async e=>{this.selectionEnabled=!1},this.toggleCurrentPuck=async e=>{this.nonPanoCurrentPuckVisible=e.visible,this.updateVisibility(this.viewData.data.currentSweep)},this.onSweepSelectCommand=async e=>{this.selectionEnabled&&this.viewData.modifySelectAnimation(e.id,e.selected,e.duration)},this.onSweepHoverCommand=async e=>{this.viewData.modifySelectAnimation(e.id,e.hovered,e.duration)},this.updateVisibility=async e=>{if(this.viewmodeData.isInside()){if(e){const t=this.viewData.getSweep(e).neighbours;this.viewData.atomic((()=>{this.viewData.iterate((e=>{const i=this.viewData.getSweepVisibility(e)&&-1!==t.indexOf(e.id);this.viewData.setVisible(e.id,i)})),this.viewData.setVisible(e,!1)}))}}else this.viewData.atomic((()=>{this.viewData.iterate((e=>{this.viewData.setVisible(e.id,this.floorsViewData.isCurrentOrAllFloors(e.floorId))})),e&&this.viewData.setVisible(e,this.nonPanoCurrentPuckVisible)}))}}async init(e,t){this.data=await t.market.waitForData(o.A),this.viewData=t.market.tryGetData(n.O)||new n.O(this.data),t.market.register(this,n.O,this.viewData),this.bindings.push(t.commandBinder.addBinding(r.S2,this.onSweepSelectCommand),t.commandBinder.addBinding(r.WW,this.onSweepHoverCommand),t.commandBinder.addBinding(r.tA,this.enableSweepSelection),t.commandBinder.addBinding(r._p,this.disableSweepSelection),t.commandBinder.addBinding(r.j3,this.toggleCurrentPuck),t.msgBus.subscribe(d.ap,(()=>this.viewData.updateViewData())),...this.viewData.bindings),this.viewmodeData=await t.market.waitForData(a.X),this.floorsViewData=await t.market.waitForData(h.X),this.bindings.push(this.data.getCollection().onElementsChanged((e=>{if(e.updated&&this.data.currentSweepObject){const t=[...this.data.currentSweepObject.neighbours,this.data.currentSweepObject.id];e.updated.map((([e,t])=>e)).some((e=>t.includes(e)))&&this.updateVisibility(this.data.currentSweep)}e.added&&this.updateVisibility(this.data.currentSweep)})),this.data.onPropertyChanged("currentSweep",this.updateVisibility),t.subscribe(l.P,(()=>this.updateVisibility(this.data.currentSweep))),t.subscribe(c.E5,(()=>this.updateVisibility(this.data.currentSweep))),this.viewmodeData.makeModeChangeSubscription((()=>this.updateVisibility(this.data.currentSweep)))),this.updateVisibility(this.data.currentSweep)}onUpdate(e){this.viewData.updateAnimations(e)}}},55650:(e,t,i)=>{"use strict";i.r(t),i.d(t,{AssetDockedMessage:()=>m.I7,AssetUndockedMessage:()=>m.f1,CloseAndRemoveToolsCommand:()=>u._S,CloseCurrentToolCommand:()=>u.Te,CloseToolCommand:()=>u.u3,CollapseBottomPanelCommand:()=>u.oe,OpenInitialToolCommand:()=>u.M_,OpenPreviousToolCommand:()=>u.kC,OpenToolCommand:()=>u.Wm,PanelCollapseMessage:()=>m.rP,PanelTransitionEndMessage:()=>m._5,RegisterToolsCommand:()=>u.Kw,SetAppBarVisibleMessage:()=>m.k_,ToggleToolCommand:()=>u.yU,ToggleViewingControlsMessage:()=>m.Vk,Tool:()=>A.N,ToolPalette:()=>h.o6,ToolPanelLayout:()=>h.L$,ToolToggleCollapseCommand:()=>u.li,Tools:()=>h.S0,ToolsData:()=>c.M,default:()=>O});var s=i(23205),o=i(35223),n=i(35596);var r=i(45018),a=i(48064),l=i(76482),h=i(521),c=i(26956),d=i(49142),u=i(9321),m=i(59839),p=i(71553),g=i(55649),f=i(52775),y=i(40270),w=i(41234),v=i(68857),b=i(28997),x=i(63438),M=i(23730),D=i(99366),T=i(74435),S=i(64599),P=i(4913);class C extends s.n{constructor(){super(...arguments),this.name="tools-module",this.activeToolDurationMap={},this.bottomPanelHeight=0,this.sidePanelWidth=0,this.sidePanelLeft=0,this.initialUrlToolOpened=!1,this.toolClosing=!1,this.closeAndRemoveTools=async e=>!(e&&!await this.deactivateCurrentTool())&&(this.closeModal(),this.toolsData.setActiveTool(null),this.toolsData.removeAllTools(),!0),this.onAssetDocked=()=>{this.toolsData.assetDocked=!0,this.toolsData.commit()},this.onAssetUndocked=()=>{this.toolsData.assetDocked=!1,this.toolsData.commit()},this.onToggleModal=async e=>{this.toggleModal(e.modal,e.open)},this.closeModal=()=>{this.toolsData.openModal&&this.toggleModal(this.toolsData.openModal,!1)},this.allowToolOrViewChange=async()=>{var e;const t=this.toolsData.getActiveTool();if(!(null===(e=null==t?void 0:t.manager)||void 0===e?void 0:e.hasPendingEdits))return!0;if(await t.manager.hasPendingEdits()){const e={title:D.A.TOOLS.UNSAVED_CHANGES_TITLE,message:D.A.TOOLS.UNSAVED_CHANGES_MESSAGE,cancellable:!0,confirmPhraseKey:D.A.TOOLS.UNSAVED_CHANGES_CONFIRM,cancelPhraseKey:D.A.TOOLS.UNSAVED_CHANGES_CANCEL};return await this.engine.commandBinder.issueCommand(new x.nX(x.YE.DISPLAY,e))===x.$t.CLOSE}return!0},this.toggleTool=async({toolName:e,active:t})=>t?this.openTool(e,!1):this.closeTool(e),this.closeCurrentTool=async()=>!!await this.deactivateCurrentTool()&&(this.toolsData.setActiveTool(null),!0),this.openInitialTool=async()=>{var e;const t=(0,p.X)(this.settingsData,this.initialUrlToolOpened);if(t){const i=this.toolsData.getTool(t);if(i){const s=(0,p.I)(this.settingsData,i);s&&(null===(e=i.manager)||void 0===e?void 0:e.deepLink)?i.manager.deepLink(s):this.engine.commandBinder.issueCommandWhenBound(new u.yU(t,!0))}}this.initialUrlToolOpened=!0},this.openPreviousTool=async()=>{this.toolsData.softOpening=!1,this.toolsData.commit();const e=this.toolsData.previousToolName;if(null===e)return;const t=this.toolsData.getTool(e)||null;null!==t?await this.deactivateCurrentTool(t)&&(await this.activateTool(t),this.toolsData.setActiveTool(e)):this.log.error(`Tool not loaded: ${e}`)},this.updateLayoutSize=()=>{const{toolPanelLayout:e}=this.toolsData;let t=e;const i=this.isSidePanelLayout();switch(e){case h.L$.NORMAL:i||(t=h.L$.NARROW);break;case h.L$.SIDE_PANEL:i||(t=h.L$.BOTTOM_PANEL);break;case h.L$.NARROW:i&&(t=h.L$.NORMAL);break;case h.L$.BOTTOM_PANEL:i&&(t=h.L$.SIDE_PANEL)}t!==e?(this.toolsData.toolPanelLayout=t,this.toolsData.commit()):e===h.L$.BOTTOM_PANEL&&this.adjustCanvasForPanel()},this.handleToolCollapse=async e=>{e!==this.toolsData.toolCollapsed&&(this.toolsData.toolCollapsed=e,this.toolsData.commit(),e||this.toolsData.toolPanelLayout!==h.L$.BOTTOM_PANEL||this.closeModal(),this.engine.broadcast(new m.rP(e)))},this.handleBottomPanelCollapse=async e=>{if(this.toolsData.toolPanelLayout===h.L$.BOTTOM_PANEL)return this.handleToolCollapse(e.collapse)},this.adjustCanvasForPanelActual=async()=>{const{toolPanelLayout:e,toolCollapsed:t,assetDocked:i,openModal:s}=this.toolsData,{sidePanelWidth:o,bottomPanelHeight:n,sidePanelLeft:r}=this,a=this.toolsData.getActiveTool(),l=e===h.L$.SIDE_PANEL,c=a&&l&&!t,u=c&&!!(null==a?void 0:a.panelLeft),m=c?-y._2:0,p=m!==o?m:void 0,g=u?y._2:0,f=g!==r?g:void 0,v=e===h.L$.BOTTOM_PANEL&&!s&&i,b=-Math.floor((this.containerData.size.height-55)*d.P6/100),x=v?b:0,M=x!==n?x:void 0,D=0===p||0===M?0:d.Cp;this.resizeCanvas((0,w.v6)(p,M,f,D)),this.bottomPanelHeight=x,this.sidePanelWidth=m,this.sidePanelLeft=g},this.adjustCanvasForPanel=(0,T.s)(this.adjustCanvasForPanelActual,50),this.resizeCanvas=async e=>{this.engine.commandBinder.issueCommand(new v.E(e))}}async init(e,t){this.engine=t,await t.getModuleBySymbol(o.$c),this.analytics=await t.getModuleBySymbol(o.aF),[this.settingsData,this.appData,this.containerData]=await Promise.all([t.market.waitForData(b.o),t.market.waitForData(n.zH),t.market.waitForData(P.G)]),this.toolsData=new c.M,this.updateLayoutSize(),this.bindings.push(t.commandBinder.addBinding(u.yU,this.toggleTool),t.commandBinder.addBinding(u.kC,this.openPreviousTool),t.commandBinder.addBinding(u.Wm,(async e=>this.openTool(e.toolName,e.softOpening))),t.commandBinder.addBinding(u.M_,this.openInitialTool),t.commandBinder.addBinding(u.u3,(async e=>this.closeTool(e.toolName))),t.commandBinder.addBinding(u.Te,this.closeCurrentTool),t.commandBinder.addBinding(g.X,this.onToggleModal),t.commandBinder.addBinding(g.r,(async()=>this.closeModal())),t.commandBinder.addBinding(u.li,(async e=>{this.handleToolCollapse(e.collapse)})),t.commandBinder.addBinding(u.oe,this.handleBottomPanelCollapse),this.containerData.onPropertyChanged("size",this.updateLayoutSize),t.subscribe(m.I7,this.onAssetDocked),t.subscribe(m.f1,this.onAssetUndocked),this.toolsData.onPropertyChanged("toolPanelLayout",this.adjustCanvasForPanel),this.toolsData.onPropertyChanged("activeToolChanged",this.adjustCanvasForPanel),this.toolsData.onPropertyChanged("toolCollapsed",this.adjustCanvasForPanel),this.toolsData.onPropertyChanged("assetDocked",this.adjustCanvasForPanel),t.commandBinder.addBinding(u._S,(({checkForEdits:e})=>this.closeAndRemoveTools(e))),t.commandBinder.addBinding(u.Kw,(async({tools:e})=>this.registerTools(...e)))),t.commandBinder.issueCommand(new M.SL(this.allowToolOrViewChange)),t.market.register(this,c.M,this.toolsData)}dispose(e){super.dispose(e),this.closeAndRemoveTools(!1),e.market.unregister(this,c.M)}registerTools(...e){e.forEach((e=>{e.featureFlag&&this.bindings.push(this.settingsData.onPropertyChanged(e.featureFlag,(()=>this.updateEnabledTools())))})),this.toolsData.addTool(...e)}closePanel(){this.toolsData.toolPanelLayout=this.isSidePanelLayout()?h.L$.NORMAL:h.L$.NARROW,this.toolsData.commit()}openPanel(e){if(!e.panel)return this.toolsData.toolCollapsed=!!e.panelBar,void this.toolsData.commit();const t=this.isSidePanelLayout();this.toolsData.toolPanelLayout=t?h.L$.SIDE_PANEL:h.L$.BOTTOM_PANEL;const i=!t&&!this.toolsData.softOpening;this.toolsData.toolCollapsed=i,this.toolsData.commit()}toggleModal(e,t){const{openModal:i,toolPanelLayout:s}=this.toolsData;if(t&&i===e||!t&&e!==i)return;const o=e.toLowerCase(),r=this.appData.application===n.lg.WORKSHOP?"workshop_gui":"showcase_gui";this.analytics.track(r,{gui_action:`open_${o}`}),e&&this.analytics.track("modal_shown",{modal:e}),this.toolsData.openModal=t?e:null,this.toolsData.commit(),s===h.L$.BOTTOM_PANEL&&t!==!!i&&this.adjustCanvasForPanel(),this.engine.broadcast(new f.rn(e,t))}async activateTool(e){if(this.toolInit)throw new Error("Current tool has not finished initializing!");this.toolsData.toolChangeInProgress=!0,this.toolsData.commit(),this.closeModal(),this.openPanel(e),e.manager&&(this.toolInit=e.manager.activate(),await this.toolInit,this.toolInit=null),this.toolsData.toolChangeInProgress=!1,this.toolsData.commit(),this.startTrackingTool(e)}async deactivateCurrentTool(e,t=!0){if(this.toolClosing)return!1;this.toolClosing=!0;const i=this.toolsData.getActiveTool();if(!i)return this.toolClosing=!1,!0;if(await this.toolInit,t&&!await this.allowToolOrViewChange())return this.toolClosing=!1,!1;this.engine.broadcast(new f.XR(!0)),i.manager?(this.toolsData.toolChangeInProgress=!0,this.toolsData.commit(),await i.manager.deactivate(),this.toolsData.toolChangeInProgress=!1,this.toolsData.commit(),this.engine.broadcast(new f.XR(!1))):setTimeout(this.engine.broadcast,100,new f.XR(!1)),this.closeModal();const s=this.toolsData.toolPanelLayout===h.L$.BOTTOM_PANEL||this.toolsData.toolPanelLayout===h.L$.NARROW||(null==e?void 0:e.panelLeft)===i.panelLeft;return!(e&&e.panel&&e.panel===i.panel&&s)&&this.closePanel(),this.toolClosing=!1,this.stopTrackingTool(i),!0}async activateToolName(e,t){const{activeToolName:i,toolChangeInProgress:s}=this.toolsData;if(s)return;if(i===e)return this.toolsData.softOpening=t,void this.toolsData.commit();const o=this.toolsData.getTool(e)||null;if(null===o)return void this.log.error(`Tool not loaded: ${e}`);const[n,h]=await Promise.all([this.engine.market.waitForData(r.M),this.engine.market.waitForData(a.X)]);await(0,l.L)(n,h),await this.deactivateCurrentTool(o)&&(await(0,l.L)(n,h),this.toolsData.softOpening=t,this.toolsData.commit(),await this.activateTool(o),this.toolsData.setActiveTool(o.id))}async deactivateToolName(e,t){e===this.toolsData.activeToolName&&await this.deactivateCurrentTool(t)&&this.toolsData.setActiveTool(null)}async openTool(e,t){await this.activateToolName(e,t)}async closeTool(e){await this.deactivateToolName(e)}startTrackingTool(e){this.activeToolDurationMap[e.analytic]=Date.now()}stopTrackingTool(e){const{analytic:t}=e;this.activeToolDurationMap[t]=Date.now()-this.activeToolDurationMap[t];const i={tool:`${t}_session_time`,duration:this.activeToolDurationMap[t]};this.analytics.track("tool_session_time",i)}updateEnabledTools(){const e=this.toolsData.toolsMap;e.atomic((()=>{for(const t of e)if(t.featureFlag){const e=this.settingsData.tryGetProperty(t.featureFlag,!1);t.enabled!==e&&(t.enabled=e,t.commit())}}))}isSidePanelLayout(){return!(0,S.w)(this.containerData.size)}}var A=i(65413);const O=C},28201:(e,t,i)=>{"use strict";i.r(t),i.d(t,{default:()=>P});var s=i(23205),o=i(35223),n=i(28997),r=i(82110),a=i(71136),l=i(94325),h=i(48071),c=i(68909),d=i(90280),u=i(49191),m=i(88696),p=i(57762),g=i(45018),f=i(41309),y=i(1902),w=i(35596),v=i(33020),b=i(76035),x=i(92590),M=i(59072),D=i(81866),T=i(93795),S=i(98780);class P extends s.n{constructor(){super(...arguments),this.name="viewmode-change"}async init(e,t){this.engine=t,this.viewmodesModule=await t.getModuleBySymbol(o.SD),this.bindings.push(t.subscribe(v.E5,(e=>this.setEnabledModes(e.application))),t.commandBinder.addBinding(D.S2,this.onChangeViewmodeCommand.bind(this))),Promise.all([t.market.waitForData(w.zH),t.market.waitForData(n.o)]).then((([t,i])=>{this.settings=i,(0,T.sj)(i,e.inWorkshop),(0,T.cW)(i,e.inWorkshop),this.setEnabledModes(t.application),this.bindings.push(i.onPropertyChanged(f.Q$.FloorPlan,(()=>(0,T.sj)(i,e.inWorkshop))),i.onPropertyChanged(f.Q$.Dollhouse,(()=>(0,T.cW)(i,e.inWorkshop))))}))}async setEnabledModes(e){if(e===w.lg.SHOWCASE){if(this.viewmodesModule.data.isDollhouseDisabled=()=>!this.settings.tryGetProperty(T.n9,!1),this.viewmodesModule.data.isFloorplanDisabled=()=>!this.settings.tryGetProperty(T._z,!1),this.engine.commandBinder.issueCommand(new S.sB({noTransition:!0})),this.previousApp){const e=await this.engine.market.waitForData(g.M),t=this.viewmodesModule.data.peekabooCorrectedMode(e);if(t===r.N3.Dollhouse&&this.viewmodesModule.data.isDollhouseDisabled()||t===r.N3.Floorplan&&this.viewmodesModule.data.isFloorplanDisabled()){const t=(await this.engine.market.waitForData(b.G)).pose;if(t&&(0,r.nI)(t.mode))this.goToInsideMode(a.fl.Interpolate,{position:t.camera.position},t.mode);else{const t=e.pose,i=(await this.engine.market.waitForData(u.A)).getClosestSweep(t.position,!0),s=i?{position:i.position}:void 0;this.goToInsideMode(a.fl.Interpolate,s,r.N3.Panorama)}}}}else e===w.lg.WORKSHOP&&(this.viewmodesModule.data.isDollhouseDisabled=()=>!1,this.viewmodesModule.data.isFloorplanDisabled=()=>!1,this.engine.commandBinder.issueCommand(new S.sB({noTransition:!0})));this.previousApp=e}async onChangeViewmodeCommand(e){try{switch(e.mode){case D.w5.INSIDE:return this.goToInsideMode(e.transitionType,e.pose,r.N3.Panorama,e.transitionTime);case D.w5.DOLLHOUSE:return this.goToDollhouse(e.transitionType,e.pose,e.transitionTime);case D.w5.FLOORPLAN:return this.goToFloorplan(e.transitionType,e.pose,e.transitionTime);case D.w5.ORTHOGRAPHIC:return this.goToOrthographic(e.transitionType,e.pose,e.transitionTime);case D.w5.MESH:return this.goToInsideMode(e.transitionType,e.pose,r.N3.Mesh,e.transitionTime)}}catch(t){throw this.log.error(t),new M.FA(`Could not move to mode ${e.mode}`,t)}}async goToInsideMode(e=a.fl.Interpolate,t={},i,s){const o=this.engine.market.tryGetData(u.A);if(!o)throw new M.dj;if(!(0,r.nI)(i))throw new M.dj;let n=t.sweepID||o.currentSweep;if(n||(n=await this.getLookAtSweep(o)),o.isSweepUnaligned(n)){const e=o.getFirstAlignedSweep();n=e?e.id:this.getFirstSweepId(o)}return(0,r.nI)(this.viewmodesModule.currentMode)&&o.isSweepUnaligned(o.currentSweep)?this.engine.commandBinder.issueCommand(new y.aj({sweep:n,rotation:t.rotation,transition:a.fl.FadeToBlack})):this.viewmodesModule.switchToMode(i,e,{sweepID:n,rotation:t.rotation},s)}async getLookAtSweep(e){const t=this.engine.market.tryGetData(g.M);if(!t)return this.getFirstSweepId(e);const i=this.engine.market.tryGetData(x.X),s=(null==i?void 0:i.getFloorMin())||this.getModelMinHeight(),o=new c.Plane(h.B1.DOWN,s),n=(0,d.qK)(t.pose.position,t.pose.rotation,o);if(!n)return this.getFirstSweepId(e);const r=[m.Zx(),m.Ol(),e=>!i||i.isCurrentOrAllFloors(e.floorId)],a=[p.cv(n)],l=e.sortByScore(r,a).shift();if(l)return l.sweep.id;const u=e.getClosestSweep(n,!0);return u?u.id:this.getFirstSweepId(e)}getFirstSweepId(e){const t=e.getFirstSweep();if(void 0===t)throw new Error("First enabled sweep not found");return t.id}getModelMinHeight(){return this.meshData||(this.meshData=this.engine.market.tryGetData(l.U)),this.meshData?this.meshData.extendedBounds.min.y:0}async goToDollhouse(e=a.fl.Interpolate,t={},i){if(this.viewmodesModule.data.isDollhouseDisabled())throw new M.dj;return this.viewmodesModule.switchToMode(r.N3.Dollhouse,e,t,i)}async goToFloorplan(e=a.fl.Interpolate,t={},i){if(this.viewmodesModule.data.isFloorplanDisabled())throw new M.dj;const s=await this.engine.getModuleBySymbol(o.CE);return s&&await s.getTransitionPromise(),this.viewmodesModule.switchToMode(r.N3.Floorplan,e,t,i,!0)}async goToOrthographic(e=a.fl.Interpolate,t={},i){const s=await this.engine.getModuleBySymbol(o.CE);return s&&await s.getTransitionPromise(),this.viewmodesModule.switchToMode(r.N3.Orthographic,e,t,i)}}},51238:(e,t,i)=>{"use strict";i.d(t,{A:()=>o});var s=i(36827);class o extends s.Y{}},59072:(e,t,i)=>{"use strict";i.d(t,{FA:()=>l,Xy:()=>n,dj:()=>a,ke:()=>r});var s=i(66871);class o extends s.d{constructor(e="Unhandled Viewmode Exception",t){super(e),this.originalError=t,this.name="ViewmodeException"}}class n extends o{constructor(e="Tried to start view-mode transition while another transition was active"){super(e),this.name="ViewmodeActiveTransition"}}class r extends o{constructor(e="Cannot change viewmode when locked"){super(e),this.name="ViewmodeLocked"}}class a extends o{constructor(e="Cannot change to disabled/invalid viewmode"){super(e),this.name="ViewmodeInvalid"}}class l extends o{constructor(e="Unhandled Error processing viewmode change command",t){super(e,t),this.name="ViewmodeCommandException"}}},4143:(e,t,i)=>{"use strict";i.d(t,{_:()=>n,x:()=>o});var s=i(18268);class o extends s.u{constructor(){super()}}o.id="LOCK_VIEWMODE";class n extends s.u{constructor(){super()}}n.id="UNLOCK_VIEWMODE"},77030:(e,t,i)=>{"use strict";i.r(t),i.d(t,{SMALL_ROTATION_DISTANCE:()=>_,SMALL_TRANSLATION_DISTANCE:()=>k,default:()=>L});var s=i(35223),o=i(82110),n=i(71136),r=i(68909),a=i(48071),l=i(53950),h=i(23205),c=i(48064),d=i(45018),u=i(49191),m=i(48094),p=i(3954),g=i(36827),f=i(59072),y=i(71294),w=i(90280),v=i(75673),b=i(39591);const x=(e,t,i,s)=>{const o=i.clone().multiply((new r.Quaternion).setFromAxisAngle(a.B1.RIGHT,60*v.fy)),n=a.B1.FORWARD.clone().applyQuaternion(o).multiplyScalar(-1*e),l=t.clone().add(n);return s.position=l,s.rotation=o,e},M=e=>{const t=e.getCenter(new r.Vector3);return e.max.distanceTo(t)/Math.tan(l.Bv.fov/2*v.fy)};var D=i(53366),T=i(78096),S=i(79953),P=i(74533),C=i(94325),A=i(4143),O=i(28997),B=i(99817),F=i(51238);const k=.2,_=3*v.fy,V=Math.PI/2+Number.EPSILON,E=Math.PI-Number.EPSILON,I=[o.N3.Mesh,o.N3.Panorama,o.N3.Floorplan,o.N3.Dollhouse,o.N3.Orthographic],R={[o.N3.Mesh]:P.Ou,[o.N3.Panorama]:P.Ou,[o.N3.Dollhouse]:P.Ou,[o.N3.Floorplan]:P.Ou,[o.N3.Orthographic]:P.Ou};class L extends h.n{constructor(){super(...arguments),this.name="viewmode",this.data=new c.X,this.minDollhouseDistance=15,this.maxDollhouseDistance=50,this.peekabooActive=!1,this._orthoMatrix=new T.k,this.snapToPhiLimit=(e,t)=>this.cameraModule.moveTo({transitionType:n.fl.OrbitTo,transitionTime:t,pose:{},autoOrtho:!0,targetPhi:e}),this.getFlyinStartPose=(e,t)=>{var i;const s=null!==(i=e.position)&&void 0!==i?i:new r.Vector3,o=t||this.cameraData.pose.position,n=s.y-o.y,l=(0,w.bw)(s,o,this.visibleMeshBounds.getCenterOfMass()),h=a.B1.FORWARD.clone().applyQuaternion(l),c=Math.sign(h.y)*Math.PI/4;return{position:(0,w.fR)(s,o,c,!0).setY(1.5*n)}},this.getFlyinEndPose=async e=>{var t,i;const s=e.position||(null===(i=this.sweepData.getSweep(null!==(t=e.sweepID)&&void 0!==t?t:"invalid"))||void 0===i?void 0:i.position)||new r.Vector3,o=e.rotation||new r.Quaternion,n=Math.PI/180*l.Bv.fov;return await this.visibleMeshBounds.initialDataLoaded,(0,w.hm)({targetPosition:s,targetRotation:o,angleDown:-Math.PI/6,box:this.visibleMeshBounds.getVisibleBounds(),fovY:n,aspectRatio:this.canvas.aspectRatio})}}async init(e,t){var i;this.engine=t,this.market=t.market,this.data.currentMode=null!==(i=e.startingMode)&&void 0!==i?i:o.N3.Dollhouse,this.market.register(this,c.X,this.data),t.market.waitForData(C.U).then((e=>{this.meshData=e,this.setDollhouseBounds()})),t.market.waitForData(O.o).then((e=>{this.peekabooActive=e.tryGetProperty(B.gT,!1),this.bindings.push(e.onPropertyChanged(B.gT,(e=>{this.peekabooActive=e})))})),this.bindings.push(t.commandBinder.addBinding(A.x,this.lockViewmode.bind(this)),t.commandBinder.addBinding(A._,this.unlockViewmode.bind(this)));const[n,r,a,l,h,m]=await Promise.all([t.getModuleBySymbol(s.jh),t.getModuleBySymbol(s.Wh),t.getModuleBySymbol(s.UN),t.market.waitForData(u.A),t.market.waitForData(D.p),t.market.waitForData(d.M)]);this.cameraModule=n,this.sweepModule=r,this.visibleMeshBounds=a,this.sweepData=l,this.canvas=h,this.cameraData=m}lockViewmode(){this.data.viewmodeChangeEnabled=!1,this.data.commit()}unlockViewmode(){this.data.viewmodeChangeEnabled=!0,this.data.commit()}get currentMode(){return this.data.currentMode}async switchToMode(e,t=n.fl.FadeToBlack,i,r,a){if(this.peekabooActive)return this.switchToModePeekaboo(e,t,i,r,a);this.log.debug(`switchToMode mode:${o.N3[e]} type:${n.fl[t]}`);const l=this.isAlreadyInMode(e),h=!i||i&&!L.willPoseChange(this.cameraData,i);if(l&&h)return;if(!I.includes(e)||this.data.isFloorplanDisabled()&&e===o.N3.Floorplan||this.data.isDollhouseDisabled()&&e===o.N3.Dollhouse)throw new f.dj(`Cannot change to invalid viewmode ${e}`);this.meshData||e!==o.N3.Floorplan&&e!==o.N3.Dollhouse||await(await this.engine.getModuleBySymbol(s.GR)).firstMeshLoadPromise;const c=!this.cameraData.canTransition();if(!this.data.canStartTransition()||c)throw new f.Xy;if(e!==this.currentMode&&!this.data.viewmodeChangeEnabled)throw new f.ke;let d=void 0!==r?r:R[e];t===n.fl.Instant&&(d=0),this.sweepData.currentSweep&&this.sweepData.isSweepUnaligned(this.sweepData.currentSweep)&&!(0,o.nI)(e)&&(t=n.fl.FadeToBlack);const u=Object.assign({},this.data.transition),y=this.data.currentMode;let w=!1;const v=t=>{this.data.transition.progress=t,this.data.commit(),t>=.5&&!w&&(w=!0,this.engine.broadcast(new g.Y(e,null!=y?y:void 0)))},b=()=>{this.data.transition.progress=1,this.data.currentMode=e,this.data.deactivateTransition(),this.data.commit(),this.engine.broadcast(new m.A(e,null!=y?y:void 0))};let x;switch((()=>{this.data.activateTransition(this.data.currentMode,e,d),this.data.currentMode=o.N3.Transition,this.data.commit(),this.engine.broadcast(new p.A(e,null!=y?y:void 0))})(),e){case o.N3.Mesh:case o.N3.Panorama:x=this.moveCameraToPanorama(y,t,d,i);break;case o.N3.Dollhouse:this.peekabooActive&&this.cameraData.setAutoOrtho(!0),x=this.moveCameraToDollhouse(t,d,i);break;case o.N3.Floorplan:x=this.moveCameraToFloorplan(null!=y?y:void 0,t,d,i);break;case o.N3.Orthographic:x=this.moveCameraToOrthographic(null!=y?y:void 0,t,d,i);break;default:throw new f.dj(`Invalid target mode ${e}`)}try{x.progress(v),await x.nativePromise(),b()}catch(e){throw this.data.currentMode=y,this.data.transition=u,this.data.commit(),e}}async switchToModePeekaboo(e,t=n.fl.FadeToBlack,i,r,a){this.log.debug(`switchToMode mode:${o.N3[e]} type:${n.fl[t]}`),this.fixHighPhiPose(e,i);const l=!i||i&&!L.willPoseChange(this.cameraData,i);if(this.isAlreadyInMode(e)&&l)return;if(!I.includes(e)||this.data.isFloorplanDisabled()&&e===o.N3.Floorplan||this.data.isDollhouseDisabled()&&e===o.N3.Dollhouse)throw new f.dj(`Cannot change to invalid viewmode ${e}`);this.meshData||e!==o.N3.Floorplan&&e!==o.N3.Dollhouse||await(await this.engine.getModuleBySymbol(s.GR)).firstMeshLoadPromise;const h=!this.cameraData.canTransition();if(!this.data.canStartTransition()||h)throw new f.Xy;if(e!==this.currentMode&&!this.data.viewmodeChangeEnabled)throw new f.ke;this.engine.broadcast(new F.A(e)),this.sweepData.currentSweep&&this.sweepData.isSweepUnaligned(this.sweepData.currentSweep)&&!(0,o.nI)(e)&&(t=n.fl.FadeToBlack);let c=void 0!==r?r:R[e],d=0;t!==n.fl.Instant&&t!==n.fl.FadeToBlack||(t===n.fl.FadeToBlack&&(d=c),c=0);const u=d>0;let w=e;e===o.N3.Floorplan&&(w=o.N3.Dollhouse),u&&(t=n.fl.Instant);const v=Object.assign({},this.data.transition),x=this.data.currentMode,M=()=>{const t=e===o.N3.Floorplan?0:1;this.data.transition.active=!0,this.data.activateTransition(this.data.currentMode,w,c,this.cameraData.pose.pitchFactor(),t),this.data.currentMode=o.N3.Transition,this.data.commit(),this.engine.broadcast(new p.A(w,null!=x?x:void 0))};let D=!1;const T=e=>{this.data.transition.progress=e,this.data.commit(),e>=.5&&!D&&(D=!0,this.engine.broadcast(new g.Y(w,null!=x?x:void 0)))},S=()=>{this.data.transition.active=!1,this.data.transition.progress=1,this.data.currentMode=w,this.data.deactivateTransition(),this.data.commit()},P=async(e,t)=>{if(u){const i=this.cameraModule.moveTo({transitionType:n.fl.FadeToBlack,fadeToBlackSubType:e,pose:{},transitionTime:d/2});i.progress((e=>T(t+e/2))),await i}},C=(0,b.aY)(this.cameraData.pose.pitchFactor()),A=i&&i.position&&i.rotation;let O=!1;const B=x===o.N3.Dollhouse||x===o.N3.Floorplan,k=[];C&&e===o.N3.Dollhouse?(A||(O=!0),k.push((()=>this.snapToPhiLimit(n.mG.Bottom,c)))):!B||e!==o.N3.Floorplan||A||a?C&&B&&(e===o.N3.Panorama||e===o.N3.Mesh)&&k.push((()=>this.snapToPhiLimit(n.mG.Bottom,c))):(A||(O=!0),k.push((()=>this.snapToPhiLimit(n.mG.Top,c))));let _=null,V=!1;if(!O||a){let s=i;switch(e){case o.N3.Mesh:case o.N3.Panorama:_=()=>this.moveCameraToPanorama(x,t,c,i);break;case o.N3.Floorplan:const n=C||0===c;if(s=this.getPeekabooDollhousePoseFromFloorplanPose(i,n),n&&s){this.cameraData.setAutoOrtho(!0),_=()=>s?this.cameraModule.moveTo({transitionType:t,pose:s,transitionTime:c,focalDistance:s.focalDistance,autoOrtho:!0}):y.i.resolve();break}V=!0;case o.N3.Dollhouse:this.cameraData.setAutoOrtho(!0),_=()=>this.moveCameraToDollhouse(t,c,s,V);break;case o.N3.Orthographic:this.cameraData.setAutoOrtho(!1),_=()=>this.moveCameraToOrthographic(null!=x?x:void 0,t,c,i);break;default:throw new f.dj(`Invalid target mode ${e}`)}}_&&k.push(_),(!C&&x!==o.N3.Dollhouse&&e===o.N3.Floorplan||V)&&k.push((()=>this.snapToPhiLimit(n.mG.Top,c)));try{const e=k.length;M(),await P(n.pw.ClearToBlack,0);for(let t=0;t<e;t++){const i=t/e,s=k[t]();u||s.progress((t=>T(t/e+i))),await s}await P(n.pw.BlackToClear,.5),S()}catch(e){throw this.data.currentMode=x,this.data.transition=v,this.data.commit(),e}O||this.engine.broadcast(new m.A(w,null!=x?x:void 0))}isAlreadyInMode(e){const{data:t}=this,i=t.transition.from===t.transition.to;let s=t.currentMode===e;if(this.peekabooActive){const i=t.currentMode===o.N3.Floorplan||t.currentMode===o.N3.Dollhouse;let n=t.currentMode;i&&(n=(0,b.aY)(this.cameraData.pose.pitchFactor())?o.N3.Floorplan:o.N3.Dollhouse),s=n===e}return t.transition.active&&i||s}static willPoseChange(e,t){return void 0!==t.position&&!e.pose.position.equals(t.position)||void 0!==t.rotation&&!e.pose.rotation.equals(t.rotation)||void 0!==t.zoom&&e.zoom()!==t.zoom}moveCameraToPanorama(e,t,i,s){var n,h;let c=null!==(n=null==s?void 0:s.sweepID)&&void 0!==n?n:this.sweepData.currentSweep;c||(c=null===(h=this.sweepData.getFirstSweep())||void 0===h?void 0:h.id);let d=null==s?void 0:s.rotation;if(!d){const t=(e===o.N3.Floorplan?a.B1.UP:a.B1.FORWARD).clone().applyQuaternion(this.cameraData.pose.rotation).setY(0).normalize();d=(new r.Quaternion).setFromUnitVectors(a.B1.FORWARD,t)}const u=(0,l.hn)(this.cameraData.aspect());return this.sweepModule.moveToSweep({transitionType:t,sweepId:c,rotation:d,transitionTime:i,rotationDelay:.5,projection:u})}moveCameraToDollhouse(e,t,i,s=!1){var n;const h=this.visibleMeshBounds.getVisibleBounds(),c=this.visibleMeshBounds.getCenterOfMass(),d={};let u,m=t;if(i&&(i.position||i.rotation)){if(i.position&&i.rotation){d.position=i.position,d.rotation=i.rotation;const e=(new r.Vector3).copy(c);if((0,b.rC)(i.rotation)*v.tm>5){const t=Math.min(c.y,i.position.y-1),s=new r.Plane(a.B1.UP.clone(),t),o=(0,w.qK)(d.position,d.rotation,s);o&&e.copy(o)}u=d.position.distanceTo(e),d.rotation=(0,w.kf)(i.position,e)}else if(i.position)d.position=i.position,d.rotation=(0,w.kf)(i.position,c);else{d.rotation=null!==(n=i.rotation)&&void 0!==n?n:new r.Quaternion;const e=h.min.distanceTo(h.max);d.position=(0,w.fg)(d.rotation,c,e)}u||(u=c.clone().distanceTo(d.position))}else{let e,t;const i=this.sweepData.isSweepUnaligned(this.sweepData.currentSweep);let n=this.cameraData.pose.position;if(i||this.data.transition.from===o.N3.Floorplan?n=c:this.data.transition.from===o.N3.Dollhouse&&(n=this.cameraData.pose.focalPoint().clone().add(new r.Vector3(0,1,0))),this.data.transition.from!==o.N3.Floorplan)if(this.peekabooActive){const e=((e,t,i,s,o=!1)=>{const n=30*v.fy,l=s<1,h=1.2*M(i),c=e.clone().add(new r.Vector3(0,-1,0)),d=(0,b.rC)(t),u=t.clone().multiply((new r.Quaternion).setFromAxisAngle(a.B1.RIGHT,d));let m=u;if(o){const e=i.getCenter(new r.Vector3);c.x=e.x,c.z=e.z;const t=i.getSize(new r.Vector3),s=t.x/t.z<1,o=a.B1.FORWARD.clone().applyQuaternion(u).normalize(),n=l===s?new r.Vector3(0,0,-(Math.sign(o.z)||1)):new r.Vector3(-(Math.sign(o.x)||1),0,0);m=(new r.Quaternion).setFromRotationMatrix((new r.Matrix4).makeBasis((new r.Vector3).crossVectors(a.B1.UP,n),a.B1.UP,n)),c.add(n.clone().multiplyScalar(1))}const p=m.multiply((new r.Quaternion).setFromAxisAngle(a.B1.RIGHT,-n)),g=a.B1.FORWARD.clone().applyQuaternion(p);return{position:c.clone().add(g.clone().multiplyScalar(-h)),rotation:p,focalDistance:h}})(n,this.cameraData.pose.rotation,h,this.canvas.aspectRatio,s);d.position=e.position,d.rotation=e.rotation,u=e.focalDistance;const t=d.position.distanceTo(this.cameraData.pose.position)<k,i=d.rotation.angleTo(this.cameraData.pose.rotation)<_;t&&i&&(m=0)}else{const i=1.5,s=(0,w.hm)({targetPosition:this.cameraData.pose.position,targetRotation:this.cameraData.pose.rotation,angleDown:-Math.PI/6,box:h,fovY:this.cameraData.fovY()*i,aspectRatio:this.cameraData.pose.aspect()}),o=((e,t)=>{const i=e.clone().add(new r.Vector3(0,6,0)),s=a.B1.FORWARD.clone().applyQuaternion(t);return s.y>=.01&&(s.y=.01),{position:i.clone().add(s.clone().multiplyScalar(-10)),direction:s}})(n,this.cameraData.pose.rotation);[e,t]=[s.position,o.direction];const l=n.clone().add(t).setY(c.y);d.position=(0,w.Gk)(e,l,this.minDollhouseDistance,this.maxDollhouseDistance),d.position=(0,w.Vb)(d.position,l,V,E),d.rotation=(0,w.kf)(d.position,l),u=l.distanceTo(d.position)}else u=((e,t,i)=>{const s=e.getCenter(new r.Vector3),o=M(e);return x(o,s,t,i)})(this.visibleMeshBounds.getVisibleBounds(),this.cameraData.pose.rotation,d)}return this.cameraModule.moveTo({transitionType:e,pose:d,transitionTime:m,autoOrtho:!!this.peekabooActive||void 0,projection:(0,l.hn)(this.cameraData.aspect()),focalDistance:u,rotationDuration:.5})}setDollhouseBounds(){const e=this.meshData.extendedBounds,t=e.min.distanceTo(e.max);this.minDollhouseDistance=Math.min(t/2,this.minDollhouseDistance),this.maxDollhouseDistance=Math.max(t,this.maxDollhouseDistance)}moveCameraToFloorplan(e,t,i,s){const o={},n=this.meshData.meshCenter,h=this.meshData.meshSize,c=Math.max(h.x,h.z),d=this.canvas.aspectRatio,u=this.getDefaultFloorplanZoom(this.meshData.meshSize),m=s&&s.zoom?this.canvas.height/(2*s.zoom):u,p=(0,l.Ei)(this.canvas.width,this.canvas.height,m),g=this.getDefaultFloorplanZoom(this.meshData.extendedSize),f=(0,l.Ei)(this.canvas.width,this.canvas.height,g);if(this.cameraModule.setBaseProjection(f),this.cameraData.pose.setAutoOrtho(!1),s&&s.position)o.position=s.position;else{const e=a.B1.UP.clone().multiplyScalar(c);o.position=n.clone().add(e)}if(s&&s.rotation)o.rotation=s.rotation;else{const e=(new T.k).setPosition(o.position);e.lookAt(o.position,n,a.B1.FORWARD),o.rotation=(new r.Quaternion).setFromRotationMatrix(e.asThreeMatrix4());if(d<1!==h.x/h.z<1){const e=(new r.Quaternion).setFromUnitVectors(a.B1.UP,a.B1.LEFT);o.rotation.multiply(e)}}const y=o.position.y-this.meshData.meshCenter.y;let w=Object.assign(Object.assign({},P.Ow),{easing:S.WD,transitionType:t,pose:o,transitionTime:i,projection:p,focalDistance:y});return e&&e in P.aF&&(w=Object.assign(Object.assign({},P.aF[e]),w)),this.cameraModule.moveTo(w)}moveCameraToOrthographic(e,t,i,s){const o=s&&s.zoom?s.zoom:this.getDefaultFloorplanZoom(this.meshData.extendedSize),n=(0,l.Ei)(this.canvas.width,this.canvas.height,o,1,void 0,void 0,this._orthoMatrix);this.cameraModule.setBaseProjection(n);const r={easing:S.WD,transitionType:t,pose:s||{},transitionTime:i,projection:n,focalDistance:2};return this.cameraModule.moveTo(r)}getPeekabooDollhousePoseFromFloorplanPose(e,t=!1){let i;if(e&&e.position&&e.rotation&&e.zoom){const s=e.position,o=e.rotation,n=(0,w.xF)(e.zoom),l=this.visibleMeshBounds.computeFocusPoint(new r.Ray(s,a.B1.DOWN));t?i={position:new r.Vector3(s.x,this.meshData.meshCenter.y+n,s.z),rotation:e.rotation.clone(),focalDistance:n}:(i={position:new r.Vector3,rotation:new r.Quaternion,focalDistance:n},x(n,l,o,i))}return i}fixHighPhiPose(e,t){if((null==t?void 0:t.rotation)&&(null==t?void 0:t.position)&&(0,b.rC)(t.rotation)>B.oO&&e===o.N3.Dollhouse){const[e,i]=this.setPhi(null==t?void 0:t.position,t.rotation);t.position=t.position.clone().add(i),t.rotation=e}}setPhi(e,t){var i;const s=(0,b.rC)(t),o=(null===(i=this.meshData)||void 0===i?void 0:i.meshCenter.y)||0,n=Math.abs(o-e.y)*Math.tan(Math.abs(B.oO-s)),l=t.clone().multiply((new r.Quaternion).setFromAxisAngle(a.B1.RIGHT,s)).multiply((new r.Quaternion).setFromAxisAngle(a.B1.RIGHT,-B.oO)),h=a.B1.UP.clone().applyQuaternion(l);return h.y=0,h.normalize().multiplyScalar(-n),[l,h]}getDefaultFloorplanZoom(e){const t=Math.max(e.x,e.z),i=Math.min(e.x,e.z),s=this.canvas.aspectRatio,o=Math.max(t,i/s),n=Math.max(i,t/s),r=s<1?o:n;return this.canvas.height/(1.2*r)}}},62569:(e,t,i)=>{"use strict";i.d(t,{A:()=>o});const s=e=>""+e;class o{constructor(e=s){this.mappingFunction=e,this.list=[],this.map={}}add(e){const t=this.mappingFunction(e);return!this.map[t]&&(this.list.push(e),this.map[t]=e,!0)}set(e){const t=this.mappingFunction(e);return this.map[t]?(this.map[t]=e,!0):(this.add(e),!0)}count(){return this.list.length}*[Symbol.iterator](){for(const e of this.list)yield e}getByIndex(e){return this.list[e]}get(e){return this.map[e]}copyToList(e){return e.push(...this.list),e}clear(){this.list=[],this.map={}}mapElements(e){return this.list.map(e)}}},89103:(e,t,i)=>{"use strict";i.d(t,{m:()=>o});var s=i(68909);class o extends s.Mesh{constructor(e,t){super(e,t)}}},61825:(e,t,i)=>{"use strict";i.d(t,{Mq:()=>a,Zd:()=>r,_o:()=>l});var s=i(68909);const o=()=>Math.random(),n={},r=(e,t=o())=>(n[t]||(n[t]=new s.Vector4(o(),o(),o(),e)),n[t]),a=()=>new s.Color(o(),o(),o()),l=e=>e instanceof Object&&"r"in e&&"g"in e&&"b"in e},34944:(e,t,i)=>{"use strict";i.d(t,{U7:()=>h,UX:()=>l,Wi:()=>d,h0:()=>n,jF:()=>u,nD:()=>m});var s=i(68909),o=i(48071);function n(e){if(0===e.length)throw Error("Can't merge empty list of geometries");if(1===e.length)return e[0];let t=0,i=0,o=0,n=0;const a=new s.Box3;for(const s of e)s.index&&(t+=s.index.count,i+=s.getAttribute("position").count,s.getAttribute("uv")&&(o+=s.getAttribute("uv").count),s.boundingBox&&(a.union(s.boundingBox),n++));const h=new s.BufferGeometry;n!==e.length||a.isEmpty()?h.computeBoundingBox():h.boundingBox=a,a.copy(l(h)),h.boundingSphere=a.getBoundingSphere(new s.Sphere);const c=r(new Float32Array(3*i),"position",e);h.setAttribute("position",new s.BufferAttribute(c,3));const d=function(e,t){let i=0,s=0;for(const o of t){const t=o.index;for(let o=0;o<t.array.length;o++)e[i+o]=t.array[o]+s;i+=t.array.length,s+=o.getAttribute("position").count}return e}(new Uint32Array(t),e);if(h.setIndex(new s.BufferAttribute(d,1)),o){const t=r(new Float32Array(2*o),"uv",e);h.setAttribute("uv",new s.BufferAttribute(t,2))}return h}function r(e,t,i){let s=0;for(const o of i){const i=o.getAttribute(t);e.set(i.array,s),s+=i.array.length}return e}const a=new s.Box3(o.B1.ZERO,o.B1.UNIT);function l(e){return e.boundingBox||e.computeBoundingBox(),e.boundingBox||a}function h(e,t){let i=1/0;const o=t.clone(),n=new s.Vector3,r=new s.Vector3(1/0,1/0,1/0);let a=-1;const l=new s.Triangle;return function(e,t){var i;const s=null===(i=e.index)||void 0===i?void 0:i.array,o=e.getAttribute("position");if(!o)return;const n=e.groups.length>0?e.groups:[{start:0,count:s?s.length:o.count,materialIndex:0}];let r=0;for(const e of n)for(let i=e.start;i<e.start+e.count;i+=3){let n=i,a=i+1,l=i+2;s&&(n=s[n],a=s[a],l=s[l]),t(o.getX(n),o.getY(n),o.getZ(n),o.getX(a),o.getY(a),o.getZ(a),o.getX(l),o.getY(l),o.getZ(l),r++,e.materialIndex||0)}}(e,((e,t,s,h,c,d,u,m,p,g)=>{l.a.set(e,t,s),l.b.set(h,c,d),l.c.set(u,m,p),l.closestPointToPoint(o,n);const f=o.distanceToSquared(n);f<i&&(r.copy(n),i=f,a=g)})),{point:r,distance:Math.sqrt(i),faceIndex:a}}const c=new s.PlaneGeometry(1,1);function d(){return c}const u=(e,t)=>{t=t||[];for(let e=0;e<8;e++)t[e]=t[e]||new s.Vector3;return t[0].set(e.min.x,e.min.y,e.min.z),t[1].set(e.min.x,e.max.y,e.min.z),t[2].set(e.max.x,e.max.y,e.min.z),t[3].set(e.max.x,e.min.y,e.min.z),t[4].set(e.min.x,e.min.y,e.max.z),t[5].set(e.min.x,e.max.y,e.max.z),t[6].set(e.max.x,e.max.y,e.max.z),t[7].set(e.max.x,e.min.y,e.max.z),t},m=(()=>{const e=new s.Vector3,t=new s.Vector3;return(i,o,n)=>{o=o||new s.Box3,e.set(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),t.set(Number.MIN_VALUE,Number.MIN_VALUE,Number.MIN_VALUE);for(const s of i)n&&s.applyMatrix4(n),e.x=Math.min(e.x,s.x),e.y=Math.min(e.y,s.y),e.z=Math.min(e.z,s.z),t.x=Math.max(t.x,s.x),t.y=Math.max(t.y,s.y),t.z=Math.max(t.z,s.z);return o.min.copy(e),o.max.copy(t),o}})()},76482:(e,t,i)=>{"use strict";async function s(e,t){if(await e.transition.promise,!t.canStartTransition()){const e=new Promise((e=>{const i=t.onChanged((()=>{t.canStartTransition()&&(i.cancel(),e())}))}));await e}}i.d(t,{L:()=>s})},48439:(e,t,i)=>{"use strict";var s;i.d(t,{o:()=>s}),function(e){e.MOUSE="mouse",e.TOUCH="touch",e.PEN="pen",e.GAMEPAD="gamepad"}(s||(s={}))},52492:e=>{e.exports="precision highp float;precision highp int;vec3 closestPointToRay(vec3 point,vec3 origin,vec3 direction){vec3 d=point-origin;float D=dot(d,direction);return origin+D*direction;}vec3 rayIntersectsSphere(vec3 origin,float radius,vec3 rayOrigin,vec3 rayDirection){vec3 chordPoint=closestPointToRay(origin,rayOrigin,rayDirection);float D1=length(rayOrigin-chordPoint);float D=length(chordPoint-origin);float D2=sqrt(radius*radius-D*D);return rayOrigin+(D1+D2)*rayDirection;}uniform float borderSize;uniform float textureSampleScale;uniform samplerCube panoTexture;uniform vec4 borderColor;varying vec2 vUv;const vec4 transparent=vec4(0.,0.,0.,0.);const float PI=3.14159265359;const float HALF_PI=PI/2.;void main(){float fadeDist=0.1;float r=1.;vec2 uv=(vUv*2.)-vec2(1.,1.);float d=length(uv);float p=d*PI-HALF_PI;float y=sin(p);float h=cos(p)*textureSampleScale;vec3 sampleVec=vec3(uv.x*h,y,uv.y*h);vec4 panoColor=textureCube(panoTexture,sampleVec);panoColor.a=clamp(((1.-d)/d)/fadeDist,0.,1.);vec4 outColor=mix(panoColor,transparent,step(1.,d));float isBorder=max(sign(borderSize),0.)*step(1.-borderSize,d)*step(d,1.);gl_FragColor=linearToOutputTexel(mix(outColor,borderColor,isBorder));}"},70694:e=>{e.exports="precision highp float;precision highp int;varying vec2 vUv;void main(){vUv=uv;vec4 projectedPosition=projectionMatrix*viewMatrix*modelMatrix*vec4(position,1.);gl_Position=projectedPosition;}"},50652:e=>{e.exports="precision highp float;precision highp int;vec3 closestPointToRay(vec3 point,vec3 origin,vec3 direction){vec3 d=point-origin;float D=dot(d,direction);return origin+D*direction;}vec3 rayIntersectsSphere(vec3 origin,float radius,vec3 rayOrigin,vec3 rayDirection){vec3 chordPoint=closestPointToRay(origin,rayOrigin,rayDirection);float D1=length(rayOrigin-chordPoint);float D=length(chordPoint-origin);float D2=sqrt(radius*radius-D*D);return rayOrigin+(D1+D2)*rayDirection;}uniform sampler2D bg;uniform sampler2D mask;varying vec2 vUv;void main(){vec4 existingColor=texture2D(bg,vUv);vec4 maskColor=texture2D(mask,vUv);gl_FragColor=linearToOutputTexel(vec4(existingColor.rgb*maskColor.rgb,maskColor.a));}"},91254:e=>{e.exports="precision highp float;precision highp int;varying vec2 vUv;void main(){vUv=uv;gl_Position=projectionMatrix*modelMatrix*vec4(position,1.);}"},88140:e=>{e.exports="precision highp float;precision highp int;vec3 closestPointToRay(vec3 point,vec3 origin,vec3 direction){vec3 d=point-origin;float D=dot(d,direction);return origin+D*direction;}vec3 rayIntersectsSphere(vec3 origin,float radius,vec3 rayOrigin,vec3 rayDirection){vec3 chordPoint=closestPointToRay(origin,rayOrigin,rayDirection);float D1=length(rayOrigin-chordPoint);float D=length(chordPoint-origin);float D2=sqrt(radius*radius-D*D);return rayOrigin+(D1+D2)*rayDirection;}\n#define M_PI  3.14159265359\nuniform samplerCube cubemap;uniform float yaw;varying vec2 vUv;void main(){vec2 uv=vUv;float theta=uv.x*2.*M_PI+yaw;float phi=uv.y*M_PI;vec3 longitude=vec3(sin(theta),1.,-cos(theta));vec3 latitude=vec3(sin(phi),-cos(phi),sin(phi));vec3 dir=longitude*latitude;normalize(dir);gl_FragColor=linearToOutputTexel(vec4(textureCube(cubemap,dir).rgb,1.));}"},16249:e=>{e.exports="precision highp float;precision highp int;varying vec2 vUv;void main(){vUv=vec2(1.-uv.x,uv.y);gl_Position=projectionMatrix*modelViewMatrix*vec4(position,1.);}"},99515:e=>{e.exports="precision highp float;precision highp int;vec3 closestPointToRay(vec3 point,vec3 origin,vec3 direction){vec3 d=point-origin;float D=dot(d,direction);return origin+D*direction;}vec3 rayIntersectsSphere(vec3 origin,float radius,vec3 rayOrigin,vec3 rayDirection){vec3 chordPoint=closestPointToRay(origin,rayOrigin,rayDirection);float D1=length(rayOrigin-chordPoint);float D=length(chordPoint-origin);float D2=sqrt(radius*radius-D*D);return rayOrigin+(D1+D2)*rayDirection;}uniform vec3 topColor;uniform vec3 bottomColor;uniform float radius;varying vec3 rayOrigin;varying vec3 rayDirection;\n#define SRGB_TO_LINEAR(c)pow((c),vec3(2.2))\n#define LINEAR_TO_SRGB(c)pow((c),vec3(1./2.2))\n#define USE_DITHER \nfloat gradientNoise(in vec2 uv){const vec3 magic=vec3(0.06711056,0.00583715,52.9829189);return fract(magic.z*fract(dot(uv,magic.xy)));}void main(){vec3 worldPosition=rayIntersectsSphere(vec3(0.,0.,0.),radius,rayOrigin,normalize(rayDirection));float normalizedHeight=(worldPosition.y+radius)/(radius*2.);float ratio=smoothstep(0.,0.5,normalizedHeight);vec3 colorFromGradient=mix(SRGB_TO_LINEAR(bottomColor),SRGB_TO_LINEAR(topColor),ratio);vec3 color=LINEAR_TO_SRGB(colorFromGradient);\n#if defined (USE_DITHER)\ncolor+=(1./255.)*gradientNoise(gl_FragCoord.xy)-(0.5/255.);\n#endif\ngl_FragColor=linearToOutputTexel(vec4(color,1.));}"},91177:e=>{e.exports="precision highp float;precision highp int;varying vec3 rayOrigin;varying vec3 rayDirection;uniform mat4 cameraMatrix;uniform mat4 inverseProjectionMatrix;vec3 unproject(vec3 pos){vec4 v=cameraMatrix*inverseProjectionMatrix*vec4(pos,1.);return vec3(v.xyz/v.w);}void main(){rayOrigin=unproject(vec3(position.xy,-1.));vec3 end=unproject(vec3(position.xy,1.));rayDirection=normalize(end-rayOrigin);gl_Position=vec4(position,1.);}"},74025:(e,t,i)=>{"use strict";i.d(t,{$J:()=>h,BE:()=>u,Bw:()=>r,Gm:()=>o,Ne:()=>d,Q7:()=>s,Xe:()=>n,b_:()=>a,bf:()=>m,nw:()=>c,yj:()=>l});const s=0,o=1,n=2,r=0,a=1,l=2,h=1.25,c=1,d=32,u=65535,m=Math.pow(2,-24)},79545:(e,t,i)=>{"use strict";i.d(t,{G:()=>le});var s=i(68909),o=i(74025);class n{constructor(){}}function r(e,t,i){return i.min.x=t[e],i.min.y=t[e+1],i.min.z=t[e+2],i.max.x=t[e+3],i.max.y=t[e+4],i.max.z=t[e+5],i}function a(e){let t=-1,i=-1/0;for(let s=0;s<3;s++){const o=e[s+3]-e[s];o>i&&(i=o,t=s)}return t}function l(e,t){t.set(e)}function h(e,t,i){let s,o;for(let n=0;n<3;n++){const r=n+3;s=e[n],o=t[n],i[n]=s<o?s:o,s=e[r],o=t[r],i[r]=s>o?s:o}}function c(e,t,i){for(let s=0;s<3;s++){const o=t[e+2*s],n=t[e+2*s+1],r=o-n,a=o+n;r<i[s]&&(i[s]=r),a>i[s+3]&&(i[s+3]=a)}}function d(e){const t=e[3]-e[0],i=e[4]-e[1],s=e[5]-e[2];return 2*(t*i+i*s+s*t)}function u(e,t,i,s,o=null){let n=1/0,r=1/0,a=1/0,l=-1/0,h=-1/0,c=-1/0,d=1/0,u=1/0,m=1/0,p=-1/0,g=-1/0,f=-1/0;const y=null!==o;for(let s=6*t,o=6*(t+i);s<o;s+=6){const t=e[s+0],i=e[s+1],o=t-i,w=t+i;o<n&&(n=o),w>l&&(l=w),y&&t<d&&(d=t),y&&t>p&&(p=t);const v=e[s+2],b=e[s+3],x=v-b,M=v+b;x<r&&(r=x),M>h&&(h=M),y&&v<u&&(u=v),y&&v>g&&(g=v);const D=e[s+4],T=e[s+5],S=D-T,P=D+T;S<a&&(a=S),P>c&&(c=P),y&&D<m&&(m=D),y&&D>f&&(f=D)}s[0]=n,s[1]=r,s[2]=a,s[3]=l,s[4]=h,s[5]=c,y&&(o[0]=d,o[1]=u,o[2]=m,o[3]=p,o[4]=g,o[5]=f)}const m=32,p=(e,t)=>e.candidate-t.candidate,g=new Array(m).fill().map((()=>({count:0,bounds:new Float32Array(6),rightCacheBounds:new Float32Array(6),leftCacheBounds:new Float32Array(6),candidate:0}))),f=new Float32Array(6);function y(e,t){function i(e){S&&S(e/P)}function r(t,s,y,S=null,P=0){if(!C&&P>=x&&(C=!0,M&&(console.warn(`MeshBVH: Max depth of ${x} reached when generating BVH. Consider increasing maxDepth.`),console.warn(e))),y<=D||P>=x)return i(s+y),t.offset=s,t.count=y,t;const A=function(e,t,i,s,n,r){let u=-1,y=0;if(r===o.Q7)u=a(t),-1!==u&&(y=(t[u]+t[u+3])/2);else if(r===o.Gm)u=a(e),-1!==u&&(y=function(e,t,i,s){let o=0;for(let n=t,r=t+i;n<r;n++)o+=e[6*n+2*s];return o/i}(i,s,n,u));else if(r===o.Xe){const r=d(e);let a=o.$J*n;const w=6*s,v=6*(s+n);for(let e=0;e<3;e++){const s=t[e],b=(t[e+3]-s)/m;if(n<8){const t=[...g];t.length=n;let s=0;for(let o=w;o<v;o+=6,s++){const n=t[s];n.candidate=i[o+2*e],n.count=0;const{bounds:r,leftCacheBounds:a,rightCacheBounds:l}=n;for(let e=0;e<3;e++)l[e]=1/0,l[e+3]=-1/0,a[e]=1/0,a[e+3]=-1/0,r[e]=1/0,r[e+3]=-1/0;c(o,i,r)}t.sort(p);let l=n;for(let e=0;e<l;e++){const i=t[e];for(;e+1<l&&t[e+1].candidate===i.candidate;)t.splice(e+1,1),l--}for(let s=w;s<v;s+=6){const o=i[s+2*e];for(let e=0;e<l;e++){const n=t[e];o>=n.candidate?c(s,i,n.rightCacheBounds):(c(s,i,n.leftCacheBounds),n.count++)}}for(let i=0;i<l;i++){const s=t[i],l=s.count,h=n-s.count,c=s.leftCacheBounds,m=s.rightCacheBounds;let p=0;0!==l&&(p=d(c)/r);let g=0;0!==h&&(g=d(m)/r);const f=o.nw+o.$J*(p*l+g*h);f<a&&(u=e,a=f,y=s.candidate)}}else{for(let e=0;e<m;e++){const t=g[e];t.count=0,t.candidate=s+b+e*b;const i=t.bounds;for(let e=0;e<3;e++)i[e]=1/0,i[e+3]=-1/0}for(let t=w;t<v;t+=6){let o=~~((i[t+2*e]-s)/b);o>=m&&(o=31);const n=g[o];n.count++,c(t,i,n.bounds)}const t=g[31];l(t.bounds,t.rightCacheBounds);for(let e=30;e>=0;e--){const t=g[e],i=g[e+1];h(t.bounds,i.rightCacheBounds,t.rightCacheBounds)}let p=0;for(let t=0;t<31;t++){const i=g[t],s=i.count,c=i.bounds,m=g[t+1].rightCacheBounds;0!==s&&(0===p?l(c,f):h(c,f,f)),p+=s;let w=0,v=0;0!==p&&(w=d(f)/r);const b=n-p;0!==b&&(v=d(m)/r);const x=o.nw+o.$J*(w*p+v*b);x<a&&(u=e,a=x,y=i.candidate)}}}}else console.warn(`MeshBVH: Invalid build strategy value ${r} used.`);return{axis:u,pos:y}}(t.boundingData,S,v,s,y,T);if(-1===A.axis)return i(s+y),t.offset=s,t.count=y,t;const O=function(e,t,i,s,o){let n=i,r=i+s-1;const a=o.pos,l=2*o.axis;for(;;){for(;n<=r&&t[6*n+l]<a;)n++;for(;n<=r&&t[6*r+l]>=a;)r--;if(!(n<r))return n;for(let i=0;i<3;i++){let s=e[3*n+i];e[3*n+i]=e[3*r+i],e[3*r+i]=s;let o=t[6*n+2*i+0];t[6*n+2*i+0]=t[6*r+2*i+0],t[6*r+2*i+0]=o;let a=t[6*n+2*i+1];t[6*n+2*i+1]=t[6*r+2*i+1],t[6*r+2*i+1]=a}n++,r--}}(b,v,s,y,A);if(O===s||O===s+y)i(s+y),t.offset=s,t.count=y;else{t.splitAxis=A.axis;const e=new n,i=s,o=O-s;t.left=e,e.boundingData=new Float32Array(6),u(v,i,o,e.boundingData,w),r(e,i,o,w,P+1);const a=new n,l=O,h=y-o;t.right=a,a.boundingData=new Float32Array(6),u(v,l,h,a.boundingData,w),r(a,l,h,w,P+1)}return t}!function(e,t){if(!e.index){const i=e.attributes.position.count,o=t.useSharedArrayBuffer?SharedArrayBuffer:ArrayBuffer;let n;n=i>65535?new Uint32Array(new o(4*i)):new Uint16Array(new o(2*i)),e.setIndex(new s.BufferAttribute(n,1));for(let e=0;e<i;e++)n[e]=e}}(e,t);const y=new Float32Array(6),w=new Float32Array(6),v=function(e,t){const i=e.attributes.position,s=e.index.array,n=s.length/3,r=new Float32Array(6*n),a=i.normalized,l=i.array,h=i.offset||0;let c=3;i.isInterleavedBufferAttribute&&(c=i.data.stride);const d=["getX","getY","getZ"];for(let e=0;e<n;e++){const n=3*e,u=6*e;let m,p,g;a?(m=s[n+0],p=s[n+1],g=s[n+2]):(m=s[n+0]*c+h,p=s[n+1]*c+h,g=s[n+2]*c+h);for(let e=0;e<3;e++){let s,n,h;a?(s=i[d[e]](m),n=i[d[e]](p),h=i[d[e]](g)):(s=l[m+e],n=l[p+e],h=l[g+e]);let c=s;n<c&&(c=n),h<c&&(c=h);let f=s;n>f&&(f=n),h>f&&(f=h);const y=(f-c)/2,w=2*e;r[u+w+0]=c+y,r[u+w+1]=y+(Math.abs(c)+y)*o.bf,c<t[e]&&(t[e]=c),f>t[e+3]&&(t[e+3]=f)}}return r}(e,y),b=e.index.array,x=t.maxDepth,M=t.verbose,D=t.maxLeafTris,T=t.strategy,S=t.onProgress,P=e.index.count/3;let C=!1;const A=[],O=function(e){if(!e.groups||!e.groups.length)return[{offset:0,count:e.index.count/3}];const t=[],i=new Set;for(const t of e.groups)i.add(t.start),i.add(t.start+t.count);const s=Array.from(i.values()).sort(((e,t)=>e-t));for(let e=0;e<s.length-1;e++){const i=s[e],o=s[e+1];t.push({offset:i/3,count:(o-i)/3})}return t}(e);if(1===O.length){const e=O[0],t=new n;t.boundingData=y,function(e,t,i,s){let o=1/0,n=1/0,r=1/0,a=-1/0,l=-1/0,h=-1/0;for(let s=6*t,c=6*(t+i);s<c;s+=6){const t=e[s+0];t<o&&(o=t),t>a&&(a=t);const i=e[s+2];i<n&&(n=i),i>l&&(l=i);const c=e[s+4];c<r&&(r=c),c>h&&(h=c)}s[0]=o,s[1]=n,s[2]=r,s[3]=a,s[4]=l,s[5]=h}(v,e.offset,e.count,w),r(t,e.offset,e.count,w),A.push(t)}else for(let e of O){const t=new n;t.boundingData=new Float32Array(6),u(v,e.offset,e.count,t.boundingData,w),r(t,e.offset,e.count,w),A.push(t)}return A}class w{constructor(){this.min=1/0,this.max=-1/0}setFromPointsField(e,t){let i=1/0,s=-1/0;for(let o=0,n=e.length;o<n;o++){const n=e[o][t];i=n<i?n:i,s=n>s?n:s}this.min=i,this.max=s}setFromPoints(e,t){let i=1/0,s=-1/0;for(let o=0,n=t.length;o<n;o++){const n=t[o],r=e.dot(n);i=r<i?r:i,s=r>s?r:s}this.min=i,this.max=s}isSeparated(e){return this.min>e.max||e.min>this.max}}w.prototype.setFromBox=function(){const e=new s.Vector3;return function(t,i){const s=i.min,o=i.max;let n=1/0,r=-1/0;for(let i=0;i<=1;i++)for(let a=0;a<=1;a++)for(let l=0;l<=1;l++){e.x=s.x*i+o.x*(1-i),e.y=s.y*a+o.y*(1-a),e.z=s.z*l+o.z*(1-l);const h=t.dot(e);n=Math.min(h,n),r=Math.max(h,r)}this.min=n,this.max=r}}();!function(){const e=new w}();const v=function(){const e=new s.Vector3,t=new s.Vector3,i=new s.Vector3;return function(s,o,n){const r=s.start,a=e,l=o.start,h=t;i.subVectors(r,l),e.subVectors(s.end,s.start),t.subVectors(o.end,o.start);const c=i.dot(h),d=h.dot(a),u=h.dot(h),m=i.dot(a),p=a.dot(a)*u-d*d;let g,f;g=0!==p?(c*d-m*u)/p:0,f=(c+g*d)/u,n.x=g,n.y=f}}(),b=function(){const e=new s.Vector2,t=new s.Vector3,i=new s.Vector3;return function(s,o,n,r){v(s,o,e);let a=e.x,l=e.y;if(a>=0&&a<=1&&l>=0&&l<=1)return s.at(a,n),void o.at(l,r);if(a>=0&&a<=1)return l<0?o.at(0,r):o.at(1,r),void s.closestPointToPoint(r,!0,n);if(l>=0&&l<=1)return a<0?s.at(0,n):s.at(1,n),void o.closestPointToPoint(n,!0,r);{let e,h;e=a<0?s.start:s.end,h=l<0?o.start:o.end;const c=t,d=i;return s.closestPointToPoint(h,!0,t),o.closestPointToPoint(e,!0,i),c.distanceToSquared(h)<=d.distanceToSquared(e)?(n.copy(c),void r.copy(h)):(n.copy(e),void r.copy(d))}}}(),x=function(){const e=new s.Vector3,t=new s.Vector3,i=new s.Plane,o=new s.Line3;return function(s,n){const{radius:r,center:a}=s,{a:l,b:h,c}=n;o.start=l,o.end=h;if(o.closestPointToPoint(a,!0,e).distanceTo(a)<=r)return!0;o.start=l,o.end=c;if(o.closestPointToPoint(a,!0,e).distanceTo(a)<=r)return!0;o.start=h,o.end=c;if(o.closestPointToPoint(a,!0,e).distanceTo(a)<=r)return!0;const d=n.getPlane(i);if(Math.abs(d.distanceToPoint(a))<=r){const e=d.projectPoint(a,t);if(n.containsPoint(e))return!0}return!1}}();function M(e){return Math.abs(e)<1e-15}class D extends s.Triangle{constructor(...e){super(...e),this.isExtendedTriangle=!0,this.satAxes=new Array(4).fill().map((()=>new s.Vector3)),this.satBounds=new Array(4).fill().map((()=>new w)),this.points=[this.a,this.b,this.c],this.sphere=new s.Sphere,this.plane=new s.Plane,this.needsUpdate=!0}intersectsSphere(e){return x(e,this)}update(){const e=this.a,t=this.b,i=this.c,s=this.points,o=this.satAxes,n=this.satBounds,r=o[0],a=n[0];this.getNormal(r),a.setFromPoints(r,s);const l=o[1],h=n[1];l.subVectors(e,t),h.setFromPoints(l,s);const c=o[2],d=n[2];c.subVectors(t,i),d.setFromPoints(c,s);const u=o[3],m=n[3];u.subVectors(i,e),m.setFromPoints(u,s),this.sphere.setFromPoints(this.points),this.plane.setFromNormalAndCoplanarPoint(r,e),this.needsUpdate=!1}}D.prototype.closestPointToSegment=function(){const e=new s.Vector3,t=new s.Vector3,i=new s.Line3;return function(s,o=null,n=null){const{start:r,end:a}=s,l=this.points;let h,c=1/0;for(let r=0;r<3;r++){const a=(r+1)%3;i.start.copy(l[r]),i.end.copy(l[a]),b(i,s,e,t),h=e.distanceToSquared(t),h<c&&(c=h,o&&o.copy(e),n&&n.copy(t))}return this.closestPointToPoint(r,e),h=r.distanceToSquared(e),h<c&&(c=h,o&&o.copy(e),n&&n.copy(r)),this.closestPointToPoint(a,e),h=a.distanceToSquared(e),h<c&&(c=h,o&&o.copy(e),n&&n.copy(a)),Math.sqrt(c)}}(),D.prototype.intersectsTriangle=function(){const e=new D,t=new Array(3),i=new Array(3),o=new w,n=new w,r=new s.Vector3,a=new s.Vector3,l=new s.Vector3,h=new s.Vector3,c=new s.Line3,d=new s.Line3,u=new s.Line3;return function(s,m=null,p=!1){this.needsUpdate&&this.update(),s.isExtendedTriangle?s.needsUpdate&&s.update():(e.copy(s),e.update(),s=e);const g=this.plane,f=s.plane;if(Math.abs(g.normal.dot(f.normal))>1-1e-10){const e=this.satBounds,a=this.satAxes;i[0]=s.a,i[1]=s.b,i[2]=s.c;for(let t=0;t<4;t++){const s=e[t],n=a[t];if(o.setFromPoints(n,i),s.isSeparated(o))return!1}const l=s.satBounds,h=s.satAxes;t[0]=this.a,t[1]=this.b,t[2]=this.c;for(let e=0;e<4;e++){const i=l[e],s=h[e];if(o.setFromPoints(s,t),i.isSeparated(o))return!1}for(let e=0;e<4;e++){const s=a[e];for(let e=0;e<4;e++){const a=h[e];if(r.crossVectors(s,a),o.setFromPoints(r,t),n.setFromPoints(r,i),o.isSeparated(n))return!1}}return m&&(p||console.warn("ExtendedTriangle.intersectsTriangle: Triangles are coplanar which does not support an output edge. Setting edge to 0, 0, 0."),m.start.set(0,0,0),m.end.set(0,0,0)),!0}{const e=this.points;let t=!1,i=0;for(let s=0;s<3;s++){const o=e[s],n=e[(s+1)%3];c.start.copy(o),c.end.copy(n),c.delta(a);const r=t?d.start:d.end,l=M(f.distanceToPoint(o));if(M(f.normal.dot(a))&&l){d.copy(c),i=2;break}if((f.intersectLine(c,r)||l)&&!M(r.distanceTo(n))){if(i++,t)break;t=!0}}if(1===i&&s.containsPoint(d.end))return m&&(m.start.copy(d.end),m.end.copy(d.end)),!0;if(2!==i)return!1;const o=s.points;let n=!1,r=0;for(let e=0;e<3;e++){const t=o[e],i=o[(e+1)%3];c.start.copy(t),c.end.copy(i),c.delta(l);const s=n?u.start:u.end,a=M(g.distanceToPoint(t));if(M(g.normal.dot(l))&&a){u.copy(c),r=2;break}if((g.intersectLine(c,s)||a)&&!M(s.distanceTo(i))){if(r++,n)break;n=!0}}if(1===r&&this.containsPoint(u.end))return m&&(m.start.copy(u.end),m.end.copy(u.end)),!0;if(2!==r)return!1;if(d.delta(a),u.delta(l),a.dot(l)<0){let e=u.start;u.start=u.end,u.end=e}const p=d.start.dot(a),y=d.end.dot(a),w=u.start.dot(a),v=u.end.dot(a);return(p===v||w===y||y<w!==p<v)&&(m&&(h.subVectors(d.start,u.start),h.dot(a)>0?m.start.copy(d.start):m.start.copy(u.start),h.subVectors(d.end,u.end),h.dot(a)<0?m.end.copy(d.end):m.end.copy(u.end)),!0)}}}(),D.prototype.distanceToPoint=function(){const e=new s.Vector3;return function(t){return this.closestPointToPoint(t,e),t.distanceTo(e)}}(),D.prototype.distanceToTriangle=function(){const e=new s.Vector3,t=new s.Vector3,i=["a","b","c"],o=new s.Line3,n=new s.Line3;return function(s,r=null,a=null){const l=r||a?o:null;if(this.intersectsTriangle(s,l))return(r||a)&&(r&&l.getCenter(r),a&&l.getCenter(a)),0;let h=1/0;for(let t=0;t<3;t++){let o;const n=i[t],l=s[n];this.closestPointToPoint(l,e),o=l.distanceToSquared(e),o<h&&(h=o,r&&r.copy(e),a&&a.copy(l));const c=this[n];s.closestPointToPoint(c,e),o=c.distanceToSquared(e),o<h&&(h=o,r&&r.copy(c),a&&a.copy(e))}for(let l=0;l<3;l++){const c=i[l],d=i[(l+1)%3];o.set(this[c],this[d]);for(let l=0;l<3;l++){const c=i[l],d=i[(l+1)%3];n.set(s[c],s[d]),b(o,n,e,t);const u=e.distanceToSquared(t);u<h&&(h=u,r&&r.copy(e),a&&a.copy(t))}}return Math.sqrt(h)}}();class T{constructor(e,t,i){this.isOrientedBox=!0,this.min=new s.Vector3,this.max=new s.Vector3,this.matrix=new s.Matrix4,this.invMatrix=new s.Matrix4,this.points=new Array(8).fill().map((()=>new s.Vector3)),this.satAxes=new Array(3).fill().map((()=>new s.Vector3)),this.satBounds=new Array(3).fill().map((()=>new w)),this.alignedSatBounds=new Array(3).fill().map((()=>new w)),this.needsUpdate=!1,e&&this.min.copy(e),t&&this.max.copy(t),i&&this.matrix.copy(i)}set(e,t,i){this.min.copy(e),this.max.copy(t),this.matrix.copy(i),this.needsUpdate=!0}copy(e){this.min.copy(e.min),this.max.copy(e.max),this.matrix.copy(e.matrix),this.needsUpdate=!0}}T.prototype.update=function(){const e=this.matrix,t=this.min,i=this.max,s=this.points;for(let o=0;o<=1;o++)for(let n=0;n<=1;n++)for(let r=0;r<=1;r++){const a=s[1*o|2*n|4*r];a.x=o?i.x:t.x,a.y=n?i.y:t.y,a.z=r?i.z:t.z,a.applyMatrix4(e)}const o=this.satBounds,n=this.satAxes,r=s[0];for(let e=0;e<3;e++){const t=n[e],i=o[e],a=s[1<<e];t.subVectors(r,a),i.setFromPoints(t,s)}const a=this.alignedSatBounds;a[0].setFromPointsField(s,"x"),a[1].setFromPointsField(s,"y"),a[2].setFromPointsField(s,"z"),this.invMatrix.copy(this.matrix).invert(),this.needsUpdate=!1},T.prototype.intersectsBox=function(){const e=new w;return function(t){this.needsUpdate&&this.update();const i=t.min,s=t.max,o=this.satBounds,n=this.satAxes,r=this.alignedSatBounds;if(e.min=i.x,e.max=s.x,r[0].isSeparated(e))return!1;if(e.min=i.y,e.max=s.y,r[1].isSeparated(e))return!1;if(e.min=i.z,e.max=s.z,r[2].isSeparated(e))return!1;for(let i=0;i<3;i++){const s=n[i],r=o[i];if(e.setFromBox(s,t),r.isSeparated(e))return!1}return!0}}(),T.prototype.intersectsTriangle=function(){const e=new D,t=new Array(3),i=new w,o=new w,n=new s.Vector3;return function(s){this.needsUpdate&&this.update(),s.isExtendedTriangle?s.needsUpdate&&s.update():(e.copy(s),e.update(),s=e);const r=this.satBounds,a=this.satAxes;t[0]=s.a,t[1]=s.b,t[2]=s.c;for(let e=0;e<3;e++){const s=r[e],o=a[e];if(i.setFromPoints(o,t),s.isSeparated(i))return!1}const l=s.satBounds,h=s.satAxes,c=this.points;for(let e=0;e<3;e++){const t=l[e],s=h[e];if(i.setFromPoints(s,c),t.isSeparated(i))return!1}for(let e=0;e<3;e++){const s=a[e];for(let e=0;e<4;e++){const r=h[e];if(n.crossVectors(s,r),i.setFromPoints(n,t),o.setFromPoints(n,c),i.isSeparated(o))return!1}}return!0}}(),T.prototype.closestPointToPoint=function(e,t){return this.needsUpdate&&this.update(),t.copy(e).applyMatrix4(this.invMatrix).clamp(this.min,this.max).applyMatrix4(this.matrix),t},T.prototype.distanceToPoint=function(){const e=new s.Vector3;return function(t){return this.closestPointToPoint(t,e),t.distanceTo(e)}}(),T.prototype.distanceToBox=function(){const e=["x","y","z"],t=new Array(12).fill().map((()=>new s.Line3)),i=new Array(12).fill().map((()=>new s.Line3)),o=new s.Vector3,n=new s.Vector3;return function(s,r=0,a=null,l=null){if(this.needsUpdate&&this.update(),this.intersectsBox(s))return(a||l)&&(s.getCenter(n),this.closestPointToPoint(n,o),s.closestPointToPoint(o,n),a&&a.copy(o),l&&l.copy(n)),0;const h=r*r,c=s.min,d=s.max,u=this.points;let m=1/0;for(let e=0;e<8;e++){const t=u[e];n.copy(t).clamp(c,d);const i=t.distanceToSquared(n);if(i<m&&(m=i,a&&a.copy(t),l&&l.copy(n),i<h))return Math.sqrt(i)}let p=0;for(let s=0;s<3;s++)for(let o=0;o<=1;o++)for(let n=0;n<=1;n++){const r=(s+1)%3,a=(s+2)%3,l=1<<s|o<<r|n<<a,h=u[o<<r|n<<a],m=u[l];t[p].set(h,m);const g=e[s],f=e[r],y=e[a],w=i[p],v=w.start,b=w.end;v[g]=c[g],v[f]=o?c[f]:d[f],v[y]=n?c[y]:d[f],b[g]=d[g],b[f]=o?c[f]:d[f],b[y]=n?c[y]:d[f],p++}for(let e=0;e<=1;e++)for(let t=0;t<=1;t++)for(let i=0;i<=1;i++){n.x=e?d.x:c.x,n.y=t?d.y:c.y,n.z=i?d.z:c.z,this.closestPointToPoint(n,o);const s=n.distanceToSquared(o);if(s<m&&(m=s,a&&a.copy(o),l&&l.copy(n),s<h))return Math.sqrt(s)}for(let e=0;e<12;e++){const s=t[e];for(let e=0;e<12;e++){const t=i[e];b(s,t,o,n);const r=o.distanceToSquared(n);if(r<m&&(m=r,a&&a.copy(o),l&&l.copy(n),r<h))return Math.sqrt(r)}}return Math.sqrt(m)}}();var S=i(7662);function P(e,t,i,s){const o=e.a,n=e.b,r=e.c;let a=t,l=t+1,h=t+2;i&&(a=i.getX(t),l=i.getX(t+1),h=i.getX(t+2)),o.x=s.getX(a),o.y=s.getY(a),o.z=s.getZ(a),n.x=s.getX(l),n.y=s.getY(l),n.z=s.getZ(l),r.x=s.getX(h),r.y=s.getY(h),r.z=s.getZ(h)}function C(e,t,i,s,o,n,r){const a=i.index,l=i.attributes.position;for(let i=e,h=t+e;i<h;i++)if(P(r,3*i,a,l),r.needsUpdate=!0,s(r,i,o,n))return!0;return!1}class A{constructor(e){this._getNewPrimitive=e,this._primitives=[]}getPrimitive(){const e=this._primitives;return 0===e.length?this._getNewPrimitive():e.pop()}releasePrimitive(e){this._primitives.push(e)}}function O(e,t){return 65535===t[e+15]}function B(e,t){return t[e+6]}function F(e,t){return t[e+14]}function k(e){return e+8}function _(e,t){return t[e+6]}const V=new s.Box3,E=new s.Vector3,I=["x","y","z"];function R(e,t,i,s,o){let n=2*e,r=j,a=W,l=Q;if(O(n,a)){const r=B(e,l),h=F(n,a);(0,S._m)(t,i,s,r,h,o)}else{const n=k(e);z(n,r,s,E)&&R(n,t,i,s,o);const a=_(e,l);z(a,r,s,E)&&R(a,t,i,s,o)}}function L(e,t,i,s){let o=2*e,n=j,r=W,a=Q;if(O(o,r)){const n=B(e,a),l=F(o,r);return(0,S.k4)(t,i,s,n,l)}{const o=function(e,t){return t[e+7]}(e,a),r=I[o],l=s.direction[r]>=0;let h,c;l?(h=k(e),c=_(e,a)):(h=_(e,a),c=k(e));const d=z(h,n,s,E)?L(h,t,i,s):null;if(d){const e=d.point[r];if(l?e<=n[c+o]:e>=n[c+o+3])return d}const u=z(c,n,s,E)?L(c,t,i,s):null;return d&&u?d.distance<=u.distance?d:u:d||u||null}}const N=function(){let e,t;const i=[],n=new A((()=>new s.Box3));return function(...s){e=n.getPrimitive(),t=n.getPrimitive(),i.push(e,t);const o=a(...s);n.releasePrimitive(e),n.releasePrimitive(t),i.pop(),i.pop();const r=i.length;return r>0&&(t=i[r-1],e=i[r-2]),o};function a(i,s,n,l,h=null,c=0,d=0){function u(e){let t=2*e,i=W,s=Q;for(;!O(t,i);)t=2*(e=k(e));return B(e,s)}function m(e){let t=2*e,i=W,s=Q;for(;!O(t,i);)t=2*(e=_(e,s));return B(e,s)+F(t,i)}let p=2*i,g=j,f=W,y=Q;if(O(p,f)){const t=B(i,y),s=F(p,f);return r(i,g,e),l(t,s,!1,d,c+i,e)}{const p=k(i),w=_(i,y);let v,b,x,M,D=p,T=w;if(h&&(x=e,M=t,r(D,g,x),r(T,g,M),v=h(x),b=h(M),b<v)){D=w,T=p;const e=v;v=b,b=e,x=M}x||(x=e,r(D,g,x));const S=n(x,O(2*D,f),v,d+1,c+D);let P;if(S===o.yj){const e=u(D);P=l(e,m(D)-e,!0,d+1,c+D,x)}else P=S&&a(D,s,n,l,h,c,d+1);if(P)return!0;M=t,r(T,g,M);const C=n(M,O(2*T,f),b,d+1,c+T);let A;if(C===o.yj){const e=u(T);A=l(e,m(T)-e,!0,d+1,c+T,M)}else A=C&&a(T,s,n,l,h,c,d+1);return!!A}}}(),U=function(){const e=new D,t=new D,i=new s.Matrix4,o=new T,n=new T;return function s(a,l,h,c,d=null){let u=2*a,m=j,p=W,g=Q;null===d&&(h.boundingBox||h.computeBoundingBox(),o.set(h.boundingBox.min,h.boundingBox.max,c),d=o);if(!O(u,p)){const e=a+8,t=g[a+6];r(e,m,V);if(d.intersectsBox(V)&&s(e,l,h,c,d))return!0;r(t,m,V);return!!(d.intersectsBox(V)&&s(t,l,h,c,d))}{const s=l,o=s.index,d=s.attributes.position,f=h.index,y=h.attributes.position,w=B(a,g),v=F(u,p);if(i.copy(c).invert(),h.boundsTree){r(a,m,n),n.matrix.copy(i),n.needsUpdate=!0;return h.boundsTree.shapecast({intersectsBounds:e=>n.intersectsBox(e),intersectsTriangle:e=>{e.a.applyMatrix4(c),e.b.applyMatrix4(c),e.c.applyMatrix4(c),e.needsUpdate=!0;for(let i=3*w,s=3*(v+w);i<s;i+=3)if(P(t,i,o,d),t.needsUpdate=!0,e.intersectsTriangle(t))return!0;return!1}})}for(let s=3*w,n=v+3*w;s<n;s+=3){P(e,s,o,d),e.a.applyMatrix4(i),e.b.applyMatrix4(i),e.c.applyMatrix4(i),e.needsUpdate=!0;for(let i=0,s=f.count;i<s;i+=3)if(P(t,i,f,y),t.needsUpdate=!0,e.intersectsTriangle(t))return!0}}}}();function z(e,t,i,s){return r(e,t,V),i.intersectBox(V,s)}const G=[];let H,j,W,Q;function $(e){H&&G.push(H),H=e,j=new Float32Array(e),W=new Uint16Array(e),Q=new Uint32Array(e)}function q(){H=null,j=null,W=null,Q=null,G.length&&$(G.pop())}const K=Symbol("skip tree generation"),X=new s.Box3,Z=new s.Box3,Y=new s.Matrix4,J=new T,ee=new T,te=new s.Vector3,ie=new s.Vector3,se=new s.Vector3,oe=new s.Vector3,ne=new s.Vector3,re=new s.Box3,ae=new A((()=>new D));class le{static serialize(e,t={}){if(t.isBufferGeometry)return console.warn("MeshBVH.serialize: The arguments for the function have changed. See documentation for new signature."),le.serialize(arguments[0],{cloneBuffers:void 0===arguments[2]||arguments[2]});t={cloneBuffers:!0,...t};const i=e.geometry,s=e._roots,o=i.getIndex();let n;return n=t.cloneBuffers?{roots:s.map((e=>e.slice())),index:o.array.slice()}:{roots:s,index:o.array},n}static deserialize(e,t,i={}){if("boolean"==typeof i)return console.warn("MeshBVH.deserialize: The arguments for the function have changed. See documentation for new signature."),le.deserialize(arguments[0],arguments[1],{setIndex:void 0===arguments[2]||arguments[2]});i={setIndex:!0,...i};const{index:o,roots:n}=e,r=new le(t,{...i,[K]:!0});if(r._roots=n,i.setIndex){const i=t.getIndex();if(null===i){const i=new s.BufferAttribute(e.index,1,!1);t.setIndex(i)}else i.array!==o&&(i.array.set(o),i.needsUpdate=!0)}return r}constructor(e,t={}){if(!e.isBufferGeometry)throw new Error("MeshBVH: Only BufferGeometries are supported.");if(e.index&&e.index.isInterleavedBufferAttribute)throw new Error("MeshBVH: InterleavedBufferAttribute is not supported for the index attribute.");if((t=Object.assign({strategy:o.Q7,maxDepth:40,maxLeafTris:10,verbose:!0,useSharedArrayBuffer:!1,setBoundingBox:!0,onProgress:null,[K]:!1},t)).useSharedArrayBuffer&&"undefined"==typeof SharedArrayBuffer)throw new Error("MeshBVH: SharedArrayBuffer is not available.");this._roots=null,t[K]||(this._roots=function(e,t){const i=y(e,t);let s,n,r;const a=[],l=t.useSharedArrayBuffer?SharedArrayBuffer:ArrayBuffer;for(let e=0;e<i.length;e++){const t=i[e];let d=h(t);const u=new l(o.Ne*d);s=new Float32Array(u),n=new Uint32Array(u),r=new Uint16Array(u),c(0,t),a.push(u)}return a;function h(e){return e.count?1:1+h(e.left)+h(e.right)}function c(e,t){const i=e/4,a=e/2,l=!!t.count,h=t.boundingData;for(let e=0;e<6;e++)s[i+e]=h[e];if(l){const s=t.offset,l=t.count;return n[i+6]=s,r[a+14]=l,r[a+15]=o.BE,e+o.Ne}{const s=t.left,r=t.right,a=t.splitAxis;let l;if(l=c(e+o.Ne,s),l/4>Math.pow(2,32))throw new Error("MeshBVH: Cannot store child pointer greater than 32 bits.");return n[i+6]=l/4,l=c(l,r),n[i+7]=a,l}}}(e,t),!e.boundingBox&&t.setBoundingBox&&(e.boundingBox=this.getBoundingBox(new s.Box3))),this.geometry=e}refit(e=null){e&&Array.isArray(e)&&(e=new Set(e));const t=this.geometry,i=t.index.array,s=t.attributes.position;let n,r,a,l,h=0;const c=this._roots;for(let e=0,t=c.length;e<t;e++)n=c[e],r=new Uint32Array(n),a=new Uint16Array(n),l=new Float32Array(n),d(0,h),h+=n.byteLength;function d(t,n,h=!1){const c=2*t;if(a[c+15]===o.BE){const e=r[t+6];let o=1/0,n=1/0,h=1/0,d=-1/0,u=-1/0,m=-1/0;for(let t=3*e,r=3*(e+a[c+14]);t<r;t++){const e=i[t],r=s.getX(e),a=s.getY(e),l=s.getZ(e);r<o&&(o=r),r>d&&(d=r),a<n&&(n=a),a>u&&(u=a),l<h&&(h=l),l>m&&(m=l)}return(l[t+0]!==o||l[t+1]!==n||l[t+2]!==h||l[t+3]!==d||l[t+4]!==u||l[t+5]!==m)&&(l[t+0]=o,l[t+1]=n,l[t+2]=h,l[t+3]=d,l[t+4]=u,l[t+5]=m,!0)}{const i=t+8,s=r[t+6],o=i+n,a=s+n;let c=h,u=!1,m=!1;e?c||(u=e.has(o),m=e.has(a),c=!u&&!m):(u=!0,m=!0);const p=c||m;let g=!1;(c||u)&&(g=d(i,n,c));let f=!1;p&&(f=d(s,n,c));const y=g||f;if(y)for(let e=0;e<3;e++){const o=i+e,n=s+e,r=l[o],a=l[o+3],h=l[n],c=l[n+3];l[t+e]=r<h?r:h,l[t+e+3]=a>c?a:c}return y}}}traverse(e,t=0){const i=this._roots[t],s=new Uint32Array(i),n=new Uint16Array(i);!function t(r,a=0){const l=2*r,h=n[l+15]===o.BE;if(h){const t=s[r+6],o=n[l+14];e(a,h,new Float32Array(i,4*r,6),t,o)}else{const n=r+o.Ne/4,l=s[r+6],c=s[r+7];e(a,h,new Float32Array(i,4*r,6),c)||(t(n,a+1),t(l,a+1))}}(0)}raycast(e,t=s.FrontSide){const i=this._roots,o=this.geometry,n=[],r=t.isMaterial,a=Array.isArray(t),l=o.groups,h=r?t.side:t;for(let s=0,r=i.length;s<r;s++){const r=a?t[l[s].materialIndex].side:h,c=n.length;if($(i[s]),R(0,o,r,e,n),q(),a){const e=l[s].materialIndex;for(let t=c,i=n.length;t<i;t++)n[t].face.materialIndex=e}}return n}raycastFirst(e,t=s.FrontSide){const i=this._roots,o=this.geometry,n=t.isMaterial,r=Array.isArray(t);let a=null;const l=o.groups,h=n?t.side:t;for(let s=0,n=i.length;s<n;s++){const n=r?t[l[s].materialIndex].side:h;$(i[s]);const c=L(0,o,n,e);q(),null!=c&&(null==a||c.distance<a.distance)&&(a=c,r&&(c.face.materialIndex=l[s].materialIndex))}return a}intersectsGeometry(e,t){const i=this.geometry;let s=!1;for(const o of this._roots)if($(o),s=U(0,i,e,t),q(),s)break;return s}shapecast(e,t,i){const s=this.geometry;if(e instanceof Function){if(t){const e=t;t=(t,i,s,o)=>{const n=3*i;return e(t,n,n+1,n+2,s,o)}}e={boundsTraverseOrder:i,intersectsBounds:e,intersectsTriangle:t,intersectsRange:null},console.warn("MeshBVH: Shapecast function signature has changed and now takes an object of callbacks as a second argument. See docs for new signature.")}const o=ae.getPrimitive();let{boundsTraverseOrder:n,intersectsBounds:r,intersectsRange:a,intersectsTriangle:l}=e;if(a&&l){const e=a;a=(t,i,n,r,a)=>!!e(t,i,n,r,a)||C(t,i,s,l,n,r,o)}else a||(a=l?(e,t,i,n)=>C(e,t,s,l,i,n,o):(e,t,i)=>i);let h=!1,c=0;for(const e of this._roots){if($(e),h=N(0,s,r,a,n,c),q(),h)break;c+=e.byteLength}return ae.releasePrimitive(o),h}bvhcast(e,t,i){let{intersectsRanges:s,intersectsTriangles:o}=i;const n=this.geometry.index,r=this.geometry.attributes.position,a=e.geometry.index,l=e.geometry.attributes.position;Y.copy(t).invert();const h=ae.getPrimitive(),c=ae.getPrimitive();if(o){function u(e,i,s,d,u,m,p,g){for(let f=s,y=s+d;f<y;f++){P(c,3*f,a,l),c.a.applyMatrix4(t),c.b.applyMatrix4(t),c.c.applyMatrix4(t),c.needsUpdate=!0;for(let t=e,s=e+i;t<s;t++)if(P(h,3*t,n,r),h.needsUpdate=!0,o(h,c,t,f,u,m,p,g))return!0}return!1}if(s){const m=s;s=function(e,t,i,s,o,n,r,a){return!!m(e,t,i,s,o,n,r,a)||u(e,t,i,s,o,n,r,a)}}else s=u}e.getBoundingBox(Z),Z.applyMatrix4(t);const d=this.shapecast({intersectsBounds:e=>Z.intersectsBox(e),intersectsRange:(t,i,o,n,r,a)=>(X.copy(a),X.applyMatrix4(Y),e.shapecast({intersectsBounds:e=>X.intersectsBox(e),intersectsRange:(e,o,a,l,h)=>s(t,i,e,o,n,r,l,h)}))});return ae.releasePrimitive(h),ae.releasePrimitive(c),d}intersectsBox(e,t){return J.set(e.min,e.max,t),J.needsUpdate=!0,this.shapecast({intersectsBounds:e=>J.intersectsBox(e),intersectsTriangle:e=>J.intersectsTriangle(e)})}intersectsSphere(e){return this.shapecast({intersectsBounds:t=>e.intersectsBox(t),intersectsTriangle:t=>t.intersectsSphere(e)})}closestPointToGeometry(e,t,i={},s={},o=0,n=1/0){e.boundingBox||e.computeBoundingBox(),J.set(e.boundingBox.min,e.boundingBox.max,t),J.needsUpdate=!0;const r=this.geometry,a=r.attributes.position,l=r.index,h=e.attributes.position,c=e.index,d=ae.getPrimitive(),u=ae.getPrimitive();let m=ie,p=se,g=null,f=null;s&&(g=oe,f=ne);let y=1/0,w=null,v=null;return Y.copy(t).invert(),ee.matrix.copy(Y),this.shapecast({boundsTraverseOrder:e=>J.distanceToBox(e),intersectsBounds:(e,t,i)=>i<y&&i<n&&(t&&(ee.min.copy(e.min),ee.max.copy(e.max),ee.needsUpdate=!0),!0),intersectsRange:(i,s)=>{if(e.boundsTree)return e.boundsTree.shapecast({boundsTraverseOrder:e=>ee.distanceToBox(e),intersectsBounds:(e,t,i)=>i<y&&i<n,intersectsRange:(e,n)=>{for(let r=3*e,b=3*(e+n);r<b;r+=3){P(u,r,c,h),u.a.applyMatrix4(t),u.b.applyMatrix4(t),u.c.applyMatrix4(t),u.needsUpdate=!0;for(let e=3*i,t=3*(i+s);e<t;e+=3){P(d,e,l,a),d.needsUpdate=!0;const t=d.distanceToTriangle(u,m,g);if(t<y&&(p.copy(m),f&&f.copy(g),y=t,w=e/3,v=r/3),t<o)return!0}}}});for(let e=0,n=c?c.count:h.count;e<n;e+=3){P(u,e,c,h),u.a.applyMatrix4(t),u.b.applyMatrix4(t),u.c.applyMatrix4(t),u.needsUpdate=!0;for(let t=3*i,n=3*(i+s);t<n;t+=3){P(d,t,l,a),d.needsUpdate=!0;const i=d.distanceToTriangle(u,m,g);if(i<y&&(p.copy(m),f&&f.copy(g),y=i,w=t/3,v=e/3),i<o)return!0}}}}),ae.releasePrimitive(d),ae.releasePrimitive(u),y===1/0?null:(i.point?i.point.copy(p):i.point=p.clone(),i.distance=y,i.faceIndex=w,s&&(s.point?s.point.copy(f):s.point=f.clone(),s.point.applyMatrix4(Y),p.applyMatrix4(Y),s.distance=p.sub(s.point).length(),s.faceIndex=v),i)}closestPointToPoint(e,t={},i=0,s=1/0){const o=i*i,n=s*s;let r=1/0,a=null;if(this.shapecast({boundsTraverseOrder:t=>(te.copy(e).clamp(t.min,t.max),te.distanceToSquared(e)),intersectsBounds:(e,t,i)=>i<r&&i<n,intersectsTriangle:(t,i)=>{t.closestPointToPoint(e,te);const s=e.distanceToSquared(te);return s<r&&(ie.copy(te),r=s,a=i),s<o}}),r===1/0)return null;const l=Math.sqrt(r);return t.point?t.point.copy(ie):t.point=ie.clone(),t.distance=l,t.faceIndex=a,t}getBoundingBox(e){e.makeEmpty();return this._roots.forEach((t=>{r(0,new Float32Array(t),re),e.union(re)})),e}}},7662:(e,t,i)=>{"use strict";i.d(t,{sP:()=>w,k4:()=>y,_m:()=>f});var s=i(68909);const o=new s.Vector3,n=new s.Vector3,r=new s.Vector3,a=new s.Vector2,l=new s.Vector2,h=new s.Vector2,c=new s.Vector3,d=new s.Vector3,u=new s.Vector3,m=new s.Vector3;function p(e,t,i,p,g,f,y,w,v){o.fromBufferAttribute(t,f),n.fromBufferAttribute(t,y),r.fromBufferAttribute(t,w);const b=function(e,t,i,o,n,r){let a;return a=r===s.BackSide?e.intersectTriangle(o,i,t,!0,n):e.intersectTriangle(t,i,o,r!==s.DoubleSide,n),null===a?null:{distance:e.origin.distanceTo(n),point:n.clone()}}(e,o,n,r,m,v);if(b){p&&(a.fromBufferAttribute(p,f),l.fromBufferAttribute(p,y),h.fromBufferAttribute(p,w),b.uv=s.Triangle.getInterpolation(m,o,n,r,a,l,h,new s.Vector2)),g&&(a.fromBufferAttribute(g,f),l.fromBufferAttribute(g,y),h.fromBufferAttribute(g,w),b.uv1=s.Triangle.getInterpolation(m,o,n,r,a,l,h,new s.Vector2)),i&&(c.fromBufferAttribute(i,f),d.fromBufferAttribute(i,y),u.fromBufferAttribute(i,w),b.normal=s.Triangle.getInterpolation(m,o,n,r,c,d,u,new s.Vector3),b.normal.dot(e.direction)>0&&b.normal.multiplyScalar(-1));const t={a:f,b:y,c:w,normal:new s.Vector3,materialIndex:0};s.Triangle.getNormal(o,n,r,t.normal),b.face=t,b.faceIndex=f}return b}function g(e,t,i,s,o){const n=3*s,r=e.index.getX(n),a=e.index.getX(n+1),l=e.index.getX(n+2),{position:h,normal:c,uv:d,uv1:u}=e.attributes,m=p(i,h,c,d,u,r,a,l,t);return m?(m.faceIndex=s,o&&o.push(m),m):null}function f(e,t,i,s,o,n){for(let r=s,a=s+o;r<a;r++)g(e,t,i,r,n)}function y(e,t,i,s,o){let n=1/0,r=null;for(let a=s,l=s+o;a<l;a++){const s=g(e,t,i,a);s&&s.distance<n&&(r=s,n=s.distance)}return r}function w(e,t,i){return null===e?null:(e.point.applyMatrix4(t.matrixWorld),e.distance=e.point.distanceTo(i.ray.origin),e.object=t,e.distance<i.near||e.distance>i.far?null:e)}}}]);